<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AI Management v2.0-MINT-BUILD-202512162050</title>
    <style>
        :root {
            --bg-primary: #FAFBFC;
            --bg-secondary: #F4F6F8;
            --bg-sidebar: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --chat-text-primary: #0B1220;
            --border-color: #E5E7EB;
            --user-msg: #3B82F6;
            --bot-msg: #FFFFFF;
            --accent: #3B82F6;
            --shadow: rgba(0, 0, 0, 0.08);
            --chat-max-width: 800px;
            --bubble-max-width: 680px;
            --bubble-max-percent: 80%;
            --bubble-padding-y: 14px;
            --bubble-padding-x: 16px;
            --bubble-radius: 18px;
            --bubble-tail-radius: 4px;
            --bubble-shadow: 0 1px 3px var(--shadow);
            --surface-translucent: color-mix(in srgb, var(--bg-sidebar) 92%, transparent);
            --surface-solid: var(--bg-sidebar);
            --hi-low: #10B981;
            --hi-med: #F59E0B;
            --hi-high: #EF4444;
            --sessions-visible-limit: 5;
            --session-row-height: 56px;
            --sessions-fallback-padding: 20px;
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1F2937;
            --bg-sidebar: #0F172A;
            --text-primary: #F9FAFB;
            --text-secondary: #9CA3AF;
            --chat-text-primary: #F9FAFB;
            --border-color: #374151;
            --user-msg: #3B82F6;
            --bot-msg: #1F2937;
            --shadow: rgba(0, 0, 0, 0.4);
            /* Surfaces du chat (input + bulles user) plus sombres en mode sombre */
            --surface-translucent: color-mix(in srgb, #0B1220 92%, transparent);
            --surface-solid: #0B1220;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* Scrollbar (Firefox) */
        body {
            scrollbar-color: rgba(0, 0, 0, 0.25) transparent;
        }

        /* RH: √©viter un flash de fond diff√©rent pendant l'overscroll mobile */
        html.hr-overlay-open,
        body.hr-overlay-open {
            background: linear-gradient(135deg, #0a4d3c, #064e3b, #1e3a8a);
                background-attachment: fixed;
            background-attachment: fixed;
            overscroll-behavior: none;
        }

        [data-theme="dark"] body {
            scrollbar-color: rgba(255, 255, 255, 0.25) transparent;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            transition: all 0.3s;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-btn {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .menu-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Desktop: bouton menu un peu plus grand (meilleure harmonie avec le logo) */
        @media (min-width: 800px) {
            .menu-btn {
                width: 44px;
                height: 44px;
                padding: 8px;
            }

            .menu-btn svg {
                width: 32px;
                height: 32px;
            }
        }

        .menu-btn:hover {
            background: var(--bg-secondary);
        }

        .menu-btn:focus {
            outline: none;
        }

        .menu-btn:active {
            transform: scale(0.96);
            background: var(--bg-secondary);
        }

        .menu-btn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .logo {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .logo .letter {
            display: inline-block;
            transition: opacity 0.3s ease;
        }

        .logo .letter.fade {
            animation: fadeOutIn 2s ease-in-out;
        }

        @keyframes fadeOutIn {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }



        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .icon-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Quota Counter (pr√®s du plan) */
        .quota-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-secondary);
            padding: 6px 10px;
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
        }

        .quota-indicator svg {
            width: 14px;
            height: 14px;
        }

        .quota-indicator .quota-value {
            font-variant-numeric: tabular-nums;
        }

        /* Param√®tres: S√©lecteur de mode (FREE/PRO) */
        .settings-plan-toggle {
            display: flex;
            gap: 6px;
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .settings-plan-btn {
            flex: 1;
            border: none;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            background: transparent;
            color: var(--text-secondary);
            transition: background 0.2s, color 0.2s;
        }

        .settings-plan-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .settings-plan-btn.active {
            background: var(--bg-primary);
            color: var(--text-primary);
            box-shadow: inset 0 0 0 1px var(--border-color);
        }

        /* Sidebar badge (Entreprise actif) */
        .menu-item-badge {
            margin-left: auto;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            background: var(--accent);
            color: #fff;
            line-height: 1;
            white-space: nowrap;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: -40%;
            top: 0;
            bottom: 0;
            height: 100vh;
            height: 100dvh;
            min-height: 100vh;
            width: 40%;
            max-width: 320px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            transition: left 0.3s ease-out;
            z-index: 120;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Desktop + Dark: harmoniser le fond du sidebar avec le fond de page */
        @media (min-width: 800px) {
            [data-theme="dark"] .sidebar {
                background: var(--bg-primary);
            }

            [data-theme="dark"] .sidebar-menu,
            [data-theme="dark"] .new-chat-btn {
                background: var(--bg-primary);
            }
        }

        /* Sidebar: zone scrollable (desktop + mobile) */
        .sidebar-scroll {
            flex: 1 1 auto;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            padding-bottom: 14px;
        }

        /* Sidebar: masquer l'indicateur de scroll tout en gardant le scroll */
        .sidebar,
        .sidebar-scroll,
        .conversations {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge legacy */
        }

        .sidebar::-webkit-scrollbar,
        .sidebar-scroll::-webkit-scrollbar,
        .conversations::-webkit-scrollbar {
            width: 0;
            height: 0;
            display: none;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 14px;
            border-bottom: 1px solid transparent;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-sidebar);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: -0.1px;
            transition: background 0.16s ease, box-shadow 0.16s ease;
            font-size: 14px;
            box-shadow: none;
        }

        .new-chat-btn:hover {
            background: var(--bg-secondary);
        }

        .new-chat-btn:active {
            background: var(--bg-secondary);
        }

        .new-chat-btn:focus-visible {
            outline: none;
            box-shadow:
                0 0 0 3px color-mix(in srgb, var(--accent) 35%, transparent);
        }

        /* Sidebar buttons: avoid default blue focus outline on click, keep focus-visible for keyboard */
        .sidebar button {
            -webkit-tap-highlight-color: transparent;
        }

        .sidebar button:focus {
            outline: none;
            box-shadow: none;
        }

        .sidebar button:active {
            outline: none;
            box-shadow: none;
        }

        .sidebar button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 35%, transparent);
        }

        .sessions-toggle-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s, color 0.2s;
            font-size: 14px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .sessions-toggle-btn:hover {
            background: var(--bg-secondary);
        }

        .sessions-toggle-btn.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .sessions-toggle-btn svg {
            width: 16px;
            height: 16px;
            transition: transform 0.3s ease;
        }

        .sessions-toggle-btn.active svg {
            transform: rotate(180deg);
        }

        .conversations {
            flex: 0 0 auto;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0;
            max-height: 0;
            opacity: 0;
            pointer-events: none;
            transition: max-height 0.4s ease, opacity 0.3s ease, padding 0.3s ease;
        }

        .conversations.visible {
            max-height: var(--sessions-max-height, calc(var(--session-row-height, 56px) * var(--sessions-visible-limit, 5) + var(--sessions-fallback-padding, 20px)));
            opacity: 1;
            padding: 10px;
            pointer-events: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .conv-group {
            margin-bottom: 20px;
        }

        .conv-group-title {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            padding: 10px;
            font-weight: 600;
        }

        .conv-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .conv-item:hover {
            background: var(--bg-secondary);
        }

        .conv-item.active {
            background: var(--bg-secondary);
        }

        /* Status Dot pour niveau HI */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            transition: background-color 0.3s ease;
        }

        .status-dot.green {
            background-color: #27ae60;
            box-shadow: 0 0 4px rgba(39, 174, 96, 0.5);
        }

        .status-dot.orange {
            background-color: #f39c12;
            box-shadow: 0 0 4px rgba(243, 156, 18, 0.5);
        }

        .status-dot.red {
            background-color: #e74c3c;
            box-shadow: 0 0 4px rgba(231, 76, 60, 0.5);
        }

        .conv-item-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Main Chat */
        .chat-container {
            margin-top: 60px;
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s;
        }

        .chat-container.sidebar-open {
            margin-left: 40%;
        }

        @media (min-width: 800px) {
            .chat-container.sidebar-open {
                margin-left: 320px;
            }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 40px 20px calc(260px + env(safe-area-inset-bottom, 0px));
            max-width: var(--chat-max-width);
            margin: 0 auto;
            width: 100%;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge legacy */
        }

        .chat-messages::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* Welcome Screen Styles */
        .welcome-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh; height: 100vh;
            padding: 40px 20px;
            animation: fadeIn 0.6s ease;
        }

        .welcome-content {
            max-width: 900px;
            width: 100%;
            text-align: center;
        }

        .welcome-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
        }

        .welcome-logo svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 8px 16px rgba(59, 130, 246, 0.3));
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3B82F6 0%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            animation: slideDown 0.6s ease;
        }

        .welcome-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 50px;
            animation: slideDown 0.7s ease;
        }

        .prompt-suggestions {
            padding-bottom: 100px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 220px));
            justify-content: center;
            gap: 12px;
            margin-bottom: 32px;
        }

        .prompt-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 14px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            animation: slideUp 0.6s ease backwards;
        }

        /* Mode PC: afficher toutes les cartes, cacher le bouton Plus */
        @media (min-width: 769px) {
            .prompt-card--hidden {
                display: flex !important;
            }
            .prompt-card--more {
                display: none !important;
            }
        }

        /* Mode mobile: comportement par d√©faut */
        .prompt-card--hidden {
            display: none;
        }

        .prompt-card:nth-child(1) { animation-delay: 0.1s; }
        .prompt-card:nth-child(2) { animation-delay: 0.2s; }
        .prompt-card:nth-child(3) { animation-delay: 0.3s; }
        .prompt-card:nth-child(4) { animation-delay: 0.4s; }
        .prompt-card:nth-child(5) { animation-delay: 0.5s; }
        .prompt-card:nth-child(6) { animation-delay: 0.6s; }

        .prompt-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
        }

        .prompt-card svg {
            width: 24px;
            height: 24px;
            color: var(--accent);
            flex-shrink: 0;
        }

        .prompt-text h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .prompt-text p {
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.35;
        }

        .welcome-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            animation: fadeIn 1s ease;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            color: #10b981;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-badge svg {
            width: 8px;
            height: 8px;
            animation: pulse 2s ease-in-out infinite;
        }

        .welcome-tip {
            font-size: 0.9rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes welcome-float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-4px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Hide welcome screen when messages exist - handled by JS */

        /* Plus d'espace en mode bureau */
        @media (min-width: 800px) {
            .chat-messages {
                padding-bottom: calc(220px + env(safe-area-inset-bottom, 0px));
            }
        }

        .message-wrapper {
            margin-bottom: 28px;
            animation: fadeIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: none;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .user-avatar {
            background: var(--user-msg);
            color: white;
        }

        .bot-avatar {
            background: var(--bot-msg);
            border: 1px solid var(--border-color);
        }

        .message-sender {
            font-weight: 600;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .message-content {
            padding: var(--bubble-padding-y) var(--bubble-padding-x);
            border-radius: 12px;
            line-height: 1.8;
            font-size: 16.75px;
            color: var(--chat-text-primary);
            white-space: pre-wrap;
            overflow-wrap: anywhere;
            word-break: break-word;
            position: relative;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        /* Typographie moderne (style ChatGPT/Gemini) */
        .message-content p {
            margin: 0 0 0.75em 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul,
        .message-content ol {
            margin: 0.6em 0 0.6em 1.25em;
            padding: 0;
        }

        .message-content li {
            margin: 0.25em 0;
        }

        .message-content a {
            color: var(--accent);
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .message-content code {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.08em 0.35em;
            font-size: 0.95em;
        }

        .message-content pre {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 14px;
            overflow-x: auto;
            margin: 0.8em 0;
            white-space: pre;
        }

        .message-content pre code {
            background: transparent;
            border: none;
            padding: 0;
            font-size: 0.92em;
        }

        .message-content blockquote {
            margin: 0.8em 0;
            padding: 0.1em 0 0.1em 12px;
            border-left: 3px solid var(--border-color);
            color: var(--text-secondary);
        }

        .message-wrapper.user .message-content {
            background: var(--surface-translucent);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            margin-left: auto;
            margin-right: 0;
            max-width: min(var(--bubble-max-percent), var(--bubble-max-width));
            border-radius: var(--bubble-radius) var(--bubble-radius) var(--bubble-tail-radius) var(--bubble-radius);
            box-shadow: 0 2px 16px var(--shadow);
        }
        /* Mode dark: bordure bleue plus visible pour les bulles utilisateur */
        [data-theme="dark"] .message-wrapper.user .message-content {
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        /* Mode dark: bordure blanche sur le champ de saisie */
        [data-theme="dark"] .input-wrapper {
            border: 1.5px solid rgba(255, 255, 255, 0.3);
        }


        /* Images upload√©es dans le chat : pas de "cadre" (bulle bleue) autour de la photo */
        .message-wrapper.user.image-message .message-content {
            background: transparent;
            color: var(--text-primary);
            padding: 0;
            border-radius: 12px;
        }

        /* Fichiers upload√©s : afficher uniquement le lien (sans bulle) */
        .message-wrapper.user.file-message .message-content {
            background: transparent;
            color: var(--text-primary);
            padding: 0;
            border: none;
            box-shadow: none;
            border-radius: 0;
            max-width: none;
            width: fit-content;
            display: inline-block;
            margin-left: auto;
            margin-right: 0;
        }

        .message-wrapper.user.image-message .chat-image-caption {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            opacity: 0.9;
            margin-top: 6px;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
        }

        .message-wrapper.user.image-message img {
            outline: none;
        }

        .message-wrapper.bot .message-content {
            background: transparent;
            color: var(--text-primary);
            margin-left: 0;
            margin-right: auto;
            max-width: 100%;
            border: none;
            box-shadow: none;
            border-radius: 0;
            padding: 0;
        }











        .message-wrapper.error .message-content {
            background: #FFF3F3;
            color: #D32F2F;
            border: 1px solid #FFCDD2;
        }

        /* Metrics */
        .metrics {
            display: none;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-hi {
            background: var(--hi-low);
            color: white;
        }

        .badge-hi.medium {
            background: var(--hi-med);
        }

        .badge-hi.high {
            background: var(--hi-high);
        }

        .badge-rag {
            background: #DBEAFE;
            color: #1E40AF;
        }

        [data-theme="dark"] .badge-rag {
            background: #1E3A8A;
            color: #93C5FD;
        }

        .badge-conf {
            background: #E0E7FF;
            color: #4338CA;
        }

        [data-theme="dark"] .badge-conf {
            background: #312E81;
            color: #A5B4FC;
        }

        /* Input Area */
        .input-container {
            max-width: var(--chat-max-width);
            margin: 0 auto;
            width: 95%;
            flex-shrink: 0;
            position: fixed;
            bottom: calc(24px + env(safe-area-inset-bottom, 0px));
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            padding: 0;
            transition: all 0.3s ease-out;
        }

        /* Quand le sidebar est ouvert, cacher la zone d‚Äô√©criture (mobile + desktop) */
        .input-container.sidebar-open {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-50%) translateY(140%);
        }

        .input-wrapper {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--surface-translucent);
            border-radius: 24px;
            border: 1.5px solid var(--border-color);
            transition: all 0.2s;
            box-shadow: 0 2px 16px var(--shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
            background: var(--surface-solid);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .input-icon-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            width: 32px;
            height: 32px;
            padding: 6px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            order: 2;
        }

        .input-icon-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .input-icon-btn.active {
            background: color-mix(in srgb, var(--accent) 14%, transparent);
            color: var(--accent);
        }

        .input-icon-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Style moderne Copilot pour l'ic√¥ne loop */
        #docsSearchBtn svg {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), filter 0.3s;
        }

        #docsSearchBtn:hover svg {
            transform: rotate(180deg);
        }

        #docsSearchBtn.active svg {
            filter: drop-shadow(0 0 6px rgba(79, 132, 255, 0.4));
        }

        .agent-btn {
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.2s;
            line-height: 1;
            white-space: nowrap;
            flex-shrink: 0;
            order: 3;
            margin-left: auto;
        }

        .agent-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        .agent-picker {
            position: absolute;
            right: 16px;
            bottom: 74px;
            width: auto;
            min-width: 220px;
            max-width: min(320px, calc(100% - 32px));
            background: var(--bg-sidebar);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            box-shadow: 0 12px 40px var(--shadow);
            padding: 8px;
            /* Doit passer au-dessus des panneaux flottants (ex: assistant panel) */
            z-index: 25000;
            display: none;

            /* Mobile: autoriser le scroll sans d√©clencher de s√©lection */
            touch-action: pan-y;
        }

        .agent-picker-item {
            width: 100%;
            text-align: left;
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            transition: all 0.15s;

            /* Mobile: √©viter les taps involontaires pendant un scroll */
            touch-action: manipulation;
        }

        .agent-picker-item:hover {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .agent-picker-item small {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 12px;
            white-space: nowrap;
        }

        .agent-picker-left {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .agent-picker-icon {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            opacity: 0.95;
        }

        #userInput {
            flex: 1 1 100%;
            width: 100%;
            border: none;
            background: transparent;
            outline: none;
            font-size: 16px;
            color: var(--chat-text-primary);
            resize: none;
            max-height: 200px;
            font-family: inherit;
            min-height: 32px;
            line-height: 1.35;
            padding: 4px 0;
            margin-bottom: 4px;
            vertical-align: top;
            align-self: flex-start;
            order: 1;
        }

        #userInput::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
        }

        .send-btn {
            order: 3;
            color: var(--text-secondary);
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            transition: all 0.2s;
        }

        .send-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .send-btn:disabled svg {
            stroke: var(--text-secondary);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Badges neutres (sans couleur) */
        .badge.neutral {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            background: transparent;
        }

        /* Listes Fonctions/Outils */
        .feature-list .feature-item { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-radius:8px; background: var(--bg-secondary); color: var(--text-primary); }
        .feature-list .feature-item:hover { background: rgba(59,130,246,0.12); }
        .badge { font-size: 12px; padding:2px 8px; border-radius:999px; background:#10B981; color:white; }
        .badge.pro { background:#F59E0B; }
        .sidebar-section h3 { color: var(--text-primary); }

        /* User Profile Menu */
        .user-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            right: auto;
            width: 320px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translate(-50%, calc(-50% - 10px));
            pointer-events: none;
            transition: all 0.2s ease;
            z-index: 12000;
            display: none;
        }

        .user-menu.show {
            opacity: 1;
            transform: translate(-50%, -50%);
            pointer-events: all;
            display: block;
        }

        /* Mobile: panneau plein large en haut */
        @media (max-width: 768px) {
            .user-menu {
                top: 72px;
                left: 12px;
                right: 12px;
                width: auto;
                transform: translateY(-10px);
            
            /* Claude-style mobile input */
            .input-wrapper {
                flex-wrap: wrap;
                align-items: flex-end;
                padding: 12px 14px;
                border-radius: 24px;
            }
            
            #userInput {
                flex: 1 1 100%;
                width: 100%;
                min-height: 38px;
                max-height: 150px;
                padding: 6px 10px;
                margin-bottom: 10px;
                order: 0;
                line-height: 1.5;
            }
            
            .input-actions {
                order: 1;
                margin-right: auto;
            }
            
            .agent-btn {
                order: 2;
                margin-left: auto;
                margin-right: 8px;
            }
            
            .send-btn {
                order: 3;
            }

        }

            .user-menu.show {
                transform: translateY(0);
            }
        }

        .user-menu-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .user-menu-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            line-height: 1;
        }

        .user-menu-close:hover {
            opacity: 0.92;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #2563eb);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .user-menu-info {
            flex: 1;
            min-width: 0;
        }

        .user-menu-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-menu-email {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .user-menu-divider {
            height: 1px;
            background: var(--border-color);
        }

        .user-menu-items {
            padding: 8px;
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .user-menu-item:hover {
            background: var(--bg-secondary);
        }

        .user-menu-item svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .user-menu-item-danger {
            color: #ef4444;
        }

        .user-menu-item-danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 14px 20px;
            border-radius: 12px;
            border: 1.5px solid var(--border-color);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            font-size: 14px;
            font-weight: 500;
            max-width: 320px;
        }

        .toast.with-icon {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast .toast-icon {
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
            opacity: 0.9;
        }

        .toast .toast-icon svg {
            width: 18px;
            height: 18px;
            display: block;
        }

        .toast .toast-text {
            flex: 1 1 auto;
            min-width: 0;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1.5px solid #3B82F6;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
        }

        .toast.error {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1.5px solid #EF4444;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.2);
        }

        /* File Upload */
        #fileInput {
            display: none;
        }

        /* Protection Alert */
        .protection-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            display: none;
        }

        .protection-alert.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translate(-50%, -60%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        /* üöÄ PERFORMANCE : Animation barre de progression */
        @keyframes progressSlide {
            from { width: 0%; opacity: 0.8; }
            to { width: 100%; opacity: 1; }
        }

        @keyframes loadingBar {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .performance-bar {
            animation: progressSlide 0.4s ease-out;
        }

        /* üöÄ PERFORMANCE : Styles badges performance */
        .badge-cache {
            animation: pulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }

        .badge-time,
        .badge-tokens {
            font-variant-numeric: tabular-nums;
        }
        
        /* üé® Metrics icon styling */
        .metrics-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            margin-right: 8px;
            border: none;
            padding: 0;
            background: transparent;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease, color 0.2s ease;
            color: var(--text-secondary);
            opacity: 0.6;
        }
        
        .metrics-icon:hover {
            opacity: 1;
            transform: scale(1.15);
            color: var(--accent);
        }
        
        .metrics-icon:active {
            transform: scale(0.95);
        }
        
        /* Desktop: l√©g√®rement plus grand et visible */
        @media (min-width: 769px) {
            .metrics-icon {
                width: 30px;
                height: 30px;
            }
        }
        
        /* Container for action buttons below message */
        .message-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            padding-left: 4px;
        }
        
        .message-actions button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border: none;
            padding: 0;
            background: transparent;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease, color 0.2s ease;
            color: var(--text-secondary);
            opacity: 0.6;
            border-radius: 6px;
        }
        
        .message-actions button:hover {
            opacity: 1;
            transform: scale(1.15);
            color: var(--accent);
            background: var(--bg-secondary);
        }


        .protection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: none;
        }

        .protection-overlay.show {
            display: block;
        }

        .protection-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .protection-icon {
            font-size: 48px;
        }

        .protection-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .protection-description {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .protection-stats {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .protection-stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .protection-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .protection-btn {
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .protection-btn-primary {
            background: #3B82F6;
            color: white;
        }

        .protection-btn-primary:hover {
            background: #2563EB;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .protection-btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1.5px solid var(--border-color);
        }

        .protection-btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .protection-btn-danger {
            background: transparent;
            color: #EF4444;
            border: 1.5px solid #EF4444;
        }

        .protection-btn-danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Modals: masquer l'indicateur de scroll tout en gardant le scroll */
        .modal-content {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge legacy */
        }

        .modal-content::-webkit-scrollbar {
            width: 0;
            height: 0;
            display: none;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: none;
            gap: 12px;
        }

        .stat-item.left {
            justify-content: flex-start;
            align-items: baseline;
        }

        .stat-item.left .stat-value {
            text-align: left;
            max-width: none;
        }

        .stat-item .stat-value {
            font-weight: 700;
            text-align: right;
            max-width: 60%;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .stat-item.multiline {
            align-items: flex-start;
        }

        .stat-item.multiline .stat-value {
            font-weight: 600;
            font-size: 12px;
            line-height: 1.4;
            text-align: right;
        }

        .stat-section-title {
            margin-top: 14px;
            padding-top: 0;
            border-top: none;
            font-size: 11px;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .ai-model-help {
            display: grid;
            gap: 6px;
        }

        .ai-model-help .row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: baseline;
        }

        .ai-model-help .k {
            color: var(--text-secondary);
            flex: 0 0 auto;
        }

        .ai-model-help .v {
            color: var(--text-primary);
            font-weight: 700;
            text-align: right;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .ai-model-help .hint {
            color: var(--text-secondary);
            font-size: 12px;
            line-height: 1.35;
        }

        /* Mobile: Active model (help) layout */
        @media (max-width: 768px) {
            .ai-model-help .stat-item {
                gap: 10px;
            }

            .ai-model-help .stat-item .stat-value {
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .ai-model-help .stat-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .ai-model-help .stat-item.left {
                align-items: flex-start;
            }

            .ai-model-help .stat-item > span:first-child {
                font-size: 12px;
                color: var(--text-secondary);
            }

            .ai-model-help .stat-item .stat-value {
                text-align: left;
            }

            .ai-model-help .hint a {
                overflow-wrap: anywhere;
                word-break: break-word;
            }
        }

        .stat-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-icon {
            width: 18px;
            height: 18px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-secondary);
            transition: all 0.2s;
            border: 1.5px solid var(--border-color);
        }

        .info-icon:hover {
            background: #3B82F6;
            color: white;
            border-color: #3B82F6;
            transform: scale(1.1);
        }

        .tooltip {
            position: fixed;
            background: var(--bg-primary);
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            max-width: 280px;
            font-size: 13px;
            line-height: 1.5;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none;
            pointer-events: none;
        }

        .tooltip.show {
            display: block;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            /* Tablette */
            .sidebar {
                width: 50%;
                max-width: 400px;
            }

            .chat-container.sidebar-open {
                margin-left: 0;
            }

            .chat-messages {
                padding: 30px 16px 260px;
            }

            /* Welcome screen responsive - Tablette */
            .welcome-title {
                font-size: 2rem;
            }

            .welcome-logo {
                width: 100px;
                height: 100px;
            }

            .prompt-suggestions {
            padding-bottom: 100px;
                grid-template-columns: repeat(2, 1fr);
            }

        }

        @media (max-width: 768px) {
            /* Mobile */
            .sidebar {
                width: 80%;
                left: -80%;
                max-width: none;
            }

            .sidebar.open {
                left: 0;
            }

            /* Sidebar scroll: √©viter que Sessions/Office/Outils soient cach√©s */
            .sidebar {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Sessions scrollables avec limite de 5 √©l√©ments */
            .conversations {
                flex: 0 0 auto;
                overflow-y: hidden;
                max-height: 0;
            }

            .conversations.visible {
                overflow-y: auto;
                max-height: var(--sessions-max-height, calc(var(--session-row-height, 56px) * var(--sessions-visible-limit, 5) + var(--sessions-fallback-padding, 20px)));
                -webkit-overflow-scrolling: touch;
            }

            .chat-container.sidebar-open {
                margin-left: 0;
            }

            .header {
                height: auto;
                min-height: 60px;
                padding: 10px 12px;
                flex-wrap: wrap;
            }

            .header-left {
                gap: 10px;
                flex: 1;
            }

            .header-left .logo {
                font-size: 16px;
            }

            .header-right {
                gap: 6px;
                order: 3;
            }

            .icon-btn {
                width: 32px;
                height: 32px;
            }

            .icon-btn svg {
                width: 18px;
                height: 18px;
            }

            .chat-messages {
                padding: 20px 12px 220px;
                max-width: 100%;
            }

            .message-wrapper {
                margin-bottom: 12px;
            }

            .message {
                padding: 10px 12px;
                font-size: 14px;
                max-width: 90%;
            }

            .message.user {
                max-width: 85%;
            }

            .message.assistant {
                max-width: 95%;
            }

            /* Welcome screen responsive - Mobile */
            .welcome-screen {
                padding: 20px 16px;
            }

            .welcome-title {
                font-size: 1.75rem;
            }

            .welcome-subtitle {
                font-size: 1rem;
                margin-bottom: 30px;
            }

            .welcome-logo {
                width: 80px;
                height: 80px;
                margin-bottom: 20px;
            }

            .prompt-suggestions {
            padding-bottom: 100px;
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .prompt-card {
                padding: 14px;
            }

            .prompt-card svg {
                width: 24px;
                height: 24px;
            }

            .welcome-footer {
                gap: 12px;
            }

            /* Input area mobile */
            .input-area {
                padding: 12px;
                gap: 8px;
            }

            .input-wrapper {
                gap: 8px;
            }

            #userMessage {
                font-size: 14px;
                padding: 10px 12px;
                min-height: 44px;
            }

            #sendBtn {
                width: 44px;
                height: 44px;
                min-width: 44px;
                min-height: 44px;
            }

            #sendBtn svg {
                width: 20px;
                height: 20px;
            }

            /* Suggestions mobile */
            .suggestions-container {
                padding: 8px 12px;
                gap: 6px;
            }

            .suggestion-chip {
                padding: 8px 12px;
                font-size: 12px;
            }

            /* Sidebar mobile */
            /* Quand le sidebar est ouvert en mobile, cacher la zone d‚Äô√©criture */
            .input-container.sidebar-open {
                opacity: 0;
                pointer-events: none;
                transform: translateX(-50%) translateY(140%);
            }

            .sidebar-header {
                padding: 16px;
            }

            .new-chat-btn {
                margin-top: 8px;
            }

            .new-chat-btn,
            .sessions-toggle-btn {
                padding: 10px;
                font-size: 13px;
            }

            .conv-item {
                padding: 10px;
                font-size: 13px;
            }

            .conv-group-title {
                font-size: 11px;
                padding: 8px 10px;
            }

            /* Mobile: autoriser le scroll du sidebar si n√©cessaire */
            .sidebar {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @media (max-width: 480px) {
            /* Petit mobile */
            .sidebar {
                width: 80%;
                left: -80%;
            }

            .header {
                padding: 8px 10px;
                min-height: auto;
            }

            .header-left .logo {
                font-size: 14px;
            }

            .menu-btn {
                font-size: 20px;
                padding: 6px;
            }

            .icon-btn {
                width: 30px;
                height: 30px;
            }

            .icon-btn svg {
                width: 16px;
                height: 16px;
            }

            .chat-messages {
                padding: 16px 10px 260px;
            }

            .message {
                padding: 8px 10px;
                font-size: 13px;
            }

            .input-area {
                padding: 10px;
                gap: 6px;
            }

            #userMessage {
                font-size: 13px;
                padding: 8px 10px;
                min-height: 40px;
            }

            #sendBtn {
                width: 40px;
                height: 40px;
                min-width: 40px;
                min-height: 40px;
            }

            #sendBtn svg {
                width: 18px;
                height: 18px;
            }

            .suggestions-container {
                padding: 6px 10px;
                gap: 4px;
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .suggestion-chip {
                padding: 6px 10px;
                font-size: 11px;
                white-space: nowrap;
            }

            .sidebar-header {
                padding: 12px;
            }

            .new-chat-btn,
            .sessions-toggle-btn {
                padding: 8px;
                font-size: 12px;
            }

            .conv-item {
                padding: 8px;
                font-size: 12px;
            }

            .conv-group-title {
                font-size: 10px;
                padding: 6px 8px;
            }
        }

        /* Touch improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Augmenter zones touch pour mobile */
            .menu-btn,
            .icon-btn,
            .conv-item,
            #sendBtn {
                min-width: 44px;
                min-height: 44px;
            }

            .suggestion-chip {
                min-height: 36px;
            }
        }

        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                height: 50px;
                min-height: 50px;
                padding: 6px 10px;
            }

            .header-left .logo {
                font-size: 14px;
            }

            .icon-btn {
                width: 28px;
                height: 28px;
            }

            .sidebar {
                width: 80%;
                left: -80%;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar {
                top: 50px;
                height: calc(100vh - 50px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .conversations {
                flex: 0 0 auto;
                overflow-y: hidden;
                max-height: 0;
            }

            .conversations.visible {
                overflow-y: auto;
                max-height: var(--sessions-max-height, calc(var(--session-row-height, 56px) * var(--sessions-visible-limit, 5) + var(--sessions-fallback-padding, 20px)));
                -webkit-overflow-scrolling: touch;
            }

            .chat-container {
                margin-top: 50px;
                height: calc(100vh - 50px);
            }

            .chat-container.sidebar-open {
                margin-left: 0;
            }

            .chat-messages {
                padding: 12px 16px 220px;
                width: 100%;
            }

            .input-container {
                bottom: 10px;
                width: 96%;
                max-width: none;
                /* Assurer que le menu des agents reste au-dessus (le picker est enfant) */
                z-index: 25000;
            }

            .input-container.sidebar-open {
                opacity: 0;
                pointer-events: none;
                transform: translateX(-50%) translateY(140%);
            }

            .input-wrapper {
                padding: 6px 10px;
            }

            /* Agent picker: mieux visible en paysage (hauteur r√©duite + scroll) */
            .agent-picker {
                bottom: 62px;
                right: 12px;
                width: min(340px, calc(100vw - 24px));
                max-height: calc(100vh - 120px);
                max-height: calc(100dvh - 120px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            #userMessage,
            #userInput {
                font-size: 14px;
                min-height: 32px;
            }

            .suggestions-container {
                display: none;
            }

            .message {
                font-size: 13px;
                padding: 8px 10px;
            }
        }


        /* Modern Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            transition: background 0.2s;
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.22);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.32);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Scrollbar pour Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
        }

        [data-theme="dark"] * {
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* About Modal Styles - Modern AI Design */
        .about-section {
            margin-bottom: 25px;
        }

        .about-section h3 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .about-section h3 svg {
            width: 20px;
            height: 20px;
            stroke: var(--accent);
        }

        .about-section p {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .about-intro {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            margin-bottom: 25px;
        }

        .about-intro p {
            margin: 0;
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.6;
        }

        .about-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .feature-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), #2563eb);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--accent);
        }

        .feature-card:hover::before {
            transform: scaleX(1);
        }

        .feature-card h4 {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .feature-card p {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        .dot-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 220px));
            gap: 12px;
            margin-top: 15px;
        }

        .dot-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-secondary);
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .dot-item:hover {
            transform: translateX(3px);
            border-color: var(--accent);
        }

        .dot-example {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .dot-example.green {
            background: #27ae60;
            box-shadow: 0 0 8px rgba(39, 174, 96, 0.6);
        }

        .dot-example.orange {
            background: #f39c12;
            box-shadow: 0 0 8px rgba(243, 156, 18, 0.6);
        }

        .dot-example.red {
            background: #e74c3c;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.6);
        }

        .dot-item-content {
            flex: 1;
        }

        .dot-item-content strong {
            display: block;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .dot-item-content span {
            display: block;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .company-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1e40af 100%);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-top: 25px;
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }

        .company-info::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .company-info > * {
            position: relative;
            z-index: 1;
        }

        .company-info h4 {
            font-size: 18px;
            margin-bottom: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .company-info p {
            color: rgba(255, 255, 255, 0.95);
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        .company-info a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .company-info a:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .tech-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .tech-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-secondary);
            color: var(--accent);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .tech-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
            border-color: var(--accent);
        }

        /* Sidebar Menu Section */
        .sidebar-menu {
            flex-shrink: 0;
            margin-top: 28px;
            padding: 15px 10px 20px 10px;
            border-top: 1px solid transparent;
            background: var(--bg-sidebar);
            position: relative;
            z-index: 2;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--text-primary);
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            touch-action: manipulation;
            transition: background 0.2s, color 0.2s;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            text-align: left;
        }

        .menu-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .menu-item svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            flex-shrink: 0;
        }

        .menu-item-text {
            flex: 1;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Mode Vocal - Voice Chat */
        #logo {
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        #logo:hover {
            color: var(--accent);
            transform: scale(1.05);
        }

        #logo.voice-active {
            color: var(--accent);
            animation: logo-pulse 1.5s ease-in-out infinite;
        }

        @keyframes logo-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .voice-mode-container {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 15px;
            padding: 24px;
            z-index: 1000;
            overflow: auto;
        }

        .voice-mode-container.active {
            display: flex;
        }

        /* Goutte d'eau spatiale - flotte doucement dans l'espace */
        .voice-orb {
            position: relative;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Halo ambiant tr√®s doux */
        .voice-orb::before {
            content: '';
            position: absolute;
            width: 140%;
            height: 140%;
            border-radius: 50%;
            background: radial-gradient(circle, var(--accent-alpha, rgba(102, 126, 234, 0.15)) 0%, transparent 70%);
            animation: space-ambient 10s ease-in-out infinite;
            filter: blur(20px);
        }

        @keyframes space-ambient {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        /* Core - la goutte d'eau qui flotte */
        .voice-orb-core {
            width: 80px;
            height: 80px;
            border-radius: 48% 52% 53% 47% / 52% 48% 52% 48%;
            background: linear-gradient(135deg, 
                var(--accent, #667eea) 0%, 
                color-mix(in srgb, var(--accent, #667eea) 70%, white) 30%,
                var(--accent, #667eea) 70%,
                color-mix(in srgb, var(--accent, #667eea) 60%, black) 100%);
            box-shadow: 
                0 0 40px var(--accent-alpha, rgba(102, 126, 234, 0.3)),
                inset 3px 3px 15px rgba(255, 255, 255, 0.4),
                inset -3px -3px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            animation: space-float 14s ease-in-out infinite, morph-idle 20s ease-in-out infinite;
            transition: all 1s ease-in-out;
        }

        @keyframes space-float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-8px) rotate(2deg); }
            50% { transform: translateY(-4px) rotate(-1deg); }
            75% { transform: translateY(-10px) rotate(1deg); }
        }

        @keyframes morph-idle {
            0%, 100% { border-radius: 48% 52% 53% 47% / 52% 48% 52% 48%; }
            25% { border-radius: 52% 48% 47% 53% / 48% 52% 48% 52%; }
            50% { border-radius: 50% 50% 52% 48% / 53% 47% 50% 50%; }
            75% { border-radius: 47% 53% 50% 50% / 50% 50% 53% 47%; }
        }

        .voice-orb-core svg {
            display: none;
        }

        /* Reflet lumineux sur la goutte */
        .voice-orb-core::before {
            content: '';
            position: absolute;
            top: 15%;
            left: 20%;
            width: 25px;
            height: 15px;
            border-radius: 50%;
            background: radial-gradient(ellipse, rgba(255,255,255,0.7) 0%, transparent 70%);
            animation: shine-float 14s ease-in-out infinite;
        }

        @keyframes shine-float {
            0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.7; }
            50% { transform: translate(3px, 2px) scale(1.1); opacity: 0.9; }
        }

        /* √âtat: √âcoute (utilisateur parle) - Bleu doux */
        .voice-orb.listening .voice-orb-core {
            background: linear-gradient(135deg, 
                #6ea8fe 0%, 
                #9ec5fe 30%,
                #6ea8fe 70%,
                #4a8fe7 100%);
            box-shadow: 
                0 0 50px rgba(110, 168, 254, 0.4),
                inset 3px 3px 20px rgba(255, 255, 255, 0.5),
                inset -3px -3px 15px rgba(74, 143, 231, 0.2);
            animation: space-float 8s ease-in-out infinite, morph-listening 6s ease-in-out infinite;
        }

        @keyframes morph-listening {
            0%, 100% { border-radius: 48% 52% 53% 47% / 52% 48% 52% 48%; transform: translateY(0) scale(1); }
            25% { border-radius: 52% 48% 45% 55% / 55% 45% 52% 48%; transform: translateY(-6px) scale(1.02); }
            50% { border-radius: 45% 55% 52% 48% / 48% 52% 45% 55%; transform: translateY(-3px) scale(1.04); }
            75% { border-radius: 55% 45% 48% 52% / 52% 48% 55% 45%; transform: translateY(-8px) scale(1.01); }
        }

        .voice-orb.listening::before {
            background: radial-gradient(circle, rgba(110, 168, 254, 0.25) 0%, transparent 70%);
            animation: space-ambient 6s ease-in-out infinite;
        }

        /* √âtat: R√©flexion (AI pense) - harmonis√© en bleu accent */
        .voice-orb.thinking .voice-orb-core {
            background: linear-gradient(135deg, 
                #6ea8fe 0%, 
                #9ec5fe 30%,
                #6ea8fe 70%,
                #4a8fe7 100%);
            box-shadow: 
                0 0 50px rgba(110, 168, 254, 0.4),
                inset 3px 3px 20px rgba(255, 255, 255, 0.5),
                inset -3px -3px 15px rgba(74, 143, 231, 0.2);
            animation: space-float 10s ease-in-out infinite, morph-thinking 8s ease-in-out infinite;
        }

        @keyframes morph-thinking {
            0%, 100% { border-radius: 50% 50% 50% 50%; transform: translateY(0) rotate(0deg); }
            25% { border-radius: 55% 45% 55% 45%; transform: translateY(-5px) rotate(3deg); }
            50% { border-radius: 45% 55% 45% 55%; transform: translateY(-7px) rotate(-2deg); }
            75% { border-radius: 52% 48% 52% 48%; transform: translateY(-4px) rotate(1deg); }
        }

        .voice-orb.thinking::before {
            background: radial-gradient(circle, rgba(110, 168, 254, 0.25) 0%, transparent 70%);
            animation: space-ambient 5s ease-in-out infinite;
        }

        /* √âtat: Parle (AI r√©pond) - harmonis√© en bleu accent */
        .voice-orb.speaking .voice-orb-core {
            background: linear-gradient(135deg, 
                #6ea8fe 0%, 
                #9ec5fe 30%,
                #6ea8fe 70%,
                #4a8fe7 100%);
            box-shadow: 
                0 0 55px rgba(110, 168, 254, 0.45),
                inset 3px 3px 20px rgba(255, 255, 255, 0.5),
                inset -3px -3px 15px rgba(74, 143, 231, 0.2);
            animation: space-float 6s ease-in-out infinite, morph-speaking 4s ease-in-out infinite;
        }

        @keyframes morph-speaking {
            0%, 100% { border-radius: 48% 52% 53% 47% / 52% 48% 52% 48%; transform: scale(1); }
            25% { border-radius: 52% 48% 48% 52% / 48% 52% 55% 45%; transform: scale(1.03); }
            50% { border-radius: 50% 50% 55% 45% / 53% 47% 48% 52%; transform: scale(1.06); }
            75% { border-radius: 47% 53% 50% 50% / 50% 50% 52% 48%; transform: scale(1.02); }
        }

        .voice-orb.speaking::before {
            background: radial-gradient(circle, rgba(110, 168, 254, 0.25) 0%, transparent 70%);
            animation: space-ambient 5s ease-in-out infinite;
        }

        .voice-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .voice-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            opacity: 0;
        }

        .voice-orb.listening .voice-particle {
            animation: particle-float 4s ease-in-out infinite;
        }

        @keyframes particle-float {
            0% { transform: translateY(0) scale(0); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateY(-40px) scale(1); opacity: 0; }
        }

        .voice-status-text {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            font-weight: 500;
        }

        .voice-status-text.listening {
            color: var(--accent);
        }

        .voice-status-text.thinking {
            color: var(--hi-med);
        }

        .voice-status-text.speaking {
            color: var(--hi-low);
        }

        .voice-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 40px;
        }

        .voice-bar {
            width: 4px;
            height: 8px;
            background: var(--accent, #667eea);
            border-radius: 4px;
            opacity: 0.3;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .voice-orb.listening .voice-bar {
            background: #6ea8fe;
            animation: bar-gentle-listening 2s ease-in-out infinite;
        }

        .voice-orb.speaking .voice-bar {
            background: #93e4c1;
            animation: bar-gentle-speaking 1.5s ease-in-out infinite;
        }

        @keyframes bar-gentle-listening {
            0%, 100% { height: 8px; opacity: 0.3; }
            50% { height: 22px; opacity: 0.6; }
        }

        @keyframes bar-gentle-speaking {
            0%, 100% { height: 8px; opacity: 0.4; }
            50% { height: 28px; opacity: 0.7; }
        }

        .voice-bar:nth-child(1) { animation-delay: 0s; }
        .voice-bar:nth-child(2) { animation-delay: 0.15s; }
        .voice-bar:nth-child(3) { animation-delay: 0.3s; }
        .voice-bar:nth-child(4) { animation-delay: 0.24s; }
        .voice-bar:nth-child(5) { animation-delay: 0.32s; }

        .input-container.voice-hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }
    </style>
    
    <!-- SheetJS pour manipulation Excel (compatible navigateur) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Finance Storage Client - Appels API avec fallback localStorage -->
    <script src="/js/financeStorageClient.js"></script>
</head>
<body data-theme="light">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="menu-btn" id="menuToggleBtn" aria-label="Ouvrir le menu">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <line x1="4" y1="7" x2="20" y2="7" />
                    <line x1="4" y1="12" x2="16" y2="12" />
                    <line x1="4" y1="17" x2="20" y2="17" />
                </svg>
            </button>
            <div class="logo" id="logo">Axilum AI</div>
        </div>
        <div class="header-right">
            <!-- Quota Counter -->
            <div class="quota-indicator" id="quotaIndicator" title="Quota (indicatif)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M12 2l1.6 5.8L20 10l-6.4 2.2L12 18l-1.6-5.8L4 10l6.4-2.2L12 2z"/>
                    <path d="M18.5 3.5l.6 2.1 2.1.6-2.1.6-.6 2.1-.6-2.1-2.1-.6 2.1-.6.6-2.1z"/>
                </svg>
                <span class="quota-value" id="quotaValue">‚Äî</span>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" id="newChatBtn" onclick="newConversation()">Nouvelle Conversation</button>
            <button class="sessions-toggle-btn" id="sessionsToggleBtn" onclick="toggleSessions()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span id="sessionsLabel">Sessions</span>
                <svg style="margin-left: auto;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
        </div>

        <div class="sidebar-scroll">
        <div class="conversations" id="conversationsList">
            <!-- Dynamically loaded -->
        </div>
        
        <!-- Menu Section -->
        <div class="sidebar-menu">
            <button class="menu-item" id="accountBtn" onclick="try { if (event) { event.preventDefault(); event.stopPropagation(); } } catch (_) {} try { showAccountMenu(); } catch (_) {} return false;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span class="menu-item-text" id="sidebarAccountLabel">Mon Compte</span>
            </button>
            <button class="menu-item" onclick="showStats()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <span class="menu-item-text" id="sidebarStatsLabel">Statistiques</span>
            </button>
            <button class="menu-item" onclick="showSettings()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="menu-item-text" id="sidebarSettingsLabel">Param√®tres</span>
            </button>
            <button class="menu-item" onclick="showAbout()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="menu-item-text" id="sidebarAboutLabel">√Ä propos</span>
            </button>

            <button class="menu-item" id="enterpriseMenuBtn" onclick="openEnterpriseOfferModal(event); return false;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21h18M6 21V5a2 2 0 012-2h8a2 2 0 012 2v16M9 7h6M9 11h6M9 15h6M9 19h6"/>
                </svg>
                <span class="menu-item-text" id="sidebarEnterpriseLabel">Entreprise</span>
                <span class="menu-item-badge" id="enterpriseActiveBadge" style="display:none;">Actif</span>
            </button>
            <!-- Section Office‚Ñ¢ (d√©pliable) -->
            <button class="menu-item" onclick="toggleFunctionsSection()" title="Office‚Ñ¢">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5a2 2 0 104 0 2 2 0 10-4 0zM5 11a2 2 0 102 2h2a2 2 0 102-2v-2a2 2 0 10-2-2H9a2 2 0 10-4 2v2zM13 13a2 2 0 112 2v2a2 2 0 11-2 2h-2a2 2 0 11-2-2v-2a2 2 0 112-2h2z"/>
                </svg>
                <span class="menu-item-text">Office‚Ñ¢</span>
                <svg id="functionsChevron" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px; height:16px; margin-left:auto; transition:transform 0.3s;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
            <div id="functionsContent" style="display:none; padding-left:20px;">
                <!-- Human Resources -->
                <button class="menu-item" onclick="loadHRModule()" style="padding-left:30px;" title="Human Resources - Gestion des Ressources Humaines">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <span class="menu-item-text">Human Resources</span>
                </button>
                <!-- Research & Development -->
                <button class="menu-item" onclick="loadRnDModule()" style="padding-left:30px;" title="Research & Development - Recherche et D√©veloppement">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    <span class="menu-item-text">Research & Development</span>
                </button>
                <!-- Marketing & Business -->
                <button class="menu-item" onclick="loadMarketingModule()" style="padding-left:30px;" title="Marketing & Business - Croissance et Strat√©gie">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span class="menu-item-text">Marketing & Business</span>
                </button>
                
                <!-- Finance & Comptabilit√© -->
                <button class="menu-item" onclick="loadFinanceModule()" style="padding-left:30px;" title="Finance & Comptabilit√©">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="menu-item-text">Finance & Compta</span>
                </button>

                <!-- AI Task (Calendrier, T√¢ches, Planning) -->
                <button class="menu-item" id="aiTaskMenuBtn" onclick="loadTaskModule()" style="padding-left:30px;" title="Tasks and Planning">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    <span class="menu-item-text">Tasks and Planning</span>
                </button>

                <!-- Hallucination Detector -->
                <button class="menu-item" onclick="loadHallucinationModule()" style="padding-left:30px;" title="Hallucination Detector - D√©tection d'hallucinations IA">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="menu-item-text">Hallucination Detector</span>
                </button>
            </div>
        </div>
        </div>
    </div>

    <!-- Main Chat -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will appear here -->
            
            <!-- Empty State - Welcome Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <div class="welcome-logo">
                        <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Orbite 1 (fixe) -->
                            <ellipse cx="60" cy="60" rx="35" ry="15" stroke="url(#gradient1)" stroke-width="1" opacity="0.3"/>
                            
                            <!-- Orbite 2 (fixe, inclin√©e 60¬∞) -->
                            <ellipse cx="60" cy="60" rx="35" ry="15" stroke="url(#gradient1)" stroke-width="1" opacity="0.3" transform="rotate(60 60 60)"/>
                            
                            <!-- Orbite 3 (fixe, inclin√©e 120¬∞) -->
                            <ellipse cx="60" cy="60" rx="35" ry="15" stroke="url(#gradient1)" stroke-width="1" opacity="0.3" transform="rotate(120 60 60)"/>
                            
                            <!-- Node central pulsant (lent, style galaxie) -->
                            <circle cx="60" cy="60" r="8" fill="url(#gradient2)">
                                <animate attributeName="r" values="8;11;8" dur="4s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.85;1;0.85" dur="4s" repeatCount="indefinite"/>
                            </circle>
                            
                            <!-- Cercle lumineux central (halo tres lent) -->
                            <circle cx="60" cy="60" r="12" fill="url(#gradient2)" opacity="0.4">
                                <animate attributeName="r" values="12;16;12" dur="12s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.4;0.15;0.4" dur="12s" repeatCount="indefinite"/>
                            </circle>
                            
                            <!-- Gradients -->
                            <defs>
                                <linearGradient id="gradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
                                </linearGradient>
                                <radialGradient id="gradient2" cx="50%" cy="50%">
                                    <stop offset="0%" style="stop-color:#60A5FA;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#3B82F6;stop-opacity:0.6" />
                                </radialGradient>
                            </defs>
                        </svg>
                    </div>
                    <h1 class="welcome-title">Axilum AI</h1>
                    <p class="welcome-subtitle" id="welcomeSubtitle">Votre assistant intelligent pour tous vos besoins professionnels</p>
                    
                    <div class="prompt-suggestions">
                        <div class="prompt-card" onclick="startExcelReportWorkflow()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <div class="prompt-text">
                                <h3 id="welcomeExcelTitle">Analyse Excel</h3>
                                <p id="welcomeExcelDesc">G√©n√®re un rapport d√©taill√©</p>
                            </div>
                        </div>
                        
                        <div class="prompt-card" onclick="useSuggestion(t('welcome.suggest.financeReport'), 'alex', true)">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div class="prompt-text">
                                <h3 id="welcomeFinanceTitle">Rapport financier</h3>
                                <p id="welcomeFinanceDesc">Analyse d√©penses et revenus</p>
                            </div>
                        </div>
                        
                        <div class="prompt-card" onclick="useSuggestion(t('welcome.suggest.webSearch'), 'web')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <div class="prompt-text">
                                <h3 id="welcomeWebTitle">Recherche web</h3>
                                <p id="welcomeWebDesc">Cherche et r√©sume</p>
                            </div>
                        </div>

                        <div class="prompt-card prompt-card--more" id="welcomeMorePromptsCard" onclick="showMoreWelcomePrompts()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14m-7-7h14"/>
                            </svg>
                            <div class="prompt-text">
                                <h3 id="welcomeMoreTitle">Plus</h3>
                                <p id="welcomeMoreDesc">Afficher plus</p>
                            </div>
                        </div>
                        
                        <div class="prompt-card prompt-card--hidden welcome-prompt--extra" onclick="useSuggestion(t('welcome.suggest.email'))">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            <div class="prompt-text">
                                <h3 id="welcomeEmailTitle">R√©daction email</h3>
                                <p id="welcomeEmailDesc">Email professionnel</p>
                            </div>
                        </div>
                        
                        <div class="prompt-card prompt-card--hidden welcome-prompt--extra" onclick="useSuggestion(t('welcome.suggest.vision'))">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <div class="prompt-text">
                                <h3 id="welcomeVisionTitle">Vision AI</h3>
                                <p id="welcomeVisionDesc">Analyse d'images</p>
                            </div>
                        </div>
                        
                        <div class="prompt-card prompt-card--hidden welcome-prompt--extra" onclick="useSuggestion(t('welcome.suggest.tasks'))">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                            </svg>
                            <div class="prompt-text">
                                <h3 id="welcomeTasksTitle">Gestion t√¢ches</h3>
                                <p id="welcomeTasksDesc">Organisation et planning</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <button class="input-icon-btn" id="attachFileBtn" onclick="attachFile()" title="Joindre un fichier">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                    </svg>
                </button>
                <button class="input-icon-btn" id="voiceInputBtn" onclick="startVoiceInput()" title="Saisie vocale">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                </button>
                <button class="input-icon-btn" id="docsSearchBtn" onclick="toggleDocsSearch()" title="Docs (RAG) : utiliser mes documents">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                    </svg>
                </button>
                <textarea id="userInput" placeholder="√âcrivez votre message..." rows="1"></textarea>
                <button class="agent-btn" id="agentBtn" onclick="toggleAgentPicker()" title="Choisir un agent">Agent</button>
                <button class="input-icon-btn send-btn" id="sendBtn" onclick="sendMessage()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </div>

            <div class="agent-picker" id="agentPicker" aria-label="Liste des agents"></div>
        </div>

        <!-- Voice Mode Container -->
        <div class="voice-mode-container" id="voiceModeContainer">
            <div class="voice-orb" id="voiceOrb" onclick="toggleVoiceMode()">
                <div class="voice-particles" id="voiceParticles"></div>
                <div class="voice-orb-core">
                    <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                    </svg>
                </div>
            </div>
            <div class="voice-status-text" id="voiceStatusText">Je vous √©coute...</div>
            <div class="voice-visualizer">
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
            </div>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div class="modal" id="signupModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title" id="signupModalTitle">Cr√©er un compte</div>
                <button class="close-modal" onclick="closeSignupModal()">√ó</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form id="signupForm" onsubmit="handleSignup(event)">
                    <div style="margin-bottom: 20px;">
                        <label id="signupNameLabel" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Nom complet</label>
                        <input type="text" id="signupName" required 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="John Doe">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label id="signupEmailLabel" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Email</label>
                        <input type="email" id="signupEmail" required 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="john@example.com">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label id="signupPasswordLabel" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Mot de passe</label>
                        <input type="password" id="signupPassword" required minlength="6"
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="Minimum 6 caract√®res">
                    </div>
                    <div style="margin-bottom: 24px;">
                        <label id="signupPasswordConfirmLabel" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Confirmer le mot de passe</label>
                        <input type="password" id="signupPasswordConfirm" required minlength="6"
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="Retapez votre mot de passe">
                    </div>
                    <button type="submit" 
                        style="width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: opacity 0.2s;">
                        <span id="signupSubmitBtn">Cr√©er mon compte</span>
                    </button>
                </form>
                <div style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 14px;">
                    <span id="signupHaveAccountText">D√©j√† un compte ?</span>
                    <a id="signupSigninLink" href="#" onclick="showSignin(); return false;" style="color: var(--accent); text-decoration: none; font-weight: 500;">Se connecter</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign In Modal -->
    <div class="modal" id="signinModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title" id="signinModalTitle">Se connecter</div>
                <button class="close-modal" onclick="closeSigninModal()">√ó</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form id="signinForm" onsubmit="handleSignin(event)">
                    <div style="margin-bottom: 20px;">
                        <label id="signinEmailLabel" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Email</label>
                        <input type="email" id="signinEmail" required 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="john@example.com">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label id="signinPasswordLabel" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Mot de passe</label>
                        <input type="password" id="signinPassword" required 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="Votre mot de passe">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                        <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 14px; cursor: pointer;">
                            <input type="checkbox" id="rememberMe" style="cursor: pointer;">
                            <span id="rememberMeLabelText">Se souvenir de moi</span>
                        </label>
                        <a id="forgotPasswordLinkText" href="#" onclick="showForgotPasswordModal(); return false;" style="color: var(--accent); text-decoration: none; font-size: 14px;">Mot de passe oubli√© ?</a>
                    </div>
                    <button type="submit" 
                        style="width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: opacity 0.2s;">
                        <span id="signinSubmitBtn">Se connecter</span>
                    </button>
                </form>
                <div style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 14px;">
                    <span id="signinNoAccountText">Pas encore de compte ?</span>
                    <a id="signinCreateAccountLink" href="#" onclick="showSignup(); return false;" style="color: var(--accent); text-decoration: none; font-weight: 500;">Cr√©er un compte</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title" id="forgotPasswordModalTitle">R√©initialiser le mot de passe</div>
                <button class="close-modal" onclick="closeForgotPasswordModal()">√ó</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <svg style="width: 48px; height: 48px; margin: 0 auto 12px; display: block; color: var(--accent);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                    <p id="forgotPasswordModalSubtitle" style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;">Entrez votre email et choisissez un nouveau mot de passe</p>
                </div>
                <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
                    <div style="margin-bottom: 20px;">
                        <label id="forgotPasswordEmailLabel" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Email</label>
                        <input type="email" id="forgotPasswordEmail" required 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="john@example.com">
                    </div>
                    <div id="forgotPasswordCodeGroup" style="margin-bottom: 20px; display: none;">
                        <label id="forgotPasswordCodeLabel" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Code</label>
                        <input type="text" id="forgotPasswordCode" inputmode="numeric" pattern="[0-9]{6}" maxlength="6"
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 18px; text-align: center; letter-spacing: 6px; font-family: monospace;" 
                            placeholder="000000" autocomplete="off">
                        <p id="forgotPasswordCodeHint" style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">Entrez le code re√ßu par email</p>
                    </div>
                    <div style="margin-bottom: 24px;">
                        <label id="forgotPasswordNewLabel" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Nouveau mot de passe</label>
                        <input type="password" id="forgotPasswordNew" required minlength="6"
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="Minimum 6 caract√®res">
                        <p id="forgotPasswordMinCharsHint" style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">Minimum 6 caract√®res</p>
                    </div>
                    <button type="submit" 
                        style="width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: opacity 0.2s;">
                        <span id="forgotPasswordSubmitBtn">Changer le mot de passe</span>
                    </button>
                </form>
                <div style="text-align: center; margin-top: 20px;">
                    <a id="forgotPasswordBackToSigninLink" href="#" onclick="closeForgotPasswordModal(); showSignin(); return false;" style="color: var(--text-secondary); text-decoration: none; font-size: 14px;">‚Üê Retour √† la connexion</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Verification Modal -->
    <div class="modal" id="verificationModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title" id="verificationModalTitle">V√©rification Email</div>
                <button class="close-modal" onclick="closeVerificationModal()">√ó</button>
            </div>
            <div class="modal-body" style="padding: 24px; text-align: center;">
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 2px dashed var(--accent);">
                    <svg style="width: 48px; height: 48px; margin: 0 auto 16px; display: block; color: var(--accent);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    <p id="verificationSentToLabel" style="margin: 0 0 12px 0; color: var(--text-primary); font-weight: 500;">Code de v√©rification envoy√© √† :</p>
                    <p id="verificationEmail" style="margin: 0; color: var(--accent); font-weight: 600; font-size: 15px;"></p>
                    <div style="margin-top: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.3);">
                        <p id="verificationCodeSimLabel" style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 13px;">Code de v√©rification (simulation) :</p>
                        <p id="displayedCode" style="margin: 0; color: var(--accent); font-weight: 700; font-size: 28px; letter-spacing: 4px; font-family: monospace;"></p>
                        <p id="verificationProductionNote" style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 12px; font-style: italic;">En production, ce code sera envoy√© par email</p>
                    </div>
                </div>
                <form id="verificationForm" onsubmit="handleVerification(event)">
                    <div style="margin-bottom: 24px;">
                        <label id="verificationEnterCodeLabel" style="display: block; margin-bottom: 12px; font-weight: 500; color: var(--text-primary);">Entrez le code de v√©rification</label>
                        <input type="text" id="verificationCode" required maxlength="6" pattern="[0-9]{6}"
                            style="width: 100%; padding: 16px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 24px; text-align: center; letter-spacing: 8px; font-family: monospace; font-weight: 600;"
                            placeholder="000000"
                            autocomplete="off">
                        <p id="verificationCodeHint" style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">Code √† 6 chiffres</p>
                    </div>
                    <button type="submit"
                        style="width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer; transition: opacity 0.2s;">
                        <span id="verificationSubmitBtn">V√©rifier et Cr√©er le Compte</span>
                    </button>
                </form>
                <div style="margin-top: 20px;">
                    <a id="verificationResendLink" href="#" onclick="resendVerificationCode(); return false;" style="color: var(--accent); text-decoration: none; font-size: 14px; font-weight: 500;">Renvoyer le code</a>
                    <span style="margin: 0 8px; color: var(--text-secondary);">‚Ä¢</span>
                    <a id="verificationCancelLink" href="#" onclick="cancelVerification(); return false;" style="color: var(--text-secondary); text-decoration: none; font-size: 14px;">${t('ui.cancel')}</a>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Menu -->
    <!-- Hidden file input for profile photo -->
    <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;" onchange="handleProfilePhotoUpload(event)">
    
    <!-- User Menu (Profil utilisateur) -->
    <div class="user-menu" id="userMenu">
        <div class="user-menu-header">
            <button class="user-menu-close" id="userMenuCloseBtn" type="button" onclick="closeUserMenu(event); return false;" aria-label="${t('userMenu.close')}">√ó</button>
            <div class="user-avatar" id="userMenuAvatar" style="cursor: pointer; position: relative; overflow: hidden; border-radius: 50%; background: var(--bg-secondary);" onclick="showProfilePhoto()" title="Cliquez pour changer la photo">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 40px; height: 40px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
            </div>
            <div class="user-menu-info">
                <div class="user-menu-name" id="userMenuName"></div>
                <div class="user-menu-email" id="userMenuEmail"></div>
            </div>
        </div>
        <div class="user-menu-divider"></div>
        <div class="user-menu-items">
            <a href="#" class="user-menu-item" onclick="showProfilePhoto(); return false;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span id="userMenuProfilePhotoLabel">Photo de profil</span>
            </a>
            <a href="#" class="user-menu-item" onclick="showResetPassword(); return false;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                </svg>
                <span id="userMenuChangePasswordLabel">Changer le mot de passe</span>
            </a>
            <a href="/privacy.html" class="user-menu-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span id="userMenuPrivacyLabel">Confidentialit√©</span>
            </a>
            <a href="#" class="user-menu-item user-menu-item-danger" onclick="logout(); return false;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                <span id="userMenuLogoutLabel">Se d√©connecter</span>
            </a>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Stats Modal -->
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="statsModalTitle">Statistiques</div>
                <button class="close-modal" onclick="closeModal()">√ó</button>
            </div>
            <div id="statsContent">
                <!-- Dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- Enterprise Offer Modal -->
    <div class="modal" id="enterpriseOfferModal" style="display:none;">
        <div class="modal-content" style="max-width: 980px; width: calc(100% - 32px); height: min(760px, calc(100vh - 48px)); padding: 0; overflow: hidden;">
            <div class="modal-header" style="padding: 14px 18px; justify-content: center; position: relative;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 700;">Offre Entreprise</h2>
                <button class="close-modal" type="button" onclick="closeEnterpriseOfferModal(event); return false;" style="position: absolute; right: 18px;">√ó</button>
            </div>
            <div style="height: calc(100% - 54px); background: var(--bg-primary);">
                <iframe
                    id="enterpriseOfferFrame"
                    title="Enterprise Offer / Offre Entreprise"
                    src="/enterprise.html?embed=1"
                    style="width: 100%; height: 100%; border: 0; display: block; background: var(--bg-primary);"
                ></iframe>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal" id="aboutModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title" style="display:flex; align-items:center; gap:10px;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px; height:20px; flex:0 0 auto;">
                        <circle cx="12" cy="12" r="10" stroke-width="2" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16v-4" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8h.01" />
                    </svg>
                    <span id="aboutModalTitle">√Ä propos d'Axilum AI</span>
                </div>
                <button class="close-modal" onclick="closeAboutModal()">√ó</button>
            </div>
            <div id="aboutModalBody" style="padding: 20px;">
                <!-- Introduction -->
                <div class="about-intro">
                    <p>
                        <strong>Axilum AI</strong> est une plateforme d‚Äôassistance professionnelle unifi√©e qui combine un <strong>chat central</strong> et des <strong>modules m√©tier</strong>.
                        L‚Äôexp√©rience est organis√©e autour d‚Äô<strong>agents sp√©cialis√©s</strong> et d‚Äôun <strong>routage intelligent</strong> : vous posez vos questions dans le chat, puis vous passez (si besoin) sur un module d√©di√© (Finance, RH, R&amp;D, Marketing, Excel, Vision, Text Pro, T√¢ches‚Ä¶) pour b√©n√©ficier d‚Äôune interface et d‚Äôactions adapt√©es.
                    </p>
                    <p>
                        L‚Äôobjectif : acc√©l√©rer vos workflows (analyse, r√©daction, organisation, reporting, documents) tout en gardant une navigation simple et une continuit√© de contexte entre le chat et les modules.
                    </p>
                </div>

                <!-- Modules Office‚Ñ¢ -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <rect x="3" y="3" width="7" height="7" rx="1" stroke-width="2" />
                            <rect x="14" y="3" width="7" height="7" rx="1" stroke-width="2" />
                            <rect x="3" y="14" width="7" height="7" rx="1" stroke-width="2" />
                            <rect x="14" y="14" width="7" height="7" rx="1" stroke-width="2" />
                        </svg>
                        Modules Office‚Ñ¢ (m√©tiers)
                    </h3>
                    <div class="about-features">
                        <div class="feature-card">
                            <h4>Finance &amp; Compta ‚Äî Agent Alex</h4>
                            <p>Chat financier + interface d√©di√©e pour poser des questions, uploader des factures, et g√©n√©rer/consulter des rapports et listes (selon configuration du module Finance).</p>
                        </div>
                        <div class="feature-card">
                            <h4>HR Management Hub ‚Äî Agent RH</h4>
                            <p>Gestion RH avec √©crans d√©di√©s (employ√©s, cong√©s, paie, recrutement) et automatisations (selon configuration RH).</p>
                        </div>
                        <div class="feature-card">
                            <h4>Research &amp; Development ‚Äî Agent Dev</h4>
                            <p>Espace R&amp;D pour assister l‚Äôinnovation, structurer des id√©es, r√©diger/it√©rer et organiser des √©l√©ments de travail.</p>
                        </div>
                        <div class="feature-card">
                            <h4>Marketing &amp; Business ‚Äî Agent Mark</h4>
                            <p>Module marketing pour analyses, strat√©gie, positionnement et production de contenus (selon votre usage).</p>
                        </div>
                    </div>
                </div>

                <!-- Outils -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 7v10a2 2 0 002 2h8a2 2 0 002-2V7" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7V5a1 1 0 011-1h4a1 1 0 011 1v2" />
                        </svg>
                        Outils (productivit√©)
                    </h3>
                    <div class="about-features">
                        <div class="feature-card">
                            <h4>Excel AI Expert ‚Äî en d√©veloppement</h4>
                            <p>Page d√©di√©e pour questions Excel (formules, tableaux, analyse, graphiques) et assistance sur vos fichiers/feuilles selon votre usage.</p>
                        </div>
                        <div class="feature-card">
                            <h4>AI Task ‚Äî Agent ToDo</h4>
                            <p>Gestion de t√¢ches/organisation (to-do, planning). Les donn√©es peuvent √™tre stock√©es localement et/ou synchronis√©es selon le mode activ√©.</p>
                        </div>
                        <div class="feature-card">
                            <h4>Text Pro ‚Äî en d√©veloppement</h4>
                            <p>Traitement de texte (r√©daction, correction, traduction) avec upload (TXT/PDF/DOC/DOCX) et export (PDF/TXT + DOCX simplifi√©).</p>
                        </div>
                        <div class="feature-card">
                            <h4>AI Vision PRO ‚Äî en d√©veloppement</h4>
                            <p>Interface Vision d√©di√©e (Azure Vision) pour l‚Äôanalyse d‚Äôimages (statut/acc√®s selon plan). Le bouton ‚ÄúRetour‚Äù vous ram√®ne au chat principal.</p>
                        </div>
                        <div class="feature-card">
                            <h4>Hallucination Detector</h4>
                            <p>Mode de v√©rification: collez une r√©ponse externe et Axilum AI vous aide √† rep√©rer les zones incertaines (via HI/CHR et guidage).</p>
                        </div>
                    </div>
                </div>

                <!-- Embeddings & RAG -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" />
                        </svg>
                        Recherche documentaire (Embeddings &amp; RAG)
                    </h3>
                    <p style="margin: 8px 0 12px; color: var(--text-secondary); font-size: 13px; line-height: 1.55;">
                        Axilum AI peut enrichir ses r√©ponses avec vos documents (mode Docs). Le syst√®me indexe les contenus, retrouve les passages pertinents, puis les injecte au mod√®le pour obtenir des r√©ponses plus factuelles et mieux ancr√©es dans vos sources.
                    </p>
                    <div class="about-features">
                        <div class="feature-card">
                            <h4>Embeddings (recherche s√©mantique)</h4>
                            <p>
                                Les <strong>embeddings</strong> transforment un texte (phrase, paragraphe, document) en <strong>vecteur</strong>. Cela permet de faire une <strong>recherche par similarit√©</strong> (sens) plut√¥t que par mots-cl√©s, utile pour retrouver rapidement les passages les plus proches de votre question.
                            </p>
                        </div>
                        <div class="feature-card">
                            <h4>RAG (Retrieval‚ÄëAugmented Generation)</h4>
                            <p>
                                Le <strong>RAG</strong> combine <strong>recherche</strong> + <strong>g√©n√©ration</strong> : Axilum AI r√©cup√®re d‚Äôabord des extraits pertinents (via la recherche s√©mantique), puis g√©n√®re une r√©ponse en s‚Äôappuyant sur ces √©l√©ments. R√©sultat : moins d‚Äôhallucinations et un meilleur alignement sur vos documents.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- M√©triques HI/CHR -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        M√©triques de Fiabilit√©
                    </h3>
                    <div class="about-features">
                        <div class="feature-card">
                            <h4>HI - Hallucination Index</h4>
                            <p>Mesure le taux d'incertitude dans la r√©ponse. Plus c'est bas, mieux c'est !</p>
                        </div>
                        <div class="feature-card">
                            <h4>CHR - Coherence Rate</h4>
                            <p>√âvalue la coh√©rence et la logique interne de la r√©ponse g√©n√©r√©e.</p>
                        </div>
                    </div>
                </div>

                <!-- Dots de statut -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Indicateurs de Session
                    </h3>
                    <p>Chaque session affiche un point color√© anim√© indiquant sa qualit√© en temps r√©el :</p>
                    <div class="dot-legend">
                        <div class="dot-item">
                            <span class="dot-example green"></span>
                            <div class="dot-item-content">
                                <strong>Vert - Fiable</strong>
                                <span>HI moyen &lt; 15%</span>
                            </div>
                        </div>
                        <div class="dot-item">
                            <span class="dot-example orange"></span>
                            <div class="dot-item-content">
                                <strong>Orange - Attention</strong>
                                <span>HI moyen 15-29%</span>
                            </div>
                        </div>
                        <div class="dot-item">
                            <span class="dot-example red"></span>
                            <div class="dot-item-content">
                                <strong>Rouge - Risque</strong>
                                <span>HI moyen ‚â• 30%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Technologies -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                        </svg>
                        Stack Technique
                    </h3>
                    <div class="tech-badges">
                        <span class="tech-badge">Azure OpenAI</span>
                        <span class="tech-badge">Azure Functions</span>
                        <span class="tech-badge">Azure Static Web Apps</span>
                        <span class="tech-badge">Azure App Service (WebApp)</span>
                        <span class="tech-badge">Azure Storage (Table/Blob)</span>
                        <span class="tech-badge">Azure AI Vision (OCR)</span>
                        <span class="tech-badge">Azure Form Recognizer</span>
                        <span class="tech-badge">IndexedDB</span>
                        <span class="tech-badge">LocalStorage</span>
                        <span class="tech-badge">Node.js</span>
                        <span class="tech-badge">Express.js</span>
                        <span class="tech-badge">JWT (HS256)</span>
                        <span class="tech-badge">Docker</span>
                        <span class="tech-badge">Azure Communication Services (Email)</span>
                        <span class="tech-badge">SendGrid</span>
                        <span class="tech-badge">Brave Search API</span>
                        <span class="tech-badge">SheetJS (xlsx)</span>
                        <span class="tech-badge">Web Speech API (vocal)</span>
                        <span class="tech-badge">PDF/Exports</span>
                        <span class="tech-badge">PDFKit</span>
                        <span class="tech-badge">Axios</span>
                        <span class="tech-badge">Cheerio</span>
                        <span class="tech-badge">Embeddings (vector search)</span>
                        <span class="tech-badge">RAG (Docs)</span>
                        <span class="tech-badge">Orchestrator (Team Auto)</span>
                        <span class="tech-badge">Agent routing</span>
                        <span class="tech-badge">Multi-provider AI (Groq/OpenAI/Qwen‚Ä¶)</span>
                        <span class="tech-badge">HI/CHR metrics</span>
                        <span class="tech-badge">A/B testing (V2 rollout)</span>
                    </div>
                </div>

                <!-- Agents -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2" />
                            <circle cx="9" cy="7" r="3" stroke-width="2" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M24 21v-2a4 4 0 00-3-3.87" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 3.13a3 3 0 010 5.74" />
                        </svg>
                        Agents &amp; Routage
                    </h3>
                    <p style="margin-bottom: 15px;">
                        Axilum AI peut fonctionner en <strong>mode g√©n√©ral</strong> ou en <strong>mode agent</strong>. Vous pouvez changer d‚Äôagent via la commande <strong>/agent</strong> (ou le s√©lecteur d‚Äôagents) pour router vos messages vers une sp√©cialit√©.
                    </p>
                    <div class="about-features">
                        <div class="feature-card">
                            <h4>Chat g√©n√©ral</h4>
                            <p><strong>Axilum AI</strong> (par d√©faut) pour les demandes transverses et l‚Äôorientation vers les bons modules.</p>
                        </div>
                        <div class="feature-card">
                            <h4>Agents sp√©cialis√©s</h4>
                            <p>dev, todo, rh, mark, web, alex ‚Äî chacun correspond √† un module/usage (R&amp;D, t√¢ches, RH, marketing, recherche web, finance).</p>
                        </div>
                    </div>
                </div>

                <!-- Orchestration & Team -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16M4 12h16M4 17h16"/>
                        </svg>
                        Orchestration &amp; Team System
                    </h3>
                    <div class="about-features">
                        <div class="feature-card">
                            <h4>Orchestrateur syst√®me</h4>
                            <p>Coordonne les capacit√©s de la plateforme (agents, modules, outils) pour transformer une demande en √©tapes actionnables, et router vers la sp√©cialit√© la plus pertinente.</p>
                        </div>
                        <div class="feature-card">
                            <h4>Team System (Team Auto)</h4>
                            <p>Mode multi-agents pour les demandes complexes : planification, d√©l√©gation et synth√®se, avec un r√©sultat plus structur√© (selon la configuration et le contexte).</p>
                        </div>
                        <div class="feature-card">
                            <h4>Contexte &amp; fiabilit√©</h4>
                            <p>Gestion du contexte conversationnel, indicateurs HI/CHR, et outils d‚Äôaide √† la v√©rification pour garder des r√©ponses plus coh√©rentes et plus tra√ßables.</p>
                        </div>
                    </div>
                </div>

                <!-- Fonctions transverses -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6 2v-2m0 2a2 2 0 100-4m0 4a2 2 0 110-4m0-4V4"/>
                        </svg>
                        Capacit√©s transverses
                    </h3>
                    <div class="about-features">
                        <div class="feature-card">
                            <h4>Fichiers &amp; documents</h4>
                            <p>Upload (selon modules), extraction et traitement (ex: OCR/vision), et exports (PDF/TXT/DOCX simplifi√©) pour vos contenus.</p>
                        </div>
                        <div class="feature-card">
                            <h4>Vocal</h4>
                            <p>Saisie vocale et lecture (Web Speech API), pratique pour dicter, reformuler et gagner du temps.</p>
                        </div>
                        <div class="feature-card">
                            <h4>Recherche web</h4>
                            <p>Agent web (Brave Search) pour obtenir du contexte externe quand c‚Äôest n√©cessaire, puis synth√®se et int√©gration dans la r√©ponse.</p>
                        </div>
                        <div class="feature-card">
                            <h4>Images</h4>
                            <p>Analyse d‚Äôimages (Vision/OCR) et g√©n√©ration d‚Äôimages (selon le mode/les options activ√©s).</p>
                        </div>
                        <div class="feature-card">
                            <h4>Comptes &amp; s√©curit√©</h4>
                            <p>Authentification, v√©rification email et gestion d‚Äôacc√®s (selon d√©ploiement), avec options de stockage local et/ou synchronis√©.</p>
                        </div>
                        <div class="feature-card">
                            <h4>Int√©grations</h4>
                            <p>Services Azure (OpenAI/Functions/Storage/Vision) et connecteurs optionnels (ex: calendrier) selon votre configuration.</p>
                        </div>
                    </div>
                </div>

                <!-- Donn√©es & Confidentialit√© -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
                        </svg>
                        Donn√©es, stockage &amp; export
                    </h3>
                    <p>
                        Axilum AI g√®re des donn√©es (conversations, t√¢ches, √©v√©nements, param√®tres) avec un <strong>stockage local</strong> (IndexedDB/LocalStorage) et un mode <strong>Cloud s√©curis√©</strong> (compte requis). En mode Cloud, l‚Äôacc√®s est prot√©g√© par <strong>JWT sign√©</strong> et les donn√©es sont <strong>isol√©es par utilisateur</strong> c√¥t√© serveur (y compris pour les √©l√©ments Finance). Vous pouvez exporter vos conversations et consulter la page <a href="/privacy.html">Confidentialit√©</a> pour le d√©tail.
                    </p>
                </div>

                <!-- Company Info -->
                <div class="company-info">
                    <h4>
                        <svg style="width: 22px; height: 22px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        D√©velopp√© par AI Solutions Hub¬Æ
                    </h4>
                    <p><strong>AI Solutions Hub¬Æ</strong> - Entreprise innovante sp√©cialis√©e dans le d√©veloppement de solutions d'intelligence artificielle de confiance et √©thique.</p>
                    <p style="margin-top: 15px;">
                        <svg style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <strong>Support :</strong> <a href="mailto:support@solutionshub.uk">support@solutionshub.uk</a>
                    </p>
                    <p style="margin-top: 10px; font-size: 13px; opacity: 0.9;">
                        ¬© 2025 AI Solutions Hub¬Æ. Tous droits r√©serv√©s.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title" id="settingsModalTitle">Param√®tres</div>
                <button class="close-modal" onclick="closeSettingsModal()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <!-- Langue -->
                <div class="about-section" id="languageSettingsSection">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke-width="2" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 12h20" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2c2.5 2.7 4 6.3 4 10s-1.5 7.3-4 10c-2.5-2.7-4-6.3-4-10s1.5-7.3 4-10z" />
                        </svg>
                        <span id="languageSectionTitle">Langue</span>
                    </h3>
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color);">
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <label for="languageSelect" id="languageLabel" style="min-width:140px; color: var(--text-secondary); font-size: 13px;">Langue</label>
                            <select id="languageSelect" onchange="onLanguageChanged()" style="flex:1; min-width:240px; padding:10px; border:1px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                                <option value="fr">Fran√ßais</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div id="languageHelp" style="margin-top:10px; color: var(--text-secondary); font-size: 13px; line-height: 1.4;">Appliqu√© √† l‚Äôinterface et √† la voix.</div>
                    </div>
                </div>

                <!-- Apparence -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="5" stroke-width="2" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 1v2" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21v2" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.22 4.22l1.42 1.42" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.36 18.36l1.42 1.42" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 12h2" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12h2" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.22 19.78l1.42-1.42" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.36 5.64l1.42-1.42" />
                        </svg>
                        <span id="appearanceSectionTitle">Apparence</span>
                    </h3>
                    <div class="feature-card" style="cursor: pointer;" onclick="toggleTheme()">
                        <h4>
                            <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                            </svg>
                            <span id="themeToggleTitle">Th√®me Sombre / Clair</span>
                        </h4>
                        <p id="themeToggleDesc">Basculer entre le mode clair et sombre</p>
                    </div>
                </div>

                <!-- IA -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <rect x="4" y="4" width="16" height="16" rx="2" ry="2" stroke-width="2" />
                            <rect x="9" y="9" width="6" height="6" stroke-width="2" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v3" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 1v3" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20v3" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 20v3" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 9h3" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 15h3" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 9h3" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 15h3" />
                        </svg>
                        <span id="aiSectionTitle">IA</span>
                    </h3>
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color);">
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <label for="aiModelSelect" id="aiModelLabel" style="min-width:140px; color: var(--text-secondary); font-size: 13px;">Mod√®le IA</label>
                            <select id="aiModelSelect" onchange="onAiModelChanged()" style="flex:1; min-width:240px; padding:10px; border:1px solid var(--border-color); border-radius:10px; background:var(--bg-primary); color:var(--text-primary);">
                                <option value="">Chargement‚Ä¶</option>
                            </select>
                        </div>
                        <div id="aiModelHelp" class="ai-model-help" style="margin-top:10px; color: var(--text-secondary); font-size: 13px; line-height: 1.4;"></div>

                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--border-color);">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap: wrap;">
                                <div style="min-width: 240px;">
                                    <div style="font-weight: 800; color: var(--text-primary);">Embeddings (recherche s√©mantique)</div>
                                    <div style="margin-top: 4px; color: var(--text-secondary); font-size: 13px; line-height: 1.4;">Active la recherche vectorielle/hybride dans vos documents.</div>
                                </div>
                                <div style="display:flex; align-items:center; gap: 10px; flex-wrap: wrap;">
                                    <div class="settings-plan-toggle" id="docsEmbToggle" aria-label="Embeddings (docs)">
                                        <button type="button" class="settings-plan-btn" id="docsEmbOff" title="Embeddings d√©sactiv√©s">OFF</button>
                                        <button type="button" class="settings-plan-btn" id="docsEmbOn" title="Embeddings activ√©s">ON</button>
                                    </div>
                                    <button type="button" class="settings-plan-btn" id="docsUiOpenBtn" onclick="openDocsModal()" title="Ouvrir mes documents" style="min-width: 160px;">Mes documents</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mode -->
                
                        <!-- MCP Section -->
                        <div style="margin-top:12px;padding-top:12px;padding-bottom:20px;border-top:1px dashed var(--border-color);">
                            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
                                <div style="min-width:240px;">
                                    <div style="font-weight:800;color:var(--text-primary);">Model Context Protocol (MCP)</div>
                                    <div style="margin-top:4px;color:var(--text-secondary);font-size:13px;line-height:1.4;">Autorise l'IA √† utiliser des outils externes (Email, Calendrier, Slack...).</div>
                                </div>
                                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                                    <div class="settings-plan-toggle" id="mcpToggle">
                                        <button type="button" class="settings-plan-btn" id="mcpOff" onclick="setMcpOn(false)">OFF</button>
                                        <button type="button" class="settings-plan-btn" id="mcpOn" onclick="setMcpOn(true)">ON</button>
                                    </div>
                                    <button type="button" id="mcpConfigBtn" onclick="openMcpConnectionsModal()" style="display:none;padding:8px 16px;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;">‚öôÔ∏è Configurer</button>
                                </div>
                            </div>
                            <div id="mcpQuickStatus" style="display:none;margin-top:12px;padding:12px;background:linear-gradient(135deg,rgba(52,211,153,0.1),rgba(59,130,246,0.1));border-radius:10px;border:1px solid rgba(52,211,153,0.3);">
                                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
                                    <div style="display:flex;align-items:center;gap:8px;">
                                        <span style="color:#34d399;font-size:16px;">‚úì</span>
                                        <span style="font-size:13px;color:var(--text-primary);">MCP Actif</span>
                                        <span id="mcpConnectedCount" style="font-size:12px;color:var(--text-secondary);">‚Ä¢ 0 services connect√©s</span>
                                    </div>
                                    <button type="button" onclick="openMcpConnectionsModal()" style="padding:6px 12px;background:var(--bg-sidebar);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;font-size:12px;color:var(--text-primary);">G√©rer les connexions ‚Üí</button>
                                </div>
                            </div>
                        </div>

                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <rect x="1" y="5" width="22" height="14" rx="7" ry="7" stroke-width="2" />
                            <circle cx="8" cy="12" r="3" stroke-width="2" />
                        </svg>
                        <span id="modeSectionTitle">Mode</span>
                    </h3>
                    <div class="settings-plan-toggle" id="settingsPlanToggle" aria-label="S√©lecteur de mode">
                        <button type="button" class="settings-plan-btn" id="settingsPlanFree" title="Mode FREE">FREE</button>
                        <button type="button" class="settings-plan-btn" id="settingsPlanPro" title="Mode PRO">PRO</button>
                    </div>
                    <p id="modeHelp" style="margin-top:10px; color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
                        Choisissez votre mode de fonctionnement. Certaines fonctionnalit√©s peuvent √™tre limit√©es selon le mode.
                    </p>
                </div>

                <!-- Donn√©es -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <ellipse cx="12" cy="5" rx="9" ry="3" stroke-width="2" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12c0 1.66 4.03 3 9 3s9-1.34 9-3" />
                        </svg>
                        <span id="dataSectionTitle">Gestion des Donn√©es</span>
                    </h3>
                    <div class="about-features">
                        <div class="feature-card" style="cursor: pointer;" onclick="window.location.href='/privacy.html'">
                            <h4 id="dataPrivacyTitle">Confidentialit√©</h4>
                            <p id="dataPrivacyDesc">Local vs Cloud, s√©curit√© et conservation</p>
                        </div>
                        <div class="feature-card" style="cursor: pointer;" onclick="exportAllConversations()">
                            <h4 id="dataExportTitle">Exporter Tout</h4>
                            <p id="dataExportDesc">T√©l√©charger toutes vos conversations</p>
                        </div>
                        <div class="feature-card" style="cursor: pointer;" onclick="confirmClearData()">
                            <h4 id="dataClearTitle">Effacer Donn√©es</h4>
                            <p id="dataClearDesc">Supprimer toutes les conversations</p>
                        </div>
                        <div class="feature-card" style="cursor: pointer;" onclick="openStorageModeModal()">
                            <h4 id="storageModeTitle">Mode de stockage</h4>
                            <p><span id="storageModePrefix">Choix actuel :</span> <strong id="storageModeValue">Demander √† chaque upload</strong></p>
                        </div>
                    </div>
                </div>

                <!-- Tarification & consommation -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke-width="2" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8.5c0-1.38-1.79-2.5-4-2.5s-4 1.12-4 2.5 1.79 2.5 4 2.5 4 1.12 4 2.5-1.79 2.5-4 2.5-4-1.12-4-2.5" />
                        </svg>
                        <span id="pricingSectionTitle">Tarification &amp; consommation</span>
                    </h3>
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color);">
                        <p id="pricingP1" style="margin: 0; color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
                            <strong>Axilum AI fonctionne en pr√©pay√© :</strong> vous chargez un cr√©dit (en $) et vous pouvez utiliser tous les modules tant que ce cr√©dit n‚Äôest pas √©puis√©.
                            La consommation est calcul√©e c√¥t√© serveur √† partir des usages r√©els (tokens, appels IA) et d√©duite automatiquement.
                        </p>
                        <p id="pricingP2" style="margin: 10px 0 0; color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
                            <strong>O√π voir le solde ?</strong> Le compteur en haut affiche votre cr√©dit restant.
                            <strong>Pour voir le d√©tail</strong> (p√©riode, co√ªt IA, etc.), cliquez directement sur ce compteur.
                        </p>
                        <p id="pricingP3" style="margin: 10px 0 0; color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
                            <strong>Devise :</strong> la facturation est en $ (USD).
                            Utilisez le taux de change actuel pour confirmer le prix.
                        </p>
                        <p id="pricingP4" style="margin: 10px 0 0; color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
                            <strong>Prix stockage :</strong> Quota inclus : 100 Mo gratuit. Au-del√† : 0.10 $ / Go / mois. Packs : +5, +10, +50 Go.
                        </p>

                        <div id="pricingCostInfo" style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--border-color); color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
                            <div id="pricingCostTitle" style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">Co√ªt (Cost)</div>
                            <div id="pricingCostBody">Le <strong>prompt</strong> correspond aux tokens d‚Äôentr√©e (vos messages, instructions). La <strong>completion</strong> correspond aux tokens de sortie (la r√©ponse g√©n√©r√©e).</div>
                        </div>

                        <div id="pricingByModelTitle" style="margin-top: 14px; font-weight: 700; color: var(--text-primary); font-size: 13px;">Prix par mod√®le :</div>
                        <div id="pricingByModelBody" style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">Chargement‚Ä¶</div>
                    </div>
                </div>

                <!-- Version -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke-width="2" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16v-4" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8h.01" />
                        </svg>
                        <span id="infoSectionTitle">Informations</span>
                    </h3>
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color);">
                        <p id="infoContent" style="margin: 0; color: var(--text-secondary); font-size: 13px;">
                            <strong>Version :</strong> 1.0.0<br>
                            <strong>Derni√®re mise √† jour :</strong> D√©cembre 2025<br>
                            <strong>Build :</strong> Production
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Docs Modal (Param√®tres > Mes documents) -->
    <div class="modal" id="docsModal" style="display:none;">
        <div class="modal-content" style="max-width: 760px;">
            <div class="modal-header">
                <div class="modal-title" style="display:flex; align-items:center; gap:10px;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px; height:20px; flex:0 0 auto;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7V4a2 2 0 012-2h6a2 2 0 012 2v3" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 6h6" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 7h12a2 2 0 012 2v4a5 5 0 01-5 5H9a5 5 0 01-5-5V9a2 2 0 012-2z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 16l4 4" />
                        <circle cx="14" cy="14" r="3" stroke-width="2" />
                    </svg>
                    <span>Mes documents</span>
                </div>
                <button class="close-modal" onclick="closeDocsModal()">√ó</button>
            </div>

            <div style="padding: 20px;">
                <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-color);">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap: wrap;">
                        <div>
                            <div style="font-weight: 800; color: var(--text-primary);">Recherche docs</div>
                            <div id="docsModalStatus" style="margin-top: 4px; color: var(--text-secondary); font-size: 13px; line-height: 1.4;">‚Äî</div>
                        </div>
                        <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" class="settings-plan-btn" onclick="toggleDocsSearch()" style="min-width: 180px;">Activer/D√©sactiver</button>
                            <button type="button" class="settings-plan-btn" onclick="attachFile()" style="min-width: 180px;">Indexer un fichier</button>
                            <button type="button" class="settings-plan-btn" onclick="clearAllIndexedDocs()" style="min-width: 210px; border-color: rgba(239, 68, 68, 0.45);">Supprimer tous mes docs</button>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 12px; background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-color);">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap: wrap;">
                        <div style="font-weight: 800; color: var(--text-primary);">Derniers documents index√©s</div>
                        <button type="button" class="settings-plan-btn" onclick="clearDocsIndexedMeta()" style="min-width: 200px;">Effacer la liste</button>
                    </div>
                    <div id="docsModalIndexed" style="margin-top: 10px; color: var(--text-secondary); font-size: 13px; line-height: 1.5;">‚Äî</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Usage Dashboard Modal (clic sur le compteur quota) -->
    <div class="modal" id="usageDashboardModal" style="display:none;">
        <div class="modal-content" style="max-width: 760px;">
            <div class="modal-header">
                <div class="modal-title" style="display:flex; align-items:center; gap:10px;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px; height:20px; flex:0 0 auto;">
                        <circle cx="12" cy="12" r="10" stroke-width="2" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8.5c0-1.38-1.79-2.5-4-2.5s-4 1.12-4 2.5 1.79 2.5 4 2.5 4 1.12 4 2.5-1.79 2.5-4 2.5-4-1.12-4-2.5" />
                    </svg>
                    <span id="usageDashboardTitle">Consommation</span>
                </div>
                <button class="close-modal" onclick="closeUsageDashboardModal()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <div id="usageDashboardMeta" style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;"></div>

                <div style="display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; margin-bottom: 14px;">
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 10px; border: 1px solid var(--border-color);">
                        <div id="usageDashboardBalanceLabel" style="color: var(--text-secondary); font-size: 12px;">Cr√©dit restant</div>
                        <div id="usageDashboardBalance" style="color: var(--text-primary); font-size: 18px; font-weight: 700; margin-top: 4px;">‚Äî</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 10px; border: 1px solid var(--border-color);">
                        <div id="usageDashboardMonthCostLabel" style="color: var(--text-secondary); font-size: 12px;">Co√ªt (mois)</div>
                        <div id="usageDashboardMonthCost" style="color: var(--text-primary); font-size: 18px; font-weight: 700; margin-top: 4px;">‚Äî</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 10px; border: 1px solid var(--border-color);">
                        <div id="usageDashboardMonthTokensLabel" style="color: var(--text-secondary); font-size: 12px;">Appels &amp; tokens</div>
                        <div id="usageDashboardMonthTokens" style="color: var(--text-primary); font-size: 14px; font-weight: 700; margin-top: 6px;">‚Äî</div>
                    </div>
                </div>

                <div style="background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border-color); overflow: hidden;">
                    <div id="usageDashboardLatestTitle" style="padding: 12px; border-bottom: 1px solid var(--border-color); color: var(--text-primary); font-weight: 700;">Derniers appels</div>
                    <div id="usageDashboardBody" style="padding: 12px; color: var(--text-secondary); font-size: 13px;">Chargement‚Ä¶</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Mode Modal (Param√®tres > Mode de stockage) -->
    <div class="modal" id="storageModeModal" style="display:none;">
        <div class="modal-content" style="max-width: 760px;">
            <div class="modal-header">
                <div class="modal-title" style="display:flex; align-items:center; gap:10px;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px; height:20px; flex:0 0 auto;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7a4 4 0 014-4h8a4 4 0 014 4v10a4 4 0 01-4 4H8a4 4 0 01-4-4V7z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 8h8M8 12h8M8 16h6" />
                    </svg>
                    <span id="storageModeModalHeaderLabel">Stockage</span>
                </div>
                <button class="close-modal" onclick="closeStorageModeModal()">√ó</button>
            </div>

            <div style="padding: 20px;">
                <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-color);">
                    <div id="storageModeModalModeTitle" style="font-weight: 800; color: var(--text-primary); margin-bottom: 8px;">Mode de stockage</div>

                    <div style="display:flex; gap:10px; flex-wrap: wrap;">
                        <button type="button" class="settings-plan-btn" id="storageModeBtnAsk" onclick="setStorageMode('ask')" style="min-width: 160px;">Demander</button>
                        <button type="button" class="settings-plan-btn" id="storageModeBtnLocal" onclick="setStorageMode('local')" style="min-width: 160px;">Local</button>
                        <button type="button" class="settings-plan-btn" id="storageModeBtnCloud" onclick="setStorageMode('cloud')" style="min-width: 160px;">Cloud</button>
                    </div>

                    <p id="storageModeModalHelp" style="margin: 10px 0 0; color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
                        <strong>Local</strong> : les fichiers restent sur votre appareil. <strong>Cloud</strong> : synchronisation serveur (connexion requise).
                    </p>
                </div>

                <div style="margin-top: 12px; background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-color);">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px;">
                        <div>
                            <div id="storageQuotaTitle" style="font-weight: 800; color: var(--text-primary);">Quota stockage Cloud</div>
                            <div id="storageQuotaSubtitle" style="color: var(--text-secondary); font-size: 13px; margin-top: 4px;">Indication (pour activer/acheter du stockage)</div>
                        </div>
                        <a id="storageQuotaAddBtn" href="javascript:void(0)" onclick="openStorageAddModal()" style="color: var(--accent); font-weight: 600; cursor: pointer; text-decoration: none;">Ajouter du stockage</a>
                    </div>

                    <div style="margin-top: 10px; display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px;">
                        <div style="background: var(--bg-primary); padding: 12px; border-radius: 10px; border: 1px solid var(--border-color);">
                            <div id="storageQuotaTotalLabel" style="color: var(--text-secondary); font-size: 12px;">Quota total</div>
                            <div id="storageQuotaTotal" style="color: var(--text-primary); font-size: 18px; font-weight: 800; margin-top: 4px;">‚Äî</div>
                        </div>
                        <div style="background: var(--bg-primary); padding: 12px; border-radius: 10px; border: 1px solid var(--border-color);">
                            <div id="storageQuotaUsedLabel" style="color: var(--text-secondary); font-size: 12px;">Utilis√©</div>
                            <div id="storageQuotaUsed" style="color: var(--text-primary); font-size: 18px; font-weight: 800; margin-top: 4px;">‚Äî</div>
                        </div>
                        <div style="background: var(--bg-primary); padding: 12px; border-radius: 10px; border: 1px solid var(--border-color);">
                            <div id="storageQuotaRemainingLabel" style="color: var(--text-secondary); font-size: 12px;">Reste</div>
                            <div id="storageQuotaRemaining" style="color: var(--text-primary); font-size: 18px; font-weight: 800; margin-top: 4px;">‚Äî</div>
                        </div>
                    </div>
                    <div id="storageQuotaHint" style="margin-top: 10px; color: var(--text-secondary); font-size: 13px; line-height: 1.5;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Add Modal (choix pack) -->
    <div class="modal" id="storageAddModal" style="display:none;">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <div class="modal-title" id="storageAddModalTitle">Ajouter du stockage</div>
                <button class="close-modal" onclick="closeStorageAddModal()">√ó</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <p id="storageAddModalDesc" style="margin: 0 0 12px; color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
                    S√©lectionnez un pack. (UI pr√™te ‚Äî paiement/activation automatique √† brancher ensuite.)
                </p>
                <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <button id="storageAddPack5" type="button" class="settings-plan-btn" onclick="addStorageAddonGb(5)" style="min-width: 140px;">+5 Go</button>
                    <button id="storageAddPack10" type="button" class="settings-plan-btn" onclick="addStorageAddonGb(10)" style="min-width: 140px;">+10 Go</button>
                    <button id="storageAddPack50" type="button" class="settings-plan-btn" onclick="addStorageAddonGb(50)" style="min-width: 140px;">+50 Go</button>
                </div>
                <div id="storageAddStatus" style="margin-top: 12px; color: var(--text-secondary); font-size: 13px;"></div>
            </div>
        </div>
    </div>

    <!-- Overlay pour panneaux -->
    <div id="panelOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1050;" onclick="closeAllPanels()"></div>

    <!-- Panneau Fonctions (slideout droite) -->
    <div id="functionsPanel" style="position:fixed; top:0; right:-100%; width:90%; max-width:600px; height:100vh; background:var(--bg-primary); z-index:1100; transition:right 0.3s ease; box-shadow:-2px 0 10px rgba(0,0,0,0.2); overflow-y:auto;">
        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:20px; color:var(--text-primary);">Fonctions</h2>
            <button onclick="closeFunctionsPanel()" style="background:none; border:none; font-size:28px; cursor:pointer; color:var(--text-primary);">√ó</button>
        </div>
        <div id="functionsPanelBody" style="padding:20px;"></div>
    </div>

    <!-- Panneau Outils (slideout droite) -->
    <div id="toolsPanel" style="position:fixed; top:0; right:-100%; width:90%; max-width:600px; height:100vh; background:var(--bg-primary); z-index:1100; transition:right 0.3s ease; box-shadow:-2px 0 10px rgba(0,0,0,0.2); overflow-y:auto;">
        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:20px; color:var(--text-primary);">Outils</h2>
            <button onclick="closeToolsPanel()" style="background:none; border:none; font-size:28px; cursor:pointer; color:var(--text-primary);">√ó</button>
        </div>
        <div id="toolsPanelBody" style="padding:20px;"></div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Protection Alert -->
    <div class="protection-overlay" id="protectionOverlay"></div>
    <div class="protection-alert" id="protectionAlert">
        <div class="protection-header">
            <span class="protection-icon" id="protectionIcon"></span>
            <div>
                <h3 class="protection-title" id="protectionTitle"></h3>
            </div>
        </div>
        <p class="protection-description" id="protectionDescription"></p>
        <div class="protection-stats" id="protectionStats"></div>
        <div class="protection-actions" id="protectionActions"></div>
    </div>

    <!-- File Input -->
    <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.xlsx,.xls,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,text/csv,.jpg,.jpeg,.png,.gif,.webp,image/*" onchange="handleFileUpload(event)">

    <script>
        // Configuration
        const AGENT_ENDPOINT_PRO = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:7071/api/agents/axilum/invoke'
            : '/api/agents/axilum/invoke';
        
        const AGENT_ENDPOINT_FREE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:7071/api/invoke-free'
            : '/api/invoke-free';
        
        // Get current endpoint based on plan
        function getEndpoint() {
            // Toujours utiliser l'endpoint standard
            return currentPlan === 'free' ? AGENT_ENDPOINT_FREE : AGENT_ENDPOINT_PRO;
        }
        
        // D√©termine si on utilise V2 via le param√®tre useV2
        function shouldUseV2ForRequest(rolloutPercentage) {
            // üß™ A/B TESTING: Tester architecture V2 sur un pourcentage d'utilisateurs
            const V2_ROLLOUT_PERCENTAGE = rolloutPercentage || 0; // 0% = d√©sactiv√©, 10 = 10%, 100 = 100%
            
            // V√©rifier si cet utilisateur fait partie du test V2
            return shouldUseV2(V2_ROLLOUT_PERCENTAGE);
        }
        
        // D√©termine si cet utilisateur doit utiliser V2
        function shouldUseV2(percentage) {
            if (percentage === 0) return false;
            if (percentage === 100) return true;
            
            // Hash stable bas√© sur user ID ou session
            const userId = currentUser?.id || sessionStorage.getItem('sessionId') || createSessionId();
            const hash = simpleHash(userId);
            
            return (hash % 100) < percentage;
        }
        
        // Cr√©er un ID de session persistant
        function createSessionId() {
            let sessionId = sessionStorage.getItem('sessionId');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('sessionId', sessionId);
            }
            return sessionId;
        }
        
        // Hash simple pour distribution stable
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        // State
        // ‚ö†Ô∏è Conversations ne doivent plus √™tre persist√©es en base64 dans localStorage (quota).
        // Elles sont d√©sormais charg√©es depuis IndexedDB (avec migration automatique).
        let conversations = [];
        let currentConversationId = null;
        // Chat principal: type d'agent actif (permet de router vers diff√©rents prompts c√¥t√© backend)
        let currentChatType = localStorage.getItem('axilumChatType') || 'axilum';
        let messageStats = JSON.parse(localStorage.getItem('messageStats') || '{"hiHistory":[],"chrHistory":[]}');
        let isRecording = false;
        let recognition = null;

        // ===================================
        // ü§ñ Mod√®le IA (s√©lection utilisateur)
        // ===================================
        const DEFAULT_AI_MODEL = 'llama-3.3-70b-versatile';
        const AI_MODEL_LS_ACTIVE = 'axilum_ai_model';

        let aiModelsCache = [];

        let activeAiModel = (() => {
            try {
                return String(localStorage.getItem(AI_MODEL_LS_ACTIVE) || '').trim();
            } catch (_) {
                return '';
            }
        })();

        function getAiModelShortName(modelId) {
            const raw = String(modelId || '').trim();
            if (!raw) return '';

            // Noms exacts demand√©s (dropdown + panneau actif)
            const KNOWN = {
                'llama-3.1-8b-instant': 'Llama 3.1 8B instant',
                'llama-3.3-70b-versatile': 'Llama 3.3 70B versatile',
                'moonshotai/kimi-k2-instruct': 'Kimi K2 instruct',
                'moonshotai/kimi-k2-instruct-0905': 'Kimi K2 instruct 0905',
                'openai/gpt-oss-120b': 'ChatGPT-oss-120b',
                'openai/gpt-oss-20b': 'ChatGPT-oss-20b',
                'qwen/qwen3-32b': 'Qwen3 32B'
            };
            if (KNOWN[raw]) return KNOWN[raw];

            const parts = raw.split('/').filter(Boolean);
            const model = parts.length ? parts[parts.length - 1] : raw;
            const m = model.toLowerCase();

            if (m.includes('gpt') || m.includes('chatgpt') || m.includes('o1') || m.includes('o3')) return 'ChatGPT';
            if (m.includes('kimi')) return 'Kimi';
            if (m.includes('qwen')) return 'Qwen';
            if (m.includes('gemini')) return 'Gemini';
            if (m.includes('claude')) return 'Claude';
            if (m.includes('llama')) return 'Llama';
            if (m.includes('mistral')) return 'Mistral';
            if (m.includes('deepseek')) return 'DeepSeek';

            const base = model.split(/[-:_\s]+/).filter(Boolean)[0] || model;
            return base.charAt(0).toUpperCase() + base.slice(1);
        }

        function getAiProviderDisplayName(providerKey) {
            const p = String(providerKey || '').trim().toLowerCase();
            if (!p) return 'N/A';
            if (p === 'openai') return 'OpenAI';
            if (p === 'qwen') return 'Qwen';
            if (p === 'moonshotai') return 'Moonshot AI';
            if (p === 'meta-llama') return 'Meta';
            if (p === 'groq') return 'Groq';
            if (p === 'canopylabs') return 'CanopyLabs';
            return providerKey;
        }

        function getAiProviderUrl(providerKey) {
            const p = String(providerKey || '').trim().toLowerCase();
            if (p === 'openai') return 'https://openai.com/';
            if (p === 'qwen') return 'https://www.alibabacloud.com/en?_p_lc=1&spm=a3c0i.29328889.9556232360.1.29722d2f639qyD';
            if (p === 'moonshotai') return 'https://www.moonshot.cn/';
            if (p === 'meta-llama') return 'https://ai.meta.com/llama/';
            if (p === 'groq') return 'https://groq.com/';
            if (p === 'canopylabs') return 'https://canopylabs.ai/';
            return '';
        }

        function getAiModelProvider(modelId) {
            const raw = String(modelId || '').trim();
            if (!raw) return '';
            const parts = raw.split('/').filter(Boolean);
            if (parts.length >= 2) return parts[0];
            return 'groq';
        }

        function getAiModelPreferences(modelEntry) {
            const catRaw = String(modelEntry?.category || '').trim();
            if (!catRaw) return '';
            const tokens = catRaw.split('/').map(s => String(s || '').trim()).filter(Boolean);
            const cleaned = tokens.filter(t => !/function\s*calling/i.test(t));
            return cleaned.join(', ');
        }

        function safeT(key, fallback) {
            try {
                if (typeof t !== 'function') return fallback;
                const v = t(key);
                if (!v || v === key) return fallback;
                return v;
            } catch (_) {
                return fallback;
            }
        }

        function getActiveAiModel() {
            const m = String(activeAiModel || '').trim();
            return m || DEFAULT_AI_MODEL;
        }

        function setActiveAiModel(modelId) {
            activeAiModel = String(modelId || '').trim();
            try {
                localStorage.setItem(AI_MODEL_LS_ACTIVE, activeAiModel);
            } catch (_) {}
        }

        function getSelectedAiModel() {
            // Mod√®le r√©ellement utilis√© c√¥t√© API
            return getActiveAiModel();
        }

        function onAiModelChanged() {
            const sel = document.getElementById('aiModelSelect');
            if (!sel) return;
            const next = String(sel.value || '').trim();
            const nextId = next || DEFAULT_AI_MODEL;
            setActiveAiModel(nextId);
            try {
                const nice = getAiModelShortName(nextId) || nextId;
                showToast(t('ai.toast.modelValidated').replace('{model}', nice), 'success');
            } catch (_) {}
            try { updateAiModelHelp(); } catch (_) {}
        }

        function updateAiModelHelp(models) {
            const help = document.getElementById('aiModelHelp');
            if (!help) return;

            if (Array.isArray(models)) aiModelsCache = models;
            const list = Array.isArray(models) ? models : (Array.isArray(aiModelsCache) ? aiModelsCache : []);

            const active = getActiveAiModel();
            const activeName = getAiModelShortName(active) || active;

            const m = Array.isArray(list) ? list.find(x => x && String(x.id || '').trim() === active) : null;
            const hasPricing = m && (m.in != null || m.out != null);
            const cur = m ? (String(m.pricingCurrency || '').toUpperCase() || '') : '';
            const inRate = hasPricing && m.in != null && Number.isFinite(Number(m.in)) ? Number(m.in) : null;
            const outRate = hasPricing && m.out != null && Number.isFinite(Number(m.out)) ? Number(m.out) : null;
            const inTxt = inRate == null ? 'N/A' : `${inRate} ${cur}/1M tokens (${t('ai.help.inSuffix')})`;
            const outTxt = outRate == null ? 'N/A' : `${outRate} ${cur}/1M tokens (${t('ai.help.outSuffix')})`;

            const provider = getAiModelProvider(active);
            const providerName = getAiProviderDisplayName(provider);
            const providerUrl = getAiProviderUrl(provider);
            const fullCategory = m && m.category ? String(m.category) : 'N/A';


            help.innerHTML = `
                <div class="stat-section-title">${safeT('ai.help.sectionTitle', 'Active model')}</div>

                <div class="stat-item left">
                    <span>${safeT('ai.help.activePrefix', 'Mod√®le actif:')}</span>
                    <span class="stat-value"><span class="status-dot green" style="display:inline-block; width:10px; height:10px; margin-right:8px; vertical-align:middle;"></span>${activeName}</span>
                </div>
                <div class="stat-item left">
                    <span>${safeT('ai.help.provider', 'Provider:')}</span>
                    <span class="stat-value">${providerName}</span>
                </div>
                <div class="stat-item left">
                    <span>${safeT('ai.help.category', 'Fonctions:')}</span>
                    <span class="stat-value">${fullCategory}</span>
                </div>
                ${providerUrl ? `
                    <div class="hint">
                        ${safeT('ai.help.moreInfo', 'Pour plus d\'informations :')} <a href="${providerUrl}" target="_blank" rel="noopener noreferrer"><strong>${providerName}</strong></a>
                    </div>
                ` : ''}
            `;
        }

        let pricingByModelCache = null;
        let pricingByModelFetchPromise = null;

        function formatPricingRate(value) {
            const n = Number(value);
            if (!Number.isFinite(n)) return null;
            try {
                return new Intl.NumberFormat(getLocale(), { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 6 }).format(n);
            } catch (_) {
                return String(n);
            }
        }

        function escapeHtmlLite(value) {
            const s = String(value == null ? '' : value);
            if (typeof escapeHtml === 'function') return escapeHtml(s);
            return s
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderPricingByModelTable(models) {
            const titleEl = document.getElementById('pricingByModelTitle');
            const bodyEl = document.getElementById('pricingByModelBody');
            if (titleEl) titleEl.textContent = t('settings.pricing.byModelTitle');
            if (!bodyEl) return;

            const list = Array.isArray(models) ? models : [];
            if (!list.length) {
                bodyEl.textContent = t('settings.pricing.byModel.loading');
                return;
            }

            const rows = list
                .slice()
                .sort((a, b) => String(a?.id || '').localeCompare(String(b?.id || '')))
                .map((m) => {
                    const id = String(m?.id || '').trim();
                    const cur = String(m?.pricingCurrency || '').trim().toUpperCase();
                    const inRate = m?.in != null && Number.isFinite(Number(m.in)) ? Number(m.in) : null;
                    const outRate = m?.out != null && Number.isFinite(Number(m.out)) ? Number(m.out) : null;

                    let costHtml = escapeHtmlLite(t('settings.pricing.byModel.na'));
                    if (inRate != null || outRate != null) {
                        const inTxt = inRate == null ? null : formatPricingRate(inRate);
                        const outTxt = outRate == null ? null : formatPricingRate(outRate);
                        const safeCur = escapeHtmlLite(cur || '');
                        costHtml = `<div style="color: var(--text-primary); font-weight: 700;">${escapeHtmlLite(inTxt == null ? t('settings.pricing.byModel.na') : inTxt)} ${safeCur}/1M</div>`
                            + `<div style="color: var(--text-secondary); font-size: 12px; margin-top: 2px;">${escapeHtmlLite(t('settings.pricing.byModel.prompt'))}</div>`
                            + `<div style="height: 6px;"></div>`
                            + `<div style="color: var(--text-primary); font-weight: 700;">${escapeHtmlLite(outTxt == null ? t('settings.pricing.byModel.na') : outTxt)} ${safeCur}/1M</div>`
                            + `<div style="color: var(--text-secondary); font-size: 12px; margin-top: 2px;">${escapeHtmlLite(t('settings.pricing.byModel.completion'))}</div>`;
                    }

                    return `
                        <tr style="border-top: 1px solid var(--border-color);">
                            <td style="text-align:left; padding: 10px 10px; color: var(--text-primary); font-weight: 600;">${escapeHtmlLite(id)}</td>
                            <td style="text-align:right; padding: 10px 10px;">${costHtml}</td>
                        </tr>
                    `;
                })
                .join('');

            bodyEl.innerHTML = `
                <div style="overflow:auto; border: 1px solid var(--border-color); border-radius: 10px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                                <th style="text-align:left; padding: 10px 10px; color: var(--text-primary);">${escapeHtmlLite(t('settings.pricing.byModel.table.model'))}</th>
                                <th style="text-align:right; padding: 10px 10px; color: var(--text-primary);">${escapeHtmlLite(t('settings.pricing.byModel.table.cost'))}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function refreshPricingByModelTable(forceFetch = false) {
            try {
                const cached = Array.isArray(pricingByModelCache) ? pricingByModelCache : null;
                const fromAiCache = Array.isArray(aiModelsCache) ? aiModelsCache : null;

                if (!forceFetch) {
                    if (cached && cached.length) {
                        renderPricingByModelTable(cached);
                        return;
                    }
                    if (fromAiCache && fromAiCache.length) {
                        pricingByModelCache = fromAiCache;
                        renderPricingByModelTable(fromAiCache);
                        return;
                    }
                }

                if (pricingByModelFetchPromise) {
                    await pricingByModelFetchPromise;
                    if (Array.isArray(pricingByModelCache)) renderPricingByModelTable(pricingByModelCache);
                    return;
                }

                const bodyEl = document.getElementById('pricingByModelBody');
                if (bodyEl) bodyEl.textContent = t('settings.pricing.byModel.loading');

                pricingByModelFetchPromise = (async () => {
                    const res = await fetch('/api/ai/models?purpose=chat', { method: 'GET' });
                    const data = await res.json().catch(() => null);
                    const models = (res.ok && data && Array.isArray(data.models)) ? data.models : [];
                    pricingByModelCache = models;
                })();

                await pricingByModelFetchPromise;
                pricingByModelFetchPromise = null;
                renderPricingByModelTable(pricingByModelCache);
            } catch (_) {
                try {
                    const bodyEl = document.getElementById('pricingByModelBody');
                    if (bodyEl) bodyEl.textContent = t('settings.pricing.byModel.loading');
                } catch (_) {}
            }
        }

        async function refreshAiModelSelect() {
            const sel = document.getElementById('aiModelSelect');
            if (!sel) return;

            sel.innerHTML = '<option value="">Chargement‚Ä¶</option>';

            try {
                const res = await fetch('/api/ai/models?purpose=chat', { method: 'GET' });
                const data = await res.json().catch(() => null);
                const models = (res.ok && data && Array.isArray(data.models)) ? data.models : [];

                const current = getActiveAiModel();
                const options = models.length ? models : [{ id: DEFAULT_AI_MODEL }];

                // Build labels without provider nor function-calling; add #index only if duplicates exist
                const labelCounts = new Map();
                for (const mm of options) {
                    const id = String(mm && mm.id || '').trim();
                    if (!id) continue;
                    const base = getAiModelShortName(id) || id;
                    const prefs = getAiModelPreferences(mm);
                    const label = prefs ? `${base} ‚Äî ${prefs}` : base;
                    labelCounts.set(label, (labelCounts.get(label) || 0) + 1);
                }
                const labelIndex = new Map();

                sel.innerHTML = options.map(m => {
                    const id = String(m.id || '').trim();
                    if (!id) return '';
                    const selected = id === current ? ' selected' : '';
                    const base = getAiModelShortName(id) || id;
                    const prefs = getAiModelPreferences(m);
                    const rawLabel = prefs ? `${base} ‚Äî ${prefs}` : base;
                    const count = labelCounts.get(rawLabel) || 0;
                    const idx = (labelIndex.get(rawLabel) || 0) + 1;
                    labelIndex.set(rawLabel, idx);
                    const label = count > 1 ? `${rawLabel} #${idx}` : rawLabel;
                    const title = id.replace(/"/g, '&quot;');
                    return `<option value="${id}"${selected} title="${title}">${label}</option>`;
                }).join('') || `<option value="${DEFAULT_AI_MODEL}">${DEFAULT_AI_MODEL}</option>`;

                // Si le mod√®le stock√© n'existe plus, revenir au d√©faut.
                const exists = options.some(m => String(m.id || '').trim() === current);
                if (!exists) {
                    setActiveAiModel(DEFAULT_AI_MODEL);
                    sel.value = DEFAULT_AI_MODEL;
                }

                updateAiModelHelp(options);
            } catch (_) {
                sel.innerHTML = `<option value="${DEFAULT_AI_MODEL}">${DEFAULT_AI_MODEL}</option>`;
                sel.value = DEFAULT_AI_MODEL;
                updateAiModelHelp([{ id: DEFAULT_AI_MODEL }]);
            }
        }

        function normalizeChatType(type) {
            const t = String(type || '').trim().toLowerCase();
            // G√©n√©ral
            if (t === 'axilum' || t === 'default' || t === 'general') return 'axilum';

            // Team (orchestrator auto)
            if (t === 'team' || t === 'team-auto' || t === 'orchestrator-auto') return 'team-auto';

            // Finance (alias "argent") -> Agent Alex
            if (t === 'finance-agent' || t === 'argent' || t === 'money' || t === 'finance' || t === 'compta' || t === 'accounting') return 'agent-alex';

            // Dev
            if (t === 'dev' || t === 'agent-dev' || t === 'developer') return 'agent-dev';

            // Excel
            if (t === 'xcel' || t === 'excel' || t === 'excel-expert' || t === 'excel-ai' || t === 'excel-ai-expert') return 'excel-expert';

            // ToDo
            if (t === 'todo' || t === 'task' || t === 'tasks' || t === 'agent-todo') return 'agent-todo';

            // RH
            if (t === 'rh' || t === 'hr' || t === 'hr-management') return 'hr-management';

            // Marketing
            if (t === 'mark' || t === 'marketing' || t === 'marketing-agent') return 'marketing-agent';

            // Web search
            if (t === 'web' || t === 'search' || t === 'web-search' || t === 'websearch') return 'web-search';

            // Personas l√©g√®res
            if (t === 'alex' || t === 'agent-alex') return 'agent-alex';
            if (t === 'tony' || t === 'agent-tony') return 'agent-tony';

            return 'axilum';
        }

        function setChatType(type) {
            currentChatType = normalizeChatType(type);
            localStorage.setItem('axilumChatType', currentChatType);
            return currentChatType;
        }

        // ===================================
        // üîÅ Agent Picker (UI)
        // ===================================
        const AXILUM_AGENT_CHOICES = [
            {
                label: 'Team',
                arg: 'team',
                hint: '/team auto',
                icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>'
            },
            { label: 'Axilum Ai', arg: 'axilum', hint: '/agent axilum' },
            { label: 'Agent Dev', arg: 'dev', hint: '/agent dev' },
            { label: 'Agent ToDo', arg: 'todo', hint: '/agent todo' },
            { label: 'Agent RH', arg: 'rh', hint: '/agent rh' },
            { label: 'Agent Mark', arg: 'mark', hint: '/agent mark' },
            { label: 'Agent Wesh', arg: 'web', hint: '/agent web' },
            { label: 'Agent Xcel', arg: 'excel', hint: '/agent excel' },
            { label: 'Agent Alex', arg: 'alex', hint: '/agent alex' },
            
        ];

        function activateTeamAutoMode() {
            try { setChatType('team-auto'); } catch (_) {}
            try { closeAgentPicker(); } catch (_) {}
            try { showToast(t('toast.teamAutoActivated'), 'info'); } catch (_) {}
            try {
                addMessage('ü§ù Team Auto activ√©. Posez votre question et je la route vers l‚Äôorchestrator.', 'bot');
            } catch (_) {}
        }

        function isAgentPickerOpen() {
            const picker = document.getElementById('agentPicker');
            return !!(picker && picker.style && picker.style.display !== 'none');
        }

        function closeAgentPicker() {
            const picker = document.getElementById('agentPicker');
            if (picker) picker.style.display = 'none';
        }

        function renderAgentPicker(filterText) {
            const picker = document.getElementById('agentPicker');
            if (!picker) return;

            const q = String(filterText || '').trim().toLowerCase();
            const items = AXILUM_AGENT_CHOICES.filter(a => {
                if (!q) return true;
                return String(a.label).toLowerCase().includes(q)
                    || String(a.arg).toLowerCase().includes(q)
                    || String(a.hint).toLowerCase().includes(q);
            });

            if (items.length === 0) {
                picker.innerHTML = '<div class="agent-picker-item" style="cursor: default; opacity: 0.8;">Aucun agent trouv√©<small>Essayez: dev, rh, web‚Ä¶</small></div>';
                return;
            }

            picker.innerHTML = items.map(a => {
                const safeLabel = String(a.label || '');
                const safeArg = String(a.arg || '').replace(/"/g, '&quot;');
                const icon = a && a.icon ? String(a.icon) : '';
                return `
                    <button class="agent-picker-item" type="button" data-agent-arg="${safeArg}">
                        <span class="agent-picker-left">${icon ? `<span class="agent-picker-icon">${icon}</span>` : ''}<span>${safeLabel}</span></span>
                    </button>
                `;
            }).join('');
        }

        function openAgentPicker(filterText) {
            const picker = document.getElementById('agentPicker');
            if (!picker) return;
            renderAgentPicker(filterText);
            picker.style.display = 'block';
        }

        function toggleAgentPicker() {
            if (isAgentPickerOpen()) {
                closeAgentPicker();
                return;
            }
            openAgentPicker('');
        }

        function selectAgentFromPicker(arg) {
            const input = document.getElementById('userInput');
            if (!input) return;
            closeAgentPicker();

            const chosen = String(arg || '').trim().toLowerCase();
            if (chosen === 'team') {
                activateTeamAutoMode();
                return;
            }

            input.value = `/agent ${String(arg || '').trim()}`;
            try { adjustTextareaHeight(); } catch (_) {}
            try { sendMessage(); } catch (_) {}
        }

        // Ouvrir automatiquement la liste quand l'utilisateur tape "agent" ou "/agent"
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('userInput');
            if (!input || input.dataset.agentPickerBound === '1') return;
            input.dataset.agentPickerBound = '1';

            // Appui long sur le bouton Agent => activer Team Auto
            try {
                const agentBtn = document.getElementById('agentBtn');
                if (agentBtn && agentBtn.dataset && agentBtn.dataset.teamLongPressBound !== '1') {
                    agentBtn.dataset.teamLongPressBound = '1';
                    let lpTimer = null;
                    let didLongPress = false;

                    const clear = () => {
                        if (lpTimer) {
                            clearTimeout(lpTimer);
                            lpTimer = null;
                        }
                    };

                    const start = (e) => {
                        didLongPress = false;
                        clear();
                        lpTimer = setTimeout(() => {
                            didLongPress = true;
                            try { activateTeamAutoMode(); } catch (_) {}
                        }, 650);
                    };

                    agentBtn.addEventListener('touchstart', start, { passive: true });
                    agentBtn.addEventListener('mousedown', start);
                    agentBtn.addEventListener('touchend', clear, { passive: true });
                    agentBtn.addEventListener('mouseup', clear);
                    agentBtn.addEventListener('mouseleave', clear);
                    agentBtn.addEventListener('touchcancel', clear, { passive: true });

                    // Emp√™cher l'ouverture de la liste si l'appui long a d√©clench√© Team
                    agentBtn.addEventListener('click', (e) => {
                        if (!didLongPress) return;
                        try {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                        } catch (_) {}
                        didLongPress = false;
                    }, true);
                }
            } catch (_) {}

            // Clic agent: utiliser la d√©l√©gation d'√©v√©nements (plus fiable que onclick inline)
            try {
                const picker = document.getElementById('agentPicker');
                if (picker && picker.dataset && picker.dataset.agentClickBound !== '1') {
                    picker.dataset.agentClickBound = '1';
                    // IMPORTANT: ne pas s√©lectionner sur pointerdown (trop sensible pendant le scroll).
                    // Le click est automatiquement annul√© lors d'un geste de scroll.
                    picker.addEventListener('click', (e) => {
                        const target = e && e.target ? e.target : null;
                        if (!target) return;
                        const btn = target.closest ? target.closest('.agent-picker-item[data-agent-arg]') : null;
                        if (!btn) return;
                        const arg = btn.getAttribute('data-agent-arg');
                        if (!arg) return;
                        try {
                            e.preventDefault();
                            e.stopPropagation();
                        } catch (_) {}
                        try { selectAgentFromPicker(arg); } catch (_) {}
                    }, true);
                }
            } catch (_) {}

            const onInput = () => {
                const text = String(input.value || '');
                const m = text.match(/^\s*(?:\/agent\b|agent\b)\s*(.*)$/i);
                if (!m) {
                    closeAgentPicker();
                    return;
                }
                const q = (m[1] || '').trim();
                openAgentPicker(q);
            };

            input.addEventListener('input', onInput);
            input.addEventListener('focus', onInput);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeAgentPicker();
                }
            });

            // Fermer la liste si clic en dehors
            document.addEventListener('click', (e) => {
                const picker = document.getElementById('agentPicker');
                const btn = document.getElementById('agentBtn');
                if (!picker || picker.style.display === 'none') return;

                const target = e && e.target ? e.target : null;
                if (!target) return;
                if (picker.contains(target) || (btn && btn.contains(target))) return;
                closeAgentPicker();
            }, true);
        });

        // ================================
        // üåç Langue (client-side, sans appel API)
        // Objectif: pour les r√©ponses instantan√©es (salutations / petits messages)
        // ================================
        function normalizeLangClient(input) {
            const raw = String(input || '').trim().toLowerCase();
            if (!raw) return 'fr';
            const base = raw.split('-')[0].split('_')[0];
            const supported = new Set(['fr','en','es','de','it','pt','ar','zh','ja','ko','ru','tr','nl','hi','th','he','el','id','vi']);
            if (supported.has(base)) return base;
            if (raw.includes('english') || raw.includes('anglais')) return 'en';
            if (raw.includes('french') || raw.includes('fran√ßais') || raw.includes('francais')) return 'fr';
            if (raw.includes('spanish') || raw.includes('espagnol') || raw.includes('espa√±ol') || raw.includes('espanol')) return 'es';
            if (raw.includes('german') || raw.includes('allemand') || raw.includes('deutsch')) return 'de';
            if (raw.includes('italian') || raw.includes('italien') || raw.includes('italiano')) return 'it';
            if (raw.includes('portuguese') || raw.includes('portugais') || raw.includes('portugu√™s') || raw.includes('portugues')) return 'pt';
            if (raw.includes('arabic') || raw.includes('arabe') || raw.includes('ÿßŸÑÿπÿ±ÿ®Ÿäÿ©')) return 'ar';
            if (raw.includes('chinese') || raw.includes('chinois') || raw.includes('‰∏≠Êñá') || raw.includes('mandarin')) return 'zh';
            if (raw.includes('japanese') || raw.includes('japonais') || raw.includes('Êó•Êú¨Ë™û')) return 'ja';
            if (raw.includes('korean') || raw.includes('cor√©en') || raw.includes('coreen') || raw.includes('ÌïúÍµ≠Ïñ¥')) return 'ko';
            if (raw.includes('russian') || raw.includes('russe') || raw.includes('—Ä—É—Å—Å–∫–∏–π')) return 'ru';
            if (raw.includes('turkish') || raw.includes('turc') || raw.includes('t√ºrk√ße') || raw.includes('turkce')) return 'tr';
            return 'fr';
        }

        function detectLangByScriptClient(text) {
            const s = String(text || '');
            if (!s) return '';
            if (/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/.test(s)) return 'ar';
            if (/[\u3040-\u30FF]/.test(s)) return 'ja';
            if (/[\u4E00-\u9FFF]/.test(s)) return 'zh';
            if (/[\uAC00-\uD7AF]/.test(s)) return 'ko';
            if (/[\u0400-\u04FF]/.test(s)) return 'ru';
            if (/[\u0900-\u097F]/.test(s)) return 'hi';
            if (/[\u0E00-\u0E7F]/.test(s)) return 'th';
            if (/[\u0590-\u05FF]/.test(s)) return 'he';
            if (/[\u0370-\u03FF]/.test(s)) return 'el';
            return '';
        }

        function detectLangFromTextClient(text, fallback) {
            // UI policy: local/instant messages should follow the app language (FR/EN)
            // as fallback (avoid unexpected languages from the browser locale).
            const appLang = (typeof getAppLanguage === 'function') ? getAppLanguage() : 'fr';
            const fb = normalizeLangClient(fallback || appLang);
            const raw = String(text || '').trim();
            if (!raw) return fb;
            const byScript = detectLangByScriptClient(raw);
            if (byScript) return normalizeLangClient(byScript);

            const lower = ` ${raw.toLowerCase().replace(/[^\p{L}\p{N}\s]+/gu, ' ').replace(/\s+/g, ' ').trim()} `;
            const score = { fr:0,en:0,es:0,de:0,it:0,pt:0,nl:0,tr:0,id:0,vi:0 };
            const hit = (k, arr, w=1) => arr.forEach(x => { if (lower.includes(` ${x} `)) score[k] += w; });
            hit('en', ['the','and','you','your','please','thanks','what','why','how','hello','hi'], 2);
            hit('fr', ['le','la','les','des','est','vous','merci','bonjour','pourquoi','comment','avec','salut'], 2);
            hit('es', ['hola','gracias','por','para','como','qu√©','que','usted','buenos','buenas'], 2);
            hit('de', ['und','der','die','das','bitte','danke','warum','wie','hallo'], 2);
            hit('it', ['ciao','grazie','perch√©','perche','come','che','buongiorno'], 2);
            hit('pt', ['ol√°','ola','obrigado','obrigada','porqu√™','porque','como','voc√™','voce'], 2);
            hit('nl', ['hallo','dank','alstublieft','waarom','hoe','jij','u'], 2);
            hit('tr', ['merhaba','te≈üekk√ºr','tesekkur','l√ºtfen','lutfen','neden','nasƒ±l','nasil'], 2);
            hit('id', ['halo','terima','kasih','kenapa','bagaimana','anda'], 2);
            hit('vi', ['xin','ch√†o','chao','c·∫£m','cam','∆°n','on','t·∫°i','sao','b·∫°n','ban'], 2);

            if (/[¬ø¬°√±]/.test(raw)) score.es += 3;
            if (/[√ß≈ì√¶]/i.test(raw)) score.fr += 2;
            if (/[√ü√§√∂√º]/i.test(raw)) score.de += 3;
            if (/[√£√µ]/i.test(raw)) score.pt += 2;
            if (/[ƒüƒ±≈ü√ß√∂√º]/i.test(raw)) score.tr += 3;
            if (/[ƒÉ√¢ƒë√™√¥∆°∆∞]/i.test(raw)) score.vi += 3;

            let best = fb;
            let bestScore = 0;
            Object.keys(score).forEach(k => {
                if (score[k] > bestScore) { best = k; bestScore = score[k]; }
            });
            if (bestScore < 2) return fb;
            return normalizeLangClient(best);
        }

        function getStoredUserLang() {
            try {
                const v = localStorage.getItem('axilum_user_lang');
                if (v) {
                    const stored = normalizeLangClient(v);
                    if (stored === 'en' || stored === 'fr') return stored;
                    // Migrate legacy/unsupported stored language to app language.
                    const appLang = (typeof getAppLanguage === 'function') ? getAppLanguage() : 'fr';
                    try { localStorage.setItem('axilum_user_lang', normalizeLangClient(appLang)); } catch (_) {}
                    return normalizeLangClient(appLang);
                }
            } catch (_) {}
            const appLang = (typeof getAppLanguage === 'function') ? getAppLanguage() : 'fr';
            return normalizeLangClient(appLang);
        }

        function setStoredUserLang(lang) {
            // UI policy: keep only FR/EN to match app language selector.
            const normalized = normalizeLangClient(lang);
            const l = (normalized === 'en') ? 'en' : 'fr';
            try { localStorage.setItem('axilum_user_lang', l); } catch (_) {}
            return l;
        }

        function tLocal(key, lang) {
            const l = normalizeLangClient(lang);
            const dict = {
                quick_chat_prompt: {
                    fr: "D'accord. De quoi aimeriez-vous parler ?",
                    en: "Sure. What would you like to talk about?",
                    es: "De acuerdo. ¬øDe qu√© te gustar√≠a hablar?",
                    de: "Alles klar. Wor√ºber m√∂chtest du sprechen?",
                    it: "Va bene. Di cosa ti piacerebbe parlare?",
                    pt: "Tudo bem. Sobre o que voc√™ gostaria de conversar?",
                    ar: "ÿ≠ÿ≥ŸÜŸãÿß. ÿπŸÖŸëÿßÿ∞ÿß ÿ™ŸàÿØŸë ÿ£ŸÜ ŸÜÿ™ÿ≠ÿØÿ´ÿü",
                    ru: "–•–æ—Ä–æ—à–æ. –û —á—ë–º –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?",
                    tr: "Tamam. Ne hakkƒ±nda konu≈ümak istersin?",
                    zh: "Â•ΩÁöÑ„ÄÇ‰Ω†ÊÉ≥ËÅä‰ªÄ‰πàÔºü",
                    ja: "„ÅÑ„ÅÑ„Åß„Åô„Çà„ÄÇ‰Ωï„Å´„Å§„ÅÑ„Å¶Ë©±„Åó„Åü„ÅÑ„Åß„Åô„ÅãÔºü",
                    ko: "Ï¢ãÏïÑÏöî. Î¨¥ÏóáÏóê ÎåÄÌï¥ Ïù¥ÏïºÍ∏∞ÌïòÍ≥† Ïã∂ÎÇòÏöî?"
                },
                quick_greeting: {
                    fr: "Bonjour ! Comment puis-je vous aider aujourd'hui ?",
                    en: "Hello! How can I help you today?",
                    es: "¬°Hola! ¬øEn qu√© puedo ayudarte hoy?",
                    de: "Hallo! Wie kann ich dir heute helfen?",
                    it: "Ciao! Come posso aiutarti oggi?",
                    pt: "Ol√°! Como posso ajudar voc√™ hoje?",
                    ar: "ŸÖÿ±ÿ≠ÿ®Ÿãÿß! ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ÿßŸÑŸäŸàŸÖÿü",
                    ru: "–ü—Ä–∏–≤–µ—Ç! –ß–µ–º —è –º–æ–≥—É –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è?",
                    tr: "Merhaba! Bug√ºn sana nasƒ±l yardƒ±mcƒ± olabilirim?",
                    zh: "‰Ω†Â•ΩÔºÅÊàë‰ªäÂ§©ËÉΩÂ∏Æ‰Ω†‰ªÄ‰πàÔºü",
                    ja: "„Åì„Çì„Å´„Å°„ÅØÔºÅ‰ªäÊó•„ÅØ„Å©„ÅÜ„ÅäÊâã‰ºù„ÅÑ„Åß„Åç„Åæ„Åô„ÅãÔºü",
                    ko: "ÏïàÎÖïÌïòÏÑ∏Ïöî! Ïò§Îäò Î¨¥ÏóáÏùÑ ÎèÑÏôÄÎìúÎ¶¥ÍπåÏöî?"
                },
                agent_welcome: {
                    fr: "üëã Bonjour, je suis {agent}. Comment puis-je vous aider ?",
                    en: "üëã Hi, I'm {agent}. How can I help you?",
                    es: "üëã Hola, soy {agent}. ¬øEn qu√© puedo ayudarte?",
                    de: "üëã Hallo, ich bin {agent}. Wie kann ich helfen?",
                    it: "üëã Ciao, sono {agent}. Come posso aiutarti?",
                    pt: "üëã Ol√°, eu sou {agent}. Como posso ajudar?",
                    ar: "üëã ŸÖÿ±ÿ≠ÿ®Ÿãÿßÿå ÿ£ŸÜÿß {agent}. ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉÿü",
                    ru: "üëã –ü—Ä–∏–≤–µ—Ç, —è {agent}. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
                    tr: "üëã Merhaba, ben {agent}. Nasƒ±l yardƒ±mcƒ± olabilirim?",
                    zh: "üëã ‰Ω†Â•ΩÔºåÊàëÊòØ {agent}„ÄÇÊàëËÉΩÂ∏Æ‰Ω†‰ªÄ‰πàÔºü",
                    ja: "üëã „Åì„Çì„Å´„Å°„ÅØ„ÄÅ{agent} „Åß„Åô„ÄÇ„Å©„ÅÜ„ÅäÊâã‰ºù„ÅÑ„Åß„Åç„Åæ„Åô„ÅãÔºü",
                    ko: "üëã ÏïàÎÖïÌïòÏÑ∏Ïöî, Ï†ÄÎäî {agent}ÏûÖÎãàÎã§. Î¨¥ÏóáÏùÑ ÎèÑÏôÄÎìúÎ¶¥ÍπåÏöî?"
                },
                team_auto: {
                    fr: "ü§ù Team Auto activ√©. Donnez-moi votre question.",
                    en: "ü§ù Team Auto enabled. What's your question?",
                    es: "ü§ù Team Auto activado. ¬øCu√°l es tu pregunta?",
                    de: "ü§ù Team Auto aktiviert. Was ist deine Frage?",
                    it: "ü§ù Team Auto attivato. Qual √® la tua domanda?",
                    pt: "ü§ù Team Auto ativado. Qual √© a sua pergunta?",
                    ar: "ü§ù ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ Team Auto. ŸÖÿß ÿ≥ÿ§ÿßŸÑŸÉÿü",
                    ru: "ü§ù Team Auto –≤–∫–ª—é—á—ë–Ω. –í —á—ë–º –≤–∞—à –≤–æ–ø—Ä–æ—Å?",
                    tr: "ü§ù Team Auto etkin. Sorun nedir?",
                    zh: "ü§ù Team Auto Â∑≤ÂºÄÂêØ„ÄÇ‰Ω†ÁöÑÈóÆÈ¢òÊòØ‰ªÄ‰πàÔºü",
                    ja: "ü§ù Team Auto „ÇíÊúâÂäπÂåñ„Åó„Åæ„Åó„Åü„ÄÇ„ÅîË≥™Âïè„ÅØÔºü",
                    ko: "ü§ù Team AutoÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§. ÏßàÎ¨∏Ïù¥ Î¨¥ÏóáÏù∏Í∞ÄÏöî?"
                }
            };

            const entry = dict[key] || {};
            return entry[l] || entry.fr || '';
        }

        // ===================================
        // üóÑÔ∏è IndexedDB Storage (Conversations + Images)
        // ===================================
        const AXILUM_IDB_DB_NAME = 'axilum_db';
        const AXILUM_IDB_DB_VERSION = 1;
        const AXILUM_IDB_STORE_KV = 'kv';
        const AXILUM_IDB_STORE_IMAGES = 'images';

        // Object URLs temporaires (pour images g√©n√©r√©es restaur√©es depuis IDB)
        const __axilumObjectUrls = new Set();

        function getActiveUserKey() {
            const u = JSON.parse(localStorage.getItem('currentUser') || 'null');
            return (u && u.email) ? u.email : 'guest';
        }

        function makeKvId(userKey, key) {
            return `${userKey}:${key}`;
        }

        function makeImageId(userKey) {
            const rnd = (typeof crypto !== 'undefined' && crypto.randomUUID)
                ? crypto.randomUUID()
                : (Date.now() + '_' + Math.random().toString(36).slice(2));
            return `${userKey}:img:${rnd}`;
        }

        function makeRemoteImageId() {
            return (typeof crypto !== 'undefined' && crypto.randomUUID)
                ? crypto.randomUUID()
                : (Date.now() + '_' + Math.random().toString(36).slice(2));
        }

        function openAxilumDb() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(AXILUM_IDB_DB_NAME, AXILUM_IDB_DB_VERSION);

                req.onupgradeneeded = () => {
                    const db = req.result;
                    if (!db.objectStoreNames.contains(AXILUM_IDB_STORE_KV)) {
                        db.createObjectStore(AXILUM_IDB_STORE_KV, { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains(AXILUM_IDB_STORE_IMAGES)) {
                        const store = db.createObjectStore(AXILUM_IDB_STORE_IMAGES, { keyPath: 'id' });
                        store.createIndex('byUserKey', 'userKey', { unique: false });
                    }
                };

                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error || new Error('Impossible d\'ouvrir IndexedDB'));
            });
        }

        async function idbGetKv(userKey, key) {
            const db = await openAxilumDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(AXILUM_IDB_STORE_KV, 'readonly');
                const store = tx.objectStore(AXILUM_IDB_STORE_KV);
                const req = store.get(makeKvId(userKey, key));
                req.onsuccess = () => resolve(req.result ? req.result.value : null);
                req.onerror = () => reject(req.error);
            });
        }

        async function idbSetKv(userKey, key, value) {
            const db = await openAxilumDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(AXILUM_IDB_STORE_KV, 'readwrite');
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
                const store = tx.objectStore(AXILUM_IDB_STORE_KV);
                store.put({ id: makeKvId(userKey, key), userKey, key, value, updatedAt: Date.now() });
            });
        }

        async function idbDeleteKv(userKey, key) {
            const db = await openAxilumDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(AXILUM_IDB_STORE_KV, 'readwrite');
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
                tx.objectStore(AXILUM_IDB_STORE_KV).delete(makeKvId(userKey, key));
            });
        }

        async function idbPutImageBlob(userKey, blob, mimeType, name = '') {
            const db = await openAxilumDb();
            const imageId = makeImageId(userKey);
            return new Promise((resolve, reject) => {
                const tx = db.transaction(AXILUM_IDB_STORE_IMAGES, 'readwrite');
                tx.oncomplete = () => resolve(imageId);
                tx.onerror = () => reject(tx.error);
                tx.objectStore(AXILUM_IDB_STORE_IMAGES).put({
                    id: imageId,
                    userKey,
                    blob,
                    mimeType: mimeType || blob.type || 'application/octet-stream',
                    name,
                    createdAt: Date.now()
                });
            });
        }

        async function idbGetImageBlob(imageId) {
            const db = await openAxilumDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(AXILUM_IDB_STORE_IMAGES, 'readonly');
                const req = tx.objectStore(AXILUM_IDB_STORE_IMAGES).get(imageId);
                req.onsuccess = () => resolve(req.result ? req.result.blob : null);
                req.onerror = () => reject(req.error);
            });
        }

        function blobToDataUrl(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error || new Error('Conversion Blob -> base64 √©chou√©e'));
                reader.readAsDataURL(blob);
            });
        }

        async function dataUrlToBlob(dataUrl) {
            const res = await fetch(dataUrl);
            return await res.blob();
        }

        async function getImageDataUrlById(imageId) {
            const blob = await idbGetImageBlob(imageId);
            if (!blob) return null;
            return await blobToDataUrl(blob);
        }

        function trackObjectUrl(url) {
            if (url) __axilumObjectUrls.add(url);
            return url;
        }

        function revokeAllObjectUrls() {
            __axilumObjectUrls.forEach(u => {
                try { URL.revokeObjectURL(u); } catch (_) {}
            });
            __axilumObjectUrls.clear();
        }
        
        // ===================================
        // üéØ SYST√àME DE TRACKING CONTEXTUEL
        // ===================================
        const AxilumContext = {
            // Base de connaissance des agents et pages
            agents: {
                'Agent Alex': { module: 'Finance & Accounting Hub', specialite: 'finance, comptabilit√©, budgets, rapports financiers' },
                'Agent RH': { module: 'HR Management Hub', specialite: 'ressources humaines, recrutement, gestion des employ√©s, cong√©s, paie' },
                'Agent dev': { module: 'Research & Development Hub', specialite: 'recherche, d√©veloppement, innovation, projets R&D' },
                'Agent mark': { module: 'Marketing & Business Hub', specialite: 'marketing, strat√©gie commerciale, analyse de march√©' },
                'Agent ToDo': { module: 'AI Task', specialite: 'gestion de t√¢ches, to-do lists, organisation, productivit√©' }
            },
            
            // Suivre l'activit√© utilisateur
            updateActivity(moduleName, agentName, action) {
                const activity = JSON.parse(localStorage.getItem('axilumActivity') || '{}');
                const timestamp = new Date().toISOString();
                
                activity.current = {
                    module: moduleName,
                    agent: agentName,
                    action: action,
                    timestamp: timestamp
                };
                
                if (!activity.history) activity.history = [];
                activity.history.unshift({
                    module: moduleName,
                    agent: agentName,
                    action: action,
                    timestamp: timestamp
                });
                
                // Garder seulement les 10 derni√®res activit√©s
                if (activity.history.length > 10) {
                    activity.history = activity.history.slice(0, 10);
                }
                
                localStorage.setItem('axilumActivity', JSON.stringify(activity));
                console.log('üéØ Contexte mis √† jour:', activity.current);
            },
            
            // Obtenir le contexte enrichi
            // ‚ö†Ô∏è Ne pas injecter d'instructions qui contredisent le chatType courant.
            getEnrichedContext(chatType) {
                const activity = JSON.parse(localStorage.getItem('axilumActivity') || '{}');
                
                if (!activity.current) return '';

                const effectiveType = (typeof normalizeChatType === 'function')
                    ? normalizeChatType(chatType || (typeof currentChatType !== 'undefined' ? currentChatType : 'axilum'))
                    : String(chatType || '').trim().toLowerCase();

                // En mode agent sp√©cialis√©, ne pas injecter de contexte "modules visit√©s" (sinon l'agent commence √† parler d'autres modules).
                if (effectiveType && effectiveType !== 'axilum') {
                    return '';
                }
                
                const agent = this.agents[activity.current.agent];
                // En mode agent, on reste factuel (pas de "ne change pas ton comportement").
                let context = effectiveType && effectiveType !== 'axilum'
                    ? `\n\n[üìç CONTEXTE UTILISATEUR]:\n`
                    : `\n\n[üìç INFORMATION CONTEXTUELLE - Ne change PAS ton comportement]:\n`;
                context += `L'utilisateur a r√©cemment visit√©: ${activity.current.module}\n`;
                
                if (agent) {
                    context += `Module sp√©cialis√© en: ${agent.specialite}\n`;
                }
                
                // Ajouter l'historique r√©cent uniquement
                if (activity.history && activity.history.length > 1) {
                    context += `\nAutres pages visit√©es: `;
                    const recent = activity.history.slice(1, 3).map(h => h.module).join(', ');
                    context += recent + '\n';
                }
                
                // Garde-fous uniquement pour le mode Axilum (g√©n√©ral)
                if (!effectiveType || effectiveType === 'axilum') {
                    context += `\n‚ö†Ô∏è IMPORTANT: Tu restes AI Axilum, assistant g√©n√©ral et polyvalent.\n`;
                    context += `Tu ne dois PAS te comporter comme un agent sp√©cialis√©, ni simuler le module ${activity.current.module}.\n`;
                    context += `Utilise ce contexte uniquement pour comprendre les int√©r√™ts de l'utilisateur et donner des conseils pertinents.\n`;
                    context += `Si l'utilisateur veut utiliser un module sp√©cialis√©, sugg√®re-lui d'y aller directement.\n`;
                }
                
                return context;
            },
            
            // R√©initialiser le contexte (quand l'utilisateur revient sur AI Axilum)
            clearCurrent() {
                const activity = JSON.parse(localStorage.getItem('axilumActivity') || '{}');
                activity.current = null;
                localStorage.setItem('axilumActivity', JSON.stringify(activity));
            }
        };
        
        // ===================================
        // üìö DOCUMENTATION COMPL√àTE DE L'APPLICATION
        // ===================================
        function getApplicationKnowledge(chatType) {
            const effectiveType = (typeof normalizeChatType === 'function')
                ? normalizeChatType(chatType || (typeof currentChatType !== 'undefined' ? currentChatType : 'axilum'))
                : String(chatType || '').trim().toLowerCase();

            // En mode agent sp√©cialis√©: ne pas injecter la liste des modules (√ßa pousse l'agent √† les citer).
            // On garde uniquement des garde-fous anti-hallucination tr√®s g√©n√©raux.
            if (effectiveType && effectiveType !== 'axilum') {
                return `\n[Contraintes produit]\n- N'invente jamais de fonctionnalit√©s qui n'existent pas\n- Ne mentionne pas d'autres modules/agents/outils sauf si l'utilisateur le demande explicitement\n`;
            }

            const base = `
[üìö Base de connaissance - Architecture de l'application]

MODULES DISPONIBLES:
Office‚Ñ¢: Finance & Accounting (Agent Alex), Excel AI Expert, HR Management (Agent RH), Research & Development (Agent dev), Marketing & Business (Agent mark)
Outils: Recherche web (Agent Wesh / web-search), Team Auto (Orchestrator), Text Pro, AI Vision, AI Task (Agent ToDo)

COMMANDES CHAT:
- /agent <nom> : change d‚Äôagent (ex: /agent dev, /agent web)
- /team <agents> -- <question> : orchestre plusieurs agents (ex: /team auto -- ...)

CE QUI N'EXISTE PAS: Modules "Documents", "Email", "Calendar s√©par√©", "Settings d√©di√©", "Dashboard", "Chat Teams", "Notes/Wiki"

R√àGLES IMPORTANTES:
- N'invente JAMAIS de fonctionnalit√©s qui n'existent pas
- Pour questions sur l'app: donne info pr√©cise bas√©e sur la liste ci-dessus
`;

            // En mode Axilum (g√©n√©ral), on conserve les r√®gles de ton historiques.
            if (!effectiveType || effectiveType === 'axilum') {
                return base + `
- Tu es AI Axilum, assistant conversationnel g√©n√©ral et naturel
- Reste SIMPLE et CONVERSATIONNEL pour les √©changes basiques (bonjour, merci, etc.)
- Ne te transforme JAMAIS en un agent sp√©cialis√©
- Sugg√®re les bons modules seulement SI l'utilisateur a un besoin sp√©cifique
- Pour conversations normales: r√©ponds naturellement sans toujours parler de modules
`;
            }

            // En mode agent sp√©cialis√©, rester factuel uniquement.
            return base;
        }
        
        // Auth State
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        
        // üìÖ Syst√®me To Do - T√¢ches et Calendrier
        // NOTE: stockage local scoped par utilisateur (fallback legacy: "userTasks")
        let userTasks = readTodoTasksFromStorage();
        let userEvents = JSON.parse(localStorage.getItem('userEvents') || '[]');
        let userProjects = JSON.parse(localStorage.getItem('userProjects') || '[]');
        let notificationSettings = JSON.parse(localStorage.getItem('notificationSettings') || '{"enabled": false, "reminderMinutes": 15}');
        
        // üîÑ Migration des donn√©es: Normaliser les t√¢ches pour ajouter les propri√©t√©s manquantes
        userTasks = userTasks.map(task => {
            // S'assurer que toutes les propri√©t√©s essentielles existent
            return {
                ...task,
                notifyEnabled: task.notifyEnabled !== undefined ? task.notifyEnabled : false,
                notificationEnabled: task.notificationEnabled !== undefined ? task.notificationEnabled : false,
                projectId: task.projectId !== undefined ? task.projectId : null,
                progress: task.progress !== undefined ? task.progress : 0,
                subtasks: task.subtasks || [],
                userId: task.userId || currentUser?.email || 'guest',
                description: task.description || '',
                category: task.category || 'autre',
                priority: task.priority || 'normal'
            };
        });
        // Sauvegarder les t√¢ches normalis√©es
        if (userTasks.length > 0) {
            localStorage.setItem(getTodoTasksStorageKey(), JSON.stringify(userTasks));
        }
        
        // Email Verification
        let pendingUser = null;

        // ===================================
        // üîê Auth serveur + Sync multi-appareils
        // ===================================
        function getApiBase() {
            return (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                ? 'http://localhost:7071'
                : '';
        }

        function apiUrl(path) {
            return getApiBase() + path;
        }

        function getAuthToken() {
            return localStorage.getItem('axilum_auth_token') || null;
        }

        function setAuthToken(token) {
            if (token) localStorage.setItem('axilum_auth_token', token);
            else localStorage.removeItem('axilum_auth_token');
        }

        async function apiFetch(path, options = {}) {
            const headers = Object.assign({}, options.headers || {});
            const token = getAuthToken();
            if (token) headers['Authorization'] = `Bearer ${token}`;
            return fetch(apiUrl(path), Object.assign({}, options, { headers }));
        }

        function withAuthHeaders(headers = {}) {
            const out = Object.assign({}, headers || {});
            const token = getAuthToken();
            if (token) out['Authorization'] = `Bearer ${token}`;
            return out;
        }

        // ================================
        // üìö Docs Search (Elasticsearch)
        // ================================
        function getDocsSearchEnabled() {
            return String(localStorage.getItem('axilum_docs_search_enabled') || '') === '1';
        }

        function setDocsSearchEnabled(enabled) {
            const v = enabled ? '1' : '0';
            localStorage.setItem('axilum_docs_search_enabled', v);
            refreshDocsSearchUi();
        }

        function getDocsEmbeddingsEnabled() {
            return String(localStorage.getItem('axilum_docs_embeddings_enabled') || '') === '1';
        }

        function setDocsEmbeddingsEnabled(enabled) {
            const v = enabled ? '1' : '0';
            localStorage.setItem('axilum_docs_embeddings_enabled', v);
            refreshDocsEmbeddingsUi(); updMcpUi();
        }

        function getDocsIndexedMetaStorageKey() {
            let userKey = 'guest';
            try {
                if (typeof getActiveUserKey === 'function') {
                    userKey = getActiveUserKey() || 'guest';
                }
            } catch (_) {}
            return `axilum_docs_indexed_meta_${userKey}`;
        }

        function loadDocsIndexedMeta() {
            try {
                const raw = localStorage.getItem(getDocsIndexedMetaStorageKey());
                const parsed = raw ? JSON.parse(raw) : [];
                return Array.isArray(parsed) ? parsed : [];
            } catch (_) {
                return [];
            }
        }

        function saveDocsIndexedMeta(items) {
            try {
                localStorage.setItem(getDocsIndexedMetaStorageKey(), JSON.stringify(Array.isArray(items) ? items : []));
            } catch (_) {}
        }

        function upsertDocsIndexedMeta(indexedItems) {
            const current = loadDocsIndexedMeta();
            const byId = new Map();
            for (const it of current) {
                if (it && it.documentId) byId.set(it.documentId, it);
            }
            for (const it of (Array.isArray(indexedItems) ? indexedItems : [])) {
                const docId = it && (it.documentId || it.id);
                if (!docId) continue;
                const prev = byId.get(docId) || {};
                byId.set(docId, {
                    ...prev,
                    ...it,
                    documentId: docId,
                    lastIndexedAt: new Date().toISOString()
                });
            }
            const merged = Array.from(byId.values())
                .sort((a, b) => String(b.lastIndexedAt || '').localeCompare(String(a.lastIndexedAt || '')))
                .slice(0, 200);
            saveDocsIndexedMeta(merged);
            return merged;
        }

        function renderDocsModalStatus() {
            const el = document.getElementById('docsModalStatus');
            if (!el) return;
            const enabled = getDocsSearchEnabled();
            const emb = getDocsEmbeddingsEnabled();
            el.textContent = `Docs: ${enabled ? 'activ√©' : 'd√©sactiv√©'} ‚Ä¢ Mode: ${emb ? 'hybride (embeddings ON)' : 'texte (embeddings OFF)'}`;
        }

        function renderDocsModalIndexed() {
            const el = document.getElementById('docsModalIndexed');
            if (!el) return;
            const items = loadDocsIndexedMeta();
            if (!items.length) {
                el.textContent = 'Aucun document index√© (liste locale vide).';
                return;
            }
            const lines = items.slice(0, 15).map((it) => {
                const title = String(it.title || it.source || it.documentId || 'Document');
                const when = it.lastIndexedAt ? new Date(it.lastIndexedAt).toLocaleString() : '';
                const chunks = (typeof it.chunks === 'number') ? ` ‚Ä¢ ${it.chunks} chunks` : '';
                return `‚Ä¢ ${title}${chunks}${when ? ` ‚Ä¢ ${when}` : ''}`;
            });
            el.textContent = lines.join('\n');
            el.style.whiteSpace = 'pre-line';
        }

        function clearDocsIndexedMeta() {
            saveDocsIndexedMeta([]);
            renderDocsModalIndexed();
        }

        function openDocsModal() {
            const modal = document.getElementById('docsModal');
            if (!modal) return;
            modal.style.display = 'flex';
            renderDocsModalStatus();
            renderDocsModalIndexed();
            const q = document.getElementById('docsModalQuery');
            if (q) {
                q.focus();
                q.onkeydown = (ev) => {
                    if (ev && ev.key === 'Enter') {
                        ev.preventDefault();
                        runDocsModalSearch();
                    }
                };
            }
        }

        function closeDocsModal() {
            const modal = document.getElementById('docsModal');
            if (!modal) return;
            modal.style.display = 'none';
        }

        async function runDocsModalSearch() {
            const resultsEl = document.getElementById('docsModalResults');
            const queryEl = document.getElementById('docsModalQuery');
            if (!resultsEl || !queryEl) return;

            const q = String(queryEl.value || '').trim();
            if (!q) {
                resultsEl.textContent = 'Entrez une requ√™te.';
                return;
            }
            if (!(typeof getAuthToken === 'function') || !getAuthToken()) {
                resultsEl.textContent = 'Connectez-vous pour rechercher dans vos documents.';
                return;
            }

            resultsEl.textContent = 'Recherche‚Ä¶';
            try {
                const mode = getDocsEmbeddingsEnabled() ? 'hybrid' : 'text';
                const res = await apiFetch('/api/elastic/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ q, mode, topK: 5 })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data || !data.ok) {
                    const err = (data && (data.error || data.details)) ? String(data.error || data.details) : `Erreur ${res.status}`;
                    resultsEl.textContent = `Erreur: ${err}`;
                    return;
                }

                const hits = Array.isArray(data.hits) ? data.hits : [];
                if (!hits.length) {
                    resultsEl.textContent = 'Aucun r√©sultat.';
                    return;
                }

                const lines = hits.slice(0, 5).map((h, idx) => {
                    const title = String(h.title || h.source || h.documentId || `R√©sultat ${idx + 1}`);
                    const score = (typeof h.score === 'number') ? ` (score ${h.score.toFixed(3)})` : '';
                    const snippet = String(h.snippet || h.content || '').replace(/\s+/g, ' ').trim();
                    return `‚Ä¢ ${title}${score}\n  ${snippet}`;
                });
                resultsEl.textContent = lines.join('\n');
                resultsEl.style.whiteSpace = 'pre-line';
            } catch (e) {
                resultsEl.textContent = `Erreur: ${e && e.message ? e.message : String(e)}`;
            }
        }

        async function clearAllIndexedDocs() {
            const ok = confirm('Supprimer tous vos documents index√©s ? Cette action est irr√©versible.');
            if (!ok) return;

            const resultsEl = document.getElementById('docsModalResults');
            if (resultsEl) resultsEl.textContent = 'Suppression‚Ä¶';

            try {
                const res = await apiFetch('/api/elastic/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await res.json().catch(() => ({}));
                if (res.status === 401) {
                    try { showToast(t('toast.loginToDelete'), 'info'); } catch (_) {}
                    if (resultsEl) resultsEl.textContent = 'Non authentifi√©.';
                    return;
                }
                if (!res.ok || !data || !data.ok) {
                    const err = (data && (data.error || data.details)) ? String(data.error || data.details) : `Erreur ${res.status}`;
                    if (resultsEl) resultsEl.textContent = `Erreur: ${err}`;
                    try { showToast(t('toast.deleteFailed'), 'error'); } catch (_) {}
                    return;
                }

                clearDocsIndexedMeta();
                if (resultsEl) resultsEl.textContent = `‚úÖ Suppression OK (${Number(data.deleted || 0)} √©l√©ments supprim√©s).`;
                try { showToast(t('toast.documentsDeleted'), 'success'); } catch (_) {}
            } catch (e) {
                if (resultsEl) resultsEl.textContent = `Erreur: ${e && e.message ? e.message : String(e)}`;
                try { showToast(t('toast.deleteFailed'), 'error'); } catch (_) {}
            }
        }

        function refreshDocsSearchUi() {
            try {
                const btn = document.getElementById('docsSearchBtn');
                if (!btn) return;
                const on = getDocsSearchEnabled();
                btn.classList.toggle('active', !!on);
                btn.title = on ? 'Docs (RAG) : activ√©' : 'Docs (RAG) : utiliser mes documents';
            } catch (_) {}
            try { renderDocsModalStatus(); } catch (_) {}
        }

        function refreshDocsEmbeddingsUi() {
            try {
                const on = getDocsEmbeddingsEnabled();
                const offBtn = document.getElementById('docsEmbOff');
                const onBtn = document.getElementById('docsEmbOn');
                if (offBtn) offBtn.classList.toggle('active', !on);
                if (onBtn) onBtn.classList.toggle('active', !!on);
            } catch (_) {}
            try { renderDocsModalStatus(); } catch (_) {}
        }

        // MCP Functions
        function getMcpOn() { return localStorage.getItem('mcp_on') === '1'; }
        function setMcpOn(v) { localStorage.setItem('mcp_on', v ? '1' : '0'); updMcpUi(); }
        function getMcpPrefs() { try { return JSON.parse(localStorage.getItem('mcp_prefs') || '{}'); } catch(e) { return {}; } }
        function saveMcpPrefs() {
            var p = { web: document.getElementById('mcpWeb')?.checked, fin: document.getElementById('mcpFin')?.checked, comm: document.getElementById('mcpComm')?.checked };
            localStorage.setItem('mcp_prefs', JSON.stringify(p));
        }
        function updMcpUi() {
            var on = getMcpOn(), btnOn = document.getElementById('mcpOn'), btnOff = document.getElementById('mcpOff'), box = document.getElementById('mcpToolsBox');
            if (btnOn) { btnOn.classList.toggle('active', on); btnOn.onclick = function() { setMcpOn(true); }; }
            if (btnOff) { btnOff.classList.toggle('active', !on); btnOff.onclick = function() { setMcpOn(false); }; }
            if (box) { box.style.display = on ? 'block' : 'none'; }
            if (on) { var p = getMcpPrefs(); if (document.getElementById('mcpWeb')) document.getElementById('mcpWeb').checked = p.web !== false; if (document.getElementById('mcpFin')) document.getElementById('mcpFin').checked = p.fin !== false; if (document.getElementById('mcpComm')) document.getElementById('mcpComm').checked = !!p.comm; }
        }

        // =====================================================
        // MCP CONNECTIONS MANAGEMENT - OAuth & User Tokens
        // =====================================================
        
        const MCP_SERVICES = [
            { id: 'microsoft', name: 'Microsoft 365', icon: 'üìß', desc: 'Email Outlook, Calendrier', tools: ['send_email', 'get_inbox', 'get_calendar_events', 'create_calendar_event'], color: '#0078d4', authType: 'oauth' },
            { id: 'google', name: 'Google Workspace', icon: 'üìÖ', desc: 'Gmail, Google Calendar', tools: ['send_email', 'get_inbox', 'get_calendar_events', 'create_calendar_event'], color: '#4285f4', authType: 'oauth' },
            { id: 'slack', name: 'Slack', icon: 'üí¨', desc: 'Messages, Canaux', tools: ['send_slack_message'], color: '#4a154b', authType: 'token' },
            { id: 'telegram', name: 'Telegram', icon: 'üì±', desc: 'Messages Bot', tools: ['send_telegram'], color: '#0088cc', authType: 'token' },
            { id: 'whatsapp', name: 'WhatsApp (Twilio)', icon: 'üì≤', desc: 'Messages WhatsApp', tools: ['send_whatsapp'], color: '#25d366', authType: 'token' },
            { id: 'brave', name: 'Brave Search', icon: 'üîç', desc: 'Recherche web', tools: ['web_search'], color: '#fb542b', authType: 'apikey' },
            { id: 'finance', name: 'Finance', icon: 'üí±', desc: 'Taux de change, Calculs', tools: ['get_exchange_rate', 'calculate', 'get_datetime'], color: '#10b981', authType: 'none' },
            { id: 'pdf', name: 'PDF Parser', icon: 'üìÑ', desc: 'Extraction texte PDF', tools: ['extract_pdf_text'], color: '#ef4444', authType: 'none' }
        ];
        
        function getMcpUserTokens() {
            try { return JSON.parse(localStorage.getItem('mcp_user_tokens') || '{}'); } catch (e) { return {}; }
        }
        
        function saveMcpUserToken(serviceId, tokenData) {
            var tokens = getMcpUserTokens();
            tokens[serviceId] = Object.assign({}, tokenData, { connectedAt: new Date().toISOString() });
            localStorage.setItem('mcp_user_tokens', JSON.stringify(tokens));
            updateMcpConnectionsUI();
        }
        
        function removeMcpUserToken(serviceId) {
            var tokens = getMcpUserTokens();
            delete tokens[serviceId];
            localStorage.setItem('mcp_user_tokens', JSON.stringify(tokens));
            updateMcpConnectionsUI();
            openMcpConnectionsModal();
        }
        
        function isMcpServiceConnected(serviceId) {
            return !!getMcpUserTokens()[serviceId];
        }
        
        function countMcpConnectedServices() {
            return Object.keys(getMcpUserTokens()).length;
        }
        
        function openMcpConnectionsModal() {
            var modal = document.getElementById('mcpConnectionsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'mcpConnectionsModal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = getMcpConnectionsModalHTML();
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
        }
        
        function closeMcpConnectionsModal() {
            var modal = document.getElementById('mcpConnectionsModal');
            if (modal) modal.style.display = 'none';
        }
        
        function getMcpConnectionsModalHTML() {
            var tokens = getMcpUserTokens();
            var count = countMcpConnectedServices();
            var servicesHTML = MCP_SERVICES.map(function(s) {
                var connected = !!tokens[s.id];
                var date = connected ? new Date(tokens[s.id].connectedAt).toLocaleDateString() : '';
                var btn = s.authType === 'none' 
                    ? '<span style="padding:6px 12px;background:rgba(16,185,129,0.2);color:#10b981;border-radius:6px;font-size:12px;font-weight:600;">Actif</span>'
                    : connected 
                        ? '<button onclick="removeMcpUserToken(\''+s.id+'\')" style="padding:6px 12px;background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.3);border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">D√©connecter</button>'
                        : '<button onclick="connectMcpService(\''+s.id+'\')" style="padding:6px 12px;background:'+s.color+';color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">Connecter</button>';
                var statusText = connected ? '<div style="font-size:11px;color:'+s.color+';margin-top:4px;">‚úì Connect√© le '+date+'</div>' : '';
                var toolsHTML = s.tools.map(function(t) { return '<span style="padding:3px 8px;background:var(--bg-secondary);border-radius:4px;font-size:11px;color:var(--text-secondary);">'+t+'</span>'; }).join('');
                return '<div style="background:var(--bg-sidebar);border:1px solid '+(connected?s.color:'var(--border-color)')+';border-radius:12px;padding:16px;margin-bottom:12px;">'+
                    '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;">'+
                    '<div style="display:flex;align-items:center;gap:12px;flex:1;">'+
                    '<div style="font-size:28px;width:40px;text-align:center;">'+s.icon+'</div>'+
                    '<div style="flex:1;"><div style="font-weight:700;font-size:15px;color:var(--text-primary);">'+s.name+'</div>'+
                    '<div style="font-size:12px;color:var(--text-secondary);margin-top:2px;">'+s.desc+'</div>'+statusText+'</div></div>'+
                    '<div>'+btn+'</div></div>'+
                    '<div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:6px;">'+toolsHTML+'</div></div>';
            }).join('');
            
            return '<div style="background:var(--bg-primary);border-radius:16px;max-width:700px;width:100%;max-height:90vh;overflow:hidden;box-shadow:0 25px 50px rgba(0,0,0,0.5);">'+
                '<div style="padding:20px 24px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;">'+
                '<div><h2 style="margin:0;font-size:20px;font-weight:700;color:var(--text-primary);">üîó Connexions MCP</h2>'+
                '<p style="margin:4px 0 0;font-size:13px;color:var(--text-secondary);">'+count+' service'+(count>1?'s':'')+' connect√©'+(count>1?'s':'')+'</p></div>'+
                '<button onclick="closeMcpConnectionsModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-secondary);padding:8px;">√ó</button></div>'+
                '<div style="padding:20px 24px;overflow-y:auto;max-height:calc(90vh - 140px);">'+servicesHTML+'</div>'+
                '<div style="padding:16px 24px;border-top:1px solid var(--border-color);background:var(--bg-secondary);text-align:right;">'+
                '<button onclick="closeMcpConnectionsModal()" style="padding:10px 20px;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">Termin√©</button></div></div>';
        }
        
        function connectMcpService(serviceId) {
            var service = MCP_SERVICES.find(function(s) { return s.id === serviceId; });
            if (!service) return;
            var label = service.authType === 'apikey' ? 'Cl√© API' : 'Token';
            var placeholder = serviceId === 'brave' ? 'BSA-xxxxxx...' : serviceId === 'telegram' ? '123456789:ABCdef...' : 'xoxb-xxxxx...';
            var token = prompt(service.name + ' - Entrez votre ' + label + ':\n\n' + placeholder);
            if (token && token.trim()) {
                saveMcpUserToken(serviceId, { token: token.trim() });
                alert('‚úÖ ' + service.name + ' connect√© !');
                openMcpConnectionsModal();
            }
        }
        
        function updateMcpConnectionsUI() {
            var count = countMcpConnectedServices();
            var countEl = document.getElementById('mcpConnectedCount');
            if (countEl) countEl.textContent = '‚Ä¢ ' + count + ' service' + (count > 1 ? 's' : '') + ' connect√©' + (count > 1 ? 's' : '');
            var quickStatus = document.getElementById('mcpQuickStatus');
            var configBtn = document.getElementById('mcpConfigBtn');
            var isOn = getMcpOn();
            if (quickStatus) quickStatus.style.display = isOn ? 'block' : 'none';
            if (configBtn) configBtn.style.display = isOn ? 'inline-block' : 'none';
        }
        
        // Surcharger setMcpOn pour mettre √† jour l'UI
        var _originalSetMcpOn = typeof setMcpOn === 'function' ? setMcpOn : null;
        function setMcpOn(v) {
            localStorage.setItem('mcp_on', v ? '1' : '0');
            updMcpUi();
            updateMcpConnectionsUI();
        }


        function formatDocsContextFromHits(hits, max = 4) {
            const arr = Array.isArray(hits) ? hits : [];
            const top = arr.slice(0, max);
            if (!top.length) return '';
            let out = '';
            top.forEach((h, i) => {
                const title = (h && h.title) ? String(h.title) : (h && h.documentId ? String(h.documentId) : 'document');
                const where = (h && (h.url || h.source)) ? ` (${h.url || h.source})` : '';
                const snippet = (h && (h.snippet || h.content)) ? String(h.snippet || h.content) : '';
                out += `- [${i + 1}] ${title}${where}: ${snippet}\n`;
            });
            return out.trim();
        }

        async function fetchDocsContextForQuery(query) {
            const q = String(query || '').trim();
            if (!q) return '';
            if (!getDocsSearchEnabled()) return '';

            const mode = getDocsEmbeddingsEnabled() ? 'hybrid' : 'text';
            try {
                const res = await apiFetch('/api/elastic/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ q, mode, topK: 5 })
                });
                if (!res.ok) return '';
                const data = await res.json().catch(() => null);
                const hits = data && Array.isArray(data.hits) ? data.hits : [];
                const ctx = formatDocsContextFromHits(hits, 4);
                if (!ctx) return '';
                return `Contexte (vos documents - Elasticsearch ${mode}):\n${ctx}`;
            } catch (_) {
                return '';
            }
        }

        async function indexDocsFromText({ title, content, source = 'upload', documentId = null, tags = null } = {}) {
            const maxChars = 220_000;
            const text = String(content || '').trim();
            if (!text) return { ok: false, skipped: true, reason: 'empty' };

            const safeContent = text.length > maxChars ? text.slice(0, maxChars) : text;
            const useEmbeddings = (typeof getDocsEmbeddingsEnabled === 'function') ? !!getDocsEmbeddingsEnabled() : true;
            const payload = {
                documents: [
                    {
                        documentId: documentId || undefined,
                        title: title || undefined,
                        content: safeContent,
                        source: source || 'upload',
                        tags: Array.isArray(tags) ? tags : undefined,
                        createdAt: new Date().toISOString()
                    }
                ],
                useEmbeddings
            };

            const res = await apiFetch('/api/elastic/index', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.status === 401) {
                try { showToast(t('toast.loginToIndex'), 'info'); } catch (_) {}
                return { ok: false, skipped: true, reason: 'no-auth', status: 401 };
            }

            const data = await res.json().catch(() => ({}));
            if (!res.ok || !data || !data.ok) {
                let err = '';
                try {
                    if (data && data.details != null) {
                        err = (typeof data.details === 'string') ? data.details : JSON.stringify(data.details);
                    } else if (data && data.error != null) {
                        err = String(data.error);
                    }
                } catch (_) {
                    err = '';
                }
                err = String(err || '').trim();
                return { ok: false, error: err || `Erreur ${res.status}`, status: res.status };
            }
            return { ok: true, indexed: data.indexed || [] };
        }

        async function maybeAutoIndexUploadedText({ fileName, text, source }) {
            if (!getDocsSearchEnabled()) return;
            const t = String(text || '').trim();
            if (t.length < 40) return;

            try {
                try { showToast(t('toast.indexingInProgress'), 'info'); } catch (_) {}
                const r = await indexDocsFromText({ title: fileName, content: t, source: source || 'upload' });
                if (r && r.ok) {
                    try {
                        const indexed = Array.isArray(r.indexed) ? r.indexed : [];
                        if (indexed.length) {
                            upsertDocsIndexedMeta(indexed.map(it => ({
                                documentId: it.documentId,
                                title: it.title || fileName,
                                source: source || 'upload',
                                chunks: (typeof it.chunks === 'number') ? it.chunks : undefined
                            })));
                            renderDocsModalIndexed();
                        }
                    } catch (_) {}
                    try { showToast(t('toast.documentIndexed'), 'success'); } catch (_) {}
                } else if (r && r.error) {
                    const rawErr = String(r.error || '').trim();
                    const shortErr = rawErr.length > 180 ? (rawErr.slice(0, 180) + '‚Ä¶') : rawErr;
                    const prefix = (typeof r.status === 'number') ? `‚ö†Ô∏è Indexation impossible (HTTP ${r.status})` : '‚ö†Ô∏è Indexation impossible';
                    try { showToast(shortErr ? `${prefix}: ${shortErr}` : prefix, 'info'); } catch (_) {}
                }
            } catch (_) {
                // silencieux
            }
        }

        async function toggleDocsSearch() {
            const next = !getDocsSearchEnabled();
            setDocsSearchEnabled(next);

            if (typeof showToast === 'function') {
                showToast(next ? 'üìö Docs (RAG) activ√©' : 'üìö Docs (RAG) d√©sactiv√©', 'info');
            }

            // Si on active et qu'il y a d√©j√† du texte, faire une pr√©visualisation rapide dans le chat.
            if (next) {
                try {
                    const input = document.getElementById('userInput');
                    const q = input ? String(input.value || '').trim() : '';
                    if (!q) return;
                    const ctx = await fetchDocsContextForQuery(q);
                    if (!ctx) return;
                    if (typeof addMessage === 'function') {
                        addMessage(ctx, 'system');
                    }
                } catch (_) {}
            }

            try { renderDocsModalStatus(); } catch (_) {}
        }

        function getConversationLastTs(conv) {
            let t = Number(conv && conv.timestamp) || 0;
            if (conv && Array.isArray(conv.messages)) {
                for (const m of conv.messages) {
                    const mt = Number(m && m.timestamp) || 0;
                    if (mt > t) t = mt;
                }
            }
            return t;
        }

        function mergeConversations(localList, remoteList) {
            const byId = new Map();
            for (const c of (Array.isArray(localList) ? localList : [])) {
                if (c && c.id) byId.set(c.id, c);
            }
            for (const rc of (Array.isArray(remoteList) ? remoteList : [])) {
                if (!rc || !rc.id) continue;
                const lc = byId.get(rc.id);
                if (!lc) {
                    byId.set(rc.id, rc);
                    continue;
                }
                const lt = getConversationLastTs(lc);
                const rt = getConversationLastTs(rc);
                byId.set(rc.id, rt >= lt ? rc : lc);
            }
            const merged = Array.from(byId.values());
            merged.sort((a, b) => getConversationLastTs(b) - getConversationLastTs(a));
            return merged;
        }

        async function syncWithServer() {
            if (getStorageMode && typeof getStorageMode === 'function' && getStorageMode() !== 'cloud') return;
            if (!currentUser || !currentUser.email || !getAuthToken()) return;
            try {
                const pull = await apiFetch('/api/chat-sync-pull', { method: 'GET' });
                const pullData = await pull.json().catch(() => ({}));
                const remoteConversations = Array.isArray(pullData) ? pullData : (pullData.conversations || []);

                const userConversations = conversations.filter(conv => conv && conv.userId === currentUser.id);
                const merged = mergeConversations(userConversations, remoteConversations);

                // Remplacer uniquement les conversations de l'utilisateur courant
                const others = conversations.filter(conv => !conv || conv.userId !== currentUser.id);
                conversations = merged.concat(others);
                saveConversations();
                loadConversations();

                // Push vers serveur (√©tat fusionn√©)
                await apiFetch('/api/chat-sync-push', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ conversations: merged })
                });
            } catch (e) {
                console.warn('‚ö†Ô∏è Sync serveur √©chou√©e:', e);
            }
        }

        async function uploadChatImageToServer(remoteImageId, imageDataUrl) {
            const token = getAuthToken();
            if (!token || !currentUser || !currentUser.email) return false;
            try {
                const res = await apiFetch('/api/chat-image-upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ remoteImageId, imageBase64: imageDataUrl })
                });
                return res.ok;
            } catch {
                return false;
            }
        }

        function makeRemoteFileId() {
            return (typeof crypto !== 'undefined' && crypto.randomUUID)
                ? crypto.randomUUID()
                : (Date.now() + '_' + Math.random().toString(36).slice(2));
        }

        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error || new Error('Conversion fichier -> base64 √©chou√©e'));
                reader.readAsDataURL(file);
            });
        }

        async function uploadChatFileToServer(remoteFileId, file) {
            const token = getAuthToken();
            if (!token || !currentUser || !currentUser.email) return false;
            try {
                const dataUrl = await fileToDataUrl(file);
                const res = await apiFetch('/api/chat-file-upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        remoteFileId,
                        fileName: file && file.name ? file.name : '',
                        mimeType: file && file.type ? file.type : '',
                        fileBase64: dataUrl
                    })
                });
                return res.ok;
            } catch {
                return false;
            }
        }

        async function fetchRemoteFileUrl(remoteFileId) {
            const res = await apiFetch('/api/chat-file-url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ remoteFileId })
            });
            if (!res.ok) return null;
            const data = await res.json().catch(() => null);
            if (!data || !data.url) return null;
            return String(data.url);
        }

        async function openRemoteChatFile(remoteFileId) {
            try {
                if (!getAuthToken() || !currentUser || !currentUser.email) {
                    showToast('üîí Connectez-vous pour r√©ouvrir le fichier', 'info');
                    return;
                }
                const url = await fetchRemoteFileUrl(remoteFileId);
                if (!url) {
                    showToast('‚ùå Fichier introuvable', 'error');
                    return;
                }
                window.open(url, '_blank');
            } catch (_) {
                showToast('‚ùå Ouverture du fichier √©chou√©e', 'error');
            }
        }

        async function fetchRemoteImageAsBlob(remoteImageId) {
            const res = await apiFetch('/api/chat-image-url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ remoteImageId })
            });
            if (!res.ok) return null;
            const data = await res.json().catch(() => null);
            if (!data || !data.url) return null;
            const imgRes = await fetch(data.url);
            if (!imgRes.ok) return null;
            return await imgRes.blob();
        }

        async function ensureLocalImageUrlForMessage(msg) {
            if (!msg) return null;

            if (msg.imageUrl && typeof msg.imageUrl === 'string' && msg.imageUrl.startsWith('data:image/')) {
                return msg.imageUrl;
            }

            if (msg.imageId) {
                try {
                    const blob = await idbGetImageBlob(msg.imageId);
                    if (blob) return trackObjectUrl(URL.createObjectURL(blob));
                } catch (_) {}
            }

            if (getStorageMode && typeof getStorageMode === 'function' && getStorageMode() === 'cloud' && msg.remoteImageId && getAuthToken() && currentUser && currentUser.email) {
                try {
                    const blob = await fetchRemoteImageAsBlob(msg.remoteImageId);
                    if (!blob) return null;
                    const userKey = getActiveUserKey();
                    const newId = await idbPutImageBlob(userKey, blob, blob.type, msg.user || 'image');
                    msg.imageId = newId;
                    saveConversations();
                    return trackObjectUrl(URL.createObjectURL(blob));
                } catch (_) {
                    return null;
                }
            }

            return null;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
                        // Recherche dynamique employ√©s
                        const employeeSearchInput = document.getElementById('employeeSearch');
                        if (employeeSearchInput) {
                            employeeSearchInput.addEventListener('input', function() {
                                const search = this.value.trim().toLowerCase();
                                const employees = getHRData('hrEmployees');
                                const filtered = employees.filter(emp =>
                                    emp.firstName.toLowerCase().includes(search) ||
                                    emp.lastName.toLowerCase().includes(search) ||
                                    (emp.position && emp.position.toLowerCase().includes(search)) ||
                                    (emp.department && emp.department.toLowerCase().includes(search)) ||
                                    (emp.email && emp.email.toLowerCase().includes(search))
                                );
                                renderEmployeesList(filtered);
                            });
                        }
            // Log version pour d√©bogage d√©ploiement
            console.log('üöÄ AXILUM AI v1.4-DEPLOY-TEST - ' + new Date().toISOString());
            console.log('üì¶ Build timestamp: ' + Date.now());

            // Langue: appliquer au chargement
            try { applyLanguageToUI(); } catch (_) {}
            
            // Animation du logo
            const logoEl = document.getElementById('logo');
            const logoText = 'Axilum AI';
            
            // Cr√©er les spans pour chaque lettre
            logoEl.innerHTML = '';
            logoText.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.className = 'letter';
                span.textContent = char === ' ' ? '\u00A0' : char;
                span.dataset.index = index;
                logoEl.appendChild(span);
            });
            
            // Animation: disparition/r√©apparition apr√®s le "A" toutes les 30 secondes
            function animateLogo() {
                const letters = logoEl.querySelectorAll('.letter');
                letters.forEach((letter, index) => {
                    if (index > 0) { // Tout sauf le premier "A"
                        setTimeout(() => {
                            letter.classList.add('fade');
                            setTimeout(() => letter.classList.remove('fade'), 2000);
                        }, index * 100);
                    }
                });
            }
            
            // Lancer l'animation toutes les 30 secondes
            setInterval(animateLogo, 30000);
            
            // Initialiser Finance Storage Client si utilisateur connect√©
            if (window.financeStorageClient && currentUser) {
                try {
                    const token = sessionStorage.getItem('authToken') || localStorage.getItem('authToken') || '';
                    await window.financeStorageClient.initialize(currentUser.id || currentUser.email, token);
                } catch (error) {
                    console.warn('[Finance] Erreur init client:', error);
                }
            }
            
            await initConversationStorage();
            await syncWithServer();
            loadConversations();
            
            // Si aucune conversation n'existe, en cr√©er une nouvelle
            if (conversations.length === 0) {
                newConversation({ autoFocus: false });
            } else {
                // Sinon, charger la conversation la plus r√©cente
                const userConversations = conversations.filter(conv => {
                    if (!currentUser) return !conv.userId;
                    return conv.userId === currentUser.id;
                });
                
                if (userConversations.length > 0) {
                    // Charger la conversation la plus r√©cente seulement si elle a des messages
                    const lastConv = userConversations[0];
                    if (lastConv.messages && lastConv.messages.length > 0) {
                        loadConversation(lastConv.id);
                    } else {
                        // Conversation vide, d√©finir l'ID mais garder l'√©cran de bienvenue
                        currentConversationId = lastConv.id;
                    }
                } else {
                    // Si l'utilisateur n'a pas de conversations, en cr√©er une
                    newConversation({ autoFocus: false });
                }
            }
            
            adjustTextareaHeight();
            
            // Auto-resize textarea
            document.getElementById('userInput').addEventListener('input', adjustTextareaHeight);
            
            // Enter to send (Shift+Enter for new line)
            document.getElementById('userInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Fermer sidebar en cliquant sur la zone de chat
            document.getElementById('chatContainer').addEventListener('click', (e) => {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('open') && !e.target.closest('.sidebar')) {
                    closeSidebar();
                }
            });

            // Fermer sidebar quand on commence √† √©crire
            document.getElementById('userInput').addEventListener('focus', () => {
                closeSidebar();
            });

            // Sessions: √©viter la fermeture lors d'un scroll (mobile/touch)
            try {
                const conversationsList = document.getElementById('conversationsList');
                if (conversationsList && conversationsList.dataset && conversationsList.dataset.scrollGuardInstalled !== '1') {
                    conversationsList.dataset.scrollGuardInstalled = '1';

                    window.__axilum_sessionsDrag = { armed: false, moved: false, x: 0, y: 0 };

                    conversationsList.addEventListener('pointerdown', (e) => {
                        try {
                            window.__axilum_sessionsDrag.armed = true;
                            window.__axilum_sessionsDrag.moved = false;
                            window.__axilum_sessionsDrag.x = e.clientX || 0;
                            window.__axilum_sessionsDrag.y = e.clientY || 0;
                        } catch (_) {}
                    }, { passive: true });

                    conversationsList.addEventListener('pointermove', (e) => {
                        try {
                            const d = window.__axilum_sessionsDrag;
                            if (!d || !d.armed) return;
                            const dx = Math.abs((e.clientX || 0) - d.x);
                            const dy = Math.abs((e.clientY || 0) - d.y);
                            if (dx + dy > 8) d.moved = true;
                        } catch (_) {}
                    }, { passive: true });

                    conversationsList.addEventListener('scroll', () => {
                        try {
                            const d = window.__axilum_sessionsDrag;
                            if (d) d.moved = true;
                        } catch (_) {}
                    }, { passive: true });

                    conversationsList.addEventListener('pointerup', () => {
                        try {
                            const d = window.__axilum_sessionsDrag;
                            if (d) d.armed = false;
                            // Laisser passer l'event click puis reset
                            setTimeout(() => {
                                try { if (window.__axilum_sessionsDrag) window.__axilum_sessionsDrag.moved = false; } catch (_) {}
                            }, 0);
                        } catch (_) {}
                    }, { passive: true });
                }
            } catch (_) {}
            
            // üîî V√©rifier les notifications au d√©marrage
            if (notificationSettings.enabled) {
                checkUpcomingNotifications();
                // Rev√©rifier toutes les 5 minutes
                setInterval(checkUpcomingNotifications, 5 * 60 * 1000);
            }

            // Fermer le menu utilisateur si on clique ailleurs
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('userMenu');
                const accountBtn = document.getElementById('accountBtn');
                
                if (menu && accountBtn && !menu.contains(e.target) && !accountBtn.contains(e.target)) {
                    menu.classList.remove('show');
                }
            });

            // Initialize speech recognition if available
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = getSpeechLocale();
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('userInput').value = transcript;
                    adjustTextareaHeight();
                    showToast(t('toast.transcriptionDone'), 'success');
                };
                
                recognition.onerror = (event) => {
                    showToast(t('toast.voiceError'), 'error');
                    isRecording = false;
                };
                
                recognition.onend = () => {
                    isRecording = false;
                };
            }

            // Fermer le menu utilisateur si on clique ailleurs
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('userMenu');
                const accountBtn = document.getElementById('accountBtn');
                
                if (menu && accountBtn && !menu.contains(e.target) && !accountBtn.contains(e.target)) {
                    menu.classList.remove('show');
                }
            });
        });

        function adjustTextareaHeight() {
            const textarea = document.getElementById('userInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const chatContainer = document.getElementById('chatContainer');
            const inputContainer = document.querySelector('.input-container');
            sidebar.classList.toggle('open');
            chatContainer.classList.toggle('sidebar-open');

            // Fermer Sessions pour √©viter de bloquer le menu bas quand on referme
            if (!sidebar.classList.contains('open')) {
                closeSessionsList();
            }
            
            // R√©duire input en mobile quand sidebar ouverte
            if (sidebar.classList.contains('open')) {
                inputContainer.classList.add('sidebar-open');
            } else {
                inputContainer.classList.remove('sidebar-open');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const chatContainer = document.getElementById('chatContainer');
            const inputContainer = document.querySelector('.input-container');
            sidebar.classList.remove('open');
            chatContainer.classList.remove('sidebar-open');
            inputContainer.classList.remove('sidebar-open');
            closeSessionsList();
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Notifier les iframes du changement de th√®me
            try {
                const enterpriseFrame = document.getElementById('enterpriseOfferFrame');
                if (enterpriseFrame && enterpriseFrame.contentWindow) {
                    enterpriseFrame.contentWindow.postMessage({ type: 'axilum:theme-change', theme: newTheme }, '*');
                }
            } catch (_) {}
        }

        function newConversation(options) {
            const autoFocus = (options && Object.prototype.hasOwnProperty.call(options, 'autoFocus'))
                ? !!options.autoFocus
                : true;
            currentConversationId = Date.now().toString();
            const newConv = {
                id: currentConversationId,
                title: 'Nouvelle conversation',
                messages: [],
                timestamp: Date.now(),
                userId: currentUser ? currentUser.id : null // Lier √† l'utilisateur connect√©
            };
            conversations.unshift(newConv);
            saveConversations();
            loadConversations();
            clearChat();
            // Ne pas autofocus par d√©faut au d√©marrage (√©vite de capturer la saisie sans clic).
            if (autoFocus) {
                try { document.getElementById('userInput')?.focus(); } catch (_) {}
            }
        }

        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            revokeAllObjectUrls();
            // Restore welcome screen
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'flex';
            }
        }

        async function initConversationStorage() {
            // Charger depuis IDB si dispo, sinon migrer depuis localStorage.
            const userKey = getActiveUserKey();

            try {
                const existing = await idbGetKv(userKey, 'conversations');
                if (Array.isArray(existing)) {
                    conversations = existing;
                    return;
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è IndexedDB indisponible, fallback localStorage:', e);
            }

            // Fallback: lire localStorage (ancien syst√®me)
            let legacy = [];
            try {
                legacy = getHRData('conversations', []);
            } catch (e) {
                legacy = [];
            }

            // Si rien √† migrer, initialiser vide
            if (!Array.isArray(legacy) || legacy.length === 0) {
                conversations = [];
                try {
                    await idbSetKv(userKey, 'conversations', conversations);
                    // Nettoyage au cas o√π
                    localStorage.removeItem(getHRStorageKey('conversations'));
                } catch (_) {}
                return;
            }

            // Migration: d√©placer les base64 vers IDB images, remplacer par imageId
            try {
                showToast('üîÑ Migration stockage (IndexedDB)...', 'info');
                const migrated = await migrateLegacyConversationsToIdb(userKey, legacy);
                conversations = migrated;
                await idbSetKv(userKey, 'conversations', conversations);
                // Supprimer l'ancienne cl√© localStorage pour √©viter quota
                try {
                    localStorage.removeItem(getHRStorageKey('conversations'));
                } catch (_) {}
                showToast('‚úÖ Migration termin√©e', 'success');
            } catch (e) {
                console.error('‚ùå Migration IndexedDB √©chou√©e:', e);
                // Dernier recours: garder legacy en m√©moire (sans garantie de persistance)
                conversations = legacy;
            }
        }

        async function migrateLegacyConversationsToIdb(userKey, legacyConversations) {
            // Ne pas muter l'input, et garder un r√©sultat JSON-safe.
            const out = JSON.parse(JSON.stringify(legacyConversations));

            for (const conv of out) {
                if (!conv || !Array.isArray(conv.messages)) continue;

                for (const msg of conv.messages) {
                    if (!msg) continue;

                    if (msg.imageUrl && typeof msg.imageUrl === 'string' && msg.imageUrl.startsWith('data:image/')) {
                        // Stocker dans IDB et remplacer
                        try {
                            const blob = await dataUrlToBlob(msg.imageUrl);
                            const imageId = await idbPutImageBlob(userKey, blob, blob.type, msg.user || 'image');
                            msg.imageId = imageId;
                            delete msg.imageUrl;
                        } catch (e) {
                            // Si conversion √©choue, laisser imageUrl tel quel (rare)
                            console.warn('‚ö†Ô∏è Migration image √©chou√©e, imageUrl conserv√©e:', e);
                        }
                    }
                }
            }
            return out;
        }

        // Function to use a suggestion
        function useSuggestion(text, agentArg, autoSend) {
            const input = document.getElementById('userInput');
            if (!input) return;

            // Optionnel: basculer d'agent avant d'envoyer
            const arg = (agentArg === undefined || agentArg === null) ? '' : String(agentArg).trim();
            if (arg) {
                try { setChatType(arg); } catch (_) {}
            }

            input.value = text;
            input.focus();
            adjustTextareaHeight();

            // UX: si la suggestion contient un placeholder [..], s√©lectionner le premier pour faciliter la saisie.
            // (Uniquement si pas d'auto-envoi)
            if (autoSend !== true && typeof text === 'string') {
                try {
                    const start = text.indexOf('[');
                    const end = text.indexOf(']', start + 1);
                    if (start !== -1 && end !== -1 && end > start + 1) {
                        input.setSelectionRange(start + 1, end);
                    }
                } catch (_) {}
            }

            // Optionnel: auto-envoi
            if (autoSend === true) {
                try { sendMessage(); } catch (_) {}
            }
        }

        // ===================================
        // ‚úÖ Workflow: Excel analysis -> upload -> auto report (Agent Xcel) -> back to Axilum
        // ===================================
        const pendingExcelReportByConversation = {};
        const excelReportRestoreChatTypeByConversation = {};
        const EXCEL_FILE_ACCEPT = '.xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel';

        function startExcelReportWorkflow() {
            try {
                const convId = currentConversationId;
                if (!convId) return;

                // Masquer l'√©cran d'accueil (si visible)
                const welcomeScreen = document.getElementById('welcomeScreen');
                if (welcomeScreen) welcomeScreen.style.display = 'none';

                pendingExcelReportByConversation[convId] = true;
                excelReportRestoreChatTypeByConversation[convId] = (typeof currentChatType !== 'undefined' && currentChatType) ? currentChatType : 'axilum';

                // Demande d'upload (r√©ponse locale, pas d'appel IA)
                try { addMessage(t('excelReport.uploadRequest'), 'bot'); } catch (_) {}

                // Ouvrir le s√©lecteur de fichiers en for√ßant le filtre Excel
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    try {
                        if (fileInput.dataset && fileInput.dataset.prevAccept === undefined) {
                            fileInput.dataset.prevAccept = fileInput.getAttribute('accept') || '';
                        }
                    } catch (_) {}
                    try { fileInput.setAttribute('accept', EXCEL_FILE_ACCEPT); } catch (_) {}
                    try { fileInput.click(); } catch (_) {}
                }
            } catch (_) {
                // no-op
            }
        }

        async function runExcelReportFromUploadedFile() {
            const input = document.getElementById('userInput');
            if (!input) return;

            const convId = currentConversationId;
            if (!convId) return;

            // Pr√©parer le prompt utilisateur (visible) + contexte Excel (invisible via buildAgentExcelContext)
            input.value = t('excelReport.generatePrompt');
            try { adjustTextareaHeight(); } catch (_) {}

            try {
                // Basculer temporairement sur l'agent Excel Expert
                try { setChatType('excel-expert'); } catch (_) {}
                await sendMessage();
            } finally {
                // Retour au chat Axilum normal (tel que demand√©)
                try { setChatType('axilum'); } catch (_) {}

                // R√©tablir l'accept du file input
                try {
                    const fileInput = document.getElementById('fileInput');
                    if (fileInput && fileInput.dataset && typeof fileInput.dataset.prevAccept === 'string') {
                        const prevAccept = fileInput.dataset.prevAccept;
                        if (prevAccept) fileInput.setAttribute('accept', prevAccept);
                        else fileInput.removeAttribute('accept');
                        delete fileInput.dataset.prevAccept;
                    }
                } catch (_) {}

                // Nettoyer le flag workflow
                delete pendingExcelReportByConversation[convId];
                delete excelReportRestoreChatTypeByConversation[convId];

                // Notifier (toast uniquement)
                try { showToast(t('excelReport.doneToast'), 'success'); } catch (_) {}
            }
        }

        function showMoreWelcomePrompts() {
            const extraCards = document.querySelectorAll('.welcome-prompt--extra');
            extraCards.forEach(card => card.classList.remove('prompt-card--hidden'));

            const moreCard = document.getElementById('welcomeMorePromptsCard');
            if (moreCard) moreCard.classList.add('prompt-card--hidden');
        }

        // üÜìüíé Plan Management
        let currentPlan = localStorage.getItem('axilum_plan') || 'pro'; // Default to pro

        // ‚òÅÔ∏èüóÑÔ∏è Mode de stockage (choix utilisateur)
        // - 'ask'   : demander √† chaque upload
        // - 'local' : stockage uniquement sur l'appareil
        // - 'cloud' : stockage cloud (si connect√©)
        function getStorageMode() {
            const v = (localStorage.getItem('axilum_storage_mode') || 'ask').toLowerCase();
            if (v === 'cloud' || v === 'local' || v === 'ask') return v;
            return 'ask';
        }

        function storageModeLabel(mode) {
            switch ((mode || '').toLowerCase()) {
                case 'cloud': return t('settings.storage.cloud');
                case 'local': return t('settings.storage.local');
                default: return t('settings.storage.ask');
            }
        }

        function refreshStorageModeUI() {
            const el = document.getElementById('storageModeValue');
            if (!el) return;
            el.textContent = storageModeLabel(getStorageMode());
        }

        function setStorageMode(mode) {
            const m = (mode || '').toLowerCase();
            const finalMode = (m === 'cloud' || m === 'local' || m === 'ask') ? m : 'ask';
            localStorage.setItem('axilum_storage_mode', finalMode);
            refreshStorageModeUI();
            try { updateStorageModeButtonsUI(); } catch (_) {}
            try { refreshStorageQuotaUI(); } catch (_) {}
            showToast(`${t('toast.storagePrefix')} ${storageModeLabel(finalMode)}`, 'info');
        }

        function cycleStorageMode() {
            const current = getStorageMode();
            const next = current === 'ask' ? 'local' : (current === 'local' ? 'cloud' : 'ask');
            setStorageMode(next);
        }

        function closeStorageModeModal() {
            const el = document.getElementById('storageModeModal');
            if (el) el.style.display = 'none';
        }

        function openStorageModeModal() {
            const el = document.getElementById('storageModeModal');
            if (!el) return;
            el.style.display = 'flex';
            try { refreshStorageModeUI(); } catch (_) {}
            try { updateStorageModeButtonsUI(); } catch (_) {}
            try { refreshStorageAddonFromServer(); } catch (_) {}
            try { refreshStorageQuotaUI(); } catch (_) {}
        }

        function closeStorageAddModal() {
            const el = document.getElementById('storageAddModal');
            if (el) el.style.display = 'none';
        }

        function openStorageAddModal() {
            const el = document.getElementById('storageAddModal');
            if (!el) return;
            el.style.display = 'flex';
            const status = document.getElementById('storageAddStatus');
            if (status) status.textContent = '';
        }

        function getStorageAddonGb() {
            try {
                const v = Number(window.__axilumStorageAddonGb || 0);
                if (Number.isFinite(v) && v > 0) return v;
            } catch (_) {}
            try {
                const v2 = Number(localStorage.getItem('axilum_storage_addon_gb') || 0);
                return Number.isFinite(v2) && v2 > 0 ? v2 : 0;
            } catch (_) {
                return 0;
            }
        }

        function setStorageAddonGb(gb) {
            const v = Number(gb);
            const finalV = Number.isFinite(v) && v >= 0 ? Math.floor(v) : 0;
            try { window.__axilumStorageAddonGb = finalV; } catch (_) {}
            try { localStorage.setItem('axilum_storage_addon_gb', String(finalV)); } catch (_) {}
        }

        function getIncludedStorageQuotaGb(plan) {
            const p = String(plan || '').toLowerCase();
            if (p === 'free') return 0.2; // 200 Mo indicatif
            if (p === 'enterprise') return 50;
            return 5; // PRO par d√©faut
        }

        function getTotalStorageQuotaGb() {
            const included = getIncludedStorageQuotaGb(currentPlan);
            const addon = getStorageAddonGb();
            return Math.max(0, Number(included || 0) + Number(addon || 0));
        }

        function formatGb(gb) {
            const n = Number(gb);
            if (!Number.isFinite(n)) return '‚Äî';
            if (n < 1) return `${Math.round(n * 1024)} Mo`;
            return `${n.toFixed(n < 10 ? 1 : 0)} Go`;
        }

        function formatBytes(bytes) {
            const n = Number(bytes);
            if (!Number.isFinite(n) || n < 0) return '‚Äî';
            const kb = 1024;
            const mb = kb * 1024;
            const gb = mb * 1024;
            if (n >= gb) return `${(n / gb).toFixed(2)} Go`;
            if (n >= mb) return `${(n / mb).toFixed(1)} Mo`;
            if (n >= kb) return `${(n / kb).toFixed(1)} Ko`;
            return `${Math.round(n)} o`;
        }

        async function fetchFinanceCloudStorageUsageBytes() {
            const token = (typeof getAuthToken === 'function') ? getAuthToken() : null;
            if (!token) return null;

            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
            const containers = ['invoices', 'reports'];
            let total = 0;
            let any = false;

            for (const c of containers) {
                try {
                    const res = await fetch('/api/finance-storage-list', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ container: c })
                    });
                    const data = await res.json().catch(() => null);
                    if (!res.ok || !data || !Array.isArray(data.items)) continue;
                    for (const it of data.items) {
                        const s = it && it.size != null ? Number(it.size) : 0;
                        if (Number.isFinite(s) && s > 0) total += s;
                    }
                    any = true;
                } catch (_) {
                    // ignore
                }
            }

            return any ? total : 0;
        }

        async function fetchCloudStorageUsageFromServer() {
            const token = (typeof getAuthToken === 'function') ? getAuthToken() : null;
            if (!token) return null;

            const headers = { 'Authorization': `Bearer ${token}` };
            try {
                const res = await fetch('/api/me/storage-usage', { method: 'GET', headers });
                const data = await res.json().catch(() => null);
                if (!res.ok || !data || !data.ok || !data.usage) return null;
                try {
                    if (data.quota && data.quota.addonGb != null) {
                        setStorageAddonGb(Number(data.quota.addonGb || 0));
                    }
                } catch (_) {}
                return data;
            } catch (_) {
                return null;
            }
        }

        async function refreshStorageAddonFromServer() {
            const token = (typeof getAuthToken === 'function') ? getAuthToken() : null;
            if (!token) return null;
            try {
                const res = await fetch('/api/me/storage-addon', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json().catch(() => null);
                if (!res.ok || !data || !data.ok) return null;
                if (data.addonGb != null) setStorageAddonGb(Number(data.addonGb || 0));
                return data;
            } catch (_) {
                return null;
            }
        }

        async function refreshStorageQuotaUI() {
            const totalEl = document.getElementById('storageQuotaTotal');
            const usedEl = document.getElementById('storageQuotaUsed');
            const remEl = document.getElementById('storageQuotaRemaining');
            const hintEl = document.getElementById('storageQuotaHint');

            if (totalEl) totalEl.textContent = formatGb(getTotalStorageQuotaGb());
            if (usedEl) usedEl.textContent = '‚Ä¶';
            if (remEl) remEl.textContent = '‚Ä¶';
            if (hintEl) hintEl.textContent = '';

            const mode = getStorageMode();
            if (mode !== 'cloud') {
                if (usedEl) usedEl.textContent = '‚Äî';
                if (remEl) remEl.textContent = '‚Äî';
                if (hintEl) hintEl.textContent = 'Passez en mode Cloud pour mesurer et g√©rer le quota.';
                return;
            }

            // 1) Pr√©f√©rer la mesure serveur (auth obligatoire, extensible multi-modules)
            const server = await fetchCloudStorageUsageFromServer();
            const bytes = server && server.usage ? Number(server.usage.totalBytes || 0) : await fetchFinanceCloudStorageUsageBytes();
            if (bytes == null) {
                if (usedEl) usedEl.textContent = 'Connexion requise';
                if (remEl) remEl.textContent = '‚Äî';
                if (hintEl) hintEl.textContent = 'Connectez-vous pour voir l‚Äôusage Cloud et acheter du stockage.';
                return;
            }

            const quotaBytes = getTotalStorageQuotaGb() * 1024 * 1024 * 1024;
            const remainingBytes = Math.max(0, quotaBytes - bytes);

            if (usedEl) usedEl.textContent = formatBytes(bytes);
            if (remEl) remEl.textContent = formatBytes(remainingBytes);
            if (hintEl) {
                const addon = getStorageAddonGb();
                hintEl.textContent = addon
                    ? `Inclu: ${formatGb(getIncludedStorageQuotaGb(currentPlan))} ‚Ä¢ Add-on: ${formatGb(addon)}.`
                    : `Inclu: ${formatGb(getIncludedStorageQuotaGb(currentPlan))}.`;
            }
        }

        function updateStorageModeButtonsUI() {
            const m = getStorageMode();
            const ask = document.getElementById('storageModeBtnAsk');
            const local = document.getElementById('storageModeBtnLocal');
            const cloud = document.getElementById('storageModeBtnCloud');
            if (ask) ask.classList.toggle('active', m === 'ask');
            if (local) local.classList.toggle('active', m === 'local');
            if (cloud) cloud.classList.toggle('active', m === 'cloud');
        }

        function addStorageAddonGb(deltaGb) {
            const d = Number(deltaGb);
            if (!Number.isFinite(d) || d <= 0) return;
            const status = document.getElementById('storageAddStatus');
            if (status) status.textContent = 'Activation‚Ä¶';

            (async () => {
                const token = (typeof getAuthToken === 'function') ? getAuthToken() : null;
                if (!token) {
                    if (status) status.textContent = 'Connexion requise.';
                    try { showToast('Connexion requise', 'error'); } catch (_) {}
                    return;
                }

                try {
                    const res = await fetch('/api/me/storage-addon', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ deltaGb: Math.floor(d) })
                    });
                    const data = await res.json().catch(() => null);

                    if (res.ok && data && data.ok) {
                        if (data.addonGb != null) setStorageAddonGb(Number(data.addonGb || 0));
                        if (status) status.textContent = `Stockage ajout√©: +${Math.floor(d)} Go (add-on total: ${getStorageAddonGb()} Go).`;
                        try { refreshStorageQuotaUI(); } catch (_) {}
                        try { showToast(`Stockage: +${Math.floor(d)} Go`, 'success'); } catch (_) {}
                        return;
                    }

                    const err = (data && (data.error || data.details)) ? String(data.error || data.details) : 'Non autoris√©';
                    if (status) status.textContent = `Non activ√© (serveur: ${err}).`;
                    try { showToast('Stockage non activ√© (paiement requis)', 'error'); } catch (_) {}
                } catch (_) {
                    if (status) status.textContent = 'Erreur r√©seau. R√©essayez plus tard.';
                    try { showToast('Erreur r√©seau', 'error'); } catch (_) {}
                }
            })();
        }

        // üñºÔ∏è Derni√®re image upload√©e (par conversation) pour questions Vision
        const lastUploadedImageByConversation = {};
        const lastUploadedImageNameByConversation = {};

        // üìé Dernier document texte/PDF upload√© (par conversation) pour contexte ponctuel
        // Objectif: ne pas afficher le texte complet dans la bulle, mais pouvoir l'envoyer au backend si besoin.
        const pendingUploadedDocByConversation = {}; // { [convId]: { fileName, mimeType, extractedText, objectUrl, createdAt } }

        function humanFileSize(bytes) {
            const b = Number(bytes || 0);
            if (!Number.isFinite(b) || b <= 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            let n = b;
            while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
            const d = (i === 0) ? 0 : (i === 1 ? 1 : 2);
            return `${n.toFixed(d)} ${units[i]}`;
        }

        function getFileDisplayMeta(fileName, mimeType) {
            const name = String(fileName || 'fichier');
            const lowerName = name.toLowerCase();
            const lowerMime = String(mimeType || '').toLowerCase();

            const extMatch = lowerName.match(/\.([a-z0-9]{1,8})$/);
            const ext = extMatch ? extMatch[1] : '';
            const extLabel = ext ? ext.toUpperCase() : '';

            const isImage = lowerMime.startsWith('image/') || /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/.test(lowerName);
            const isPdf = lowerMime === 'application/pdf' || lowerName.endsWith('.pdf');
            const isText = lowerMime === 'text/plain' || lowerName.endsWith('.txt');
            const isCsv = lowerMime === 'text/csv' || lowerName.endsWith('.csv');
            const isExcel = lowerMime === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                || lowerMime === 'application/vnd.ms-excel'
                || /\.(xlsx|xls)$/.test(lowerName);
            const isDoc = /\.(docx|doc)$/.test(lowerName) || lowerMime.includes('word');
            const isZip = /\.(zip|rar|7z|tar|gz)$/.test(lowerName) || lowerMime.includes('zip');
            const isAudio = lowerMime.startsWith('audio/') || /\.(mp3|wav|m4a|ogg|flac)$/.test(lowerName);
            const isVideo = lowerMime.startsWith('video/') || /\.(mp4|mov|mkv|webm|avi)$/.test(lowerName);

            let icon = 'üìé';
            let typeLabel = extLabel || (mimeType ? String(mimeType) : '');

            if (isPdf) { icon = 'üìÑ'; typeLabel = 'PDF'; }
            else if (isExcel) { icon = 'üìä'; typeLabel = extLabel || 'EXCEL'; }
            else if (isCsv) { icon = 'üìä'; typeLabel = 'CSV'; }
            else if (isText) { icon = 'üìù'; typeLabel = 'TXT'; }
            else if (isImage) { icon = 'üñºÔ∏è'; typeLabel = extLabel || 'IMAGE'; }
            else if (isDoc) { icon = 'üìÑ'; typeLabel = extLabel || 'DOC'; }
            else if (isZip) { icon = 'üóúÔ∏è'; typeLabel = extLabel || 'ARCHIVE'; }
            else if (isAudio) { icon = 'üîä'; typeLabel = extLabel || 'AUDIO'; }
            else if (isVideo) { icon = 'üéûÔ∏è'; typeLabel = extLabel || 'VID√âO'; }

            return { icon, typeLabel };
        }

        function appendUploadedFileCardToChat({ fileName, objectUrl, remoteFileId, mimeType, sizeBytes, subtitle }) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            const safeName = String(fileName || 'fichier');
            const safeUrl = objectUrl ? String(objectUrl) : '';
            const safeRemoteId = remoteFileId ? String(remoteFileId) : '';
            const safeMime = String(mimeType || 'application/octet-stream');
            const disp = getFileDisplayMeta(safeName, safeMime);
            const meta = subtitle ? String(subtitle) : `${humanFileSize(sizeBytes)} ‚Ä¢ ${(disp && disp.typeLabel) ? disp.typeLabel : safeMime}`;

            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper user file-message';

            const now = new Date();
            const time = now.toLocaleTimeString(getLocale(), { hour: '2-digit', minute: '2-digit' });

            messageWrapper.innerHTML = `
                <div class="message-header">
                    <div class="avatar user-avatar">üë§</div>
                    <span class="message-sender">Vous</span>
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-content">
                    ${safeRemoteId ? `
                        <a href="#" onclick="openRemoteChatFile('${safeRemoteId}'); return false;" title="${escapeHtmlLite(meta)}" style="display:inline-flex; align-items:center; gap:6px; font-weight:700; font-size:12px; color: var(--text-primary); text-decoration: underline; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            <span aria-hidden="true" style="font-size:14px; line-height:1;">${escapeHtmlLite((disp && disp.icon) ? disp.icon : 'üìé')}</span>
                            <span style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtmlLite(safeName)}</span>
                        </a>
                    ` : (safeUrl ? `
                        <a href="${safeUrl}" target="_blank" rel="noopener" title="${escapeHtmlLite(meta)}" style="display:inline-flex; align-items:center; gap:6px; font-weight:700; font-size:12px; color: var(--text-primary); text-decoration: underline; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            <span aria-hidden="true" style="font-size:14px; line-height:1;">${escapeHtmlLite((disp && disp.icon) ? disp.icon : 'üìé')}</span>
                            <span style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtmlLite(safeName)}</span>
                        </a>
                    ` : `
                        <span title="${escapeHtmlLite(meta)}" style="display:inline-flex; align-items:center; gap:6px; font-weight:700; font-size:12px; color: var(--text-primary); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            <span aria-hidden="true" style="font-size:14px; line-height:1;">${escapeHtmlLite((disp && disp.icon) ? disp.icon : 'üìé')}</span>
                            <span style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtmlLite(safeName)}</span>
                        </span>
                    `)}
                </div>
            `;

            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // üìÑ OCR local (mode FREE): cache par conversation
        const lastUploadedOcrTextByConversation = {};
        const lastUploadedOcrImageSigByConversation = {};

        // üí° Promo Vision Pro (mode FREE): ne l'afficher qu'une seule fois par conversation
        const visionProPromoShownByConversation = {};

        // üñºÔ∏è Vision PRO: cache d'analyse par conversation (√©vite de re-lancer Azure √† chaque message)
        const lastUploadedVisionTextByConversation = {};
        const lastUploadedVisionImageSigByConversation = {};

        let __tesseractLoadPromise = null;
        function loadTesseract() {
            if (window.Tesseract) return Promise.resolve(window.Tesseract);
            if (__tesseractLoadPromise) return __tesseractLoadPromise;

            __tesseractLoadPromise = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
                script.async = true;
                script.onload = () => resolve(window.Tesseract);
                script.onerror = () => reject(new Error('Impossible de charger le module OCR (tesseract.js)'));
                document.head.appendChild(script);
            });

            return __tesseractLoadPromise;
        }

        async function extractTextFromImageBase64(base64) {
            const Tesseract = await loadTesseract();
            try {
                const result = await Tesseract.recognize(base64, 'fra', {
                    langPath: 'https://tessdata.projectnaptha.com/4.0.0',
                    logger: () => {}
                });
                return (result && result.data && result.data.text ? result.data.text : '').trim();
            } catch (e) {
                const result = await Tesseract.recognize(base64, 'eng', {
                    langPath: 'https://tessdata.projectnaptha.com/4.0.0',
                    logger: () => {}
                });
                return (result && result.data && result.data.text ? result.data.text : '').trim();
            }
        }

        function withTimeout(promise, timeoutMs, timeoutMessage = 'D√©lai d√©pass√©') {
            let timeoutHandle;
            const timeoutPromise = new Promise((_, reject) => {
                timeoutHandle = setTimeout(() => {
                    const err = new Error(timeoutMessage);
                    err.name = 'TimeoutError';
                    reject(err);
                }, timeoutMs);
            });
            return Promise.race([promise, timeoutPromise]).finally(() => clearTimeout(timeoutHandle));
        }

        function appendVisionProPromo(rawText) {
            const promo = "\n\nüí° Pour une analyse Pro de l'image (objets, sc√®ne, d√©tails), je vous propose d'utiliser l'outil Vision Pro.";
            if (!rawText) return promo.trim();

            // Idempotent: ne pas r√©p√©ter la promo si elle est d√©j√† pr√©sente
            if (String(rawText).includes(promo.trim()) || String(rawText).includes("l'outil Vision Pro")) {
                return rawText;
            }

            const sepIndex = rawText.indexOf('\n---');
            if (sepIndex !== -1) {
                return rawText.slice(0, sepIndex) + promo + rawText.slice(sepIndex);
            }
            return rawText + promo;
        }

        function safeJsonParse(value, fallback) {
            try {
                if (typeof value !== 'string') return fallback;
                return JSON.parse(value);
            } catch (_) {
                return fallback;
            }
        }

        function getRnDDataFromStorage() {
            const projects = safeJsonParse(localStorage.getItem('rndProjects') || '[]', []);
            const milestones = safeJsonParse(localStorage.getItem('rndMilestones') || '[]', []);
            const documents = safeJsonParse(localStorage.getItem('rndDocuments') || '[]', []);
            const risks = safeJsonParse(localStorage.getItem('rndRisks') || '[]', []);
            return {
                projects: Array.isArray(projects) ? projects : [],
                milestones: Array.isArray(milestones) ? milestones : [],
                documents: Array.isArray(documents) ? documents : [],
                risks: Array.isArray(risks) ? risks : []
            };
        }

        function truncateText(text, maxChars) {
            const str = String(text || '');
            if (!maxChars || maxChars <= 0) return str;
            if (str.length <= maxChars) return str;
            return str.slice(0, maxChars) + `\n\n[Note: contexte tronqu√© √† ${maxChars} caract√®res]`;
        }

        function getHRModuleDataFromStorage() {
            const employees = getHRData('hrEmployees');
            const leaves = getHRData('hrLeaves');
            const payrolls = getHRData('hrPayrolls');
            const reviews = getHRData('hrReviews');
            const companySettings = getHRData('companySettings', {});
            const recruitmentJobs = getHRData('recruitmentJobs');
            const recruitmentCandidates = getHRData('recruitmentCandidates');

            return {
                employees: Array.isArray(employees) ? employees : [],
                leaves: Array.isArray(leaves) ? leaves : [],
                payrolls: Array.isArray(payrolls) ? payrolls : [],
                reviews: Array.isArray(reviews) ? reviews : [],
                companySettings: (companySettings && typeof companySettings === 'object') ? companySettings : {},
                recruitmentJobs: Array.isArray(recruitmentJobs) ? recruitmentJobs : [],
                recruitmentCandidates: Array.isArray(recruitmentCandidates) ? recruitmentCandidates : []
            };
        }

        function buildAgentHRContext({ mode = 'summary', employees = [], leaves = [], payrolls = [], reviews = [], recruitmentJobs = [], recruitmentCandidates = [], companySettings = {} } = {}) {
            const byStatus = (arr, field = 'status') => {
                const out = {};
                (Array.isArray(arr) ? arr : []).forEach(x => {
                    const k = (x && x[field]) ? String(x[field]) : 'unknown';
                    out[k] = (out[k] || 0) + 1;
                });
                return out;
            };

            const employeesStatus = byStatus(employees, 'status');
            const leavesStatus = byStatus(leaves, 'status');
            const payrollStatus = byStatus(payrolls, 'status');

            const topEmployees = (Array.isArray(employees) ? employees : []).slice(0, 5).map(e => {
                const fullName = [e?.firstName, e?.lastName].filter(Boolean).join(' ').trim() || t('hr.employee.defaultPosition');
                const dept = e?.department ? ` | D√©partement: ${e.department}` : '';
                const pos = e?.position ? ` | Poste: ${e.position}` : '';
                const status = e?.status ? ` | Statut: ${e.status}` : '';
                return `- ${fullName}${pos}${dept}${status}`;
            }).join('\n') || 'Aucun employ√©';

            const pendingLeaves = (Array.isArray(leaves) ? leaves : []).filter(l => l && l.status === 'pending').slice(0, 5).map(l => {
                const emp = (Array.isArray(employees) ? employees : []).find(e => e && e.id === l.employeeId);
                const fullName = [emp?.firstName, emp?.lastName].filter(Boolean).join(' ').trim() || `employeeId=${l.employeeId || 'N/A'}`;
                const type = l?.type ? ` | Type: ${l.type}` : '';
                const start = l?.startDate ? ` | D√©but: ${l.startDate}` : '';
                const end = l?.endDate ? ` | Fin: ${l.endDate}` : '';
                return `- ${fullName}${type}${start}${end}`;
            }).join('\n') || 'Aucune demande en attente';

            const pendingPayrolls = (Array.isArray(payrolls) ? payrolls : []).filter(p => p && p.status === 'pending').slice(0, 5).map(p => {
                const emp = (Array.isArray(employees) ? employees : []).find(e => e && e.id === p.employeeId);
                const fullName = [emp?.firstName, emp?.lastName].filter(Boolean).join(' ').trim() || `employeeId=${p.employeeId || 'N/A'}`;
                const period = p?.period ? ` | P√©riode: ${p.period}` : '';
                const net = (typeof p?.netSalary === 'number') ? ` | Net: ${p.netSalary}` : '';
                return `- ${fullName}${period}${net}`;
            }).join('\n') || 'Aucun bulletin en attente';

            const constraints = `
[Contraintes produit]
- Ne pr√©tends pas ex√©cuter des actions automatiquement dans l'UI
- N'invente jamais des donn√©es RH si elles ne sont pas dans le contexte ci-dessous
- Si une info manque (p√©riode, employ√©, statut), pose 1-3 questions cibl√©es
`;

            const moduleDoc = `
=== TU ES AGENT RH ‚Äî AXILUM HR MANAGEMENT HUB ===

Ce module RH (dans l'app) couvre notamment:
- Employ√©s: cr√©ation/consultation/suppression + filtres (nom, d√©partement, statut)
- Cong√©s: demandes (pending/approved/rejected), calendrier, approbation/refus/suppression
- Paie: bulletins (pending/validated/paid), g√©n√©ration en masse, validation, marquer comme pay√©, d√©tails bulletin
- Autres onglets pr√©sents dans l'UI: √âvaluations, Turnover, Recrutement

Stockage local (navigateur / localStorage) utilis√© par le module:
- hrEmployees, hrLeaves, hrPayrolls, hrReviews, companySettings, recruitmentJobs, recruitmentCandidates

Workflows (statuts):
- Cong√©s: pending ‚Üí approved | rejected (suppression possible)
- Paie: pending ‚Üí validated ‚Üí paid (suppression possible)

Actions UI existantes (√† expliquer √† l'utilisateur si demand√©):
- Employ√©s: ajouter, voir, supprimer
- Cong√©s: nouvelle demande, approuver (approveLeave), refuser (rejectLeave), supprimer (deleteLeave)
- Paie: g√©n√©rer tous (generateAllPayrolls), nouveau bulletin, valider (validatePayroll), marquer pay√© (markPayrollAsPaid), d√©tails (viewPayrollDetails)
`;

            const dataSnapshot = `
---
DONN√âES RH DISPONIBLES (snapshot):

Employ√©s: ${employees.length} (statuts: ${JSON.stringify(employeesStatus)})
${topEmployees}

Cong√©s: ${leaves.length} (statuts: ${JSON.stringify(leavesStatus)})
Demandes en attente (top):
${pendingLeaves}

Paie: ${payrolls.length} (statuts: ${JSON.stringify(payrollStatus)})
Bulletins en attente (top):
${pendingPayrolls}

√âvaluations: ${reviews.length}
Recrutement: offres=${recruitmentJobs.length}, candidats=${recruitmentCandidates.length}
Param√®tres entreprise: ${Object.keys(companySettings || {}).length ? 'pr√©sents' : 'absents'}
---
`;

            if (mode === 'summary') {
                return truncateText(`${constraints}${moduleDoc}${dataSnapshot}`, 6000);
            }
            return truncateText(`${constraints}${moduleDoc}${dataSnapshot}`, 12000);
        }

        function getMarketingModuleDataFromStorage() {
            const campaigns = safeJsonParse(localStorage.getItem('marketingCampaigns') || '[]', []);
            const personas = safeJsonParse(localStorage.getItem('marketingPersonas') || '[]', []);
            const content = safeJsonParse(localStorage.getItem('marketingContent') || '[]', []);
            const business = safeJsonParse(localStorage.getItem('marketingBusiness') || '{}', {});
            return {
                campaigns: Array.isArray(campaigns) ? campaigns : [],
                personas: Array.isArray(personas) ? personas : [],
                content: Array.isArray(content) ? content : [],
                business: (business && typeof business === 'object') ? business : {}
            };
        }

        function buildAgentMarketingContext({ mode = 'summary', campaigns = [], personas = [], content = [], business = {} } = {}) {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const isEn = (lang === 'en');

            const safeNum = (v) => (typeof v === 'number' && Number.isFinite(v)) ? v : (parseFloat(v) || 0);
            const list = Array.isArray(campaigns) ? campaigns : [];
            const totalBudget = list.reduce((sum, c) => sum + safeNum(c?.budget), 0);
            const totalSpent = list.reduce((sum, c) => sum + safeNum(c?.spent), 0);
            const totalLeads = list.reduce((sum, c) => sum + safeNum(c?.leads), 0);
            const avgRoi = list.length ? Math.round(list.reduce((sum, c) => sum + safeNum(c?.roi), 0) / list.length) : 0;
            const cac = totalLeads > 0 ? Math.round(totalSpent / totalLeads) : 0;

            const topCampaigns = list
                .slice()
                .sort((a, b) => safeNum(b?.roi) - safeNum(a?.roi))
                .slice(0, 5)
                .map(c => {
                    const name = c?.name || (isEn ? 'Campaign' : 'Campagne');
                    const type = c?.type ? (isEn ? ` | Type: ${c.type}` : ` | Type: ${c.type}`) : '';
                    const status = c?.status ? (isEn ? ` | Status: ${c.status}` : ` | Statut: ${c.status}`) : '';
                    const roi = ` | ROI: ${Math.round(safeNum(c?.roi))}%`;
                    const leads = c?.leads != null ? ` | Leads: ${safeNum(c?.leads)}` : '';
                    const budget = c?.budget != null ? ` | Budget: ${safeNum(c?.budget)} DA` : '';
                    return `- ${name}${type}${status}${roi}${leads}${budget}`;
                }).join('\n') || (isEn ? 'No campaigns' : 'Aucune campagne');

            const topPersonas = (Array.isArray(personas) ? personas : []).slice(0, 5).map(p => {
                const name = p?.name || 'Persona';
                const age = p?.age != null ? (isEn ? ` | Age: ${p.age}` : ` | √Çge: ${p.age}`) : '';
                const prof = p?.profession ? (isEn ? ` | Job: ${p.profession}` : ` | Profession: ${p.profession}`) : '';
                const goals = Array.isArray(p?.goals) && p.goals.length ? (isEn ? ` | Goals: ${p.goals.slice(0, 4).join(', ')}` : ` | Objectifs: ${p.goals.slice(0, 4).join(', ')}`) : '';
                return `- ${name}${age}${prof}${goals}`;
            }).join('\n') || (isEn ? 'No personas' : 'Aucun persona');

            const topContent = (Array.isArray(content) ? content : []).slice(0, 5).map(i => {
                const title = i?.title || (isEn ? 'Content' : 'Contenu');
                const type = i?.type ? (isEn ? ` | Type: ${i.type}` : ` | Type: ${i.type}`) : '';
                const status = i?.status ? (isEn ? ` | Status: ${i.status}` : ` | Statut: ${i.status}`) : '';
                const date = i?.publishDate ? ` | Date: ${i.publishDate}` : '';
                return `- ${title}${type}${status}${date}`;
            }).join('\n') || (isEn ? 'No content' : 'Aucun contenu');

            const constraintsFr = `
[Contraintes produit]
- Ne mentionne pas d'autres modules/agents/outils sauf si l'utilisateur le demande explicitement
- N'invente jamais de donn√©es marketing si elles ne sont pas dans le contexte
- Si une info manque (p√©riode, canal, budget), pose 1-3 questions cibl√©es
`;
            const constraintsEn = `
[Product constraints]
- Do not mention other modules/agents/tools unless the user explicitly asks
- Never invent marketing data if not in the context
- If info is missing (period, channel, budget), ask 1-3 targeted questions
`;

            const moduleDocFr = `
=== TU ES AGENT MARK ‚Äî AXILUM MARKETING & BUSINESS HUB ===

Ce module Marketing (dans l'app) couvre notamment:
- Campagnes: cr√©ation/lecture, KPI (ROI, leads, budget, spent), statuts (ex: active)
- Personas: profils clients + objectifs
- Contenu: calendrier √©ditorial (type, statut, date)
- Business: business model + objectifs + m√©triques (LTV, churn, MRR)
- Analytics: section pr√©sente (peut √™tre "en d√©veloppement" selon l'UI)

Stockage local (navigateur / localStorage) utilis√© par le module:
- marketingCampaigns, marketingPersonas, marketingContent, marketingBusiness
`;
            const moduleDocEn = `
=== YOU ARE AGENT MARK ‚Äî AXILUM MARKETING & BUSINESS HUB ===

This Marketing module (in app) covers:
- Campaigns: create/read, KPIs (ROI, leads, budget, spent), status (e.g. active)
- Personas: client profiles + goals
- Content: editorial calendar (type, status, date)
- Business: business model + objectives + metrics (LTV, churn, MRR)
- Analytics: present section (may be "under development" depending on UI)

Local storage (browser / localStorage) used by the module:
- marketingCampaigns, marketingPersonas, marketingContent, marketingBusiness
`;

            const constraints = isEn ? constraintsEn : constraintsFr;
            const moduleDoc = isEn ? moduleDocEn : moduleDocFr;

            const businessSafe = (business && typeof business === 'object') ? business : {};
            const objectives = Array.isArray(businessSafe.objectives) ? businessSafe.objectives : [];
            const topObjectives = objectives.slice(0, 5).map(o => {
                const title = o?.title || (isEn ? 'Objective' : 'Objectif');
                const target = o?.target ? (isEn ? ` | Target: ${o.target}` : ` | Cible: ${o.target}`) : '';
                return `- ${title}${target}`;
            }).join('\n') || (isEn ? 'No objectives' : 'Aucun objectif');

            const dataSnapshotFr = `
---
DONN√âES MARKETING DISPONIBLES (snapshot):

Campagnes: ${list.length}
KPIs: CAC=${cac} DA | ROI moyen=${avgRoi}% | Leads=${totalLeads} | Budget total=${Math.round(totalBudget)} DA | D√©penses=${Math.round(totalSpent)} DA
Top campagnes (par ROI):
${topCampaigns}

Personas: ${(Array.isArray(personas) ? personas : []).length}
${topPersonas}

Contenu: ${(Array.isArray(content) ? content : []).length}
${topContent}

Business:
- Model: ${businessSafe.model || 'Non d√©fini'}
- LTV: ${businessSafe.ltv || 0}
- Churn: ${(businessSafe.churn || 0)}%
- MRR: ${businessSafe.mrr || 0}
- Objectifs (top):
${topObjectives}
---
`;
            const dataSnapshotEn = `
---
AVAILABLE MARKETING DATA (snapshot):

Campaigns: ${list.length}
KPIs: CAC=${cac} DA | Avg ROI=${avgRoi}% | Leads=${totalLeads} | Total Budget=${Math.round(totalBudget)} DA | Spent=${Math.round(totalSpent)} DA
Top campaigns (by ROI):
${topCampaigns}

Personas: ${(Array.isArray(personas) ? personas : []).length}
${topPersonas}

Content: ${(Array.isArray(content) ? content : []).length}
${topContent}

Business:
- Model: ${businessSafe.model || 'Undefined'}
- LTV: ${businessSafe.ltv || 0}
- Churn: ${(businessSafe.churn || 0)}%
- MRR: ${businessSafe.mrr || 0}
- Objectives (top):
${topObjectives}
---
`;

            const dataSnapshot = isEn ? dataSnapshotEn : dataSnapshotFr;

            if (mode === 'summary') {
                return truncateText(`${constraints}${moduleDoc}${dataSnapshot}`, 6000);
            }
            return truncateText(`${constraints}${moduleDoc}${dataSnapshot}`, 12000);
        }

        function getExcelModuleDataFromStorage() {
            const savedWorkbooks = safeJsonParse(localStorage.getItem('excelWorkbooks') || '[]', []);
            const workbooks = Array.isArray(savedWorkbooks) ? savedWorkbooks : [];

            // Ces variables existent dans le module Excel AI (m√™me fichier).
            // On les lit prudemment pour √©viter toute erreur si non initialis√©es.
            let currentName = '';
            let columns = [];
            let rows = [];
            try { currentName = (typeof excelCurrentFile !== 'undefined' && excelCurrentFile && excelCurrentFile.name) ? String(excelCurrentFile.name) : ''; } catch (_) {}
            try { columns = (typeof excelColumns !== 'undefined' && Array.isArray(excelColumns)) ? excelColumns : []; } catch (_) { columns = []; }
            try { rows = (typeof excelSheetData !== 'undefined' && Array.isArray(excelSheetData)) ? excelSheetData : []; } catch (_) { rows = []; }

            return {
                savedWorkbooks: workbooks,
                currentWorkbook: {
                    name: currentName,
                    columns: Array.isArray(columns) ? columns : [],
                    rows: Array.isArray(rows) ? rows : []
                }
            };
        }

        function buildAgentExcelContext({ mode = 'summary', savedWorkbooks = [], currentWorkbook = null } = {}) {
            const wbs = Array.isArray(savedWorkbooks) ? savedWorkbooks : [];
            const cw = currentWorkbook && typeof currentWorkbook === 'object' ? currentWorkbook : { name: '', columns: [], rows: [] };

            const colList = Array.isArray(cw.columns) ? cw.columns : [];
            const rowList = Array.isArray(cw.rows) ? cw.rows : [];

            const previewCols = colList.slice(0, 25);
            const previewRows = rowList.slice(0, 8);

            const safeRowToLine = (row) => {
                if (!Array.isArray(row)) return '';
                return row.slice(0, 25).map(v => String(v ?? '')).join(' | ');
            };

            const dataPreview = previewRows.length
                ? previewRows.map(safeRowToLine).join('\n')
                : 'Aucune donn√©e charg√©e';

            const topSaved = wbs
                .slice()
                .sort((a, b) => String(b?.savedAt || '').localeCompare(String(a?.savedAt || '')))
                .slice(0, 5)
                .map(wb => {
                    const name = wb?.name || 'Classeur';
                    const lines = Array.isArray(wb?.data) ? wb.data.length : 0;
                    const cols = Array.isArray(wb?.columns) ? wb.columns.length : 0;
                    const when = wb?.savedAt ? ` | Sauvegard√©: ${wb.savedAt}` : '';
                    return `- ${name} | Lignes: ${lines} | Colonnes: ${cols}${when}`;
                }).join('\n') || 'Aucun classeur sauvegard√©';

            const constraints = `
[Contraintes produit]
- Ne mentionne pas d'autres modules/agents/outils sauf si l'utilisateur le demande explicitement
- N'invente jamais les donn√©es d'un classeur: utilise uniquement le contexte ci-dessous
- Si aucun classeur n'est charg√©, demande √† l'utilisateur d'en importer un ou d'en cr√©er un vide
`;

            const moduleDoc = `
=== TU ES AGENT XCEL ‚Äî AXILUM EXCEL AI EXPERT ===

Ce module Excel (dans l'app) permet notamment:
- Charger/√©diter un classeur (colonnes, lignes) et visualiser un aper√ßu
- Actions rapides (ex: clean, duplicates, kpi, formulas, charts selon l'UI)
- Sauvegarder des classeurs dans le navigateur (localStorage) et les recharger

Stockage local utilis√© par le module:
- excelWorkbooks (liste des classeurs sauvegard√©s)
`;

            const snapshot = `
---
DONN√âES EXCEL DISPONIBLES (snapshot):

Classeur courant:
- Nom: ${cw.name || 'Aucun'}
- Colonnes: ${colList.length} (${previewCols.join(', ') || 'N/A'})
- Lignes: ${rowList.length}

Aper√ßu donn√©es (premi√®res lignes):
${dataPreview}

Classeurs sauvegard√©s: ${wbs.length}
Top r√©cents:
${topSaved}
---
`;

            if (mode === 'summary') {
                return truncateText(`${constraints}${moduleDoc}${snapshot}`, 6000);
            }
            return truncateText(`${constraints}${moduleDoc}${snapshot}`, 12000);
        }

        function getTodoModuleDataFromStorage() {
            const tasks = safeJsonParse(localStorage.getItem(getTodoTasksStorageKey()) || localStorage.getItem('userTasks') || '[]', []);
            const events = safeJsonParse(localStorage.getItem('userEvents') || '[]', []);
            const projects = safeJsonParse(localStorage.getItem('userProjects') || '[]', []);
            const notificationSettings = safeJsonParse(localStorage.getItem('notificationSettings') || '{"enabled": false, "reminderMinutes": 15}', { enabled: false, reminderMinutes: 15 });
            const todoNotificationsEnabled = (localStorage.getItem('todoNotificationsEnabled') === 'true');
            const currentUser = safeJsonParse(localStorage.getItem('currentUser') || 'null', null);

            return {
                tasks: Array.isArray(tasks) ? tasks : [],
                events: Array.isArray(events) ? events : [],
                projects: Array.isArray(projects) ? projects : [],
                notificationSettings: (notificationSettings && typeof notificationSettings === 'object') ? notificationSettings : { enabled: false, reminderMinutes: 15 },
                todoNotificationsEnabled,
                currentUser: (currentUser && typeof currentUser === 'object') ? currentUser : null
            };
        }

        function buildAgentTodoContext({ mode = 'summary', tasks = [], projects = [], events = [], notificationSettings = {}, todoNotificationsEnabled = false, currentUser = null } = {}) {
            const lang = getAppLanguage();
            const isEn = lang === 'en';
            const safeArr = (v) => Array.isArray(v) ? v : [];
            const safeObj = (v) => (v && typeof v === 'object') ? v : {};
            const listTasks = safeArr(tasks);
            const listProjects = safeArr(projects);
            const listEvents = safeArr(events);
            const settings = safeObj(notificationSettings);

            const userEmail = currentUser?.email ? String(currentUser.email) : '';
            const scopedTasks = userEmail
                ? listTasks.filter(t => !t?.userId || String(t.userId) === userEmail)
                : listTasks;

            const now = new Date();
            const today = now.toISOString().split('T')[0];

            const isCompleted = (t) => Boolean(t && t.completed);
            const parseDate = (d) => {
                if (!d) return null;
                const dt = new Date(d);
                return Number.isFinite(dt.getTime()) ? dt : null;
            };

            const activeTasks = scopedTasks.filter(t => !isCompleted(t));
            const completedTasks = scopedTasks.filter(t => isCompleted(t));

            const dueToday = activeTasks.filter(t => {
                const dt = parseDate(t?.dueDate);
                if (!dt) return false;
                return dt.toISOString().split('T')[0] === today;
            });

            const overdue = activeTasks.filter(t => {
                const dt = parseDate(t?.dueDate);
                if (!dt) return false;
                const iso = dt.toISOString().split('T')[0];
                return iso < today;
            });

            const by = (arr, key) => {
                const out = {};
                safeArr(arr).forEach(x => {
                    const k = x && x[key] ? String(x[key]) : 'unknown';
                    out[k] = (out[k] || 0) + 1;
                });
                return out;
            };

            const byPriority = by(activeTasks, 'priority');
            const byCategory = by(activeTasks, 'category');

            const sortByDue = (a, b) => {
                const da = parseDate(a?.dueDate);
                const db = parseDate(b?.dueDate);
                if (da && db) return da.getTime() - db.getTime();
                if (da) return -1;
                if (db) return 1;
                return 0;
            };

            const topUpcoming = activeTasks
                .slice()
                .sort(sortByDue)
                .slice(0, 8)
                .map(t => {
                    const title = t?.title || (isEn ? 'Task' : 'T√¢che');
                    const due = t?.dueDate ? ` | ${isEn ? 'Due' : '√âch√©ance'}: ${t.dueDate}` : '';
                    const prio = t?.priority ? ` | ${isEn ? 'Priority' : 'Priorit√©'}: ${t.priority}` : '';
                    const cat = t?.category ? ` | ${isEn ? 'Category' : 'Cat√©gorie'}: ${t.category}` : '';
                    const proj = t?.projectId != null ? ` | ${isEn ? 'Project' : 'Projet'}: ${t.projectId}` : '';
                    const prog = (typeof t?.progress === 'number') ? ` | ${isEn ? 'Progress' : 'Progress'}: ${t.progress}%` : '';
                    return `- ${title}${due}${prio}${cat}${proj}${prog}`;
                }).join('\n') || (isEn ? 'No active tasks' : 'Aucune t√¢che active');

            const topProjects = listProjects
                .slice(0, 5)
                .map(p => {
                    const name = p?.name || p?.title || (isEn ? 'Project' : 'Projet');
                    const progress = (typeof p?.progress === 'number') ? ` | ${isEn ? 'Progress' : 'Progress'}: ${p.progress}%` : '';
                    const total = (typeof p?.totalTasks === 'number') ? ` | ${isEn ? 'Total tasks' : 'Total t√¢ches'}: ${p.totalTasks}` : '';
                    return `- ${name}${progress}${total}`;
                }).join('\n') || (isEn ? 'No projects' : 'Aucun projet');

            const nextEvents = listEvents
                .slice()
                .filter(e => parseDate(e?.date))
                .sort((a, b) => parseDate(a?.date).getTime() - parseDate(b?.date).getTime())
                .slice(0, 5)
                .map(e => {
                    const title = e?.title || (isEn ? 'Event' : '√âv√©nement');
                    const date = e?.date ? ` | ${isEn ? 'Date' : 'Date'}: ${e.date}` : '';
                    return `- ${title}${date}`;
                }).join('\n') || (isEn ? 'No events' : 'Aucun √©v√©nement');

            const constraints = isEn
                ? `
[Product constraints]
- Do not claim you can execute UI actions automatically
- Never invent tasks/projects/events: use only the snapshot below
- If information is missing (title, due date, priority, category, project), ask 1-3 targeted questions and ask the user to add/complete those details in AI Task for a more accurate plan
- Read-only advisory mode: you cannot move tasks between To do / In progress / Done, nor rename tasks; propose suggestions and let the user do the UI action.
`
                : `
[Contraintes produit]
- Ne pr√©tends pas ex√©cuter des actions automatiquement dans l'UI
- N'invente jamais des t√¢ches/projets/√©v√©nements: utilise uniquement le snapshot ci-dessous
- Si une info manque (titre, √©ch√©ance, priorit√©, cat√©gorie, projet), pose 1-3 questions cibl√©es et demande √† l'utilisateur de compl√©ter ces infos dans AI Task pour un planning plus pr√©cis
- Mode conseil (lecture seule): tu ne peux pas d√©placer les t√¢ches entre √Ä faire / En cours / Termin√© ni renommer les t√¢ches; propose et laisse l'utilisateur faire l'action UI.
`;

            const moduleDoc = isEn
                ? `
=== YOU ARE TODO AGENT ‚Äî AXILUM AI TASK (CALENDAR, TASKS, PLANNING) ===

This AI Task module (in-app) covers:
- Task management (create, complete, delete)
- Projects (group tasks, progress)
- Calendar / events (depending on UI)

Local storage (browser / localStorage) used by the module:
- userTasks, userProjects, userEvents
- notificationSettings, todoNotificationsEnabled

Existing UI actions (explain to the user if asked):
- Add a task (addTask)
- Mark completed (completeTask)
- Delete (deleteTask)
- Move tasks across columns is done by the user in the UI; you can only advise.
`
                : `
=== TU ES AGENT TODO ‚Äî AXILUM AI TASK (CALENDRIER, T√ÇCHES, PLANNING) ===

Ce module AI Task (dans l'app) couvre notamment:
- Gestion des t√¢ches (cr√©ation, compl√©tion, suppression)
- Projets (regrouper des t√¢ches, progression)
- Calendrier / √©v√©nements (selon l'UI)

Stockage local (navigateur / localStorage) utilis√© par le module:
- userTasks, userProjects, userEvents
- notificationSettings, todoNotificationsEnabled

Actions UI existantes (√† expliquer √† l'utilisateur si demand√©):
- Ajouter une t√¢che (addTask)
- Marquer termin√©e (completeTask)
- Supprimer (deleteTask)
- Le d√©placement entre colonnes est fait par l'utilisateur dans l'UI; tu ne fais que conseiller.
`;

            const snapshot = isEn
                ? `
---
TODO DATA AVAILABLE (snapshot):

User: ${userEmail || 'N/A'}

Tasks (user scope): total=${scopedTasks.length} | active=${activeTasks.length} | completed=${completedTasks.length}
Due dates: today=${dueToday.length} | overdue=${overdue.length}
Active breakdown: priority=${JSON.stringify(byPriority)} | category=${JSON.stringify(byCategory)}

Top upcoming tasks:
${topUpcoming}

Projects: ${listProjects.length}
${topProjects}

Events: ${listEvents.length}
${nextEvents}

Notifications:
- todoNotificationsEnabled=${todoNotificationsEnabled ? 'true' : 'false'}
- notificationSettings.enabled=${settings.enabled ? 'true' : 'false'}
- reminderMinutes=${settings.reminderMinutes != null ? settings.reminderMinutes : 'N/A'}
---
`
                : `
---
DONN√âES TODO DISPONIBLES (snapshot):

Utilisateur: ${userEmail || 'N/A'}

T√¢ches (scope utilisateur): total=${scopedTasks.length} | actives=${activeTasks.length} | termin√©es=${completedTasks.length}
√âch√©ances: aujourd'hui=${dueToday.length} | en retard=${overdue.length}
R√©partition actives: priorit√©=${JSON.stringify(byPriority)} | cat√©gorie=${JSON.stringify(byCategory)}

Top t√¢ches √† venir:
${topUpcoming}

Projets: ${listProjects.length}
${topProjects}

√âv√©nements: ${listEvents.length}
${nextEvents}

Notifications:
- todoNotificationsEnabled=${todoNotificationsEnabled ? 'true' : 'false'}
- notificationSettings.enabled=${settings.enabled ? 'true' : 'false'}
- reminderMinutes=${settings.reminderMinutes != null ? settings.reminderMinutes : 'N/A'}
---
`;

            if (mode === 'summary') {
                return truncateText(`${constraints}${moduleDoc}${snapshot}`, 6000);
            }
            return truncateText(`${constraints}${moduleDoc}${snapshot}`, 12000);
        }

        function getFinanceModuleDataFromStorage() {
            const financeData = safeJsonParse(localStorage.getItem('axilum_finance_data') || '{}', {});
            const conversationsObj = (typeof financeConversationsCache !== 'undefined') ? financeConversationsCache : safeJsonParse(localStorage.getItem('financeConversations') || '{}' , {});
            const conversations = (conversationsObj && typeof conversationsObj === 'object') ? Object.values(conversationsObj) : [];

            // R√©cup√©rer un snapshot runtime si le module Finance a d√©j√† √©t√© initialis√©
            let runtimeContext = null;
            try {
                if (typeof financeContext !== 'undefined' && financeContext && typeof financeContext === 'object') {
                    runtimeContext = financeContext;
                }
            } catch (_) {
                runtimeContext = null;
            }

            // Agr√©ger invoices/reports depuis les conversations sauvegard√©es
            const invoices = [];
            const reports = [];
            const budgets = [];
            const kpis = [];

            (Array.isArray(conversations) ? conversations : []).forEach(conv => {
                const ctx = conv?.context && typeof conv.context === 'object' ? conv.context : null;
                if (!ctx) return;
                if (Array.isArray(ctx.invoices)) invoices.push(...ctx.invoices);
                if (Array.isArray(ctx.reports)) reports.push(...ctx.reports);
                if (Array.isArray(ctx.budgets)) budgets.push(...ctx.budgets);
                if (ctx.kpis && typeof ctx.kpis === 'object') kpis.push(ctx.kpis);
            });

            // Compl√©ter avec runtime si pr√©sent
            if (runtimeContext) {
                if (Array.isArray(runtimeContext.invoices)) invoices.push(...runtimeContext.invoices);
                if (Array.isArray(runtimeContext.reports)) reports.push(...runtimeContext.reports);
                if (Array.isArray(runtimeContext.budgets)) budgets.push(...runtimeContext.budgets);
                if (runtimeContext.kpis && typeof runtimeContext.kpis === 'object') kpis.push(runtimeContext.kpis);
            }

            // D√©dupliquer grossi√®rement les factures (vendor+amount+date+invoiceNumber)
            const seen = new Set();
            const uniqInvoices = [];
            invoices.forEach(inv => {
                if (!inv || typeof inv !== 'object') return;
                const key = [inv.vendor, inv.amount, inv.date, inv.invoiceNumber, inv.filename].map(v => String(v ?? '').trim()).join('|');
                if (seen.has(key)) return;
                seen.add(key);
                uniqInvoices.push(inv);
            });

            // Derni√®re facture (runtime prioritaire)
            let lastInvoice = null;
            if (runtimeContext && runtimeContext.lastInvoice) {
                lastInvoice = runtimeContext.lastInvoice;
            } else {
                // Sinon, prendre la facture la plus r√©cente selon extractedAt/createdAt/date
                lastInvoice = uniqInvoices
                    .slice()
                    .sort((a, b) => String(b?.extractedAt || b?.createdAt || b?.date || '').localeCompare(String(a?.extractedAt || a?.createdAt || a?.date || '')))[0] || null;
            }

            const companySettings = (runtimeContext?.companySettings && typeof runtimeContext.companySettings === 'object')
                ? runtimeContext.companySettings
                : ((financeData && typeof financeData.companySettings === 'object') ? financeData.companySettings : null);

            return {
                companySettings,
                financeDataLastUpdated: financeData?.lastUpdated || null,
                conversationsCount: (Array.isArray(conversations) ? conversations.length : 0),
                invoices: uniqInvoices,
                reports: Array.isArray(reports) ? reports : [],
                budgets: Array.isArray(budgets) ? budgets : [],
                kpis: kpis.length ? kpis[kpis.length - 1] : null,
                lastInvoice
            };
        }

        function buildAgentFinanceContext({ mode = 'summary', companySettings = null, invoices = [], reports = [], budgets = [], kpis = null, lastInvoice = null, financeDataLastUpdated = null, conversationsCount = 0 } = {}) {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const invs = Array.isArray(invoices) ? invoices : [];
            const reps = Array.isArray(reports) ? reports : [];
            const buds = Array.isArray(budgets) ? budgets : [];
            const cs = (companySettings && typeof companySettings === 'object') ? companySettings : {};

            const safeNum = (v) => (typeof v === 'number' && Number.isFinite(v)) ? v : (parseFloat(v) || 0);
            const currency = cs.currency || 'EUR';

            const typeField = (inv) => String(inv?.type || inv?.invoiceType || inv?.transactionType?.type || '').toLowerCase();
            const isIncome = (inv) => ['income', 'revenue', 'vente'].includes(typeField(inv));
            const isExpense = (inv) => ['expense', 'charge', 'achat'].includes(typeField(inv));

            const totalRevenue = invs.filter(isIncome).reduce((s, i) => s + safeNum(i?.amount), 0);
            const totalExpenses = invs.filter(isExpense).reduce((s, i) => s + safeNum(i?.amount), 0);
            const netIncome = totalRevenue - totalExpenses;

            const isEn = (lang === 'en');

            const topInvoices = invs
                .slice()
                .sort((a, b) => String(b?.extractedAt || b?.createdAt || b?.date || '').localeCompare(String(a?.extractedAt || a?.createdAt || a?.date || '')))
                .slice(0, 6)
                .map(inv => {
                    const vendor = inv?.vendor || inv?.supplier || inv?.client || 'N/A';
                    const amount = inv?.amount != null ? safeNum(inv.amount) : 0;
                    const date = inv?.date ? (isEn ? ` | Date: ${inv.date}` : ` | Date: ${inv.date}`) : '';
                    const num = inv?.invoiceNumber ? (isEn ? ` | N¬∞: ${inv.invoiceNumber}` : ` | N¬∞: ${inv.invoiceNumber}`) : '';
                    const t = typeField(inv) ? (isEn ? ` | Type: ${typeField(inv)}` : ` | Type: ${typeField(inv)}`) : '';
                    const dup = inv?.isDuplicate ? (isEn ? ' | ‚ö†Ô∏è Duplicate' : ' | ‚ö†Ô∏è Doublon') : '';
                    
                    const lblAmount = isEn ? 'Amount' : 'Montant';
                    return `- ${vendor} | ${lblAmount}: ${amount} ${inv?.currency || currency}${date}${num}${t}${dup}`;
                }).join('\n') || (isEn ? 'No invoices' : 'Aucune facture');

            const topReports = reps
                .slice()
                .sort((a, b) => String(b?.createdAt || b?.generatedAt || '').localeCompare(String(a?.createdAt || a?.generatedAt || '')))
                .slice(0, 4)
                .map(r => {
                    const title = r?.title || r?.name || r?.type || (isEn ? 'Report' : 'Rapport');
                    const period = r?.period ? (isEn ? ` | Period: ${r.period}` : ` | P√©riode: ${r.period}`) : '';
                    const created = r?.createdAt ? (isEn ? ` | Created: ${r.createdAt}` : ` | Cr√©√©: ${r.createdAt}`) : '';
                    return `- ${title}${period}${created}`;
                }).join('\n') || (isEn ? 'No reports' : 'Aucun rapport');

            const constraintsFr = `
[Contraintes produit]
- Ne pr√©tends pas ex√©cuter des actions automatiquement dans l'UI
- Quand tu fais r√©f√©rence √† l'outil, utilise toujours le nom exact: ¬´ Module Finance & Compta (Agent Alex) ¬ª
- N'invente jamais des donn√©es financi√®res (factures/rapports/budgets): utilise uniquement le snapshot ci-dessous
- Si une info manque (p√©riode, devise, type, montant), pose 1-3 questions cibl√©es; puis oriente l'utilisateur vers le ¬´ Module Finance & Compta (Agent Alex) ¬ª pour ajouter/compl√©ter les donn√©es et obtenir un rapport optimis√© et pr√©cis
`;

            const constraintsEn = `
[Product constraints]
- Do not claim you can execute actions automatically in the UI
- When you refer to the tool, always use the exact name: ¬´ Module Finance & Compta (Agent Alex) ¬ª
- Never invent financial data (invoices/reports/budgets): use only the snapshot below
- If information is missing (period, currency, type, amount), ask 1‚Äì3 targeted questions; then direct the user to ¬´ Module Finance & Compta (Agent Alex) ¬ª to add/complete data and get an accurate report
- Language: respond in English only
`;

            const moduleDocFr = `
=== TU ES AGENT FINANCE ‚Äî AXILUM FINANCE & ACCOUNTING HUB ===

Nom de l'outil √† afficher √† l'utilisateur: Module Finance & Compta (Agent Alex)

Ce module Finance (dans l'app) couvre notamment:
- Import/OCR de factures + extraction (fournisseur, montant, date, num√©ro)
- D√©tection de doublons
- Analyses (revenus/charges, r√©sultat net) et rapports
- Param√®tres entreprise (devise, infos soci√©t√©)

Stockage local (navigateur / localStorage) utilis√© par le module:
- axilum_finance_data (companySettings)
- financeConversations (historique + context incluant invoices/reports)
`;

            const moduleDocEn = `
=== YOU ARE FINANCE AGENT ‚Äî AXILUM FINANCE & ACCOUNTING HUB ===

Tool name to show to the user: Module Finance & Compta (Agent Alex)

This Finance module (in the app) covers:
- Invoice import/OCR + extraction (vendor, amount, date, invoice number)
- Duplicate detection
- Analyses (revenue/expenses, net income) and reports
- Company settings (currency, company details)

Local storage (browser / localStorage) used by the module:
- axilum_finance_data (companySettings)
- financeConversations (history + context incl. invoices/reports)
`;

            const constraints = (lang === 'en') ? constraintsEn : constraintsFr;
            const moduleDoc = (lang === 'en') ? moduleDocEn : moduleDocFr;

            const lastInv = (lastInvoice && typeof lastInvoice === 'object') ? lastInvoice : null;
            const lastInvBlockFr = lastInv ? `
Derni√®re facture (si disponible):
- Fournisseur: ${lastInv.vendor || lastInv.supplier || lastInv.client || 'N/A'}
- Montant: ${safeNum(lastInv.amount)} ${lastInv.currency || currency}
- Date: ${lastInv.date || 'N/A'}
- Num√©ro: ${lastInv.invoiceNumber || 'N/A'}
` : '\nDerni√®re facture: N/A\n';

            const lastInvBlockEn = lastInv ? `
Latest invoice (if available):
- Vendor: ${lastInv.vendor || lastInv.supplier || lastInv.client || 'N/A'}
- Amount: ${safeNum(lastInv.amount)} ${lastInv.currency || currency}
- Date: ${lastInv.date || 'N/A'}
- Number: ${lastInv.invoiceNumber || 'N/A'}
` : '\nLatest invoice: N/A\n';

            const snapshotFr = `
---
DONN√âES FINANCE DISPONIBLES (snapshot):

Entreprise (settings):
- Nom: ${cs.name || 'N/A'}
- Activit√©: ${cs.activity || 'N/A'}
- Devise: ${currency}
- Email: ${cs.email || 'N/A'}
- T√©l: ${cs.phone || 'N/A'}
- Derni√®re MAJ settings: ${financeDataLastUpdated || 'N/A'}

Conversations sauvegard√©es: ${conversationsCount}

Factures: ${invs.length}
Synth√®se: revenus=${totalRevenue.toFixed(2)} ${currency} | charges=${totalExpenses.toFixed(2)} ${currency} | r√©sultat=${netIncome.toFixed(2)} ${currency}

Factures r√©centes:
${topInvoices}

Rapports: ${reps.length}
${topReports}

Budgets: ${buds.length}

KPIs (si disponibles): ${kpis ? JSON.stringify(kpis) : 'N/A'}

${lastInvBlockFr}
---
`;

            const snapshotEn = `
---
AVAILABLE FINANCE DATA (snapshot):

Company (settings):
- Name: ${cs.name || 'N/A'}
- Activity: ${cs.activity || 'N/A'}
- Currency: ${currency}
- Email: ${cs.email || 'N/A'}
- Phone: ${cs.phone || 'N/A'}
- Last settings update: ${financeDataLastUpdated || 'N/A'}

Saved conversations: ${conversationsCount}

Invoices: ${invs.length}
Summary: revenue=${totalRevenue.toFixed(2)} ${currency} | expenses=${totalExpenses.toFixed(2)} ${currency} | net=${netIncome.toFixed(2)} ${currency}

Recent invoices:
${topInvoices}

Reports: ${reps.length}
${topReports}

Budgets: ${buds.length}

KPIs (if available): ${kpis ? JSON.stringify(kpis) : 'N/A'}

${lastInvBlockEn}
---
`;

            const snapshot = (lang === 'en') ? snapshotEn : snapshotFr;

            if (mode === 'summary') {
                return truncateText(`${constraints}${moduleDoc}${snapshot}`, 6000);
            }
            return truncateText(`${constraints}${moduleDoc}${snapshot}`, 12000);
        }

        function getTextProModuleDataFromStorage() {
            const lastText = String(localStorage.getItem('textPro_lastText') || '');
            const lastUpdated = localStorage.getItem('textPro_lastUpdated') || null;
            const lastFileName = String(localStorage.getItem('textPro_lastFileName') || '');

            // Essayez de lire l'√©tat courant de l'overlay si ouvert (fallback legacy)
            let currentText = '';
            let currentFileName = '';
            try {
                const textarea = document.getElementById('textProTextarea');
                if (textarea && typeof textarea.value === 'string') currentText = textarea.value;
            } catch (_) {
                currentText = '';
            }
            try {
                const fileNameDiv = document.getElementById('textProFileName');
                if (fileNameDiv && typeof fileNameDiv.textContent === 'string') currentFileName = fileNameDiv.textContent;
            } catch (_) {
                currentFileName = '';
            }

            return {
                lastText,
                lastUpdated,
                lastFileName,
                currentText,
                currentFileName
            };
        }

        function buildAgentTonyContext({ mode = 'summary', lastText = '', lastUpdated = null, lastFileName = '', currentText = '', currentFileName = '' } = {}) {
            const safeStr = (v) => (typeof v === 'string') ? v : String(v ?? '');
            const text = safeStr(currentText).trim() || safeStr(lastText).trim();
            const source = safeStr(currentText).trim() ? 'overlay Text Pro (en cours)' : (safeStr(lastText).trim() ? 'dernier texte (persist√©)' : 'N/A');
            const fileName = safeStr(currentFileName).trim() || safeStr(lastFileName).trim() || 'N/A';
            const updatedAt = lastUpdated ? String(lastUpdated) : 'N/A';
            const preview = text ? truncateText(text, 3500) : '';

            const constraints = `
[Contraintes produit]
- Ne mentionne pas d'autres modules/agents/outils sauf si l'utilisateur le demande explicitement
- N'invente jamais le contenu d'un document/texte: utilise uniquement le texte fourni ci-dessous
- Si une info manque, pose 1-3 questions cibl√©es (ex: langue cible, ton, audience, format de sortie)
`;

            const moduleDoc = `
=== TU ES AGENT TONY ‚Äî AXILUM AI TEXT PRO ===

Ce module AI Text Pro (dans l'app) couvre notamment:
- Traduction professionnelle
- R√©√©criture / reformulation
- Correction orthographe/grammaire + am√©lioration du style
- R√©sum√©, extraction de points cl√©s, transformation de format

Remarque: le module Text Pro envoie le texte vers le chat principal pour traitement.
Stockage local (navigateur / localStorage) utilis√© pour l'alignement:
- textPro_lastText, textPro_lastUpdated, textPro_lastFileName
`;

            const snapshot = `
---
DONN√âES TEXT PRO DISPONIBLES (snapshot):

Source: ${source}
Fichier: ${fileName}
Derni√®re MAJ: ${updatedAt}
Longueur texte: ${text ? text.length : 0} caract√®res

Texte (aper√ßu):
${preview || 'Aucun texte disponible'}
---
`;

            if (mode === 'summary') {
                return truncateText(`${constraints}${moduleDoc}${snapshot}`, 6000);
            }
            return truncateText(`${constraints}${moduleDoc}${snapshot}`, 12000);
        }

        function getWebSearchModuleDataFromStorage() {
            const lastQuery = String(localStorage.getItem('webSearch_lastQuery') || '');
            const lastResponse = String(localStorage.getItem('webSearch_lastResponse') || '');
            const lastUpdated = localStorage.getItem('webSearch_lastUpdated') || null;
            const sources = safeJsonParse(localStorage.getItem('webSearch_lastSources') || '[]', []);

            return {
                lastQuery,
                lastResponse,
                lastUpdated,
                sources: Array.isArray(sources) ? sources : []
            };
        }

        function buildAgentWebSearchContext({ mode = 'summary', lastQuery = '', lastResponse = '', lastUpdated = null, sources = [] } = {}) {
            const safeStr = (v) => (typeof v === 'string') ? v : String(v ?? '');
            const q = safeStr(lastQuery).trim();
            const r = safeStr(lastResponse).trim();
            const when = lastUpdated ? String(lastUpdated) : 'N/A';
            const listSources = Array.isArray(sources) ? sources : [];
            const topSources = listSources.slice(0, 6).map((s, idx) => {
                const title = s && s.title ? String(s.title) : 'Source';
                const url = s && s.url ? String(s.url) : '';
                return `- ${idx + 1}. ${title}${url ? ` (${url})` : ''}`;
            }).join('\n') || 'N/A';

            const constraints = `
[Contraintes produit]
- Quand tu fais r√©f√©rence √† l'outil, utilise toujours le nom exact: ¬´ Recherche web (Agent Wesh) ¬ª
- Appuie-toi d'abord sur le "Contexte de recherche web" (si pr√©sent)
- N'invente jamais des faits: si une info manque, pose 1-3 questions cibl√©es (pays, p√©riode, contexte)
`;

            const moduleDoc = `
=== TU ES AGENT WESH ‚Äî AXILUM WEB SEARCH ===

Ce mode (/agent web) sert √† obtenir des informations √† jour via recherche web.
Le backend peut fournir un bloc "Contexte de recherche web" (√† utiliser en priorit√©).

Stockage local (navigateur / localStorage) utilis√© pour l'alignement (suivi minimal):
- webSearch_lastQuery, webSearch_lastResponse, webSearch_lastUpdated, webSearch_lastSources
`;

            const snapshot = `
---
HISTORIQUE WEB SEARCH (snapshot):

Derni√®re requ√™te: ${q || 'N/A'}
Derni√®re MAJ: ${when}
Sources (top):
${topSources}

Derni√®re r√©ponse (aper√ßu):
${r ? truncateText(r, 3500) : 'N/A'}
---
`;

            if (mode === 'summary') {
                return truncateText(`${constraints}${moduleDoc}${snapshot}`, 6000);
            }
            return truncateText(`${constraints}${moduleDoc}${snapshot}`, 12000);
        }

        function buildAgentDevRnDContext({ mode = 'full', projects = [], milestones = [], documents = [], risks = [] } = {}) {
            const activeProjects = projects.filter(p => p && p.statut === 'actif');
            const upcomingMilestones = milestones
                .filter(m => m && m.date && new Date(m.date) >= new Date() && m.statut !== 'compl√©t√©');
            const activeRisks = risks.filter(r => r && r.statut === 'actif');

            const persona = `
=== TU ES AGENT DEV - COACH INNOVATION MULTI-DOMAINES ===

IDENTIT√â :
Tu es Agent Dev, expert en innovation et R&D tous domaines confondus.
Tu accompagnes les utilisateurs dans leurs projets d'innovation, quel que soit le secteur.

DOMAINES D'EXPERTISE :
- Technologie & Digital (IA, IoT, Cloud, Cybers√©curit√©)
- Sant√© & Biotechnologie (T√©l√©m√©decine, biotech, dispositifs m√©dicaux)
- √âducation & Formation (E-learning, EdTech, p√©dagogie innovante)
- Agriculture & Agroalimentaire (Smart farming, AgTech, food-tech)
- Environnement & D√©veloppement Durable (√ânergies renouvelables, √©conomie circulaire)
- Business & Entrepreneuriat (Nouveaux mod√®les, start-ups, innovation business)
- Arts & Culture (Cr√©ation artistique, industries cr√©atives)
- Sciences & Recherche (Recherche fondamentale et appliqu√©e)
- √ânergie & Infrastructure (Smart grids, mobilit√© durable)
- Social & Impact (Inclusion, innovation sociale)

M√âTHODOLOGIE :
Tu guides √† travers 5 phases d'innovation :
1. D√©couverte : Identifier le probl√®me/opportunit√©
2. Id√©ation : G√©n√©rer des solutions cr√©atives
3. Exp√©rimentation : Cr√©er POC/MVP et tester
4. Validation : Mesurer l'impact et la viabilit√©
5. D√©ploiement : Lancer et scaler le projet

TON APPROCHE :
- Pragmatique et orient√© r√©sultats
- Cr√©atif dans les solutions propos√©es
- Adapte ton langage selon le domaine du projet
- Pose des questions pertinentes pour clarifier
- Donne des conseils actionnables
- Partage des best practices et exemples concrets

STYLE DE R√âPONSE :
- Professionnel mais accessible
- Structur√© et clair
- Encourage l'action et l'it√©ration rapide
- Anticipe les obstacles et propose des solutions
`;

            if (mode === 'summary') {
                const topProjects = activeProjects.slice(0, 3).map(p => {
                    const title = p.titre || 'Sans titre';
                    const domain = p.domaine || 'N/A';
                    const phase = p.phase || 'N/A';
                    const progress = (typeof p.avancement === 'number') ? `${p.avancement}%` : 'N/A';
                    return `- ${title} | Domaine: ${domain} | Phase: ${phase} | Avancement: ${progress}`;
                }).join('\n') || 'Aucun projet actif';

                const nextMilestones = upcomingMilestones.slice(0, 3).map(m => {
                    const project = projects.find(p => p && p.id === m.projectId);
                    const dateStr = m.date ? new Date(m.date).toLocaleDateString(getLocale()) : 'N/A';
                    return `- ${m.titre || 'Sans titre'} (${dateStr}) - Projet: ${project?.titre || 'N/A'}`;
                }).join('\n') || 'Aucun jalon √† venir';

                const topRisks = activeRisks.slice(0, 3).map(r => {
                    const project = projects.find(p => p && p.id === r.projectId);
                    const criticite = r.criticite || 'N/A';
                    const impact = (typeof r.impact === 'number') ? `${r.impact}%` : 'N/A';
                    return `- ${r.titre || 'Sans titre'} (${criticite}) - Impact: ${impact} - Projet: ${project?.titre || 'N/A'}`;
                }).join('\n') || 'Aucun risque actif';

                const summary = `
CONTEXTE R&D (SYNTH√àSE) :

PROJETS R&D ACTIFS (${activeProjects.length}/${projects.length} total) :
${topProjects}

JALONS √Ä VENIR (${upcomingMilestones.length}) :
${nextMilestones}

RISQUES ACTIFS (${activeRisks.length}) :
${topRisks}

${persona}
`;

                return truncateText(summary, 6000);
            }

            const full = `
CONTEXTE R&D COMPLET :

PROJETS R&D ACTIFS (${activeProjects.length}/${projects.length} total) :
${activeProjects.length > 0 ? activeProjects.map(p => {
    const budgetPrevu = Number(p?.budget?.prevu ?? 0);
    const budgetDevise = p?.budget?.devise || '';
    const equipe = Array.isArray(p?.equipe) ? p.equipe.join(', ') : '';
    const techs = Array.isArray(p?.technologies) ? p.technologies.join(', ') : '';
    const created = p?.created ? new Date(p.created).toLocaleDateString(getLocale()) : 'N/A';
    return `\n- Projet "${p.titre}" (ID: ${p.id})\n  Domaine: ${p.domaine}\n  Phase: ${p.phase} (${p.avancement}%)\n  Budget: ${budgetPrevu.toLocaleString(getLocale())} ${budgetDevise}\n  √âquipe: ${equipe || 'Non d√©finie'}\n  Technologies: ${techs || 'Aucune'}\n  Dur√©e pr√©vue: ${p.duree} mois\n  Probl√®me: ${p.probleme}\n  Cr√©√© le: ${created}\n`;
}).join('\n') : 'Aucun projet actif'}

JALONS √Ä VENIR (${upcomingMilestones.length}) :
${upcomingMilestones.length > 0 ? upcomingMilestones.map(m => {
    const project = projects.find(p => p && p.id === m.projectId);
    return `- ${m.titre} (${new Date(m.date).toLocaleDateString(getLocale())}) - Projet: ${project?.titre || 'N/A'}`;
}).join('\n') : 'Aucun jalon √† venir'}

DOCUMENTS (${documents.length}) :
${documents.length > 0 ? documents.slice(0, 5).map(d => {
    const project = projects.find(p => p && p.id === d.projectId);
    return `- ${d.titre} (${d.type}) - Projet: ${project?.titre || 'N/A'}`;
}).join('\n') : 'Aucun document'}

RISQUES ACTIFS (${activeRisks.length}) :
${activeRisks.length > 0 ? activeRisks.map(r => {
    const project = projects.find(p => p && p.id === r.projectId);
    return `- ${r.titre} (${r.criticite}) - Impact: ${r.impact}% - Projet: ${project?.titre || 'N/A'}`;
}).join('\n') : 'Aucun risque actif'}

${persona}
`;

            return full;
        }

        function getQuotaLabelForPlan(plan) {
            const p = String(plan || '').toLowerCase();
            if (p === 'free') return '50';
            if (p === 'enterprise') return '5000';
            return '500';
        }

        async function refreshQuotaFromServer(plan) {
            const quotaValue = document.getElementById('quotaValue');
            const quotaIndicator = document.getElementById('quotaIndicator');
            if (!quotaValue) return;

            // placeholder (garde un rendu stable)
            quotaValue.textContent = '‚Ä¶';

            const p = String(plan || '').toLowerCase();
            const qs = new URLSearchParams({ feature: 'excel_chat', plan: p });

            const headers = {};
            try {
                const token = (typeof getAuthToken === 'function') ? getAuthToken() : null;
                if (token) headers['Authorization'] = `Bearer ${token}`;
            } catch (_) {}

            try {
                // 1) Cr√©dit pr√©pay√© (devise serveur) - priorit√©
                try {
                    const u = (typeof currentUser !== 'undefined' && currentUser)
                        ? (currentUser.email || currentUser.id)
                        : (typeof getTodoUserId === 'function' ? getTodoUserId() : 'guest');
                    const creditQs = new URLSearchParams();
                    if (u) creditQs.set('userId', String(u));
                    const cres = await fetch(`/api/me/credit?${creditQs.toString()}`, { method: 'GET', headers });
                    const cdata = await cres.json().catch(() => null);
                    if (cres.ok && cdata) {
                        const cur = 'USD';
                        const balance = (() => {
                            if (Number.isFinite(cdata.balanceAmount)) return Number(cdata.balanceAmount);
                            if (Number.isFinite(cdata.balance)) return Number(cdata.balance);
                            if (Number.isFinite(cdata.balanceEur)) return Number(cdata.balanceEur);
                            if (Number.isFinite(cdata.balanceCents)) return Number(cdata.balanceCents) / 100;
                            return null;
                        })();

                        if (Number.isFinite(balance)) {
                            const formatted = formatMoney(balance, cur);
                            const amountOnly = formatMoneyAmountOnly(balance);
                            quotaValue.textContent = amountOnly;
                            if (quotaIndicator) {
                                quotaIndicator.title = `Cr√©dit: ${formatted}`;
                            }
                            return;
                        }
                    }
                } catch (_) {}

                const res = await fetch(`/api/me/plan-quota?${qs.toString()}`, { method: 'GET', headers });
                const data = await res.json().catch(() => null);
                if (!res.ok || !data || !data.quota) throw new Error('bad_response');

                // Si l'utilisateur est authentifi√©, l'API renvoie le plan r√©el: on synchronise l'UI automatiquement.
                try {
                    if (data && data.authenticated && data.plan) {
                        const serverPlan = String(data.plan).toLowerCase();
                        const localPlan = String(currentPlan || '').toLowerCase();
                        if (serverPlan && serverPlan !== localPlan) {
                            if (!window.__axilumPlanSyncing) {
                                window.__axilumPlanSyncing = true;
                                switchToPlan(serverPlan);
                                window.__axilumPlanSyncing = false;
                            }
                        }
                    }
                } catch (_) {}

                const remaining = (data.quota.remaining != null) ? String(data.quota.remaining) : '‚Äî';
                quotaValue.textContent = remaining;
                if (quotaIndicator) {
                    const limit = (data.quota.limit != null) ? String(data.quota.limit) : '';
                    const resetAt = data.quota.resetAt ? String(data.quota.resetAt) : '';
                    quotaIndicator.title = limit ? `Quota: ${remaining}/${limit}${resetAt ? ` ‚Ä¢ Reset: ${resetAt}` : ''}` : 'Quota';
                }
            } catch (_) {
                // Fallback indicatif
                quotaValue.textContent = getQuotaLabelForPlan(plan);
                if (quotaIndicator) quotaIndicator.title = 'Quota (indicatif)';
            }
        }

        function updateQuotaUI(plan) {
            refreshQuotaFromServer(plan);
        }

        function closeUsageDashboardModal() {
            const el = document.getElementById('usageDashboardModal');
            if (el) el.style.display = 'none';
        }

        function formatMoney(amount, currency) {
            const n = Number(amount);
            if (!Number.isFinite(n)) return '‚Äî';
            const c = String(currency || '').trim().toUpperCase() || 'USD';
            try {
                return new Intl.NumberFormat(getLocale(), { style: 'currency', currency: c, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
            } catch (_) {
                return `${c} ${n.toFixed(2)}`;
            }
        }

        function formatMoneyAmountOnly(amount) {
            const n = Number(amount);
            if (!Number.isFinite(n)) return '‚Äî';
            try {
                return new Intl.NumberFormat(getLocale(), { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
            } catch (_) {
                return n.toFixed(2);
            }
        }

        function formatMoneyWithDollar(amount) {
            const n = Number(amount);
            if (!Number.isFinite(n)) return '‚Äî';
            try {
                return '$' + new Intl.NumberFormat(getLocale(), { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
            } catch (_) {
                return '$' + n.toFixed(2);
            }
        }

        function safeText(s) {
            return String(s == null ? '' : s);
        }

        async function openUsageDashboardModal() {
            const modal = document.getElementById('usageDashboardModal');
            const meta = document.getElementById('usageDashboardMeta');
            const balanceEl = document.getElementById('usageDashboardBalance');
            const monthCostEl = document.getElementById('usageDashboardMonthCost');
            const monthTokensEl = document.getElementById('usageDashboardMonthTokens');
            const body = document.getElementById('usageDashboardBody');
            if (!modal || !body) return;

            modal.style.display = 'flex';
            if (meta) meta.textContent = '';
            if (balanceEl) balanceEl.textContent = '‚Ä¶';
            if (monthCostEl) monthCostEl.textContent = '‚Ä¶';
            if (monthTokensEl) monthTokensEl.textContent = '‚Ä¶';
            body.textContent = t('usage.loading');

            const headers = {};
            try {
                const token = (typeof getAuthToken === 'function') ? getAuthToken() : null;
                if (token) headers['Authorization'] = `Bearer ${token}`;
            } catch (_) {}

            let u = 'guest';
            try {
                u = (typeof currentUser !== 'undefined' && currentUser)
                    ? (currentUser.email || currentUser.id)
                    : (typeof getTodoUserId === 'function' ? getTodoUserId() : 'guest');
            } catch (_) {}

            try {
                const qs = new URLSearchParams();
                if (u) qs.set('userId', String(u));
                const res = await fetch(`/api/me/usage?${qs.toString()}`, { method: 'GET', headers });
                const data = await res.json().catch(() => null);
                if (!res.ok || !data || !data.ok) throw new Error((data && data.error) ? String(data.error) : 'bad_response');

                const month = safeText(data.month || '');
                const credit = data.credit || {};
                const totals = data.totals || {};
                const items = Array.isArray(data.items) ? data.items : [];
                const displayCurrency = 'USD';
                const balanceValue = (Number.isFinite(credit.balanceAmount) ? Number(credit.balanceAmount)
                    : Number.isFinite(credit.balanceEur) ? Number(credit.balanceEur)
                    : Number.isFinite(credit.balance) ? Number(credit.balance)
                    : Number.isFinite(credit.balanceCents) ? Number(credit.balanceCents) / 100
                    : null);
                const totalsCurrency = 'USD';

                if (meta) meta.textContent = month ? `${t('usage.periodPrefix')} ${month}` : '';

                if (balanceEl) {
                    const bal = Number.isFinite(balanceValue) ? balanceValue : 0;
                    balanceEl.textContent = formatMoneyWithDollar(bal);
                }

                if (monthCostEl) {
                    monthCostEl.textContent = formatMoneyWithDollar(Number(totals.totalCost || 0));
                }

                if (monthTokensEl) {
                    const calls = Number(totals.totalCalls || 0);
                    const toks = Number(totals.totalTokens || 0);
                    monthTokensEl.textContent = `${calls.toLocaleString(getLocale())} ${t('usage.calls')} ‚Ä¢ ${toks.toLocaleString(getLocale())} ${t('usage.tokens')}`;
                }

                if (!items.length) {
                    body.textContent = t('usage.noUsage');
                    return;
                }

                const rows = items.map(it => {
                    const when = it.createdAt ? new Date(it.createdAt) : null;
                    const dateLabel = when && !Number.isNaN(when.getTime()) ? when.toLocaleString(getLocale()) : '‚Äî';
                    const model = it.model ? String(it.model) : '‚Äî';
                    const tokens = Number(it.totalTokens || 0);
                    const cost = it.cost == null ? null : Number(it.cost);
                    const itemCurrency = 'USD';
                    const costLabel = (cost == null || !Number.isFinite(cost)) ? '‚Äî' : formatMoneyWithDollar(cost);
                    return `
                        <tr>
                            <td style="padding: 10px; border-top: 1px solid var(--border-color); white-space: nowrap;">${safeText(dateLabel)}</td>
                            <td style="padding: 10px; border-top: 1px solid var(--border-color);">${safeText(model)}</td>
                            <td style="padding: 10px; border-top: 1px solid var(--border-color); text-align: right; white-space: nowrap;">${tokens.toLocaleString(getLocale())}</td>
                            <td style="padding: 10px; border-top: 1px solid var(--border-color); text-align: right; white-space: nowrap;">${safeText(costLabel)}</td>
                        </tr>
                    `;
                }).join('');

                body.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="color: var(--text-secondary); font-size: 12px;">
                                    <th style="text-align: left; padding: 8px 10px;">${safeText(t('usage.table.date'))}</th>
                                    <th style="text-align: left; padding: 8px 10px;">${safeText(t('usage.table.model'))}</th>
                                    <th style="text-align: right; padding: 8px 10px;">${safeText(t('usage.table.tokens'))}</th>
                                    <th style="text-align: right; padding: 8px 10px;">${safeText(t('usage.table.cost'))}</th>
                                </tr>
                            </thead>
                            <tbody style="color: var(--text-primary); font-size: 13px;">
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (e) {
                body.textContent = t('usage.errorLoading');
                try {
                    if (meta) meta.textContent = safeText(e && e.message ? e.message : 'Erreur');
                } catch (_) {}
            }
        }

        function updateEnterpriseBadgeUI(plan) {
            const badge = document.getElementById('enterpriseActiveBadge');
            if (!badge) return;
            const p = String(plan || '').toLowerCase();
            badge.style.display = (p === 'enterprise') ? 'inline-flex' : 'none';
        }

        function getCurrentPlanFromStorage() {
            try {
                const ax = String(localStorage.getItem('axilum_plan') || '').toLowerCase();
                if (ax) return ax;
            } catch (_) {}
            try {
                const sp = String(localStorage.getItem('selectedPlan') || '').toLowerCase();
                if (sp) return sp;
            } catch (_) {}
            return 'pro';
        }

        function switchToPlan(plan) {
            const p = String(plan || '').toLowerCase();
            const normalized = (p === 'free' || p === 'pro' || p === 'enterprise') ? p : 'pro';

            currentPlan = normalized;
            localStorage.setItem('axilum_plan', normalized);
            localStorage.setItem('selectedPlan', normalized.toUpperCase()); // Synchroniser avec selectedPlan

            // Update UI
            const freeBadge = document.getElementById('settingsPlanFree');
            const proBadge = document.getElementById('settingsPlanPro');

            if (freeBadge) freeBadge.classList.toggle('active', normalized === 'free');
            // ENTREPRISE n'est pas s√©lectionnable ici; on refl√®te l'√©tat via PRO
            if (proBadge) proBadge.classList.toggle('active', normalized === 'pro' || normalized === 'enterprise');

            updateQuotaUI(normalized);
            updateEnterpriseBadgeUI(normalized);

            if (normalized === 'free') {
                showToast('Mode FREE', 'info');
            } else if (normalized === 'enterprise') {
                showToast('Mode ENTREPRISE', 'success');
            } else {
                showToast('Mode PRO', 'success');
            }
        }

        // Initialize plan on load
        document.addEventListener('DOMContentLoaded', () => {
            // Fix mobile: tap "Mon Compte" parfois ignor√© (click/touch)
            try {
                const accountBtn = document.getElementById('accountBtn');
                if (accountBtn && accountBtn.dataset && accountBtn.dataset.tapFixInstalled !== '1') {
                    accountBtn.dataset.tapFixInstalled = '1';
                    let lastTapTs = 0;
                    const handler = (e) => {
                        const now = Date.now();
                        if (now - lastTapTs < 450) return;
                        lastTapTs = now;
                        try {
                            if (e) {
                                e.preventDefault();
                                e.stopPropagation();
                            }
                        } catch (_) {}
                        try {
                            showAccountMenu();
                        } catch (_) {}
                    };
                    accountBtn.addEventListener('touchend', handler, { passive: false });
                    accountBtn.addEventListener('click', handler);
                }
            } catch (_) {}

            // Attacher les event listeners aux boutons
            const menuBtn = document.getElementById('menuToggleBtn');
            const freeBadge = document.getElementById('settingsPlanFree');
            const proBadge = document.getElementById('settingsPlanPro');
            
            if (menuBtn) menuBtn.addEventListener('click', toggleSidebar);
            if (freeBadge) freeBadge.addEventListener('click', () => switchToPlan('free'));
            if (proBadge) proBadge.addEventListener('click', () => switchToPlan('pro'));

            // Dashboard consommation (clic sur le compteur quota)
            try {
                const quotaIndicator = document.getElementById('quotaIndicator');
                if (quotaIndicator && quotaIndicator.dataset && quotaIndicator.dataset.usageClickInstalled !== '1') {
                    quotaIndicator.dataset.usageClickInstalled = '1';
                    quotaIndicator.addEventListener('click', (e) => {
                        try { if (e) e.preventDefault(); } catch (_) {}
                        openUsageDashboardModal();
                    });
                }
            } catch (_) {}
            
            switchToPlan(currentPlan);

            // Docs search UI init
            try {
                refreshDocsSearchUi();
                refreshDocsEmbeddingsUi();

                const offBtn = document.getElementById('docsEmbOff');
                const onBtn = document.getElementById('docsEmbOn');
                if (offBtn) offBtn.addEventListener('click', () => {
                    setDocsEmbeddingsEnabled(false);
                    try { showToast('Embeddings d√©sactiv√©s', 'info'); } catch (_) {}
                });
                if (onBtn) onBtn.addEventListener('click', () => {
                    setDocsEmbeddingsEnabled(true);
                    try { showToast('Embeddings activ√©s', 'success'); } catch (_) {}
                });
            } catch (_) {}

            // Si un paiement/activation change le plan via localStorage (plus tard), refl√©ter l'√©tat
            window.addEventListener('storage', (e) => {
                try {
                    if (!e || (e.key !== 'axilum_plan' && e.key !== 'selectedPlan')) return;
                    const nextPlan = getCurrentPlanFromStorage();
                    switchToPlan(nextPlan);
                } catch (_) {}
            });
        });

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            const isCommandTop = /^\s*\//.test(message);
            // M√©moriser la langue utilisateur (pour /agent et autres r√©ponses instantan√©es)
            if (!isCommandTop) {
                const detected = detectLangFromTextClient(message, getStoredUserLang());
                setStoredUserLang(detected);
            }

            // Hide welcome screen on first message (do this early to cover all early-returns).
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }

            const selectedModel = (typeof getSelectedAiModel === 'function') ? getSelectedAiModel() : null;

            // ‚ö° Fast path (local) pour salutations / petit talk
            // Objectif: √©viter un appel IA long sur des messages simples.
            const lowerMsg = message.toLowerCase().trim();
            const isGreeting = /^(bonjour|bonsoir|salut|coucou|hello|hi|hey|hola|buenas|buenos|hallo|ciao|ola|ol√°|merhaba|–ø—Ä–∏–≤–µ—Ç|„Åì„Çì„Å´„Å°„ÅØ|‰Ω†Â•Ω|ŸÖÿ±ÿ≠ÿ®ÿß)\b/i.test(lowerMsg);
            const isJustChat = /\b(seulement\s+discuter|juste\s+discuter|on\s+discute|discuter\s+seulement|just\s+chat|just\s+talking|only\s+chat|let\s*'?s\s+chat)\b/i.test(lowerMsg);

            if (isGreeting || isJustChat) {
                input.value = '';
                try { adjustTextareaHeight(); } catch (_) {}

                addMessage(message, 'user');

                const localLang = detectLangFromTextClient(message, getStoredUserLang());
                setStoredUserLang(localLang);
                const quickReply = isJustChat
                    ? tLocal('quick_chat_prompt', localLang)
                    : tLocal('quick_greeting', localLang);

                const botData = {
                    response: quickReply,
                    hallucinationIndex: 0,
                    contextHistoryRatio: 0,
                    responseTime: 0.01,
                    processingTime: 0.01,
                    cached: true,
                    usage: { total_tokens: 0, prompt_tokens: 0, completion_tokens: 0 },
                    model: 'local',
                    provider: 'local'
                };

                addMessage(quickReply, 'bot', botData);
                try { await saveMessage(message, botData); } catch (_) {}
                return;
            }

            // Ne pas "voler" le focus apr√®s la r√©ponse : si l'utilisateur clique ailleurs pendant l'attente,
            // on √©vite de remettre automatiquement le focus dans le champ du chat.
            let allowAutoRefocus = false;
            let userInteractedOutsideChatInput = false;
            const markInteractionOutside = (e) => {
                try {
                    const target = e && e.target;
                    if (!target) return;
                    if (target === input) return;
                    const sendBtnEl = document.getElementById('sendBtn');
                    if (sendBtnEl && target === sendBtnEl) return;
                    if (typeof target.closest === 'function' && target.closest('.input-container')) return;
                    userInteractedOutsideChatInput = true;
                } catch (_) {}
            };

            // Cas important: l'utilisateur quitte l'onglet/la fen√™tre pendant l'attente.
            // Sans √ßa, on peut refocus au retour m√™me si l'utilisateur n'a rien cliqu√© "dans" la page.
            const markTabOrWindowLeft = () => {
                userInteractedOutsideChatInput = true;
            };

            const markVisibilityHidden = () => {
                try {
                    if (document.hidden) userInteractedOutsideChatInput = true;
                } catch (_) {}
            };

            // ü§ù Mode Team Auto (orchestrator) : route automatiquement les messages "normaux".
            // IMPORTANT: ne jamais intercepter les commandes (ex: /agent ...) sinon on reste coinc√© en Team.
            const isCommand = /^\s*\//.test(message);
            if (typeof currentChatType !== 'undefined' && String(currentChatType) === 'team-auto' && !isCommand) {
                input.value = '';
                try { adjustTextareaHeight(); } catch (_) {}

                // Afficher la question utilisateur
                addMessage(message, 'user');
                showTyping();

                try {
                    const endpoint = getEndpoint();

                    const conv = conversations.find(c => c.id === currentConversationId);
                    const history = [];
                    if (conv && conv.messages) {
                        conv.messages.forEach(m => {
                            if (m.user) history.push({ type: 'user', content: m.user });
                            if (m.bot) history.push({ type: 'bot', content: m.bot, hiScore: m.hiScore || 0, chrScore: m.chrScore || 0 });
                        });
                    }

                    const V2_ROLLOUT_PERCENTAGE = 0;
                    const useV2 = shouldUseV2ForRequest(V2_ROLLOUT_PERCENTAGE);

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: withAuthHeaders({ 'Content-Type': 'application/json' }),
                        body: JSON.stringify({
                            model: selectedModel,
                            message: message,
                            conversationId: currentConversationId,
                            chatType: 'orchestrator',
                            teamAgents: ['auto'],
                            teamQuestion: message,
                            history: history,
                            useV2: useV2
                        })
                    });

                    if (!response.ok) throw new Error(`Erreur ${response.status}`);
                    const data = await response.json();
                    hideTyping();
                    addMessage(data.response || 'Erreur de r√©ponse', 'bot', data);
                } catch (err) {
                    hideTyping();
                    addMessage('‚ùå Erreur orchestration: ' + (err.message || String(err)), 'bot');
                }
                return;
            }


            // MCP Command
            if (/^\/mcp\b/i.test(message)) {
                if (typeof getMcpOn === 'function' && !getMcpOn()) { input.value = ''; addMessage('MCP d√©sactiv√©. Activez-le dans Param√®tres.', 'bot'); return; }
                var raw = message.replace(/^\/mcp\b/i, '').trim(); input.value = '';
                var parts = raw.split(/\s+/), tool = parts[0], query = parts.slice(1).join(' ');
                if (!tool) { addMessage('Usage: /mcp <outil> [params]', 'bot'); return; }
                addMessage(message, 'user'); showTyping();
                fetch('/mcp', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tool: tool, params: { query: query } }) })
                    .then(function(r) { return r.json(); })
                    .then(function(d) { hideTyping(); addMessage(d.status === 'success' ? JSON.stringify(d.data, null, 2) : ('Erreur: ' + (d.error || 'Unknown')), 'bot'); })
                    .catch(function(e) { hideTyping(); addMessage('Erreur MCP: ' + e.message, 'bot'); });
                return;
            }

            // ü§ù Orchestration multi-agents (sur demande)
            // Syntaxe fiable: /team dev marketing -- votre question
            if (/^\/team\b/i.test(message)) {
                const raw = message.replace(/^\/team\b/i, '').trim();
                input.value = '';
                adjustTextareaHeight();

                if (!raw || /^help$/i.test(raw)) {
                    const help = [
                        'ü§ù Orchestration multi-agents (sur demande)',
                        '',
                        'Syntaxe:',
                        '- `/team dev marketing -- votre question`',
                        '- `/team auto -- votre question`',
                        '',
                        'Alias agents:',
                        '- auto, dev, marketing, rh, excel, todo, web, alex, tony, axilum',
                        '',
                        'Notes:',
                        '- max 3 agents par requ√™te (MVP robuste)',
                        '- l\'orchestrateur renvoie une seule r√©ponse finale'
                    ].join('\n');
                    addMessage(help, 'bot');
                    return;
                }

                const parts = raw.split(/\s+--\s+/);
                if (parts.length < 2) {
                    addMessage('‚ö†Ô∏è Syntaxe invalide. Exemple: `/team dev marketing -- votre question`', 'bot');
                    return;
                }

                const agentsPart = parts[0].trim();
                const question = parts.slice(1).join(' -- ').trim();
                if (!agentsPart || !question) {
                    addMessage('‚ö†Ô∏è Ajoutez des agents et une question. Exemple: `/team dev marketing -- votre question`', 'bot');
                    return;
                }

                const aliasToChatType = {
                    auto: 'auto',
                    dev: 'agent-dev',
                    marketing: 'marketing-agent',
                    rh: 'hr-management',
                    excel: 'excel-expert',
                    todo: 'agent-todo',
                    web: 'web-search',
                    alex: 'agent-alex',
                    tony: 'agent-tony',
                    axilum: 'axilum'
                };

                const requestedAgents = agentsPart
                    .split(/\s+/)
                    .map(a => String(a || '').trim().toLowerCase())
                    .filter(Boolean)
                    .map(a => aliasToChatType[a] || a)
                    .filter(Boolean);

                const teamAgents = Array.from(new Set(requestedAgents)).slice(0, 3);
                if (teamAgents.length === 0) {
                    addMessage('‚ö†Ô∏è Aucun agent valide. Essayez: dev, mark, rh, todo, web, alex, axilum', 'bot');
                    return;
                }

                // Afficher la question utilisateur
                addMessage(question, 'user');
                showTyping();

                // Envoyer au backend (orchestrateur)
                try {
                    const endpoint = getEndpoint();

                    const conv = conversations.find(c => c.id === currentConversationId);
                    const history = [];
                    if (conv && conv.messages) {
                        conv.messages.forEach(m => {
                            if (m.user) history.push({ type: 'user', content: m.user });
                            if (m.bot) history.push({ type: 'bot', content: m.bot, hiScore: m.hiScore || 0, chrScore: m.chrScore || 0 });
                        });
                    }

                    const V2_ROLLOUT_PERCENTAGE = 0;
                    const useV2 = shouldUseV2ForRequest(V2_ROLLOUT_PERCENTAGE);

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: withAuthHeaders({ 'Content-Type': 'application/json' }),
                        body: JSON.stringify({
                            model: selectedModel,
                            message: question,
                            conversationId: currentConversationId,
                            chatType: 'orchestrator',
                            teamAgents: teamAgents,
                            teamQuestion: question,
                            history: history,
                            useV2: useV2
                        })
                    });

                    if (!response.ok) throw new Error(`Erreur ${response.status}`);
                    const data = await response.json();
                    hideTyping();
                    addMessage(data.response || 'Erreur de r√©ponse', 'bot', data);
                } catch (err) {
                    hideTyping();
                    addMessage('‚ùå Erreur orchestration: ' + (err.message || String(err)), 'bot');
                }
                return;
            }

            // üîÅ Commandes d'agent (chat principal)
            // Exemples: /agent dev | /agent axilum | /agent help
            if (/^\/agent\b/i.test(message)) {
                const arg = message.replace(/^\/agent\b/i, '').trim();

                // UX: ne pas afficher la commande /agent dans le chat.
                // On efface simplement l'input puis on affiche un message d'accueil.
                input.value = '';
                adjustTextareaHeight();

                if (!arg || /^help$/i.test(arg)) {
                    const help = [
                        'üîÅ Changement d\'agent disponible :',
                        '- `/agent axilum` : Axilum Ai',
                        '- `/agent dev` : Agent Dev',
                        '- `/agent excel` : Agent Xcel (Excel AI Expert)',
                        '- `/agent todo` : Agent ToDo',
                        '- `/agent rh` : Agent RH',
                        '- `/agent mark` : Agent Mark',
                        '- `/agent alex` : Agent Alex (Finance & Comptabilit√©)',
                        '- `/agent web` : Agent Wesh',
                        '',
                        'Note: les agents partagent le m√™me historique de conversation.'
                    ].join('\n');
                    addMessage(help, 'bot');
                    return;
                }

                const chosen = setChatType(arg);

                const uiLang = (typeof getAppLanguage === 'function') ? getAppLanguage() : getStoredUserLang();
                const mkWelcome = (agentLabel) => tLocal('agent_welcome', uiLang).replace('{agent}', agentLabel);

                // Afficher uniquement un message d'accueil (sans citer d'autres modules/agents).
                const welcome = chosen === 'agent-dev'
                    ? mkWelcome('Agent Dev')
                    : chosen === 'excel-expert'
                        ? mkWelcome('Agent Xcel')
                        : chosen === 'agent-todo'
                            ? mkWelcome('Agent ToDo')
                            : chosen === 'hr-management'
                                ? mkWelcome('Agent RH')
                                : chosen === 'marketing-agent'
                                    ? mkWelcome('Agent Mark')
                                    : chosen === 'web-search'
                                        ? mkWelcome('Agent Wesh')
                                        : chosen === 'agent-alex'
                                            ? mkWelcome('Agent Alex')
                                            : chosen === 'agent-tony'
                                                ? mkWelcome('Agent Tony')
                                                : chosen === 'team-auto'
                                                    ? tLocal('team_auto', uiLang)
                                                    : mkWelcome('Axilum AI');

                addMessage(welcome, 'bot');
                return;
            }

            // üîç Mode Hallucination Detector: v√©rifier un texte externe via /api/verify-hallucination
            if (typeof hallucinationVerifyMode !== 'undefined' && hallucinationVerifyMode && hallucinationVerifyMode.active) {
                // Fermer la sidebar automatiquement
                closeSidebar();

                // Disable input
                const sendBtn = document.getElementById('sendBtn');

                try {
                    allowAutoRefocus = (document.activeElement === input || document.activeElement === sendBtn);
                } catch (_) {
                    allowAutoRefocus = false;
                }
                try {
                    document.addEventListener('pointerdown', markInteractionOutside, true);
                    document.addEventListener('focusin', markInteractionOutside, true);
                    window.addEventListener('blur', markTabOrWindowLeft, true);
                    document.addEventListener('visibilitychange', markVisibilityHidden, true);
                } catch (_) {}

                sendBtn.disabled = true;
                input.disabled = true;

                // Add user message
                addMessage(message, 'user');
                input.value = '';
                adjustTextareaHeight();

                // Show typing indicator
                showTyping();

                try {
                    // Limite simple pour √©viter timeouts/coups de m√©moire
                    if (message.length > 50000) {
                        throw new Error(t('hd.error.tooLong'));
                    }

                    const res = await fetch('/api/verify-hallucination', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: message,
                            source: hallucinationVerifyMode.source || t('hd.source.otherAi'),
                            lang: getAppLanguage()
                        })
                    });

                    const report = await res.json().catch(() => null);
                    hideTyping();

                    if (!res.ok || !report) {
                        const details = report && (report.details || report.error) ? ` (${report.details || report.error})` : '';
                        addMessage(`‚ùå ${t('hd.error.unavailable')}${details}`, 'bot', { detectorReport: true });
                    } else {
                        const reliabilityScore = typeof report.reliabilityScore === 'number' ? report.reliabilityScore : null;
                        const hiPercent = typeof report.hiPercent === 'number' ? report.hiPercent : null;
                        const chrPercent = typeof report.chrPercent === 'number' ? report.chrPercent : null;
                        const contradictionsCount = Array.isArray(report.contradictions) ? report.contradictions.length : 0;
                        const hallucinationsCount = Array.isArray(report.hallucinations) ? report.hallucinations.length : 0;
                        const verifiedCount = Array.isArray(report.verifiedFacts) ? report.verifiedFacts.length : 0;
                        const suspiciousCount = Array.isArray(report.suspiciousFacts) ? report.suspiciousFacts.length : 0;
                        const securityCount = Array.isArray(report.securityWarnings) ? report.securityWarnings.length : 0;
                        const detectorCounts = (report && report.counts && typeof report.counts === 'object') ? report.counts : null;
                        const evidenceScore = (report && report.score && typeof report.score === 'object') ? report.score : null;
                        const notSupportedClaims = Array.isArray(report.notSupportedClaims) ? report.notSupportedClaims : [];
                        const contradictoryClaims = Array.isArray(report.contradictoryClaims) ? report.contradictoryClaims : [];

                        let out = `${t('hd.report.title')}\n`;
                        if (report.source) out += `${t('hd.report.source')}: ${report.source}\n`;
                        if (reliabilityScore !== null) out += `${t('hd.report.reliability')}: ${reliabilityScore}%\n`;
                        if (hiPercent !== null || chrPercent !== null) {
                            out += `HI: ${hiPercent !== null ? hiPercent + '%' : 'N/A'} | CHR: ${chrPercent !== null ? chrPercent + '%' : 'N/A'}\n`;
                        }

                        if (evidenceScore && (typeof evidenceScore.contradictionRisk === 'number' || typeof evidenceScore.evidenceCoverage === 'number')) {
                            const risk = (typeof evidenceScore.contradictionRisk === 'number') ? `${evidenceScore.contradictionRisk}%` : 'N/A';
                            const cov = (typeof evidenceScore.evidenceCoverage === 'number') ? `${evidenceScore.evidenceCoverage}%` : 'N/A';
                            const ci = (evidenceScore.uncertainty && Array.isArray(evidenceScore.uncertainty.ci90) && evidenceScore.uncertainty.ci90.length === 2)
                                ? `[${evidenceScore.uncertainty.ci90[0]}%, ${evidenceScore.uncertainty.ci90[1]}%]`
                                : 'N/A';
                            out += `${t('hd.report.contradictionRisk')}: ${risk} | ${t('hd.report.evidenceCoverage')}: ${cov} | ${t('hd.report.uncertainty')}: ${ci}\n`;
                        }

                        if (detectorCounts && typeof detectorCounts.total === 'number') {
                            const total = detectorCounts.total;
                            const supported = typeof detectorCounts.supported === 'number' ? detectorCounts.supported : 0;
                            const notSupported = typeof detectorCounts.not_supported === 'number' ? detectorCounts.not_supported : 0;
                            const contradictory = typeof detectorCounts.contradictory === 'number' ? detectorCounts.contradictory : 0;
                            out += `${t('hd.report.claimsDetector')}: total ${total} | ‚úÖ ${supported} | ‚ùå ${notSupported} | ‚ö° ${contradictory}\n`;
                        }

                        out += `${t('hd.report.facts')}: ‚úÖ ${verifiedCount} | ‚ö†Ô∏è ${t('hd.report.unverified')}: ${suspiciousCount} | ‚ùå hallucinations: ${hallucinationsCount}\n`;
                        if (contradictionsCount > 0) out += `${t('hd.report.internalContradictions')}: ${contradictionsCount}\n`;
                        if (securityCount > 0) out += `${t('hd.report.securityWarnings')}: ${securityCount}\n`;

                        if (typeof report.warning === 'string' && report.warning.trim()) {
                            out += `\n${report.warning.trim()}\n`;
                        }

                        if (Array.isArray(report.suspiciousFacts) && report.suspiciousFacts.length > 0) {
                            out += `\n${t('hd.section.unconfirmed')}\n`;
                            report.suspiciousFacts.slice(0, 5).forEach((s, idx) => {
                                const fact = (s && s.fact) ? String(s.fact) : '';
                                const reason = (s && s.reason) ? ` ‚Äî ${s.reason}` : '';
                                if (fact) out += `${idx + 1}. ${fact}${reason}\n`;
                            });
                        }

                        if (Array.isArray(report.hallucinations) && report.hallucinations.length > 0) {
                            out += `\n${t('hd.section.probablyFalse')}\n`;
                            report.hallucinations.slice(0, 5).forEach((h, idx) => {
                                const fact = (h && h.fact) ? String(h.fact) : '';
                                const reason = (h && h.reason) ? ` ‚Äî ${h.reason}` : '';
                                if (fact) out += `${idx + 1}. ${fact}${reason}\n`;
                            });
                        }

                        if (notSupportedClaims.length > 0) {
                            out += `\n${t('hd.section.notSupportedClaims')}\n`;
                            notSupportedClaims.slice(0, 5).forEach((c, idx) => {
                                const txt = (c && c.text) ? String(c.text) : '';
                                if (txt) out += `${idx + 1}. ${txt}\n`;
                            });
                        }

                        if (contradictoryClaims.length > 0) {
                            out += `\n${t('hd.section.contradictoryClaims')}\n`;
                            contradictoryClaims.slice(0, 5).forEach((c, idx) => {
                                const txt = (c && c.text) ? String(c.text) : '';
                                if (txt) out += `${idx + 1}. ${txt}\n`;
                            });
                        }

                        if (Array.isArray(report.verifiedFacts) && report.verifiedFacts.length > 0) {
                            out += `\n${t('hd.section.verifiedFacts')}\n`;
                            report.verifiedFacts.slice(0, 5).forEach((v, idx) => {
                                const fact = (v && v.fact) ? String(v.fact) : '';
                                const src = (v && v.source) ? ` (${v.source})` : '';
                                if (fact) out += `${idx + 1}. ${fact}${src}\n`;
                            });
                        }

                        if (Array.isArray(report.recommendedSources) && report.recommendedSources.length > 0) {
                            out += `\n${t('hd.section.recommendedSources')}\n`;
                            report.recommendedSources.slice(0, 5).forEach((s, idx) => {
                                const src = s ? String(s) : '';
                                if (src) out += `${idx + 1}. ${src}\n`;
                            });
                        }

                        if (typeof report.recommendation === 'string' && report.recommendation.trim()) {
                            out += `\n${t('hd.report.recommendation')}: ${report.recommendation.trim()}\n`;
                        }

                        addMessage(out.trim(), 'bot', { detectorReport: true });
                        await saveMessage(message, { response: out.trim(), detectorReport: true });
                    }
                } catch (err) {
                    hideTyping();
                    addMessage(`${t('hd.error.analysisPrefix')} ${err.message}`, 'bot', { detectorReport: true });
                } finally {
                    try {
                        document.removeEventListener('pointerdown', markInteractionOutside, true);
                        document.removeEventListener('focusin', markInteractionOutside, true);
                        window.removeEventListener('blur', markTabOrWindowLeft, true);
                        document.removeEventListener('visibilitychange', markVisibilityHidden, true);
                    } catch (_) {}

                    hallucinationVerifyMode.active = false;
                    if (input) {
                        try {
                            if (hallucinationVerifyMode.prevPlaceholder !== null) {
                                input.setAttribute('placeholder', hallucinationVerifyMode.prevPlaceholder);
                            }
                        } catch (_) {}
                        hallucinationVerifyMode.prevPlaceholder = null;
                    }

                    const sendBtn = document.getElementById('sendBtn');
                    sendBtn.disabled = false;
                    input.disabled = false;
                    try {
                        if (!userInteractedOutsideChatInput && allowAutoRefocus) {
                            input.focus();
                        }
                    } catch (_) {}
                }

                return;
            }

            // MODE D√âTECTION D'HALLUCINATIONS

            // üìÖ D√âTECTION AUTOMATIQUE DES COMMANDES TO DO - D√âSACTIV√âE
            // AI Axilum reste un assistant g√©n√©ral. Pour g√©rer les t√¢ches, utilisez le module AI Task.
            // const todoResult = detectAndHandleTodoCommand(message);
            // if (todoResult.handled) {
            //     addMessage(message, 'user');
            //     addMessage(todoResult.response, 'bot');
            //     input.value = '';
            //     adjustTextareaHeight();
            //     saveMessage(message, { response: todoResult.response });
            //     return;
            // }

            // Fermer la sidebar automatiquement
            closeSidebar();
            
            // üéØ Effacer le contexte "current" car l'utilisateur interagit avec AI Axilum
            AxilumContext.clearCurrent();

            // Disable input
            const sendBtn = document.getElementById('sendBtn');

            try {
                allowAutoRefocus = (document.activeElement === input || document.activeElement === sendBtn);
            } catch (_) {
                allowAutoRefocus = false;
            }
            try {
                document.addEventListener('pointerdown', markInteractionOutside, true);
                document.addEventListener('focusin', markInteractionOutside, true);
                window.addEventListener('blur', markTabOrWindowLeft, true);
                document.addEventListener('visibilitychange', markVisibilityHidden, true);
            } catch (_) {}

            sendBtn.disabled = true;
            input.disabled = true;

            // Add user message
            addMessage(message, 'user');
            input.value = '';
            adjustTextareaHeight();

            // Show typing indicator
            showTyping();

            // Pr√©parer l'historique de conversation
            const conv = conversations.find(c => c.id === currentConversationId);
            const history = [];
            if (conv && conv.messages) {
                conv.messages.forEach(m => {
                    // Ajouter le message utilisateur
                    if (m.user) {
                        history.push({
                            type: 'user',
                            content: m.user
                        });
                    }
                    // Ajouter la r√©ponse du bot
                    if (m.bot) {
                        history.push({
                            type: 'bot',
                            content: m.bot,
                            hiScore: m.hiScore || 0,
                            chrScore: m.chrScore || 0
                        });
                    }
                });
            }

            try {
                const requestStart = Date.now();
                const endpoint = getEndpoint();

                let usedFreeOcr = false;

                const baseContext = getApplicationKnowledge(currentChatType) + AxilumContext.getEnrichedContext(currentChatType);
                let agentDevExtraContext = '';
                if (currentChatType === 'agent-dev') {
                    const rndData = getRnDDataFromStorage();
                    agentDevExtraContext = '\n\n' + buildAgentDevRnDContext({
                        mode: 'summary',
                        projects: rndData.projects,
                        milestones: rndData.milestones,
                        documents: rndData.documents,
                        risks: rndData.risks
                    });
                }

                let agentHRExtraContext = '';
                if (currentChatType === 'hr-management') {
                    const hrData = getHRModuleDataFromStorage();
                    agentHRExtraContext = '\n\n' + buildAgentHRContext({
                        mode: 'summary',
                        employees: hrData.employees,
                        leaves: hrData.leaves,
                        payrolls: hrData.payrolls,
                        reviews: hrData.reviews,
                        recruitmentJobs: hrData.recruitmentJobs,
                        recruitmentCandidates: hrData.recruitmentCandidates,
                        companySettings: hrData.companySettings
                    });
                }

                let agentMarketingExtraContext = '';
                if (currentChatType === 'marketing-agent') {
                    const mktData = getMarketingModuleDataFromStorage();
                    agentMarketingExtraContext = '\n\n' + buildAgentMarketingContext({
                        mode: 'summary',
                        campaigns: mktData.campaigns,
                        personas: mktData.personas,
                        content: mktData.content,
                        business: mktData.business
                    });
                }

                let agentExcelExtraContext = '';
                if (currentChatType === 'excel-expert') {
                    const excelData = getExcelModuleDataFromStorage();
                    agentExcelExtraContext = '\n\n' + buildAgentExcelContext({
                        mode: 'summary',
                        savedWorkbooks: excelData.savedWorkbooks,
                        currentWorkbook: excelData.currentWorkbook
                    });
                }

                let agentTodoExtraContext = '';
                if (currentChatType === 'agent-todo') {
                    const todoData = getTodoModuleDataFromStorage();
                    agentTodoExtraContext = '\n\n' + buildAgentTodoContext({
                        mode: 'summary',
                        tasks: todoData.tasks,
                        projects: todoData.projects,
                        events: todoData.events,
                        notificationSettings: todoData.notificationSettings,
                        todoNotificationsEnabled: todoData.todoNotificationsEnabled,
                        currentUser: todoData.currentUser
                    });
                }

                let agentFinanceExtraContext = '';
                // (legacy) finance-agent est d√©sormais normalis√© en agent-alex

                let agentAlexExtraContext = '';
                if (currentChatType === 'agent-alex') {
                    const finData = getFinanceModuleDataFromStorage();
                    agentAlexExtraContext = '\n\n' + buildAgentFinanceContext({
                        mode: 'summary',
                        companySettings: finData.companySettings,
                        invoices: finData.invoices,
                        reports: finData.reports,
                        budgets: finData.budgets,
                        kpis: finData.kpis,
                        lastInvoice: finData.lastInvoice,
                        financeDataLastUpdated: finData.financeDataLastUpdated,
                        conversationsCount: finData.conversationsCount
                    });
                }

                let agentWebSearchExtraContext = '';
                if (currentChatType === 'web-search') {
                    const wsData = getWebSearchModuleDataFromStorage();
                    agentWebSearchExtraContext = '\n\n' + buildAgentWebSearchContext({
                        mode: 'summary',
                        lastQuery: wsData.lastQuery,
                        lastResponse: wsData.lastResponse,
                        lastUpdated: wsData.lastUpdated,
                        sources: wsData.sources
                    });
                }

                let agentTonyExtraContext = '';
                if (currentChatType === 'agent-tony') {
                    const textProData = getTextProModuleDataFromStorage();
                    agentTonyExtraContext = '\n\n' + buildAgentTonyContext({
                        mode: 'summary',
                        lastText: textProData.lastText,
                        lastUpdated: textProData.lastUpdated,
                        lastFileName: textProData.lastFileName,
                        currentText: textProData.currentText,
                        currentFileName: textProData.currentFileName
                    });
                }

                let contextPrefix = baseContext + agentDevExtraContext + agentHRExtraContext + agentMarketingExtraContext + agentExcelExtraContext + agentTodoExtraContext + agentFinanceExtraContext + agentAlexExtraContext + agentWebSearchExtraContext + agentTonyExtraContext;

                // üìö Docs RAG: injecter un contexte court issu d'Elasticsearch (vos documents)
                try {
                    const docsCtx = await fetchDocsContextForQuery(message);
                    if (docsCtx) {
                        contextPrefix = contextPrefix + `\n\n${docsCtx}`;
                    }
                } catch (_) {}

                let messageForBackend = contextPrefix + '\n\nUtilisateur: ' + message;

                // Force Agent Alex language in EN mode (some base contexts are FR-heavy).
                try {
                    const lang = (typeof getAppLanguage === 'function') ? getAppLanguage() : 'fr';
                    if (currentChatType === 'agent-alex' && lang === 'en') {
                        messageForBackend += '\n\nIMPORTANT: Reply in English only. Do not reply in French.';
                    }
                } catch (_) {}

                // üñºÔ∏è Si une image a √©t√© upload√©e dans cette conversation, et que l'utilisateur pose une question,
                // on route la requ√™te vers l'analyse d'image (Vision) pour que l'IA "voie" r√©ellement la photo.
                const convForVision = conversations.find(c => c.id === currentConversationId);
                const getLastUploadedImageFromConversation = () => {
                    if (!convForVision || !Array.isArray(convForVision.messages)) return null;
                    for (let i = convForVision.messages.length - 1; i >= 0; i--) {
                        const msg = convForVision.messages[i];
                        if (msg && !msg.imageGenerated && (msg.imageUrl || msg.imageId)) {
                            return { base64: msg.imageUrl || null, imageId: msg.imageId || null, name: msg.user || 'image' };
                        }
                    }
                    return null;
                };

                const lastImageFromConversation = getLastUploadedImageFromConversation();

                let lastImageBase64 = lastUploadedImageByConversation[currentConversationId]
                    || (lastImageFromConversation && lastImageFromConversation.base64);
                const lastImageId = (lastImageFromConversation && lastImageFromConversation.imageId) || null;
                const lastImageName = lastUploadedImageNameByConversation[currentConversationId]
                    || (lastImageFromConversation && lastImageFromConversation.name);

                if (!lastImageBase64 && lastImageId) {
                    try {
                        lastImageBase64 = await getImageDataUrlById(lastImageId);
                    } catch (_) {
                        lastImageBase64 = null;
                    }
                }

                if (lastImageBase64) {
                    const selectedPlan = (localStorage.getItem('selectedPlan') || '').toUpperCase();
                    const isPro = currentPlan === 'pro' || currentPlan === 'enterprise' || selectedPlan === 'PRO' || selectedPlan === 'ENTERPRISE';

                    if (!isPro) {
                        usedFreeOcr = true;
                        try {
                            const sig = String(lastImageBase64.length);
                            let ocrText = '';

                            if (lastUploadedOcrTextByConversation[currentConversationId] && lastUploadedOcrImageSigByConversation[currentConversationId] === sig) {
                                ocrText = lastUploadedOcrTextByConversation[currentConversationId];
                            } else {
                                showToast('üìÑ OCR local en cours (mode FREE)...', 'info');
                                ocrText = await withTimeout(
                                    extractTextFromImageBase64(lastImageBase64),
                                    30000,
                                    'OCR trop long (mode FREE)'
                                );
                                lastUploadedOcrTextByConversation[currentConversationId] = ocrText;
                                lastUploadedOcrImageSigByConversation[currentConversationId] = sig;
                            }

                            const cleanName = (lastImageName || 'photo').replace(/^üì∏\s*/, '');
                            const ocrPreview = ocrText && ocrText.length > 0 ? ocrText : "(Aucun texte lisible d√©tect√© dans l'image)";
                            messageForBackend = contextPrefix
                                + '\n\nContexte image (OCR local - ' + cleanName + '):\n'
                                + ocrPreview
                                + '\n\nQuestion utilisateur: ' + message;
                        } catch (ocrErr) {
                            messageForBackend = contextPrefix
                                + "\n\n(Utilisateur a upload√© une image, mais l'OCR local a √©chou√©: " + ocrErr.message + ')\n\nUtilisateur: ' + message;
                        }
                    }

                    // Mode PRO: utiliser Vision comme contexte, puis continuer la discussion normale.
                    if (isPro) {
                        const imageSig = String(lastImageBase64.length);
                        let visionText = '';

                        if (
                            lastUploadedVisionTextByConversation[currentConversationId]
                            && lastUploadedVisionImageSigByConversation[currentConversationId] === imageSig
                        ) {
                            visionText = lastUploadedVisionTextByConversation[currentConversationId];
                        } else {
                            showToast(`üîç Analyse de l'image (${(lastImageName || 'photo').replace(/^üì∏\s*/, '')})...`, 'info');
                            const analyzeEndpoint = '/api/analyze-image-pro';
                            try {
                                const visionResponse = await withTimeout(fetch(analyzeEndpoint, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        imageBase64: lastImageBase64,
                                        question: 'D√©cris cette image en d√©tail. Que vois-tu ?'
                                    })
                                }), 45000, 'Analyse image trop longue (PRO)');

                                const analysisData = await visionResponse.json().catch(() => ({ analysis: '' }));
                                if (visionResponse.ok) {
                                    visionText = analysisData.analysis || '';
                                    lastUploadedVisionTextByConversation[currentConversationId] = visionText;
                                    lastUploadedVisionImageSigByConversation[currentConversationId] = imageSig;
                                } else {
                                    visionText = '';
                                }
                            } catch (err) {
                                visionText = '';
                            }
                        }

                        if (visionText) {
                            const cleanName = (lastImageName || 'photo').replace(/^üì∏\s*/, '');
                            messageForBackend = contextPrefix
                                + '\n\nContexte image (Vision PRO - ' + cleanName + '):\n'
                                + visionText
                                + '\n\nQuestion utilisateur: ' + message;
                        }
                    }
                }

                // üìé Si un PDF/document vient d'√™tre upload√©, injecter son texte comme contexte UNE seule fois.
                // Cela √©vite d'afficher une bulle gigantesque tout en gardant la capacit√© d'analyse.
                try {
                    const pendingDoc = pendingUploadedDocByConversation[currentConversationId];
                    const extracted = pendingDoc && pendingDoc.extractedText ? String(pendingDoc.extractedText) : '';
                    const name = pendingDoc && pendingDoc.fileName ? String(pendingDoc.fileName) : 'document';
                    if (extracted && extracted.trim().length > 0) {
                        const maxChars = Math.max(2000, Math.min(50000, Number(window.DOC_UPLOAD_CONTEXT_MAX_CHARS || 20000) || 20000));
                        const clipped = extracted.length > maxChars ? (extracted.slice(0, maxChars) + '\n\n[... contenu tronqu√© ...]') : extracted;
                        messageForBackend = contextPrefix
                            + `\n\nContexte document upload√© (PDF - ${name}):\n`
                            + clipped
                            + '\n\nQuestion utilisateur: ' + message;

                        // Utiliser une seule fois (ensuite: RAG/docsCtx prend le relais)
                        delete pendingUploadedDocByConversation[currentConversationId];
                    }
                } catch (_) {}
                
                // üß™ D√©terminer si on utilise V2 via le param√®tre
                const V2_ROLLOUT_PERCENTAGE = 0; // Modifier cette valeur pour activer le rollout
                const useV2 = shouldUseV2ForRequest(V2_ROLLOUT_PERCENTAGE);
                
                console.log(`üéØ Using ${currentPlan.toUpperCase()} endpoint:`, endpoint);
                if (useV2) {
                    console.log('üß™ Architecture V2 (scalable) utilis√©e - Param√®tre useV2=true');
                } else {
                    console.log('üìä Architecture V1 (actuelle) utilis√©e');
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: withAuthHeaders({ 'Content-Type': 'application/json' }),
                    body: JSON.stringify({ 
                        model: selectedModel,
                        message: messageForBackend,  // üéØ Connaissance app + contexte + message (ou OCR)
                        conversationId: currentConversationId,
                        chatType: currentChatType,
                        lang: (typeof getAppLanguage === 'function') ? getAppLanguage() : undefined,
                        history: history,
                        useV2: useV2  // ‚ú® Param√®tre pour activer V2
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}`);
                }

                const data = await response.json();
                if (!data.model && selectedModel) {
                    data.model = selectedModel;
                }
                const requestTime = Date.now() - requestStart;
                hideTyping();

                if (usedFreeOcr) {
                    if (!visionProPromoShownByConversation[currentConversationId]) {
                        data.response = appendVisionProPromo(data.response);
                        visionProPromoShownByConversation[currentConversationId] = true;
                    }
                }
                
                // üöÄ PERFORMANCE : Afficher le temps de r√©ponse
                const isCached = response.headers.get('X-Cache') === 'HIT';
                if (isCached) {
                    console.log(`‚ö° R√©ponse en cache! Temps: ${requestTime}ms`);
                } else {
                    console.log(`üìä Temps de r√©ponse: ${requestTime}ms`);
                }
                
                // Ajouter les infos de performance au data
                data.responseTime = requestTime;
                data.cached = isCached;
                
                // ÔøΩ V√âRIFIER SI ERREUR DE L'API
                if (data.error) {
                    console.error('‚ùå Erreur de l\'API:', data.error);
                    let errorMessage = `‚ùå **Erreur**: ${data.error}\n\n`;
                    if (data.hint) errorMessage += `üí° **Solution**: ${data.hint}\n\n`;
                    if (data.details) errorMessage += `üìã **D√©tails**: ${data.details}`;
                    addMessage(errorMessage, 'bot', data);
                    return;
                }
                
                // V√©rifier que response existe
                if (!data.response) {
                    console.error('‚ùå Pas de r√©ponse dans data:', data);
                    addMessage('‚ùå Erreur: L\'API n\'a pas retourn√© de r√©ponse', 'bot', data);
                    return;
                }

                // üîé Web Search: persister un snapshot minimal (requ√™te + r√©ponse + sources)
                if (currentChatType === 'web-search') {
                    try {
                        localStorage.setItem('webSearch_lastQuery', String(message || ''));
                        localStorage.setItem('webSearch_lastResponse', String(data.response || ''));
                        localStorage.setItem('webSearch_lastUpdated', new Date().toISOString());
                        const src = Array.isArray(data.sources) ? data.sources.slice(0, 12) : [];
                        localStorage.setItem('webSearch_lastSources', JSON.stringify(src));
                    } catch (_) {}
                }
                
                // ÔøΩüõ°Ô∏è V√©rifier la protection contre hallucinations
                if (data.protection && data.protection.should_intervene) {
                    showProtectionAlert(data.protection);
                }
                
                // üé® D√©tecter demande de g√©n√©ration d'image
                const imageGenMatch = data.response.match(/Je g√©n√®re l'image\s*:\s*(.+?)(?:\n|$)/i);
                if (imageGenMatch) {
                    const imagePrompt = imageGenMatch[1].trim();
                    
                    // Afficher le message de l'IA
                    addMessage(data.response || 'Pas de r√©ponse', 'bot', data);
                    
                    // G√©n√©rer l'image automatiquement
                    try {
                        showToast('üé® G√©n√©ration de l\'image en cours...', 'info');
                        const imgResponse = await fetch('/api/generate-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: imagePrompt })
                        });
                        
                        if (imgResponse.ok) {
                            const imgData = await imgResponse.json();
                            imgData.imageGenerated = true;
                            addMessage(`Voici l'image g√©n√©r√©e :`, 'bot', imgData);
                            
                            // Sauvegarder l'image dans la conversation
                            const conv = conversations.find(c => c.id === currentConversationId);
                            if (conv) {
                                let storedImageId = null;
                                let storedImageUrl = imgData.imageUrl;
                                let remoteImageId = null;

                                if (typeof imgData.imageUrl === 'string' && imgData.imageUrl.startsWith('data:image/')) {
                                    try {
                                        const userKey = getActiveUserKey();
                                        const blob = await dataUrlToBlob(imgData.imageUrl);
                                        storedImageId = await idbPutImageBlob(userKey, blob, blob.type, imgData.prompt || 'image');
                                        storedImageUrl = undefined;

                                        // Upload serveur (si mode Cloud + connect√©)
                                        if (getStorageMode() === 'cloud' && getAuthToken() && currentUser && currentUser.email) {
                                            const rid = makeRemoteImageId();
                                            const ok = await uploadChatImageToServer(rid, imgData.imageUrl);
                                            if (ok) remoteImageId = rid;
                                        }
                                    } catch (e) {
                                        // Fallback: conserver imageUrl
                                        storedImageId = null;
                                        storedImageUrl = imgData.imageUrl;
                                    }
                                }

                                conv.messages.push({
                                    user: '',
                                    bot: `Voici l'image g√©n√©r√©e :`,
                                    timestamp: Date.now(),
                                    imageId: storedImageId || undefined,
                                    imageUrl: storedImageUrl,
                                    remoteImageId: remoteImageId || undefined,
                                    imageGenerated: true,
                                    prompt: imgData.prompt,
                                    hiScore: 0,
                                    chrScore: 0
                                });
                                saveConversations();
                            }
                            
                            showToast('‚úÖ Image g√©n√©r√©e avec succ√®s !', 'success');
                        } else {
                            const errorText = await imgResponse.text();
                            console.error('‚ùå Erreur g√©n√©ration image:', imgResponse.status, errorText);
                            throw new Error(`Erreur ${imgResponse.status}`);
                        }
                    } catch (imgError) {
                        console.error('‚ùå Exception g√©n√©ration image:', imgError);
                        addMessage(`‚ùå D√©sol√©, la g√©n√©ration d'image a √©chou√©: ${imgError.message}`, 'bot');
                    }
                } else {
                    // Add bot message with metrics
                    addMessage(data.response || 'Pas de r√©ponse', 'bot', data);
                }
                
                // Update stats
                updateStats(data);
                
                // Save conversation
                await saveMessage(message, data);

                if (usedFreeOcr) {
                    // IMPORTANT: on ne supprime pas le cache OCR ici.
                    // Sinon l'OCR se re-d√©clenche √† chaque message et peut bloquer l'UI.
                    delete lastUploadedImageByConversation[currentConversationId];
                    delete lastUploadedImageNameByConversation[currentConversationId];
                }

            } catch (error) {
                hideTyping();
                addMessage(`Erreur: ${error.message}`, 'error');
                showToast('‚ùå Erreur de connexion', 'error');
            } finally {
                try {
                    document.removeEventListener('pointerdown', markInteractionOutside, true);
                    document.removeEventListener('focusin', markInteractionOutside, true);
                    window.removeEventListener('blur', markTabOrWindowLeft, true);
                    document.removeEventListener('visibilitychange', markVisibilityHidden, true);
                } catch (_) {}
                sendBtn.disabled = false;
                input.disabled = false;
                try {
                    if (!userInteractedOutsideChatInput && allowAutoRefocus) {
                        input.focus();
                    }
                } catch (_) {}
            }
        }

        function axilumNormalizeForIntent(str) {
            return String(str || '')
                .toLowerCase()
                .replace(/[‚Äô]/g, "'")
                .trim();
        }

        function axilumUserAsksForSources(str) {
            const s = axilumNormalizeForIntent(str);
            return /(\bsources?\b|\br[√©e]f[√©e]rences?\b|\bcitations?\b|\bciter\b|\bpreuve(s)?\b|\bjustifie\b|\bjustification\b|\bliens?\b|\burl\b|\barticles?\b)/i.test(s);
        }

        function axilumIsSmallTalk(str) {
            const s0 = axilumNormalizeForIntent(str);
            if (!s0) return false;

            const s = s0
                .replace(/[^a-z0-9√†-√ø\s'_-]/gi, ' ')
                .replace(/\s+/g, ' ')
                .trim();

            // Salutations / acquiescements courts
            if (/^(bonjour|salut|coucou|hello|hey|yo|bonsoir|bonne\s+nuit|merci|merci\s+beaucoup|ok|d\s*accord|√ßa\s+marche|ca\s+marche|super|cool)\b/i.test(s)) {
                return true;
            }

            // Au revoir / fin de conversation
            if (/^(au\s+revoir|a\s+plus|√†\s+plus|a\+|bye|ciao|√†\s+bient[o√¥]t|a\s+bient[o√¥]t|√†\s+demain|a\s+demain|√†\s+tout\s+√†\s+l'heure|a\s+tout\s+√†\s+l'heure|√†\s+tout\s+de\s+suite|a\s+tout\s+de\s+suite|bonne\s+journ[√©e]e|bonne\s+soir[√©e]e|bon\s+week-?end)\b/i.test(s)) {
                return true;
            }

            // Petites phrases sociales
            if (/(comment\s+√ßa\s+va|comment\s+ca\s+va|√ßa\s+va\s*\?|ca\s+va\s*\?|tu\s+vas\s+bien)/i.test(s)) {
                return true;
            }

            // Identit√© / nom de l'agent
            if (/(quel\s+est\s+ton\s+nom|tu\s+t'appelles\s+comment|qui\s+es\s*-?\s*tu|tu\s+es\s+qui)/i.test(s)) {
                return true;
            }

            return false;
        }

        function axilumIsQuestionnaire(str) {
            const s0 = axilumNormalizeForIntent(str);
            if (!s0) return false;
            const s = s0.replace(/\s+/g, ' ').trim();

            // Mot-cl√© explicite
            if (/\b(questionnaire|interview|sondage)\b/i.test(s)) return true;
            if (/(pose(-|\s)?moi\s+des\s+questions|pose\s+des\s+questions|je\s+vais\s+te\s+poser\s+des\s+questions)/i.test(s)) return true;

            // Plusieurs questions dans un m√™me message
            const qm = (s.match(/\?/g) || []).length;
            if (qm >= 2) return true;

            // Liste num√©rot√©e (1) / 1. / 1-
            if (/(^|\n)\s*\d{1,2}\s*[\)\.-]\s+/.test(String(str || ''))) return true;

            return false;
        }

        function axilumShouldShowWebSources(lastUserMessage) {
            const m = String(lastUserMessage || '').trim();
            if (!m) return true;
            if (axilumUserAsksForSources(m)) return true;
            if (axilumIsSmallTalk(m)) return false;
            if (axilumIsQuestionnaire(m)) return false;
            return true;
        }

        function addMessage(text, type, data = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-wrapper ${type}`;

            // Garder une trace du dernier message utilisateur pour gater l'affichage des sources (mode Wesh).
            try {
                if (type === 'user') {
                    window.__axilum_lastUserMessage = String(text || '').trim();
                }
            } catch (_) {}

            const isDetectorReport = type === 'bot' && data && data.detectorReport === true;

            // Helper minimal pour √©viter l'injection HTML (ex: rapport detector)
            function escapeHtml(str) {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            // Nettoyer le texte des m√©triques pour l'affichage
            let displayText = text;
            let ragSources = []; // Extraire sources RAG
            let ragSourcesStructured = []; // [{title,url}] si disponible
            let sourceUrlById = {}; // {'1': 'https://...'} pour rendre [S#] cliquable
            
            if (type === 'bot' && !isDetectorReport) {
                const allowSources = (typeof currentChatType !== 'undefined' && String(currentChatType) === 'web-search');
                const lastUserMsg = (typeof window !== 'undefined' && window.__axilum_lastUserMessage)
                    ? String(window.__axilum_lastUserMessage)
                    : '';
                const shouldShowSources = allowSources && axilumShouldShowWebSources(lastUserMsg);
                const shouldStripJsonMeta = (t) => {
                    const raw = String(t || '');
                    return (
                        /axilum_actions/i.test(raw)
                        || /```\s*json/i.test(raw)
                        || /(bloc\s*json|code\s*json|format\s*json)/i.test(raw)
                        || /g[√©e]n[√©e]r(?:er|e|ai|a|ons)[\s\S]{0,40}\bjson\b/i.test(raw)
                    );
                };

                // Extraire sources RAG (priorit√©: payload API data.sources)
                const isPlaceholderSource = (s) => {
                    const v = String(s || '').trim().toLowerCase();
                    return (
                        v === 'aucune source' ||
                        v === 'aucune source disponible' ||
                        v === 'aucune source trouv√©e' ||
                        v === 'aucune source trouv√©e via brave' ||
                        v === 'no source' ||
                        v === 'no sources' ||
                        v === 'no sources available' ||
                        v === 'no source available'
                    );
                };

                if (shouldShowSources && data && Array.isArray(data.sources) && data.sources.length > 0) {
                    ragSourcesStructured = data.sources
                        .filter(Boolean)
                        .map((s) => ({
                            title: s?.title ? String(s.title).trim() : '',
                            url: s?.url ? String(s.url).trim() : ''
                        }))
                        .filter(s => s.title || s.url)
                        .slice(0, 12);

                    // Construire le mapping [S#] -> URL (index 1-based)
                    sourceUrlById = {};
                    ragSourcesStructured.forEach((s, idx) => {
                        const id = String(idx + 1);
                        if (s.url) sourceUrlById[id] = s.url;
                    });

                    ragSources = data.sources
                        .slice(0, 12)
                        .map((s) => {
                            if (!s) return '';
                            const title = s.title ? String(s.title).trim() : '';
                            const url = s.url ? String(s.url).trim() : '';
                            if (title && url) return `${title} ‚Äî ${url}`;
                            return (url || title || '').trim();
                        })
                        .filter((s) => s && !isPlaceholderSource(s));
                } else if (shouldShowSources) {
                    // Fallback: parse depuis le texte si l'API ne fournit pas sources
                    const sourcesMatch = text.match(/üìö\s*Sources:\s*([^\n]+)/i);
                    if (sourcesMatch) {
                        ragSources = sourcesMatch[1]
                            .split(',')
                            .map(s => s.trim())
                            .filter(s => s && !isPlaceholderSource(s));
                    }
                } else {
                    ragSources = [];
                    ragSourcesStructured = [];
                    sourceUrlById = {};
                }

                // D√©doublonner
                if (ragSources.length > 1) {
                    ragSources = Array.from(new Set(ragSources));
                }
                
                // Retirer toutes les variations de m√©triques (HI/CHR/pourcentages)
                displayText = text
                    // Retirer "---" et tout ce qui suit (m√©triques compl√®tes)
                    .replace(/(^|\n)\s*---\s*\n(?=\s*(üìä|üìö|üí°|Sources\s*:))[\s\S]*/m, '')
                    // Retirer lignes avec emoji + HI/CHR
                    .replace(/\n*üìä.*?HI:.*?CHR:.*?\n*/gi, '')
                    // Retirer lignes HI: X% ‚Ä¢ CHR: Y%
                    .replace(/\n*HI:\s*[0-9.]+%.*?CHR:\s*[0-9.]+%.*?\n*/gi, '')
                    // Retirer lignes isol√©es de pourcentages
                    .replace(/\n*\d+\.\d+%\s*[‚Ä¢¬∑]\s*\d+\.\d+%.*?\n*/g, '')
                    // Retirer warnings et sources recommand√©es
                    .replace(/\n*‚ö†Ô∏è\s*Attention\s*:.*?$/gm, '')
                    .replace(/\n*Sources recommand√©es\s*:[\s\S]*/gi, '')
                    // Retirer la ligne "üìö Sources:" (les sources sont rendues s√©par√©ment)
                    .replace(/\n*üìö\s*Sources:\s*[^\n]*\n*/gi, '\n')
                        // Retirer la section "Sources :" (format Wesh) en fin de message pour √©viter duplication
                        .replace(/\n\s*Sources\s*:\s*[\s\S]*$/i, '')
                    .trim();

                if (shouldStripJsonMeta(text)) {
                    displayText = displayText
                        .split('\n')
                        .filter(line => !/(\bjson\b|bloc\s*json|code\s*json|format\s*json)/i.test(line))
                        .join('\n')
                        .trim();
                }
            }

            const now = new Date();
            const time = now.toLocaleTimeString(getLocale(), { hour: '2-digit', minute: '2-digit' });

            let avatarEmoji = type === 'user' ? 'üë§' : 'ü§ñ';
            let senderName = type === 'user' ? 'Vous' : 'Axilum AI';
            let avatarClass = type === 'user' ? 'user-avatar' : 'bot-avatar';

            // üé® V√©rifier si c'est une image g√©n√©r√©e
            let contentHTML = displayText;
            if (data && data.imageUrl && data.imageGenerated) {
                contentHTML = `
                    <div style="margin-bottom: 12px;">${displayText}</div>
                    <div style="position: relative; width: 100%; max-width: 512px;">
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(147, 51, 234, 0.05)); border-radius: 12px; padding: 80px; text-align: center; overflow: hidden; position: relative;">
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <div style="width: 60px; height: 60px; border: 4px solid transparent; border-top-color: #3B82F6; border-radius: 50%; animation: spin 0.8s linear infinite; box-shadow: 0 0 30px rgba(59, 130, 246, 0.6), 0 0 60px rgba(59, 130, 246, 0.3);"></div>
                            </div>
                            <style>
                                @keyframes spin {
                                    to { transform: rotate(360deg); }
                                }
                            </style>
                        </div>
                        <img src="${data.imageUrl}" 
                             alt="${data.prompt || 'Image g√©n√©r√©e'}" 
                             style="position: absolute; top: 0; left: 0; width: 100%; height: auto; display: block; cursor: pointer; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.5s ease;"
                             onload="this.style.opacity='1'; this.previousElementSibling.style.display='none';"
                             onerror="this.previousElementSibling.innerHTML='<div style=\\'padding:40px;text-align:center;\\'><div style=\\'font-size:48px;margin-bottom:12px;\\'>‚ùå</div><div style=\\'color:var(--text-secondary);\\'>Erreur de chargement</div></div>'"
                             onclick="window.open('${data.imageUrl}', '_blank')"
                             loading="eager">
                    </div>
                `;
            }

            // Pour les messages bot, rendre [S#] cliquable et afficher une liste compacte des sources (titres uniquement)
            if (type === 'bot' && !isDetectorReport && !(data && data.imageUrl && data.imageGenerated)) {
                const safe = escapeHtml(displayText);
                const linkified = safe.replace(/\[S(\d+)\]/g, (m, n) => {
                    const url = sourceUrlById[String(n)];
                    if (!url) return m;
                    return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: underline;">[S${n}]</a>`;
                });

                let compactSourcesHTML = '';
                if (ragSourcesStructured.length > 0) {
                    const lines = ragSourcesStructured.map((s, idx) => {
                        const id = idx + 1;
                        const title = s.title || s.url || '';
                        const url = s.url || '';
                        const sTag = url
                            ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: underline;">[S${id}]</a>`
                            : `[S${id}]`;
                        return `${sTag} ${escapeHtml(title)}`;
                    });
                    compactSourcesHTML = `\n\n<div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">Sources:\n${lines.join('\n')}</div>`;
                }

                contentHTML = `<div>${linkified}${compactSourcesHTML}</div>`;
            }

            // Rapport Hallucination Detector: pr√©server les sauts de ligne et √©viter le nettoyage UI
            if (isDetectorReport) {
                contentHTML = `<div style="white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word;">${escapeHtml(displayText)}</div>`;
            }

            messageWrapper.innerHTML = `
                <div class="message-header">
                    <div class="avatar ${avatarClass}">${avatarEmoji}</div>
                    <span class="message-sender">${senderName}</span>
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-content">${contentHTML}</div>
                ${ragSources.length > 0 ? `
                <div class="rag-sources" style="
                    margin-top: 12px;
                    padding: 10px 12px;
                    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(59, 130, 246, 0.05));
                    border-left: 3px solid #10B981;
                    border-radius: 8px;
                    font-size: 12px;
                    color: var(--text-secondary);
                ">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 6px; margin-bottom: 6px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            <span style="font-weight: 600; color: #10B981;">Sources RAG v√©rifi√©es</span>
                        </div>
                        <div class="metrics-icon-rag" style="cursor: pointer; opacity: 0.7; transition: opacity 0.2s;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                        </div>
                    </div>
                    <div style="color: var(--text-secondary); line-height: 1.5; word-break: break-all; overflow-wrap: break-word;">
                        ${(
                            ragSourcesStructured.length > 0
                                ? ragSourcesStructured.map((s) => {
                                    const title = s.title || s.url || '';
                                    const url = s.url || '';
                                    if (url) {
                                        return `‚Ä¢ <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: underline;">${escapeHtml(title)}</a> ‚Äî ${escapeHtml(url)}`;
                                    }
                                    return `‚Ä¢ ${escapeHtml(title)}`;
                                }).join('<br>')
                                : ragSources.map(s => `‚Ä¢ ${escapeHtml(s)}`).join('<br>')
                        )}
                    </div>
                </div>
                ` : ''}
            `;

            // üé® Add elegant metrics icon for bot messages
            if (type === 'bot' && data && !isDetectorReport) {
                console.log('üîç Debug - data:', {cached: data.cached, responseTime: data.responseTime, processingTime: data.processingTime, usage: data.usage});
                
                // Collecter toutes les m√©triques
                const metrics = {
                    performance: [],
                    quality: []
                };

                // Synchroniser le mod√®le affich√© avec le choix utilisateur (si backend silencieux)
                const selectedModelForUi = (typeof getSelectedAiModel === 'function') ? getSelectedAiModel() : null;
                if (selectedModelForUi) {
                    data.model = selectedModelForUi;
                }
                
                // M√©triques de performance
                if (data.cached === true) {
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>', 
                        label: (typeof t === 'function' ? t('metrics.label.cache') : 'Cache'), 
                        value: `${data.responseTime}ms`, 
                        color: '#10B981'
                    });
                } else if (data.responseTime) {
                    const timeInSec = (data.responseTime / 1000).toFixed(2);
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>', 
                        label: (typeof t === 'function' ? t('metrics.label.time') : 'Temps'), 
                        value: `${timeInSec}s`, 
                        color: '#3B82F6'
                    });
                } else if (data.processingTime) {
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>', 
                        label: (typeof t === 'function' ? t('metrics.label.time') : 'Temps'), 
                        value: data.processingTime, 
                        color: '#3B82F6'
                    });
                }
                
                if (data.tokensUsed || (data.usage && data.usage.total_tokens)) {
                    const tokens = data.tokensUsed || data.usage.total_tokens;
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2v20M2 12h20"/></svg>', 
                        label: (typeof t === 'function' ? t('metrics.label.tokens') : 'Tokens'), 
                        value: tokens, 
                        color: '#8B5CF6'
                    });
                }
                
                // Prompt tokens uniquement
                if (data.promptTokens) {
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>', 
                        label: (typeof t === 'function' ? t('metrics.label.prompt') : 'Prompt'), 
                        value: data.promptTokens, 
                        color: '#3B82F6'
                    });
                }
                
                // Provider et Model
                if (data.provider) {
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>', 
                        label: (typeof t === 'function' ? t('metrics.label.provider') : 'Provider'), 
                        value: data.provider, 
                        color: '#F59E0B'
                    });
                }
                
                if (data.model) {
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m5.196-13.196l-4.242 4.242m-5.908 5.908l-4.242 4.242m18.384-.001l-4.242-4.242m-5.908-5.908l-4.242-4.242"/></svg>', 
                        label: (typeof t === 'function' ? t('metrics.label.model') : 'Mod√®le'), 
                        value: data.model, 
                        color: '#8B5CF6'
                    });
                }
                
                // üß™ Architecture V2 indicator
                if (data.functionsUsed !== undefined || data.contextTokensEstimated !== undefined) {
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>', 
                        label: (typeof t === 'function' ? t('metrics.label.arch') : 'Archi'), 
                        value: 'V2 üöÄ', 
                        color: '#10B981'
                    });
                }
                
                // M√©triques de qualit√©
                
                // Priorit√© 1: Utiliser les propri√©t√©s directes du backend
                if (data.hallucinationIndex !== undefined && data.hallucinationIndex !== null) {
                    const hiValue = data.hallucinationIndex;
                    const color = hiValue < 15 ? '#10B981' : hiValue < 30 ? '#F59E0B' : '#EF4444';
                    metrics.quality.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>', 
                        label: 'HI', 
                        value: `${hiValue}%`, 
                        color: color
                    });
                }
                
                if (data.contextHistoryRatio !== undefined && data.contextHistoryRatio !== null) {
                    const chrValue = data.contextHistoryRatio;
                    const color = chrValue < 15 ? '#10B981' : chrValue < 30 ? '#F59E0B' : '#EF4444';
                    metrics.quality.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>', 
                        label: 'CHR', 
                        value: `${chrValue}%`, 
                        color: color
                    });
                }
                
                // Priorit√© 2: Fallback sur parsing du texte si propri√©t√©s absentes
                if (metrics.quality.length === 0 && data.response && data.response.includes('HI:')) {
                    const hiMatch = data.response.match(/HI: ([0-9.]+)%/);
                    const chrMatch = data.response.match(/CHR: ([0-9.]+)%/);
                    
                    if (hiMatch) {
                        const hiValue = parseFloat(hiMatch[1]);
                        const color = hiValue < 15 ? '#10B981' : hiValue < 30 ? '#F59E0B' : '#EF4444';
                        metrics.quality.push({
                            icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>', 
                            label: 'HI', 
                            value: `${hiValue}%`, 
                            color: color
                        });
                    }
                    
                    if (chrMatch) {
                        const chrValue = parseFloat(chrMatch[1]);
                        const color = chrValue < 15 ? '#10B981' : chrValue < 30 ? '#F59E0B' : '#EF4444';
                        metrics.quality.push({
                            icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>', 
                            label: 'CHR', 
                            value: `${chrValue}%`, 
                            color: color
                        });
                    }
                }
                
                // RAG Sources
                if (ragSources.length > 0) {
                    metrics.quality.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>', 
                        label: 'RAG', 
                        value: `${ragSources.length} source${ragSources.length > 1 ? 's' : ''}`, 
                        color: '#10B981',
                        details: ragSources.join(', ')
                    });
                } else if (data.rag_verification && data.rag_verification.relevant_facts_count > 0) {
                    metrics.quality.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>', 
                        label: 'RAG', 
                        value: `${data.rag_verification.relevant_facts_count} fait${data.rag_verification.relevant_facts_count > 1 ? 's' : ''}`, 
                        color: '#10B981'
                    });
                }
                
                // Stocker les m√©triques globalement pour le bouton inline
                if (metrics.performance.length > 0 || metrics.quality.length > 0) {
                    window.__currentMessageMetrics = metrics;
                } else {
                    window.__currentMessageMetrics = null;
                }
                
                // Cr√©er l'ic√¥ne √©l√©gante si des m√©triques existent
                if (metrics.performance.length > 0 || metrics.quality.length > 0) {
                    // Chercher d'abord le bouton dans le bloc RAG apr√®s l'ajout au DOM
                    setTimeout(() => {
                        const ragMetricsIcon = messageWrapper.querySelector('.metrics-icon-rag');
                        
                        if (ragMetricsIcon) {
                            // Si le bloc RAG existe avec son bouton, utiliser celui-ci
                            ragMetricsIcon.addEventListener('click', function(e) {
                                e.stopPropagation();
                                showMetricsModal(metrics);
                            });
                            ragMetricsIcon.style.opacity = '1'; // Rendre visible
                        } else {
                            // Sinon, ne rien faire - le bouton m√©triques sera ajout√© avec le TTS
                        }
                    }, 10);
                }
            }

            // üîä Ajouter bouton TTS inline dans le dernier √©l√©ment de texte
            if (type === 'bot' && displayText && displayText.length > 0) {
                // Attendre que le DOM soit mis √† jour
                setTimeout(() => {
                    const messageContent = messageWrapper.querySelector('.message-content');
                    if (messageContent) {
                        // Trouver le dernier √©l√©ment de texte (p, div, span, etc.)
                        const allElements = messageContent.querySelectorAll('p, div, span, li');
                        let lastTextElement = allElements.length > 0 ? allElements[allElements.length - 1] : messageContent;
                        
                        // Si aucun √©l√©ment trouv√©, utiliser directement le contenu
                        if (allElements.length === 0 && messageContent.childNodes.length > 0) {
                            // Chercher le dernier n≈ìud de texte
                            for (let i = messageContent.childNodes.length - 1; i >= 0; i--) {
                                if (messageContent.childNodes[i].nodeType === Node.TEXT_NODE || 
                                    messageContent.childNodes[i].nodeType === Node.ELEMENT_NODE) {
                                    lastTextElement = messageContent.childNodes[i].nodeType === Node.ELEMENT_NODE 
                                        ? messageContent.childNodes[i] 
                                        : messageContent;
                                    break;
                                }
                            }
                        }
                        
                        // Cr√©er le bouton TTS
                        const ttsButton = document.createElement('button');
                        ttsButton.className = 'tts-button-inline';
                        ttsButton.dataset.speaking = 'false';
                        ttsButton.dataset.text = displayText;
                        ttsButton.title = '√âcouter ce message';
                        ttsButton.setAttribute('aria-label', '√âcouter ce message');
                        
                        ttsButton.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                            </svg>
                        `;
                        
                        // Ajouter les √©v√©nements
                        ttsButton.addEventListener('mouseenter', function() {
                            this.style.opacity = '1';
                            this.style.transform = 'scale(1.15)';
                            this.style.color = 'var(--accent)';
                        });
                        
                        ttsButton.addEventListener('mouseleave', function() {
                            this.style.opacity = '0.6';
                            this.style.transform = 'scale(1)';
                            this.style.color = 'var(--text-secondary)';
                        });
                        
                        ttsButton.addEventListener('click', function(e) {
                            e.stopPropagation();
                            toggleTTS(this);
                        });
                        
                        // Cr√©er un conteneur pour les boutons d'action
                        const actionsContainer = document.createElement('div');
                        actionsContainer.className = 'message-actions';
                        
                        // Ajouter le bouton TTS
                        actionsContainer.appendChild(ttsButton);
                        
                        // Cr√©er et ajouter le bouton m√©triques si les m√©triques existent
                        if (window.__currentMessageMetrics) {
                            const metricsButton = document.createElement('button');
                            metricsButton.type = 'button';
                            metricsButton.className = 'metrics-icon';
                            metricsButton.title = 'M√©triques de r√©ponse';
                            metricsButton.setAttribute('aria-label', 'M√©triques de r√©ponse');
                            metricsButton.innerHTML = `
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4M12 8h.01"/>
                                </svg>
                            `;
                            
                            metricsButton.addEventListener('click', function(e) {
                                e.stopPropagation();
                                showMetricsModal(window.__currentMessageMetrics);
                            });
                            
                            actionsContainer.appendChild(metricsButton);
                        }
                        
                        // Ins√©rer le conteneur apr√®s le message-content
                        messageContent.parentNode.insertBefore(actionsContainer, messageContent.nextSibling);
                    }
                }, 10);
            }

            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // üé® Afficher modal √©l√©gant avec m√©triques
        function showMetricsModal(metrics) {
            // Supprimer modal existant si pr√©sent
            const existing = document.getElementById('metricsModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'metricsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 30000; animation: fadeIn 0.2s ease;';
            
            let performanceHTML = '';
            if (metrics.performance.length > 0) {
                const perfTitle = (typeof t === 'function' ? t('metrics.section.performance') : 'Performance');
                performanceHTML = `<div style="margin-bottom: 16px;"><h4 style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>${perfTitle}</h4>`;
                metrics.performance.forEach(m => {
                    performanceHTML += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 6px; transition: all 0.2s;">
                            <span style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary); font-size: 13px;">
                                <span style="color: ${m.color}; display: flex; align-items: center;">${m.icon}</span>
                                ${m.label}
                            </span>
                            <span style="font-weight: 600; color: ${m.color}; font-size: 14px;">${m.value}</span>
                        </div>
                    `;
                });
                performanceHTML += '</div>';
            }
            
            let qualityHTML = '';
            if (metrics.quality.length > 0) {
                const qualityTitle = (typeof t === 'function' ? t('metrics.section.quality') : 'Qualit√©');
                qualityHTML = `<div><h4 style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>${qualityTitle}</h4>`;
                metrics.quality.forEach(m => {
                    qualityHTML += `
                        <div style="display: flex; ${m.details ? 'flex-direction: column; align-items: flex-start;' : 'align-items: center; justify-content: space-between;'} padding: 10px 14px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 6px; transition: all 0.2s;">
                            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                <span style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary); font-size: 13px;">
                                    <span style="color: ${m.color}; display: flex; align-items: center;">${m.icon}</span>
                                    ${m.label}
                                </span>
                                <span style="font-weight: 600; color: ${m.color}; font-size: 14px;">${m.value}</span>
                            </div>
                            ${m.details ? `
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color); font-size: 11px; color: var(--text-secondary); line-height: 1.6; width: 100%; word-break: break-all; overflow-wrap: break-word;">
                                    ${m.details}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                qualityHTML += '</div>';
            }
            
            modal.innerHTML = `
                <div style="background: var(--bg-primary); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; max-height: 90vh; max-height: 90dvh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; position: sticky; top: -24px; background: var(--bg-primary); padding: 24px 0 12px 0; margin: -24px -24px 20px -24px; padding: 24px 24px 12px 24px; z-index: 1;">
                        <h3 style="margin: 0; color: var(--text-primary); font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18"/>
                                <path d="M18 17V9"/>
                                <path d="M13 17V5"/>
                                <path d="M8 17v-3"/>
                            </svg>
                            ${(typeof t === 'function' ? t('metrics.title') : 'M√©triques de r√©ponse')}
                        </h3>
                        <button onclick="document.getElementById('metricsModal').remove()" style="background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    ${performanceHTML}
                    ${qualityHTML}
                </div>
            `;
            
            // Fermer au clic sur le fond
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Hover sur bouton fermer
            const closeBtn = modal.querySelector('button');
            closeBtn.addEventListener('mouseenter', function() {
                this.style.background = 'var(--bg-secondary)';
            });
            closeBtn.addEventListener('mouseleave', function() {
                this.style.background = 'none';
            });
            
            document.body.appendChild(modal);
        }

        function showTyping() {
            const chatMessages = document.getElementById('chatMessages');
            const typing = document.createElement('div');
            typing.id = 'typing';
            typing.className = 'message-wrapper bot';
            typing.innerHTML = `
                <div class="message-header">
                    <div class="avatar bot-avatar">ü§ñ</div>
                    <span class="message-sender">Axilum AI</span>
                    <span class="message-time" style="color: var(--text-secondary); font-size: 12px;">Analyse en cours...</span>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
                <div style="height: 3px; background: linear-gradient(90deg, #3B82F6 0%, #3B82F6 50%, transparent 50%); background-size: 200% 100%; animation: loadingBar 1.5s linear infinite; border-radius: 2px; margin-top: 8px;"></div>
            `;
            chatMessages.appendChild(typing);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function attachFile() {
            document.getElementById('fileInput').click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileType = file.type;
            const isImage = fileType.startsWith('image/');
            const isText = fileType === 'text/plain';
            const isPDF = fileType === 'application/pdf';
            const lowerName = String(file.name || '').toLowerCase();
            const isCSV = fileType === 'text/csv' || lowerName.endsWith('.csv');
            const isExcel = fileType === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                || fileType === 'application/vnd.ms-excel'
                || lowerName.endsWith('.xlsx')
                || lowerName.endsWith('.xls');
            
            showToast(`üìé Fichier re√ßu: ${file.name}`, 'info');

            const persistAndRenderFileAttachment = async ({ subtitle = '', extractedText = null } = {}) => {
                // Option: sauvegarde persistante (Cloud) + fallback objectUrl (session)
                let remoteFileId = null;
                try {
                    const storageMode = getStorageMode();
                    let wantsCloud = storageMode === 'cloud';
                    if (storageMode === 'ask') {
                        wantsCloud = confirm(`Sauvegarder ce fichier dans le cloud s√©curis√© (r√©-ouverture m√™me apr√®s fermeture) ?\n\nOK = Oui (Cloud)\nAnnuler = Non (lien session uniquement)\n\n${file.name}`);
                    }

                    if (wantsCloud) {
                        if (getAuthToken() && currentUser && currentUser.email) {
                            remoteFileId = makeRemoteFileId();
                            try { showToast('‚òÅÔ∏è Sauvegarde du fichier‚Ä¶', 'info'); } catch (_) {}
                            const ok = await uploadChatFileToServer(remoteFileId, file);
                            if (!ok) remoteFileId = null;
                        } else {
                            try { showToast('üîí Connectez-vous pour sauvegarder (Cloud). Lien session utilis√©.', 'info'); } catch (_) {}
                        }
                    }
                } catch (_) {
                    remoteFileId = null;
                }

                let objectUrl = '';
                if (!remoteFileId) {
                    try {
                        const prev = pendingUploadedDocByConversation[currentConversationId];
                        if (prev && prev.objectUrl) {
                            try { URL.revokeObjectURL(prev.objectUrl); } catch (_) {}
                        }
                        objectUrl = trackObjectUrl(URL.createObjectURL(file));
                    } catch (_) {
                        objectUrl = '';
                    }
                }

                // Afficher le lien compact
                try {
                    appendUploadedFileCardToChat({
                        fileName: file.name,
                        objectUrl,
                        remoteFileId,
                        mimeType: file.type,
                        sizeBytes: file.size,
                        subtitle: subtitle || `${humanFileSize(file.size)} ‚Ä¢ ${file.type || 'application/octet-stream'}`
                    });
                } catch (_) {}

                // Persister l'attachement dans la conversation (r√©ouverture ult√©rieure)
                try {
                    const conv = conversations.find(c => c.id === currentConversationId);
                    if (conv) {
                        conv.messages.push({
                            timestamp: Date.now(),
                            file: {
                                name: file.name,
                                mimeType: file.type,
                                sizeBytes: file.size,
                                remoteFileId: remoteFileId || undefined
                            }
                        });
                        if (conv.messages.length === 1) {
                            conv.title = String(file.name || 'Fichier').substring(0, 30) + (String(file.name || '').length > 30 ? '...' : '');
                        }
                        saveConversations();
                        loadConversations();
                    }
                } catch (_) {}

                // Optionnel: stocker le texte extrait pour injection ONE-SHOT + indexation
                if (typeof extractedText === 'string' && extractedText.length) {
                    try {
                        pendingUploadedDocByConversation[currentConversationId] = {
                            fileName: file.name,
                            mimeType: file.type,
                            extractedText,
                            objectUrl,
                            remoteFileId,
                            createdAt: Date.now()
                        };
                    } catch (_) {}
                }

                return { remoteFileId, objectUrl };
            };
            
            try {
                if (isImage) {
                    // Lire l'image en base64
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64 = e.target.result;

                        // Persister l'image en Blob dans IndexedDB (√©vite base64 dans conversations)
                        let persistedImageId = null;
                        try {
                            const userKey = getActiveUserKey();
                            persistedImageId = await idbPutImageBlob(userKey, file, file.type, file.name);
                        } catch (idbErr) {
                            console.warn('‚ö†Ô∏è Sauvegarde image IndexedDB √©chou√©e:', idbErr);
                        }

                        // M√©moriser la derni√®re image pour permettre les questions Vision
                        lastUploadedImageByConversation[currentConversationId] = base64;
                        lastUploadedImageNameByConversation[currentConversationId] = file.name;

                        // üìö Auto-indexation (OCR local) si recherche docs activ√©e
                        try {
                            const token = (typeof getAuthToken === 'function') ? getAuthToken() : null;
                            if (token && typeof getDocsSearchEnabled === 'function' && getDocsSearchEnabled()) {
                                (async () => {
                                    try {
                                        showToast('üìÑ OCR (pour indexation)‚Ä¶', 'info');
                                        const ocrText = await withTimeout(
                                            extractTextFromImageBase64(base64),
                                            30000,
                                            'OCR trop long'
                                        );
                                        await maybeAutoIndexUploadedText({ fileName: file.name, text: ocrText, source: 'image-ocr' });
                                    } catch (_) {
                                        // OCR peut √©chouer selon la qualit√©
                                    }
                                })();
                            }
                        } catch (_) {}

                        // R√©initialiser le cache OCR pour cette nouvelle image
                        delete lastUploadedOcrTextByConversation[currentConversationId];
                        delete lastUploadedOcrImageSigByConversation[currentConversationId];
                        delete visionProPromoShownByConversation[currentConversationId];

                        // Upload serveur (optionnel) selon le mode de stockage
                        let remoteImageId = null;
                        const storageMode = getStorageMode();
                        let wantsCloud = storageMode === 'cloud';
                        if (storageMode === 'ask') {
                            wantsCloud = confirm("Stocker cette image dans le cloud s√©curis√© (compte requis) ?\n\nOK = Cloud\nAnnuler = Local (cet appareil)");
                        }

                        if (wantsCloud) {
                            if (getAuthToken() && currentUser && currentUser.email) {
                                remoteImageId = makeRemoteImageId();
                                const ok = await uploadChatImageToServer(remoteImageId, base64);
                                if (!ok) remoteImageId = null;
                            } else {
                                showToast('üîí Connectez-vous pour activer le stockage Cloud. Stockage local utilis√©.', 'info');
                            }
                        }
                        
                        // Afficher l'image directement dans le message utilisateur (style ChatGPT/Gemini)
                        const chatMessages = document.getElementById('chatMessages');
                        const messageWrapper = document.createElement('div');
                        messageWrapper.className = 'message-wrapper user image-message';
                        
                        const now = new Date();
                        const time = now.toLocaleTimeString(getLocale(), { hour: '2-digit', minute: '2-digit' });
                        
                        messageWrapper.innerHTML = `
                            <div class="message-header">
                                <div class="avatar user-avatar">üë§</div>
                                <span class="message-sender">Vous</span>
                                <span class="message-time">${time}</span>
                            </div>
                            <div class="message-content" style="max-width: 400px;">
                                <img src="${base64}" 
                                     alt="${file.name}" 
                                     style="width: 100%; height: auto; border-radius: 12px; cursor: pointer; display: block; margin-bottom: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                     onclick="window.open('${base64}', '_blank')"
                                     loading="eager">
                                <div class="chat-image-caption">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                        <circle cx="12" cy="13" r="4"/>
                                    </svg>
                                    <span>${file.name}</span>
                                </div>
                            </div>
                        `;
                        
                        chatMessages.appendChild(messageWrapper);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        
                        // R√©activer l'analyse uniquement pour le plan PRO
                        const currentPlan = localStorage.getItem('selectedPlan') || 'FREE';
                        if (currentPlan === 'PRO' || currentPlan === 'ENTERPRISE') {
                            const analyzeEndpoint = '/api/analyze-image-pro';
                            showToast('üîç Analyse avec Azure Vision (PRO)...', 'info');
                            showTyping();
                            try {
                                const imageSig = String(base64.length);
                                const response = await withTimeout(fetch(analyzeEndpoint, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        imageBase64: base64,
                                        question: 'D√©cris cette image en d√©tail. Que vois-tu ?'
                                    })
                                }), 45000, 'Analyse image trop longue (PRO)');
                                const analysisData = await response.json().catch(() => ({ analysis: 'R√©ponse non format√©e.' }));
                                hideTyping();
                                if (response.ok) {
                                    const provider = analysisData.provider || 'Azure Computer Vision';
                                    const analysisMessage = `${analysisData.analysis}\n\n_Analys√© par ${provider}_`;
                                    addMessage(analysisMessage, 'bot');
                                    const conv = conversations.find(c => c.id === currentConversationId);
                                    if (conv) {
                                        conv.messages.push({
                                            user: `üì∏ ${file.name}`,
                                            bot: analysisMessage,
                                            timestamp: Date.now(),
                                            imageId: persistedImageId || undefined,
                                            imageUrl: persistedImageId ? undefined : base64,
                                            remoteImageId: remoteImageId || undefined,
                                            hiScore: 0,
                                            chrScore: 0
                                        });
                                        saveConversations();
                                    }

                                    // Cache Vision PRO pour les messages suivants
                                    lastUploadedVisionTextByConversation[currentConversationId] = analysisData.analysis || '';
                                    lastUploadedVisionImageSigByConversation[currentConversationId] = imageSig;

                                    showToast('‚úÖ Image analys√©e (PRO)', 'success');
                                } else {
                                    addMessage(`‚ùå √âchec analyse (PRO): ${analysisData.error || 'Erreur inconnue'}`, 'bot');
                                    showToast('‚ùå Erreur d\'analyse (PRO)', 'error');
                                }
                            } catch (err) {
                                hideTyping();
                                const isTimeout = err && err.name === 'TimeoutError';
                                addMessage(isTimeout ? '‚ùå Analyse image (PRO) : d√©lai d√©pass√©. R√©essayez avec une image plus l√©g√®re.' : `‚ùå Erreur r√©seau (PRO): ${err.message}`, 'bot');
                                showToast(isTimeout ? '‚è±Ô∏è Analyse trop longue (PRO)' : '‚ùå Erreur r√©seau (PRO)', 'error');
                            }
                        } else {
                            // FREE: afficher message informatif
                            addMessage("üìå Image re√ßue ! Vous pouvez me poser des questions dessus.\n\nüí° En mode PRO, l'image serait automatiquement analys√©e par Azure Vision.", 'bot');
                            const conv = conversations.find(c => c.id === currentConversationId);
                            if (conv) {
                                conv.messages.push({
                                    user: `üì∏ ${file.name}`,
                                    bot: "Image re√ßue (mode FREE)",
                                    timestamp: Date.now(),
                                    imageId: persistedImageId || undefined,
                                    imageUrl: persistedImageId ? undefined : base64,
                                    remoteImageId: remoteImageId || undefined,
                                    hiScore: 0,
                                    chrScore: 0
                                });
                                saveConversations();
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                    
                } else if (isText) {
                    // Lire le fichier texte + cr√©er un lien persistant
                    const text = await file.text();
                    await persistAndRenderFileAttachment({
                        subtitle: `${humanFileSize(file.size)} ‚Ä¢ texte`,
                        extractedText: text
                    });

                    const input = document.getElementById('userInput');
                    if (input) {
                        input.value = `Contenu du fichier ${file.name}:\n\n${String(text || '').substring(0, 3000)}${text.length > 3000 ? '...' : ''}`;
                    }
                    showToast('‚úÖ Fichier texte charg√©', 'success');

                    // Auto-indexation (si recherche docs activ√©e)
                    try { await maybeAutoIndexUploadedText({ fileName: file.name, text, source: 'text' }); } catch (_) {}

                } else if (isPDF) {
                    showToast('üìÑ PDF d√©tect√© - extraction du texte...', 'info');
                    try {
                        // Charger pdf.js via CDN si n√©cessaire
                        if (!window.pdfjsLib) {
                            const script = document.createElement('script');
                            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                            script.crossOrigin = 'anonymous';
                            document.body.appendChild(script);
                            await new Promise(resolve => { script.onload = resolve; });
                        }
                        
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const pdfData = new Uint8Array(e.target.result);
                            window['pdfjsLib'].GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                            const pdf = await window['pdfjsLib'].getDocument({ data: pdfData }).promise;
                            let fullText = '';
                            for (let pageNum = 1; pageNum <= Math.min(pdf.numPages, 10); pageNum++) {
                                const page = await pdf.getPage(pageNum);
                                const content = await page.getTextContent();
                                const strings = content.items.map(item => item.str);
                                fullText += strings.join(' ') + '\n\n';
                            }
                            // Option: sauvegarde persistante (comme ChatGPT/Gemini) via Azure Blob (chat-files)
                            let remoteFileId = null;
                            try {
                                const storageMode = getStorageMode();
                                let wantsCloud = storageMode === 'cloud';
                                if (storageMode === 'ask') {
                                    wantsCloud = confirm("Sauvegarder ce PDF dans le cloud s√©curis√© (r√©-ouverture m√™me apr√®s fermeture) ?\n\nOK = Oui (Cloud)\nAnnuler = Non (lien session uniquement)");
                                }

                                if (wantsCloud) {
                                    if (getAuthToken() && currentUser && currentUser.email) {
                                        remoteFileId = makeRemoteFileId();
                                        try { showToast('‚òÅÔ∏è Sauvegarde du PDF‚Ä¶', 'info'); } catch (_) {}
                                        const ok = await uploadChatFileToServer(remoteFileId, file);
                                        if (!ok) remoteFileId = null;
                                    } else {
                                        try { showToast('üîí Connectez-vous pour sauvegarder (Cloud). Lien session utilis√©.', 'info'); } catch (_) {}
                                    }
                                }
                            } catch (_) {
                                remoteFileId = null;
                            }

                            // Fallback: lien session (object URL)
                            let objectUrl = '';
                            if (!remoteFileId) {
                                try {
                                    const prev = pendingUploadedDocByConversation[currentConversationId];
                                    if (prev && prev.objectUrl) {
                                        try { URL.revokeObjectURL(prev.objectUrl); } catch (_) {}
                                    }
                                    objectUrl = trackObjectUrl(URL.createObjectURL(file));
                                } catch (_) {
                                    objectUrl = '';
                                }
                            }

                            // Afficher une carte fichier compacte (style ChatGPT/Gemini)
                            appendUploadedFileCardToChat({
                                fileName: file.name,
                                objectUrl,
                                remoteFileId,
                                mimeType: file.type,
                                sizeBytes: file.size,
                                subtitle: `${pdf.numPages} page(s) ‚Ä¢ ${humanFileSize(file.size)}`
                            });

                            // Persister l'attachement fichier dans la conversation (pour r√©ouvrir plus tard)
                            try {
                                const conv = conversations.find(c => c.id === currentConversationId);
                                if (conv) {
                                    conv.messages.push({
                                        timestamp: Date.now(),
                                        file: {
                                            name: file.name,
                                            mimeType: file.type,
                                            sizeBytes: file.size,
                                            remoteFileId: remoteFileId || undefined
                                        }
                                    });
                                    if (conv.messages.length === 1) {
                                        conv.title = String(file.name || 'Fichier').substring(0, 30) + (String(file.name || '').length > 30 ? '...' : '');
                                    }
                                    saveConversations();
                                    loadConversations();
                                }
                            } catch (_) {}

                            // Stocker le texte extrait pour l'envoyer UNE fois au backend si besoin
                            pendingUploadedDocByConversation[currentConversationId] = {
                                fileName: file.name,
                                mimeType: file.type,
                                extractedText: fullText,
                                objectUrl,
                                remoteFileId,
                                createdAt: Date.now()
                            };

                            // Ne pas injecter le texte complet dans la bulle/textarea.
                            // On met une invite courte, l'utilisateur peut poser sa question.
                            const input = document.getElementById('userInput');
                            if (input) {
                                input.value = `J'ai upload√© un PDF : ${file.name}. Peux-tu l'analyser ?`;
                                try { adjustTextareaHeight(); } catch (_) {}
                            }

                            showToast('‚úÖ PDF pr√™t', 'success');

                            // Auto-indexation (si recherche docs activ√©e)
                            try { await maybeAutoIndexUploadedText({ fileName: file.name, text: fullText, source: 'pdf' }); } catch (_) {}
                        };
                        reader.readAsArrayBuffer(file);
                    } catch (e) {
                        console.error('PDF extraction error:', e);
                        const input = document.getElementById('userInput');
                        input.value = `J'ai upload√© un PDF : ${file.name}. Peux-tu m'aider √† l'analyser ?`;
                        showToast('‚ùå √âchec extraction PDF - Aper√ßu non disponible', 'error');
                    }
                } else if (isCSV || isExcel) {
                    showToast(isCSV ? 'üìä CSV d√©tect√© - pr√©paration...' : 'üìä Excel d√©tect√© - lecture du contenu...', 'info');
                    try {
                        const input = document.getElementById('userInput');
                        if (!input) throw new Error('Zone de saisie introuvable');

                        if (isCSV) {
                            const text = await file.text();
                            await persistAndRenderFileAttachment({
                                subtitle: `${humanFileSize(file.size)} ‚Ä¢ CSV`,
                                extractedText: text
                            });
                            const preview = String(text || '').trim().substring(0, 5000);
                            input.value = `Contenu du CSV ${file.name} (aper√ßu):\n\n${preview}${text.length > 5000 ? '\n\n...' : ''}`;
                            showToast('‚úÖ CSV charg√©', 'success');

                            // Auto-indexation (si recherche docs activ√©e)
                            try { await maybeAutoIndexUploadedText({ fileName: file.name, text, source: 'csv' }); } catch (_) {}
                            return;
                        }

                        // Charger SheetJS via CDN si n√©cessaire
                        if (!window.XLSX) {
                            const script = document.createElement('script');
                            script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
                            script.crossOrigin = 'anonymous';
                            document.body.appendChild(script);
                            await new Promise(resolve => { script.onload = resolve; });
                        }
                        if (!window.XLSX) throw new Error('Biblioth√®que Excel (XLSX) indisponible');

                        const buffer = await file.arrayBuffer();
                        const wb = window.XLSX.read(buffer, { type: 'array' });
                        const firstSheetName = (wb && wb.SheetNames && wb.SheetNames[0]) ? wb.SheetNames[0] : null;
                        if (!firstSheetName) throw new Error('Aucune feuille d√©tect√©e dans ce fichier');

                        const sheet = wb.Sheets[firstSheetName];
                        const csv = window.XLSX.utils.sheet_to_csv(sheet);

                        await persistAndRenderFileAttachment({
                            subtitle: `${humanFileSize(file.size)} ‚Ä¢ Excel`,
                            extractedText: csv
                        });

                        // Extraire aussi en tableau (header:1) pour alimenter le contexte de l'agent Excel
                        let jsonData = [];
                        try {
                            jsonData = window.XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                        } catch (_) {
                            jsonData = [];
                        }

                        const convId = currentConversationId;
                        const shouldAutoReport = !!(convId && pendingExcelReportByConversation && pendingExcelReportByConversation[convId]);

                        if (shouldAutoReport) {
                            // Alimenter le module Excel (contexte) sans ouvrir la page Excel Expert
                            try {
                                excelCurrentFile = file;
                                if (Array.isArray(jsonData) && jsonData.length > 0) {
                                    excelColumns = Array.isArray(jsonData[0]) ? jsonData[0].map(v => String(v ?? '')) : [];
                                    excelSheetData = jsonData.slice(1).map(r => Array.isArray(r) ? r : []);
                                } else {
                                    excelColumns = [];
                                    excelSheetData = [];
                                }
                            } catch (_) {
                                // Si les variables Excel ne sont pas accessibles, on continue quand m√™me.
                            }

                            showToast(t('excelReport.processingToast'), 'info');
                            await runExcelReportFromUploadedFile();

                            // Auto-indexation (si recherche docs activ√©e)
                            try { await maybeAutoIndexUploadedText({ fileName: file.name, text: csv, source: 'excel' }); } catch (_) {}
                            return;
                        }

                        const preview = String(csv || '').trim().substring(0, 5000);
                        input.value = `Contenu Excel ${file.name} ‚Äî Feuille: ${firstSheetName} (aper√ßu CSV):\n\n${preview}${csv.length > 5000 ? '\n\n...' : ''}`;
                        showToast('‚úÖ Excel charg√© (aper√ßu pr√™t)', 'success');

                        // Auto-indexation (si recherche docs activ√©e)
                        try { await maybeAutoIndexUploadedText({ fileName: file.name, text: csv, source: 'excel' }); } catch (_) {}
                    } catch (e) {
                        console.error('Excel/CSV import error:', e);
                        const input = document.getElementById('userInput');
                        if (input) {
                            input.value = `J'ai upload√© un fichier ${file.name}. Peux-tu l'analyser ?`;
                        }
                        showToast('‚ùå √âchec lecture Excel/CSV', 'error');

                        // Si on √©tait dans le workflow auto-report, nettoyer l'√©tat pour √©viter de rester bloqu√©.
                        try {
                            const convId = currentConversationId;
                            if (convId && pendingExcelReportByConversation && pendingExcelReportByConversation[convId]) {
                                delete pendingExcelReportByConversation[convId];
                                delete excelReportRestoreChatTypeByConversation[convId];
                            }
                        } catch (_) {}
                    }
                } else {
                    // Autres types (doc/docx/etc): lien persistant + invite courte
                    await persistAndRenderFileAttachment({
                        subtitle: `${humanFileSize(file.size)} ‚Ä¢ ${file.type || 'fichier'}`
                    });

                    const input = document.getElementById('userInput');
                    if (input) {
                        input.value = `J'ai upload√© un fichier : ${file.name}. Peux-tu l'analyser ?`;
                        try { adjustTextareaHeight(); } catch (_) {}
                    }

                    showToast('‚úÖ Fichier ajout√©', 'success');
                }
                
            } catch (error) {
                showToast(`‚ùå Erreur: ${error.message}`, 'error');
            }
            
            // Reset input
            event.target.value = '';
        }

        function startVoiceInput() {
            if (!recognition) {
                showToast('‚ùå Reconnaissance vocale non support√©e', 'error');
                return;
            }

            if (isRecording) {
                recognition.stop();
                isRecording = false;
                showToast('‚è∏Ô∏è Enregistrement arr√™t√©', '');
            } else {
                recognition.start();
                isRecording = true;
                showToast('üé§ En cours d\'enregistrement...', 'success');
            }
        }

        function saveConversations() {
            const userKey = getActiveUserKey();
            // Persister en IndexedDB (ne bloque pas l'UI)
            idbSetKv(userKey, 'conversations', conversations)
                .catch(e => {
                    console.warn('‚ö†Ô∏è Sauvegarde IndexedDB √©chou√©e, fallback localStorage:', e);
                    try {
                        setHRData('conversations', conversations);
                    } catch (_) {
                        // Ignorer
                    }
                });
        }

        // üìÖ SYST√àME TO DO - Gestion des t√¢ches et √©v√©nements
        
        function saveTasks() {
            saveTasksInternal(false);
        }

        let todoTasksSyncTimer = null;

        function isTodoOverlayOpen() {
            return Boolean(document.getElementById('officeProOverlay'));
        }

        function saveTasksInternal(skipSync) {
            try {
                localStorage.setItem(getTodoTasksStorageKey(), JSON.stringify(userTasks));
            } catch (e) {
                console.warn('‚ö†Ô∏è Sauvegarde t√¢ches √©chou√©e:', e);
            }

            // Sync serveur debounc√©e pour √©viter les √©crasements (et √©viter trop d'appels)
            if (!skipSync && isTodoOverlayOpen()) {
                if (todoTasksSyncTimer) clearTimeout(todoTasksSyncTimer);
                todoTasksSyncTimer = setTimeout(() => {
                    syncTasksToServer();
                }, 800);
            }
        }

        function normalizeTodoId(value) {
            if (value === null || value === undefined) return '';
            return String(value);
        }

        function findTaskById(taskId) {
            const id = normalizeTodoId(taskId);
            return userTasks.find(t => normalizeTodoId(t && t.id) === id) || null;
        }

        function normalizeTodoCategoryKey(cat) {
            const raw = String(cat || '').trim().toLowerCase();
            try {
                return raw.normalize('NFD').replace(/\p{Diacritic}/gu, '');
            } catch (_) {
                return raw;
            }
        }

        function getTodoCategoryLabel(cat) {
            const key = normalizeTodoCategoryKey(cat);
            if (key === 'general') return t('todo.category.other');
            if (key === 'travail' || key === 'work') return t('todo.category.work');
            if (key === 'personnel' || key === 'personal') return t('todo.category.personal');
            if (key === 'etudes' || key === 'studies') return t('todo.category.studies');
            if (key === 'voyage' || key === 'travel') return t('todo.category.travel');
            if (key === 'sport') return t('todo.category.sport');
            if (key === 'sante' || key === 'health') return t('todo.category.health');
            if (key === 'autre' || key === 'other') return t('todo.category.other');
            return String(cat || '').trim() || t('todo.category.other');
        }

        // Ajouter une t√¢che (helper, utilis√© par Agent ToDo + fallback)
        function addTask(title, dueDate = null, priority = 'medium', category = 'Autre', projectId = null, description = '') {
            const cleanTitle = String(title || '').trim();
            if (!cleanTitle) return null;

            let prio = String(priority || 'medium').toLowerCase();
            if (prio === 'urgent' || prio === 'high' || prio === 'haute') prio = 'high';
            else if (prio === 'low' || prio === 'basse') prio = 'low';
            else prio = 'medium';

            const task = {
                id: normalizeTodoId(Date.now()) + Math.random().toString(36).slice(2, 8),
                title: cleanTitle,
                description: String(description || ''),
                priority: prio,
                dueDate: dueDate || null,
                category: category || 'Autre',
                completed: false,
                inProgress: false,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                subtasks: [],
                notifyEnabled: false,
                notificationEnabled: false,
                projectId: projectId != null ? projectId : null,
                progress: 0,
                userId: currentUser?.email || 'guest'
            };

            userTasks.push(task);
            saveTasks();
            return task;
        }

        // Marquer une t√¢che comme termin√©e (helper legacy)
        function completeTask(taskId) {
            const task = findTaskById(taskId);
            if (!task) return false;
            task.completed = true;
            task.inProgress = false;
            task.status = 'completed';
            task.completedAt = new Date().toISOString();
            task.updatedAt = new Date().toISOString();
            saveTasks();
            if (task.projectId != null) updateProjectProgress(task.projectId);
            return true;
        }

        // Supprimer une t√¢che
        function deleteTask(taskId) {
            const id = normalizeTodoId(taskId);
            userTasks = userTasks.filter(t => normalizeTodoId(t && t.id) !== id);
            saveTasks();
        }
        
        // Obtenir t√¢ches du jour
        function getTodayTasks() {
            const today = new Date().toISOString().split('T')[0];
            return userTasks.filter(t => {
                if (!t.dueDate) return false;
                const taskDate = new Date(t.dueDate).toISOString().split('T')[0];
                return taskDate === today && !t.completed;
            });
        }
        
        // Ajouter un √©v√©nement au calendrier
        function addEvent(title, startDate, endDate = null, description = '') {
            const event = {
                id: Date.now(),
                title: title,
                startDate: startDate,
                endDate: endDate || startDate,
                description: description,
                createdAt: new Date().toISOString(),
                userId: currentUser?.email || 'guest'
            };
            userEvents.push(event);
            saveEvents();
            return event;
        }
        
        // Supprimer un √©v√©nement
        function deleteEvent(eventId) {
            userEvents = userEvents.filter(e => e.id !== eventId);
            saveEvents();
        }
        
        // Obtenir √©v√©nements du jour
        function getTodayEvents() {
            const today = new Date().toISOString().split('T')[0];
            return userEvents.filter(e => {
                const eventDate = new Date(e.startDate).toISOString().split('T')[0];
                return eventDate === today;
            });
        }
        
        // Obtenir √©v√©nements de la semaine
        function getWeekEvents() {
            const today = new Date();
            const weekEnd = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            return userEvents.filter(e => {
                const eventDate = new Date(e.startDate);
                return eventDate >= today && eventDate <= weekEnd;
            });
        }
        
        // V√©rifier disponibilit√©
        function isAvailable(date, startTime, endTime) {
            const checkDate = new Date(date).toISOString().split('T')[0];
            const conflicts = userEvents.filter(e => {
                const eventDate = new Date(e.startDate).toISOString().split('T')[0];
                return eventDate === checkDate;
            });
            return conflicts.length === 0;
        }
        
        // üìä GESTION DES PROJETS
        function saveProjects() {
            localStorage.setItem('userProjects', JSON.stringify(userProjects));
        }
        
        function createProject(name, category, description = '', deadline = null) {
            const project = {
                id: Date.now(),
                name: name,
                category: category, // 'voyage', '√©tudes', 'travail', 'personnel'
                description: description,
                deadline: deadline,
                createdAt: new Date().toISOString(),
                progress: 0,
                status: 'en cours', // 'en cours', 'termin√©', 'en attente'
                tasks: [],
                userId: currentUser?.email || 'guest'
            };
            userProjects.push(project);
            saveProjects();
            return project;
        }
        
        function updateProjectProgress(projectId) {
            const project = userProjects.find(p => p.id === projectId);
            if (!project) return;
            
            const projectTasks = userTasks.filter(t => t.projectId === projectId);
            if (projectTasks.length === 0) {
                project.progress = 0;
                return;
            }
            
            const completedTasks = projectTasks.filter(t => t.completed).length;
            project.progress = Math.round((completedTasks / projectTasks.length) * 100);
            
            if (project.progress === 100) {
                project.status = 'termin√©';
            }
            
            saveProjects();
        }
        
        function getProjectStats(projectId) {
            const project = userProjects.find(p => p.id === projectId);
            if (!project) return null;
            
            const projectTasks = userTasks.filter(t => t.projectId === projectId);
            const completed = projectTasks.filter(t => t.completed).length;
            const pending = projectTasks.length - completed;
            
            return {
                project: project,
                totalTasks: projectTasks.length,
                completed: completed,
                pending: pending,
                progress: project.progress
            };
        }
        
        // üîî SYST√àME DE NOTIFICATIONS
        function saveNotificationSettings() {
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
        }
        
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                return false;
            }
            
            if (Notification.permission === 'granted') {
                notificationSettings.enabled = true;
                saveNotificationSettings();
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    notificationSettings.enabled = true;
                    saveNotificationSettings();
                    return true;
                }
            }
            
            return false;
        }
        
        function scheduleNotification(item) {
            if (!notificationSettings.enabled) return;
            
            const itemDate = new Date(item.dueDate || item.startDate);
            if (!itemDate || isNaN(itemDate.getTime())) return;
            
            const now = new Date();
            // Utiliser le temps personnalis√© de la t√¢che ou le d√©faut (15 min)
            const reminderMinutes = item.notifyMinutes || notificationSettings.reminderMinutes || 15;
            const reminderTime = new Date(itemDate.getTime() - (reminderMinutes * 60 * 1000));
            
            if (reminderTime > now) {
                const delay = reminderTime.getTime() - now.getTime();
                
                setTimeout(() => {
                    if (Notification.permission === 'granted') {
                        const type = item.title ? 'üìã T√¢che' : 'üìÖ √âv√©nement';
                        const timeText = reminderMinutes >= 60 ? `${reminderMinutes/60} heure(s)` : `${reminderMinutes} minutes`;
                        new Notification(`${type} √† venir`, {
                            body: `${item.title} dans ${timeText}`,
                            icon: '/favicon.ico',
                            tag: `reminder-${item.id}`
                        });
                    }
                }, delay);
            }
        }
        
        function sendImmediateNotification(title, body) {
            if (!notificationSettings.enabled || Notification.permission !== 'granted') return;
            
            new Notification(title, {
                body: body,
                icon: '/favicon.ico'
            });
        }
        
        // V√©rifier les notifications au chargement
        function checkUpcomingNotifications() {
            const now = new Date();
            const oneHour = new Date(now.getTime() + 60 * 60 * 1000);
            
            // V√©rifier les t√¢ches
            userTasks.filter(t => !t.completed && t.dueDate).forEach(task => {
                const dueDate = new Date(task.dueDate);
                if (dueDate > now && dueDate <= oneHour) {
                    scheduleNotification(task);
                }
            });
            
            // V√©rifier les √©v√©nements
            userEvents.forEach(event => {
                const startDate = new Date(event.startDate);
                if (startDate > now && startDate <= oneHour) {
                    scheduleNotification(event);
                }
            });
        }
        
        // ü§ñ D√âTECTION INTELLIGENTE DES COMMANDES TO DO
        function detectAndHandleTodoCommand(message) {
            const lowerMsg = message.toLowerCase();
            const lang = getAppLanguage();
            const isEn = lang === 'en';
            
            // ACTIVER LES NOTIFICATIONS
            if (lowerMsg.match(/\b(active|enable|turn on|allow)\b|autorise.*notifications?|rappels?/i)) {
                requestNotificationPermission().then(granted => {
                    if (granted) {
                        checkUpcomingNotifications();
                        addMessage(message, 'user');
                        addMessage(t('todo.agent.notificationsEnabledMessage'), 'bot');
                    } else {
                        addMessage(message, 'user');
                        addMessage(t('todo.agent.notificationsDeniedMessage'), 'bot');
                    }
                });
                return { handled: true, response: '' };
            }
            
            // CR√âER UN PROJET
            if (lowerMsg.match(/cr[√©e]e.*projet|nouveau projet|create.*project|new project|plan.*voyage|plan.*[√©e]tudes|plan.*travel|plan.*stud(y|ies)/i)) {
                let projectName = message.replace(/(cr[√©e]e|nouveau|create|new|projet|project|un|une|a|an|de|pour|for|mon|ma|my)/gi, '').trim();
                
                let category = 'autre';
                if (lowerMsg.includes('voyage') || lowerMsg.includes('travel')) category = lowerMsg.includes('travel') ? 'travel' : 'voyage';
                else if (lowerMsg.match(/[√©e]tudes?|cours|formation|stud(y|ies)|course|training/)) category = lowerMsg.match(/stud(y|ies)|course|training/) ? 'studies' : '√©tudes';
                else if (lowerMsg.match(/travail|professionnel|entreprise|work|professional|company/)) category = lowerMsg.match(/work|professional|company/) ? 'work' : 'travail';
                
                if (projectName.length < 3) {
                    return { handled: true, response: t('todo.agent.projectNamePrompt') };
                }
                
                const project = createProject(projectName, category);
                const createdTpl = String(t('todo.agent.projectCreated') || '');
                return {
                    handled: true,
                    response: createdTpl
                        .replace('{name}', project.name)
                        .replace('{category}', project.category)
                        .split('{id}').join(String(project.id))
                };
            }
            
            // VOIR LES PROJETS
            if (lowerMsg.match(/mes projets|liste.*projets|projets? en cours|my projects|list.*projects|projects? in progress|ongoing projects/i)) {
                if (userProjects.length === 0) {
                    return { handled: true, response: t('todo.agent.noProjects') };
                }
                
                let response = String(t('todo.agent.projectsHeader') || '').replace('{count}', String(userProjects.length));
                userProjects.forEach(project => {
                    const stats = getProjectStats(project.id);
                    const emoji = (project.category === 'voyage' || project.category === 'travel')
                        ? '‚úàÔ∏è'
                        : (project.category === '√©tudes' || project.category === 'studies')
                            ? 'üìö'
                            : (project.category === 'travail' || project.category === 'work')
                                ? 'üíº'
                                : 'üìÅ';
                    response += `${emoji} **${project.name}** (${project.category})\n`;
                    response += String(t('todo.agent.projectStatsLine') || '')
                        .replace('{progress}', String(project.progress))
                        .replace('{done}', String(stats.completed))
                        .replace('{total}', String(stats.totalTasks));
                    response += String(t('todo.agent.projectIdLine') || '').replace('{id}', String(project.id));
                });
                
                return { handled: true, response };
            }
            
            // AJOUTER UNE T√ÇCHE
            if (lowerMsg.match(/^(ajoute|cr[√©e]e) (une |la |)t[a√¢]che|^nouvelle t[a√¢]che|^note (une |la |)t[a√¢]che|^rappel[- ]moi|^(add|create) (a |an |the |)?task|^new task|^note (a |an |the |)?task|^remind me/i)) {
                // D√©tecter la cat√©gorie
                let category = 'autre';
                if (lowerMsg.includes('travail') || lowerMsg.includes('professionnel') || lowerMsg.includes('work') || lowerMsg.includes('professional')) category = isEn ? 'work' : 'travail';
                else if (lowerMsg.includes('personnel') || lowerMsg.includes('personal')) category = isEn ? 'personal' : 'personnel';
                else if (lowerMsg.includes('voyage') || lowerMsg.includes('travel') || lowerMsg.includes('trip')) category = isEn ? 'travel' : 'voyage';
                else if (lowerMsg.match(/[√©e]tudes?|cours|stud(y|ies)|course/)) category = isEn ? 'studies' : '√©tudes';
                
                // D√©tecter si c'est li√© √† un projet
                const projectMatch = message.match(/projet (\d+)|au projet (\d+)|project (\d+)|to project (\d+)/i);
                const projectId = projectMatch ? parseInt(projectMatch[1] || projectMatch[2] || projectMatch[3] || projectMatch[4], 10) : null;
                
                // Extraire le titre de la t√¢che
                let taskTitle = message.replace(/(ajoute|cr[√©e]e|nouvelle|t[a√¢]che|note|rappel|add|create|new|task|remind|to|my|√†|mes|ma|une|un|a|an|the|work|personal|travel|trip|stud(y|ies)|cours|course|training|travail|personnel|voyage|[√©e]tudes?|projet \d+|au projet \d+|project \d+|to project \d+)/gi, '').trim();
                
                if (taskTitle.length < 3) {
                    return { handled: true, response: t('todo.agent.taskTitlePrompt') };
                }
                
                const task = addTask(taskTitle, null, 'normal', category, projectId);

                const taskAddedTpl = String(t('todo.agent.taskAdded') || '');
                const categoryLabel = (typeof getTodoCategoryLabel === 'function') ? getTodoCategoryLabel(category) : String(category || '');
                let response = taskAddedTpl
                    .replace('{title}', task.title)
                    .replace('{category}', categoryLabel);
                if (projectId) {
                    const project = userProjects.find(p => p.id === projectId);
                    if (project) {
                        response += String(t('todo.agent.taskAddedProjectLine') || '').replace('{project}', project.name);
                        updateProjectProgress(projectId);
                    }
                }
                const activeCount = userTasks.filter(t => !t.completed).length;
                response += String(t('todo.agent.activeTasksCount') || '').replace('{count}', String(activeCount));
                
                return { handled: true, response };
            }
            
            // MONTRER LES T√ÇCHES
            if (lowerMsg.match(/montre|affiche|liste.*t[a√¢]ches?|mes t[a√¢]ches|t[a√¢]ches? du jour|show|display|list.*tasks?|my tasks?|today'?s tasks?/i)) {
                const activeTasks = userTasks.filter(t => !t.completed);
                
                if (activeTasks.length === 0) {
                    return { handled: true, response: t('todo.agent.noActiveTasks') };
                }
                
                let response = String(t('todo.agent.tasksHeader') || '').replace('{count}', String(activeTasks.length));
                activeTasks.forEach((task, index) => {
                    const priority = task.priority === 'high' ? 'üî¥' : task.priority === 'low' ? 'üîµ' : 'üü°';
                    const categoryIcon = task.category === 'voyage' ? '‚úàÔ∏è' : task.category === '√©tudes' ? 'üìö' : task.category === 'travail' ? 'üíº' : task.category === 'personnel' ? 'üë§' : 'üìã';
                    response += `${index + 1}. ${priority} ${categoryIcon} ${task.title}`;
                    if (task.dueDate) {
                        const dueDate = new Date(task.dueDate);
                        response += ` (üìÖ ${dueDate.toLocaleDateString(getLocale())})`;
                    }
                    if (task.progress > 0) {
                        response += ` [${task.progress}%]`;
                    }
                    response += `\n`;
                });
                
                return { handled: true, response };
            }
            
            // MARQUER T√ÇCHE COMME TERMIN√âE
            if (lowerMsg.match(/termin[√©e]|fait|compl[√©e]t[√©e]|marque.*fait|\bdone\b|\bcomplete\b|\bcompleted\b|mark.*done/i)) {
                const activeTasks = userTasks.filter(t => !t.completed);
                
                if (activeTasks.length === 0) {
                    return { handled: true, response: t('todo.agent.noTasksInProgress') };
                }
                
                // Tenter d'extraire le num√©ro de t√¢che
                const numMatch = message.match(/\d+/);
                if (numMatch) {
                    const taskNum = parseInt(numMatch[0]) - 1;
                    if (taskNum >= 0 && taskNum < activeTasks.length) {
                        completeTask(activeTasks[taskNum].id);
                        return { handled: true, response: String(t('todo.agent.taskCompleted') || '').replace('{title}', activeTasks[taskNum].title) };
                    }
                }
                
                // Sinon marquer la premi√®re t√¢che
                completeTask(activeTasks[0].id);
                return { handled: true, response: String(t('todo.agent.taskCompleted') || '').replace('{title}', activeTasks[0].title) };
            }
            
            // AJOUTER UN √âV√âNEMENT / RDV
            if (lowerMsg.match(/^(cr[√©e]e|ajoute|planifie) (un |une |)(r[√©e]union|rendez[- ]?vous|[√©e]v[√©e]nement)|^nouveau (rendez[- ]?vous|[√©e]v[√©e]nement)|^(create|add|schedule) (a |an |)(meeting|appointment|event)|^new (appointment|event)/i)) {
                // Extraire les d√©tails basiques
                let eventTitle = message.replace(/(cr[√©e]e|nouvelle|create|new|un|une|a|an|the|r[√©e]union|meeting|rendez[- ]vous|appointment|[√©e]v[√©e]nement|event|√†|to|ajoute|add|planifie|schedule|nouveau)/gi, '').trim();
                
                // D√©tection de date simple
                const tomorrow = lowerMsg.includes('demain') || lowerMsg.includes('tomorrow');
                const today = lowerMsg.includes('aujourd') || lowerMsg.includes('today');
                
                let startDate = new Date();
                if (tomorrow) {
                    startDate.setDate(startDate.getDate() + 1);
                    eventTitle = eventTitle.replace(/demain|tomorrow/gi, '').trim();
                } else if (!today) {
                    // Date par d√©faut aujourd'hui
                }
                
                // D√©tection d'heure
                const timeMatch = message.match(/(\d{1,2})h(\d{2})?/);
                if (timeMatch) {
                    startDate.setHours(parseInt(timeMatch[1]));
                    if (timeMatch[2]) startDate.setMinutes(parseInt(timeMatch[2]));
                }
                
                if (eventTitle.length < 3) {
                    eventTitle = isEn ? 'Meeting' : 'R√©union';
                }
                
                const event = addEvent(eventTitle, startDate.toISOString());
                const dateStr = new Date(event.startDate).toLocaleString(getLocale());
                
                const eventTpl = String(t('todo.agent.eventCreated') || '');
                return {
                    handled: true,
                    response: eventTpl
                        .replace('{title}', event.title)
                        .replace('{date}', dateStr)
                };
            }
            
            // MONTRER LE CALENDRIER
            if (lowerMsg.match(/^(montre|affiche|voir) (mon |le |mes |)(calendrier|emploi du temps|planning|rendez[- ]?vous|[√©e]v[√©e]nements)|^(calendrier|planning)$|^(show|display|see) (my |the |)(calendar|schedule|agenda)|^(calendar|schedule)$/i)) {
                const todayEvents = getTodayEvents();
                const weekEvents = getWeekEvents();
                
                let response = "";
                
                if (todayEvents.length > 0) {
                    response += String(t('todo.agent.calendarToday') || '').replace('{count}', String(todayEvents.length));
                    todayEvents.forEach(event => {
                        const time = new Date(event.startDate).toLocaleTimeString(getLocale(), { hour: '2-digit', minute: '2-digit' });
                        response += `üïê ${time} - ${event.title}\n`;
                    });
                    response += "\n";
                }
                
                if (weekEvents.length > todayEvents.length) {
                    response += String(t('todo.agent.calendarWeek') || '').replace('{count}', String(weekEvents.length));
                    weekEvents.forEach(event => {
                        const date = new Date(event.startDate).toLocaleDateString(getLocale());
                        const time = new Date(event.startDate).toLocaleTimeString(getLocale(), { hour: '2-digit', minute: '2-digit' });
                        response += isEn
                            ? `‚Ä¢ ${date} at ${time} - ${event.title}\n`
                            : `‚Ä¢ ${date} √† ${time} - ${event.title}\n`;
                    });
                }
                
                if (response === "") {
                    response = t('todo.agent.calendarEmpty');
                }
                
                return { handled: true, response };
            }
            
            // V√âRIFIER DISPONIBILIT√â (avec jours sp√©cifiques)
            if (lowerMsg.match(/libre|disponible|occup[√©e]|\bfree\b|available|\bbusy\b/i)) {
                // D√©tecter le jour sp√©cifique
                const dayMap = {
                    // FR
                    'lundi': 1, 'mardi': 2, 'mercredi': 3, 'jeudi': 4, 'vendredi': 5, 'samedi': 6, 'dimanche': 0,
                    'aujourd': -1, 'demain': -2,
                    // EN
                    'monday': 1, 'tuesday': 2, 'wednesday': 3, 'thursday': 4, 'friday': 5, 'saturday': 6, 'sunday': 0,
                    'today': -1, 'tomorrow': -2
                };
                
                let targetDate = new Date();
                let dayName = isEn ? 'today' : "aujourd'hui";
                
                for (const [day, dayNum] of Object.entries(dayMap)) {
                    if (lowerMsg.includes(day)) {
                        if (dayNum === -1) {
                            // aujourd'hui
                            dayName = isEn ? 'today' : "aujourd'hui";
                        } else if (dayNum === -2) {
                            // demain
                            targetDate.setDate(targetDate.getDate() + 1);
                            dayName = isEn ? 'tomorrow' : 'demain';
                        } else {
                            // Jour sp√©cifique de la semaine
                            const currentDay = targetDate.getDay();
                            let daysToAdd = dayNum - currentDay;
                            if (daysToAdd <= 0) daysToAdd += 7; // Si le jour est pass√©, prendre la semaine prochaine
                            targetDate.setDate(targetDate.getDate() + daysToAdd);
                            dayName = day;
                        }
                        break;
                    }
                }
                
                // D√©tecter matin/apr√®s-midi/soir
                let timeSlot = isEn ? 'all day' : 'toute la journ√©e';
                if (lowerMsg.includes('matin') || lowerMsg.includes('morning')) timeSlot = isEn ? 'morning' : 'matin';
                else if (lowerMsg.match(/apr[√®e]s[-\s]?midi|aprem/i) || lowerMsg.includes('afternoon')) timeSlot = isEn ? 'afternoon' : 'apr√®s-midi';
                else if (lowerMsg.includes('soir') || lowerMsg.includes('evening')) timeSlot = isEn ? 'evening' : 'soir';
                
                const targetDateStr = targetDate.toISOString().split('T')[0];
                const dayEvents = userEvents.filter(e => {
                    const eventDate = new Date(e.startDate).toISOString().split('T')[0];
                    return eventDate === targetDateStr;
                });
                
                if (dayEvents.length === 0) {
                    const slotSuffix = (isEn ? timeSlot !== 'all day' : timeSlot !== 'toute la journ√©e')
                        ? ` ${timeSlot}`
                        : '';
                    const freeTpl = String(t('todo.agent.free') || '');
                    return {
                        handled: true,
                        response: freeTpl
                            .replace('{day}', dayName)
                            .replace('{slot}', slotSuffix)
                    };
                } else {
                    const dayLabel = dayName.charAt(0).toUpperCase() + dayName.slice(1);
                    let response = String(t('todo.agent.dayHasEvents') || '')
                        .replace('{day}', dayLabel)
                        .replace('{count}', String(dayEvents.length));
                    dayEvents.forEach(event => {
                        const time = new Date(event.startDate).toLocaleTimeString(getLocale(), { hour: '2-digit', minute: '2-digit' });
                        response += `üïê ${time} - ${event.title}\n`;
                    });
                    return { handled: true, response };
                }
            }
            
            // PROPOSER DES CR√âNEAUX LIBRES
            if (lowerMsg.match(/propose|sugg[√®e]re.*cr[√©e]neaux?|quand.*libre|cr[√©e]neaux? disponibles?/i)) {
                const today = new Date();
                const slots = [];
                
                // V√©rifier les 7 prochains jours
                for (let i = 0; i < 7; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(today.getDate() + i);
                    const dateStr = checkDate.toISOString().split('T')[0];
                    
                    const dayEvents = userEvents.filter(e => {
                        const eventDate = new Date(e.startDate).toISOString().split('T')[0];
                        return eventDate === dateStr;
                    });
                    
                    if (dayEvents.length === 0) {
                        const dayName = checkDate.toLocaleDateString(getLocale(), { weekday: 'long', day: 'numeric', month: 'long' });
                        slots.push(String(t('todo.agent.slotFreeAllDay') || '').replace('{dayName}', dayName));
                    }
                }
                
                if (slots.length === 0) {
                    return { handled: true, response: t('todo.agent.slotsAllBusy') };
                }
                
                let response = t('todo.agent.slotsHeader');
                response += slots.slice(0, 5).join('\n');
                
                return { handled: true, response };
            }
            
            // PLANIFIER LA SEMAINE
            if (lowerMsg.match(/planifie.*semaine|organise.*semaine|planning.*semaine/i)) {
                const activeTasks = userTasks.filter(t => !t.completed && !t.dueDate);
                const weekEvents = getWeekEvents();
                
                let response = t('todo.agent.weekPlanHeader');
                
                // Afficher les √©v√©nements existants
                if (weekEvents.length > 0) {
                    response += t('todo.agent.weekPlanEvents');
                    weekEvents.forEach(event => {
                        const date = new Date(event.startDate).toLocaleDateString(getLocale(), { weekday: 'short', day: 'numeric' });
                        const time = new Date(event.startDate).toLocaleTimeString(getLocale(), { hour: '2-digit', minute: '2-digit' });
                        response += `‚Ä¢ ${date} ${time} - ${event.title}\n`;
                    });
                    response += "\n";
                }
                
                // Sugg√©rer d'ajouter des dates aux t√¢ches
                if (activeTasks.length > 0) {
                    response += String(t('todo.agent.weekPlanTasksToSchedule') || '').replace('{count}', String(activeTasks.length));
                    response += t('todo.agent.weekPlanUndated');
                    activeTasks.slice(0, 5).forEach((task, index) => {
                        response += `${index + 1}. ${task.title}\n`;
                    });
                    response += t('todo.agent.weekPlanTip');
                } else {
                    response += t('todo.agent.weekPlanAllPlanned');
                }
                
                return { handled: true, response };
            }
            
            // Commande non reconnue comme TO DO
            return { handled: false };
        }

    async function saveMessage(userMsg, botData) {
        // S'assurer qu'une conversation existe
        if (!currentConversationId) {
            console.error('Aucune conversation active');
            return;
        }

        const conv = conversations.find(c => c.id === currentConversationId);
        if (conv) {
            // Extraire HI/CHR du texte de la r√©ponse
            const hiMatch = botData.response.match(/HI: ([0-9.]+)%/);
            const chrMatch = botData.response.match(/CHR: ([0-9.]+)%/);

            const normalizePercent = (value) => {
                if (typeof value !== 'number' || !Number.isFinite(value)) return null;
                // Certaines impl√©mentations peuvent renvoyer 0..1 au lieu de 0..100
                if (value >= 0 && value <= 1) return Math.round(value * 10000) / 100;
                return value;
            };

            const hiFromFields = normalizePercent(botData.hallucinationIndex);
            const chrFromFields = normalizePercent(botData.contextHistoryRatio);
            const hiFromText = hiMatch ? parseFloat(hiMatch[1]) : null;
            const chrFromText = chrMatch ? parseFloat(chrMatch[1]) : null;
            
            const messageData = {
                user: userMsg,
                bot: botData.response,
                timestamp: Date.now(),
                // Align√© sur les m√©triques: on privil√©gie les champs num√©riques du backend
                hiScore: hiFromFields !== null ? hiFromFields : hiFromText,
                chrScore: chrFromFields !== null ? chrFromFields : chrFromText,
                // Sauvegarder toutes les m√©triques pour restauration
                hallucinationIndex: botData.hallucinationIndex,
                contextHistoryRatio: botData.contextHistoryRatio,
                responseTime: botData.responseTime,
                processingTime: botData.processingTime,
                cached: botData.cached,
                usage: botData.usage,
                model: botData.model,
                rag_verification: botData.rag_verification
            };
            
            // Sauvegarder les donn√©es d'image si pr√©sentes
            if (botData.imageUrl && botData.imageGenerated) {
                messageData.imageGenerated = true;
                messageData.prompt = botData.prompt;

                // √âviter de persister de gros base64 dans la conversation.
                // Si l'image g√©n√©r√©e est un dataURL, on la stocke en Blob dans IDB.
                if (typeof botData.imageUrl === 'string' && botData.imageUrl.startsWith('data:image/')) {
                    try {
                        const userKey = getActiveUserKey();
                        const blob = await dataUrlToBlob(botData.imageUrl);
                        const imageId = await idbPutImageBlob(userKey, blob, blob.type, botData.prompt || 'image');
                        messageData.imageId = imageId;
                    } catch (e) {
                        // Fallback: conserver l'URL (si IDB √©choue)
                        messageData.imageUrl = botData.imageUrl;
                    }
                } else {
                    messageData.imageUrl = botData.imageUrl;
                }
            }
            
            conv.messages.push(messageData);

            // Update title with first message
            if (conv.messages.length === 1) {
                conv.title = userMsg.substring(0, 30) + (userMsg.length > 30 ? '...' : '');
            }

            saveConversations();
            loadConversations();
        }
        }

        function getHIStatusDot(conversation) {
            // Calculer le HI moyen de la conversation
            if (!conversation.messages || conversation.messages.length === 0) {
                return 'green'; // Nouvelle conversation = vert par d√©faut
            }

            const normalizePercent = (value) => {
                if (typeof value !== 'number' || !Number.isFinite(value)) return null;
                if (value >= 0 && value <= 1) return Math.round(value * 10000) / 100;
                return value;
            };

            const getHiFromMessage = (msg) => {
                if (!msg) return null;
                const fromIndex = normalizePercent(msg.hallucinationIndex);
                if (fromIndex !== null) return fromIndex;
                const fromScore = normalizePercent(msg.hiScore);
                if (fromScore === null) return null;
                const hasInline = typeof msg.bot === 'string' && msg.bot.includes('HI:');
                if (fromScore === 0 && !hasInline) return null;
                return fromScore;
            };

            const hiValues = (conversation.messages || [])
                .map(getHiFromMessage)
                .filter(v => v !== null);

            if (hiValues.length === 0) {
                return 'green'; // Pas de scores HI = vert
            }

            const totalHI = hiValues.reduce((sum, v) => sum + v, 0);
            const avgHI = totalHI / hiValues.length;

            // Seuils align√©s sur les badges HI de l'UI
            // üü¢ Vert : HI < 15%
            if (avgHI < 15) return 'green';
            // üü† Orange : HI 15-29%
            if (avgHI < 30) return 'orange';
            // üî¥ Rouge : HI >= 30%
            return 'red';
        }

        function toggleSessions() {
            const conversationsList = document.getElementById('conversationsList');
            const toggleBtn = document.getElementById('sessionsToggleBtn');
            
            conversationsList.classList.toggle('visible');
            toggleBtn.classList.toggle('active');

            // Si on ouvre: limiter la hauteur √† ~5 sessions puis scroll
            try {
                if (conversationsList.classList.contains('visible')) {
                    requestAnimationFrame(() => applySessionsListMaxHeight());
                }
            } catch (_) {}
        }

        function applySessionsListMaxHeight() {
            const MAX_VISIBLE_SESSIONS = 5;
            const conversationsList = document.getElementById('conversationsList');
            if (!conversationsList) return;

            if (!conversationsList.classList.contains('visible')) return;

            const convItems = Array.from(conversationsList.querySelectorAll('.conv-item'));
            if (convItems.length === 0) {
                try { conversationsList.style.removeProperty('--sessions-max-height'); } catch (_) {}
                conversationsList.style.overflowY = 'hidden';
                return;
            }

            conversationsList.style.overflowY = convItems.length > MAX_VISIBLE_SESSIONS ? 'auto' : 'hidden';

            const targetCount = Math.min(MAX_VISIBLE_SESSIONS, convItems.length);

            let itemsCounted = 0;
            let targetHeight = 0;
            const children = Array.from(conversationsList.children);
            for (const child of children) {
                const rect = child.getBoundingClientRect();
                const h = rect && rect.height ? rect.height : 0;
                targetHeight += h;
                if (child.classList && child.classList.contains('conv-item')) {
                    itemsCounted += 1;
                    if (itemsCounted >= targetCount) break;
                }
            }

            const styles = window.getComputedStyle ? getComputedStyle(conversationsList) : null;
            const rowHeight = styles ? parseFloat(styles.getPropertyValue('--session-row-height')) : NaN;
            const fallbackPadding = styles ? parseFloat(styles.getPropertyValue('--sessions-fallback-padding')) : NaN;
            const fallbackHeight = (Number.isFinite(rowHeight) ? rowHeight : 56) * MAX_VISIBLE_SESSIONS + (Number.isFinite(fallbackPadding) ? fallbackPadding : 20);

            if (!targetHeight || targetHeight < fallbackHeight * 0.6) {
                targetHeight = fallbackHeight;
            }

            const padded = Math.ceil(targetHeight + 8);

            // Borne haute: ne pas manger l'espace du menu (surtout sur mobile)
            let available = 0;
            try {
                const sidebar = document.getElementById('sidebar');
                const header = sidebar ? sidebar.querySelector('.sidebar-header') : null;
                const menu = sidebar ? sidebar.querySelector('.sidebar-menu') : null;
                if (sidebar) {
                    const s = sidebar.getBoundingClientRect();
                    const h = header ? header.getBoundingClientRect() : null;
                    const m = menu ? menu.getBoundingClientRect() : null;
                    const headerH = h && h.height ? h.height : 0;
                    const menuH = m && m.height ? m.height : 0;
                    available = Math.floor((s && s.height ? s.height : 0) - headerH - menuH - 24);
                }
            } catch (_) {}

            let finalMax = padded;
            if (available && available > 0) {
                finalMax = Math.min(finalMax, available);
            }
            if (!finalMax || finalMax < 140) finalMax = 140;

            try { conversationsList.style.setProperty('--sessions-max-height', finalMax + 'px'); } catch (_) {}
        }

        // Fermer sessions si clic en dehors ou sur un item
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const conversationsList = document.getElementById('conversationsList');
            const toggleBtn = document.getElementById('sessionsToggleBtn');
            const convItems = document.querySelectorAll('.conv-item');

            if (!sidebar || !conversationsList || !toggleBtn) return;

            // Clic hors sidebar -> fermer
            if (!sidebar.contains(e.target)) {
                closeSessionsList();
                return;
            }

            // Clic sur un item de conversation -> fermer
            if (e.target.closest('.conv-item')) {
                try {
                    if (window.__axilum_sessionsDrag && window.__axilum_sessionsDrag.moved) {
                        return;
                    }
                } catch (_) {}
                closeSessionsList();
                return;
            }

            // Clic dans sidebar mais pas sur le bouton / la liste -> ne pas forcer
        });

        function loadConversations() {
            const list = document.getElementById('conversationsList');
            const groupTitles = {
                today: (typeof t === 'function') ? t('sessions.group.today') : "Aujourd'hui",
                yesterday: (typeof t === 'function') ? t('sessions.group.yesterday') : 'Hier',
                older: (typeof t === 'function') ? t('sessions.group.older') : 'Plus ancien'
            };
            
            const today = [];
            const yesterday = [];
            const older = [];

            const now = Date.now();
            const oneDayMs = 24 * 60 * 60 * 1000;

            // Filtrer les conversations de l'utilisateur connect√©
            const userConversations = conversations.filter(conv => {
                // Si pas connect√©, montrer conversations sans userId (anciennes)
                if (!currentUser) {
                    return !conv.userId;
                }
                // Si connect√©, montrer uniquement ses conversations
                return conv.userId === currentUser.id;
            });

            userConversations.forEach(conv => {
                const age = now - conv.timestamp;
                if (age < oneDayMs) {
                    today.push(conv);
                } else if (age < 2 * oneDayMs) {
                    yesterday.push(conv);
                } else {
                    older.push(conv);
                }
            });

            list.innerHTML = '';

            if (today.length) {
                list.innerHTML += `<div class="conv-group-title">${groupTitles.today}</div>`;
                today.forEach(conv => {
                    const dotClass = getHIStatusDot(conv);
                    list.innerHTML += `<div class="conv-item ${conv.id === currentConversationId ? 'active' : ''}" onclick="loadConversation('${conv.id}')">
                        <span class="status-dot ${dotClass}"></span>
                        <span class="conv-item-text">${conv.title}</span>
                    </div>`;
                });
            }

            if (yesterday.length) {
                list.innerHTML += `<div class="conv-group-title">${groupTitles.yesterday}</div>`;
                yesterday.forEach(conv => {
                    const dotClass = getHIStatusDot(conv);
                    list.innerHTML += `<div class="conv-item ${conv.id === currentConversationId ? 'active' : ''}" onclick="loadConversation('${conv.id}')">
                        <span class="status-dot ${dotClass}"></span>
                        <span class="conv-item-text">${conv.title}</span>
                    </div>`;
                });
            }

            if (older.length) {
                list.innerHTML += `<div class="conv-group-title">${groupTitles.older}</div>`;
                older.forEach(conv => {
                    const dotClass = getHIStatusDot(conv);
                    list.innerHTML += `<div class="conv-item ${conv.id === currentConversationId ? 'active' : ''}" onclick="loadConversation('${conv.id}')">
                        <span class="status-dot ${dotClass}"></span>
                        <span class="conv-item-text">${conv.title}</span>
                    </div>`;
                });
            }

            // Si la liste Sessions est ouverte, limiter √† ~5 items puis scroll
            try {
                if (list.classList.contains('visible')) {
                    requestAnimationFrame(() => applySessionsListMaxHeight());
                }
            } catch (_) {}
        }

        async function loadConversation(id) {
            currentConversationId = id;
            const conv = conversations.find(c => c.id === id);
            if (!conv) return;

            clearChat();
            
            // Hide welcome screen when loading conversation with messages
            if (conv.messages && conv.messages.length > 0) {
                const welcomeScreen = document.getElementById('welcomeScreen');
                if (welcomeScreen) {
                    welcomeScreen.style.display = 'none';
                }
            }
            
            for (const msg of (conv.messages || [])) {
                // Restaurer un fichier upload√© (lien persistant via remoteFileId)
                if (msg && msg.file && (msg.file.name || msg.file.fileName)) {
                    try {
                        appendUploadedFileCardToChat({
                            fileName: msg.file.name || msg.file.fileName,
                            remoteFileId: msg.file.remoteFileId || null,
                            objectUrl: null,
                            mimeType: msg.file.mimeType || msg.file.type || 'application/octet-stream',
                            sizeBytes: msg.file.sizeBytes || msg.file.size || 0,
                            subtitle: ''
                        });
                    } catch (_) {
                        // no-op
                    }
                    continue;
                }

                // Restaurer l'image envoy√©e par l'utilisateur si associ√©e √† ce message
                if (msg && !msg.imageGenerated && (msg.imageUrl || msg.imageId || msg.remoteImageId)) {
                    const userImgUrl = await ensureLocalImageUrlForMessage(msg);
                    if (userImgUrl) {
                        addMessage(msg.user, 'user', { imageUrl: userImgUrl, imageName: msg.user });
                    } else {
                        addMessage(msg.user, 'user');
                    }
                } else {
                    addMessage(msg.user, 'user');
                }
                
                // Restaurer toutes les donn√©es (image et m√©triques)
                const botData = {
                    response: msg.bot,
                    hallucinationIndex: msg.hallucinationIndex,
                    contextHistoryRatio: msg.contextHistoryRatio,
                    responseTime: msg.responseTime,
                    processingTime: msg.processingTime,
                    cached: msg.cached,
                    usage: msg.usage,
                    model: msg.model,
                    rag_verification: msg.rag_verification,
                    imageUrl: msg.imageUrl,
                    imageGenerated: msg.imageGenerated,
                    prompt: msg.prompt
                };

                // Restaurer une image g√©n√©r√©e stock√©e via imageId
                if (msg.imageGenerated && !botData.imageUrl && msg.imageId) {
                    try {
                        const blob = await idbGetImageBlob(msg.imageId);
                        if (blob) {
                            const objUrl = trackObjectUrl(URL.createObjectURL(blob));
                            botData.imageUrl = objUrl;
                        }
                    } catch (_) {}
                }

                // Si image (g√©n√©r√©e) dispo c√¥t√© serveur, restaurer via remoteImageId
                if (msg.imageGenerated && !botData.imageUrl && msg.remoteImageId) {
                    try {
                        const tmp = await ensureLocalImageUrlForMessage(msg);
                        if (tmp) botData.imageUrl = tmp;
                    } catch (_) {}
                }
                
                addMessage(msg.bot, 'bot', botData);
            }

            loadConversations();
            toggleSidebar();
        }

        function updateStats(data) {
            const normalizePercent = (value) => {
                if (typeof value !== 'number' || !Number.isFinite(value)) return null;
                if (value >= 0 && value <= 1) return Math.round(value * 10000) / 100;
                return value;
            };

            // Priorit√©: champs num√©riques (align√©s sur les badges UI)
            const hiFromFields = normalizePercent(data.hallucinationIndex);
            const chrFromFields = normalizePercent(data.contextHistoryRatio);

            // Fallback: parsing du texte si n√©cessaire
            let hiFromText = null;
            let chrFromText = null;
            if (data.response && data.response.includes('HI:')) {
                const hiMatch = data.response.match(/HI: ([0-9.]+)%/);
                const chrMatch = data.response.match(/CHR: ([0-9.]+)%/);
                hiFromText = hiMatch ? parseFloat(hiMatch[1]) : null;
                chrFromText = chrMatch ? parseFloat(chrMatch[1]) : null;
            }

            const hi = hiFromFields !== null ? hiFromFields : hiFromText;
            const chr = chrFromFields !== null ? chrFromFields : chrFromText;

            if (hi !== null) {
                messageStats.hiHistory.push(hi);
                if (messageStats.hiHistory.length > 20) messageStats.hiHistory.shift();
            }

            if (chr !== null) {
                messageStats.chrHistory.push(chr);
                if (messageStats.chrHistory.length > 20) messageStats.chrHistory.shift();
            }

            localStorage.setItem('messageStats', JSON.stringify(messageStats));
        }

        // ========== I18N (FR/EN) ==========
        const I18N_STRINGS = {
            fr: {

        'companySettings.title': 'Param√®tres Entreprise',
        'companySettings.subtitle': 'Informations de votre entreprise',
        'companySettings.menu': 'MENU',
        'companySettings.nav.general': 'G√©n√©ral',
        'companySettings.nav.contact': 'Contact',
        'companySettings.nav.currency': 'Devise',
        'companySettings.nav.legal': 'L√©gal',
        'companySettings.sectionTitle.general': 'G√©n√©ral',
        'companySettings.sectionTitle.contact': 'Contact',
        'companySettings.sectionTitle.currency': 'Devise',
        'companySettings.sectionTitle.legal': 'L√©gal',
        'companySettings.label.companyName': "Nom de l'entreprise *",
        'companySettings.label.activity': "Domaine d'activit√© *",
        'companySettings.label.address': "Adresse compl√®te *",
        'companySettings.label.phone': "T√©l√©phone *",
        'companySettings.label.email': "Email *",
        'companySettings.label.currency': "Devise *",
        'companySettings.label.registration': "Num√©ro SIRET/RC (optionnel)",
        'companySettings.placeholder.companyName': 'Ex: Axilum',
        'companySettings.placeholder.activity': 'Ex: Technologies, Commerce, Services...',
        'companySettings.placeholder.address': 'Rue, ville, code postal, pays...',
        'companySettings.placeholder.phone': '+213 XXX XXX XXX',
        'companySettings.placeholder.email': 'contact@entreprise.com',
        'companySettings.placeholder.registration': "Num√©ro d'enregistrement",
        'companySettings.button.cancel': 'Annuler',
        'companySettings.button.save': 'Enregistrer',
        'companySettings.currency.eur': 'Euro (‚Ç¨)',
        'companySettings.currency.usd': 'Dollar US ($)',
        'companySettings.currency.mad': 'Dirham Marocain (MAD)',
        'companySettings.currency.tnd': 'Dinar Tunisien (TND)',

                'ui.newConversation': 'Nouvelle Conversation',
            'ui.close': 'Fermer',
            'ui.cancel': 'Annuler',
            'ui.delete': 'Supprimer',
            'ui.save': 'Enregistrer',
            'ui.download': 'T√©l√©charger',
            'ui.confirm': 'Confirmer',
            'ui.submit': 'Soumettre',
            'ui.edit': 'Modifier',
            'ui.add': 'Ajouter',
            'ui.search': 'Rechercher',
                'ui.sessions': 'Sessions',
                'ui.settings': 'Param√®tres',
                'ui.languageSection': 'Langue',
                'ui.languageLabel': 'Langue',
                'ui.languageHelp': 'Appliqu√© √† l‚Äôinterface et √† la voix.',
                'ui.attachFileTitle': 'Joindre un fichier',
                'ui.voiceInputTitle': 'Saisie vocale',
                'ui.chooseAgentTitle': 'Choisir un agent',
                'welcome.subtitle': 'Votre assistant intelligent pour tous vos besoins professionnels',
                'welcome.visionTitle': 'Vision AI',
                'welcome.visionDesc': "Analyse d'images",
                'welcome.tasksTitle': 'Gestion t√¢ches',
                'welcome.tasksDesc': 'Organisation et planning',

                'welcome.excelTitle': 'Analyse Excel',
                'welcome.excelDesc': 'G√©n√®re un rapport d√©taill√©',
                'welcome.financeTitle': 'Rapport financier',
                'welcome.financeDesc': 'Analyse d√©penses',
                'welcome.webTitle': 'Recherche web',
                'welcome.webDesc': 'Cherche et r√©sume',
                'welcome.moreTitle': 'Plus',
                'welcome.moreDesc': 'Afficher plus',
                'welcome.emailTitle': 'R√©daction email',
                'welcome.emailDesc': 'Email professionnel',

                'welcome.suggest.excelAnalysis': 'Analyse ce fichier Excel et g√©n√®re un rapport d√©taill√©',
                'welcome.suggest.financeReport': 'Cr√©e un rapport financier pour ce mois avec analyse des d√©penses et revenus. Si une info manque, pose-moi 1-3 questions ou aller dans le Module Finance & Compta (Agent Alex) pour ajouter/compl√©ter les donn√©es afin d\'obtenir un rapport optimis√© et pr√©cis.',
                'welcome.suggest.webSearch': 'Recherche des informations d√©taill√©es sur [sujet] et r√©sume les points cl√©s',
                'welcome.suggest.email': 'R√©dige un email professionnel pour [destinataire] concernant [sujet]',
                'welcome.suggest.vision': 'Analyse cette image et d√©cris en d√©tail ce que tu vois',
                'welcome.suggest.tasks': 'Aide-moi √† organiser mes t√¢ches et cr√©e un planning pour la semaine. Pour un planning plus pr√©cis, demande-moi de compl√©ter mes t√¢ches (√©ch√©ances, priorit√©s) dans AI Task.',

                'excelReport.uploadRequest': 'üìé Merci d\'uploader un fichier Excel (.xlsx/.xls) pour g√©n√©rer automatiquement un rapport d√©taill√©.',
                'excelReport.generatePrompt': 'G√©n√®re un rapport d√©taill√© √† partir du fichier Excel que je viens d\'uploader.\n\nStructure: 1) R√©sum√© ex√©cutif 2) KPIs cl√©s 3) Tendances 4) Anomalies/valeurs manquantes 5) Recommandations.\n\nR√©ponds directement avec le rapport (sans demander d\'infos suppl√©mentaires sauf si indispensable).',
                'excelReport.processingToast': 'üìä Excel re√ßu ‚Äî g√©n√©ration du rapport‚Ä¶',
                'excelReport.doneToast': '‚úÖ Rapport g√©n√©r√© ‚Äî retour √† Axilum AI',

                'marketStudy.quickBtn': '√âtude March√©',
                'marketStudy.wizard.title': '√âtude de march√© ‚Äî Cadrage (√©tape {step}/{total})',
                'marketStudy.wizard.subtitle': 'R√©pondez rapidement : on collecte ensuite des donn√©es via Recherche web (Agent Wesh), puis Agent Alex fait l‚Äôanalyse.',
                'marketStudy.field.country': 'Pays *',
                'marketStudy.placeholder.country': 'Ex: Portugal',
                'marketStudy.field.region': 'R√©gion / ville (optionnel)',
                'marketStudy.placeholder.region': 'Ex: Lisbonne',
                'marketStudy.field.sector': 'Secteur *',
                'marketStudy.sector.saas': 'SaaS',
                'marketStudy.sector.health': 'Sant√©',
                'marketStudy.sector.fintech': 'Fintech',
                'marketStudy.sector.education': '√âducation',
                'marketStudy.sector.ai': 'IA',
                'marketStudy.sector.ecommerce': 'E-commerce',
                'marketStudy.sector.other': 'Autre',
                'marketStudy.field.subSector': 'Sous-secteur (optionnel)',
                'marketStudy.placeholder.subSector': 'Ex: SaaS RH / HealthTech / Payments',
                'marketStudy.field.marketScope': 'March√© vis√© *',
                'marketStudy.scope.local': 'Local',
                'marketStudy.scope.national': 'National',
                'marketStudy.scope.international': 'International',
                'marketStudy.field.companySize': "Taille de l'entreprise *",
                'marketStudy.companySize.tpe': 'Petite entreprise (TPE)',
                'marketStudy.companySize.pme': 'Moyenne entreprise (PME)',
                'marketStudy.companySize.ge': 'Grande entreprise',
                'marketStudy.field.companyScope': "Port√©e actuelle de l'entreprise *",
                'marketStudy.field.businessModel': 'Mod√®le √©conomique *',
                'marketStudy.field.horizon': 'Horizon *',
                'marketStudy.horizon.6m': '6 mois',
                'marketStudy.horizon.12m': '12 mois',
                'marketStudy.horizon.24m': '24 mois',
                'marketStudy.field.objective': 'Objectif principal *',
                'marketStudy.objective.inflation': "Impacts de l'inflation",
                'marketStudy.objective.goNoGo': 'Go / No-Go march√©',
                'marketStudy.objective.pricing': 'Pricing & positionnement',
                'marketStudy.objective.expansion': 'Expansion (nouveau march√©)',
                'marketStudy.objective.competition': 'Analyse concurrence',
                'marketStudy.objective.other': 'Autre',
                'marketStudy.field.notes': 'Notes (optionnel)',
                'marketStudy.placeholder.notes': 'Ex: produit, ICP, contraintes r√©gulatoires...',
                'marketStudy.field.metrics': 'Chiffres internes (optionnel)',
                'marketStudy.placeholder.metrics': 'Ex: pricing, CAC, LTV, marge, churn...',
                'marketStudy.btn.back': 'Retour',
                'marketStudy.btn.cancel': 'Annuler',
                'marketStudy.btn.next': 'Suivant',
                'marketStudy.btn.finish': 'Terminer',
                'marketStudy.toast.countryRequired': '‚ö†Ô∏è Pays requis',
                'marketStudy.summary.title': 'üìä √âtude de march√© ‚Äî r√©sum√© de cadrage',
                'marketStudy.summary.country': 'Pays',
                'marketStudy.summary.sector': 'Secteur',
                'marketStudy.summary.marketScope': 'March√© vis√©',
                'marketStudy.summary.company': 'Entreprise',
                'marketStudy.summary.horizon': 'Horizon',
                'marketStudy.summary.objective': 'Objectif',
                'marketStudy.summary.notes': 'Notes',
                'marketStudy.summary.metrics': 'Chiffres internes',
                'marketStudy.summary.confirm': 'Confirmez-vous ces informations ?',
                'marketStudy.action.approve': 'Approuver et lancer',
                'marketStudy.status.alreadyRunning': '‚è≥ Une √©tude est d√©j√† en cours pour cette conversation‚Ä¶',
                'marketStudy.status.missingDraft': '‚ùå Donn√©es de cadrage introuvables. Relancez ‚Äú√âtude March√©‚Äù.',
                'marketStudy.status.webRunning': 'üîé Collecte web en cours‚Ä¶ (Recherche web ‚Äî Agent Wesh)',
                'marketStudy.status.webDone': '‚úÖ Collecte termin√©e. Lancement de l‚Äôanalyse‚Ä¶ (Agent Alex)',
                'marketStudy.error.prefix': '‚ùå √âchec √©tude de march√©: ',

                'todo.title': 'Tasks and Planning',
                'todo.aiAssistant': 'Agent ToDo',
                'todo.aiAssistantTitle': 'Assistant IA',
                'todo.searchPlaceholder': 'Rechercher...',
                'todo.notificationsEnabled': 'Notifications activ√©es',
                'todo.notificationsEnable': 'Activer les notifications',
                'todo.newTask': 'Nouvelle t√¢che',
                'todo.profile': 'Profil personnel',
                'todo.profile.filled': 'Profil renseign√©. Vous pouvez l‚Äôajuster pour affiner les m√©triques.',
                'todo.profile.incomplete': 'Profil incomplet. Ajoutez √¢ge/sexe/capacit√© pour mieux personnaliser les scores.',
                'todo.profile.edit': 'Modifier',
                'todo.profile.complete': 'Compl√©ter',
                'todo.profile.modal.title': 'Informations personnelles',
                'todo.profile.modal.close': 'Fermer',
                'todo.profile.modal.desc': 'Ces informations servent √† personnaliser les m√©triques et recommandations. Vous pouvez laisser vide.',
                'todo.profile.modal.age': '√Çge',
                'todo.profile.modal.agePlaceholder': 'ex: 32',
                'todo.profile.modal.sex': 'Sexe',
                'todo.profile.modal.sexFemale': 'Femme',
                'todo.profile.modal.sexMale': 'Homme',
                'todo.profile.modal.sexOther': 'Autre',
                'todo.profile.modal.capacity': 'Capacit√© (heures focus / jour)',
                'todo.profile.modal.capacityPlaceholder': 'ex: 6',
                'todo.profile.modal.capacityHint': 'Aide √† interpr√©ter la surcharge (prochaines 24h).',
                'todo.profile.modal.save': 'Enregistrer',
                'todo.menu': 'Menu',
                'todo.close': 'Fermer',
                'todo.views': 'Vues',
                'todo.view.list': 'Liste',
                'todo.view.kanban': 'Tableau',
                'todo.view.calendar': 'Calendrier',
                'todo.view.personal': 'Personnel',

                'todo.filtersTitle': 'Filtres',
                'todo.filter.all': 'Toutes',
                'todo.filter.today': "Aujourd'hui",
                'todo.filter.week': 'Semaine',
                'todo.filter.urgent': 'Urgent',

                'todo.categoriesTitle': 'Cat√©gories',
                'todo.category.all': 'Toutes',
                'todo.category.work': 'Travail',
                'todo.category.personal': 'Personnel',
                'todo.category.studies': '√âtudes',
                'todo.category.travel': 'Voyage',
                'todo.category.sport': 'Sport',
                'todo.category.health': 'Sant√©',
                'todo.category.other': 'Autre',

                'todo.toast.notificationsNotSupported': '‚ùå Notifications non support√©es par ce navigateur',
                'todo.toast.notificationsEnabled': 'üîî Notifications activ√©es !',
                'todo.toast.permissionDenied': '‚ùå Permission refus√©e',
                'todo.toast.notificationsDisabled': 'üîï Notifications d√©sactiv√©es',

                'todo.sidebarTooltip': 'Tasks and Planning - Calendrier, T√¢ches, Planning',

                'todo.toast.addTasksFirst': '‚ÑπÔ∏è Ajoutez des t√¢ches d\'abord',
                'todo.toast.enableBrowserNotifications': 'üí° Activez les notifications dans votre navigateur',
                'todo.toast.taskNotificationEnabled': 'üîî Notification activ√©e',
                'todo.toast.taskNotificationEnabledForTask': 'üîî Notification activ√©e pour cette t√¢che',
                'todo.toast.taskNotificationDisabled': 'üîï Notification d√©sactiv√©e',
                'todo.toast.notificationTimeUpdated': '‚è∞ Notification: {when} avant',

                'todo.aiAssistant.coachMode': 'Coaching',
                'todo.aiAssistant.subtitle': 'Gestion intelligente',
                'todo.aiAssistant.deleteChat': 'Supprimer le chat',
                'todo.aiAssistant.close': 'Fermer',
                'todo.aiAssistant.helpTitle': 'Comment puis-je vous aider ?',
                'todo.aiAssistant.helpSubtitle': 'Posez vos questions sur vos t√¢ches',
                'todo.aiAssistant.placeholder': 'Demandez quelque chose...',
                'todo.aiAssistant.sending': '√âmission en cours...',
                'todo.aiAssistant.coachPromptOnEnable': "Donne-moi un conseil rapide pour aujourd'hui.",

                'todo.smart.prioritiesHeader': 'Voici tes priorit√©s:',
                'todo.smart.noTasksToPrioritize': "Je n'ai pas trouv√© de t√¢ches √† prioriser.",
                'todo.smart.dueDate': ' (√©ch√©ance: {date})',
                'todo.smart.overloadWarning': '\n\n‚ö†Ô∏è Surcharge possible dans 24h (~{hours}h).',
                'todo.smart.overloadWarningInline': '\n‚ö†Ô∏è Surcharge possible dans 24h (~{hours}h).',
                'todo.smart.scheduleHeader': "Proposition de planning (sans cr√©er d'√©v√©nements):",
                'todo.smart.scheduleNoSlots': "Je n'ai pas pu proposer de cr√©neaux (pas assez de t√¢ches ou pas de disponibilit√©).",
                'todo.smart.coachUnavailable': 'Conseils indisponibles.',
                'todo.smart.coachWorkLabel': 'Travail:',
                'todo.smart.coachPersonalLabel': 'Perso:',
                'todo.smart.productivitySummary': 'Productivit√©: {completed} termin√©e(s), {pending} en cours, {overdue} en retard.\nStreak: {streak} jour(s).\nCharge estim√©e: ~{hours}h.',
                'todo.smart.summaryFallback': 'R√©sum√©.',
                'todo.smart.nextStepsTitle': '√Ä faire ensuite',
                'todo.smart.suggestionsTitle': 'Suggestions',
                'todo.smart.insightUrgent': 'Urgentes: {count}',
                'todo.smart.insightToday': "Aujourd'hui: {count}",
                'todo.smart.toast.tasksPrefix': '‚úÖ T√¢che(s):',
                'todo.smart.toast.created': '{count} cr√©√©e(s)',
                'todo.smart.toast.updated': '{count} modifi√©e(s)',
                'todo.smart.toast.deleted': '{count} supprim√©e(s)',
                'todo.smart.error.server': 'Erreur serveur: {status} {statusText}',
                'todo.smart.error.invalidResponse': "R√©ponse invalide du serveur. V√©rifiez que l'API est d√©ploy√©e.",
                'todo.smart.error.genericPrefix': '‚ùå Erreur: ',

                'todo.agent.notificationsEnabledMessage': '‚úÖ Notifications activ√©es ! Vous recevrez des rappels 15 minutes avant vos √©v√©nements et t√¢ches.\n\nüí° Les notifications fonctionnent m√™me quand l\'onglet est ouvert en arri√®re-plan.',
                'todo.agent.notificationsDeniedMessage': '‚ùå Impossible d\'activer les notifications. Veuillez autoriser les notifications dans les param√®tres de votre navigateur.',
                'todo.agent.projectNamePrompt': "‚ùì Quel est le nom du projet ? Exemple: 'Cr√©e un projet voyage √† Paris'",
                'todo.agent.projectCreated': '‚úÖ Projet cr√©√©: "{name}"\nüìÅ Cat√©gorie: {category}\nüÜî ID: {id}\n\nüí° Ajoutez des t√¢ches avec: "Ajoute [t√¢che] au projet {id}"',
                'todo.agent.noProjects': "üìÅ Aucun projet cr√©√©. Dites 'Cr√©e un projet [nom]' pour commencer !",
                'todo.agent.projectsHeader': 'üìä **Vos projets** ({count}):\n\n',
                'todo.agent.projectStatsLine': '   Progress: {progress}% | T√¢ches: {done}/{total}\n',
                'todo.agent.projectIdLine': '   ID: {id}\n\n',
                'todo.agent.taskTitlePrompt': "‚ùì Quelle t√¢che voulez-vous ajouter ? Exemple: 'Ajoute r√©server l\'h√¥tel √† mes t√¢ches voyage'",
                'todo.agent.taskAdded': '‚úÖ T√¢che ajout√©e: "{title}"\nüìÅ Cat√©gorie: {category}',
                'todo.agent.taskAddedProjectLine': '\nüìä Projet: {project}',
                'todo.agent.activeTasksCount': '\n\nüìã {count} t√¢che(s) active(s).',
                'todo.agent.noActiveTasks': '‚úÖ Aucune t√¢che en cours ! Vous √™tes √† jour. üéâ',
                'todo.agent.tasksHeader': 'üìã **Vos t√¢ches** ({count}):\n\n',
                'todo.agent.noTasksInProgress': "Vous n\'avez pas de t√¢ches en cours.",
                'todo.agent.taskCompleted': '‚úÖ T√¢che "{title}" marqu√©e comme termin√©e !',
                'todo.agent.eventCreated': 'üìÖ √âv√©nement cr√©√©: "{title}"\nüïê Date: {date}\n\n‚úÖ Ajout√© √† votre calendrier !',
                'todo.agent.calendarToday': "üìÖ **Aujourd\'hui** ({count}):\n\n",
                'todo.agent.calendarWeek': 'üìÜ **Cette semaine** ({count} √©v√©nements):\n\n',
                'todo.agent.calendarEmpty': 'üìÖ Votre calendrier est vide. Aucun √©v√©nement programm√© pour le moment.',
                'todo.agent.free': '‚úÖ Vous √™tes libre {day}{slot}! Aucun √©v√©nement programm√©.',
                'todo.agent.dayHasEvents': '{day}, vous avez {count} √©v√©nement(s):\n\n',
                'todo.agent.slotsAllBusy': 'üìÖ Votre semaine est bien charg√©e ! Tous les jours ont des √©v√©nements. Essayez de consulter les d√©tails pour trouver des plages horaires libres.',
                'todo.agent.slotsHeader': 'üìÖ **Cr√©neaux disponibles cette semaine:**\n\n',
                'todo.agent.slotFreeAllDay': '‚úÖ {dayName} - Libre toute la journ√©e',
                'todo.agent.weekPlanHeader': 'üìã **Planning de la semaine:**\n\n',
                'todo.agent.weekPlanEvents': 'üìÖ **√âv√©nements programm√©s:**\n',
                'todo.agent.weekPlanTasksToSchedule': 'üìù **T√¢ches √† planifier ({count}):**\n',
                'todo.agent.weekPlanUndated': "Vous avez des t√¢ches sans date d\'√©ch√©ance:\n",
                'todo.agent.weekPlanTip': "\nüí° Astuce: Dites 'Ajoute une date √† la t√¢che X' pour les planifier !",
                'todo.agent.weekPlanAllPlanned': '‚úÖ Toutes vos t√¢ches sont planifi√©es !',

                'todo.notification.upcomingTitle': 'T√¢che √† venir',
                'todo.notification.upcomingBody': '{title}\n‚è∞ Dans 15 minutes ({time})',

                'todo.calendar.title': 'Calendrier & √âv√©nements',
                'todo.calendar.todayPrefix': "Aujourd'hui",
                'todo.calendar.noEventsToday': "Aucun √©v√©nement aujourd'hui",
                'todo.calendar.thisWeek': 'Cette semaine',
                'todo.calendar.noScheduledTasks': 'Aucune t√¢che programm√©e',

                'todo.empty.title': 'Aucune t√¢che',
                'todo.empty.desc': 'Cr√©ez votre premi√®re t√¢che pour commencer',
                'todo.empty.create': 'Cr√©er une t√¢che',

                'todo.search.noResultsTitle': 'Aucun r√©sultat',
                'todo.search.noResultsDesc': "Essayez avec d'autres mots-cl√©s",

                'todo.confirm.deleteTask': '‚ö†Ô∏è Supprimer cette t√¢che d√©finitivement ?',
                'todo.toast.taskDeleted': 'üóëÔ∏è T√¢che supprim√©e',

                'todo.priority.high': 'Urgent',
                'todo.priority.medium': 'Normal',
                'todo.priority.low': 'Basse',

                'todo.personal.title': 'Espace personnel',
                'todo.personal.loading': 'Chargement des m√©triques‚Ä¶',
                'todo.personal.metricsError': 'Impossible de charger les m√©triques. V√©rifiez que l‚ÄôAPI est disponible.',
                'todo.personal.card.completionTitle': 'Taux de compl√©tion',
                'todo.personal.card.completionSubtitle': '{completed} termin√©e(s) / {total} au total',
                'todo.personal.card.completionHint': 'But MVP: augmenter la r√©gularit√©, pas la vitesse.',
                'todo.personal.card.mentalTitle': 'Charge mentale',
                'todo.personal.card.mentalSubtitle': '{pending} en cours ‚Ä¢ {overdue} en retard',
                'todo.personal.card.mentalHint': 'IA: r√©duire le nombre de t√¢ches visibles et regrouper.',
                'todo.personal.card.stressTitle': 'Indice de stress',
                'todo.personal.card.stressSubtitleOverload': 'Surcharge 24h (~{hours}h)',
                'todo.personal.card.stressSubtitleStreak': 'Streak: {days} jour(s)',
                'todo.personal.card.stressHint': 'IA: proposer des ajustements avant l‚Äôaccumulation de retards.',
                'todo.personal.detailsTitle': 'D√©tails',
                'todo.personal.details.inProgress': 'En cours',
                'todo.personal.advice.overdue': 'Prioriser les t√¢ches en retard ({count}) et d√©couper la plus grosse en sous-t√¢ches.',
                'todo.personal.advice.overload': 'Journ√©e trop charg√©e (‚âà {hours}h sur 24h). Proposer un mode ‚Äújourn√©e all√©g√©e‚Äù ou reporter 1‚Äì2 t√¢ches.',
                'todo.personal.advice.highLoad': 'Charge globale √©lev√©e (‚âà {hours}h). Planifier 2 blocs focus et r√©duire le multit√¢che.',
                'todo.personal.advice.stable': "Rythme stable. Conserver 1 bloc focus + 1 t√¢che courte pour garder l'√©lan.",
                'todo.personal.error.server': 'Erreur serveur: {status} {statusText}',

                'todo.personal.card.overdue': 'En retard',
                'todo.personal.card.workload': 'Charge (estim√©e)',
                'todo.personal.card.next24h': 'Prochaines 24h',
                'todo.personal.aiAdvice': 'Conseils IA',

                'todo.kanban.todo': '√Ä faire',
                'todo.kanban.inProgress': 'En cours',
                'todo.kanban.done': 'Termin√©',

                'todo.add.prompt': 'üìù D√©crivez votre t√¢che (l\'IA va l\'analyser):',
                'todo.add.promptExample': 'Exemple: "Appeler le client urgent lundi 10h pour le projet"',
                'todo.toast.analyzing': 'ü§ñ Analyse de la t√¢che en cours...',
                'todo.toast.taskCreated': '‚úÖ T√¢che cr√©√©e !',
                'todo.toast.taskCreatedSimple': '‚ö†Ô∏è T√¢che cr√©√©e (mode simple - IA indisponible)',
                'todo.toast.taskCompleted': '‚úÖ T√¢che termin√©e !',
                'todo.toast.taskReactivated': 'üîÑ T√¢che r√©activ√©e',

                'todo.details.title': 'D√©tails de la t√¢che',
                'todo.details.dueDateUnset': 'Non d√©finie',
                'todo.details.dueDateLabel': '√âch√©ance',
                'todo.details.descriptionLabel': 'Description',
                'todo.details.subtasksLabel': 'Sous-t√¢ches',
                'todo.details.notifyMeTitle': 'Me notifier',
                'todo.details.notifyMeDesc': 'Recevoir une notification avant la t√¢che',
                'todo.details.notifyLabel': 'Notifier',
                'todo.details.before': 'avant',
                'todo.details.minutes': 'minutes',
                'todo.details.hour': '1 heure',
                'todo.details.hours2': '2 heures',
                'todo.details.day': '1 jour',
                'todo.details.reactivateBtn': 'R√©activer',
                'todo.details.completeBtn': 'Terminer',
                'todo.error.open': "Erreur lors de l'ouverture d'AI Task",
                'todo.error.load': "Erreur lors du chargement d'AI Task. Veuillez r√©essayer.",

                'rnd.applyActionsConfirm': 'Appliquer {count} action(s) au dashboard R&D ?',
                'rnd.clearChatConfirm': '‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer tout l\'historique des conversations avec Agent dev?\n\nCette action est irr√©versible.',
                
                // Module RH
                'hr.title': 'Dashboard RH',
                'hr.subtitle': 'Gestion RH avec √©crans d√©di√©s (employ√©s, cong√©s, paie, recrutement) et automatisations (selon configuration RH).',
                'hr.tab.employees': 'Employ√©s',
                'hr.tab.leaves': 'Cong√©s',
                'hr.tab.payroll': 'Paie',
                'hr.tab.recruitment': 'Recrutement',
                'hr.tab.agent': 'Agent RH',
                'hr.stat.totalEmployees': 'Total Employ√©s',
                'hr.stat.activeLeaves': 'Cong√©s en attente',
                'hr.stat.leavesHint': 'Cong√©s + Maladie',
                'hr.tab.dashboard': 'Dashboard',
                'hr.tab.reviews': '√âvaluations',
                'hr.tab.turnover': 'Turnover',
                'hr.tab.company': 'Entreprise',
                'hr.stat.absentToday': 'Absents aujourd\'hui',
                'hr.stat.totalSalary': 'Masse salariale',
                'hr.stat.monthlyGross': 'Brut mensuel',
                'hr.stat.toProcess': '√Ä traiter',
                'hr.stat.noEmployee': 'Aucun employ√©',
                
                'hr.actions.title': 'Actions Rapides',
                'hr.actions.newEmployee': 'Nouvel Employ√©',
                'hr.actions.manageLeaves': 'G√©rer Cong√©s',
                'hr.actions.generatePayroll': 'G√©n√©rer Paie',
                
                'hr.notifications.title': 'Notifications',
                'hr.notifications.empty': 'Aucune notification',
                'hr.notifications.uptodate': 'Tout est √† jour',

                'hr.btn.back': 'Retour',
                'hr.filters.title': 'Filtres de recherche',
                'hr.filters.allDepartments': 'Tous les d√©partements',
                'hr.filters.allStatus': 'Tous les statuts',

                'hr.employees.subtitle': 'Gestion compl√®te du personnel',
                'hr.employees.empty.title': 'Aucun employ√©',
                'hr.employees.empty.desc': 'Commencez par ajouter votre premier employ√© √† la liste',
                'hr.employees.empty.addBtn': 'Ajouter un Employ√©',
                'hr.employees.list.header.employee': 'Employ√©',
                'hr.employees.list.header.position': 'Poste',
                'hr.employees.list.header.department': 'D√©partement',
                'hr.employees.list.header.email': 'Email',
                'hr.employees.list.header.status': 'Statut',
                'hr.employees.list.header.actions': 'Actions',
                'hr.employees.status.active': 'Actif',
                'hr.employees.status.onLeave': 'En cong√©',
                'hr.employees.status.terminated': 'Termin√©',
                'hr.employees.action.view': 'Voir',
                'hr.employees.action.delete': 'Supprimer',
                
                'hr.employees.modal.title': 'Nouvel Employ√©',
                'hr.employees.modal.subtitle': 'Ajouter un nouveau membre √† l\'√©quipe',
                'hr.employees.modal.section.personal': 'Informations personnelles',
                'hr.employees.modal.label.firstName': 'Pr√©nom *',
                'hr.employees.modal.placeholder.firstName': 'Ex: Ahmed',
                'hr.employees.modal.label.lastName': 'Nom *',
                'hr.employees.modal.placeholder.lastName': 'Ex: Benali',
                'hr.employees.modal.label.email': 'Email *',
                'hr.employees.modal.placeholder.email': 'ahmed.benali@company.dz',
                'hr.employees.modal.label.phone': 'T√©l√©phone',
                'hr.employees.modal.placeholder.phone': '+213 555 123 456',
                'hr.employees.modal.label.birthDate': 'Date de naissance *',
                'hr.employees.modal.label.address': 'Adresse *',
                'hr.employees.modal.placeholder.address': 'Ex: 123 Rue de la Libert√©, Alger',
                'hr.employees.modal.section.professional': 'Informations professionnelles',
                'hr.employees.modal.label.position': 'Poste *',
                'hr.employees.modal.placeholder.position': 'Ex: D√©veloppeur Full Stack',
                'hr.employees.modal.label.department': 'D√©partement *',
                'hr.employees.modal.placeholder.select': 'S√©lectionner...',
                'hr.employees.modal.label.hireDate': 'Date d\'embauche *',
                'hr.employees.modal.label.contractType': 'Type de contrat *',
                'hr.employees.modal.label.baseSalary': 'Salaire *',
                'hr.employees.modal.placeholder.baseSalary': 'Ex: 3600000',
                'hr.employees.modal.btn.cancel': 'Annuler',
                'hr.employees.modal.btn.submit': '‚úì Ajouter l\'Employ√©',
                'hr.employees.toast.success': '‚úÖ Employ√© ajout√© avec succ√®s',
                'hr.employees.toast.deleted': '‚ùå Employ√© supprim√©',
                
                'hr.employees.details.label.id': 'ID Employ√©',
                'hr.employees.details.notProvided': 'Non renseign√©',
                'hr.employees.details.label.seniority': 'Anciennet√©',
                'hr.employees.details.section.salary': 'Informations salariales',
                'hr.employees.details.label.annualSalary': 'Salaire annuel',
                'hr.employees.details.label.monthlySalary': 'Salaire mensuel',
                'hr.employees.details.btn.close': 'Fermer',
                'hr.employees.details.btn.certificate': 'G√©n√©rer une attestation de travail',
                
                
    // Common HR
    'hr.common.employee': 'Employ√©',
    'hr.common.type': 'Type',
    'hr.common.startDate': 'Date D√©but',
    'hr.common.endDate': 'Date Fin',
    'hr.common.duration': 'Dur√©e',
    'hr.common.status': 'Statut',
    'hr.common.actions': 'Actions',
    'hr.common.date': 'Date',
                'hr.common.year': 'an',
                'hr.common.years': 'ans',
                'hr.common.month': 'mois',
                'hr.common.months': 'mois',
                'hr.common.and': 'et',

                'hr.leaves.subtitle': 'Suivi et validation des demandes',
    'hr.leaves.modal.title': 'Nouvelle Demande de Cong√©',
        'hr.leaves.modal.label.employee': 'Employ√© *',
        'hr.leaves.modal.placeholder.selectEmployee': 'S√©lectionner un employ√©...',
        'hr.leaves.modal.label.type': 'Type de cong√© *',
        'hr.leaves.modal.placeholder.selectType': 'S√©lectionner...',
        'hr.leaves.modal.label.startDate': 'Date de d√©but *',
        'hr.leaves.modal.label.endDate': 'Date de fin *',
        'hr.leaves.modal.label.reason': 'Motif (optionnel)',
        'hr.leaves.modal.placeholder.reason': 'Raison de la demande de cong√©...',
        'hr.leaves.modal.button.cancel': 'Annuler',
        'hr.leaves.modal.button.create': 'Cr√©er la Demande',

    'hr.leaves.modal.subtitle': 'Remplissez les informations ci-dessous',
    'hr.leaves.calendar.title': 'Planning des Cong√©s',
    'hr.leaves.calendar.subtitle': 'Vue mensuelle avec suivi des chevauchements',
    'hr.leaves.calendar.filterDept': 'Filtrer par d√©partement',
    'hr.leaves.calendar.allDepts': 'Tous les d√©partements',
                'hr.leaves.calendar.legend': 'L√©gende',
                'hr.leaves.calendar.today': 'Aujourd\'hui',
                'hr.leaves.calendarBtn': 'Calendrier',
                'hr.leaves.stat.approved': 'Approuv√©es',
                'hr.leaves.stat.pending': 'En attente',
                'hr.leaves.stat.rejected': 'Refus√©es',
                'hr.leaves.stat.today': 'Absents aujourd\'hui',
                'hr.leaves.searchPlaceholder': 'Rechercher par nom d\'employ√©...',
                'hr.leaves.filter.allTypes': 'Tous les types',
                'hr.leaves.empty.title': 'Aucune demande de cong√©',
                'hr.leaves.empty.desc': 'Commencez par cr√©er votre premi√®re demande de cong√©',
                'hr.leaves.newRequestBtn': 'Nouvelle Demande',
                
                'hr.leaves.type.paid': 'Cong√© pay√©',
                'hr.leaves.type.sick': 'Maladie',
                'hr.leaves.type.unpaid': 'Sans solde',
                'hr.leaves.type.parental': 'Parental',
                'hr.leaves.type.other': 'Autre',
                
                'hr.leaves.status.pending': 'En attente',
                'hr.leaves.status.approved': 'Approuv√©e',
                'hr.leaves.status.rejected': 'Refus√©e',
                
                'hr.payroll.title': 'Gestion de la Paie',
                'hr.payroll.filters.title': 'Filtres et actions',
                'hr.payroll.filters.searchPlaceholder': 'Rechercher un employ√©...',
                'hr.payroll.filters.allStatus': 'Tous les statuts',
                'hr.payroll.status.pending': 'En attente',
                'hr.payroll.status.validated': 'Valid√©',
                'hr.payroll.status.paid': 'Pay√©',
                
                'hr.reviews.title': '√âvaluations de Performance',
                'hr.reviews.subtitle': 'Suivi des performances & d√©veloppement',
                'hr.reviews.stat.total': 'Total √âvaluations',
                'hr.reviews.stat.scheduled': 'Planifi√©es',
                'hr.reviews.stat.completed': 'Termin√©es',
                'hr.reviews.stat.averageScore': 'Score Moyen',
                'hr.reviews.btn.new': 'Nouvelle √âvaluation',
                'hr.reviews.details.title': '√âvaluation de Performance',
                'hr.reviews.details.scoresTitle': 'Scores d√©taill√©s',
                'hr.reviews.details.overallRating': 'Note globale',
                'hr.reviews.details.close': 'Fermer',
                'hr.reviews.details.employee': 'Employ√©',
    'hr.reviews.modal.title': 'Nouvelle √âvaluation',
    'hr.reviews.modal.subtitle': 'Renseignez la p√©riode, l\'√©valuateur et les crit√®res',
    'hr.reviews.modal.employee': 'Employ√©',
    'hr.reviews.modal.selectEmployee': 'S√©lectionner...',
    'hr.reviews.modal.period': 'P√©riode',
    'hr.reviews.modal.periodPlaceholder': 'Ex: Q4 2025, Annuelle 2025',
    'hr.reviews.modal.type': 'Type d\'√©valuation',
    'hr.reviews.modal.typeAnnual': 'Annuelle',
    'hr.reviews.modal.typeSemiannual': 'Semestrielle',
    'hr.reviews.modal.typeQuarterly': 'Trimestrielle',
    'hr.reviews.modal.typeProbation': 'P√©riode d\'essai',
    'hr.reviews.modal.evaluator': '√âvaluateur',
    'hr.reviews.modal.evaluatorPlaceholder': 'Ex: Jean Dupont',
    'hr.reviews.modal.criteria': 'Crit√®res d\'√©valuation',
    'hr.reviews.modal.technical': 'Comp√©tences Techniques',
    'hr.reviews.modal.behavioral': 'Comp√©tences Comportementales',
    'hr.reviews.modal.performance': 'Performance & Productivit√©',
    'hr.reviews.modal.development': 'D√©veloppement & Apprentissage',
    'hr.reviews.modal.strengths': 'Points forts',
    'hr.reviews.modal.strengthsPlaceholder': 'Ex: Excellente communication, leadership naturel...',
    'hr.reviews.modal.improvements': 'Axes d\'am√©lioration',
    'hr.reviews.modal.improvementsPlaceholder': 'Ex: Gestion du temps, comp√©tences techniques sp√©cifiques...',
    'hr.reviews.modal.objectives': 'Objectifs pour la prochaine p√©riode',
    'hr.reviews.modal.objectivesPlaceholder': 'Ex: Suivre une formation en management, augmenter la productivit√© de 15%...',
    'hr.reviews.modal.comments': 'Commentaires g√©n√©raux',
    'hr.reviews.modal.commentsPlaceholder': 'Commentaires additionnels...',
    'hr.reviews.modal.cancel': 'Annuler',
    'hr.reviews.modal.create': 'Cr√©er l\'√âvaluation',
    'hr.reviews.modal.noEmployees': 'Aucun employ√© trouv√©. Ajoutez des employ√©s d\'abord.',
                'hr.reviews.stat.completedLabel': '√âvaluations r√©alis√©es',
                'hr.reviews.stat.scoreLabel': 'Sur 5 √©toiles',
                'hr.reviews.stat.excellent': 'Excellent',
                'hr.reviews.stat.excellentLabel': 'Notes ‚â• 4.5',
                'hr.reviews.filter.allEmployees': 'Tous les employ√©s',
                'hr.reviews.filter.allPeriods': 'Toutes les p√©riodes',
                'hr.reviews.filter.search': 'üîç Rechercher...',
                'hr.reviews.empty.title': 'Aucune √©valuation',
                'hr.reviews.empty.desc': 'Cr√©ez votre premi√®re √©valuation pour commencer',

                'hr.turnover.rgpd.title': 'Conformit√© RGPD - Donn√©es Sensibles',
                'hr.turnover.rgpd.desc': 'Cette fonctionnalit√© analyse des donn√©es RH pour pr√©dire les risques de d√©part. Toutes les donn√©es sont trait√©es dans le navigateur (localStorage).',
                'hr.turnover.rgpd.badge.minimized': '‚úì Donn√©es minimis√©es',
                'hr.turnover.rgpd.badge.explainable': '‚úì Explicabilit√© totale',
                'hr.turnover.rgpd.badge.noSurveillance': '‚úì Pas de surveillance',
                'hr.turnover.rgpd.badge.consent': '‚úì Consentement requis',
                'hr.turnover.details.mainTitle': 'Analyse de risque de turnover',
                'hr.turnover.details.mainSubtitle': 'Analyse conforme RGPD - Donn√©es explicables et transparentes',
                'hr.turnover.details.riskScore': 'Score de risque',
                'hr.turnover.details.window': 'Fen√™tre : {0} derniers mois',
                'hr.turnover.details.identifiedFactors': 'Facteurs de risque identifi√©s',
                
                'hr.turnover.risk.high': 'Risque √©lev√©',
                'hr.turnover.risk.medium': 'Risque moyen',
                'hr.turnover.risk.low': 'Risque faible',
                'hr.turnover.risk.highDesc': 'Score ‚â• 70% - Action imm√©diate',
                'hr.turnover.risk.mediumDesc': 'Score 40-69% - Surveillance',
                'hr.turnover.risk.lowDesc': 'Score < 40% - Stable',

                'hr.turnover.label.confidence': 'Confidence',
                'hr.turnover.label.factors': 'Risk factors',
                'hr.turnover.label.recommendedActions': 'Recommended actions',
                'hr.turnover.label.otherFactors': 'more factors...',
                'hr.turnover.priority.high': 'PRIORITY',
                'hr.turnover.priority.recommended': 'Recommended',
                
                'hr.turnover.btn.analyze': 'Analyser les risques',
                'hr.turnover.btn.rgpdSettings': 'Param√®tres RGPD',
                'hr.turnover.btn.close': 'Fermer',
                'hr.turnover.filter.allLevels': 'Tous les niveaux',
                'hr.turnover.searchPlaceholder': 'Rechercher un employ√©...',
                
                'hr.turnover.empty.title': 'Aucune analyse disponible',
                'hr.turnover.empty.desc': 'Cliquez sur "Analyser les risques" pour g√©n√©rer les pr√©dictions',
                'hr.turnover.empty.hint': "L'analyse n√©cessite des donn√©es d'employ√©s, cong√©s et √©valuations",

                'hr.turnover.empty.filteredTitle': 'Aucun r√©sultat',
                'hr.turnover.empty.filteredDesc': 'Aucun employ√© ne correspond √† vos filtres. Modifiez la recherche ou le niveau de risque.',

                // Recruitment
                'hr.recruitment.rgpd.title': 'Conformit√© RGPD - CV Screening',
                'hr.recruitment.rgpd.desc': 'Analyse des CV avec transparence et explicabilit√©. L\'humain reste d√©cisionnaire.',
                'hr.recruitment.rgpd.badge.minimized': '‚úì Donn√©es minimis√©es',
                'hr.recruitment.rgpd.badge.explainable': '‚úì Scoring explicable',
                'hr.recruitment.rgpd.badge.human': '‚úì Humain d√©cide',
                'hr.recruitment.rgpd.badge.audit': '‚úì Audit trail',
                'hr.recruitment.rgpd.close': 'Fermer',

                'hr.recruitment.stats.activeJobs': 'Offres actives',
                'hr.recruitment.stats.activeJobsSub': 'Postes en recrutement',
                'hr.recruitment.stats.cvs': 'CV re√ßus',
                'hr.recruitment.stats.cvsSub': 'Tous candidats',
                'hr.recruitment.stats.shortlist': 'Shortlist',
                'hr.recruitment.stats.shortlistSub': 'Candidats qualifi√©s',
                'hr.recruitment.stats.avgScore': 'Score moyen',
                'hr.recruitment.stats.avgScoreSub': 'Match moyen / 100',

                'hr.recruitment.backup.title': 'Sauvegarde / Restauration',
                'hr.recruitment.backup.desc': 'T√©l√©chargez ou restaurez toutes les donn√©es (offres, CV, analyses)',
                'hr.recruitment.backup.save': 'Sauvegarder',
                'hr.recruitment.backup.restore': 'Restaurer',

                'hr.recruitment.actions.newJob': 'Nouvelle Offre',
                'hr.recruitment.actions.uploadCV': 'Upload CV',
                'hr.recruitment.filter.allJobs': 'Toutes les offres',
                'hr.recruitment.actions.toggleShortlist': 'Tout afficher',
                'hr.recruitment.actions.toggleShortlistOnly': 'Shortlist uniquement',
                'hr.recruitment.actions.scoringSettings': 'Scoring & Filtres',

                'hr.recruitment.empty.title': 'Aucun CV analys√©',
                'hr.recruitment.empty.desc': 'Cr√©ez une offre d\'emploi et uploadez des CV pour commencer',
                'hr.recruitment.empty.createJob': 'Cr√©er une offre',
                'hr.recruitment.empty.uploadCV': 'Upload CV',

                // Modals Recruitment
                'hr.recruitment.modal.addJob.title': 'üíº Nouvelle Offre d\'Emploi',
                'hr.recruitment.modal.addJob.subtitle': 'Cr√©ez une offre active pour analyser ensuite les CV.',
                'hr.recruitment.modal.addJob.label.title': 'Titre du poste *',
                'hr.recruitment.modal.addJob.placeholder.title': 'Ex: D√©veloppeur Full Stack Senior',
                'hr.recruitment.modal.addJob.label.department': 'D√©partement *',
                'hr.recruitment.modal.addJob.placeholder.department': 'Ex: IT',
                'hr.recruitment.modal.addJob.label.location': 'Localisation *',
                'hr.recruitment.modal.addJob.placeholder.location': 'Ex: Lisbonne, Portugal',
                'hr.recruitment.modal.addJob.label.description': 'Description du poste *',
                'hr.recruitment.modal.addJob.placeholder.description': 'Missions principales, responsabilit√©s...',
                'hr.recruitment.modal.addJob.label.skills': 'Comp√©tences requises * (s√©par√©es par virgule)',
                'hr.recruitment.modal.addJob.placeholder.skills': 'Ex: React, Node.js, MongoDB, Docker, AWS',
                'hr.recruitment.modal.addJob.label.minExperience': 'Exp√©rience minimale (ann√©es) *',
                'hr.recruitment.modal.addJob.label.language': 'Langue *',
                'hr.recruitment.modal.addJob.placeholder.language': 'Ex: Fran√ßais',
                'hr.recruitment.modal.addJob.label.level': 'Niveau *',
                'hr.recruitment.modal.addJob.btn.publish': 'Publier l\'Offre',
                'hr.recruitment.modal.addJob.btn.cancel': 'Annuler',
                'hr.recruitment.modal.addJob.label.mustHave': 'Crit√®res must-have (optionnels)',
                'hr.recruitment.modal.addJob.placeholder.mustHave': 'Ex: Permis B, Disponible imm√©diatement, Ma√Ætrise anglais...',
                'hr.recruitment.modal.addJob.hint.mustHave': 'Les CV sans ces crit√®res seront automatiquement filtr√©s',

                'hr.recruitment.modal.uploadCV.title': 'üìÑ Analyser un CV avec IA',
                'hr.recruitment.modal.uploadCV.subtitle': 'Parsing automatique via Azure Vision + Azure OpenAI. Aucune donn√©e sensible n‚Äôest prise en compte.',
                'hr.recruitment.modal.uploadCV.hint': '‚ú® Upload un CV (PDF/JPG/PNG) et l\'IA extrait automatiquement les donn√©es',
                'hr.recruitment.modal.uploadCV.btn.analyze': 'ü§ñ Analyser avec IA',
                'hr.recruitment.modal.uploadCV.btn.cancel': '‚ùå Annuler',
                'hr.recruitment.toast.createJobFirst': 'Cr√©ez d\'abord une offre d\'emploi',
                'hr.recruitment.modal.uploadCV.label.targetJob': 'Offre cibl√©e *',
                'hr.recruitment.modal.uploadCV.placeholder.select': 'S√©lectionner...',
                'hr.recruitment.modal.uploadCV.label.file': 'Fichier CV * (PDF, JPG, PNG)',
                'hr.recruitment.modal.uploadCV.hint.file': 'üí° Pour de meilleurs r√©sultats, utilisez un CV avec un texte clair et lisible',

                'hr.recruitment.modal.scoring.title': '‚öôÔ∏è Scoring & Filtres',
                'hr.recruitment.modal.scoring.subtitle': 'Rappel des r√®gles de scoring et du filtrage par offre (RGPD: explicable, d√©cision finale humaine).',
                'hr.recruitment.modal.scoring.section.weights': 'Scoring (pond√©rations)',
                'hr.recruitment.modal.scoring.weight.skills': 'Comp√©tences',
                'hr.recruitment.modal.scoring.weight.experience': 'Exp√©rience',
                'hr.recruitment.modal.scoring.weight.languages': 'Langues',
                'hr.recruitment.modal.scoring.weight.education': 'Dipl√¥me',
                'hr.recruitment.modal.scoring.weight.mustHave': 'Must-have',
                'hr.recruitment.modal.scoring.mustHaveDesc': 'Si des crit√®res must-have sont d√©finis sur l‚Äôoffre, un CV qui ne les remplit pas est marqu√© comme non conforme.',
                'hr.recruitment.modal.scoring.section.thresholds': 'Seuils (recommandation)',
                'hr.recruitment.modal.scoring.threshold.recommended': 'Recommand√©',
                'hr.recruitment.modal.scoring.threshold.shortlist': 'Shortlist',
                'hr.recruitment.modal.scoring.section.filters': 'Filtres',
                'hr.recruitment.modal.scoring.filtersDesc': 'Utilisez le filtre <strong>Toutes les offres</strong> pour afficher uniquement les candidats li√©s √† une offre.',
                'hr.recruitment.modal.scoring.btn.close': 'Fermer',

                'hr.recruitment.toast.pdfGenerated': '‚úÖ PDF t√©l√©charg√©',
                'hr.recruitment.toast.pdfFallback': '‚ö†Ô∏è PDF g√©n√©r√© en mode local (fallback)',
                'hr.recruitment.toast.pdfJsonFallback': '‚ö†Ô∏è PDF indisponible, sauvegarde JSON t√©l√©charg√©e',
                'hr.recruitment.toast.saveError': '‚ùå Impossible de sauvegarder les donn√©es recrutement',
                'hr.recruitment.toast.restoreSuccess': '‚úÖ Restauration: {jobs} offres, {candidates} CV',
                'hr.recruitment.toast.restoreError': '‚ùå Erreur: {error}',
                'hr.recruitment.toast.confirmRestore': 'üìä Restaurer les donn√©es?\n\nActuelles: {currentJobs} offres, {currentCandidates} CV\nFichier: {newJobs} offres, {newCandidates} CV\n\n‚ö†Ô∏è Les donn√©es actuelles seront remplac√©es!',
                'hr.recruitment.toast.jobPublished': 'Offre publi√©e avec succ√®s',
                'hr.recruitment.toast.fileTooLarge': 'Fichier trop volumineux (max 10 MB)',
                'hr.recruitment.toast.selectCV': 'S√©lectionnez un fichier CV',
                'hr.recruitment.toast.extractingText': 'üîç Extraction du texte avec Azure Vision...',
                'hr.recruitment.toast.analyzingAI': '‚ú® CV analys√© par Azure OpenAI...',
                'hr.recruitment.toast.jobNotFound': 'Offre non trouv√©e',
                'hr.recruitment.toast.analysisSuccess': '‚úÖ CV analys√© avec IA - Score: {score}%',
                'hr.recruitment.toast.candidateNotFound': '‚ùå Candidat introuvable',
                'hr.recruitment.toast.shortlistAdded': '‚≠ê Ajout√© √† la shortlist',
                'hr.recruitment.toast.shortlistRemoved': '‚úÖ Retir√© de la shortlist',

                'hr.recruitment.modal.details.scoreTitle': 'Score de compatibilit√©',
                'hr.recruitment.modal.details.jobTitle': 'Candidature pour',
                'hr.recruitment.modal.details.analysisTitle': 'üìä Analyse d√©taill√©e',
                'hr.recruitment.modal.details.profileTitle': 'üë§ Profil du candidat',
                'hr.recruitment.modal.details.strengthsTitle': '‚úÖ Points forts',
                'hr.recruitment.modal.details.risksTitle': '‚ö†Ô∏è Points d\'attention',
                'hr.recruitment.modal.details.missingKeywordsTitle': '‚ùå Comp√©tences manquantes',
                'hr.recruitment.modal.details.anomaliesTitle': 'üîç Anomalies d√©tect√©es',
                'hr.recruitment.modal.details.gdpr': '‚ÑπÔ∏è Transparence RGPD : Ce scoring est calcul√© automatiquement selon les crit√®res suivants : Comp√©tences (40%), Exp√©rience (30%), Langues (10%), Dipl√¥me (10%), Crit√®res must-have (10%). Aucune donn√©e sensible (origine, religion, sant√©) n\'est analys√©e. La d√©cision finale reste humaine.',
                'hr.recruitment.modal.details.btn.close': 'Fermer',
                'hr.recruitment.modal.details.btn.removeFromShortlist': '‚≠ê Retirer de la shortlist',
                'hr.recruitment.filter.allJobs': 'Toutes les offres',
                'hr.recruitment.modal.details.btn.addToShortlist': '‚úÖ Ajouter √† la shortlist',
                'hr.recruitment.card.matchLabel': 'Match',
                'hr.recruitment.jobDeleted': 'Offre supprim√©e',
                'hr.recruitment.modal.details.detailSkills': 'Comp√©tences d√©taill√©es',
                'hr.recruitment.modal.details.lastJob': 'Derni√®re exp√©rience',
                'hr.recruitment.modal.details.certifications': 'Certifications',

                'hr.recruitment.analysis.strength.skills': 'Excellente ad√©quation des comp√©tences techniques',
                'hr.recruitment.analysis.risk.skills': 'Comp√©tences techniques insuffisantes',
                'hr.recruitment.analysis.strength.experience': '{years} ans d\'exp√©rience suppl√©mentaire au-del√† du minimum',
                'hr.recruitment.analysis.risk.experienceSlight': 'L√©g√®rement en dessous de l\'exp√©rience requise',
                'hr.recruitment.analysis.risk.experienceGap': '{years} ans d\'exp√©rience manquants',
                'hr.recruitment.analysis.strength.education': 'Formation acad√©mique excellente',
                'hr.recruitment.analysis.risk.language': 'Niveau de langue √† v√©rifier',
                'hr.recruitment.analysis.risk.mustHave': 'Crit√®res must-have non satisfaits',
                'hr.recruitment.analysis.anomaly.experienceHigh': '‚ö†Ô∏è Exp√©rience exceptionnellement √©lev√©e (surqualification?)',
                'hr.recruitment.analysis.anomaly.skillsLow': '‚ö†Ô∏è Peu de comp√©tences list√©es',
                'hr.recruitment.analysis.anomaly.lastJobMissing': '‚ö†Ô∏è Derni√®re exp√©rience non renseign√©e',
                'hr.recruitment.analysis.recommendation.excellent': '‚úÖ RECOMMAND√â - Excellent profil',
                'hr.recruitment.analysis.recommendation.shortlist': '‚úÖ SHORTLIST - Bon candidat √† interviewer',
                'hr.recruitment.analysis.recommendation.review': '‚ö†Ô∏è √Ä √âVALUER - Profil int√©ressant mais n√©cessite validation',
                'hr.recruitment.analysis.recommendation.rejectedMustHave': '‚ùå REJET√â - Crit√®res must-have non satisfaits',
                'hr.recruitment.analysis.recommendation.rejected': '‚ùå NON RECOMMAND√â - Profil insuffisant',

                // Recruitment Levels
                'hr.recruitment.level.a2': 'A2 - √âl√©mentaire',
                'hr.recruitment.level.b1': 'B1 - Interm√©diaire',
                'hr.recruitment.level.b2': 'B2 - Interm√©diaire avanc√©',
                'hr.recruitment.level.c1': 'C1 - Avanc√©',
                'hr.recruitment.level.c2': 'C2 - Ma√Ætrise',
                'hr.recruitment.placeholder.minExperience': 'Ex: 3',
                'hr.recruitment.candidate.noName': 'Sans nom',
                'hr.recruitment.candidate.noEmail': 'Email non renseign√©',
                'hr.recruitment.candidate.pending': 'Analyse en attente',
                'hr.recruitment.label.weight': 'Poids',

                'hr.payroll.subtitle': 'Bulletins de salaire et masse salariale',


                'common.month.01': 'Janvier',
                'common.month.02': 'F√©vrier',
                'common.month.03': 'Mars',
                'common.month.04': 'Avril',
                'common.month.05': 'Mai',
                'common.month.06': 'Juin',
                'common.month.07': 'Juillet',
                'common.month.08': 'Ao√ªt',
                'common.month.09': 'Septembre',
                'common.month.10': 'Octobre',
                'common.month.11': 'Novembre',
                'common.month.12': 'D√©cembre',
                'hr.payroll.stat.totalMass': 'Masse Salariale Totale',
                'hr.payroll.stat.monthSlips': 'Bulletins du Mois',
                'hr.payroll.stat.pending': 'En Attente',
                'hr.payroll.stat.paidEmployees': 'Employ√©s Pay√©s',
                'hr.payroll.filtersActions': 'Filtres et actions',
                'hr.payroll.filter.allMonths': 'Tous les mois',
                'hr.payroll.generateAllBtn': 'G√©n√©rer Tous',
                'hr.payroll.newSlipBtn': 'Nouveau Bulletin',
    'hr.payroll.modal.newTitle': 'Nouveau Bulletin de Paie',
    'hr.payroll.modal.employee': 'Employ√©',
    'hr.payroll.modal.selectEmployee': 'S√©lectionner un employ√©...',
    'hr.payroll.modal.period': 'P√©riode',
    'hr.payroll.modal.baseSalary': 'Salaire de base',
    'hr.payroll.modal.bonuses': 'Primes',
    'hr.payroll.modal.overtime': 'Heures sup. (h)',
    'hr.payroll.modal.bonusesAndBonus': 'Primes & Bonus',
    'hr.payroll.modal.addBtn': 'Ajouter',
    'hr.payroll.modal.bonusTip': 'Ajoutez des primes, bonus ou indemnit√©s suppl√©mentaires',
    'hr.payroll.modal.deductions': 'D√©ductions',
    'hr.payroll.modal.grossSalary': 'Salaire brut',
    'hr.payroll.modal.netSalary': 'Salaire net',
    'hr.payroll.modal.cancel': 'Annuler',
    'hr.payroll.modal.create': 'Cr√©er le Bulletin',
    'hr.payroll.modal.noEmployees': 'Veuillez d\'abord cr√©er des employ√©s',
                'hr.payroll.modal.selectRequired': 'Veuillez s√©lectionner un √©l√©ment dans la liste.',
                'hr.payroll.success.created': 'Bulletin de paie cr√©√© avec succ√®s',
    'hr.employee.defaultPosition': 'Employ√©',
    'common.months.jan': 'Janvier',
    'common.months.feb': 'F√©vrier',
    'common.months.mar': 'Mars',
    'common.months.apr': 'Avril',
    'common.months.may': 'Mai',
    'common.months.jun': 'Juin',
    'common.months.jul': 'Juillet',
    'common.months.aug': 'Ao√ªt',
    'common.months.sep': 'Septembre',
    'common.months.oct': 'Octobre',
    'common.months.nov': 'Novembre',
    'common.months.dec': 'D√©cembre',
                
                'hr.agent.title': 'Agent RH',
                'hr.agent.desc': 'Assistant IA pour la gestion RH (employ√©s, cong√©s, paie, recrutement, √©valuations)',
                'hr.agent.clearHistory': 'Effacer l\'historique du chat',
                'hr.agent.clearButton': 'Effacer chat',
                'hr.agent.placeholder': 'Posez votre question √† Agent RH...',
                'hr.agent.send': 'Envoyer',
                
                'hr.help.guide': 'Guide',

                'hr.employees.title': 'Liste des Employ√©s',
                'hr.employees.addBtn': 'Ajouter Employ√©',
                'hr.employees.searchPlaceholder': 'Rechercher un employ√©...',
                'hr.employees.table.name': 'Nom',
                'hr.employees.table.position': 'Poste',
                'hr.employees.table.department': 'D√©partement',
                'hr.employees.table.status': 'Statut',
                'hr.employees.table.actions': 'Actions',
                'hr.employees.status.active': 'Actif',
                'hr.employees.status.inactive': 'Inactif',
                'hr.employees.status.onLeave': 'En cong√©',
                'hr.employees.details': 'D√©tails employ√©',
                'hr.employees.deleteConfirm': 'Supprimer cet employ√© ?',

                'hr.leaves.title': 'Gestion des Cong√©s',

    // Payroll
    'hr.payroll.period': 'P√©riode',
    'hr.payroll.grossSalary': 'Salaire Brut',
    'hr.payroll.netSalary': 'Salaire Net',

    'hr.reviews.recommendedActions': 'Actions recommand√©es',
    'hr.reviews.preventiveActions': 'Actions pr√©ventives recommand√©es',
                'hr.leaves.newRequestBtn': 'Nouvelle demande',
                'hr.leaves.table.employee': 'Employ√©',
                'hr.leaves.table.type': 'Type',
                'hr.leaves.table.dates': 'Dates',
                'hr.leaves.table.duration': 'Dur√©e',
                'hr.leaves.table.status': 'Statut',
                'hr.leaves.table.actions': 'Actions',
                'hr.leaves.status.pending': 'En attente',
                'hr.leaves.status.approved': 'Approuv√©',
                'hr.leaves.status.rejected': 'Refus√©',
                'hr.leaves.approve': 'Approuver',
                'hr.leaves.reject': 'Refuser',

                'hr.payroll.title': 'Gestion de la Paie',
                'hr.payroll.generateBtn': 'G√©n√©rer bulletins',
                'hr.payroll.table.period': 'P√©riode',
                'hr.payroll.table.employee': 'Employ√©',
                'hr.payroll.table.netSalary': 'Net √† payer',
                'hr.payroll.table.status': 'Statut',
                'hr.payroll.table.actions': 'Actions',
                'hr.payroll.status.pending': 'Brouillon',
                'hr.payroll.status.validated': 'Valid√©',
                'hr.payroll.status.paid': 'Pay√©',
                'hr.payroll.validate': 'Valider',
                'hr.payroll.markPaid': 'Marquer pay√©',
                'hr.payroll.view': 'Voir bulletin',
                'chat.historyCleared': 'üóëÔ∏è Historique du chat effac√© avec succ√®s',
                'mkt.clearChatConfirm': '‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer tout l\'historique des conversations avec Agent mark?\n\nCette action est irr√©versible.',
                'auth.noAccount': 'Pas encore de compte ?',
                'auth.createAccount': 'Cr√©er un compte',
                'auth.signup.title': 'Cr√©er un compte',
                'auth.signup.fullNameLabel': 'Nom complet',
                'auth.signup.passwordLabel': 'Mot de passe',
                'auth.signup.confirmPasswordLabel': 'Confirmer le mot de passe',
                'auth.signup.confirmPasswordPlaceholder': 'Retapez votre mot de passe',
                'auth.signup.submit': 'Cr√©er mon compte',
                'auth.signup.haveAccount': 'D√©j√† un compte ?',
                'auth.signup.signin': 'Se connecter',
                'auth.signin.title': 'Se connecter',
                'auth.signin.passwordLabel': 'Mot de passe',
                'auth.signin.passwordPlaceholder': 'Votre mot de passe',
                'auth.signin.rememberMe': 'Se souvenir de moi',
                'auth.signin.forgotPassword': 'Mot de passe oubli√© ?',
                'auth.signin.submit': 'Se connecter',
                'auth.passwordMinChars': 'Minimum 6 caract√®res',
                'auth.forgotPassword.title': 'R√©initialiser le mot de passe',
                'auth.forgotPassword.subtitle': 'Entrez votre email et choisissez un nouveau mot de passe',
                'auth.forgotPassword.emailLabel': 'Email',
                'auth.forgotPassword.newPasswordLabel': 'Nouveau mot de passe',
                'auth.forgotPassword.minChars': 'Minimum 6 caract√®res',
                'auth.forgotPassword.submit': 'Changer le mot de passe',
                'auth.forgotPassword.backToSignin': '‚Üê Retour √† la connexion',
                'auth.verification.title': 'V√©rification Email',
                'auth.verification.sentTo': 'Code de v√©rification envoy√© √† :',
                'auth.verification.codeSim': 'Code de v√©rification (simulation) :',
                'auth.verification.productionNote': 'En production, ce code sera envoy√© par email',
                'auth.verification.enterCode': 'Entrez le code de v√©rification',
                'auth.verification.codeHint': 'Code √† 6 chiffres',
                'auth.verification.submit': 'V√©rifier et Cr√©er le Compte',
                'auth.verification.resend': 'Renvoyer le code',
                'auth.verification.cancel': 'Annuler',
                'sidebar.account': 'Mon Compte',
                'sidebar.stats': 'Statistiques',
                'sidebar.settings': 'Param√®tres',
                'sidebar.about': '√Ä propos',
                'sidebar.enterprise': 'Entreprise',
                'sidebar.enterpriseBadge': 'Actif',
                'sessions.group.today': "Aujourd'hui",
                'sessions.group.yesterday': 'Hier',
                'sessions.group.older': 'Plus ancien',
                'stats.messagesExchanged': 'Messages √©chang√©s',
                'stats.conversations': 'Conversations',
                'stats.avgHI': 'HI (global)',
                'stats.avgCHR': 'CHR (global)',
                'stats.hiCoverage': 'Couverture HI',
                'stats.chrCoverage': 'Couverture CHR',
                'stats.recentHI': 'HI (r√©cent, 20 derniers)',
                'stats.recentCHR': 'CHR (r√©cent, 20 derniers)',
                'stats.riskMessages': 'Messages √† risque',
                'stats.highRiskMessages': 'Messages tr√®s risqu√©s',
                'stats.topModels': 'Mod√®les (top)',
                'tooltip.hi': "<strong>Hallucination Index (HI)</strong><br>Mesure le risque qu'une r√©ponse contienne des informations invent√©es ou non v√©rifi√©es.<br><br>‚Ä¢ &lt;15% : Tr√®s fiable<br>‚Ä¢ 15-30% : Fiable<br>‚Ä¢ 30-60% : Prudence<br>‚Ä¢ &gt;60% : Incertitude",
                'tooltip.chr': "<strong>Composite Hallucination Risk (CHR)</strong><br>Indicateur global combinant la confiance de l'IA, l'incertitude et les contradictions d√©tect√©es.<br><br>Plus le CHR est bas, plus la r√©ponse est s√ªre et coh√©rente.",
                'userMenu.close': 'Fermer',
                'userMenu.avatarTitle': 'Cliquez pour changer la photo',
                'userMenu.profilePhoto': 'Photo de profil',
                'userMenu.changePassword': 'Changer le mot de passe',
                'userMenu.privacy': 'Confidentialit√©',
                'userMenu.logout': 'Se d√©connecter',
                'modal.statsTitle': 'Statistiques',
                'modal.aboutTitle': "√Ä propos d'Axilum AI",
                'auth.logoutConfirm': '√ätes-vous s√ªr de vouloir vous d√©connecter ?',
                'auth.goodbye': 'üëã √Ä bient√¥t !',
                'auth.selectImage': '‚ùå Veuillez s√©lectionner une image',
                'auth.imageTooLarge': "‚ùå L'image ne doit pas d√©passer 2MB",
                'auth.profilePhotoUpdated': '‚úÖ Photo de profil mise √† jour !',
                'auth.resetPasswordPrompt': 'Entrez votre nouveau mot de passe (min. 6 caract√®res) :',
                'auth.resetPasswordSuccess': '‚úÖ Mot de passe modifi√© avec succ√®s !',
                'auth.resetPasswordTooShort': '‚ùå Le mot de passe doit contenir au moins 6 caract√®res',
                'auth.alt.profilePhoto': 'Photo de profil',
                'auth.alt.photo': 'Photo',
                'ui.inputPlaceholder': '√âcrivez votre message...',
                'tts.listen': '√âcouter ce message',
                'tts.stop': 'Arr√™ter la lecture',
                'toast.transcriptionDone': '‚úÖ Transcription termin√©e',
                'toast.voiceError': '‚ùå Erreur de reconnaissance vocale',
                'toast.noTextToRead': 'Aucun texte √† lire',
                'voice.listening': 'Je vous √©coute...',
                'voice.thinking': 'Je r√©fl√©chis...',
                'voice.speaking': 'Je vous r√©ponds...',
                'voice.paused': 'En pause - Cliquez pour reprendre',

                'hd.source.otherAi': 'Autre IA',
                'hd.mode.placeholder': "Collez ici le texte √† v√©rifier (r√©ponse d'une autre IA), puis cliquez sur Envoyer‚Ä¶",
                'hd.mode.toast': 'üîç Collez le texte √† v√©rifier puis Envoyer',
                'hd.error.tooLong': 'Texte trop long. Merci de r√©duire (‚âà 50k caract√®res max).',
                'hd.error.unavailable': 'Analyse impossible',
                'hd.error.analysisPrefix': '‚ùå Erreur analyse:',
                'hd.report.title': 'üîé Rapport Hallucination Detector',
                'hd.report.source': 'Source',
                'hd.report.reliability': 'Score de fiabilit√©',
                'hd.report.contradictionRisk': 'Risque de contradiction',
                'hd.report.evidenceCoverage': 'Couverture de preuve',
                'hd.report.uncertainty': 'Incertitude (IC90)',
                'hd.report.claimsDetector': 'Claims (d√©tecteur)',
                'hd.report.facts': 'Faits',
                'hd.report.unverified': 'non confirm√©s',
                'hd.report.internalContradictions': 'Contradictions internes d√©tect√©es',
                'hd.report.securityWarnings': '‚ö†Ô∏è Avertissements s√©curit√©',
                'hd.section.unconfirmed': '‚ö†Ô∏è Points non confirm√©s automatiquement (extraits):',
                'hd.section.probablyFalse': '‚ùå Points probablement faux / non support√©s (extraits):',
                'hd.section.notSupportedClaims': '‚ùå Claims non support√©es (extraits):',
                'hd.section.contradictoryClaims': '‚ö° Claims contradictoires (extraits):',
                'hd.section.verifiedFacts': '‚úÖ Faits trouvant une source (extraits):',
                'hd.section.recommendedSources': 'üìö Sources recommand√©es (√† v√©rifier):',
                'hd.report.recommendation': 'Recommandation',
                'metrics.title': 'M√©triques de r√©ponse',
                'metrics.section.performance': 'Performance',
                'metrics.section.quality': 'Qualit√©',
                'metrics.label.cache': 'Cache',
                'metrics.label.time': 'Temps',
                'metrics.label.tokens': 'Tokens',
                'metrics.label.prompt': 'Prompt',
                'metrics.label.provider': 'Fournisseur',
                'metrics.label.model': 'Mod√®le',
                'metrics.label.arch': 'Archi',

                'settings.appearance': 'Apparence',
                'settings.themeToggleTitle': 'Th√®me Sombre / Clair',
                'settings.themeToggleDesc': 'Basculer entre le mode clair et sombre',
                'settings.aiTitle': 'IA',
                'settings.aiModelLabel': 'Mod√®le IA',
                'settings.aiValidateModel': 'Valider la s√©lection',
                'settings.aiModelSelected': 'Mod√®le s√©lectionn√©',
                'settings.modeTitle': 'Mode',
                'settings.modeAria': 'S√©lecteur de mode',
                'settings.modeHelp': 'Choisissez votre mode de fonctionnement. Certaines fonctionnalit√©s peuvent √™tre limit√©es selon le mode.',
                'settings.dataTitle': 'Gestion des Donn√©es',
                'settings.dataPrivacyTitle': 'Confidentialit√©',
                'settings.dataPrivacyDesc': 'Local vs Cloud, s√©curit√© et conservation',
                'settings.dataExportTitle': 'Exporter Tout',
                'settings.dataExportDesc': 'T√©l√©charger toutes vos conversations',
                'settings.dataClearTitle': 'Effacer Donn√©es',
                'settings.dataClearDesc': 'Supprimer toutes les conversations',
                'settings.dataClearConfirm': '‚ö†Ô∏è Voulez-vous vraiment effacer toutes vos donn√©es ?\n\nCette action est irr√©versible et supprimera :\n- Toutes les conversations\n- Tous les messages\n- Toutes les statistiques\n\nExportez vos donn√©es avant si n√©cessaire.',
                'settings.dataClearedToast': 'Toutes les donn√©es ont √©t√© effac√©es',
                'settings.storageTitle': 'Mode de stockage',
                'settings.storagePrefix': 'Choix actuel :',
                'settings.storage.ask': 'Demander √† chaque upload',
                'settings.storage.local': 'Local (cet appareil)',
                'settings.storage.cloud': 'Cloud s√©curis√©',
                'settings.storage.btn.ask': 'Demander',
                'settings.storage.btn.local': 'Local',
                'settings.storage.btn.cloud': 'Cloud',
                'settings.storageModal.header': 'Stockage',
                'settings.storageModal.modeTitle': 'Mode de stockage',
                'settings.storageModal.help': '<strong>Local</strong> : les fichiers restent sur votre appareil. <strong>Cloud</strong> : synchronisation serveur (connexion requise).',
                'settings.storageModal.quotaTitle': 'Quota stockage Cloud',
                'settings.storageModal.quotaSubtitle': 'Indication (pour activer/acheter du stockage)',
                'settings.storageModal.quotaAddButton': 'Ajouter du stockage',
                'settings.storageModal.quotaTotal': 'Quota total',
                'settings.storageModal.quotaUsed': 'Utilis√©',
                'settings.storageModal.quotaRemaining': 'Reste',
                'settings.storageAddModal.title': 'Ajouter du stockage',
                'settings.storageAddModal.desc': 'S√©lectionnez un pack. (UI pr√™te ‚Äî paiement/activation automatique √† brancher ensuite.)',
                'settings.storageAddModal.pack5': '+5 Go',
                'settings.storageAddModal.pack10': '+10 Go',
                'settings.storageAddModal.pack50': '+50 Go',
                'toast.storagePrefix': 'üóÑÔ∏è Stockage:',
                'settings.pricingTitle': 'Tarification &amp; consommation',
                'settings.pricing.p1': '<strong>Axilum AI fonctionne en pr√©pay√© :</strong> vous chargez un cr√©dit (en $) et vous pouvez utiliser tous les modules tant que ce cr√©dit n‚Äôest pas √©puis√©. La consommation est calcul√©e c√¥t√© serveur √† partir des usages r√©els (tokens, appels IA) et d√©duite automatiquement.',
                'settings.pricing.p2': '<strong>O√π voir le solde ?</strong> Le compteur en haut affiche votre cr√©dit restant. <strong>Pour voir le d√©tail</strong> (p√©riode, co√ªt IA, etc.), cliquez directement sur ce compteur.',
                'settings.pricing.p3': '<strong>Devise :</strong> la facturation est en $ (USD). Utilisez le taux de change actuel pour confirmer le prix.',
                'settings.pricing.p4': '<strong>Prix stockage :</strong> Quota inclus : 100 Mo gratuit. Au-del√† : 0.10 $ / Go / mois. Packs : +5, +10, +50 Go.',
                'settings.pricing.costTitle': 'Co√ªt',
                'settings.pricing.costBody': 'Le <strong>prompt</strong> correspond aux tokens d‚Äôentr√©e (vos messages, instructions). La <strong>completion</strong> correspond aux tokens de sortie (la r√©ponse g√©n√©r√©e).',
                'settings.pricing.byModelTitle': 'Prix par mod√®le :',
                'settings.pricing.byModel.loading': 'Chargement‚Ä¶',
                'settings.pricing.byModel.table.model': 'Mod√®le',
                'settings.pricing.byModel.table.cost': 'Co√ªt',
                'settings.pricing.byModel.na': 'N/A',
                'settings.pricing.byModel.prompt': 'prompt',
                'settings.pricing.byModel.completion': 'completion',
                'settings.infoTitle': 'Informations',
                'settings.infoContent': '<strong>Version :</strong> 1.0.0<br><strong>Derni√®re mise √† jour :</strong> D√©cembre 2025<br><strong>Build :</strong> Production',

                'usage.title': 'Consommation',
                'usage.balanceLabel': 'Cr√©dit restant',
                'usage.monthCostLabel': 'Co√ªt (mois)',
                'usage.monthTokensLabel': 'Appels &amp; tokens',
                'usage.latestTitle': 'Derniers appels',
                'usage.loading': 'Chargement‚Ä¶',
                'usage.errorLoading': 'Impossible de charger la consommation.',
                'usage.noUsage': 'Aucun usage enregistr√© pour cette p√©riode.',
                'usage.periodPrefix': 'P√©riode:',
                'usage.calls': 'appels',
                'usage.tokens': 'tokens',
                'usage.table.date': 'Date',
                'usage.table.model': 'Mod√®le',
                'usage.table.tokens': 'Tokens',
                'usage.table.cost': 'Co√ªt',

                'ai.toast.modelUpdated': 'Mod√®le s√©lectionn√©',
                'ai.toast.modelValidated': 'Mod√®le actif : {model}',
                'ai.help.activePrefix': 'Mod√®le actif:',
                'ai.help.fullId': 'Nom complet:',
                'ai.help.provider': 'Provider:',
                'ai.help.kind': 'Type:',
                'ai.help.category': 'Fonctions:',
                'ai.help.preferences': 'Pr√©f√©rences:',
                'ai.help.pricePrefix': 'Prix:',
                'ai.help.inSuffix': 'entr√©e',
                'ai.help.outSuffix': 'sortie',
                'ai.help.moreInfo': "Pour plus d'informations :",
                'ai.help.hint': "Astuce : survolez un mod√®le dans la liste pour voir son identifiant complet."
            },
            en: {
                'toast.teamAutoActivated': 'ü§ù Team Auto activated',
                'toast.loginToDelete': 'üîí Log in to delete your documents',
                'toast.deleteFailed': '‚ùå Deletion failed',
                'toast.documentsDeleted': '‚úÖ Documents deleted',
                'toast.loginToIndex': 'üîí Log in to index your documents',
                'toast.indexingInProgress': 'üìö Indexing document...',
                'toast.documentIndexed': '‚úÖ Document indexed',
                'ui.newConversation': 'New Conversation',
            'ui.close': 'Close',
            'ui.cancel': 'Cancel',
            'ui.delete': 'Delete',
            'ui.save': 'Save',
            'ui.download': 'Download',
            'ui.confirm': 'Confirm',
            'ui.submit': 'Submit',
            'ui.edit': 'Edit',
            'ui.add': 'Add',
            'ui.search': 'Search',
                'ui.sessions': 'Sessions',
                'ui.settings': 'Settings',
                'ui.languageSection': 'Language',
                'ui.languageLabel': 'Language',
                'ui.languageHelp': 'Applies to the UI and voice.',
                'ui.attachFileTitle': 'Attach a file',
                'ui.voiceInputTitle': 'Voice input',
                'ui.chooseAgentTitle': 'Choose an agent',
                'welcome.subtitle': 'Your smart assistant for all your professional needs',
                'welcome.visionTitle': 'Vision AI',
                'welcome.visionDesc': 'Image analysis',
                'welcome.tasksTitle': 'Task management',
                'welcome.tasksDesc': 'Planning',

                'welcome.excelTitle': 'Excel analysis',
                'welcome.excelDesc': 'Generate a detailed report',
                'welcome.financeTitle': 'Financial report',
                'welcome.financeDesc': 'Analyze and income',
                'welcome.webTitle': 'Web search',
                'welcome.webDesc': 'Find and summarize',
                'welcome.moreTitle': 'More',
                'welcome.moreDesc': 'Show more',
                'welcome.emailTitle': 'Email writing',
                'welcome.emailDesc': 'Professional email',

                'welcome.suggest.excelAnalysis': 'Analyze this Excel file and generate a detailed report',
                'welcome.suggest.financeReport': 'Create a financial report for this month with an analysis of expenses and income. If information is missing, ask me 1-3 questions, then point me to the Finance & Accounting module (Agent Alex) to add/complete data for a more accurate, optimized report.',
                'welcome.suggest.webSearch': 'Research detailed information about [topic] and summarize the key points',
                'welcome.suggest.email': 'Write a professional email to [recipient] about [topic]',
                'welcome.suggest.vision': 'Analyze this image and describe what you see in detail',
                'welcome.suggest.tasks': 'Help me organize my tasks and create a plan for the week. For a more accurate plan, ask me to complete my tasks (due dates, priorities) in AI Task.',

                'excelReport.uploadRequest': 'üìé Please upload an Excel file (.xlsx/.xls) to automatically generate a detailed report.',
                'excelReport.generatePrompt': 'Generate a detailed report from the Excel file I just uploaded.\n\nStructure: 1) Executive summary 2) Key KPIs 3) Trends 4) Anomalies/missing values 5) Recommendations.\n\nAnswer directly with the report (only ask questions if strictly necessary).',
                'excelReport.processingToast': 'üìä Excel received ‚Äî generating the report‚Ä¶',
                'excelReport.doneToast': '‚úÖ Report generated ‚Äî back to Axilum AI',

                'marketStudy.quickBtn': 'Market Study',
                'marketStudy.wizard.title': 'Market study ‚Äî Scoping (step {step}/{total})',
                'marketStudy.wizard.subtitle': 'Answer quickly: we will then collect data via Web search (Agent Wesh), then Agent Alex will analyze it.',
                'marketStudy.field.country': 'Country *',
                'marketStudy.placeholder.country': 'e.g., Portugal',
                'marketStudy.field.region': 'Region / city (optional)',
                'marketStudy.placeholder.region': 'e.g., Lisbon',
                'marketStudy.field.sector': 'Sector *',
                'marketStudy.sector.saas': 'SaaS',
                'marketStudy.sector.health': 'Healthcare',
                'marketStudy.sector.fintech': 'Fintech',
                'marketStudy.sector.education': 'Education',
                'marketStudy.sector.ai': 'AI',
                'marketStudy.sector.ecommerce': 'E-commerce',
                'marketStudy.sector.other': 'Other',
                'marketStudy.field.subSector': 'Sub-sector (optional)',
                'marketStudy.placeholder.subSector': 'e.g., HR SaaS / HealthTech / Payments',
                'marketStudy.field.marketScope': 'Target market *',
                'marketStudy.scope.local': 'Local',
                'marketStudy.scope.national': 'National',
                'marketStudy.scope.international': 'International',
                'marketStudy.field.companySize': 'Company size *',
                'marketStudy.companySize.tpe': 'Small business',
                'marketStudy.companySize.pme': 'Mid-size company',
                'marketStudy.companySize.ge': 'Large enterprise',
                'marketStudy.field.companyScope': 'Current company reach *',
                'marketStudy.field.businessModel': 'Business model *',
                'marketStudy.field.horizon': 'Time horizon *',
                'marketStudy.horizon.6m': '6 months',
                'marketStudy.horizon.12m': '12 months',
                'marketStudy.horizon.24m': '24 months',
                'marketStudy.field.objective': 'Primary objective *',
                'marketStudy.objective.inflation': 'Inflation impact',
                'marketStudy.objective.goNoGo': 'Go / No-Go',
                'marketStudy.objective.pricing': 'Pricing & positioning',
                'marketStudy.objective.expansion': 'Expansion (new market)',
                'marketStudy.objective.competition': 'Competitive analysis',
                'marketStudy.objective.other': 'Other',
                'marketStudy.field.notes': 'Notes (optional)',
                'marketStudy.placeholder.notes': 'e.g., product, ICP, regulatory constraints...',
                'marketStudy.field.metrics': 'Internal metrics (optional)',
                'marketStudy.placeholder.metrics': 'e.g., pricing, CAC, LTV, margin, churn...',
                'marketStudy.btn.back': 'Back',
                'marketStudy.btn.cancel': 'Cancel',
                'marketStudy.btn.next': 'Next',
                'marketStudy.btn.finish': 'Finish',
                'marketStudy.toast.countryRequired': '‚ö†Ô∏è Country required',
                'marketStudy.summary.title': 'üìä Market study ‚Äî scoping summary',
                'marketStudy.summary.country': 'Country',
                'marketStudy.summary.sector': 'Sector',
                'marketStudy.summary.marketScope': 'Target market',
                'marketStudy.summary.company': 'Company',
                'marketStudy.summary.horizon': 'Horizon',
                'marketStudy.summary.objective': 'Objective',
                'marketStudy.summary.notes': 'Notes',
                'marketStudy.summary.metrics': 'Internal metrics',
                'marketStudy.summary.confirm': 'Do you confirm this information?',
                'marketStudy.action.approve': 'Approve and launch',
                'marketStudy.status.alreadyRunning': '‚è≥ A market study is already running for this conversation‚Ä¶',
                'marketStudy.status.missingDraft': '‚ùå Scoping data not found. Please restart ‚ÄúMarket Study‚Äù.',
                'marketStudy.status.webRunning': 'üîé Web research running‚Ä¶ (Web search ‚Äî Agent Wesh)',
                'marketStudy.status.webDone': '‚úÖ Research completed. Launching analysis‚Ä¶ (Agent Alex)',
                'marketStudy.error.prefix': '‚ùå Market study failed: ',

                'todo.title': 'Tasks and Planning',
                'todo.aiAssistant': 'ToDo Agent',
                'todo.aiAssistantTitle': 'AI assistant',
                'todo.searchPlaceholder': 'Search...',
                'todo.notificationsEnabled': 'Notifications enabled',
                'todo.notificationsEnable': 'Enable notifications',
                'todo.newTask': 'New task',
                'todo.profile': 'Personal profile',
                'todo.profile.filled': 'Profile set. You can adjust it to refine the metrics.',
                'todo.profile.incomplete': 'Profile incomplete. Add age/sex/focus capacity to better personalize the scores.',
                'todo.profile.edit': 'Edit',
                'todo.profile.complete': 'Complete',
                'todo.profile.modal.title': 'Personal information',
                'todo.profile.modal.close': 'Close',
                'todo.profile.modal.desc': 'This info helps personalize metrics and recommendations. You may leave it blank.',
                'todo.profile.modal.age': 'Age',
                'todo.profile.modal.agePlaceholder': 'e.g., 32',
                'todo.profile.modal.sex': 'Sex',
                'todo.profile.modal.sexFemale': 'Female',
                'todo.profile.modal.sexMale': 'Male',
                'todo.profile.modal.sexOther': 'Other',
                'todo.profile.modal.capacity': 'Focus capacity (hours/day)',
                'todo.profile.modal.capacityPlaceholder': 'e.g., 6',
                'todo.profile.modal.capacityHint': 'Helps interpret overload (next 24h).',
                'todo.profile.modal.save': 'Save',
                'todo.menu': 'Menu',
                'todo.close': 'Close',
                'todo.views': 'Views',
                'todo.view.list': 'List',
                'todo.view.kanban': 'Board',
                'todo.view.calendar': 'Calendar',
                'todo.view.personal': 'Personal',

                'todo.filtersTitle': 'Filters',
                'todo.filter.all': 'All',
                'todo.filter.today': 'Today',
                'todo.filter.week': 'Week',
                'todo.filter.urgent': 'Urgent',

                'todo.categoriesTitle': 'Categories',
                'todo.category.all': 'All',
                'todo.category.work': 'Work',
                'todo.category.personal': 'Personal',
                'todo.category.studies': 'Studies',
                'todo.category.travel': 'Travel',
                'todo.category.sport': 'Sport',
                'todo.category.health': 'Health',
                'todo.category.other': 'Other',

                'todo.toast.notificationsNotSupported': '‚ùå Notifications are not supported by this browser',
                'todo.toast.notificationsEnabled': 'üîî Notifications enabled!',
                'todo.toast.permissionDenied': '‚ùå Permission denied',
                'todo.toast.notificationsDisabled': 'üîï Notifications disabled',

                'todo.sidebarTooltip': 'Tasks and Planning - Calendar, Tasks, Planning',

                'todo.toast.addTasksFirst': '‚ÑπÔ∏è Add tasks first',
                'todo.toast.enableBrowserNotifications': 'üí° Enable notifications in your browser',
                'todo.toast.taskNotificationEnabled': 'üîî Notification enabled',
                'todo.toast.taskNotificationEnabledForTask': 'üîî Notification enabled for this task',
                'todo.toast.taskNotificationDisabled': 'üîï Notification disabled',
                'todo.toast.notificationTimeUpdated': '‚è∞ Notification: {when} before',

                'todo.aiAssistant.coachMode': 'Coaching',
                'todo.aiAssistant.subtitle': 'Smart management',
                'todo.aiAssistant.deleteChat': 'Delete chat',
                'todo.aiAssistant.close': 'Close',
                'todo.aiAssistant.helpTitle': 'How can I help?',
                'todo.aiAssistant.helpSubtitle': 'Ask questions about your tasks',
                'todo.aiAssistant.placeholder': 'Ask something...',
                'todo.aiAssistant.sending': 'Sending...',
                'todo.aiAssistant.coachPromptOnEnable': 'Give me a quick tip for today.',

                'todo.smart.prioritiesHeader': 'Here are your priorities:',
                'todo.smart.noTasksToPrioritize': "I couldn't find any tasks to prioritize.",
                'todo.smart.dueDate': ' (due: {date})',
                'todo.smart.overloadWarning': '\n\n‚ö†Ô∏è Potential overload in 24h (~{hours}h).',
                'todo.smart.overloadWarningInline': '\n‚ö†Ô∏è Potential overload in 24h (~{hours}h).',
                'todo.smart.scheduleHeader': 'Proposed schedule (without creating events):',
                'todo.smart.scheduleNoSlots': "I couldn't suggest time slots (not enough tasks or no availability).",
                'todo.smart.coachUnavailable': 'Advice unavailable.',
                'todo.smart.coachWorkLabel': 'Work:',
                'todo.smart.coachPersonalLabel': 'Personal:',
                'todo.smart.productivitySummary': 'Productivity: {completed} done, {pending} in progress, {overdue} overdue.\nStreak: {streak} day(s).\nEstimated workload: ~{hours}h.',
                'todo.smart.summaryFallback': 'Summary.',
                'todo.smart.nextStepsTitle': 'Next steps',
                'todo.smart.suggestionsTitle': 'Suggestions',
                'todo.smart.insightUrgent': 'Urgent: {count}',
                'todo.smart.insightToday': 'Today: {count}',
                'todo.smart.toast.tasksPrefix': '‚úÖ Task(s):',
                'todo.smart.toast.created': '{count} created',
                'todo.smart.toast.updated': '{count} updated',
                'todo.smart.toast.deleted': '{count} deleted',
                'todo.smart.error.server': 'Server error: {status} {statusText}',
                'todo.smart.error.invalidResponse': 'Invalid server response. Check that the API is deployed.',
                'todo.smart.error.genericPrefix': '‚ùå Error: ',

                'todo.agent.notificationsEnabledMessage': '‚úÖ Notifications enabled! You\'ll receive reminders 15 minutes before your events and tasks.\n\nüí° Notifications work even when the tab is in the background.',
                'todo.agent.notificationsDeniedMessage': '‚ùå Unable to enable notifications. Please allow notifications in your browser settings.',
                'todo.agent.projectNamePrompt': "‚ùì What\'s the project name? Example: 'Create a Paris trip project'",
                'todo.agent.projectCreated': '‚úÖ Project created: "{name}"\nüìÅ Category: {category}\nüÜî ID: {id}\n\nüí° Add tasks with: "Add [task] to project {id}"',
                'todo.agent.noProjects': "üìÅ No projects yet. Say 'Create a project [name]' to get started!",
                'todo.agent.projectsHeader': 'üìä **Your projects** ({count}):\n\n',
                'todo.agent.projectStatsLine': '   Progress: {progress}% | Tasks: {done}/{total}\n',
                'todo.agent.projectIdLine': '   ID: {id}\n\n',
                'todo.agent.taskTitlePrompt': "‚ùì What task do you want to add? Example: 'Add book the hotel to my travel tasks'",
                'todo.agent.taskAdded': '‚úÖ Task added: "{title}"\nüìÅ Category: {category}',
                'todo.agent.taskAddedProjectLine': '\nüìä Project: {project}',
                'todo.agent.activeTasksCount': '\n\nüìã {count} active task(s).',
                'todo.agent.noActiveTasks': '‚úÖ No tasks in progress! You\'re all caught up. üéâ',
                'todo.agent.tasksHeader': 'üìã **Your tasks** ({count}):\n\n',
                'todo.agent.noTasksInProgress': "You don't have any tasks in progress.",
                'todo.agent.taskCompleted': '‚úÖ Task "{title}" marked as done!',
                'todo.agent.eventCreated': 'üìÖ Event created: "{title}"\nüïê Date: {date}\n\n‚úÖ Added to your calendar!',
                'todo.agent.calendarToday': 'üìÖ **Today** ({count}):\n\n',
                'todo.agent.calendarWeek': 'üìÜ **This week** ({count} events):\n\n',
                'todo.agent.calendarEmpty': 'üìÖ Your calendar is empty. No events scheduled yet.',
                'todo.agent.free': '‚úÖ You are free {day}{slot}! No events scheduled.',
                'todo.agent.dayHasEvents': '{day}, you have {count} event(s):\n\n',
                'todo.agent.slotsAllBusy': 'üìÖ Your week is quite busy! Every day has events. Check details to find free time slots.',
                'todo.agent.slotsHeader': 'üìÖ **Available slots this week:**\n\n',
                'todo.agent.slotFreeAllDay': '‚úÖ {dayName} - Free all day',
                'todo.agent.weekPlanHeader': 'üìã **Weekly plan:**\n\n',
                'todo.agent.weekPlanEvents': 'üìÖ **Scheduled events:**\n',
                'todo.agent.weekPlanTasksToSchedule': 'üìù **Tasks to schedule ({count}):**\n',
                'todo.agent.weekPlanUndated': 'You have tasks without a due date:\n',
                'todo.agent.weekPlanTip': "\nüí° Tip: Say 'Add a date to task X' to schedule them!",
                'todo.agent.weekPlanAllPlanned': '‚úÖ All your tasks are planned!',

                'todo.notification.upcomingTitle': 'Upcoming task',
                'todo.notification.upcomingBody': '{title}\n‚è∞ In 15 minutes ({time})',

                'todo.calendar.title': 'Calendar & Events',
                'todo.calendar.todayPrefix': 'Today',
                'todo.calendar.noEventsToday': 'No events today',
                'todo.calendar.thisWeek': 'This week',
                'todo.calendar.noScheduledTasks': 'No scheduled tasks',

                'todo.empty.title': 'No tasks',
                'todo.empty.desc': 'Create your first task to get started',
                'todo.empty.create': 'Create a task',

                'todo.search.noResultsTitle': 'No results',
                'todo.search.noResultsDesc': 'Try different keywords',

                'todo.confirm.deleteTask': '‚ö†Ô∏è Delete this task permanently?',
                'todo.toast.taskDeleted': 'üóëÔ∏è Task deleted',

                'todo.priority.high': 'Urgent',
                'todo.priority.medium': 'Normal',
                'todo.priority.low': 'Low',

                'todo.personal.title': 'Personal space',
                'todo.personal.loading': 'Loading metrics‚Ä¶',
                'todo.personal.metricsError': 'Unable to load metrics. Check that the API is available.',
                'todo.personal.card.completionTitle': 'Completion rate',
                'todo.personal.card.completionSubtitle': '{completed} completed / {total} total',
                'todo.personal.card.completionHint': 'MVP goal: increase consistency, not speed.',
                'todo.personal.card.mentalTitle': 'Mental load score',
                'todo.personal.card.mentalSubtitle': '{pending} in progress ‚Ä¢ {overdue} overdue',
                'todo.personal.card.mentalHint': 'AI: reduce visible tasks and batch them.',
                'todo.personal.card.stressTitle': 'Stress index',
                'todo.personal.card.stressSubtitleOverload': 'Overload next 24h (~{hours}h)',
                'todo.personal.card.stressSubtitleStreak': 'Streak: {days} day(s)',
                'todo.personal.card.stressHint': 'AI: propose adjustments before delays build up.',
                'todo.personal.detailsTitle': 'Details',
                'todo.personal.details.inProgress': 'In progress',
                'todo.personal.advice.overdue': 'Prioritize overdue tasks ({count}) and break down the biggest one.',
                'todo.personal.advice.overload': 'Day too busy (‚âà {hours}h over 24h). Offer a ‚Äúlighter day‚Äù mode or postpone 1‚Äì2 tasks.',
                'todo.personal.advice.highLoad': 'High workload (‚âà {hours}h). Plan 2 focus blocks and reduce multitasking.',
                'todo.personal.advice.stable': 'Stable pace. Keep 1 focus block + 1 quick task to maintain momentum.',
                'todo.personal.error.server': 'Server error: {status} {statusText}',

                'todo.personal.card.overdue': 'Overdue',
                'todo.personal.card.workload': 'Workload (est.)',
                'todo.personal.card.next24h': 'Next 24h',
                'todo.personal.aiAdvice': 'AI tips',

                'todo.kanban.todo': 'To do',
                'todo.kanban.inProgress': 'In progress',
                'todo.kanban.done': 'Done',

                'todo.add.prompt': 'üìù Describe your task (AI will analyze it):',
                'todo.add.promptExample': 'Example: "Call the urgent client on Monday 10am for the project"',
                'todo.toast.analyzing': 'ü§ñ Analyzing task‚Ä¶',
                'todo.toast.taskCreated': '‚úÖ Task created!',
                'todo.toast.taskCreatedSimple': '‚ö†Ô∏è Task created (simple mode - AI unavailable)',
                'todo.toast.taskCompleted': '‚úÖ Task completed!',
                'todo.toast.taskReactivated': 'üîÑ Task reactivated',

                'todo.details.title': 'Task details',
                'todo.details.dueDateUnset': 'Not set',
                'todo.details.dueDateLabel': 'Due date',
                'todo.details.descriptionLabel': 'Description',
                'todo.details.subtasksLabel': 'Subtasks',
                'todo.details.notifyMeTitle': 'Notify me',
                'todo.details.notifyMeDesc': 'Receive a notification before the task',
                'todo.details.notifyLabel': 'Notify',
                'todo.details.before': 'before',
                'todo.details.minutes': 'minutes',
                'todo.details.hour': '1 hour',
                'todo.details.hours2': '2 hours',
                'todo.details.day': '1 day',
                'todo.details.reactivateBtn': 'Reactivate',
                'todo.details.completeBtn': 'Complete',
                'todo.error.open': 'Error opening AI Task',
                'todo.error.load': 'Error loading AI Task. Please try again.',

                'rnd.applyActionsConfirm': 'Apply {count} action(s) to the R&D dashboard?',
                'rnd.clearChatConfirm': '‚ö†Ô∏è Are you sure you want to clear the entire chat history with Agent dev?\n\nThis action is irreversible.',
                
                 // HR Module
                'hr.title': 'HR Dashboard',
                'hr.subtitle': 'HR management with dedicated screens (employees, leaves, payroll, recruitment) and automation (depending on HR config).',
                'hr.tab.employees': 'Employees',
                'hr.tab.leaves': 'Leaves',
                'hr.tab.payroll': 'Payroll',
                'hr.tab.recruitment': 'Recruitment',
                'hr.tab.agent': 'HR Agent',
                'hr.stat.totalEmployees': 'Total Employees',
                'hr.stat.activeLeaves': 'Pending Leaves',
                'hr.stat.leavesHint': 'Leave + Sick',
                'hr.tab.dashboard': 'Dashboard',
                'hr.tab.reviews': 'Reviews',
                'hr.tab.turnover': 'Turnover',
                'hr.tab.company': 'Company',
                'hr.stat.absentToday': 'Absent Today',
                'hr.stat.totalSalary': 'Total Payroll',
                'hr.stat.monthlyGross': 'Monthly Gross',
                'hr.stat.toProcess': 'To Process',
                'hr.stat.noEmployee': 'No employee',
                
                'hr.actions.title': 'Quick Actions',
                'hr.actions.newEmployee': 'New Employee',
                'hr.actions.manageLeaves': 'Manage Leaves',
                'hr.actions.generatePayroll': 'Generate Payroll',
                
                'hr.notifications.title': 'Notifications',
                'hr.notifications.empty': 'No notifications',
                'hr.notifications.uptodate': 'Everything is up to date',

                'hr.btn.back': 'Back',
                'hr.filters.title': 'Search filters',
                'hr.filters.allDepartments': 'All departments',
                'hr.filters.allStatus': 'All statuses',

                'hr.employees.subtitle': 'Complete personnel management',
                'hr.employees.empty.title': 'No employees',
                'hr.employees.empty.desc': 'Start by adding your first employee to the list',
                'hr.employees.empty.addBtn': 'Add Employee',
                'hr.employees.list.header.employee': 'Employee',
                'hr.employees.list.header.position': 'Position',
                'hr.employees.list.header.department': 'Department',
                'hr.employees.list.header.email': 'Email',
                'hr.employees.list.header.status': 'Status',
                'hr.employees.list.header.actions': 'Actions',
                'hr.employees.status.active': 'Active',
                'hr.employees.status.onLeave': 'On Leave',
                'hr.employees.status.terminated': 'Terminated',
                'hr.employees.action.view': 'View',
                'hr.employees.action.delete': 'Delete',

                'hr.employees.modal.title': 'New Employee',
                'hr.employees.modal.subtitle': 'Add a new member to the team',
                'hr.employees.modal.section.personal': 'Personal Information',
                'hr.employees.modal.label.firstName': 'First Name *',
                'hr.employees.modal.placeholder.firstName': 'Ex: Ahmed',
                'hr.employees.modal.label.lastName': 'Last Name *',
                'hr.employees.modal.placeholder.lastName': 'Ex: Benali',
                'hr.employees.modal.label.email': 'Email *',
                'hr.employees.modal.placeholder.email': 'ahmed.benali@company.dz',
                'hr.employees.modal.label.phone': 'Phone',
                'hr.employees.modal.placeholder.phone': '+213 555 123 456',
                'hr.employees.modal.label.birthDate': 'Date of Birth *',
                'hr.employees.modal.label.address': 'Address *',
                'hr.employees.modal.placeholder.address': 'Ex: 123 Liberty Street, Algiers',
                'hr.employees.modal.section.professional': 'Professional Information',
                'hr.employees.modal.label.position': 'Position *',
                'hr.employees.modal.placeholder.position': 'Ex: Full Stack Developer',
                'hr.employees.modal.label.department': 'Department *',
                'hr.employees.modal.placeholder.select': 'Select...',
                'hr.employees.modal.label.hireDate': 'Hire Date *',
                'hr.employees.modal.label.contractType': 'Contract Type *',
                'hr.employees.modal.label.baseSalary': 'Salary *',
                'hr.employees.modal.placeholder.baseSalary': 'Ex: 3600000',
                'hr.employees.modal.btn.cancel': 'Cancel',
                'hr.employees.modal.btn.submit': '‚úì Add Employee',
                'hr.employees.toast.success': '‚úÖ Employee added successfully',
                'hr.employees.toast.deleted': '‚ùå Employee deleted',

                'hr.employees.details.label.id': 'Employee ID',
                'hr.employees.details.notProvided': 'Not provided',
                'hr.employees.details.label.seniority': 'Seniority',
                'hr.employees.details.section.salary': 'Salary Information',
                'hr.employees.details.label.annualSalary': 'Annual Salary',
                'hr.employees.details.label.monthlySalary': 'Monthly Salary',
                'hr.employees.details.btn.close': 'Close',
                'hr.employees.details.btn.certificate': 'Generate Work Certificate',

                
    // Common HR
    'hr.common.employee': 'Employee',
    'hr.common.type': 'Type',
    'hr.common.startDate': 'Start Date',
    'hr.common.endDate': 'End Date',
    'hr.common.duration': 'Duration',
    'hr.common.status': 'Status',
    'hr.common.actions': 'Actions',
    'hr.common.date': 'Date',
'hr.common.year': 'year',

    // Payroll
    'hr.payroll.period': 'Period',
    'hr.payroll.grossSalary': 'Gross Salary',
    'hr.payroll.netSalary': 'Net Salary',

    'hr.reviews.recommendedActions': 'Recommended Actions',
    'hr.reviews.preventiveActions': 'Preventive Actions',
                'hr.common.years': 'years',
                'hr.common.month': 'month',
                'hr.common.months': 'months',
                'hr.common.and': 'and',

                'hr.leaves.subtitle': 'Request tracking and validation',
                'hr.leaves.calendarBtn': 'Calendar',
                'hr.leaves.stat.approved': 'Approved',
                'hr.leaves.stat.pending': 'Pending',
                'hr.leaves.stat.rejected': 'Rejected',
                'hr.leaves.stat.today': 'Absent Today',
                'hr.leaves.searchPlaceholder': 'Search by employee name...',
                'hr.leaves.filter.allTypes': 'All types',
                'hr.leaves.empty.title': 'No leave requests',
                'hr.leaves.empty.desc': 'Start by creating your first leave request',
                'hr.leaves.type.paid': 'Paid leave',
                'hr.leaves.type.sick': 'Sick leave',
                'hr.leaves.type.unpaid': 'Unpaid leave',
                'hr.leaves.type.parental': 'Parental leave',
                'hr.leaves.type.other': 'Other',

                'hr.payroll.filters.title': 'Filters and actions',
                'hr.payroll.filters.searchPlaceholder': 'Search employee...',
                'hr.payroll.filters.allMonths': 'All months',
                'hr.payroll.filters.allStatus': 'All statuses',
                'hr.payroll.actions.generateAll': 'Generate All',
                'hr.payroll.actions.new': 'New Slip',

                'hr.payroll.subtitle': 'Payslips and payroll mass',
                'common.month.01': 'January',
                'common.month.02': 'February',
                'common.month.03': 'March',
                'common.month.04': 'April',
                'common.month.05': 'May',
                'common.month.06': 'June',
                'common.month.07': 'July',
                'common.month.08': 'August',
                'common.month.09': 'September',
                'common.month.10': 'October',
                'common.month.11': 'November',
                'common.month.12': 'December',
                'hr.payroll.stat.totalMass': 'Total Payroll Mass',
                'hr.payroll.stat.monthSlips': 'Slips of the Month',
                'hr.payroll.stat.pending': 'Pending',
                'hr.payroll.stat.paidEmployees': 'Paid Employees',
                'hr.payroll.filtersActions': 'Filters and actions',
                'hr.payroll.filter.allMonths': 'All months',
                'hr.payroll.generateAllBtn': 'Generate All',
                'hr.payroll.newSlipBtn': 'New Slips',
    'hr.payroll.modal.newTitle': 'New Payslip',
    'hr.payroll.modal.employee': 'Employee',
    'hr.payroll.modal.selectEmployee': 'Select an employee...',
    'hr.payroll.modal.period': 'Period',
    'hr.payroll.modal.baseSalary': 'Base Salary',
    'hr.payroll.modal.bonuses': 'Bonuses',
    'hr.payroll.modal.overtime': 'Overtime (h)',
    'hr.payroll.modal.bonusesAndBonus': 'Bonuses & Premiums',
    'hr.payroll.modal.addBtn': 'Add',
    'hr.payroll.modal.bonusTip': 'Add bonuses, premiums or additional allowances',
    'hr.payroll.modal.deductions': 'Deductions',
    'hr.payroll.modal.grossSalary': 'Gross Salary',
    'hr.payroll.modal.netSalary': 'Net Salary',
    'hr.payroll.modal.cancel': 'Cancel',
    'hr.payroll.modal.create': 'Create Payslip',
    'hr.payroll.modal.noEmployees': 'Please create employees first',
                'hr.payroll.modal.selectRequired': 'Please select an item from the list.',
                'hr.payroll.success.created': 'Payslip created successfully',
    'hr.employee.defaultPosition': 'Employee',
    'common.months.jan': 'January',
    'common.months.feb': 'February',
    'common.months.mar': 'March',
    'common.months.apr': 'April',
    'common.months.may': 'May',
    'common.months.jun': 'June',
    'common.months.jul': 'July',
    'common.months.aug': 'August',
    'common.months.sep': 'September',
    'common.months.oct': 'October',
    'common.months.nov': 'November',
    'common.months.dec': 'December',

                'hr.agent.title': 'HR Agent',
                'hr.agent.desc': 'AI Assistant for HR management (employees, leaves, payroll, recruitment, reviews)',
                'hr.agent.clearHistory': 'Clear chat history',
                'hr.agent.clearButton': 'Clear chat',
                'hr.agent.placeholder': 'Ask HR Agent a question...',
                'hr.agent.send': 'Send',

                'hr.help.guide': 'Guide',

                'hr.employees.title': 'Employee List',
                'hr.employees.addBtn': 'Add Employee',
                'hr.employees.searchPlaceholder': 'Search employee...',
                'hr.employees.table.name': 'Name',
                'hr.employees.table.position': 'Position',
                'hr.employees.table.department': 'Department',
                'hr.employees.table.status': 'Status',
                'hr.employees.table.actions': 'Actions',
                'hr.employees.status.active': 'Active',
                'hr.employees.status.inactive': 'Inactive',
                'hr.employees.status.onLeave': 'On Leave',
                'hr.employees.details': 'Employee Details',
                'hr.employees.deleteConfirm': 'Delete this employee?',

                'hr.leaves.title': 'Leave Management',
                'hr.leaves.newRequestBtn': 'New Request',
    'hr.leaves.modal.title': 'New Leave Request',
        'hr.leaves.modal.label.employee': 'Employee *',
        'hr.leaves.modal.placeholder.selectEmployee': 'Select an employee...',
        'hr.leaves.modal.label.type': 'Leave Type *',
        'hr.leaves.modal.placeholder.selectType': 'Select...',
        'hr.leaves.modal.label.startDate': 'Start Date *',
        'hr.leaves.modal.label.endDate': 'End Date *',
        'hr.leaves.modal.label.reason': 'Reason (optional)',
        'hr.leaves.modal.placeholder.reason': 'Reason for leave request...',
        'hr.leaves.modal.button.cancel': 'Cancel',
        'hr.leaves.modal.button.create': 'Create Request',

    'hr.leaves.modal.subtitle': 'Fill in the information below',
    'hr.leaves.calendar.title': 'Leave Planning',
    'hr.leaves.calendar.subtitle': 'Monthly view with overlap tracking',
    'hr.leaves.calendar.filterDept': 'Filter by Department',
    'hr.leaves.calendar.allDepts': 'All Departments',
                'hr.leaves.calendar.legend': 'Legend',
                'hr.leaves.calendar.today': 'Today',
    'hr.leaves.calendar.noOverlap': 'No critical overlap detected',
    'hr.leaves.calendar.allPresent': 'All present today',
    'hr.leaves.legend.pending': 'Pending',
    'hr.summary.noLeaves': 'No leave requests at the moment.',
    'hr.summary.noOffers': 'No job offers or applications in progress. Start by creating an offer!',
                'hr.leaves.table.employee': 'Employee',
                'hr.leaves.table.type': 'Type',
                'hr.leaves.table.dates': 'Dates',
                'hr.leaves.table.duration': 'Duration',
                'hr.leaves.table.status': 'Status',
                'hr.leaves.table.actions': 'Actions',
                'hr.leaves.status.pending': 'Pending',
                'hr.leaves.status.approved': 'Approved',
                'hr.leaves.status.rejected': 'Rejected',
                'hr.leaves.approve': 'Approve',
                'hr.leaves.reject': 'Reject',

                'hr.payroll.title': 'Payroll Management',
                'hr.payroll.generateBtn': 'Generate Slips',
                'hr.payroll.table.period': 'Period',
                'hr.payroll.table.employee': 'Employee',
                'hr.payroll.table.netSalary': 'Net Pay',
                'hr.payroll.table.status': 'Status',
                'hr.payroll.table.actions': 'Actions',
                'hr.payroll.status.pending': 'Draft',
                'hr.payroll.status.validated': 'Validated',
                'hr.payroll.status.paid': 'Paid',

                'hr.reviews.title': 'Performance Reviews',
                'hr.reviews.subtitle': 'Tracking performance & development',
                'hr.reviews.stat.total': 'Total Reviews',
                'hr.reviews.stat.scheduled': 'Scheduled',
                'hr.reviews.stat.completed': 'Completed',
                'hr.reviews.stat.averageScore': 'Average Score',
                'hr.reviews.btn.new': 'New Review',
                'hr.reviews.details.title': 'Performance Review',
                'hr.reviews.details.scoresTitle': 'Detailed Scores',
                'hr.reviews.details.overallRating': 'Overall Rating',
                'hr.reviews.details.close': 'Close',
                'hr.reviews.details.employee': 'Employee',
    'hr.reviews.modal.title': 'New Review',
    'hr.reviews.modal.subtitle': 'Enter the period, evaluator and criteria',
    'hr.reviews.modal.employee': 'Employee',
    'hr.reviews.modal.selectEmployee': 'Select...',
    'hr.reviews.modal.period': 'Period',
    'hr.reviews.modal.periodPlaceholder': 'Ex: Q4 2025, Annual 2025',
    'hr.reviews.modal.type': 'Review Type',
    'hr.reviews.modal.typeAnnual': 'Annual',
    'hr.reviews.modal.typeSemiannual': 'Semi-annual',
    'hr.reviews.modal.typeQuarterly': 'Quarterly',
    'hr.reviews.modal.typeProbation': 'Probation Period',
    'hr.reviews.modal.evaluator': 'Evaluator',
    'hr.reviews.modal.evaluatorPlaceholder': 'Ex: John Smith',
    'hr.reviews.modal.criteria': 'Evaluation Criteria',
    'hr.reviews.modal.technical': 'Technical Skills',
    'hr.reviews.modal.behavioral': 'Behavioral Skills',
    'hr.reviews.modal.performance': 'Performance & Productivity',
    'hr.reviews.modal.development': 'Development & Learning',
    'hr.reviews.modal.strengths': 'Strengths',
    'hr.reviews.modal.strengthsPlaceholder': 'Ex: Excellent communication, natural leadership...',
    'hr.reviews.modal.improvements': 'Areas for Improvement',
    'hr.reviews.modal.improvementsPlaceholder': 'Ex: Time management, specific technical skills...',
    'hr.reviews.modal.objectives': 'Objectives for Next Period',
    'hr.reviews.modal.objectivesPlaceholder': 'Ex: Attend management training, increase productivity by 15%...',
    'hr.reviews.modal.comments': 'General Comments',
    'hr.reviews.modal.commentsPlaceholder': 'Additional comments...',
    'hr.reviews.modal.cancel': 'Cancel',
    'hr.reviews.modal.create': 'Create Review',
    'hr.reviews.modal.noEmployees': 'No employees found. Add employees first.',
                'hr.reviews.stat.completedLabel': 'Completed reviews',
                'hr.reviews.stat.scoreLabel': 'Out of 5 stars',
                'hr.reviews.stat.excellent': 'Excellent',
                'hr.reviews.stat.excellentLabel': 'Score ‚â• 4.5',
                'hr.reviews.filter.allEmployees': 'All employees',
                'hr.reviews.filter.allPeriods': 'All periods',
                'hr.reviews.filter.search': 'üîç Search...',
                'hr.reviews.empty.title': 'No reviews',
                'hr.reviews.empty.desc': 'Create your first review to get started',

                'hr.turnover.rgpd.title': 'GDPR Compliance - Sensitive Data',
                'hr.turnover.rgpd.desc': 'This feature analyzes HR data to predict turnover risks. All data is processed in the browser (localStorage).',
                'hr.turnover.rgpd.badge.minimized': '‚úì Minimized Data',
                'hr.turnover.rgpd.badge.explainable': '‚úì Full Explainability',
                'hr.turnover.rgpd.badge.noSurveillance': '‚úì No Surveillance',
                'hr.turnover.rgpd.badge.consent': '‚úì Consent Required',
                'hr.turnover.details.mainTitle': 'Turnover Risk Analysis',
                'hr.turnover.details.mainSubtitle': 'GDPR Compliant Analysis - Explainable and Transparent Data',
                'hr.turnover.details.riskScore': 'Risk Score',
                'hr.turnover.details.window': 'Window: {0} last months',
                'hr.turnover.details.identifiedFactors': 'Identified Risk Factors',
                
                'hr.turnover.risk.high': 'High Risk',
                'hr.turnover.risk.medium': 'Medium Risk',
                'hr.turnover.risk.low': 'Low Risk',
                'hr.turnover.risk.highDesc': 'Score ‚â• 70% - Immediate Action',
                'hr.turnover.risk.mediumDesc': 'Score 40-69% - Monitoring',
                'hr.turnover.risk.lowDesc': 'Score < 40% - Stable',
                
                'hr.turnover.btn.analyze': 'Analyze Risks',
                'hr.turnover.btn.rgpdSettings': 'GDPR Settings',
                'hr.turnover.btn.close': 'Close',
                'hr.turnover.filter.allLevels': 'All Levels',
                'hr.turnover.searchPlaceholder': 'Search employee...',
                
                'hr.turnover.empty.title': 'No analysis available',
                'hr.turnover.empty.desc': 'Click "Analyze Risks" to generate predictions',
                'hr.turnover.empty.hint': 'Analysis requires employee, leave, and review data',

                'hr.turnover.empty.filteredTitle': 'No results',
                'hr.turnover.empty.filteredDesc': 'No employees match your filters. Adjust the search or risk level.',

                // Recruitment
                'hr.recruitment.rgpd.title': 'GDPR Compliance - CV Screening',
                'hr.recruitment.rgpd.desc': 'CV analysis with transparency and explainability. Humans remain the decision makers.',
                'hr.recruitment.rgpd.badge.minimized': '‚úì Minimized Data',
                'hr.recruitment.rgpd.badge.explainable': '‚úì Explainable Scoring',
                'hr.recruitment.rgpd.badge.human': '‚úì Human Decides',
                'hr.recruitment.rgpd.badge.audit': '‚úì Audit Trail',
                'hr.recruitment.rgpd.close': 'Close',

                'hr.recruitment.stats.activeJobs': 'Active Jobs',
                'hr.recruitment.stats.activeJobsSub': 'Open Positions',
                'hr.recruitment.stats.cvs': 'CVs Received',
                'hr.recruitment.stats.cvsSub': 'All Candidates',
                'hr.recruitment.stats.shortlist': 'Shortlist',
                'hr.recruitment.stats.shortlistSub': 'Qualified Candidates',
                'hr.recruitment.stats.avgScore': 'Avg Score',
                'hr.recruitment.stats.avgScoreSub': 'Avg Match / 100',

                'hr.recruitment.backup.title': 'Backup / Restore',
                'hr.recruitment.backup.desc': 'Download or restore all data (jobs, CVs, analysis)',
                'hr.recruitment.backup.save': 'Save',
                'hr.recruitment.backup.restore': 'Restore',

                'hr.recruitment.actions.newJob': 'New Job',
                'hr.recruitment.actions.uploadCV': 'Upload CV',
                'hr.recruitment.filter.allJobs': 'All Jobs',
                'hr.recruitment.actions.toggleShortlist': 'Show All',
                'hr.recruitment.actions.toggleShortlistOnly': 'Shortlist Only',
                'hr.recruitment.actions.scoringSettings': 'Scoring & Filters',

                'hr.recruitment.empty.title': 'No CVs Analyzed',
                'hr.recruitment.empty.desc': 'Create a job offer and upload CVs to start',
                'hr.recruitment.empty.createJob': 'Create Job',
                'hr.recruitment.empty.uploadCV': 'Upload CV',

                // Modals Recruitment
                'hr.recruitment.modal.addJob.title': 'üíº New Job Offer',
                'hr.recruitment.modal.addJob.subtitle': 'Create an active job to then analyze CVs.',
                'hr.recruitment.modal.addJob.label.title': 'Job Title *',
                'hr.recruitment.modal.addJob.placeholder.title': 'Ex: Senior Full Stack Developer',
                'hr.recruitment.modal.addJob.label.department': 'Department *',
                'hr.recruitment.modal.addJob.placeholder.department': 'Ex: IT',
                'hr.recruitment.modal.addJob.label.location': 'Location *',
                'hr.recruitment.modal.addJob.placeholder.location': 'Ex: Lisbon, Portugal',
                'hr.recruitment.modal.addJob.label.description': 'Job Description *',
                'hr.recruitment.modal.addJob.placeholder.description': 'Main missions, responsibilities...',
                'hr.recruitment.modal.addJob.label.skills': 'Required Skills * (comma separated)',
                'hr.recruitment.modal.addJob.placeholder.skills': 'Ex: React, Node.js, MongoDB, Docker, AWS',
                'hr.recruitment.modal.addJob.label.minExperience': 'Min Experience (years) *',
                'hr.recruitment.modal.addJob.label.language': 'Language *',
                'hr.recruitment.modal.addJob.placeholder.language': 'Ex: English',
                'hr.recruitment.modal.addJob.label.level': 'Level *',
                'hr.recruitment.modal.addJob.btn.publish': 'Publish Job',
                'hr.recruitment.modal.addJob.btn.cancel': 'Cancel',
                'hr.recruitment.modal.addJob.label.mustHave': 'Must-have criteria (optional)',
                'hr.recruitment.modal.addJob.placeholder.mustHave': 'Ex: Driving license, Available immediately, English fluency...',
                'hr.recruitment.modal.addJob.hint.mustHave': 'CVs without these criteria will be automatically filtered',

                'hr.recruitment.modal.uploadCV.title': 'üìÑ Analyze CV with AI',
                'hr.recruitment.modal.uploadCV.subtitle': 'Automatic parsing via Azure Vision + Azure OpenAI. No sensitive data is taken into account.',
                'hr.recruitment.modal.uploadCV.hint': '‚ú® Upload a CV (PDF/JPG/PNG) and AI automatically extracts data',
                'hr.recruitment.modal.uploadCV.btn.analyze': 'ü§ñ Analyze with AI',
                'hr.recruitment.modal.uploadCV.btn.cancel': '‚ùå Cancel',
                'hr.recruitment.toast.createJobFirst': 'Create a job offer first',
                'hr.recruitment.modal.uploadCV.label.targetJob': 'Target Job *',
                'hr.recruitment.modal.uploadCV.placeholder.select': 'Select...',
                'hr.recruitment.modal.uploadCV.label.file': 'CV File * (PDF, JPG, PNG)',
                'hr.recruitment.modal.uploadCV.hint.file': 'üí° For best results, use a CV with clear and readable text',
                
                'hr.recruitment.modal.scoring.title': '‚öôÔ∏è Scoring & Filters',
                'hr.recruitment.modal.scoring.subtitle': 'Reminder of scoring rules and job filtering (GDPR: explainable, human final decision).',
                'hr.recruitment.modal.scoring.section.weights': 'Scoring (weighting)',
                'hr.recruitment.modal.scoring.weight.skills': 'Skills',
                'hr.recruitment.modal.scoring.weight.experience': 'Experience',
                'hr.recruitment.modal.scoring.weight.languages': 'Languages',
                'hr.recruitment.modal.scoring.weight.education': 'Education',
                'hr.recruitment.modal.scoring.weight.mustHave': 'Must-have',
                'hr.recruitment.modal.scoring.mustHaveDesc': 'If must-have criteria are defined on the job, a CV that does not meet them is marked as non-compliant.',
                'hr.recruitment.modal.scoring.section.thresholds': 'Thresholds (recommendation)',
                'hr.recruitment.modal.scoring.threshold.recommended': 'Recommended',
                'hr.recruitment.modal.scoring.threshold.shortlist': 'Shortlist',
                'hr.recruitment.modal.scoring.section.filters': 'Filters',
                'hr.recruitment.modal.scoring.filtersDesc': 'Use the <strong>All Jobs</strong> filter to display only candidates linked to a job.',
                'hr.recruitment.modal.scoring.btn.close': 'Close',

                'hr.recruitment.toast.pdfGenerated': '‚úÖ PDF downloaded',

                'hr.recruitment.modal.details.scoreTitle': 'Compatibility Score',
                'hr.recruitment.modal.details.jobTitle': 'Application for',
                'hr.recruitment.modal.details.analysisTitle': 'üìä Detailed Analysis',
                'hr.recruitment.modal.details.profileTitle': 'üë§ Candidate Profile',
                'hr.recruitment.modal.details.strengthsTitle': '‚úÖ Strengths',
                'hr.recruitment.modal.details.risksTitle': '‚ö†Ô∏è Points of Attention',
                'hr.recruitment.modal.details.missingKeywordsTitle': '‚ùå Missing Skills',
                'hr.recruitment.modal.details.anomaliesTitle': 'üîç Anomalies Detected',
                'hr.recruitment.modal.details.gdpr': '‚ÑπÔ∏è GDPR Transparency: This score is calculated automatically based on: Skills (40%), Experience (30%), Languages (10%), Education (10%), Must-have (10%). No sensitive data (origin, religion, health) is analyzed. The final decision remains human.',
                'hr.recruitment.modal.details.btn.close': 'Close',
                'hr.recruitment.card.matchLabel': 'Match',
                'hr.recruitment.jobDeleted': 'Job deleted',
                'hr.recruitment.modal.details.btn.removeFromShortlist': '‚≠ê Remove from shortlist',
                'hr.recruitment.filter.allJobs': 'All Jobs',
                'hr.recruitment.modal.details.btn.addToShortlist': '‚úÖ Add to shortlist',
                'hr.recruitment.modal.details.detailSkills': 'Detailed Skills',
                'hr.recruitment.modal.details.lastJob': 'Last Experience',
                'hr.recruitment.modal.details.certifications': 'Certifications',

                'hr.recruitment.analysis.strength.skills': 'Excellent technical skills match',
                'hr.recruitment.analysis.risk.skills': 'Insufficient technical skills',
                'hr.recruitment.analysis.strength.experience': '{years} years of additional experience beyond minimum',
                'hr.recruitment.analysis.risk.experienceSlight': 'Slightly below required experience',
                'hr.recruitment.analysis.risk.experienceGap': '{years} years of experience missing',
                'hr.recruitment.analysis.strength.education': 'Excellent academic background',
                'hr.recruitment.analysis.risk.language': 'Language level to verify',
                'hr.recruitment.analysis.risk.mustHave': 'Must-have criteria not met',
                'hr.recruitment.analysis.anomaly.experienceHigh': '‚ö†Ô∏è Exceptionally high experience (overqualified?)',
                'hr.recruitment.analysis.anomaly.skillsLow': '‚ö†Ô∏è Few skills listed',
                'hr.recruitment.analysis.anomaly.lastJobMissing': '‚ö†Ô∏è Last experience missing',
                'hr.recruitment.analysis.recommendation.excellent': '‚úÖ RECOMMENDED - Excellent profile',
                'hr.recruitment.analysis.recommendation.shortlist': '‚úÖ SHORTLIST - Good candidate to interview',
                'hr.recruitment.analysis.recommendation.review': '‚ö†Ô∏è TO REVIEW - Interesting profile but needs validation',
                'hr.recruitment.analysis.recommendation.rejectedMustHave': '‚ùå REJECTED - Must-have criteria not met',
                'hr.recruitment.analysis.recommendation.rejected': '‚ùå NOT RECOMMENDED - Insufficient profile',

                // Recruitment Levels
                'hr.recruitment.level.a2': 'A2 - Elementary',
                'hr.recruitment.level.b1': 'B1 - Intermediate',
                'hr.recruitment.level.b2': 'B2 - Upper Intermediate',
                'hr.recruitment.level.c1': 'C1 - Advanced',
                'hr.recruitment.level.c2': 'C2 - Mastery',
                'hr.recruitment.placeholder.minExperience': 'Ex: 3',
                'hr.recruitment.candidate.noName': 'No name',
                'hr.recruitment.candidate.noEmail': 'Email not provided',
                'hr.recruitment.candidate.pending': 'Analysis pending',
                'hr.recruitment.label.weight': 'Weight',
                'hr.recruitment.toast.pdfFallback': '‚ö†Ô∏è PDF generated in local mode (fallback)',
                'hr.recruitment.toast.pdfJsonFallback': '‚ö†Ô∏è PDF unavailable, JSON backup downloaded',
                'hr.recruitment.toast.saveError': '‚ùå Unable to save recruitment data',
                'hr.recruitment.toast.restoreSuccess': '‚úÖ Restore: {jobs} jobs, {candidates} CVs',
                'hr.recruitment.toast.restoreError': '‚ùå Error: {error}',
                'hr.recruitment.toast.confirmRestore': 'üìä Restore data?\n\nCurrent: {currentJobs} jobs, {currentCandidates} CVs\nFile: {newJobs} jobs, {newCandidates} CVs\n\n‚ö†Ô∏è Current data will be replaced!',
                'hr.recruitment.toast.jobPublished': 'Job published successfully',
                'hr.recruitment.toast.fileTooLarge': 'File too large (max 10 MB)',
                'hr.recruitment.toast.selectCV': 'Select a CV file',
                'hr.recruitment.toast.extractingText': 'üîç Extracting text with Azure Vision...',
                'hr.recruitment.toast.analyzingAI': '‚ú® CV analyzed by Azure OpenAI...',
                'hr.recruitment.toast.jobNotFound': 'Job not found',
                'hr.recruitment.toast.analysisSuccess': '‚úÖ CV analyzed with AI - Score: {score}%',
                'hr.recruitment.toast.candidateNotFound': '‚ùå Candidate not found',
                'hr.recruitment.toast.shortlistAdded': '‚≠ê Added to shortlist',
                'hr.recruitment.toast.shortlistRemoved': '‚úÖ Removed from shortlist',

                'hr.payroll.validate': 'Validate',


                'hr.payroll.markPaid': 'Mark as Paid',
                'hr.payroll.view': 'View Slip',
                'chat.historyCleared': 'üóëÔ∏è Chat history cleared successfully',
                'mkt.clearChatConfirm': '‚ö†Ô∏è Are you sure you want to clear the entire chat history with Agent mark?\n\nThis action is irreversible.',
                'auth.noAccount': "Don't have an account?",
                'auth.createAccount': 'Create an account',
                'auth.signup.title': 'Create an account',
                'auth.signup.fullNameLabel': 'Full name',
                'auth.signup.passwordLabel': 'Password',
                'auth.signup.confirmPasswordLabel': 'Confirm password',
                'auth.signup.confirmPasswordPlaceholder': 'Re-enter your password',
                'auth.signup.submit': 'Create my account',
                'auth.signup.haveAccount': 'Already have an account?',
                'auth.signup.signin': 'Sign in',
                'auth.signin.title': 'Sign in',
                'auth.signin.passwordLabel': 'Password',
                'auth.signin.passwordPlaceholder': 'Your password',
                'auth.signin.rememberMe': 'Remember me',
                'auth.signin.forgotPassword': 'Forgot password?',
                'auth.signin.submit': 'Sign in',
                'auth.passwordMinChars': 'Minimum 6 characters',
                'auth.forgotPassword.title': 'Reset password',
                'auth.forgotPassword.subtitle': 'Enter your email and choose a new password',
                'auth.forgotPassword.emailLabel': 'Email',
                'auth.forgotPassword.newPasswordLabel': 'New password',
                'auth.forgotPassword.minChars': 'Minimum 6 characters',
                'auth.forgotPassword.submit': 'Change password',
                'auth.forgotPassword.backToSignin': '‚Üê Back to sign in',
                'auth.verification.title': 'Email verification',
                'auth.verification.sentTo': 'Verification code sent to:',
                'auth.verification.codeSim': 'Verification code (simulation):',
                'auth.verification.productionNote': 'In production, this code will be sent by email',
                'auth.verification.enterCode': 'Enter the verification code',
                'auth.verification.codeHint': '6-digit code',
                'auth.verification.submit': 'Verify and create account',
                'auth.verification.resend': 'Resend code',
                'auth.verification.cancel': 'Cancel',
                'sidebar.account': 'My Account',
                'sidebar.stats': 'Stats',
                'sidebar.settings': 'Settings',
                'sidebar.about': 'About',
                'sidebar.enterprise': 'Enterprise',
                'sidebar.enterpriseBadge': 'Active',
                'sessions.group.today': 'Today',
                'sessions.group.yesterday': 'Yesterday',
                'sessions.group.older': 'Older',
                'stats.messagesExchanged': 'Messages exchanged',
                'stats.conversations': 'Conversations',
                'stats.avgHI': 'HI (global)',
                'stats.avgCHR': 'CHR (global)',
                'stats.hiCoverage': 'HI coverage',
                'stats.chrCoverage': 'CHR coverage',
                'stats.recentHI': 'HI (recent, last 20)',
                'stats.recentCHR': 'CHR (recent, last 20)',
                'stats.riskMessages': 'Risky messages',
                'stats.highRiskMessages': 'High-risk messages',
                'stats.topModels': 'Top models',
                'tooltip.hi': '<strong>Hallucination Index (HI)</strong><br>Measures the risk that a response contains fabricated or unverified information.<br><br>‚Ä¢ &lt;15%: Very reliable<br>‚Ä¢ 15-30%: Reliable<br>‚Ä¢ 30-60%: Cautious<br>‚Ä¢ &gt;60%: Uncertain',
                'tooltip.chr': '<strong>Composite Hallucination Risk (CHR)</strong><br>Overall indicator combining AI confidence, uncertainty, and detected contradictions.<br><br>The lower the CHR, the safer and more coherent the response.',
                'userMenu.close': 'Close',
                'userMenu.avatarTitle': 'Click to change photo',
                'userMenu.profilePhoto': 'Profile photo',
                'userMenu.changePassword': 'Change password',
                'userMenu.privacy': 'Privacy',
                'userMenu.logout': 'Sign out',
                'modal.statsTitle': 'Stats',
                'modal.aboutTitle': 'About Axilum AI',
                'auth.logoutConfirm': 'Are you sure you want to sign out?',
                'auth.goodbye': 'üëã See you soon!',
                'auth.selectImage': '‚ùå Please select an image',
                'auth.imageTooLarge': '‚ùå The image must not exceed 2MB',
                'auth.profilePhotoUpdated': '‚úÖ Profile photo updated!',
                'auth.resetPasswordPrompt': 'Enter your new password (min. 6 characters):',
                'auth.resetPasswordSuccess': '‚úÖ Password changed successfully!',
                'auth.resetPasswordTooShort': '‚ùå Password must be at least 6 characters long',
                'auth.alt.profilePhoto': 'Profile photo',
                'auth.alt.photo': 'Photo',
                'ui.inputPlaceholder': 'Type your message...',
                'tts.listen': 'Listen to this message',
                'tts.stop': 'Stop playback',
                'toast.transcriptionDone': '‚úÖ Transcription complete',
                'toast.voiceError': '‚ùå Voice recognition error',
        'companySettings.title': 'Company Settings',
        'companySettings.subtitle': 'Company Information',
        'companySettings.menu': 'MENU',
        'companySettings.nav.general': 'General',
        'companySettings.nav.contact': 'Contact',
        'companySettings.nav.currency': 'Currency',
        'companySettings.nav.legal': 'Legal',
        'companySettings.sectionTitle.general': 'General',
        'companySettings.sectionTitle.contact': 'Contact',
        'companySettings.sectionTitle.currency': 'Currency',
        'companySettings.sectionTitle.legal': 'Legal',
        'companySettings.label.companyName': 'Company Name *',
        'companySettings.label.activity': 'Activity Field *',
        'companySettings.label.address': 'Full Address *',
        'companySettings.label.phone': 'Phone *',
        'companySettings.label.email': 'Email *',
        'companySettings.label.currency': 'Currency *',
        'companySettings.label.registration': 'Registration Number (optional)',
        'companySettings.placeholder.companyName': 'Ex: Axilum',
        'companySettings.placeholder.activity': 'Ex: Technology, Commerce, Services...',
        'companySettings.placeholder.address': 'Street, city, zip code, country...',
        'companySettings.placeholder.phone': '+1 234 567 890',
        'companySettings.placeholder.email': 'contact@company.com',
        'companySettings.placeholder.registration': 'Registration Number',
        'companySettings.button.cancel': 'Cancel',
        'companySettings.button.save': 'Save',
        'companySettings.currency.eur': 'Euro (‚Ç¨)',
        'companySettings.currency.usd': 'US Dollar ($)',
        'companySettings.currency.mad': 'Moroccan Dirham (MAD)',
        'companySettings.currency.tnd': 'Tunisian Dinar (TND)',

                'toast.noTextToRead': 'No text to read',
                'voice.listening': "I'm listening...",
                'voice.thinking': "Thinking...",
                'voice.speaking': "Speaking...",
                'voice.paused': 'Paused ‚Äî click to resume',

                'hd.source.otherAi': 'Other AI',
                'hd.mode.placeholder': 'Paste the text to verify (another AI response), then click Send‚Ä¶',
                'hd.mode.toast': 'üîç Paste the text to verify, then Send',
                'hd.error.tooLong': 'Text is too long. Please shorten it (‚âà 50k chars max).',
                'hd.error.unavailable': 'Analysis failed',
                'hd.error.analysisPrefix': '‚ùå Analysis error:',
                'hd.report.title': 'üîé Hallucination Detector Report',
                'hd.report.source': 'Source',
                'hd.report.reliability': 'Reliability score',
                'hd.report.contradictionRisk': 'Contradiction risk',
                'hd.report.evidenceCoverage': 'Evidence coverage',
                'hd.report.uncertainty': 'Uncertainty (CI90)',
                'hd.report.claimsDetector': 'Claims (detector)',
                'hd.report.facts': 'Facts',
                'hd.report.unverified': 'unverified',
                'hd.report.internalContradictions': 'Internal contradictions detected',
                'hd.report.securityWarnings': '‚ö†Ô∏è Security warnings',
                'hd.section.unconfirmed': '‚ö†Ô∏è Unconfirmed points (snippets):',
                'hd.section.probablyFalse': '‚ùå Likely false / unsupported points (snippets):',
                'hd.section.notSupportedClaims': '‚ùå Unsupported claims (snippets):',
                'hd.section.contradictoryClaims': '‚ö° Contradictory claims (snippets):',
                'hd.section.verifiedFacts': '‚úÖ Facts with sources (snippets):',
                'hd.section.recommendedSources': 'üìö Recommended sources (to verify):',
                'hd.report.recommendation': 'Recommendation',
                'metrics.title': 'Response metrics',
                'metrics.section.performance': 'Performance',
                'metrics.section.quality': 'Quality',
                'metrics.label.cache': 'Cache',
                'metrics.label.time': 'Time',
                'metrics.label.tokens': 'Tokens',
                'metrics.label.prompt': 'Prompt',
                'metrics.label.provider': 'Provider',
                'metrics.label.model': 'Model',
                'metrics.label.arch': 'Arch',

                'settings.appearance': 'Appearance',
                'settings.themeToggleTitle': 'Dark / Light theme',
                'settings.themeToggleDesc': 'Toggle between light and dark mode',
                'settings.aiTitle': 'AI',
                'settings.aiModelLabel': 'AI model',
                'settings.aiValidateModel': 'Confirm selection',
                'settings.aiModelSelected': 'Selected',
                'settings.modeTitle': 'Mode',
                'settings.modeAria': 'Mode selector',
                'settings.modeHelp': 'Choose your operating mode. Some features may be limited depending on the selected mode.',
                'settings.dataTitle': 'Data management',
                'settings.dataPrivacyTitle': 'Privacy',
                'settings.dataPrivacyDesc': 'Local vs Cloud, security and retention',
                'settings.dataExportTitle': 'Export all',
                'settings.dataExportDesc': 'Download all your conversations',
                'settings.dataClearTitle': 'Clear data',
                'settings.dataClearDesc': 'Delete all conversations',
                'settings.dataClearConfirm': '‚ö†Ô∏è Do you really want to clear all your data?\n\nThis action is irreversible and will delete:\n- All conversations\n- All messages\n- All statistics\n\nExport your data first if needed.',
                'settings.dataClearedToast': 'All data has been cleared',
                'settings.storageTitle': 'Storage mode',
                'settings.storagePrefix': 'Current choice:',
                'settings.storage.ask': 'Ask on each upload',
                'settings.storage.local': 'Local (this device)',
                'settings.storage.cloud': 'Secure cloud',
                'settings.storage.btn.ask': 'Ask',
                'settings.storage.btn.local': 'Local',
                'settings.storage.btn.cloud': 'Cloud',
                'settings.storageModal.header': 'Storage',
                'settings.storageModal.modeTitle': 'Storage mode',
                'settings.storageModal.help': '<strong>Local</strong>: files stay on your device. <strong>Cloud</strong>: server sync (sign-in required).',
                'settings.storageModal.quotaTitle': 'Cloud storage quota',
                'settings.storageModal.quotaSubtitle': 'Indicator (to enable/buy storage)',
                'settings.storageModal.quotaAddButton': 'Add storage',
                'settings.storageModal.quotaTotal': 'Total quota',
                'settings.storageModal.quotaUsed': 'Used (Finance)',
                'settings.storageModal.quotaRemaining': 'Remaining',
                'settings.storageAddModal.title': 'Add storage',
                'settings.storageAddModal.desc': 'Select a pack. (UI ready ‚Äî payment/auto-activation to be wired later.)',
                'settings.storageAddModal.pack5': '+5 GB',
                'settings.storageAddModal.pack10': '+10 GB',
                'settings.storageAddModal.pack50': '+50 GB',
                'toast.storagePrefix': 'üóÑÔ∏è Storage:',
                'settings.pricingTitle': 'Pricing &amp; usage',
                'settings.pricing.p1': '<strong>Axilum AI runs on prepaid credit:</strong> you top up a balance (in $) and can use all modules as long as your credit is not depleted. Usage is computed server-side from real consumption (tokens, AI calls) and deducted automatically.',
                'settings.pricing.p2': '<strong>Where to see your balance?</strong> The counter at the top shows your remaining credit. <strong>To see details</strong> (period, AI cost, etc.), click directly on that counter.',
                'settings.pricing.p3': '<strong>Currency:</strong> billing is in $ (USD).',
                'settings.pricing.p4': '<strong>Storage pricing:</strong> Included quota: 100 MB free. Beyond: $0.10 / GB / month. Packs: +5, +10, +50 GB.',
                'settings.pricing.costTitle': 'Cost',
                'settings.pricing.costBody': '<strong>Prompt</strong> tokens are input tokens (your messages and instructions). <strong>Completion</strong> tokens are output tokens (the model‚Äôs generated answer).',
                'settings.pricing.byModelTitle': 'Price per model:',
                'settings.pricing.byModel.loading': 'Loading‚Ä¶',
                'settings.pricing.byModel.table.model': 'Model',
                'settings.pricing.byModel.table.cost': 'Cost',
                'settings.pricing.byModel.na': 'N/A',
                'settings.pricing.byModel.prompt': 'prompt',
                'settings.pricing.byModel.completion': 'completion',
                'settings.infoTitle': 'Information',
                'settings.infoContent': '<strong>Version:</strong> 1.0.0<br><strong>Last update:</strong> December 2025<br><strong>Build:</strong> Production',

                'usage.title': 'Usage',
                'usage.balanceLabel': 'Remaining credit',
                'usage.monthCostLabel': 'Cost (month)',
                'usage.monthTokensLabel': 'Calls &amp; tokens',
                'usage.latestTitle': 'Latest calls',
                'usage.loading': 'Loading‚Ä¶',
                'usage.errorLoading': 'Unable to load usage.',
                'usage.noUsage': 'No usage recorded for this period.',
                'usage.periodPrefix': 'Period:',
                'usage.calls': 'calls',
                'usage.tokens': 'tokens',
                'usage.table.date': 'Date',
                'usage.table.model': 'Model',
                'usage.table.tokens': 'Tokens',
                'usage.table.cost': 'Cost',

                'ai.toast.modelUpdated': 'Model selected',
                'ai.toast.modelValidated': 'Active model: {model}',
                'ai.help.activePrefix': 'Active model:',
                'ai.help.fullId': 'Full name:',
                'ai.help.provider': 'Provider:',
                'ai.help.kind': 'Type:',
                'ai.help.category': 'Functions:',
                'ai.help.preferences': 'Preferences:',
                'ai.help.pricePrefix': 'Pricing:',
                'ai.help.inSuffix': 'input',
                'ai.help.outSuffix': 'output',
                'ai.help.moreInfo': 'For more information:',
                'ai.help.hint': 'Tip: hover a model in the list to see its full identifier.'
            }
        };

        function normalizeAppLanguage(lang) {
            const raw = String(lang || '').toLowerCase();
            if (raw.startsWith('en')) return 'en';
            return 'fr';
        }

        function getAppLanguage() {
            try {
                const stored = localStorage.getItem('appLanguage');
                if (stored) return normalizeAppLanguage(stored);
            } catch (_) {}
            return normalizeAppLanguage((navigator && navigator.language) ? navigator.language : 'fr');
        }

        function setAppLanguage(lang) {
            const normalized = normalizeAppLanguage(lang);
            try { localStorage.setItem('appLanguage', normalized); } catch (_) {}
            return normalized;
        }

        function t(key) {
            const lang = getAppLanguage();
            const dict = I18N_STRINGS[lang] || I18N_STRINGS.fr;
            return dict[key] || (I18N_STRINGS.fr && I18N_STRINGS.fr[key]) || key;
        }

        // About modal content (FR HTML is the source-of-truth in DOM; EN is injected on demand)
        let ABOUT_BODY_FR_HTML = null;
        const ABOUT_BODY_EN_HTML = `
            <!-- Introduction -->
            <div class="about-intro">
                <p>
                    <strong>Axilum AI</strong> is a unified professional assistant platform that combines a <strong>central chat</strong> and <strong>business modules</strong>.
                    The experience is organized around <strong>specialized agents</strong> and <strong>intelligent routing</strong>: you ask questions in chat, then (when needed) switch to a dedicated module (Finance, HR, R&amp;D, Marketing, Excel, Vision, Text Pro, Tasks‚Ä¶) to access the right UI and actions.
                </p>
                <p>
                    The goal: speed up your workflows (analysis, writing, organization, reporting, documents) while keeping navigation simple and preserving context continuity between the chat and the modules.
                </p>
            </div>

            <!-- Office‚Ñ¢ Modules -->
            <div class="about-section">
                <h3>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <rect x="3" y="3" width="7" height="7" rx="1" stroke-width="2" />
                        <rect x="14" y="3" width="7" height="7" rx="1" stroke-width="2" />
                        <rect x="3" y="14" width="7" height="7" rx="1" stroke-width="2" />
                        <rect x="14" y="14" width="7" height="7" rx="1" stroke-width="2" />
                    </svg>
                    Office‚Ñ¢ Modules (business)
                </h3>
                <div class="about-features">
                    <div class="feature-card">
                        <h4>Finance &amp; Accounting ‚Äî Agent Alex</h4>
                        <p>Finance chat + dedicated interface to ask questions, upload invoices, and generate/view reports and lists (depending on Finance module configuration).</p>
                    </div>
                    <div class="feature-card">
                        <h4>HR Management Hub ‚Äî Agent RH</h4>
                        <p>HR management with dedicated screens (employees, leave, payroll, recruiting) and automations (depending on HR configuration).</p>
                    </div>
                    <div class="feature-card">
                        <h4>Research &amp; Development ‚Äî Agent Dev</h4>
                        <p>R&amp;D space to support innovation, structure ideas, write/iterate, and organize work items.</p>
                    </div>
                    <div class="feature-card">
                        <h4>Marketing &amp; Business ‚Äî Agent Mark</h4>
                        <p>Marketing module for analysis, strategy, positioning, and content production (depending on your use).</p>
                    </div>
                </div>
            </div>

            <!-- Tools -->
            <div class="about-section">
                <h3>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 7v10a2 2 0 002 2h8a2 2 0 002-2V7" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7V5a1 1 0 011-1h4a1 1 0 011 1v2" />
                    </svg>
                    Tools (productivity)
                </h3>
                <div class="about-features">
                    <div class="feature-card">
                        <h4>Excel AI Expert ‚Äî in development</h4>
                        <p>Dedicated page for Excel questions (formulas, tables, analysis, charts) and assistance with your files/sheets depending on your usage.</p>
                    </div>
                    <div class="feature-card">
                        <h4>AI Task ‚Äî Agent ToDo</h4>
                        <p>Task/organization management (to-do, planning). Data can be stored locally and/or synchronized depending on the enabled mode.</p>
                    </div>
                    <div class="feature-card">
                        <h4>Text Pro ‚Äî in development</h4>
                        <p>Text processing (writing, correction, translation) with upload (TXT/PDF/DOC/DOCX) and export (PDF/TXT + simplified DOCX).</p>
                    </div>
                    <div class="feature-card">
                        <h4>AI Vision PRO ‚Äî in development</h4>
                        <p>Dedicated Vision interface (Azure Vision) for image analysis (status/access depends on plan). The ‚ÄúBack‚Äù button returns to the main chat.</p>
                    </div>
                    <div class="feature-card">
                        <h4>Hallucination Detector</h4>
                        <p>Verification mode: paste an external answer and Axilum AI helps you spot uncertain areas (via HI/CHR and guidance).</p>
                    </div>
                </div>
            </div>

            <!-- Embeddings & RAG -->
            <div class="about-section">
                <h3>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" />
                    </svg>
                    Document search (Embeddings &amp; RAG)
                </h3>
                <p style="margin: 8px 0 12px; color: var(--text-secondary); font-size: 13px; line-height: 1.55;">
                    Axilum AI can enrich its answers with your documents (Docs mode). The system indexes content, retrieves the most relevant passages, then injects them into the model context to produce more grounded and factual responses.
                </p>
                <div class="about-features">
                    <div class="feature-card">
                        <h4>Embeddings (semantic search)</h4>
                        <p>
                            <strong>Embeddings</strong> transform text (sentence, paragraph, document) into a <strong>vector</strong>. This enables <strong>similarity search</strong> based on meaning (not just keywords) to quickly find the passages closest to your question.
                        </p>
                    </div>
                    <div class="feature-card">
                        <h4>RAG (Retrieval‚ÄëAugmented Generation)</h4>
                        <p>
                            <strong>RAG</strong> combines <strong>retrieval</strong> + <strong>generation</strong>: Axilum AI first retrieves relevant snippets (via semantic search), then generates an answer grounded on those sources. Result: fewer hallucinations and better alignment with your documents.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Reliability Metrics -->
            <div class="about-section">
                <h3>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Reliability Metrics
                </h3>
                <div class="about-features">
                    <div class="feature-card">
                        <h4>HI - Hallucination Index</h4>
                        <p>Measures uncertainty in the response. The lower, the better!</p>
                    </div>
                    <div class="feature-card">
                        <h4>CHR - Coherence Rate</h4>
                        <p>Evaluates the internal consistency and logic of the generated response.</p>
                    </div>
                </div>
            </div>

            <!-- Session indicators -->
            <div class="about-section">
                <h3>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Session Indicators
                </h3>
                <p>Each session shows an animated colored dot indicating its quality in real time:</p>
                <div class="dot-legend">
                    <div class="dot-item">
                        <span class="dot-example green"></span>
                        <div class="dot-item-content">
                            <strong>Green - Reliable</strong>
                            <span>Average HI &lt; 40%</span>
                        </div>
                    </div>
                    <div class="dot-item">
                        <span class="dot-example orange"></span>
                        <div class="dot-item-content">
                            <strong>Orange - Caution</strong>
                            <span>Average HI 40-59%</span>
                        </div>
                    </div>
                    <div class="dot-item">
                        <span class="dot-example red"></span>
                        <div class="dot-item-content">
                            <strong>Red - Risk</strong>
                            <span>Average HI ‚â• 60%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tech -->
            <div class="about-section">
                <h3>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                    </svg>
                    Tech Stack
                </h3>
                <p style="margin: 8px 0 12px; color: var(--text-secondary); font-size: 13px; line-height: 1.55;">
                    Includes an AI layer with <strong>embeddings</strong> (semantic search) and <strong>RAG</strong> (source-augmented answers), on top of business modules, agent routing, and Azure services.
                    <br><strong>Embeddings</strong>: transform text into <strong>vectors</strong> to retrieve relevant passages by <strong>semantic similarity</strong>.
                    <br><strong>RAG</strong>: <strong>retrieval + generation</strong> ‚Äî retrieve snippets first, then generate an answer grounded in your documents for more <strong>factual</strong> outputs.
                </p>
                <div class="tech-badges">
                    <span class="tech-badge">Azure OpenAI</span>
                    <span class="tech-badge">Azure Functions</span>
                    <span class="tech-badge">Azure Static Web Apps</span>
                    <span class="tech-badge">Azure Storage (Table/Blob)</span>
                    <span class="tech-badge">Azure AI Vision (OCR)</span>
                    <span class="tech-badge">IndexedDB</span>
                    <span class="tech-badge">LocalStorage</span>
                    <span class="tech-badge">Node.js</span>
                    <span class="tech-badge">Express.js</span>
                    <span class="tech-badge">Docker</span>
                    <span class="tech-badge">SendGrid</span>
                    <span class="tech-badge">Brave Search API</span>
                    <span class="tech-badge">SheetJS (xlsx)</span>
                    <span class="tech-badge">Web Speech API (voice)</span>
                    <span class="tech-badge">PDF/Exports</span>
                    <span class="tech-badge">PDFKit</span>
                    <span class="tech-badge">Axios</span>
                    <span class="tech-badge">Cheerio</span>
                    <span class="tech-badge">Embeddings (vector search)</span>
                    <span class="tech-badge">RAG (Docs)</span>
                    <span class="tech-badge">Orchestrator (Team Auto)</span>
                    <span class="tech-badge">Agent routing</span>
                    <span class="tech-badge">Multi-provider AI (Groq/OpenAI/Qwen‚Ä¶)</span>
                    <span class="tech-badge">HI/CHR metrics</span>
                    <span class="tech-badge">A/B testing (V2 rollout)</span>
                </div>
            </div>

            <!-- Data -->
            <div class="about-section">
                <h3>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
                    </svg>
                    Data, storage &amp; export
                </h3>
                <p>
                    Axilum AI manages data (conversations, tasks, events, settings) with <strong>local storage</strong> (IndexedDB/LocalStorage) and optional <strong>cloud sync</strong> depending on the selected mode. You can export your conversations and consult the Privacy page for details.
                </p>
            </div>

            <!-- Company -->
            <div class="company-info">
                <h4>
                    <svg style="width: 22px; height: 22px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    Developed by AI Solutions Hub¬Æ
                </h4>
                <p><strong>AI Solutions Hub¬Æ</strong> - An innovative company specialized in building trusted and ethical artificial intelligence solutions.</p>
                <p style="margin-top: 15px;">
                    <svg style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    <strong>Support:</strong> <a href="mailto:support@solutionshub.uk">support@solutionshub.uk</a>
                </p>
                <p style="margin-top: 10px; font-size: 13px; opacity: 0.9;">
                    ¬© 2025 AI Solutions Hub¬Æ. All rights reserved.
                </p>
            </div>
        `;

        function applyAboutLanguage() {
            const body = document.getElementById('aboutModalBody');
            if (!body) return;
            if (ABOUT_BODY_FR_HTML === null) ABOUT_BODY_FR_HTML = body.innerHTML;
            const lang = getAppLanguage();
            body.innerHTML = (lang === 'en') ? ABOUT_BODY_EN_HTML : ABOUT_BODY_FR_HTML;
        }

        function getLocale() {
            const lang = getAppLanguage();
            return lang === 'en' ? 'en-US' : 'fr-FR';
        }

        function getSpeechLocale() {
            return getLocale();
        }

        function applyLanguageToUI() {
            try {
                const lang = getAppLanguage();
                document.documentElement.lang = lang;
            } catch (_) {}

            try {
                const aiTaskMenuBtn = document.getElementById('aiTaskMenuBtn');
                if (aiTaskMenuBtn) aiTaskMenuBtn.title = t('todo.sidebarTooltip');
            } catch (_) {}

            try {
                const newChatBtn = document.getElementById('newChatBtn');
                if (newChatBtn) newChatBtn.textContent = t('ui.newConversation');

                const sessionsLabel = document.getElementById('sessionsLabel');
                if (sessionsLabel) sessionsLabel.textContent = t('ui.sessions');

                const settingsTitle = document.getElementById('settingsModalTitle');
                if (settingsTitle) settingsTitle.textContent = t('ui.settings');

                const languageSectionTitle = document.getElementById('languageSectionTitle');
                if (languageSectionTitle) languageSectionTitle.textContent = t('ui.languageSection');

                const languageLabel = document.getElementById('languageLabel');
                if (languageLabel) languageLabel.textContent = t('ui.languageLabel');

                const languageHelp = document.getElementById('languageHelp');
                if (languageHelp) languageHelp.textContent = t('ui.languageHelp');

                const appearanceSectionTitle = document.getElementById('appearanceSectionTitle');
                if (appearanceSectionTitle) appearanceSectionTitle.textContent = t('settings.appearance');

                const themeToggleTitle = document.getElementById('themeToggleTitle');
                if (themeToggleTitle) themeToggleTitle.textContent = t('settings.themeToggleTitle');

                const themeToggleDesc = document.getElementById('themeToggleDesc');
                if (themeToggleDesc) themeToggleDesc.textContent = t('settings.themeToggleDesc');

                const aiSectionTitle = document.getElementById('aiSectionTitle');
                if (aiSectionTitle) aiSectionTitle.textContent = t('settings.aiTitle');

                const aiModelLabel = document.getElementById('aiModelLabel');
                if (aiModelLabel) aiModelLabel.textContent = t('settings.aiModelLabel');

                const modeSectionTitle = document.getElementById('modeSectionTitle');
                if (modeSectionTitle) modeSectionTitle.textContent = t('settings.modeTitle');

                const settingsPlanToggle = document.getElementById('settingsPlanToggle');
                if (settingsPlanToggle) settingsPlanToggle.setAttribute('aria-label', t('settings.modeAria'));

                const modeHelp = document.getElementById('modeHelp');
                if (modeHelp) modeHelp.textContent = t('settings.modeHelp');

                const dataSectionTitle = document.getElementById('dataSectionTitle');
                if (dataSectionTitle) dataSectionTitle.textContent = t('settings.dataTitle');

                const dataPrivacyTitle = document.getElementById('dataPrivacyTitle');
                if (dataPrivacyTitle) dataPrivacyTitle.textContent = t('settings.dataPrivacyTitle');

                const dataPrivacyDesc = document.getElementById('dataPrivacyDesc');
                if (dataPrivacyDesc) dataPrivacyDesc.textContent = t('settings.dataPrivacyDesc');

                const dataExportTitle = document.getElementById('dataExportTitle');
                if (dataExportTitle) dataExportTitle.textContent = t('settings.dataExportTitle');

                const dataExportDesc = document.getElementById('dataExportDesc');
                if (dataExportDesc) dataExportDesc.textContent = t('settings.dataExportDesc');

                const dataClearTitle = document.getElementById('dataClearTitle');
                if (dataClearTitle) dataClearTitle.textContent = t('settings.dataClearTitle');

                const dataClearDesc = document.getElementById('dataClearDesc');
                if (dataClearDesc) dataClearDesc.textContent = t('settings.dataClearDesc');

                const storageModeTitle = document.getElementById('storageModeTitle');
                if (storageModeTitle) storageModeTitle.textContent = t('settings.storageTitle');

                const storageModePrefix = document.getElementById('storageModePrefix');
                if (storageModePrefix) storageModePrefix.textContent = t('settings.storagePrefix');

                const storageModeModalHeaderLabel = document.getElementById('storageModeModalHeaderLabel');
                if (storageModeModalHeaderLabel) storageModeModalHeaderLabel.textContent = t('settings.storageModal.header');

                const storageModeModalModeTitle = document.getElementById('storageModeModalModeTitle');
                if (storageModeModalModeTitle) storageModeModalModeTitle.textContent = t('settings.storageModal.modeTitle');

                const storageModeBtnAsk = document.getElementById('storageModeBtnAsk');
                if (storageModeBtnAsk) storageModeBtnAsk.textContent = t('settings.storage.btn.ask');

                const storageModeBtnLocal = document.getElementById('storageModeBtnLocal');
                if (storageModeBtnLocal) storageModeBtnLocal.textContent = t('settings.storage.btn.local');

                const storageModeBtnCloud = document.getElementById('storageModeBtnCloud');
                if (storageModeBtnCloud) storageModeBtnCloud.textContent = t('settings.storage.btn.cloud');

                const storageModeModalHelp = document.getElementById('storageModeModalHelp');
                if (storageModeModalHelp) storageModeModalHelp.innerHTML = t('settings.storageModal.help');

                const storageQuotaTitle = document.getElementById('storageQuotaTitle');
                if (storageQuotaTitle) storageQuotaTitle.textContent = t('settings.storageModal.quotaTitle');

                const storageQuotaSubtitle = document.getElementById('storageQuotaSubtitle');
                if (storageQuotaSubtitle) storageQuotaSubtitle.textContent = t('settings.storageModal.quotaSubtitle');

                const storageQuotaAddBtn = document.getElementById('storageQuotaAddBtn');
                if (storageQuotaAddBtn) storageQuotaAddBtn.textContent = t('settings.storageModal.quotaAddButton');

                const storageQuotaTotalLabel = document.getElementById('storageQuotaTotalLabel');
                if (storageQuotaTotalLabel) storageQuotaTotalLabel.textContent = t('settings.storageModal.quotaTotal');

                const storageQuotaUsedLabel = document.getElementById('storageQuotaUsedLabel');
                if (storageQuotaUsedLabel) storageQuotaUsedLabel.textContent = t('settings.storageModal.quotaUsed');

                const storageQuotaRemainingLabel = document.getElementById('storageQuotaRemainingLabel');
                if (storageQuotaRemainingLabel) storageQuotaRemainingLabel.textContent = t('settings.storageModal.quotaRemaining');

                const storageAddModalTitle = document.getElementById('storageAddModalTitle');
                if (storageAddModalTitle) storageAddModalTitle.textContent = t('settings.storageAddModal.title');

                const storageAddModalDesc = document.getElementById('storageAddModalDesc');
                if (storageAddModalDesc) storageAddModalDesc.textContent = t('settings.storageAddModal.desc');

                const storageAddPack5 = document.getElementById('storageAddPack5');
                if (storageAddPack5) storageAddPack5.textContent = t('settings.storageAddModal.pack5');

                const storageAddPack10 = document.getElementById('storageAddPack10');
                if (storageAddPack10) storageAddPack10.textContent = t('settings.storageAddModal.pack10');

                const storageAddPack50 = document.getElementById('storageAddPack50');
                if (storageAddPack50) storageAddPack50.textContent = t('settings.storageAddModal.pack50');

                try {
                    if (typeof updateStorageModeButtonsUI === 'function') updateStorageModeButtonsUI();
                } catch (_) {}

                const pricingSectionTitle = document.getElementById('pricingSectionTitle');
                if (pricingSectionTitle) pricingSectionTitle.innerHTML = t('settings.pricingTitle');

                const pricingP1 = document.getElementById('pricingP1');
                if (pricingP1) pricingP1.innerHTML = t('settings.pricing.p1');

                const pricingP2 = document.getElementById('pricingP2');
                if (pricingP2) pricingP2.innerHTML = t('settings.pricing.p2');

                const pricingP3 = document.getElementById('pricingP3');
                if (pricingP3) pricingP3.innerHTML = t('settings.pricing.p3');

                const pricingP4 = document.getElementById('pricingP4');
                if (pricingP4) pricingP4.innerHTML = t('settings.pricing.p4');

                const pricingCostTitle = document.getElementById('pricingCostTitle');
                if (pricingCostTitle) pricingCostTitle.textContent = t('settings.pricing.costTitle');

                const pricingCostBody = document.getElementById('pricingCostBody');
                if (pricingCostBody) pricingCostBody.innerHTML = t('settings.pricing.costBody');

                const pricingByModelTitle = document.getElementById('pricingByModelTitle');
                if (pricingByModelTitle) pricingByModelTitle.textContent = t('settings.pricing.byModelTitle');
                try {
                    const list = Array.isArray(pricingByModelCache) ? pricingByModelCache : (Array.isArray(aiModelsCache) ? aiModelsCache : null);
                    if (list && list.length) renderPricingByModelTable(list);
                } catch (_) {}

                const infoSectionTitle = document.getElementById('infoSectionTitle');
                if (infoSectionTitle) infoSectionTitle.textContent = t('settings.infoTitle');

                const infoContent = document.getElementById('infoContent');
                if (infoContent) infoContent.innerHTML = t('settings.infoContent');

                const usageDashboardTitle = document.getElementById('usageDashboardTitle');
                if (usageDashboardTitle) usageDashboardTitle.textContent = t('usage.title');

                const usageDashboardBalanceLabel = document.getElementById('usageDashboardBalanceLabel');
                if (usageDashboardBalanceLabel) usageDashboardBalanceLabel.textContent = t('usage.balanceLabel');

                const usageDashboardMonthCostLabel = document.getElementById('usageDashboardMonthCostLabel');
                if (usageDashboardMonthCostLabel) usageDashboardMonthCostLabel.textContent = t('usage.monthCostLabel');

                const usageDashboardMonthTokensLabel = document.getElementById('usageDashboardMonthTokensLabel');
                if (usageDashboardMonthTokensLabel) usageDashboardMonthTokensLabel.innerHTML = t('usage.monthTokensLabel');

                const usageDashboardLatestTitle = document.getElementById('usageDashboardLatestTitle');
                if (usageDashboardLatestTitle) usageDashboardLatestTitle.textContent = t('usage.latestTitle');

                const signinNoAccountText = document.getElementById('signinNoAccountText');
                if (signinNoAccountText) signinNoAccountText.textContent = t('auth.noAccount');

                const signinCreateAccountLink = document.getElementById('signinCreateAccountLink');
                if (signinCreateAccountLink) signinCreateAccountLink.textContent = t('auth.createAccount');

                const signupModalTitle = document.getElementById('signupModalTitle');
                if (signupModalTitle) signupModalTitle.textContent = t('auth.signup.title');

                const signupNameLabel = document.getElementById('signupNameLabel');
                if (signupNameLabel) signupNameLabel.textContent = t('auth.signup.fullNameLabel');

                const signupEmailLabel = document.getElementById('signupEmailLabel');
                if (signupEmailLabel) signupEmailLabel.textContent = t('auth.forgotPassword.emailLabel');

                const signupPasswordLabel = document.getElementById('signupPasswordLabel');
                if (signupPasswordLabel) signupPasswordLabel.textContent = t('auth.signup.passwordLabel');

                const signupPassword = document.getElementById('signupPassword');
                if (signupPassword) signupPassword.placeholder = t('auth.passwordMinChars');

                const signupPasswordConfirmLabel = document.getElementById('signupPasswordConfirmLabel');
                if (signupPasswordConfirmLabel) signupPasswordConfirmLabel.textContent = t('auth.signup.confirmPasswordLabel');

                const signupPasswordConfirm = document.getElementById('signupPasswordConfirm');
                if (signupPasswordConfirm) signupPasswordConfirm.placeholder = t('auth.signup.confirmPasswordPlaceholder');

                const signupSubmitBtn = document.getElementById('signupSubmitBtn');
                if (signupSubmitBtn) signupSubmitBtn.textContent = t('auth.signup.submit');

                const signupHaveAccountText = document.getElementById('signupHaveAccountText');
                if (signupHaveAccountText) signupHaveAccountText.textContent = t('auth.signup.haveAccount');

                const signupSigninLink = document.getElementById('signupSigninLink');
                if (signupSigninLink) signupSigninLink.textContent = t('auth.signup.signin');

                const signinModalTitle = document.getElementById('signinModalTitle');
                if (signinModalTitle) signinModalTitle.textContent = t('auth.signin.title');

                const signinEmailLabel = document.getElementById('signinEmailLabel');
                if (signinEmailLabel) signinEmailLabel.textContent = t('auth.forgotPassword.emailLabel');

                const signinPasswordLabel = document.getElementById('signinPasswordLabel');
                if (signinPasswordLabel) signinPasswordLabel.textContent = t('auth.signin.passwordLabel');

                const signinPassword = document.getElementById('signinPassword');
                if (signinPassword) signinPassword.placeholder = t('auth.signin.passwordPlaceholder');

                const rememberMeLabelText = document.getElementById('rememberMeLabelText');
                if (rememberMeLabelText) rememberMeLabelText.textContent = t('auth.signin.rememberMe');

                const forgotPasswordLinkText = document.getElementById('forgotPasswordLinkText');
                if (forgotPasswordLinkText) forgotPasswordLinkText.textContent = t('auth.signin.forgotPassword');

                const signinSubmitBtn = document.getElementById('signinSubmitBtn');
                if (signinSubmitBtn) signinSubmitBtn.textContent = t('auth.signin.submit');

                const forgotPasswordModalTitle = document.getElementById('forgotPasswordModalTitle');
                if (forgotPasswordModalTitle) forgotPasswordModalTitle.textContent = t('auth.forgotPassword.title');

                const forgotPasswordModalSubtitle = document.getElementById('forgotPasswordModalSubtitle');
                if (forgotPasswordModalSubtitle) forgotPasswordModalSubtitle.textContent = t('auth.forgotPassword.subtitle');

                const forgotPasswordEmailLabel = document.getElementById('forgotPasswordEmailLabel');
                if (forgotPasswordEmailLabel) forgotPasswordEmailLabel.textContent = t('auth.forgotPassword.emailLabel');

                const forgotPasswordNewLabel = document.getElementById('forgotPasswordNewLabel');
                if (forgotPasswordNewLabel) forgotPasswordNewLabel.textContent = t('auth.forgotPassword.newPasswordLabel');

                const forgotPasswordNew = document.getElementById('forgotPasswordNew');
                if (forgotPasswordNew) forgotPasswordNew.placeholder = t('auth.forgotPassword.minChars');

                const forgotPasswordMinCharsHint = document.getElementById('forgotPasswordMinCharsHint');
                if (forgotPasswordMinCharsHint) forgotPasswordMinCharsHint.textContent = t('auth.forgotPassword.minChars');

                const forgotPasswordSubmitBtn = document.getElementById('forgotPasswordSubmitBtn');
                if (forgotPasswordSubmitBtn) forgotPasswordSubmitBtn.textContent = t('auth.forgotPassword.submit');

                const forgotPasswordBackToSigninLink = document.getElementById('forgotPasswordBackToSigninLink');
                if (forgotPasswordBackToSigninLink) forgotPasswordBackToSigninLink.textContent = t('auth.forgotPassword.backToSignin');

                const verificationModalTitle = document.getElementById('verificationModalTitle');
                if (verificationModalTitle) verificationModalTitle.textContent = t('auth.verification.title');

                const verificationSentToLabel = document.getElementById('verificationSentToLabel');
                if (verificationSentToLabel) verificationSentToLabel.textContent = t('auth.verification.sentTo');

                const verificationCodeSimLabel = document.getElementById('verificationCodeSimLabel');
                if (verificationCodeSimLabel) verificationCodeSimLabel.textContent = t('auth.verification.codeSim');

                const verificationProductionNote = document.getElementById('verificationProductionNote');
                if (verificationProductionNote) verificationProductionNote.textContent = t('auth.verification.productionNote');

                const verificationEnterCodeLabel = document.getElementById('verificationEnterCodeLabel');
                if (verificationEnterCodeLabel) verificationEnterCodeLabel.textContent = t('auth.verification.enterCode');

                const verificationCodeHint = document.getElementById('verificationCodeHint');
                if (verificationCodeHint) verificationCodeHint.textContent = t('auth.verification.codeHint');

                const verificationSubmitBtn = document.getElementById('verificationSubmitBtn');
                if (verificationSubmitBtn) verificationSubmitBtn.textContent = t('auth.verification.submit');

                const verificationResendLink = document.getElementById('verificationResendLink');
                if (verificationResendLink) verificationResendLink.textContent = t('auth.verification.resend');

                const verificationCancelLink = document.getElementById('verificationCancelLink');
                if (verificationCancelLink) verificationCancelLink.textContent = t('auth.verification.cancel');

                const sidebarAccountLabel = document.getElementById('sidebarAccountLabel');
                if (sidebarAccountLabel) sidebarAccountLabel.textContent = t('sidebar.account');

                const sidebarStatsLabel = document.getElementById('sidebarStatsLabel');
                if (sidebarStatsLabel) sidebarStatsLabel.textContent = t('sidebar.stats');

                const sidebarSettingsLabel = document.getElementById('sidebarSettingsLabel');
                if (sidebarSettingsLabel) sidebarSettingsLabel.textContent = t('sidebar.settings');

                const sidebarAboutLabel = document.getElementById('sidebarAboutLabel');
                if (sidebarAboutLabel) sidebarAboutLabel.textContent = t('sidebar.about');

                const sidebarEnterpriseLabel = document.getElementById('sidebarEnterpriseLabel');
                if (sidebarEnterpriseLabel) sidebarEnterpriseLabel.textContent = t('sidebar.enterprise');

                const userMenuCloseBtn = document.getElementById('userMenuCloseBtn');
                if (userMenuCloseBtn) userMenuCloseBtn.setAttribute('aria-label', t('userMenu.close'));

                const userMenuAvatar = document.getElementById('userMenuAvatar');
                if (userMenuAvatar) userMenuAvatar.setAttribute('title', t('userMenu.avatarTitle'));

                const userMenuProfilePhotoLabel = document.getElementById('userMenuProfilePhotoLabel');
                if (userMenuProfilePhotoLabel) userMenuProfilePhotoLabel.textContent = t('userMenu.profilePhoto');

                const userMenuChangePasswordLabel = document.getElementById('userMenuChangePasswordLabel');
                if (userMenuChangePasswordLabel) userMenuChangePasswordLabel.textContent = t('userMenu.changePassword');

                const userMenuPrivacyLabel = document.getElementById('userMenuPrivacyLabel');
                if (userMenuPrivacyLabel) userMenuPrivacyLabel.textContent = t('userMenu.privacy');

                const userMenuLogoutLabel = document.getElementById('userMenuLogoutLabel');
                if (userMenuLogoutLabel) userMenuLogoutLabel.textContent = t('userMenu.logout');

                const statsModalTitle = document.getElementById('statsModalTitle');
                if (statsModalTitle) statsModalTitle.textContent = t('modal.statsTitle');

                const aboutModalTitle = document.getElementById('aboutModalTitle');
                if (aboutModalTitle) aboutModalTitle.textContent = t('modal.aboutTitle');

                // About modal content is mostly static HTML; swap content for EN when needed.
                applyAboutLanguage();

                const userInput = document.getElementById('userInput');
                if (userInput) userInput.placeholder = t('ui.inputPlaceholder');

                const attachFileBtn = document.getElementById('attachFileBtn');
                if (attachFileBtn) attachFileBtn.setAttribute('title', t('ui.attachFileTitle'));

                const voiceInputBtn = document.getElementById('voiceInputBtn');
                if (voiceInputBtn) voiceInputBtn.setAttribute('title', t('ui.voiceInputTitle'));

                const agentBtn = document.getElementById('agentBtn');
                if (agentBtn) agentBtn.setAttribute('title', t('ui.chooseAgentTitle'));

                const welcomeVisionTitle = document.getElementById('welcomeVisionTitle');
                if (welcomeVisionTitle) welcomeVisionTitle.textContent = t('welcome.visionTitle');

                const welcomeVisionDesc = document.getElementById('welcomeVisionDesc');
                if (welcomeVisionDesc) welcomeVisionDesc.textContent = t('welcome.visionDesc');

                const welcomeTasksTitle = document.getElementById('welcomeTasksTitle');
                if (welcomeTasksTitle) welcomeTasksTitle.textContent = t('welcome.tasksTitle');

                const welcomeTasksDesc = document.getElementById('welcomeTasksDesc');
                if (welcomeTasksDesc) welcomeTasksDesc.textContent = t('welcome.tasksDesc');

                const welcomeSubtitle = document.getElementById('welcomeSubtitle');
                if (welcomeSubtitle) welcomeSubtitle.textContent = t('welcome.subtitle');

                const welcomeExcelTitle = document.getElementById('welcomeExcelTitle');
                if (welcomeExcelTitle) welcomeExcelTitle.textContent = t('welcome.excelTitle');

                const welcomeExcelDesc = document.getElementById('welcomeExcelDesc');
                if (welcomeExcelDesc) welcomeExcelDesc.textContent = t('welcome.excelDesc');

                const welcomeFinanceTitle = document.getElementById('welcomeFinanceTitle');
                if (welcomeFinanceTitle) welcomeFinanceTitle.textContent = t('welcome.financeTitle');

                const welcomeFinanceDesc = document.getElementById('welcomeFinanceDesc');
                if (welcomeFinanceDesc) welcomeFinanceDesc.textContent = t('welcome.financeDesc');

                const welcomeWebTitle = document.getElementById('welcomeWebTitle');
                if (welcomeWebTitle) welcomeWebTitle.textContent = t('welcome.webTitle');

                const welcomeWebDesc = document.getElementById('welcomeWebDesc');
                if (welcomeWebDesc) welcomeWebDesc.textContent = t('welcome.webDesc');

                const welcomeMoreTitle = document.getElementById('welcomeMoreTitle');
                if (welcomeMoreTitle) welcomeMoreTitle.textContent = t('welcome.moreTitle');

                const welcomeMoreDesc = document.getElementById('welcomeMoreDesc');
                if (welcomeMoreDesc) welcomeMoreDesc.textContent = t('welcome.moreDesc');

                const welcomeEmailTitle = document.getElementById('welcomeEmailTitle');
                if (welcomeEmailTitle) welcomeEmailTitle.textContent = t('welcome.emailTitle');

                const welcomeEmailDesc = document.getElementById('welcomeEmailDesc');
                if (welcomeEmailDesc) welcomeEmailDesc.textContent = t('welcome.emailDesc');

                const voiceStatusText = document.getElementById('voiceStatusText');
                if (voiceStatusText && (!voiceStatusText.textContent || voiceStatusText.textContent.trim().length === 0 || voiceStatusText.textContent === 'Je vous √©coute...')) {
                    voiceStatusText.textContent = t('voice.listening');
                }
            } catch (_) {}

            try {
                // D√©pend de la langue (ask/local/cloud)
                refreshStorageModeUI();
            } catch (_) {}

            try {
                // Mettre √† jour la langue de la reco vocale simple
                if (typeof recognition !== 'undefined' && recognition) {
                    recognition.lang = getSpeechLocale();
                }
            } catch (_) {}

            try {
                // Mettre √† jour la langue du mode vocal
                if (typeof voiceRecognition !== 'undefined' && voiceRecognition) {
                    voiceRecognition.lang = getSpeechLocale();
                }
            } catch (_) {}

            try {
                // Certains √©l√©ments sont inject√©s dynamiquement (innerHTML), ex: bouton compte.
                if (typeof updateUIForAuth === 'function') updateUIForAuth();
            } catch (_) {}

            try {
                // Si le modal Stats est ouvert, re-rendre son contenu pour appliquer les libell√©s traduits (Average HI/CHR).
                const statsModal = document.getElementById('statsModal');
                if (statsModal && statsModal.classList.contains('show') && typeof showStats === 'function') {
                    showStats();
                }
            } catch (_) {}

            try {
                // Finance overlay: labels are injected dynamically, so apply dedicated i18n when present.
                if (typeof applyLanguageToFinanceUI === 'function') applyLanguageToFinanceUI();
            } catch (_) {}
        }

        function applyLanguageToFinanceUI() {
            const overlay = document.getElementById('financeAIOverlay');
            if (!overlay) return;

            const lang = getAppLanguage();
            const strings = {
                fr: {
                    headerTitle: 'Centre Finance & Comptabilit√©',
                    headerSubtitle: 'Gestion financi√®re & analyse de march√©',

                    btnToolsAria: 'Outils',
                    btnToolsTitle: "Outils d'Automatisation",
                    btnHistoryAria: 'Historique',
                    btnHistoryTitle: 'Historique des conversations',
                    btnHelpAria: 'Aide',
                    btnHelpTitle: "Guide d'utilisation",
                    btnSettingsAria: 'Param√®tres',
                    btnSettingsTitle: "Param√®tres de l'entreprise",
                    btnRgpdAria: 'RGPD',
                    btnRgpdTitle: 'Protection des donn√©es',
                    btnCloseAria: 'Fermer',

                    rgpdTitle: 'Protection de vos donn√©es',
                    rgpdSubtitle: 'S√©curit√©, isolation par utilisateur et bonnes pratiques RGPD',
                    rgpdIsolationH3: 'üîí Isolation des donn√©es',
                    rgpdIsolationP1: "Vos donn√©es Finance sont <strong>isol√©es par compte</strong> : toutes les op√©rations passent par une authentification (JWT sign√©) et l'acc√®s est scind√© par utilisateur c√¥t√© serveur. Concr√®tement, un autre compte ne peut pas lister, t√©l√©charger ou supprimer vos factures/rapports, ni acc√©der √† vos conversations/param√®tres.",
                    rgpdSecurityH3: 'üõ°Ô∏è S√©curit√© renforc√©e',
                    rgpdSecurityLi1: 'Chiffrement en transit (HTTPS/TLS)',
                    rgpdSecurityLi2: 'Stockage Cloud priv√© (Azure, conteneurs Blob non publics)',
                    rgpdSecurityLi3: 'Authentification par token JWT sign√© (obligatoire)',
                    rgpdSecurityLi4: "Isolation stricte des fichiers (pr√©fixe utilisateur) et contr√¥le d'acc√®s c√¥t√© serveur",
                    rgpdSecurityLi5: 'H√©bergement en France (France Central)',
                    rgpdRightsH3: 'üìã Vos droits RGPD',
                    rgpdRightsLi1: '<strong>Acc√®s</strong> : Consultez toutes vos donn√©es √† tout moment',
                    rgpdRightsLi2: '<strong>Rectification</strong> : Modifiez vos informations',
                    rgpdRightsLi3: "<strong>Suppression</strong> : Demandez l'effacement de vos donn√©es",
                    rgpdRightsLi4: '<strong>Portabilit√©</strong> : Exportez vos donn√©es (selon les fonctionnalit√©s disponibles)',
                    rgpdRetentionH3: '‚è±Ô∏è Conservation des donn√©es',
                    rgpdRetentionLi1: 'Conversations / param√®tres : conserv√©s pour fournir le service, et supprimables sur demande',
                    rgpdRetentionLi2: "Factures / rapports : conserv√©s tant que vous les gardez, et supprimables depuis l'interface",
                    rgpdRetentionLi3: 'Note : la conformit√© RGPD d√©pend aussi de votre usage (base l√©gale, mentions, droits, processus internes)',
                    rgpdContactP: 'Pour toute question relative √† vos donn√©es : <strong>contact@axilum.com</strong>',
                    helpTitle: 'Guide Complet du Module Finance',
                    helpSubtitle: 'D√©couvrez toutes les fonctionnalit√©s et capacit√©s',

                    settingsTitle: '‚öôÔ∏è Param√®tres Entreprise',
                    settingsDesc: "Informations de votre entreprise pour am√©liorer la pr√©cision de l'analyse financi√®re.",
                    settingsMenu: 'Menu',
                    navGeneral: 'G√©n√©ral',
                    navContact: 'Contact',
                    navCurrency: 'Devise',
                    navLegal: 'L√©gal',
                    sectionGeneral: 'G√©n√©ral',
                    sectionContact: 'Contact',
                    sectionCurrency: 'Devise',
                    sectionLegal: 'L√©gal',
                    labelCompanyName: "Nom de l'entreprise",
                    labelCompanyActivity: "Domaine d'activit√©",
                    labelCompanyAddress: 'Adresse compl√®te',
                    labelCompanyPhone: 'T√©l√©phone',
                    labelCompanyEmail: 'Email',
                    labelCompanyCurrency: 'Devise',
                    labelCompanyRegistration: 'Num√©ro SIRET/RC',
                    labelOptional: '(optionnel)',
                    placeholderCompanyName: 'Ex: Axilum',
                    placeholderCompanyActivity: 'Ex: Technologies, Commerce, Services...',
                    placeholderCompanyAddress: 'Rue, ville, code postal, pays...',
                    placeholderCompanyPhone: '+213 XX XX XX XX',
                    placeholderCompanyEmail: 'contact@entreprise.com',
                    placeholderCompanyRegistration: 'Ex: 123 456 789 00012',
                    saveSettings: 'Enregistrer les informations',

                    historyTitle: 'Historique',
                    newConversation: '+ Nouvelle conversation',

                    toolsTitle: "Outils d'Automatisation",
                    toolInvoiceName: 'Lecture Automatique de Factures',
                    toolInvoiceDesc: 'OCR IA ‚Ä¢ Extraction montants, dates, fournisseurs, TVA',
                    toolFraudName: 'D√©tection de Fraudes',
                    toolFraudDesc: 'ML Detection ‚Ä¢ Anomalies, doublons, alertes temps r√©el',
                    toolCashflowName: 'Pr√©vision de Tr√©sorerie',
                    toolCashflowDesc: 'Pr√©dictions flux futurs ‚Ä¢ Simulations sc√©narios',
                    toolExpenseName: 'Classification des D√©penses',
                    toolExpenseDesc: 'Auto-cat√©gorisation ‚Ä¢ R√®gles personnalisables',
                    toolReportsName: 'Rapports Financiers Automatiques',
                    toolReportsDesc: 'Bilans, comptes r√©sultat ‚Ä¢ Export PDF multiformat',
                    toolListInvoices: 'Lister Factures',
                    toolListReports: 'Lister Rapports',

                    chatTitle: 'Agent Alex',
                    chatSubtitle: 'Posez vos questions de gestion financi√®re et comptable',
                    statusActive: 'Actif',
                    quickKpis: 'KPIs budg√©taires',
                    quickClosure: 'Cl√¥ture mensuelle',
                    inputPlaceholder: 'Budget, comptabilit√©, analyse march√©, tr√©sorerie...',
                    uploadInvoiceTitle: 'Uploader une facture'
                },
                en: {
                    headerTitle: 'Finance & Accounting Hub',
                    headerSubtitle: 'Financial Management & Market Analysis Center',

                    btnToolsAria: 'Tools',
                    btnToolsTitle: 'Automation tools',
                    btnHistoryAria: 'History',
                    btnHistoryTitle: 'Conversation history',
                    btnHelpAria: 'Help',
                    btnHelpTitle: 'User guide',
                    btnSettingsAria: 'Settings',
                    btnSettingsTitle: 'Company settings',
                    btnRgpdAria: 'Data protection',
                    btnRgpdTitle: 'Data protection',
                    btnCloseAria: 'Close',

                    rgpdTitle: 'Your data protection',
                    rgpdSubtitle: 'Security, per-user isolation and GDPR best practices',
                    rgpdIsolationH3: 'üîí Data isolation',
                    rgpdIsolationP1: 'Your Finance data is <strong>isolated per account</strong>: every operation requires authentication (signed JWT) and access is partitioned per user on the server. Concretely, another account cannot list, download, or delete your invoices/reports, nor access your conversations/settings.',
                    rgpdSecurityH3: 'üõ°Ô∏è Enhanced security',
                    rgpdSecurityLi1: 'Encryption in transit (HTTPS/TLS)',
                    rgpdSecurityLi2: 'Private cloud storage (Azure, non-public Blob containers)',
                    rgpdSecurityLi3: 'Authentication via signed JWT token (required)',
                    rgpdSecurityLi4: 'Strict file isolation (user prefix) and server-side access control',
                    rgpdSecurityLi5: 'Hosted in France (France Central)',
                    rgpdRightsH3: 'üìã Your GDPR rights',
                    rgpdRightsLi1: '<strong>Access</strong>: View all your data at any time',
                    rgpdRightsLi2: '<strong>Rectification</strong>: Update your information',
                    rgpdRightsLi3: '<strong>Erasure</strong>: Request deletion of your data',
                    rgpdRightsLi4: '<strong>Portability</strong>: Export your data (depending on available features)',
                    rgpdRetentionH3: '‚è±Ô∏è Data retention',
                    rgpdRetentionLi1: 'Conversations / settings: retained to provide the service, and deletable upon request',
                    rgpdRetentionLi2: 'Invoices / reports: retained as long as you keep them, and deletable from the interface',
                    rgpdRetentionLi3: 'Note: GDPR compliance also depends on how you use the service (legal basis, notices, rights handling, internal processes)',
                    rgpdContactP: 'For any questions about your data: <strong>contact@axilum.com</strong>',
                    helpTitle: 'Finance Module - Full Guide',
                    helpSubtitle: 'Discover all features and capabilities',

                    settingsTitle: '‚öôÔ∏è Company Settings',
                    settingsDesc: 'Company information to improve financial analysis accuracy.',
                    settingsMenu: 'Menu',
                    navGeneral: 'General',
                    navContact: 'Contact',
                    navCurrency: 'Currency',
                    navLegal: 'Legal',
                    sectionGeneral: 'General',
                    sectionContact: 'Contact',
                    sectionCurrency: 'Currency',
                    sectionLegal: 'Legal',
                    labelCompanyName: 'Company name',
                    labelCompanyActivity: 'Business activity',
                    labelCompanyAddress: 'Full address',
                    labelCompanyPhone: 'Phone',
                    labelCompanyEmail: 'Email',
                    labelCompanyCurrency: 'Currency',
                    labelCompanyRegistration: 'Registration number',
                    labelOptional: '(optional)',
                    placeholderCompanyName: 'e.g., Axilum',
                    placeholderCompanyActivity: 'e.g., Technology, Retail, Services‚Ä¶',
                    placeholderCompanyAddress: 'Street, city, postal code, country‚Ä¶',
                    placeholderCompanyPhone: '+213 XX XX XX XX',
                    placeholderCompanyEmail: 'contact@company.com',
                    placeholderCompanyRegistration: 'e.g., 123 456 789 00012',
                    saveSettings: 'Save information',

                    historyTitle: 'History',
                    newConversation: '+ New conversation',

                    toolsTitle: 'Automation tools',
                    toolInvoiceName: 'Automatic Invoice Reading',
                    toolInvoiceDesc: 'AI OCR ‚Ä¢ Extract amounts, dates, vendor, VAT',
                    toolFraudName: 'Fraud Detection',
                    toolFraudDesc: 'ML detection ‚Ä¢ Anomalies, duplicates, real-time alerts',
                    toolCashflowName: 'Cashflow Forecast',
                    toolCashflowDesc: 'Future cashflow predictions ‚Ä¢ Scenario simulations',
                    toolExpenseName: 'Expense Classification',
                    toolExpenseDesc: 'Auto-categorization ‚Ä¢ Customizable rules',
                    toolReportsName: 'Automated Financial Reports',
                    toolReportsDesc: 'Balance sheet, P&L ‚Ä¢ Multi-format PDF export',
                    toolListInvoices: 'List invoices',
                    toolListReports: 'List reports',

                    chatTitle: 'Agent Alex',
                    chatSubtitle: 'Ask questions about finance management and accounting',
                    statusActive: 'Active',
                    quickKpis: 'Budget KPIs',
                    quickClosure: 'Monthly close',
                    inputPlaceholder: 'Budget, accounting, market analysis, cashflow‚Ä¶',
                    uploadInvoiceTitle: 'Upload an invoice'
                }
            };

            const S = (lang === 'en') ? strings.en : strings.fr;

            const getElById = (id) => {
                return overlay.querySelector(`#${id}`) || document.getElementById(id);
            };

            const setText = (id, text) => {
                const el = getElById(id);
                if (el && typeof text === 'string') el.textContent = text;
            };
            const setHtml = (id, html) => {
                const el = getElById(id);
                if (el && typeof html === 'string') el.innerHTML = html;
            };
            const setAttr = (id, attr, val) => {
                const el = getElById(id);
                if (el && typeof val === 'string') el.setAttribute(attr, val);
            };

            setText('financeHeaderTitle', S.headerTitle);
            setText('financeHeaderSubtitle', S.headerSubtitle);

            setAttr('financeToolsToggleBtn', 'aria-label', S.btnToolsAria);
            setAttr('financeToolsToggleBtn', 'title', S.btnToolsTitle);
            setAttr('financeHistoryToggleBtn', 'aria-label', S.btnHistoryAria);
            setAttr('financeHistoryToggleBtn', 'title', S.btnHistoryTitle);
            setAttr('financeHelpToggleBtn', 'aria-label', S.btnHelpAria);
            setAttr('financeHelpToggleBtn', 'title', S.btnHelpTitle);
            setAttr('financeSettingsToggleBtn', 'aria-label', S.btnSettingsAria);
            setAttr('financeSettingsToggleBtn', 'title', S.btnSettingsTitle);
            setAttr('financeRgpdToggleBtn', 'aria-label', S.btnRgpdAria);
            setAttr('financeRgpdToggleBtn', 'title', S.btnRgpdTitle);
            setAttr('financeCloseBtn', 'aria-label', S.btnCloseAria);

            setText('financeRgpdTitle', S.rgpdTitle);
            setText('financeRgpdSubtitle', S.rgpdSubtitle);
            setText('financeRgpdIsolationH3', S.rgpdIsolationH3);
            setHtml('financeRgpdIsolationP1', S.rgpdIsolationP1);

            setText('financeRgpdSecurityH3', S.rgpdSecurityH3);
            setText('financeRgpdSecurityLi1', S.rgpdSecurityLi1);
            setText('financeRgpdSecurityLi2', S.rgpdSecurityLi2);
            setText('financeRgpdSecurityLi3', S.rgpdSecurityLi3);
            setText('financeRgpdSecurityLi4', S.rgpdSecurityLi4);
            setText('financeRgpdSecurityLi5', S.rgpdSecurityLi5);

            setText('financeRgpdRightsH3', S.rgpdRightsH3);
            setHtml('financeRgpdRightsLi1', S.rgpdRightsLi1);
            setHtml('financeRgpdRightsLi2', S.rgpdRightsLi2);
            setHtml('financeRgpdRightsLi3', S.rgpdRightsLi3);
            setHtml('financeRgpdRightsLi4', S.rgpdRightsLi4);

            setText('financeRgpdRetentionH3', S.rgpdRetentionH3);
            setText('financeRgpdRetentionLi1', S.rgpdRetentionLi1);
            setText('financeRgpdRetentionLi2', S.rgpdRetentionLi2);
            setText('financeRgpdRetentionLi3', S.rgpdRetentionLi3);

            setHtml('financeRgpdContactP', S.rgpdContactP);

            // Fallback: if list items are missing ids (or DOM differs), still translate the security section.
            try {
                const rgpdModal = overlay.querySelector('#financeRGPDModal') || document.getElementById('financeRGPDModal');
                if (rgpdModal) {
                    const securityH3 = rgpdModal.querySelector('#financeRgpdSecurityH3') || Array.from(rgpdModal.querySelectorAll('.rgpd-section h3'))
                        .find((h) => {
                            const txt = (h && h.textContent) ? h.textContent : '';
                            return txt.includes('S√©curit√©') || txt.toLowerCase().includes('security');
                        });
                    if (securityH3) securityH3.textContent = S.rgpdSecurityH3;

                    const securitySection = securityH3 ? securityH3.closest('.rgpd-section') : null;
                    if (securitySection) {
                        const lis = securitySection.querySelectorAll('li');
                        if (lis && lis[0]) lis[0].textContent = S.rgpdSecurityLi1;
                        if (lis && lis[1]) lis[1].textContent = S.rgpdSecurityLi2;
                        if (lis && lis[2]) lis[2].textContent = S.rgpdSecurityLi3;
                        if (lis && lis[3]) lis[3].textContent = S.rgpdSecurityLi4;
                        if (lis && lis[4]) lis[4].textContent = S.rgpdSecurityLi5;
                    }

                    const contactP = rgpdModal.querySelector('#financeRgpdContactP') || rgpdModal.querySelector('.rgpd-contact p');
                    if (contactP && typeof S.rgpdContactP === 'string') contactP.innerHTML = S.rgpdContactP;
                }
            } catch (_) {}
            setText('financeHelpTitle', S.helpTitle);
            setText('financeHelpSubtitle', S.helpSubtitle);

            setText('financeSettingsPanelTitle', S.settingsTitle);
            setText('financeSettingsPanelDesc', S.settingsDesc);
            setText('financeSettingsMenuLabel', S.settingsMenu);
            setText('financeSettingsNav_general', S.navGeneral);
            setText('financeSettingsNav_contact', S.navContact);
            setText('financeSettingsNav_currency', S.navCurrency);
            setText('financeSettingsNav_legal', S.navLegal);
            setText('financeSettingsSectionTitle_general', S.sectionGeneral);
            setText('financeSettingsSectionTitle_contact', S.sectionContact);
            setText('financeSettingsSectionTitle_currency', S.sectionCurrency);
            setText('financeSettingsSectionTitle_legal', S.sectionLegal);

            setHtml('financeLabelCompanyName', `${S.labelCompanyName} <span style="color: #ef4444;">*</span>`);
            setHtml('financeLabelCompanyActivity', `${S.labelCompanyActivity} <span style="color: #ef4444;">*</span>`);
            setHtml('financeLabelCompanyAddress', `${S.labelCompanyAddress} <span style="color: #ef4444;">*</span>`);
            setHtml('financeLabelCompanyPhone', `${S.labelCompanyPhone} <span style="color: #ef4444;">*</span>`);
            setHtml('financeLabelCompanyEmail', `${S.labelCompanyEmail} <span style="color: #ef4444;">*</span>`);
            setHtml('financeLabelCompanyCurrency', `${S.labelCompanyCurrency} <span style="color: #ef4444;">*</span>`);
            setHtml('financeLabelCompanyRegistration', `${S.labelCompanyRegistration} <span style="color: #9ca3af; font-weight: 400;">${S.labelOptional}</span>`);

            setAttr('financeCompanyName', 'placeholder', S.placeholderCompanyName);
            setAttr('financeCompanyActivity', 'placeholder', S.placeholderCompanyActivity);
            setAttr('financeCompanyAddress', 'placeholder', S.placeholderCompanyAddress);
            setAttr('financeCompanyPhone', 'placeholder', S.placeholderCompanyPhone);
            setAttr('financeCompanyEmail', 'placeholder', S.placeholderCompanyEmail);
            setAttr('financeCompanyRegistration', 'placeholder', S.placeholderCompanyRegistration);
            setText('financeSaveSettingsBtn', S.saveSettings);

            setText('financeHistoryTitle', S.historyTitle);
            setText('financeNewConversationBtn', S.newConversation);

            setText('financeToolsPanelTitleText', S.toolsTitle);
            setText('financeToolInvoiceName', S.toolInvoiceName);
            setText('financeToolInvoiceDesc', S.toolInvoiceDesc);
            setText('financeToolFraudName', S.toolFraudName);
            setText('financeToolFraudDesc', S.toolFraudDesc);
            setText('financeToolCashflowName', S.toolCashflowName);
            setText('financeToolCashflowDesc', S.toolCashflowDesc);
            setText('financeToolExpenseName', S.toolExpenseName);
            setText('financeToolExpenseDesc', S.toolExpenseDesc);
            setText('financeToolReportsName', S.toolReportsName);
            setText('financeToolReportsDesc', S.toolReportsDesc);
            setText('financeToolListInvoicesName', S.toolListInvoices);
            setText('financeToolListReportsName', S.toolListReports);

            setText('financeChatTitle', S.chatTitle);
            setText('financeChatSubtitle', S.chatSubtitle);
            setText('financeStatusLabel', S.statusActive);
            setText('financeQuickKpisBtn', S.quickKpis);
            try {
                // This label already exists in the global i18n table; reuse it.
                setText('financeQuickMarketBtn', t('marketStudy.quickBtn'));
            } catch (_) {}
            setText('financeQuickClosureBtn', S.quickClosure);
            setAttr('financeMsg', 'placeholder', S.inputPlaceholder);
            setAttr('financeUploadBtn', 'title', S.uploadInvoiceTitle);
        }

        function onLanguageChanged() {
            try {
                const sel = document.getElementById('languageSelect');
                if (!sel) return;
                setAppLanguage(sel.value);
                applyLanguageToUI();
            } catch (_) {}
        }

        function showAbout() {
            try { applyAboutLanguage(); } catch (_) {}
            document.getElementById('aboutModal').style.display = 'flex';
        }

        function closeAboutModal() {
            document.getElementById('aboutModal').style.display = 'none';
        }

        function showSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            try {
                const sel = document.getElementById('languageSelect');
                if (sel) sel.value = getAppLanguage();
                applyLanguageToUI();
            } catch (_) {}
            refreshStorageModeUI();
            try { refreshAiModelSelect(); } catch (_) {}
            // Defer to avoid blocking click release (prevents visible "blue flash" on sidebar buttons)
            setTimeout(() => { try { refreshPricingByModelTable(false); } catch (_) {} }, 0);
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function openEnterpriseOfferModal(e) {
            try { if (e) { e.preventDefault(); e.stopPropagation(); } } catch (_) {}
            const modal = document.getElementById('enterpriseOfferModal');
            if (modal) {
                modal.style.display = 'flex';
                // Envoyer le th√®me actuel √† l'iframe
                setTimeout(() => {
                    const iframe = document.getElementById('enterpriseOfferFrame');
                    const currentTheme = document.body.getAttribute('data-theme') || 'light';
                    if (iframe && iframe.contentWindow) {
                        iframe.contentWindow.postMessage({ type: 'axilum:theme-change', theme: currentTheme }, '*');
                    }
                }, 100);
            }
        }

        function closeEnterpriseOfferModal(e) {
            try { if (e) { e.preventDefault(); e.stopPropagation(); } } catch (_) {}
            const modal = document.getElementById('enterpriseOfferModal');
            if (modal) modal.style.display = 'none';
        }

        (function initEnterpriseOfferModal() {
            try {
                if (window.__axilumEnterpriseOfferModalInit) return;
                window.__axilumEnterpriseOfferModalInit = true;

                window.addEventListener('message', function (ev) {
                    try {
                        if (!ev || !ev.data) return;
                        if (ev.origin && ev.origin !== window.location.origin) return;
                        if (ev.data && ev.data.type === 'axilum:enterprise-offer:close') {
                            closeEnterpriseOfferModal();
                        }
                    } catch (_) {}
                });

                document.addEventListener('keydown', function (ev) {
                    try {
                        if (!ev || ev.key !== 'Escape') return;
                        const modal = document.getElementById('enterpriseOfferModal');
                        if (modal && modal.style.display === 'flex') closeEnterpriseOfferModal(ev);
                    } catch (_) {}
                });

                const modal = document.getElementById('enterpriseOfferModal');
                if (modal) {
                    modal.addEventListener('click', function (ev) {
                        try {
                            if (ev && ev.target === modal) closeEnterpriseOfferModal(ev);
                        } catch (_) {}
                    });
                }
            } catch (_) {}
        })();

        function showFunctions() {
            const panel = document.getElementById('functionsPanel');
            const body = document.getElementById('functionsPanelBody');
            const overlay = document.getElementById('panelOverlay');
            if (!panel || !body) {
                console.error('Panneau Fonctions introuvable');
                return;
            }
            body.innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <div style="font-weight:700; margin-bottom:8px; color:var(--text-primary);">FREE</div>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <button class="sessions-toggle-btn" disabled title="√Ä venir">R√©sum√© Document (FREE)</button>
                        </div>
                    </div>
                    <div>
                        <div style="font-weight:700; margin-bottom:8px; color:var(--text-primary);">PRO</div>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <button class="sessions-toggle-btn" onclick="activateProVision(); closeFunctionsPanel();" title="Analyse Vision (PRO)">Analyse Vision</button>
                            <button class="sessions-toggle-btn" disabled title="√Ä venir">R√©sum√© Document (PRO)</button>
                        </div>
                    </div>
                </div>
            `;
            overlay.style.display = 'block';
            panel.style.right = '0';
        }

        function showTools() {
            const panel = document.getElementById('toolsPanel');
            const body = document.getElementById('toolsPanelBody');
            const overlay = document.getElementById('panelOverlay');
            if (!panel || !body) {
                console.error('Panneau Outils introuvable');
                return;
            }
            body.innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <div style="font-weight:700; margin-bottom:8px; color:var(--text-primary);">FREE</div>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <button class="sessions-toggle-btn" onclick="openTranslationTool('FREE')" title="Traduction (FREE)">Traduction</button>
                            <button class="sessions-toggle-btn" onclick="openTTS()" title="Synth√®se vocale (FREE)">Synth√®se vocale</button>
                        </div>
                    </div>
                    <div>
                        <div style="font-weight:700; margin-bottom:8px; color:var(--text-primary);">PRO</div>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <button class="sessions-toggle-btn" onclick="openTranslationTool('PRO')" title="Traduction (PRO)">Traduction</button>
                            <button class="sessions-toggle-btn" disabled title="√Ä venir">Extraction Entit√©s (PRO)</button>
                        </div>
                    </div>
                </div>
            `;
            overlay.style.display = 'block';
            panel.style.right = '0';
        }

        // Outil Traduction (FREE/PRO)
        function openTranslationTool(mode) {
            const plan = (mode || 'FREE').toUpperCase();
            const targetLang = localStorage.getItem('translationTarget') || 'fr';
            const template = `
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <div style="display:flex; gap:8px; align-items:center;">
                        <label for=\"translationTarget\" style=\"min-width:120px;\">Langue cible</label>
                        <input id=\"translationTarget\" type=\"text\" value=\"${targetLang}\" placeholder=\"ex: en, fr, es\" style=\"flex:1; padding:8px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-secondary); color:var(--text-primary);\">
                    </div>
                    <textarea id=\"translationInput\" rows=\"6\" placeholder=\"Texte √† traduire...\" style=\"width:100%; padding:10px; border:1px solid var(--border-color); border-radius:10px; background:var(--bg-secondary); color:var(--text-primary);\"></textarea>
                    <div style=\"display:flex; gap:8px;\">
                        <button class=\"new-chat-btn\" onclick=\"runTranslation('${plan}')\">Traduire (${plan})</button>
                        <button class=\"new-chat-btn\" style=\"background: var(--bg-secondary); color: var(--text-primary);\" onclick=\"closeToolsModal()\">${t('ui.close')}</button>
                    </div>
                </div>
            `;
            showGenericModal(`Outil Traduction (${plan})`, template);
        }

        async function runTranslation(plan) {
            try {
                const inputEl = document.getElementById('translationInput');
                const langEl = document.getElementById('translationTarget');
                if (!inputEl || !langEl) { showToast('Formulaire traduction introuvable', 'error'); return; }
                const text = inputEl.value.trim();
                const target = langEl.value.trim() || 'fr';
                localStorage.setItem('translationTarget', target);
                if (!text) { showToast('Veuillez saisir un texte √† traduire', 'warning'); return; }

                showTyping();

                const endpoint = plan === 'PRO' ? AGENT_ENDPOINT_PRO : AGENT_ENDPOINT_FREE;
                const prompt = `Translate the following text to ${target}. Preserve meaning, tone, and formatting where relevant. Text:\n\n${text}`;

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: withAuthHeaders({ 'Content-Type': 'application/json' }),
                    body: JSON.stringify({ prompt, model: getSelectedAiModel() })
                });

                hideTyping();

                if (!res.ok) {
                    const errText = await res.text();
                    showToast(`Erreur traduction (${plan}): ${res.status}`, 'error');
                    appendMessage(text, `Erreur (${res.status}): ${errText}`);
                    return;
                }

                const data = await res.json();
                const output = data.response || data.text || JSON.stringify(data);
                appendMessage(text, output);
                closeGenericModal();
            } catch (e) {
                hideTyping();
                console.error('Translation error', e);
                showToast(`Erreur traduction: ${e.message || 'inconnue'}`, 'error');
            }
        }

        function closeSessionsList() {
            const conversationsList = document.getElementById('conversationsList');
            const toggleBtn = document.getElementById('sessionsToggleBtn');
            if (!conversationsList || !toggleBtn) return;
            conversationsList.classList.remove('visible');
            toggleBtn.classList.remove('active');
            try { conversationsList.style.removeProperty('--sessions-max-height'); } catch (_) {}
            conversationsList.style.overflowY = 'hidden';
        }

        // ===== TO DO AI - Syst√®me complet de gestion de t√¢ches =====
        
        let todoView = 'list'; // list, kanban, calendar
        let todoFilter = 'all'; // all, today, week, priority
        let todoCategory = 'all'; // all, work, personal, studies
        let selectedTask = null;
        let detailsPanelOpen = false;
        let notificationsEnabled = localStorage.getItem('todoNotificationsEnabled') === 'true';
        let notificationCheckInterval = null;
        let aiChatHistory = []; // Historique de conversation avec Agent ToDo

        function showTodoHelp() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const isEn = (lang === 'en');
            
            const existingHelp = document.getElementById('todo-help-modal');
            if (existingHelp) existingHelp.remove();
            
            const helpModal = document.createElement('div');
            helpModal.id = 'todo-help-modal';
            helpModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 10005;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                backdrop-filter: blur(5px);
                animation: fadeIn 0.2s ease-out;
            `;
            
            const title = isEn ? 'Agent ToDo User Guide' : 'Guide Utilisateur Agent ToDo';
            const subtitle = isEn ? 'Master your tasks and productivity' : 'Ma√Ætrisez vos t√¢ches et votre productivit√©';
            const closeText = isEn ? 'Close Guide' : 'Fermer le guide';
            
            const contentFr = `
                <h3>1. Introduction</h3>
                <p><strong>Agent ToDo</strong> est votre assistant intelligent pour la gestion des t√¢ches, des projets et de la productivit√© personnelle.</p>
                
                <h3>2. Fonctionnalit√©s Cl√©s</h3>
                <ul>
                    <li><strong>Gestion des T√¢ches :</strong> Cr√©ez, organisez et suivez vos t√¢ches quotidiennes avec des priorit√©s.</li>
                    <li><strong>Vues Multiples :</strong> Basculez entre les vues Liste, Kanban, Calendrier et Personnel pour visualiser votre travail.</li>
                    <li><strong>Cat√©gories Intelligentes :</strong> Classez vos t√¢ches par projets ou domaines (Travail, Personnel, Urgent, etc.).</li>
                    <li><strong>Rappels & Notifications :</strong> Ne manquez jamais une √©ch√©ance gr√¢ce aux rappels intelligents.</li>
                </ul>
                
                <h3>3. Commandes Utiles</h3>
                <ul>
                    <li><code>/tache [nom]</code> : Cr√©er une nouvelle t√¢che rapidement.</li>
                    <li><code>/synthese</code> : R√©sum√© de vos t√¢ches en cours et termin√©es.</li>
                    <li><code>/agenda</code> : Voir vos t√¢ches planifi√©es pour aujourd'hui.</li>
                </ul>
                
                <h3>4. Astuces</h3>
                <p>Utilisez l'Assistant IA pour prioriser automatiquement vos t√¢ches ou sugg√©rer des plans d'action pour des objectifs complexes.</p>
            `;
            
            const contentEn = `
                <h3>1. Introduction</h3>
                <p><strong>Agent ToDo</strong> is your intelligent assistant for task management, projects, and personal productivity.</p>
                
                <h3>2. Key Features</h3>
                <ul>
                    <li><strong>Task Management:</strong> Create, organize, and track daily tasks with priorities.</li>
                    <li><strong>Multiple Views:</strong> Switch between List, Kanban, Calendar, and Personal views to visualize your work.</li>
                    <li><strong>Smart Categories:</strong> Categorize tasks by projects or domains (Work, Personal, Urgent, etc.).</li>
                    <li><strong>Reminders & Notifications:</strong> Never miss a deadline with smart reminders.</li>
                </ul>
                
                <h3>3. Useful Commands</h3>
                <ul>
                    <li><code>/task [name]</code> : Create a new task quickly.</li>
                    <li><code>/summary</code> : Summary of your ongoing and completed tasks.</li>
                    <li><code>/agenda</code> : View tasks scheduled for today.</li>
                </ul>
                
                <h3>4. Tips</h3>
                <p>Use the AI Assistant to automatically prioritize your tasks or suggest action plans for complex goals.</p>
            `;

            helpModal.innerHTML = `
                <div style="
                    background: var(--bg-primary);
                    color: var(--text-primary);
                    width: 100%;
                    max-width: 700px;
                    max-height: 85vh;
                    border-radius: 16px;
                    border: 1px solid var(--border-color);
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                    overflow: hidden;
                ">
                    <div style="
                        padding: 24px;
                        border-bottom: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                        display: flex;
                        justify-content: space-between;
                        align-items: start;
                    ">
                        <div>
                            <h2 style="margin: 0; font-size: 24px; color: var(--text-primary); font-weight: 700;">${title}</h2>
                            <p style="margin: 4px 0 0; color: var(--text-secondary); font-size: 14px;">${subtitle}</p>
                        </div>
                        <button onclick="document.getElementById('todo-help-modal').remove()" style="
                            background: none;
                            border: none;
                            color: var(--text-secondary);
                            cursor: pointer;
                            padding: 4px;
                        ">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <div style="
                        padding: 32px;
                        overflow-y: auto;
                        color: var(--text-primary);
                        line-height: 1.6;
                        font-family: inherit;
                    ">
                        <style>
                            #todo-help-modal h3 { color: var(--accent); margin-top: 24px; margin-bottom: 12px; font-size: 18px; font-weight: 600; }
                            #todo-help-modal h3:first-child { margin-top: 0; }
                            #todo-help-modal ul { padding-left: 20px; margin-bottom: 16px; }
                            #todo-help-modal li { margin-bottom: 8px; }
                            #todo-help-modal code { background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px; font-family: monospace; color: var(--accent); border: 1px solid var(--border-color); }
                            #todo-help-modal p { margin-bottom: 16px; }
                        </style>
                        ${isEn ? contentEn : contentFr}
                    </div>
                    <div style="
                        padding: 20px 24px;
                        border-top: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                        display: flex;
                        justify-content: flex-end;
                    ">
                        <button onclick="document.getElementById('todo-help-modal').remove()" style="
                            padding: 10px 20px;
                            background: var(--accent);
                            border: none;
                            border-radius: 8px;
                            color: white;
                            font-weight: 600;
                            cursor: pointer;
                            transition: opacity 0.2s;
                        " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">${closeText}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpModal);
            
            // Close on click outside
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    helpModal.remove();
                }
            });
        }

        // Office Pro - Interface compl√®te To Do AI
        function openOfficePro() {
            // Fermer l'overlay existant s'il y en a un
            const existingOverlay = document.getElementById('officeProOverlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // Cr√©er l'overlay
            const modal = document.createElement('div');
            modal.id = 'officeProOverlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--bg-primary);
                z-index: 10000;
                display: flex;
                flex-direction: column;
                padding: 0;
                margin: 0;
            `;
            
            modal.innerHTML = `
                <!-- Header -->
                <div id="todoHeader" style="background: var(--bg-primary); border-bottom: 1px solid var(--border-color); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <button id="todoSidebarToggle" onclick="window.toggleTodoSidebar(true)" style="display: none; padding: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;" title="${t('todo.menu')}" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="3" y1="6" x2="21" y2="6"/>
                                <line x1="3" y1="12" x2="21" y2="12"/>
                                <line x1="3" y1="18" x2="21" y2="18"/>
                            </svg>
                        </button>
                        <div id="todoTitleBlock" style="display: flex; align-items: center; gap: 10px; color: var(--text-primary); font-size: 20px; font-weight: 700; margin-right: 60px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 11l3 3L22 4"/>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                            </svg>
                            ${t('todo.title')}
                        </div>
                    </div>
                    <div id="todoHeaderActions" style="display: flex; align-items: center; gap: 12px;">
                        <!-- Assistant IA Conversationnel -->
                        <div style="position: relative;">
                            <button id="aiAssistantBtn" onclick="toggleAiAssistant()" style="padding: 8px 16px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 13px; font-weight: 500;" title="${t('todo.aiAssistantTitle')}" onmouseover="this.style.background='var(--bg-hover)'; this.style.borderColor='var(--text-secondary)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.borderColor='var(--border-color)'">
                                ${t('todo.aiAssistant')}
                            </button>
                        </div>
                        <button id="todoProfileBtn" onclick="openPersonalProfileModal()" title="${t('todo.profile')}" aria-label="${t('todo.profile')}" style="padding: 8px; background: transparent; color: var(--text-secondary); border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M20 21a8 8 0 0 0-16 0" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                        </button>
                        <div id="todoSearchWrapper" style="position: relative;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                            <input id="todoSearchInput" type="text" placeholder="${t('todo.searchPlaceholder')}" onkeyup="filterTodoSearch(this.value)" style="padding: 8px 12px 8px 40px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; width: 250px; outline: none;">
                        </div>
                        <button id="notificationToggle" onclick="toggleNotifications()" style="padding: 8px; background: ${notificationsEnabled ? 'rgba(59, 130, 246, 0.1)' : 'transparent'}; color: ${notificationsEnabled ? 'var(--accent)' : 'var(--text-secondary)'}; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" title="${notificationsEnabled ? t('todo.notificationsEnabled') : t('todo.notificationsEnable')}">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                            </svg>
                        </button>
                        <button id="addTaskBtn" onclick="showAddTaskModal()" style="padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            <span id="addTaskBtnText">${t('todo.newTask')}</span>
                        </button>
                        </button>
                        <button id="todoHelpBtn" onclick="showTodoHelp()" title="${t('todo.help') || 'Guide'}" style="padding: 8px; background: transparent; color: var(--text-secondary); border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                        </button>
                        <button onclick="closeTodoAi()" style="padding: 8px; background: transparent; color: var(--text-secondary); border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Main Container -->
                <div id="todoMainContainer" style="flex: 1; display: flex; overflow: hidden; position: relative;">
                    <div id="todoSidebarBackdrop" onclick="window.toggleTodoSidebar(false)" style="display: none;"></div>
                    <!-- Sidebar -->
                    <div id="todoSidebar" style="width: 240px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); overflow-y: auto; padding: 16px;">
                        <button id="todoSidebarClose" onclick="window.toggleTodoSidebar(false)" style="display: none; position: absolute; top: 14px; right: 14px; padding: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;" title="${t('todo.close')}" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                        <!-- Vues -->
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin-bottom: 8px; color: var(--text-secondary); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px;">${t('todo.views')}</h3>
                            <button onclick="switchTodoView('list')" id="viewList" class="sidebar-btn" style="width: 100%; padding: 8px 12px; text-align: left; border: none; background: rgba(59, 130, 246, 0.1); color: var(--accent); border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; transition: all 0.2s;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="8" y1="6" x2="21" y2="6"/>
                                    <line x1="8" y1="12" x2="21" y2="12"/>
                                    <line x1="8" y1="18" x2="21" y2="18"/>
                                    <line x1="3" y1="6" x2="3.01" y2="6"/>
                                    <line x1="3" y1="12" x2="3.01" y2="12"/>
                                    <line x1="3" y1="18" x2="3.01" y2="18"/>
                                </svg>
                                ${t('todo.view.list')}
                            </button>
                            <button onclick="switchTodoView('kanban')" id="viewKanban" class="sidebar-btn" style="width: 100%; padding: 8px 12px; text-align: left; border: none; background: transparent; color: var(--text-primary); border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; transition: all 0.2s;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                                </svg>
                                ${t('todo.view.kanban')}
                            </button>
                            <button onclick="switchTodoView('calendar')" id="viewCalendar" class="sidebar-btn" style="width: 100%; padding: 8px 12px; text-align: left; border: none; background: transparent; color: var(--text-primary); border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; transition: all 0.2s;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                ${t('todo.view.calendar')}
                            </button>
                            <button onclick="switchTodoView('personal')" id="viewPersonal" class="sidebar-btn" style="width: 100%; padding: 8px 12px; text-align: left; border: none; background: transparent; color: var(--text-primary); border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; transition: all 0.2s;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M3 17l6-6 4 4 8-8"/>
                                    <path d="M14 7h7v7"/>
                                </svg>
                                ${t('todo.view.personal')}
                            </button>
                        </div>

                        <!-- Filtres -->
                        <div id="todoFilters"></div>

                        <!-- Cat√©gories -->
                        <div id="todoCategories"></div>
                    </div>

                    <!-- Main Area -->
                    <div id="todoMainArea" style="flex: 1; overflow-y: auto; padding: 20px; background: var(--bg-primary);">
                        <!-- Contenu dynamique -->
                    </div>

                    <!-- Details Panel (overlay absolu) -->
                    <div id="todoDetailsPanel" style="position: absolute; right: 0; top: 0; bottom: 0; width: 0; background: var(--bg-sidebar); border-left: 1px solid var(--border-color); padding: 0; overflow-y: auto; overflow-x: hidden; transition: all 0.3s; box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15); z-index: 100;">
                        <!-- Task details -->
                    </div>
                </div>
            `;

            // Ajouter le modal au body AVANT de rendre les √©l√©ments
            document.body.appendChild(modal);

            renderTodoFilters();
            renderTodoCategories();
            renderTodoMainView();
            
            // D√©marrer la v√©rification des notifications si activ√©es
            if (notificationsEnabled) {
                startNotificationCheck();
            }
            
            // Ajouter styles responsive
            addTodoResponsiveStyles();

            // Mobile UX (sidebar drawer)
            setupTodoMobileSidebar();
            
            // Event listener pour les boutons de navigation Kanban
            setTimeout(() => {
                const kanbanContainer = document.getElementById('kanbanContainer');
                if (kanbanContainer) {
                    kanbanContainer.addEventListener('scroll', updateKanbanNavButtons);
                    if (todoView === 'kanban' && window.innerWidth <= 768) {
                        updateKanbanNavButtons();
                    }
                }
            }, 100);
        }
        
        function addTodoResponsiveStyles() {
            // V√©rifier si les styles existent d√©j√†
            if (document.getElementById('todoResponsiveStyles')) return;
            
            const style = document.createElement('style');
            style.id = 'todoResponsiveStyles';
            style.textContent = `
                /* Responsive mobile pour To-Do AI */

                /* Agent ToDo: mode r√©duit (bulle) */
                #aiAssistantPanel.minimized #aiAssistantPanelContent {
                    width: auto !important;
                    max-height: none !important;
                    background: transparent !important;
                    border: none !important;
                    box-shadow: none !important;
                    overflow: visible !important;
                    touch-action: none;
                }

                #aiAssistantPanel.minimized #aiAssistantPanelHeader {
                    padding: 0 !important;
                    border-bottom: none !important;
                    background: transparent !important;
                    justify-content: flex-end !important;
                }

                #aiAssistantPanel.minimized #aiAssistantPanelTitle {
                    display: none !important;
                }

                #aiAssistantPanel.minimized #aiAssistantCloseBtn {
                    display: none !important;
                }

                #aiAssistantPanel.minimized #aiChatMessages,
                #aiAssistantPanel.minimized #aiAssistantInputArea {
                    display: none !important;
                }

                #aiAssistantPanel.minimized #aiAssistantMinimizeBtn {
                    width: 32px !important;
                    height: 32px !important;
                    padding: 0 !important;
                    border-radius: 999px !important;
                    touch-action: none;
                    cursor: grab;
                    -webkit-tap-highlight-color: transparent;
                    outline: none;
                }

                #aiAssistantPanel.minimized #aiAssistantMinimizeBtn:active {
                    cursor: grabbing;
                }

                #aiAssistantPanel.minimized #aiAssistantMinimizeBtn:focus-visible {
                    outline: 2px solid var(--accent);
                    outline-offset: 2px;
                }

                @media (max-width: 768px) {
                    #todoHeader {
                        padding: 12px 12px !important;
                        flex-wrap: wrap !important;
                        gap: 10px !important;
                    }

                    #todoTitleBlock {
                        margin-right: 0 !important;
                        font-size: 16px !important;
                    }

                    #todoSidebarToggle {
                        display: inline-flex !important;
                        align-items: center;
                        justify-content: center;
                    }

                    #todoHeaderActions {
                        width: 100% !important;
                        flex-wrap: wrap !important;
                        justify-content: flex-end !important;
                        gap: 8px !important;
                    }

                    #todoSearchWrapper {
                        flex: 1 1 180px !important;
                        min-width: 160px !important;
                    }

                    /* Header responsive */
                    #todoSearchInput {
                        width: 100% !important;
                    }
                    
                    #addTaskBtnText {
                        display: none;
                    }
                    
                    #addTaskBtn {
                        padding: 8px !important;
                    }

                    /* Sidebar devient un drawer */
                    #todoSidebar {
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        height: 100vh !important;
                        width: min(280px, 88vw) !important;
                        transform: translateX(-105%);
                        transition: transform 0.25s ease;
                        z-index: 10040 !important;
                        padding-top: 58px !important;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.45);
                    }

                    #todoSidebar.open {
                        transform: translateX(0);
                    }

                    #todoSidebarClose {
                        display: inline-flex !important;
                        align-items: center;
                        justify-content: center;
                    }

                    #todoSidebarBackdrop {
                        position: fixed !important;
                        inset: 0 !important;
                        background: rgba(0, 0, 0, 0.45) !important;
                        z-index: 10030 !important;
                    }

                    /* Details panel fullscreen sur mobile */
                    #todoDetailsPanel {
                        position: fixed !important;
                        top: 0 !important;
                        right: 0 !important;
                        bottom: 0 !important;
                        height: 100vh !important;
                        max-width: 100vw !important;
                        z-index: 10050 !important;
                        box-shadow: none !important;
                    }

                    #todoDetailsBackdrop {
                        position: fixed !important;
                        inset: 0 !important;
                        z-index: 10045 !important;
                    }

                    /* Assistant IA sur mobile: pleine largeur */
                    #aiAssistantPanelContent {
                        left: 12px !important;
                        right: 12px !important;
                        width: auto !important;
                        bottom: 72px !important;
                        max-height: 70vh !important;
                        z-index: 10010 !important; /* laisser le drawer sidebar passer au-dessus */
                    }

                    /* Agent ToDo r√©duit sur mobile: petite bulle en bas √† droite */
                    #aiAssistantPanel.minimized #aiAssistantPanelContent {
                        left: auto !important;
                        right: 12px !important;
                        bottom: 92px !important;
                        z-index: 10010 !important;
                    }

                    /* Quand le drawer sidebar est ouvert, masquer le panneau chat pour √©viter le chevauchement */
                    body.todo-sidebar-open #aiAssistantPanel,
                    body.todo-sidebar-open #aiAssistantPanelContent {
                        display: none !important;
                    }

                    /* Mobile paysage: √©viter que le panneau monte trop haut */
                    @media (orientation: landscape) {
                        #aiAssistantPanelContent {
                            bottom: 12px !important;
                            max-height: calc(100vh - 24px) !important;
                        }

                        #aiAssistantPanel.minimized #aiAssistantPanelContent {
                            bottom: 12px !important;
                        }
                    }
                    
                    /* Conteneur principal sans overflow-y sur mobile */
                    #todoMainArea {
                        overflow-y: auto !important;
                        overflow-x: visible !important;
                        padding: 12px !important;
                    }
                    
                    /* Kanban en scroll horizontal sur mobile */
                    #kanbanContainer {
                        display: flex !important;
                        overflow-x: scroll !important;
                        overflow-y: hidden !important;
                        gap: 12px !important;
                        padding: 8px 4px 20px 4px !important;
                        margin: 0 -12px !important;
                        width: calc(100% + 24px) !important;
                        -webkit-overflow-scrolling: touch;
                        scroll-behavior: smooth;
                    }
                    
                    .kanban-column {
                        min-width: 85vw !important;
                        max-width: 85vw !important;
                        flex-shrink: 0 !important;
                        height: calc(100vh - 160px) !important;
                        margin-left: 4px;
                    }
                    
                    .kanban-column:first-child {
                        margin-left: 12px !important;
                    }
                    
                    .kanban-column:last-child {
                        margin-right: 12px !important;
                    }
                    
                    /* Scrollbar toujours visible sur mobile */
                    #kanbanContainer::-webkit-scrollbar {
                        height: 12px !important;
                        display: block !important;
                    }
                    
                    #kanbanContainer::-webkit-scrollbar-track {
                        background: rgba(30, 41, 59, 0.5) !important;
                        border-radius: 6px !important;
                        margin: 0 12px;
                    }
                    
                    #kanbanContainer::-webkit-scrollbar-thumb {
                        background: #3B82F6 !important;
                        border-radius: 6px !important;
                        border: 2px solid rgba(30, 41, 59, 0.5);
                    }
                    
                    #kanbanContainer::-webkit-scrollbar-thumb:hover {
                        background: #2563EB !important;
                    }
                }
                
                @media (max-width: 480px) {
                    #todoHeaderActions {
                        gap: 8px !important;
                    }

                    #todoHelpBtn {
                        padding: 6px !important;
                    }
                    
                    #todoSearchInput {
                        font-size: 12px !important;
                    }
                    
                    .kanban-column {
                        min-width: 90vw !important;
                        max-width: 90vw !important;
                    }
                    
                    #kanbanContainer::-webkit-scrollbar {
                        height: 10px !important;
                    }
                }
            `;
            document.head.appendChild(style);
            
            // Synchroniser les t√¢ches au chargement
            setTimeout(() => {
                syncTasksFromServer().then(() => {
                    renderTodoMainView();
                });
            }, 500);
        }

        function setupTodoMobileSidebar() {
            const sidebar = document.getElementById('todoSidebar');
            const backdrop = document.getElementById('todoSidebarBackdrop');
            if (!sidebar || !backdrop) return;

            window.toggleTodoSidebar = function(forceOpen) {
                const isMobile = window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
                if (!isMobile) {
                    // Desktop: sidebar toujours visible
                    sidebar.classList.remove('open');
                    backdrop.style.display = 'none';
                    return;
                }

                const shouldOpen = typeof forceOpen === 'boolean' ? forceOpen : !sidebar.classList.contains('open');
                sidebar.classList.toggle('open', shouldOpen);
                backdrop.style.display = shouldOpen ? 'block' : 'none';
                document.body.classList.toggle('todo-sidebar-open', shouldOpen);

                // Sur mobile, fermer le panneau chat pour ne pas g√™ner le drawer
                if (shouldOpen) {
                    try {
                        aiAssistantWasOpenBeforeSidebar = aiAssistantOpen;
                        hideAiAssistantPanel();
                        aiAssistantOpen = false;
                    } catch (_) {}
                } else if (aiAssistantWasOpenBeforeSidebar) {
                    // Rouvrir automatiquement le chat si l'utilisateur l'avait ouvert avant le drawer
                    aiAssistantWasOpenBeforeSidebar = false;
                    aiAssistantOpen = true;
                    showAiAssistantPanel();
                }
            };

            const sync = () => {
                const isMobile = window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
                if (!isMobile) {
                    // Desktop reset
                    sidebar.classList.remove('open');
                    backdrop.style.display = 'none';
                    document.body.classList.remove('todo-sidebar-open');
                    aiAssistantWasOpenBeforeSidebar = false;
                } else {
                    // Mobile: ne pas √©craser l'√©tat (un resize peut arriver pendant l'ouverture)
                    const isOpen = sidebar.classList.contains('open');
                    backdrop.style.display = isOpen ? 'block' : 'none';
                    document.body.classList.toggle('todo-sidebar-open', isOpen);

                    // Si un resize a ferm√© le drawer, restaurer le chat si n√©cessaire
                    if (!isOpen && aiAssistantWasOpenBeforeSidebar) {
                        aiAssistantWasOpenBeforeSidebar = false;
                        aiAssistantOpen = true;
                        showAiAssistantPanel();
                    }
                }
            };

            sync();
            window.addEventListener('resize', sync);
        }

        function closeTodoAi() {
            const overlay = document.getElementById('officeProOverlay');
            if (overlay) {
                overlay.remove();
            }

            // Fermer le modal profil s'il est ouvert (sinon il peut rester affich√©/masqu√©)
            try { closePersonalProfileModal(); } catch (_) {}

            selectedTask = null;
            detailsPanelOpen = false;
            stopNotificationCheck();

            // Fermer le panneau Agent ToDo (sinon il reste sur le chat principal)
            aiAssistantOpen = false;
            aiAssistantMinimized = false;
            aiAssistantWasOpenBeforeSidebar = false;
            hideAiAssistantPanel();
        }

        // Assistant IA Conversationnel
        let aiAssistantOpen = false;
        let aiAssistantMinimized = false;
        let aiAssistantWasOpenBeforeSidebar = false;

        function getTodoUserId() {
            try {
                const email = currentUser?.email;
                return email ? String(email) : 'guest';
            } catch (_) {
                return 'guest';
            }
        }

        function getTodoTasksStorageKey(userId = null) {
            const uid = userId != null ? String(userId) : getTodoUserId();
            return `userTasks:${uid}`;
        }

        function readTodoTasksFromStorage(userId = null) {
            const key = getTodoTasksStorageKey(userId);
            try {
                const rawScoped = localStorage.getItem(key);
                if (rawScoped) {
                    const parsed = JSON.parse(rawScoped);
                    return Array.isArray(parsed) ? parsed : [];
                }
            } catch (_) {
                // ignore
            }

            // Fallback legacy
            try {
                const legacy = JSON.parse(localStorage.getItem('userTasks') || '[]');
                return Array.isArray(legacy) ? legacy : [];
            } catch (_) {
                return [];
            }
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Synchronisation localStorage <-> Serveur
        async function syncTasksToServer() {
            try {
                // Envoyer toutes les t√¢ches localStorage au serveur (REMPLACER compl√®tement)
                const tasks = userTasks.map(task => ({
                    id: task && task.id != null ? String(task.id) : (Date.now().toString() + Math.random().toString(36).substr(2, 9)),
                    title: task.title,
                    description: task.description || '',
                    priority: task.priority || 'medium',
                    deadline: task.dueDate || null,
                    category: task.category || 'personnel',
                    status: task.completed ? 'completed' : (task.inProgress ? 'in-progress' : 'pending'),
                    estimatedTime: task.estimatedTime || null,
                    subtasks: task.subtasks || [],
                    createdAt: task.createdAt || new Date().toISOString(),
                    updatedAt: task.updatedAt || new Date().toISOString()
                }));

                // Synchronisation compl√®te (REMPLACE toutes les t√¢ches serveur)
                const response = await apiFetch('/api/tasks/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tasks: tasks })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Synchronisation termin√©e:', data.taskCount, 't√¢ches');
                } else {
                    console.error('‚ùå Erreur sync serveur:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Erreur sync:', error);
            }
        }

        async function syncTasksFromServer() {
            try {
                const response = await apiFetch('/api/tasks/list');
                const data = await response.json();
                
                if (data.tasks && data.tasks.length > 0) {
                    const toLocal = (serverTask) => ({
                        id: serverTask && serverTask.id != null ? String(serverTask.id) : (Date.now().toString() + Math.random().toString(36).substr(2, 9)),
                        title: serverTask.title,
                        description: serverTask.description || '',
                        priority: serverTask.priority || 'medium',
                        dueDate: serverTask.deadline || serverTask.dueDate || null,
                        category: serverTask.category || 'personnel',
                        completed: serverTask.status === 'completed',
                        inProgress: serverTask.status === 'in-progress',
                        estimatedTime: serverTask.estimatedTime || null,
                        subtasks: serverTask.subtasks || [],
                        createdAt: serverTask.createdAt || new Date().toISOString(),
                        updatedAt: serverTask.updatedAt || new Date().toISOString(),
                        notificationEnabled: true
                    });

                    // Serveur a des t√¢ches - MERGE non destructif avec le local
                    const serverTasks = data.tasks.map(toLocal);
                    const byId = new Map();
                    for (const t of (Array.isArray(userTasks) ? userTasks : [])) {
                        if (!t) continue;
                        byId.set(String(t.id), t);
                    }

                    const parseTs = (v) => {
                        const dt = new Date(String(v || ''));
                        const ms = dt.getTime();
                        return Number.isFinite(ms) ? ms : 0;
                    };

                    let shouldPush = false;

                    for (const st of serverTasks) {
                        const id = String(st.id);
                        const lt = byId.get(id);
                        if (!lt) {
                            byId.set(id, st);
                            continue;
                        }

                        const lts = parseTs(lt.updatedAt || lt.createdAt);
                        const sts = parseTs(st.updatedAt || st.createdAt);

                        if (lts > sts) {
                            // Local plus r√©cent -> conserver local, et pousser ensuite
                            shouldPush = true;
                        } else if (sts > lts) {
                            // Serveur plus r√©cent
                            byId.set(id, { ...lt, ...st });
                        }
                    }

                    // Local-only t√¢ches -> pousser au serveur pour √©viter ‚Äúdisparition‚Äù
                    for (const [id] of byId) {
                        const existsOnServer = serverTasks.some(t => String(t.id) === id);
                        if (!existsOnServer) {
                            shouldPush = true;
                            break;
                        }
                    }

                    userTasks = Array.from(byId.values());
                    saveTasksInternal(true);
                    console.log('‚úÖ T√¢ches synchronis√©es (merge) depuis serveur:', userTasks.length, 't√¢ches');

                    if (shouldPush) {
                        await syncTasksToServer();
                    }
                } else {
                    // Serveur vide - envoyer les t√¢ches locales au serveur
                    if (userTasks.length > 0) {
                        console.log('üì§ Serveur vide, envoi des t√¢ches locales:', userTasks.length);
                        await syncTasksToServer();
                    } else {
                        console.log('‚ÑπÔ∏è Aucune t√¢che locale ni sur serveur');
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur r√©cup√©ration serveur:', error);
                // En cas d'erreur, garder les t√¢ches locales
                console.log('üíæ Conservation des t√¢ches locales:', userTasks.length);
            }
        }

        function toggleAiAssistant() {
            aiAssistantOpen = !aiAssistantOpen;
            if (aiAssistantOpen) {
                aiAssistantMinimized = false;
                // Restaurer l'historique sauvegard√© (auto-sauvegarde)
                try {
                    const userId = typeof getTodoUserId === 'function' ? getTodoUserId() : 'guest';
                    aiChatHistory = loadTodoChatHistory(userId);
                } catch (_) {}
                showAiAssistantPanel();
            } else {
                hideAiAssistantPanel();
            }
        }

        function minimizeAiAssistant() {
            // D√©sactiv√©: bouton de r√©duction supprim√© (UX mobile portrait)
            return;
            const panel = document.getElementById('aiAssistantPanel');
            if (!panel) return;

            panel.classList.toggle('minimized', aiAssistantMinimized);

            const content = document.getElementById('aiAssistantPanelContent');
            if (!content) return;

            const header = document.getElementById('aiAssistantPanelHeader');
            const headerTitle = document.getElementById('aiAssistantPanelTitle');
            const closeBtn = document.getElementById('aiAssistantCloseBtn');
            const messages = document.getElementById('aiChatMessages');
            const inputArea = document.getElementById('aiAssistantInputArea');
            
            if (aiAssistantMinimized) {
                // R√©duire au bouton uniquement
                content.style.width = 'auto';
                // Position g√©r√©e par JS (drag) via left/top
                // IMPORTANT: forcer right/bottom √† auto sinon √ßa colle √† droite (mobile portrait)
                content.style.bottom = 'auto';
                content.style.right = 'auto';
                content.style.left = '';
                content.style.top = '';
                if (header) header.style.minHeight = 'auto';
                if (headerTitle) headerTitle.style.display = 'none';
                if (closeBtn) closeBtn.style.display = 'none';
                if (messages) messages.style.display = 'none';
                if (inputArea) inputArea.style.display = 'none';
                content.style.cursor = 'pointer';
                content.onclick = (e) => {
                    if (e.target.closest('button')) return;
                    minimizeAiAssistant();
                };

                requestAnimationFrame(() => {
                    applySavedAiAssistantMinimizedPosition();
                    enableAiAssistantMinimizedDrag();
                });
            } else {
                // Restaurer
                content.style.width = '380px';
                content.style.bottom = '80px';
                content.style.right = '20px';
                content.style.left = '';
                content.style.top = '';
                if (header) {
                    header.style.padding = '16px 20px';
                    header.style.minHeight = '';
                }
                if (headerTitle) headerTitle.style.display = 'flex';
                if (closeBtn) closeBtn.style.display = 'flex';
                if (messages) messages.style.display = 'flex';
                if (inputArea) inputArea.style.display = 'flex';
                content.style.cursor = 'default';
                content.onclick = null;
            }
        }

        function aiAssistantClamp(value, min, max) {
            return Math.min(Math.max(value, min), max);
        }

        function getAiAssistantMinimizedPositionKey() {
            return 'aiAssistantMinimizedPos';
        }

        function saveAiAssistantMinimizedPosition(pos) {
            try {
                localStorage.setItem(getAiAssistantMinimizedPositionKey(), JSON.stringify(pos));
            } catch (_) {
                // ignore
            }
        }

        function loadAiAssistantMinimizedPosition() {
            try {
                const raw = localStorage.getItem(getAiAssistantMinimizedPositionKey());
                return raw ? JSON.parse(raw) : null;
            } catch (_) {
                return null;
            }
        }

        function setAiAssistantMinimizedPosition(leftPx, topPx) {
            const content = document.getElementById('aiAssistantPanelContent');
            if (!content) return;
            content.style.left = `${Math.round(leftPx)}px`;
            content.style.top = `${Math.round(topPx)}px`;
            // IMPORTANT: must be auto so left/top can control position
            content.style.right = 'auto';
            content.style.bottom = 'auto';
        }

        function applySavedAiAssistantMinimizedPosition() {
            const panel = document.getElementById('aiAssistantPanel');
            const content = document.getElementById('aiAssistantPanelContent');
            if (!panel || !content || !panel.classList.contains('minimized')) return;

            const btn = document.getElementById('aiAssistantMinimizeBtn');
            const btnSize = btn ? Math.max(btn.offsetWidth, btn.offsetHeight, 32) : 32;
            const margin = 12;
            const maxLeft = window.innerWidth - btnSize - margin;
            const maxTop = window.innerHeight - btnSize - margin;

            const saved = loadAiAssistantMinimizedPosition();
            if (saved && typeof saved.left === 'number' && typeof saved.top === 'number') {
                setAiAssistantMinimizedPosition(
                    aiAssistantClamp(saved.left, margin, maxLeft),
                    aiAssistantClamp(saved.top, margin, maxTop)
                );
                return;
            }

            // Default: bottom-right
            setAiAssistantMinimizedPosition(maxLeft, maxTop);
            saveAiAssistantMinimizedPosition({ left: maxLeft, top: maxTop });
        }

        function enableAiAssistantMinimizedDrag() {
            const panel = document.getElementById('aiAssistantPanel');
            const content = document.getElementById('aiAssistantPanelContent');
            const btn = document.getElementById('aiAssistantMinimizeBtn');
            if (!panel || !content || !btn) return;

            if (btn.dataset.dragBound === '1') return;
            btn.dataset.dragBound = '1';

            let dragging = false;
            let moved = false;
            let startX = 0;
            let startY = 0;
            let startLeft = 0;
            let startTop = 0;

            const onPointerMove = (e) => {
                if (!dragging) return;
                if (!panel.classList.contains('minimized')) return;
                e.preventDefault();

                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                if (!moved && (Math.abs(dx) > 3 || Math.abs(dy) > 3)) moved = true;

                const btnSize = Math.max(btn.offsetWidth, btn.offsetHeight, 32);
                const margin = 8;
                const maxLeft = window.innerWidth - btnSize - margin;
                const maxTop = window.innerHeight - btnSize - margin;

                const nextLeft = aiAssistantClamp(startLeft + dx, margin, maxLeft);
                const nextTop = aiAssistantClamp(startTop + dy, margin, maxTop);
                setAiAssistantMinimizedPosition(nextLeft, nextTop);
                saveAiAssistantMinimizedPosition({ left: nextLeft, top: nextTop });
            };

            const onPointerUp = () => {
                dragging = false;
                window.removeEventListener('pointermove', onPointerMove, { capture: true });
                window.removeEventListener('pointerup', onPointerUp, { capture: true });

                if (moved) {
                    btn.dataset.suppressClick = '1';
                    setTimeout(() => {
                        if (btn.dataset.suppressClick === '1') delete btn.dataset.suppressClick;
                    }, 120);
                }
            };

            // Capture click to avoid toggling minimize when drag happened
            btn.addEventListener('click', (e) => {
                if (btn.dataset.suppressClick === '1') {
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
                }
            }, true);

            btn.addEventListener('pointerdown', (e) => {
                if (!panel.classList.contains('minimized')) return;
                if (e.pointerType === 'mouse' && e.button !== 0) return;
                // Important for Android/Chrome: block scroll/back-swipe gestures so horizontal drag works
                if (typeof e.preventDefault === 'function') e.preventDefault();
                dragging = true;
                moved = false;
                startX = e.clientX;
                startY = e.clientY;
                const rect = content.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                btn.setPointerCapture?.(e.pointerId);
                window.addEventListener('pointermove', onPointerMove, { capture: true, passive: false });
                window.addEventListener('pointerup', onPointerUp, { capture: true, passive: true });
            }, { passive: false });
        }

        // Re-clamp position on viewport changes (mobile portrait/landscape)
        let aiAssistantResizeTimeout;
        function ensureAiAssistantPositionInViewport() {
            if (!aiAssistantMinimized) return;
            clearTimeout(aiAssistantResizeTimeout);
            aiAssistantResizeTimeout = setTimeout(() => {
                applySavedAiAssistantMinimizedPosition();
            }, 80);
        }
        window.addEventListener('resize', ensureAiAssistantPositionInViewport);
        window.addEventListener('orientationchange', ensureAiAssistantPositionInViewport);

        function showAiAssistantPanel() {
            // Supprimer panneau existant
            const existingPanel = document.getElementById('aiAssistantPanel');
            if (existingPanel) {
                existingPanel.remove();
            }

            // V√©rifier que les t√¢ches sont pr√™tes
            if (!userTasks || userTasks.length === 0) {
                showToast(t('todo.toast.addTasksFirst'), 'info');
            }
            
            const panel = document.createElement('div');
            panel.id = 'aiAssistantPanel';
            const coachEnabled = isTodoCoachEnabled(typeof getTodoUserId === 'function' ? getTodoUserId() : 'anonymous');
            panel.innerHTML = `
                <div id="aiAssistantPanelContent" style="position: fixed; bottom: 80px; right: 20px; width: 380px; max-height: 500px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); z-index: 20000; display: flex; flex-direction: column; overflow: hidden;">
                    <!-- Header -->
                    <div id="aiAssistantPanelHeader" style="padding: 16px 20px; background: var(--bg-primary); color: var(--text-primary); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color);">
                        <div id="aiAssistantPanelTitle" style="display: flex; align-items: center; gap: 10px;">
                            <div style="display: inline-flex; align-items: center; justify-content: center;">
                                <button id="todoCoachBtn" onclick="toggleTodoCoachMode()" title="${t('todo.aiAssistant.coachMode')}" aria-label="${t('todo.aiAssistant.coachMode')}" style="padding: 8px; background: ${coachEnabled ? 'rgba(59, 130, 246, 0.1)' : 'transparent'}; color: ${coachEnabled ? 'var(--accent)' : 'var(--text-secondary)'}; border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=${coachEnabled ? `'rgba(59, 130, 246, 0.1)'` : `'transparent'`}"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <path d="m5 3-1 5-3 1 3 1 1 5 1-5 3-1-3-1-1-5Z"/>
                                        <path d="m19 3-1 3-3 1 3 1 1 3 1-3 3-1-3-1-1-3Z"/>
                                        <path d="m11 13-1 3-3 1 3 1 1 3 1-3 3-1-3-1-1-3Z"/>
                                    </svg></button>
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 15px; letter-spacing: -0.01em;">Agent ToDo</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">${t('todo.aiAssistant.subtitle')}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button id="aiAssistantDeleteBtn" onclick="clearTodoChatHistory()" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 6px; cursor: pointer; padding: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-secondary)'" title="${t('todo.aiAssistant.deleteChat')}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                                    <path d="M10 11v6"/>
                                    <path d="M14 11v6"/>
                                    <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
                                </svg>
                            </button>
                            <button id="aiAssistantCloseBtn" onclick="toggleAiAssistant()" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 6px; cursor: pointer; padding: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-secondary)'" title="${t('todo.aiAssistant.close')}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Conversation -->
                    <div id="aiChatMessages" style="flex: 1; padding: 16px; overflow-y: auto; max-height: 300px; background: var(--bg-primary); display: flex; flex-direction: column;">
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">
                            <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 4px;">${t('todo.aiAssistant.helpTitle')}</div>
                            <div style="font-size: 11px; margin-top: 8px; color: var(--text-secondary);">${t('todo.aiAssistant.helpSubtitle')}</div>
                        </div>
                    </div>

                    <!-- Input -->
                    <div id="aiAssistantInputArea" style="padding: 12px; border-top: 1px solid var(--border-color); display: flex; gap: 8px;">
                        <input id="aiCommandInput" type="text" placeholder="${t('todo.aiAssistant.placeholder')}" onkeypress="if(event.key==='Enter') askAi(this.value)" style="flex: 1; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); font-size: 13px; outline: none; color: var(--text-primary); transition: all 0.2s;" onfocus="this.style.borderColor='var(--text-secondary)'" onblur="this.style.borderColor='var(--border-color)'">
                        <button onclick="askAi(document.getElementById('aiCommandInput').value)" style="padding: 10px 14px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(panel);

            try {
                const messagesContainer = document.getElementById('aiChatMessages');
                if (messagesContainer) messagesContainer.dataset.empty = '1';
            } catch (_) {}

            // Restaurer et afficher l'historique si pr√©sent
            try {
                const messagesContainer = document.getElementById('aiChatMessages');
                if (messagesContainer) {
                    renderTodoChatHistory(messagesContainer);
                }
            } catch (_) {}

            // Si d√©j√† en mode r√©duit, appliquer position & activer drag
            if (aiAssistantMinimized) {
                panel.classList.add('minimized');
                requestAnimationFrame(() => {
                    applySavedAiAssistantMinimizedPosition();
                    enableAiAssistantMinimizedDrag();
                });
            }
        }

        function hideAiAssistantPanel() {
            const panel = document.getElementById('aiAssistantPanel');
            if (panel) panel.remove();
        }

        function getTodoChatHistoryStorageKey(userId) {
            return `aiTaskTodoChatHistory:${String(userId || 'guest')}`;
        }

        function loadTodoChatHistory(userId) {
            try {
                const raw = localStorage.getItem(getTodoChatHistoryStorageKey(userId));
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                const items = Array.isArray(parsed) ? parsed : [];
                return items
                    .filter(m => m && (m.role === 'user' || m.role === 'assistant') && typeof m.content === 'string')
                    .slice(-20);
            } catch (_) {
                return [];
            }
        }

        function saveTodoChatHistory(userId, history) {
            try {
                localStorage.setItem(getTodoChatHistoryStorageKey(userId), JSON.stringify(Array.isArray(history) ? history.slice(-20) : []));
            } catch (_) {
                // ignore
            }
        }

        function renderTodoChatHistory(messagesContainer) {
            const userId = typeof getTodoUserId === 'function' ? getTodoUserId() : 'guest';
            if (!Array.isArray(aiChatHistory) || aiChatHistory.length === 0) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">
                        <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 4px;">${t('todo.aiAssistant.helpTitle')}</div>
                        <div style="font-size: 11px; margin-top: 8px; color: var(--text-secondary);">${t('todo.aiAssistant.helpSubtitle')}</div>
                    </div>
                `;
                try { messagesContainer.dataset.empty = '1'; } catch (_) {}
                saveTodoChatHistory(userId, []);
                return;
            }

            try { messagesContainer.dataset.empty = '0'; } catch (_) {}

            messagesContainer.innerHTML = '';
            aiChatHistory.slice(-20).forEach(m => {
                const role = m.role === 'assistant' ? 'assistant' : 'user';
                const safe = escapeHtml(String(m.content || '')).replace(/\n/g, '<br>');
                const wrap = document.createElement('div');
                wrap.style.cssText = role === 'user' ? 'margin-bottom: 12px; text-align: right;' : 'margin-bottom: 12px;';
                wrap.innerHTML = role === 'user'
                    ? `<div style="display: inline-block; background: var(--bg-secondary); color: var(--text-primary); padding: 10px 14px; border-radius: 12px 12px 4px 12px; max-width: 80%; font-size: 13px; border: 1px solid var(--border-color);">${safe}</div>`
                    : `<div style="display: inline-block; background: var(--bg-secondary); color: var(--text-primary); padding: 10px 14px; border-radius: 12px 12px 12px 4px; max-width: 80%; font-size: 13px; line-height: 1.5; border: 1px solid var(--border-color);">${safe}</div>`;
                messagesContainer.appendChild(wrap);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            saveTodoChatHistory(userId, aiChatHistory);
        }

        function clearTodoChatHistory() {
            const userId = typeof getTodoUserId === 'function' ? getTodoUserId() : 'guest';
            aiChatHistory = [];
            saveTodoChatHistory(userId, []);
            const messagesContainer = document.getElementById('aiChatMessages');
            if (messagesContainer) {
                renderTodoChatHistory(messagesContainer);
            }
        }

        function getTodoCoachStorageKey(userId) {
            return `aiTaskTodoCoachEnabled:${String(userId || 'anonymous')}`;
        }

        function isTodoCoachEnabled(userId) {
            try {
                return localStorage.getItem(getTodoCoachStorageKey(userId)) === 'true';
            } catch (_) {
                return false;
            }
        }

        function setTodoCoachEnabled(userId, enabled) {
            try {
                localStorage.setItem(getTodoCoachStorageKey(userId), enabled ? 'true' : 'false');
            } catch (_) {}
        }

        function syncTodoCoachUi() {
            const userId = typeof getTodoUserId === 'function' ? getTodoUserId() : 'anonymous';
            const enabled = isTodoCoachEnabled(userId);
            const btn = document.getElementById('todoCoachBtn');
            if (btn) {
                btn.style.background = enabled ? 'rgba(59, 130, 246, 0.1)' : 'transparent';
                btn.style.color = enabled ? 'var(--accent)' : 'var(--text-secondary)';
                btn.dataset.enabled = enabled ? '1' : '0';
            }
        }

        async function toggleTodoCoachMode() {
            const userId = typeof getTodoUserId === 'function' ? getTodoUserId() : 'anonymous';
            const next = !isTodoCoachEnabled(userId);
            setTodoCoachEnabled(userId, next);
            syncTodoCoachUi();

            // D√©clencher une premi√®re r√©ponse coach quand on active
            if (next) {
                try {
                    const prompt = (typeof t === 'function' ? t('todo.aiAssistant.coachPromptOnEnable') : null)
                        || "Donne-moi un conseil rapide pour aujourd'hui.";
                    await askAi(prompt);
                } catch (_) {}
            }
        }

        async function askAi(command) {
            if (!command || !command.trim()) return;

            const safeCommand = escapeHtml(command);

            const input = document.getElementById('aiCommandInput');
            if (input) input.value = '';

            const messagesContainer = document.getElementById('aiChatMessages');
            if (!messagesContainer) return;

            // Effacer l'√©tat vide
            try {
                if (messagesContainer.dataset.empty === '1') {
                    messagesContainer.innerHTML = '';
                    messagesContainer.dataset.empty = '0';
                }
            } catch (_) {}

            // Message utilisateur
            const userMsg = document.createElement('div');
            userMsg.style.cssText = 'margin-bottom: 12px; text-align: right;';
            userMsg.innerHTML = `<div style="display: inline-block; background: var(--bg-secondary); color: var(--text-primary); padding: 10px 14px; border-radius: 12px 12px 4px 12px; max-width: 80%; font-size: 13px; border: 1px solid var(--border-color);">${safeCommand}</div>`;
            messagesContainer.appendChild(userMsg);

            const userId = getTodoUserId();

            // Ajouter √† l'historique (auto-sauvegarde)
            aiChatHistory.push({
                role: 'user',
                content: command
            });

            // Limiter l'historique aux 20 derniers messages (10 √©changes)
            if (aiChatHistory.length > 20) {
                aiChatHistory = aiChatHistory.slice(-20);
            }

            saveTodoChatHistory(userId, aiChatHistory);

            // Message loading
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'aiLoadingMsg';
            loadingMsg.style.cssText = 'margin-bottom: 12px;';
            loadingMsg.innerHTML = `<div style="display: inline-block; background: var(--bg-secondary); color: var(--text-secondary); padding: 10px 14px; border-radius: 12px 12px 12px 4px; font-size: 13px; border: 1px solid var(--border-color);">
                <span style="animation: pulse 1.5s infinite;">${t('todo.aiAssistant.sending')}</span>
            </div>`;
            messagesContainer.appendChild(loadingMsg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                const normalized = command.toLowerCase();

                const coachEnabled = isTodoCoachEnabled(userId);

                function tpl(template, values) {
                    let out = String(template || '');
                    if (!values) return out;
                    Object.keys(values).forEach(k => {
                        out = out.split(`{${k}}`).join(String(values[k]));
                    });
                    return out;
                }

                function buildTodoHistoryExcerpt(history, { maxMessages = 8, maxChars = 900 } = {}) {
                    const items = Array.isArray(history) ? history.slice(-maxMessages) : [];
                    const lines = items
                        .map(m => {
                            const role = (m && m.role) === 'assistant' ? 'A' : 'U';
                            const content = String(m && m.content ? m.content : '').replace(/\s+/g, ' ').trim();
                            return `${role}: ${content}`;
                        })
                        .filter(Boolean);
                    let text = lines.join('\n');
                    if (text.length > maxChars) text = text.slice(text.length - maxChars);
                    return text;
                }

                // Commandes rapides (sans LLM)
                const isPrioritize = /(\bpriori|\bpriorise|\bprioriser|\bpriorit√©|\bprioritiz|\bpriority)/i.test(normalized);
                const isSchedule = /(\bplanifie|\bplanifier|\bschedule|\bplanning)/i.test(normalized);
                const isSummary = /(\br√©sume|\bresume|\br√©cap|\brecap|\bsummary)/i.test(normalized);
                const isProductivity = /(\bproductiv|\bstats|\bm√©triques|\bmetriques|\bperformance)/i.test(normalized);
                const isCoach = /(\bcoach|\bconseil|\bconseiller|\bbien[-\s]?etre|\blife)/i.test(normalized);

                // Laisser TOUTES les commandes d'action (CRUD/√©dition/d√©placement/compl√©tion) passer sur smart-command
                // m√™me si le mode Coach est activ√© et/ou si le message contient "coach".
                const isSlashCommand = /^\s*\//.test(command);
                const taskOperationRe = new RegExp(
                    '(?:' +
                    // Ajout / cr√©ation
                    '\\bajoute(?:r|z)?\\b|\\bajouter\\b|\\brajoute(?:r|z)?\\b|\\brajouter\\b|' +
                    '\\bcr[e√©]e(?:r|z)?\\b|\\bcr[e√©]er\\b|\\bcree(?:r|z)?\\b|\\bcreer\\b|' +
                    // Suppression
                    '\\bsupprime(?:r|z)?\\b|\\bsupprimer\\b|\\befface(?:r|z)?\\b|\\beffacer\\b|' +
                    '\\benl[e√®]ve(?:r|z)?\\b|\\benlever\\b|\\bretire(?:r|z)?\\b|\\bretirer\\b|' +
                    // Modification
                    '\\bmodifie(?:r|z)?\\b|\\bmodifier\\b|\\bchange(?:r|z)?\\b|\\bchanger\\b|\\bupdate\\b|\\bedit\\b|\\b(?:[e√©])dite(?:r|z)?\\b|' +
                    // D√©placement / replanification
                    '\\bd[e√©]place(?:r|z)?\\b|\\bd[e√©]placer\\b|\\breporte(?:r|z)?\\b|\\breporter\\b|\\b(?:re)?planifie(?:r|z)?\\b|\\b(?:re)?planifier\\b|' +
                    // Statut / cl√¥ture
                    '\\bmarque(?:r|z)?\\b|\\bmarquer\\b|\\btermine(?:r|z)?\\b|\\bterminer\\b|\\bcompl[e√©]te(?:r|z)?\\b|\\bcompl[e√©]ter\\b|' +
                    '\\bdone\\b|\\bclose\\b|\\bcl[o√¥]ture(?:r|z)?\\b|\\bcl[o√¥]turer\\b|' +
                    // Anglais
                    '\\bdelete\\b' +
                    ')',
                    'i'
                );
                const isTaskOperation = isSlashCommand || taskOperationRe.test(normalized);

                const shouldUseCoach = (!isTaskOperation) && (isCoach || (coachEnabled && !isPrioritize && !isSchedule && !isSummary && !isProductivity));

                if (isPrioritize || isSchedule || isSummary || isProductivity || shouldUseCoach) {
                    await syncTasksToServer();

                    const requestLang = getAppLanguage();

                                        let endpoint = 'summary';
                    let method = 'GET';
                    let body = null;

                    if (isPrioritize) {
                        endpoint = 'prioritize';
                        method = 'POST';
                        body = { userId, tasks: userTasks };
                    } else if (isSchedule) {
                        endpoint = 'schedule';
                        method = 'POST';
                        body = { userId, tasks: userTasks, events: userEvents || [], preferences: { days: 5, workBlocks: [[9, 12], [14, 17]] } };
                    } else if (shouldUseCoach) {
                        const profile = getPersonalProfile(userId);
                        endpoint = 'coach';
                        method = 'POST';
                        const historyExcerpt = buildTodoHistoryExcerpt(aiChatHistory);
                        body = {
                            userId,
                            message: command,
                            historyExcerpt,
                            coachMode: coachEnabled ? 'llm' : 'heuristic',
                            ...(profile.age ? { age: profile.age } : {}),
                            ...(profile.sex ? { sex: profile.sex } : {}),
                            ...(profile.focusHours ? { focusHours: profile.focusHours } : {})
                        };
                    } else if (isProductivity) {
                        const profile = getPersonalProfile(userId);
                        const qp = new URLSearchParams();
                        qp.set('lang', requestLang);
                        if (profile.age) qp.set('age', String(profile.age));
                        if (profile.sex) qp.set('sex', String(profile.sex));
                        if (profile.focusHours) qp.set('focusHours', String(profile.focusHours));
                        endpoint = `productivity?${qp.toString()}`;
                        method = 'GET';
                    } else if (isSummary) {
                        endpoint = `summary?lang=${encodeURIComponent(requestLang)}`;
                        method = 'GET';
                    }

                    const resp = await apiFetch(`/api/tasks/${endpoint}`, {
                        method,
                        headers: Object.assign(
                            { 'X-Language': requestLang },
                            method === 'POST' ? { 'Content-Type': 'application/json' } : {}
                        ),
                        body: method === 'POST' ? JSON.stringify(Object.assign({ lang: requestLang }, body || {})) : undefined
                    });

                    if (!resp.ok) {
                        throw new Error(tpl(t('todo.smart.error.server'), { status: resp.status, statusText: resp.statusText }));
                    }

                    const data = await resp.json();
                    loadingMsg.remove();

                    let text = 'OK';
                    if (isPrioritize) {
                        const top = Array.isArray(data.prioritized) ? data.prioritized.slice(0, 7) : [];
                        const lines = top.map((t, i) => {
                            const due = t.deadline ? tpl(t('todo.smart.dueDate'), { date: new Date(t.deadline).toLocaleString(getLocale()) }) : '';
                            return `${i + 1}. ${t.title}${due}`;
                        });
                        const extra = data.insights?.overload ? tpl(t('todo.smart.overloadWarning'), { hours: data.insights.next24Hours }) : '';
                        text = (lines.length ? `${t('todo.smart.prioritiesHeader')}\n${lines.join('\n')}` : t('todo.smart.noTasksToPrioritize')) + extra;
                    } else if (isSchedule) {
                        const blocks = Array.isArray(data.schedule) ? data.schedule.slice(0, 8) : [];
                        const lines = blocks.map(b => {
                            const s = new Date(b.start).toLocaleString(getLocale());
                            const e = new Date(b.end).toLocaleTimeString(getLocale());
                            return `- ${s} ‚Üí ${e} : ${b.title}`;
                        });
                        text = blocks.length
                            ? `${t('todo.smart.scheduleHeader')}\n${lines.join('\n')}`
                            : t('todo.smart.scheduleNoSlots');
                    } else if (shouldUseCoach) {
                        const coachText = data.response || t('todo.smart.coachUnavailable');
                        const work = Array.isArray(data.advice?.work) ? data.advice.work.slice(0, 4) : [];
                        const personal = Array.isArray(data.advice?.personal) ? data.advice.personal.slice(0, 3) : [];
                        const parts = [coachText];
                        if (work.length) parts.push(`\n${t('todo.smart.coachWorkLabel')}\n- ${work.join('\n- ')}`);
                        if (personal.length) parts.push(`\n${t('todo.smart.coachPersonalLabel')}\n- ${personal.join('\n- ')}`);
                        text = parts.join('\n');
                    } else if (isProductivity) {
                        const m = data.metrics || {};
                        text = tpl(t('todo.smart.productivitySummary'), {
                            completed: m.completed || 0,
                            pending: m.pending || 0,
                            overdue: m.overdue || 0,
                            streak: m.streakDays || 0,
                            hours: m.pendingEstimatedHours || 0
                        });
                    } else if (isSummary) {
                        const next = Array.isArray(data.topNext) ? data.topNext : [];
                        const lines = next.map((t, i) => `${i + 1}. ${t.title} ‚Äî ${t.reason}`);
                        const extra = data.insights?.overload ? tpl(t('todo.smart.overloadWarningInline'), { hours: data.insights.next24Hours }) : '';
                        text = `${data.response || t('todo.smart.summaryFallback')}${lines.length ? `\n\n${t('todo.smart.nextStepsTitle')}:\n${lines.join('\n')}` : ''}${extra}`;
                    }

                    const aiMsg = document.createElement('div');
                    aiMsg.style.cssText = 'margin-bottom: 12px;';
                    aiMsg.innerHTML = `<div style="display: inline-block; background: var(--bg-secondary); color: var(--text-primary); padding: 10px 14px; border-radius: 12px 12px 12px 4px; max-width: 80%; font-size: 13px; line-height: 1.5; border: 1px solid var(--border-color);">${escapeHtml(text).replace(/\n/g, '<br>')}</div>`;
                    messagesContainer.appendChild(aiMsg);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    aiChatHistory.push({ role: 'assistant', content: String(text || '') });
                    if (aiChatHistory.length > 20) aiChatHistory = aiChatHistory.slice(-20);
                    saveTodoChatHistory(userId, aiChatHistory);
                    return;
                }

                // Synchroniser les t√¢ches localStorage vers serveur avant commande
                await syncTasksToServer();

                const response = await apiFetch('/api/tasks/smart-command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Language': getAppLanguage() },
                    body: JSON.stringify({ 
                        command: command,
                        history: aiChatHistory,
                        lang: getAppLanguage()
                    })
                });

                // V√©rifier si la r√©ponse est OK
                if (!response.ok) {
                    throw new Error(tpl(t('todo.smart.error.server'), { status: response.status, statusText: response.statusText }));
                }

                // R√©cup√©rer le texte brut pour debug
                const responseText = await response.text();
                console.log('Response from server:', responseText);

                // Parser le JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error(t('todo.smart.error.invalidResponse'));
                }

                loadingMsg.remove();

                if (data.error) {
                    const errorMsg = document.createElement('div');
                    errorMsg.style.cssText = 'margin-bottom: 12px;';
                    errorMsg.innerHTML = `<div style="display: inline-block; background: #FEE2E2; color: #DC2626; padding: 10px 14px; border-radius: 12px 12px 12px 4px; max-width: 80%; font-size: 13px;">‚ùå ${escapeHtml(data.error)}</div>`;
                    messagesContainer.appendChild(errorMsg);
                } else {
                    // R√©ponse IA
                    const aiMsg = document.createElement('div');
                    aiMsg.style.cssText = 'margin-bottom: 12px;';

                    const safeResponse = escapeHtml(data.response || '').replace(/\n/g, '<br>');
                    
                    let responseHtml = `<div style="display: inline-block; background: var(--bg-secondary); color: var(--text-primary); padding: 10px 14px; border-radius: 12px 12px 12px 4px; max-width: 80%; font-size: 13px; line-height: 1.5; border: 1px solid var(--border-color);">
                        ${safeResponse}
                    `;

                    // Afficher suggestions
                    if (data.suggestions && data.suggestions.length > 0) {
                        responseHtml += `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">`;
                        responseHtml += `<div style="font-weight: 600; font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">${escapeHtml(t('todo.smart.suggestionsTitle'))}</div>`;
                        data.suggestions.slice(0, 3).forEach((s, i) => {
                            const task = userTasks.find(t => t.id === s.taskId);
                            if (task) {
                                responseHtml += `<div style="font-size: 12px; margin-bottom: 4px; color: var(--text-primary);">${i+1}. ${escapeHtml(task.title)} <span style="color: var(--text-secondary); font-size: 11px;">(${escapeHtml(s.reason)})</span></div>`;
                            }
                        });
                        responseHtml += `</div>`;
                    }

                    // Afficher insights
                    if (data.insights && Object.keys(data.insights).length > 0) {
                        responseHtml += `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); font-size: 11px; color: var(--text-secondary); display: flex; gap: 8px; flex-wrap: wrap;">`;
                        if (data.insights.urgent) responseHtml += `<span style="background: #FEE2E2; color: #DC2626; padding: 2px 8px; border-radius: 6px; font-weight: 500;">${escapeHtml(tpl(t('todo.smart.insightUrgent'), { count: data.insights.urgent }))}</span>`;
                        if (data.insights.today) responseHtml += `<span style="background: #DBEAFE; color: #3B82F6; padding: 2px 8px; border-radius: 6px; font-weight: 500;">${escapeHtml(tpl(t('todo.smart.insightToday'), { count: data.insights.today }))}</span>`;
                        responseHtml += `</div>`;
                    }

                    responseHtml += `</div>`;
                    aiMsg.innerHTML = responseHtml;
                    messagesContainer.appendChild(aiMsg);

                    // Ajouter la r√©ponse de l'assistant √† l'historique
                    aiChatHistory.push({
                        role: 'assistant',
                        content: data.response
                    });

                    if (aiChatHistory.length > 20) {
                        aiChatHistory = aiChatHistory.slice(-20);
                    }
                    saveTodoChatHistory(userId, aiChatHistory);

                    // Si modifications, recharger les t√¢ches
                    if (data.tasksModified > 0) {
                        let message = '';
                        const actions = [];
                        
                        if (data.created && data.created.length > 0) {
                            actions.push(tpl(t('todo.smart.toast.created'), { count: data.created.length }));
                        }
                        if (data.changes && data.changes.length > 0) {
                            actions.push(tpl(t('todo.smart.toast.updated'), { count: data.changes.length }));
                        }
                        if (data.deleted && data.deleted.length > 0) {
                            actions.push(tpl(t('todo.smart.toast.deleted'), { count: data.deleted.length }));
                        }
                        
                        message = `${t('todo.smart.toast.tasksPrefix')} ${actions.join(', ')}`;
                        showToast(message, 'success');
                        
                        // Synchroniser les modifications depuis le serveur
                        await syncTasksFromServer();
                        renderTodoMainView();
                    }
                }

                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (error) {
                loadingMsg.remove();
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = 'margin-bottom: 12px;';
                errorMsg.innerHTML = `<div style="display: inline-block; background: #FEE2E2; color: #DC2626; padding: 10px 14px; border-radius: 12px 12px 12px 4px; max-width: 80%; font-size: 13px; border: 1px solid #FCA5A5;">${escapeHtml(t('todo.smart.error.genericPrefix'))}${escapeHtml(error.message)}</div>`;
                messagesContainer.appendChild(errorMsg);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Syst√®me de notifications
        async function toggleNotifications() {
            if (!notificationsEnabled) {
                // Demander la permission
                if (!('Notification' in window)) {
                    showToast(t('todo.toast.notificationsNotSupported'), 'error');
                    return;
                }
                
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    notificationsEnabled = true;
                    localStorage.setItem('todoNotificationsEnabled', 'true');
                    showToast(t('todo.toast.notificationsEnabled'), 'success');
                    startNotificationCheck();
                    updateNotificationButton();
                } else {
                    showToast(t('todo.toast.permissionDenied'), 'error');
                }
            } else {
                notificationsEnabled = false;
                localStorage.setItem('todoNotificationsEnabled', 'false');
                showToast(t('todo.toast.notificationsDisabled'), 'info');
                stopNotificationCheck();
                updateNotificationButton();
            }
        }

        function updateNotificationButton() {
            const btn = document.getElementById('notificationToggle');
            if (btn) {
                btn.style.background = notificationsEnabled ? 'rgba(59, 130, 246, 0.1)' : 'transparent';
                btn.style.color = notificationsEnabled ? 'var(--accent)' : 'var(--text-secondary)';
                btn.title = notificationsEnabled ? t('todo.notificationsEnabled') : t('todo.notificationsEnable');
            }
        }

        function toggleTaskNotification(taskId, enabled) {
            const id = String(taskId);
            
            console.log('üîî toggleTaskNotification appel√©:', {
                taskIdOriginal: taskId,
                taskIdType: typeof taskId,
                idConverted: id,
                enabled: enabled,
                userTasksLength: userTasks.length
            });
            
            const task = userTasks.find(t => String(t.id) === id);
            
            console.log('üîç T√¢che trouv√©e:', task ? {
                id: task.id,
                title: task.title,
                notifyEnabledAvant: task.notifyEnabled
            } : 'AUCUNE T√ÇCHE TROUV√âE');
            
            if (task) {
                task.notifyEnabled = enabled;
                task.notificationEnabled = enabled;
                
                console.log('‚úÖ T√¢che mise √† jour:', {
                    id: task.id,
                    notifyEnabledApres: task.notifyEnabled
                });
                
                // Sauvegarder imm√©diatement
                saveTasks();
                console.log('üíæ Sauvegard√© dans localStorage');
                
                // V√©rifier la sauvegarde
                const saved = JSON.parse(localStorage.getItem(getTodoTasksStorageKey()) || '[]');
                const savedTask = saved.find(t => t.id === id);
                console.log('‚úì V√©rification localStorage:', savedTask ? {
                    id: savedTask.id,
                    notifyEnabled: savedTask.notifyEnabled
                } : 'T√ÇCHE NON TROUV√âE DANS localStorage');
                
                // Mettre √† jour selectedTask si c'est la t√¢che actuelle
                if (selectedTask && String(selectedTask.id) === id) {
                    selectedTask.notifyEnabled = enabled;
                    selectedTask.notificationEnabled = enabled;
                }
                
                showToast(enabled ? t('todo.toast.taskNotificationEnabledForTask') : t('todo.toast.taskNotificationDisabled'), 'info');
                
                // D√©marrer la v√©rification des notifications si activ√©
                if (enabled) {
                    if (!notificationsEnabled) {
                        // Auto-activer les notifications globales
                        requestNotificationPermission().then(granted => {
                            if (granted) {
                                startNotificationCheck();
                                setTimeout(() => {
                                    showToast(t('todo.toast.notificationsEnabled'), 'success');
                                }, 500);
                            } else {
                                setTimeout(() => {
                                    showToast(t('todo.toast.enableBrowserNotifications'), 'info');
                                }, 500);
                            }
                        });
                    } else {
                        // V√©rifier imm√©diatement cette t√¢che
                        checkTaskNotifications();
                    }
                }
                
                // Ne pas rafra√Æchir le panneau pour √©viter de perdre le focus
                // Le checkbox est d√©j√† mis √† jour par le onChange du HTML
            }
        }

        // Fonction sp√©ciale pour les notifications des t√¢ches cr√©√©es par l'agent (avec IDs string)
        function toggleTaskNotificationAgent(taskId, enabled) {
            console.log('ü§ñ toggleTaskNotificationAgent appel√© pour ID:', taskId, 'Type:', typeof taskId);
            
            // Chercher la t√¢che par ID exact (string ou number)
            let task = userTasks.find(t => t.id === taskId || String(t.id) === String(taskId));
            
            console.log('üîç T√¢che agent trouv√©e:', task ? {
                id: task.id,
                title: task.title,
                notifyEnabledAvant: task.notifyEnabled
            } : 'AUCUNE T√ÇCHE TROUV√âE');
            
            if (task) {
                task.notifyEnabled = enabled;
                task.notificationEnabled = enabled;
                
                console.log('‚úÖ T√¢che agent mise √† jour:', {
                    id: task.id,
                    notifyEnabledApres: task.notifyEnabled
                });
                
                // Sauvegarder imm√©diatement
                saveTasks();
                console.log('üíæ Sauvegard√© dans localStorage');
                
                // Mettre √† jour selectedTask
                if (selectedTask && (selectedTask.id === taskId || String(selectedTask.id) === String(taskId))) {
                    selectedTask.notifyEnabled = enabled;
                    selectedTask.notificationEnabled = enabled;
                }
                
                showToast(enabled ? t('todo.toast.taskNotificationEnabled') : t('todo.toast.taskNotificationDisabled'), 'info');
                
                // Auto-activer les notifications globales si n√©cessaire
                if (enabled && !notificationsEnabled) {
                    requestNotificationPermission().then(granted => {
                        if (granted) {
                            startNotificationCheck();
                            setTimeout(() => showToast(t('todo.toast.notificationsEnabled'), 'success'), 500);
                        }
                    });
                } else if (enabled) {
                    checkTaskNotifications();
                }
            } else {
                console.error('‚ùå Impossible de trouver la t√¢che agent avec ID:', taskId);
            }
        }

        // Mettre √† jour le temps de notification personnalis√©
        function updateTaskNotificationTime(taskId, minutes) {
            minutes = parseInt(minutes);
            console.log('‚è∞ Mise √† jour temps notification:', taskId, '‚Üí', minutes, 'minutes');
            
            // Chercher la t√¢che (g√©rer les IDs string et number)
            let task = userTasks.find(t => t.id === taskId || String(t.id) === String(taskId));
            
            if (task) {
                task.notifyMinutes = minutes;
                saveTasks();
                
                // Mettre √† jour selectedTask
                if (selectedTask && (selectedTask.id === taskId || String(selectedTask.id) === String(taskId))) {
                    selectedTask.notifyMinutes = minutes;
                }
                
                const when = minutes >= 60
                    ? ((minutes / 60) + 'h')
                    : (minutes + ' min');
                showToast(String(t('todo.toast.notificationTimeUpdated') || '').replace('{when}', when), 'success');
                console.log('‚úÖ Temps de notification mis √† jour:', minutes, 'minutes');
            }
        }

        function startNotificationCheck() {
            if (notificationCheckInterval) return;
            
            // V√©rifier toutes les minutes
            notificationCheckInterval = setInterval(() => {
                checkTaskNotifications();
            }, 60000); // 1 minute
            
            // V√©rification imm√©diate
            checkTaskNotifications();
        }

        function stopNotificationCheck() {
            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
                notificationCheckInterval = null;
            }
        }

        function checkTaskNotifications() {
            if (!notificationsEnabled) return;
            
            const now = new Date();
            const notifiedTasks = JSON.parse(localStorage.getItem('notifiedTasks') || '[]');
            
            userTasks.forEach(task => {
                if (!task.dueDate || task.completed || !task.notifyEnabled) return;
                if (notifiedTasks.includes(task.id)) return; // D√©j√† notifi√©
                
                const dueDate = new Date(task.dueDate);
                const timeDiff = dueDate - now;
                const minutesDiff = Math.floor(timeDiff / 60000);
                
                // Notifier 15 minutes avant
                if (minutesDiff <= 15 && minutesDiff >= 0) {
                    sendTaskNotification(task);
                    notifiedTasks.push(task.id);
                    localStorage.setItem('notifiedTasks', JSON.stringify(notifiedTasks));
                }
            });
        }

        function sendTaskNotification(task) {
            if (!('Notification' in window) || Notification.permission !== 'granted') return;
            
            const priorityEmoji = task.priority === 'high' ? 'üî¥' : task.priority === 'medium' ? 'üü°' : 'üîµ';
            const timeStr = new Date(task.dueDate).toLocaleTimeString(getLocale(), { hour: '2-digit', minute: '2-digit' });

            const title = `${priorityEmoji} ${t('todo.notification.upcomingTitle')}`;
            const body = String(t('todo.notification.upcomingBody') || '')
                .replace('{title}', task.title)
                .replace('{time}', timeStr);
            
            const notification = new Notification(title, {
                body,
                icon: '/favicon.ico',
                badge: '/favicon.ico',
                tag: `task-${task.id}`,
                requireInteraction: false,
                silent: false
            });
            
            notification.onclick = function() {
                window.focus();
                showTaskDetails(task.id);
                notification.close();
            };
            
            // Auto-close apr√®s 10 secondes
            setTimeout(() => notification.close(), 10000);
        }

        function renderTodoFilters() {
            const filters = document.getElementById('todoFilters');
            const activeTasks = userTasks.filter(t => !t.completed);
            const todayTasks = activeTasks.filter(t => {
                if (!t.dueDate) return false;
                const today = new Date().toDateString();
                return new Date(t.dueDate).toDateString() === today;
            });
            const weekTasks = activeTasks.filter(t => {
                if (!t.dueDate) return false;
                const weekFromNow = new Date();
                weekFromNow.setDate(weekFromNow.getDate() + 7);
                return new Date(t.dueDate) <= weekFromNow;
            });
            const priorityTasks = activeTasks.filter(t => t.priority === 'high');

            const isActive = (filter) => todoFilter === filter;
            filters.innerHTML = `
                <div style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 8px; color: var(--text-secondary); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px;">${t('todo.filtersTitle')}</h3>
                    <button onclick="switchTodoFilter('all')" class="sidebar-btn" style="width: 100%; padding: 8px 12px; text-align: left; border: none; background: ${isActive('all') ? 'rgba(59, 130, 246, 0.1)' : 'transparent'}; color: ${isActive('all') ? 'var(--accent)' : 'var(--text-primary)'}; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; transition: all 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                        </svg>
                        ${t('todo.filter.all')}
                        <span style="margin-left: auto; background: ${isActive('all') ? 'rgba(59, 130, 246, 0.15)' : 'var(--bg-secondary)'}; color: ${isActive('all') ? 'var(--accent)' : 'var(--text-secondary)'}; padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">${activeTasks.length}</span>
                    </button>
                    <button onclick="switchTodoFilter('today')" class="sidebar-btn" style="width: 100%; padding: 8px 12px; text-align: left; border: none; background: ${isActive('today') ? 'rgba(59, 130, 246, 0.1)' : 'transparent'}; color: ${isActive('today') ? 'var(--accent)' : 'var(--text-primary)'}; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; transition: all 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                        ${t('todo.filter.today')}
                        <span style="margin-left: auto; background: ${isActive('today') ? 'rgba(59, 130, 246, 0.15)' : 'var(--bg-secondary)'}; color: ${isActive('today') ? 'var(--accent)' : 'var(--text-secondary)'}; padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">${todayTasks.length}</span>
                    </button>
                    <button onclick="switchTodoFilter('week')" class="sidebar-btn" style="width: 100%; padding: 8px 12px; text-align: left; border: none; background: ${isActive('week') ? 'rgba(59, 130, 246, 0.1)' : 'transparent'}; color: ${isActive('week') ? 'var(--accent)' : 'var(--text-primary)'}; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; transition: all 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        ${t('todo.filter.week')}
                        <span style="margin-left: auto; background: ${isActive('week') ? 'rgba(59, 130, 246, 0.15)' : 'var(--bg-secondary)'}; color: ${isActive('week') ? 'var(--accent)' : 'var(--text-secondary)'}; padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">${weekTasks.length}</span>
                    </button>
                    <button onclick="switchTodoFilter('priority')" class="sidebar-btn" style="width: 100%; padding: 8px 12px; text-align: left; border: none; background: ${isActive('priority') ? 'rgba(59, 130, 246, 0.1)' : 'transparent'}; color: ${isActive('priority') ? 'var(--accent)' : 'var(--text-primary)'}; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; transition: all 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        ${t('todo.filter.urgent')}
                        <span style="margin-left: auto; background: ${isActive('priority') ? 'rgba(239, 68, 68, 0.15)' : 'var(--bg-secondary)'}; color: ${isActive('priority') ? 'var(--hi-high)' : 'var(--text-secondary)'}; padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">${priorityTasks.length}</span>
                    </button>
                </div>
            `;
        }

        function renderTodoCategories() {
            const categories = document.getElementById('todoCategories');
            const categoriesCount = {};
            const activeTasks = userTasks.filter(t => !t.completed);
            
            activeTasks.forEach(task => {
                const cat = task.category || 'Autre';
                categoriesCount[cat] = (categoriesCount[cat] || 0) + 1;
            });

            const categoryIcons = {
                'Toutes': '<path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>',
                'Travail': '<path d="M20 7h-4V5l-2-2h-4L8 5v2H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2zM10 5h4v2h-4V5z"/>',
                'Personnel': '<path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>',
                '√âtudes': '<path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z"/><path d="M17.5 10.5c.88 0 1.73.09 2.5.26V9.24c-.79-.15-1.64-.24-2.5-.24-1.7 0-3.24.29-4.5.83v1.66c1.13-.64 2.7-.99 4.5-.99zM13 12.49v1.66c1.13-.64 2.7-.99 4.5-.99.88 0 1.73.09 2.5.26V11.9c-.79-.15-1.64-.24-2.5-.24-1.7 0-3.24.3-4.5.83zM17.5 14.33c-1.7 0-3.24.29-4.5.83v1.66c1.13-.64 2.7-.99 4.5-.99.88 0 1.73.09 2.5.26v-1.52c-.79-.16-1.64-.24-2.5-.24z"/>',
                'Sport': '<path d="M13.49 5.48c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.6 13.9l1-4.4 2.1 2v6h2v-7.5l-2.1-2 .6-3c1.3 1.5 3.3 2.5 5.5 2.5v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1l-5.2 2.2v4.7h2v-3.4l1.8-.7-1.6 8.1-4.9-1-.4 2 7 1.4z"/>',
                'Sant√©': '<path d="M19 3H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/>',
                'Autre': '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'
            };

            let html = `<div style="margin-bottom: 24px;"><h3 style="margin-bottom: 8px; color: var(--text-secondary); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px;">${t('todo.categoriesTitle')}</h3>`;
            
            // Bouton "Toutes" en premier
            const isAllActive = todoCategory === 'all';
            html += `
                <button onclick="switchTodoCategory('all')" class="sidebar-btn" style="width: 100%; padding: 8px 12px; text-align: left; border: none; background: ${isAllActive ? 'rgba(59, 130, 246, 0.1)' : 'transparent'}; color: ${isAllActive ? 'var(--accent)' : 'var(--text-primary)'}; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; transition: all 0.2s;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" opacity="0.8">
                        ${categoryIcons['Toutes']}
                    </svg>
                    ${t('todo.category.all')}
                    <span style="margin-left: auto; background: ${isAllActive ? 'rgba(59, 130, 246, 0.15)' : 'var(--bg-secondary)'}; color: ${isAllActive ? 'var(--accent)' : 'var(--text-secondary)'}; padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">${activeTasks.length}</span>
                </button>
            `;
            
            // Autres cat√©gories
            Object.keys(categoriesCount).forEach(cat => {
                const isActive = todoCategory === cat;
                html += `
                    <button onclick="switchTodoCategory('${cat}')" class="sidebar-btn" style="width: 100%; padding: 8px 12px; text-align: left; border: none; background: ${isActive ? 'rgba(59, 130, 246, 0.1)' : 'transparent'}; color: ${isActive ? 'var(--accent)' : 'var(--text-primary)'}; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; transition: all 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" opacity="0.8">
                            ${categoryIcons[cat] || categoryIcons['Autre']}
                        </svg>
                        ${getTodoCategoryLabel(cat)}
                        <span style="margin-left: auto; background: ${isActive ? 'rgba(59, 130, 246, 0.15)' : 'var(--bg-secondary)'}; color: ${isActive ? 'var(--accent)' : 'var(--text-secondary)'}; padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">${categoriesCount[cat]}</span>
                    </button>
                `;
            });

            html += '</div>';
            categories.innerHTML = html;
        }

        function renderTodoMainView() {
            const mainArea = document.getElementById('todoMainArea');
            
            if (todoView === 'list') {
                renderListView(mainArea);
            } else if (todoView === 'kanban') {
                renderKanbanView(mainArea);
            } else if (todoView === 'calendar') {
                renderCalendarView(mainArea);
            } else if (todoView === 'personal') {
                renderPersonalSpaceView(mainArea);
            }
        }

        function clampNumber(value, min, max) {
            return Math.min(Math.max(value, min), max);
        }

        function normalizeProfileNumber(raw, { min = 0, max = 120, allowFloat = false } = {}) {
            const s = String(raw ?? '').trim();
            if (!s) return '';

            // Garder uniquement chiffres + s√©parateurs d√©cimaux √©ventuels
            const cleaned = s.replace(/[^0-9.,-]/g, '').replace(',', '.');
            if (!cleaned) return '';

            const n = allowFloat ? parseFloat(cleaned) : parseInt(cleaned, 10);
            if (!Number.isFinite(n)) return '';
            return String(clampNumber(n, min, max));
        }

        function getPersonalProfileStorageKey(userId) {
            return `aiTaskPersonalProfile:${String(userId || 'anonymous')}`;
        }

        function getPersonalProfile(userId) {
            try {
                const raw = localStorage.getItem(getPersonalProfileStorageKey(userId));
                if (!raw) return { age: '', sex: '', focusHours: '' };
                const parsed = JSON.parse(raw);
                return {
                    age: parsed?.age ?? '',
                    sex: parsed?.sex ?? '',
                    focusHours: parsed?.focusHours ?? ''
                };
            } catch (_) {
                return { age: '', sex: '', focusHours: '' };
            }
        }

        function savePersonalProfile(userId, profile) {
            const cleaned = {
                age: profile?.age ?? '',
                sex: profile?.sex ?? '',
                focusHours: profile?.focusHours ?? ''
            };
            try {
                localStorage.setItem(getPersonalProfileStorageKey(userId), JSON.stringify(cleaned));
                try { showToast('‚úÖ Profil enregistr√©', 'success'); } catch (_) {}
            } catch (e) {
                try { showToast('‚ùå Impossible d\'enregistrer le profil', 'error'); } catch (_) {}
            }
        }

        function savePersonalProfileFromModal() {
            const userId = typeof getTodoUserId === 'function' ? getTodoUserId() : 'anonymous';
            const ageRaw = document.getElementById('profileAgeInput')?.value ?? '';
            const sexRaw = document.getElementById('profileSexInput')?.value ?? '';
            const focusRaw = document.getElementById('profileFocusHoursInput')?.value ?? '';
            const age = normalizeProfileNumber(ageRaw, { min: 0, max: 120, allowFloat: false });
            const sex = String(sexRaw).trim();
            const focusHours = normalizeProfileNumber(focusRaw, { min: 0, max: 24, allowFloat: true });

            savePersonalProfile(userId, { age, sex, focusHours });
            closePersonalProfileModal();

            try {
                if (typeof todoView !== 'undefined' && todoView === 'personal') {
                    const mainArea = document.querySelector('.todo-main') || document.getElementById('todoMainArea') || null;
                    if (mainArea) renderPersonalSpaceView(mainArea);
                }
            } catch (_) {}
        }

        function closePersonalProfileModal() {
            const el = document.getElementById('personalProfileModal');
            if (el) el.remove();
        }

        function openPersonalProfileModal() {
            const userId = typeof getTodoUserId === 'function' ? getTodoUserId() : 'anonymous';
            const current = getPersonalProfile(userId);

            closePersonalProfileModal();

            const modal = document.createElement('div');
            modal.id = 'personalProfileModal';
            modal.style.position = 'fixed';
            modal.style.inset = '0';
            modal.style.background = 'rgba(0,0,0,0.35)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.padding = '18px';
            // Doit passer au-dessus des overlays (ex: AI Task overlay z-index 10000)
            modal.style.zIndex = '40000';

            modal.innerHTML = `
                <div role="dialog" aria-modal="true" style="width: 100%; max-width: 520px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 14px; padding: 16px; box-shadow: 0 12px 30px var(--shadow);">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap: 12px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M20 21a8 8 0 0 0-16 0" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                            <div style="font-weight: 800; color: var(--text-primary);">${t('todo.profile.modal.title')}</div>
                        </div>
                        <button type="button" onclick="closePersonalProfileModal()" style="border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); border-radius: 10px; padding: 8px 10px; cursor: pointer;">${t('todo.profile.modal.close')}</button>
                    </div>

                    <div style="margin-top: 12px; color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
                        ${t('todo.profile.modal.desc')}
                    </div>

                    <div style="margin-top: 14px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary); font-weight: 700; margin-bottom: 6px;">${t('todo.profile.modal.age')}</div>
                            <input id="profileAgeInput" type="number" inputmode="numeric" min="0" max="120" placeholder="${t('todo.profile.modal.agePlaceholder')}" value="${String(current.age ?? '')}" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);" />
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary); font-weight: 700; margin-bottom: 6px;">${t('todo.profile.modal.sex')}</div>
                            <select id="profileSexInput" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                                <option value="" ${current.sex ? '' : 'selected'}>‚Äî</option>
                                <option value="female" ${String(current.sex) === 'female' ? 'selected' : ''}>${t('todo.profile.modal.sexFemale')}</option>
                                <option value="male" ${String(current.sex) === 'male' ? 'selected' : ''}>${t('todo.profile.modal.sexMale')}</option>
                                <option value="other" ${String(current.sex) === 'other' ? 'selected' : ''}>${t('todo.profile.modal.sexOther')}</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-top: 10px;">
                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 700; margin-bottom: 6px;">${t('todo.profile.modal.capacity')}</div>
                        <input id="profileFocusHoursInput" type="number" inputmode="decimal" min="0" max="24" step="0.5" placeholder="${t('todo.profile.modal.capacityPlaceholder')}" value="${String(current.focusHours ?? '')}" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);" />
                        <div style="margin-top: 6px; font-size: 12px; color: var(--text-secondary);">${t('todo.profile.modal.capacityHint')}</div>
                    </div>

                    <div style="margin-top: 14px; display:flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="savePersonalProfileFromModal()" style="border: none; background: var(--accent); color: white; border-radius: 10px; padding: 10px 12px; cursor: pointer; font-weight: 800;">${t('todo.profile.modal.save')}</button>
                    </div>
                </div>
            `;

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closePersonalProfileModal();
            });

            document.body.appendChild(modal);
        }

        function computeMentalLoadScore(metrics) {
            const pending = Number(metrics.pending || 0);
            const overdue = Number(metrics.overdue || 0);
            const next24Hours = Number(metrics.next24Hours || 0);
            const overload = metrics.overloadNext24 ? 1 : 0;

            const score = (pending * 8) + (overdue * 15) + (next24Hours * 6) + (overload * 18);
            return clampNumber(Math.round(score), 0, 100);
        }

        function computeStressIndex(metrics) {
            const overdue = Number(metrics.overdue || 0);
            const next24Hours = Number(metrics.next24Hours || 0);
            const overload = metrics.overloadNext24 ? 1 : 0;
            const streak = Number(metrics.streakDays || 0);

            const score = (overdue * 20) + (next24Hours * 5) + (overload * 22) - (streak >= 3 ? 8 : 0);
            return clampNumber(Math.round(score), 0, 100);
        }

        function renderScoreCard({ title, value, subtitle, hint }) {
            const numeric = typeof value === 'number' ? value : parseFloat(String(value).replace('%', ''));
            const bar = clampNumber(isFinite(numeric) ? numeric : 0, 0, 100);
            return `
                <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px;">
                    <div style="font-size: 12px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px;">${title}</div>
                    <div style="margin-top: 6px; font-size: 26px; font-weight: 800; color: var(--text-primary); line-height: 1;">${value}</div>
                    ${subtitle ? `<div style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);">${subtitle}</div>` : ''}
                    <div style="margin-top: 12px; height: 10px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 999px; overflow: hidden;">
                        <div style="height: 100%; width: ${bar}%; background: var(--accent);"></div>
                    </div>
                    ${hint ? `<div style="margin-top: 10px; font-size: 13px; color: var(--text-secondary);">${hint}</div>` : ''}
                </div>
            `;
        }

        async function renderPersonalSpaceView(container) {
            const fmt = (template, values) => {
                let out = String(template || '');
                if (!values) return out;
                Object.keys(values).forEach(k => { out = out.split(`{${k}}`).join(String(values[k])); });
                return out;
            };

            container.innerHTML = `
                <div style="max-width: 980px; margin: 0 auto;">
                    <h2 style="color: var(--text-primary); margin-bottom: 18px; font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M3 17l6-6 4 4 8-8"/>
                            <path d="M14 7h7v7"/>
                        </svg>
                        ${t('todo.personal.title')}
                    </h2>

                    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-bottom: 14px;">
                        <div style="color: var(--text-secondary); font-size: 13px;">${t('todo.personal.loading')}</div>
                    </div>
                </div>
            `;

            const userId = getTodoUserId();
                        try {
                const profile = getPersonalProfile(userId);
                const qp = new URLSearchParams();
                if (profile.age) qp.set('age', String(profile.age));
                if (profile.sex) qp.set('sex', String(profile.sex));
                if (profile.focusHours) qp.set('focusHours', String(profile.focusHours));
                qp.set('lang', getAppLanguage());

                const resp = await apiFetch(`/api/tasks/productivity?${qp.toString()}`, {
                    headers: { 'X-Language': getAppLanguage() }
                });
                if (!resp.ok) throw new Error(fmt(t('todo.personal.error.server'), { status: resp.status, statusText: resp.statusText }));
                const data = await resp.json();
                const metrics = data.metrics || {};

                const total = Number(metrics.total || 0);
                const completed = Number(metrics.completed || 0);
                const pending = Number(metrics.pending || 0);
                const overdue = Number(metrics.overdue || 0);
                const pendingHours = Number(metrics.pendingEstimatedHours || 0);
                const next24Hours = Number(metrics.next24Hours || 0);
                const overloadNext24 = !!metrics.overloadNext24;
                const streakDays = Number(metrics.streakDays || 0);

                const completionRate = Number.isFinite(Number(metrics.completionRate))
                    ? Number(metrics.completionRate)
                    : (total > 0 ? Math.round((completed / total) * 100) : 0);

                const mentalLoad = Number.isFinite(Number(metrics.mentalLoadScore))
                    ? Number(metrics.mentalLoadScore)
                    : computeMentalLoadScore({ pending, overdue, next24Hours, overloadNext24 });

                const stress = Number.isFinite(Number(metrics.stressIndex))
                    ? Number(metrics.stressIndex)
                    : computeStressIndex({ overdue, next24Hours, overloadNext24, streakDays });

                const advice = [];
                if (overdue > 0) advice.push(fmt(t('todo.personal.advice.overdue'), { count: overdue }));
                if (overloadNext24) advice.push(fmt(t('todo.personal.advice.overload'), { hours: next24Hours }));
                if (!overloadNext24 && pendingHours >= 6) advice.push(fmt(t('todo.personal.advice.highLoad'), { hours: pendingHours }));
                if (advice.length === 0) advice.push(t('todo.personal.advice.stable'));

                const profileLocal = getPersonalProfile(userId);
                const hasAnyProfile = !!(String(profileLocal.age || '').trim() || String(profileLocal.sex || '').trim() || String(profileLocal.focusHours || '').trim());
                const profileBanner = `
                    <div style="margin-bottom: 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px 14px; display:flex; align-items:center; justify-content: space-between; gap: 12px;">
                        <div style="display:flex; gap: 10px; align-items:flex-start;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="margin-top: 1px;">
                                <path d="M20 21a8 8 0 0 0-16 0" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                            <div>
                                <div style="font-weight: 800; color: var(--text-primary); font-size: 13px;">${t('todo.profile')}</div>
                                <div style="color: var(--text-secondary); font-size: 13px; line-height: 1.4;">${hasAnyProfile ? t('todo.profile.filled') : t('todo.profile.incomplete')}</div>
                            </div>
                        </div>
                        <button type="button" onclick="openPersonalProfileModal()" style="border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); border-radius: 10px; padding: 8px 10px; cursor: pointer; font-weight: 800;">${hasAnyProfile ? t('todo.profile.edit') : t('todo.profile.complete')}</button>
                    </div>
                `;

                const cardsHtml = `
                    <div id="personalCardsGrid" style="display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px;">
                        ${renderScoreCard({
                            title: t('todo.personal.card.completionTitle'),
                            value: `${completionRate}%`,
                            subtitle: fmt(t('todo.personal.card.completionSubtitle'), { completed, total }),
                            hint: t('todo.personal.card.completionHint')
                        })}
                        ${renderScoreCard({
                            title: t('todo.personal.card.mentalTitle'),
                            value: mentalLoad,
                            subtitle: fmt(t('todo.personal.card.mentalSubtitle'), { pending, overdue }),
                            hint: t('todo.personal.card.mentalHint')
                        })}
                        ${renderScoreCard({
                            title: t('todo.personal.card.stressTitle'),
                            value: stress,
                            subtitle: overloadNext24
                                ? fmt(t('todo.personal.card.stressSubtitleOverload'), { hours: next24Hours })
                                : fmt(t('todo.personal.card.stressSubtitleStreak'), { days: streakDays }),
                            hint: t('todo.personal.card.stressHint')
                        })}
                    </div>
                `;

                const detailsHtml = `
                    <div style="margin-top: 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px;">
                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 10px;">${t('todo.personal.detailsTitle')}</div>
                        <div id="personalDetailsGrid" style="display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px;">
                            <div style="padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-primary);">
                                <div style="font-size: 12px; color: var(--text-secondary);">${t('todo.personal.details.inProgress')}</div>
                                <div style="font-size: 18px; font-weight: 800; color: var(--text-primary);">${pending}</div>
                            </div>
                            <div style="padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-primary);">
                                <div style="font-size: 12px; color: var(--text-secondary);">${t('todo.personal.card.overdue')}</div>
                                <div style="font-size: 18px; font-weight: 800; color: var(--text-primary);">${overdue}</div>
                            </div>
                            <div style="padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-primary);">
                                <div style="font-size: 12px; color: var(--text-secondary);">${t('todo.personal.card.workload')}</div>
                                <div style="font-size: 18px; font-weight: 800; color: var(--text-primary);">${pendingHours}h</div>
                            </div>
                            <div style="padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-primary);">
                                <div style="font-size: 12px; color: var(--text-secondary);">${t('todo.personal.card.next24h')}</div>
                                <div style="font-size: 18px; font-weight: 800; color: var(--text-primary);">${next24Hours}h</div>
                            </div>
                        </div>
                        <div style="margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                            <div style="font-weight: 800; color: var(--text-primary); margin-bottom: 8px; font-size: 13px;">${t('todo.personal.aiAdvice')}</div>
                            <div style="color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
                                ${advice.map(a => `‚Ä¢ ${a}`).join('<br>')}
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = `
                    <div style="max-width: 980px; margin: 0 auto;">
                        <h2 style="color: var(--text-primary); margin-bottom: 18px; font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M3 17l6-6 4 4 8-8"/>
                                <path d="M14 7h7v7"/>
                            </svg>
                            ${t('todo.personal.title')}
                        </h2>

                        ${profileBanner}
                        ${cardsHtml}
                        ${detailsHtml}
                    </div>
                `;

                if (window.innerWidth <= 900) {
                    const cardsGrid = document.getElementById('personalCardsGrid');
                    if (cardsGrid) cardsGrid.style.gridTemplateColumns = '1fr';
                    const detailsGrid = document.getElementById('personalDetailsGrid');
                    if (detailsGrid) detailsGrid.style.gridTemplateColumns = 'repeat(2, minmax(0, 1fr))';
                }
            } catch (e) {
                console.error('Metrics error:', e);
                container.innerHTML = `
                    <div style="max-width: 980px; margin: 0 auto;">
                        <h2 style="color: var(--text-primary); margin-bottom: 18px; font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M3 17l6-6 4 4 8-8"/>
                                <path d="M14 7h7v7"/>
                            </svg>
                            ${t('todo.personal.title')}
                        </h2>
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px;">
                            <div style="color: var(--text-secondary); font-size: 13px;">${t('todo.personal.metricsError')}</div>
                        </div>
                    </div>
                `;
            }
        }

        function renderListView(container) {
            const tasks = getFilteredTasks();
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); text-align: center; padding: 40px;">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.3; margin-bottom: 20px;" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 11l3 3L22 4"/>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                        </svg>
                        <h3 style="margin-bottom: 8px; font-size: 18px; color: var(--text-primary); font-weight: 600;">${t('todo.empty.title')}</h3>
                        <p style="font-size: 14px; margin-bottom: 24px; color: var(--text-secondary);">${t('todo.empty.desc')}</p>
                        <button onclick="showAddTaskModal()" style="padding: 10px 24px; background: #3B82F6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.2s;" onmouseover="this.style.background='#2563EB'" onmouseout="this.style.background='#3B82F6'">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            ${t('todo.empty.create')}
                        </button>
                    </div>
                `;
                return;
            }

            let html = '<div>';
            tasks.forEach(task => {
                html += renderTaskCard(task);
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function renderTaskCard(task) {
            const priorityColor = task.priority === 'high' ? '#EF4444' : task.priority === 'medium' ? '#F59E0B' : '#3B82F6';
            const priorityBg = task.priority === 'high' ? 'rgba(239, 68, 68, 0.1)' : task.priority === 'medium' ? 'rgba(245, 158, 11, 0.1)' : 'rgba(59, 130, 246, 0.1)';
            const priorityLabel = task.priority === 'high' ? t('todo.priority.high') : task.priority === 'medium' ? t('todo.priority.medium') : t('todo.priority.low');
            const dueStr = task.dueDate ? new Date(task.dueDate).toLocaleDateString(getLocale(), { day: 'numeric', month: 'short' }) : '';
            
            return `
                <div onclick="showTaskDetails('${task.id}')" style="padding: 14px 16px; background: var(--bg-secondary); border-radius: 10px; border-left: 3px solid ${priorityColor}; cursor: pointer; transition: all 0.2s; margin-bottom: 10px; border: 1px solid var(--border-color);" 
                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px var(--shadow)'" 
                     onmouseout="this.style.transform=''; this.style.boxShadow=''">
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <div onclick="event.stopPropagation(); toggleTaskComplete('${task.id}')" style="margin-top: 3px; width: 18px; height: 18px; border: 2px solid ${task.completed ? 'var(--hi-low)' : 'var(--border-color)'}; border-radius: 5px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; ${task.completed ? 'background: var(--hi-low);' : ''} transition: all 0.2s;">
                            ${task.completed ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; font-size: 14px; ${task.completed ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${task.title}</div>
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; font-size: 12px;">
                                <span style="background: ${priorityBg}; color: ${priorityColor}; padding: 3px 8px; border-radius: 6px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="10"/>
                                    </svg>
                                    ${priorityLabel}
                                </span>
                                ${dueStr ? `<span style="color: var(--text-secondary); display: flex; align-items: center; gap: 4px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${dueStr}</span>` : ''}
                                ${task.category ? `<span style="color: var(--text-secondary); display: flex; align-items: center; gap: 4px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>${getTodoCategoryLabel(task.category)}</span>` : ''}
                                ${task.subtasks && task.subtasks.length > 0 ? `<span style="color: var(--text-secondary); display: flex; align-items: center; gap: 4px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>${task.subtasks.filter(s => s.completed).length}/${task.subtasks.length}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderKanbanView(container) {
            const allTasks = getFilteredTasks();
            const todoTasks = allTasks.filter(t => !t.completed && !t.inProgress);
            const inProgressTasks = allTasks.filter(t => t.inProgress && !t.completed);
            const completedTasks = userTasks.filter(t => t.completed);

            container.innerHTML = `
                <div style="position: relative;">
                    <div id="kanbanContainer" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; height: 100%;">
                        <div class="kanban-column" style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; overflow-y: auto; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; position: sticky; top: 0; background: var(--bg-secondary); z-index: 1; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);">
                                <div style="font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--text-primary);">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"/>
                                    </svg>
                                    ${t('todo.kanban.todo')}
                                </div>
                                <span style="background: rgba(59, 130, 246, 0.1); color: var(--accent); padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;">${todoTasks.length}</span>
                            </div>
                            ${todoTasks.map(t => renderTaskCard(t)).join('')}
                        </div>

                        <div class="kanban-column" style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; overflow-y: auto; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; position: sticky; top: 0; background: var(--bg-secondary); z-index: 1; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);">
                                <div style="font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--text-primary);">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                    </svg>
                                    ${t('todo.kanban.inProgress')}
                                </div>
                                <span style="background: rgba(245, 158, 11, 0.1); color: var(--hi-med); padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;">${inProgressTasks.length}</span>
                            </div>
                            ${inProgressTasks.map(t => renderTaskCard(t)).join('')}
                        </div>

                        <div class="kanban-column" style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; overflow-y: auto; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; position: sticky; top: 0; background: var(--bg-secondary); z-index: 1; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);">
                                <div style="font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--text-primary);">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22 4 12 14.01 9 11.01"/>
                                    </svg>
                                    ${t('todo.kanban.done')}
                                </div>
                                <span style="background: rgba(16, 185, 129, 0.1); color: var(--hi-low); padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;">${completedTasks.length}</span>
                            </div>
                            ${completedTasks.slice(0, 10).map(t => renderTaskCard(t)).join('')}
                        </div>
                    </div>
                    
                    <!-- Boutons de navigation mobile -->
                    <button id="kanbanNavLeft" onclick="scrollKanban('left')" style="display: none; position: fixed; left: 8px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; background: rgba(59, 130, 246, 0.9); color: white; border: none; border-radius: 50%; cursor: pointer; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"/>
                        </svg>
                    </button>
                    <button id="kanbanNavRight" onclick="scrollKanban('right')" style="display: none; position: fixed; right: 8px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; background: rgba(59, 130, 246, 0.9); color: white; border: none; border-radius: 50%; cursor: pointer; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </button>
                </div>
            `;
        }

        function renderCalendarView(container) {
            const events = getTodayEvents();
            const weekEvents = getWeekEvents();
            const tasksWithDates = userTasks.filter(t => t.dueDate && !t.completed);

            container.innerHTML = `
                <div style="max-width: 900px; margin: 0 auto;">
                    <h2 style="color: var(--text-primary); margin-bottom: 24px; font-size: 22px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        ${t('todo.calendar.title')}
                    </h2>
                    
                    <!-- Aujourd'hui -->
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 16px; border: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="3" y2="12"/>
                                <line x1="21" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                            ${t('todo.calendar.todayPrefix')} - ${new Date().toLocaleDateString(getLocale(), { weekday: 'long', day: 'numeric', month: 'long' })}
                        </h3>
                        ${events.length === 0 ? `<p style="color: var(--text-secondary); margin: 0; font-size: 14px;">${t('todo.calendar.noEventsToday')}</p>` : events.map(e => `
                            <div style="padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #3B82F6; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px; font-size: 14px;">${e.title}</div>
                                <div style="color: var(--text-secondary); font-size: 13px; display: flex; align-items: center; gap: 6px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                    ${new Date(e.startDate).toLocaleTimeString(getLocale(), { hour: '2-digit', minute: '2-digit' })}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Cette semaine -->
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 16px; border: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            ${t('todo.calendar.thisWeek')}
                        </h3>
                        ${tasksWithDates.length === 0 ? `<p style="color: var(--text-secondary); margin: 0; font-size: 14px;">${t('todo.calendar.noScheduledTasks')}</p>` : tasksWithDates.slice(0, 5).map(t => renderTaskCard(t)).join('')}
                    </div>
                </div>
            `;
        }

        function getFilteredTasks() {
            let tasks = userTasks.filter(t => !t.completed);

            if (todoFilter === 'today') {
                const today = new Date().toDateString();
                tasks = tasks.filter(t => t.dueDate && new Date(t.dueDate).toDateString() === today);
            } else if (todoFilter === 'week') {
                const weekFromNow = new Date();
                weekFromNow.setDate(weekFromNow.getDate() + 7);
                tasks = tasks.filter(t => t.dueDate && new Date(t.dueDate) <= weekFromNow);
            } else if (todoFilter === 'priority') {
                tasks = tasks.filter(t => t.priority === 'high');
            }

            if (todoCategory !== 'all') {
                tasks = tasks.filter(t => t.category === todoCategory);
            }

            return tasks;
        }

        function switchTodoView(view) {
            todoView = view;
            
            // Update visual feedback on sidebar buttons
            ['list', 'kanban', 'calendar', 'personal'].forEach(v => {
                const btn = document.getElementById('view' + v.charAt(0).toUpperCase() + v.slice(1));
                if (btn) {
                    if (v === view) {
                        btn.style.background = 'rgba(59, 130, 246, 0.1)';
                        btn.style.color = '#3B82F6';
                    } else {
                        btn.style.background = 'transparent';
                        btn.style.color = 'var(--text-primary)';
                    }
                }
            });
            
            // Re-render the main view with new selected view
            renderTodoMainView();

            // Mobile: refermer le sidebar apr√®s action
            if (window.toggleTodoSidebar && window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
                window.toggleTodoSidebar(false);
            }
            
            // Activer les boutons de navigation si vue Kanban sur mobile
            if (view === 'kanban' && window.innerWidth <= 768) {
                setTimeout(updateKanbanNavButtons, 100);
            }
        }
        
        function scrollKanban(direction) {
            const container = document.getElementById('kanbanContainer');
            if (!container) return;
            
            const scrollAmount = container.offsetWidth * 0.85; // Scroll une colonne
            const currentScroll = container.scrollLeft;
            
            if (direction === 'left') {
                container.scrollTo({
                    left: Math.max(0, currentScroll - scrollAmount),
                    behavior: 'smooth'
                });
            } else {
                container.scrollTo({
                    left: currentScroll + scrollAmount,
                    behavior: 'smooth'
                });
            }
            
            setTimeout(updateKanbanNavButtons, 300);
        }
        
        function updateKanbanNavButtons() {
            const container = document.getElementById('kanbanContainer');
            const leftBtn = document.getElementById('kanbanNavLeft');
            const rightBtn = document.getElementById('kanbanNavRight');
            
            if (!container || !leftBtn || !rightBtn) return;
            if (window.innerWidth > 768) {
                leftBtn.style.display = 'none';
                rightBtn.style.display = 'none';
                return;
            }
            
            const maxScroll = container.scrollWidth - container.clientWidth;
            const currentScroll = container.scrollLeft;
            
            // Afficher/masquer selon la position
            leftBtn.style.display = currentScroll > 10 ? 'flex' : 'none';
            rightBtn.style.display = currentScroll < maxScroll - 10 ? 'flex' : 'none';
        }

        function switchTodoFilter(filter) {
            todoFilter = filter;
            renderTodoFilters();
            renderTodoMainView();

            if (window.toggleTodoSidebar && window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
                window.toggleTodoSidebar(false);
            }
        }

        function switchTodoCategory(category) {
            todoCategory = category;
            renderTodoCategories();
            renderTodoMainView();

            if (window.toggleTodoSidebar && window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
                window.toggleTodoSidebar(false);
            }
        }

        function showAddTaskModal() {
            const description = prompt(`${t('todo.add.prompt')}\n\n${t('todo.add.promptExample')}`);
            if (!description) return;

            showToast(t('todo.toast.analyzing'), 'info');

            // Appel √† l'API taskManager
            apiFetch('/api/tasks/smart-add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    description: description,
                                        model: (typeof getSelectedAiModel === 'function') ? getSelectedAiModel() : null
                })
            })
            .then(res => res.json())
            .then(data => {
                console.log('R√©ponse API:', data); // Debug
                
                if (data.task) {
                    const task = data.task;
                    
                    // Mapper les champs de l'API vers le format local
                    // Normaliser "urgent" ‚Üí "high" pour compatibilit√© avec le code existant
                    let priority = task.priority || 'medium';
                    if (priority === 'urgent') priority = 'high';
                    
                    const dueDate = task.deadline || task.dueDate || null; // L'API utilise "deadline"
                    
                    // Mapper les cat√©gories (premi√®re lettre en majuscule)
                    let category = task.category || 'Autre';
                    if (category) {
                        category = category.charAt(0).toUpperCase() + category.slice(1);
                    }
                    
                    const description = task.description || '';
                    
                    // Cr√©er la t√¢che avec les donn√©es pars√©es
                    const newTask = {
                        id: Date.now().toString() + Math.random().toString(36).slice(2, 8),
                        title: task.title,
                        description: description,
                        priority: priority,
                        dueDate: dueDate,
                        category: category,
                        completed: false,
                        inProgress: false,
                        createdAt: new Date().toISOString(),
                        subtasks: task.subtasks || [],
                        notifyEnabled: false,
                        notificationEnabled: false,
                        projectId: null,
                        progress: 0,
                        userId: currentUser?.email || 'guest'
                    };
                    
                    userTasks.push(newTask);
                    saveTasks();
                    
                    // Programmer la notification si une date d'√©ch√©ance est d√©finie
                    if (dueDate) {
                        scheduleNotification(newTask);
                    }
                    
                    // Message avec priorit√© si urgente
                    const priorityEmoji = priority === 'high' ? 'üî¥ ' : '';
                    showToast(`${t('todo.toast.taskCreated')} ${priorityEmoji}${dueDate ? 'üìÖ ' + new Date(dueDate).toLocaleDateString(getLocale()) : ''}`, 'success');
                    renderTodoFilters();
                    renderTodoCategories();
                    renderTodoMainView();
                } else {
                    throw new Error('Format de r√©ponse invalide');
                }
            })
            .catch(error => {
                console.error('Erreur API:', error);
                // Fallback: cr√©ation simple avec tous les champs n√©cessaires
                addTask(description, null, 'medium', 'Autre');
                showToast(t('todo.toast.taskCreatedSimple'), 'info');
                renderTodoFilters();
                renderTodoCategories();
                renderTodoMainView();
            });
        }

        function toggleTaskComplete(taskId) {
            const id = String(taskId);
            const task = userTasks.find(t => String(t.id) === id);
            if (task) {
                task.completed = !task.completed;
                task.status = task.completed ? 'completed' : 'pending';
                task.updatedAt = new Date().toISOString();
                if (task.completed) {
                    task.completedAt = new Date().toISOString();
                }
                saveTasks();
                showToast(task.completed ? t('todo.toast.taskCompleted') : t('todo.toast.taskReactivated'), 'success');
                renderTodoFilters();
                renderTodoCategories();
                renderTodoMainView();
            }
        }

        function showTaskDetails(taskId) {
            // Convertir taskId en number si n√©cessaire pour la comparaison
            const id = typeof taskId === 'string' ? parseInt(taskId) : taskId;
            selectedTask = userTasks.find(t => t.id === id || t.id === taskId);
            if (!selectedTask) {
                console.error('T√¢che non trouv√©e:', taskId, 'Type:', typeof taskId);
                return;
            }
            
            // üîÑ Normaliser la t√¢che pour s'assurer que toutes les propri√©t√©s existent
            if (selectedTask.notifyEnabled === undefined) {
                selectedTask.notifyEnabled = false;
            }
            if (selectedTask.notificationEnabled === undefined) {
                selectedTask.notificationEnabled = false;
            }
            if (selectedTask.subtasks === undefined) {
                selectedTask.subtasks = [];
            }

            const panel = document.getElementById('todoDetailsPanel');
            const isMobile = window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
            panel.style.width = isMobile ? '100%' : '420px';
            panel.style.padding = isMobile ? '16px' : '20px';
            detailsPanelOpen = true;

            // Mobile: fermer le sidebar si ouvert
            if (isMobile && window.toggleTodoSidebar) {
                window.toggleTodoSidebar(false);
            }
            
            // Add backdrop
            let backdrop = document.getElementById('todoDetailsBackdrop');
            if (!backdrop) {
                backdrop = document.createElement('div');
                backdrop.id = 'todoDetailsBackdrop';
                backdrop.onclick = closeTaskDetails;
                panel.parentElement.appendChild(backdrop);
            }
            backdrop.style.cssText = 'position: absolute; inset: 0; background: rgba(0, 0, 0, 0.4); z-index: 99; transition: opacity 0.3s; opacity: 1;';

            const dueStr = selectedTask.dueDate ? new Date(selectedTask.dueDate).toLocaleDateString(getLocale(), { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }) : t('todo.details.dueDateUnset');
            const priorityLabel = selectedTask.priority === 'high' ? t('todo.priority.high') : selectedTask.priority === 'medium' ? t('todo.priority.medium') : t('todo.priority.low');
            const priorityColor = selectedTask.priority === 'high' ? '#EF4444' : selectedTask.priority === 'medium' ? '#F59E0B' : '#3B82F6';
            const priorityBg = selectedTask.priority === 'high' ? 'rgba(239, 68, 68, 0.1)' : selectedTask.priority === 'medium' ? 'rgba(245, 158, 11, 0.1)' : 'rgba(59, 130, 246, 0.1)';

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                    <h3 style="margin: 0; color: var(--text-primary); font-size: 16px; font-weight: 600;">${t('todo.details.title')}</h3>
                    <button onclick="closeTaskDetails()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <div style="margin-bottom: 24px;">
                    <h4 style="color: var(--text-primary); font-size: 15px; margin-bottom: 12px; font-weight: 600; line-height: 1.4;">${selectedTask.title}</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <span style="background: ${priorityBg}; color: ${priorityColor}; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
                            ${priorityLabel}
                        </span>
                        ${selectedTask.category ? `<span style="background: rgba(139, 92, 246, 0.1); color: #8B5CF6; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>${getTodoCategoryLabel(selectedTask.category)}</span>` : ''}
                    </div>
                </div>

                <div style="margin-bottom: 20px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <span style="color: var(--text-secondary); font-size: 12px; font-weight: 600;">${t('todo.details.dueDateLabel')}</span>
                    </div>
                    <div style="color: var(--text-primary); font-size: 13px; padding-left: 22px;">${dueStr}</div>
                </div>

                ${selectedTask.description ? `
                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10 9 9 9 8 9"/>
                            </svg>
                            ${t('todo.details.descriptionLabel')}
                        </div>
                        <div style="color: var(--text-primary); font-size: 13px; line-height: 1.6; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">${selectedTask.description}</div>
                    </div>
                ` : ''}

                ${selectedTask.subtasks && selectedTask.subtasks.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 10px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="8" y1="6" x2="21" y2="6"/>
                                <line x1="8" y1="12" x2="21" y2="12"/>
                                <line x1="8" y1="18" x2="21" y2="18"/>
                                <line x1="3" y1="6" x2="3.01" y2="6"/>
                                <line x1="3" y1="12" x2="3.01" y2="12"/>
                                <line x1="3" y1="18" x2="3.01" y2="18"/>
                            </svg>
                            ${t('todo.details.subtasksLabel')} (${selectedTask.subtasks.filter(s => s.completed).length}/${selectedTask.subtasks.length})
                        </div>
                        ${selectedTask.subtasks.map(st => `
                            <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 6px; display: flex; align-items: center; gap: 10px; border: 1px solid var(--border-color);">
                                <div style="width: 16px; height: 16px; border: 2px solid ${st.completed ? 'var(--hi-low)' : 'var(--border-color)'}; border-radius: 4px; flex-shrink: 0; ${st.completed ? 'background: var(--hi-low);' : ''} display: flex; align-items: center; justify-content: center;">
                                    ${st.completed ? '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                                </div>
                                <span style="color: var(--text-primary); font-size: 13px; ${st.completed ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${st.title}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${selectedTask.dueDate && !selectedTask.completed ? `
                    <div style="margin-top: 20px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 10px;">
                            <input type="checkbox" ${selectedTask.notifyEnabled ? 'checked' : ''} onchange="${typeof selectedTask.id === 'string' && /[a-zA-Z]/.test(selectedTask.id) ? 'toggleTaskNotificationAgent' : 'toggleTaskNotification'}('${selectedTask.id}', this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="color: var(--text-primary); font-size: 13px; font-weight: 600; margin-bottom: 2px;">${t('todo.details.notifyMeTitle')}</div>
                                <div style="color: var(--text-secondary); font-size: 12px;">${t('todo.details.notifyMeDesc')}</div>
                            </div>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                            </svg>
                        </label>
                        ${selectedTask.notifyEnabled ? `
                            <div style="display: flex; align-items: center; gap: 8px; padding-left: 28px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <span style="color: var(--text-secondary); font-size: 12px; font-weight: 500;">${t('todo.details.notifyLabel')}</span>
                                <select onchange="updateTaskNotificationTime('${selectedTask.id}', this.value)" style="padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 12px; cursor: pointer; outline: none;">
                                    <option value="5" ${selectedTask.notifyMinutes === 5 ? 'selected' : ''}>5 ${t('todo.details.minutes')}</option>
                                    <option value="10" ${selectedTask.notifyMinutes === 10 ? 'selected' : ''}>10 ${t('todo.details.minutes')}</option>
                                    <option value="15" ${!selectedTask.notifyMinutes || selectedTask.notifyMinutes === 15 ? 'selected' : ''}>15 ${t('todo.details.minutes')}</option>
                                    <option value="30" ${selectedTask.notifyMinutes === 30 ? 'selected' : ''}>30 ${t('todo.details.minutes')}</option>
                                    <option value="60" ${selectedTask.notifyMinutes === 60 ? 'selected' : ''}>${t('todo.details.hour')}</option>
                                    <option value="120" ${selectedTask.notifyMinutes === 120 ? 'selected' : ''}>${t('todo.details.hours2')}</option>
                                    <option value="1440" ${selectedTask.notifyMinutes === 1440 ? 'selected' : ''}>${t('todo.details.day')}</option>
                                </select>
                                <span style="color: var(--text-secondary); font-size: 12px;">${t('todo.details.before')}</span>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <div style="display: flex; gap: 8px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <button onclick="toggleTaskComplete('${selectedTask.id}')" style="flex: 1; padding: 10px; background: ${selectedTask.completed ? 'rgba(245, 158, 11, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; color: ${selectedTask.completed ? '#F59E0B' : '#10B981'}; border: 1px solid ${selectedTask.completed ? 'rgba(245, 158, 11, 0.3)' : 'rgba(16, 185, 129, 0.3)'}; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;">
                        ${selectedTask.completed ? 
                            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/></svg>' + t('todo.details.reactivateBtn') : 
                            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>' + t('todo.details.completeBtn')}
                    </button>
                    <button onclick="deleteTaskConfirm('${selectedTask.id}')" style="padding: 10px; background: rgba(239, 68, 68, 0.1); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                    </button>
                </div>
            `;
        }

        function closeTaskDetails() {
            // Sauvegarder les changements de la t√¢che s√©lectionn√©e avant de fermer
            if (selectedTask) {
                // S'assurer que les modifications sont persist√©es
                const taskIndex = userTasks.findIndex(t => t.id === selectedTask.id);
                if (taskIndex !== -1) {
                    // Mettre √† jour avec les donn√©es de selectedTask
                    userTasks[taskIndex] = { ...userTasks[taskIndex], ...selectedTask };
                    saveTasks();
                }
            }
            
            const panel = document.getElementById('todoDetailsPanel');
            panel.style.width = '0';
            panel.style.padding = '0';
            detailsPanelOpen = false;
            selectedTask = null;
            
            // Remove backdrop
            const backdrop = document.getElementById('todoDetailsBackdrop');
            if (backdrop) {
                backdrop.style.opacity = '0';
                setTimeout(() => backdrop.remove(), 300);
            }
        }

        function deleteTaskConfirm(taskId) {
            if (confirm(t('todo.confirm.deleteTask'))) {
                deleteTask(taskId);
                closeTaskDetails();
                showToast(t('todo.toast.taskDeleted'), 'info');
                renderTodoFilters();
                renderTodoCategories();
                renderTodoMainView();
            }
        }

        function filterTodoSearch(query) {
            if (!query) {
                renderTodoMainView();
                return;
            }

            const q = query.toLowerCase();
            const filtered = userTasks.filter(t => 
                t.title.toLowerCase().includes(q) ||
                (t.description && t.description.toLowerCase().includes(q)) ||
                (t.category && (t.category.toLowerCase().includes(q) || getTodoCategoryLabel(t.category).toLowerCase().includes(q)))
            );

            const mainArea = document.getElementById('todoMainArea');
            if (filtered.length === 0) {
                mainArea.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #94A3B8; text-align: center;">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.3; margin-bottom: 16px;">
                            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        <h3 style="margin-bottom: 8px; font-size: 18px; color: #F1F5F9;">${t('todo.search.noResultsTitle')}</h3>
                        <p style="font-size: 14px;">${t('todo.search.noResultsDesc')}</p>
                    </div>
                `;
            } else {
                mainArea.innerHTML = '<div>' + filtered.map(t => renderTaskCard(t)).join('') + '</div>';
            }
        }

        // Fonction helper pour compl√©ter une t√¢che depuis l'UI (legacy support)
        function completeTaskUI(taskId) {
            toggleTaskComplete(taskId);
        }

        // Text Pro - Chargement modulaire pour √©viter de bloquer l'application
        let textProModuleLoaded = false;

        function preventTextProAutoFocus() {
            // √âvite que l'ouverture de Text Pro capture le curseur automatiquement.
            // IMPORTANT: certains modules d√©clenchent un focus() diff√©r√©; on prot√®ge
            // donc pendant un court laps de temps, sans bloquer le clic volontaire.
            let lastPointerDown = { t: 0, target: null };

            const onPointerDown = (e) => {
                lastPointerDown = { t: Date.now(), target: e && e.target ? e.target : null };
            };

            const onFocusIn = (e) => {
                try {
                    const textarea = document.getElementById('textProTextarea');
                    const chatInput = document.getElementById('textProChatInput');
                    if (!textarea && !chatInput) return;
                    const target = e && e.target ? e.target : null;
                    if (!target) return;

                    const isTextProField = (textarea && (target === textarea || textarea.contains(target)))
                        || (chatInput && (target === chatInput || chatInput.contains(target)));
                    if (!isTextProField) return;

                    const delta = Date.now() - (lastPointerDown.t || 0);
                    const pointerInsideField = !!(lastPointerDown.target && (
                        (textarea && (lastPointerDown.target === textarea || textarea.contains(lastPointerDown.target))) ||
                        (chatInput && (lastPointerDown.target === chatInput || chatInput.contains(lastPointerDown.target)))
                    ));

                    // Si le focus n'est pas d√©clench√© par un clic direct dans la zone, on blur.
                    if (!pointerInsideField || delta > 250) {
                        try { target.blur(); } catch (_) {}
                    }
                } catch (_) {}
            };

            document.addEventListener('pointerdown', onPointerDown, true);
            document.addEventListener('focusin', onFocusIn, true);

            // Blur imm√©diat si un focus a d√©j√† √©t√© pris au moment de l'ouverture.
            setTimeout(() => {
                try {
                    const textarea = document.getElementById('textProTextarea');
                    const chatInput = document.getElementById('textProChatInput');
                    const ae = document.activeElement;
                    if (!ae || (!textarea && !chatInput)) return;
                    const isInTextArea = textarea && (ae === textarea || textarea.contains(ae));
                    const isInChatInput = chatInput && (ae === chatInput || chatInput.contains(ae));
                    if (isInTextArea || isInChatInput) {
                        try { ae.blur(); } catch (_) {}
                    }
                } catch (_) {}
            }, 0);

            // Nettoyage: ne pas garder les listeners trop longtemps.
            setTimeout(() => {
                try {
                    document.removeEventListener('pointerdown', onPointerDown, true);
                    document.removeEventListener('focusin', onFocusIn, true);
                } catch (_) {}
            }, 1200);
        }

        // Feature flag: outils report√©s (Excel / Text Pro / Vision)
        // On garde le code, mais on emp√™che l'ouverture depuis l'app.
        const AXILUM_DEFERRED_TOOLS_DISABLED = true;
        
        function loadTextProModule() {
            if (typeof AXILUM_DEFERRED_TOOLS_DISABLED !== 'undefined' && AXILUM_DEFERRED_TOOLS_DISABLED) {
                try { showToast('Ce module est d√©sactiv√© pour le moment.', 'error'); } catch (_) {}
                return;
            }

            // üéØ Tracking: Utilisateur ouvre Text Pro
            AxilumContext.updateActivity('AI Text Pro', 'Agent Tony', 'Ouverture du module');
            
            if (textProModuleLoaded && typeof window.openTextProModule === 'function') {
                window.openTextProModule();
                preventTextProAutoFocus();
                return;
            }
            
            // Charger le module JavaScript s√©par√©ment
            const script = document.createElement('script');
            script.src = '/js/text-pro-module.js';
            script.onload = function() {
                textProModuleLoaded = true;
                console.log('Module Text Pro charg√©');
                if (typeof window.openTextProModule === 'function') {
                    window.openTextProModule();
                    preventTextProAutoFocus();
                } else {
                    console.error('openTextProModule non disponible');
                    // Fallback UI
                    try { openTextPro(); } catch (_) {}
                }
            };
            script.onerror = function() {
                console.error('Erreur lors du chargement du module Text Pro');
                alert('Erreur lors du chargement de Text Pro. Veuillez r√©essayer.');
            };
            document.head.appendChild(script);
        }
        
        // Ancienne fonction openTextPro (conserv√©e comme fallback)
        function openTextPro() {
            if (typeof AXILUM_DEFERRED_TOOLS_DISABLED !== 'undefined' && AXILUM_DEFERRED_TOOLS_DISABLED) {
                try { showToast('Ce module est d√©sactiv√© pour le moment.', 'error'); } catch (_) {}
                return;
            }

            // Fermer tout overlay existant
            const existingOverlay = document.getElementById('textProOverlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // Cr√©er l'overlay
            const overlay = document.createElement('div');
            overlay.id = 'textProOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #1e3a8a, #0a4d3c, #064e3b);
                z-index: 10001;
                animation: fadeIn 0.3s ease;
                overflow: hidden;
            `;
            
            overlay.innerHTML = `
                <style>
                    .textpro-container {
                        width: 100%;
                        height: 100%;
                        display: flex;
                        flex-direction: column;
                        color: white;
                    }
                    
                    .textpro-header {
                        background: rgba(0, 0, 0, 0.3);
                        padding: 24px 40px;
                        border-bottom: 1px solid rgba(59, 130, 246, 0.3);
                        backdrop-filter: blur(10px);
                        position: relative;
                    }
                    
                    .textpro-title {
                        font-size: 32px;
                        font-weight: 700;
                        background: linear-gradient(135deg, #3b82f6, #06b6d4, #10b981);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                        margin: 0 0 8px;
                        letter-spacing: -0.5px;
                    }
                    
                    .textpro-subtitle {
                        font-size: 14px;
                        color: rgba(255, 255, 255, 0.6);
                        margin: 0;
                    }
                    
                    .textpro-content {
                        flex: 1;
                        overflow-y: auto;
                        padding: 40px;
                    }
                    
                    .textpro-section {
                        max-width: 1200px;
                        margin: 0 auto 32px;
                    }
                    
                    .textpro-intro {
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(59, 130, 246, 0.3);
                        border-radius: 16px;
                        padding: 24px;
                        margin-bottom: 32px;
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .textpro-intro::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 3px;
                        background: linear-gradient(90deg, #3b82f6, #06b6d4, #10b981);
                    }
                    
                    .textpro-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                        gap: 20px;
                        margin-bottom: 32px;
                    }
                    
                    .textpro-card {
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(59, 130, 246, 0.3);
                        border-radius: 16px;
                        padding: 24px;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .textpro-card::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 3px;
                        background: linear-gradient(90deg, #3b82f6, #06b6d4);
                    }
                    
                    .textpro-card:hover {
                        background: rgba(255, 255, 255, 0.08);
                        border-color: rgba(59, 130, 246, 0.5);
                        transform: translateY(-4px);
                        box-shadow: 0 8px 30px rgba(59, 130, 246, 0.3);
                    }
                    
                    .textpro-card-title {
                        font-size: 18px;
                        font-weight: 700;
                        margin: 0 0 16px;
                        color: white;
                    }
                    
                    .textpro-card-example {
                        background: rgba(0, 0, 0, 0.2);
                        padding: 12px 16px;
                        border-radius: 8px;
                        margin-bottom: 8px;
                        font-size: 13px;
                        color: rgba(255, 255, 255, 0.7);
                        border-left: 3px solid rgba(59, 130, 246, 0.5);
                    }
                    
                    .textpro-usage {
                        background: rgba(16, 185, 129, 0.1);
                        border: 1px solid rgba(16, 185, 129, 0.3);
                        border-radius: 16px;
                        padding: 28px;
                        margin-bottom: 32px;
                    }
                    
                    .textpro-usage-title {
                        font-size: 20px;
                        font-weight: 700;
                        margin: 0 0 16px;
                        color: white;
                    }
                    
                    .textpro-usage-text {
                        font-size: 15px;
                        line-height: 1.7;
                        color: rgba(255, 255, 255, 0.8);
                        margin: 0;
                    }
                    
                    .textpro-upload-area {
                        background: rgba(255, 255, 255, 0.05);
                        border: 2px dashed rgba(59, 130, 246, 0.4);
                        border-radius: 16px;
                        padding: 32px;
                        margin-bottom: 32px;
                        text-align: center;
                        transition: all 0.3s ease;
                        cursor: pointer;
                    }
                    
                    .textpro-upload-area:hover {
                        background: rgba(255, 255, 255, 0.08);
                        border-color: rgba(59, 130, 246, 0.6);
                    }
                    
                    .textpro-upload-title {
                        font-size: 18px;
                        font-weight: 700;
                        color: white;
                        margin: 0 0 12px;
                    }
                    
                    .textpro-upload-desc {
                        font-size: 14px;
                        color: rgba(255, 255, 255, 0.6);
                        margin: 0 0 20px;
                    }
                    
                    .textpro-upload-btn {
                        display: inline-block;
                        padding: 12px 28px;
                        background: linear-gradient(135deg, #3b82f6, #06b6d4);
                        border: none;
                        border-radius: 10px;
                        color: white;
                        font-weight: 600;
                        font-size: 14px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }
                    
                    .textpro-upload-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
                    }
                    
                    .textpro-textarea {
                        width: 100%;
                        min-height: 200px;
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid rgba(59, 130, 246, 0.3);
                        border-radius: 12px;
                        padding: 16px;
                        color: white;
                        font-size: 14px;
                        font-family: inherit;
                        resize: vertical;
                        margin-bottom: 16px;
                    }
                    
                    .textpro-textarea:focus {
                        outline: none;
                        border-color: rgba(59, 130, 246, 0.6);
                        background: rgba(0, 0, 0, 0.4);
                    }
                    
                    .textpro-textarea::placeholder {
                        color: rgba(255, 255, 255, 0.4);
                    }
                    
                    .textpro-actions {
                        display: flex;
                        gap: 16px;
                        max-width: 600px;
                        margin: 0 auto;
                    }
                    
                    .textpro-btn {
                        flex: 1;
                        padding: 16px 32px;
                        background: linear-gradient(135deg, #3b82f6, #06b6d4);
                        border: none;
                        border-radius: 12px;
                        color: white;
                        font-weight: 600;
                        font-size: 15px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }
                    
                    .textpro-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
                    }
                    
                    .textpro-btn-secondary {
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                    }
                    
                    .textpro-btn-secondary:hover {
                        background: rgba(255, 255, 255, 0.15);
                        box-shadow: 0 4px 16px rgba(255, 255, 255, 0.1);
                    }
                    
                    .textpro-close-btn {
                        position: absolute;
                        top: 24px;
                        right: 40px;
                        width: 40px;
                        height: 40px;
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 10px;
                        color: white;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                        transition: all 0.3s ease;
                    }
                    
                    .textpro-close-btn:hover {
                        background: rgba(239, 68, 68, 0.2);
                        border-color: rgba(239, 68, 68, 0.5);
                        transform: scale(1.1);
                    }
                </style>
                
                <div class="textpro-container">
                    <div class="textpro-header">
                        <h1 class="textpro-title">AI Text Pro</h1>
                        <p class="textpro-subtitle">Traitement de texte professionnel intelligent</p>
                        <div class="textpro-close-btn" onclick="closeTextPro()">√ó</div>
                    </div>
                    
                    <div class="textpro-content">
                        <div class="textpro-section">
                            <div class="textpro-intro">
                                <p style="margin: 0; font-size: 15px; line-height: 1.7; color: rgba(255, 255, 255, 0.85);">
                                    Outils professionnels de traitement de texte. Traduction, r√©√©criture, correction, r√©sum√© et bien plus.
                                </p>
                            </div>
                            
                            <div class="textpro-usage">
                                <h3 class="textpro-usage-title">Utilisation ultra-simple</h3>
                                <p class="textpro-usage-text">
                                    Collez votre texte dans le chat et demandez ce que vous voulez faire. L'IA applique automatiquement le traitement et vous retourne le r√©sultat dans le chat. Vous pouvez v√©rifier, demander des modifications ou accepter. L'IA cr√©era alors un fichier PDF t√©l√©chargeable.
                                </p>
                            </div>
                            
                            <div class="textpro-upload-area" id="textProUploadArea">
                                <h3 class="textpro-upload-title">Collez ou uploadez votre texte</h3>
                                <p class="textpro-upload-desc">Collez directement votre texte ci-dessous ou uploadez un fichier (.txt, .pdf, .docx)</p>
                                
                                <textarea id="textProTextarea" class="textpro-textarea" placeholder="Collez votre texte ici..."></textarea>
                                
                                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                                    <button class="textpro-upload-btn" onclick="document.getElementById('textProFileInput').click()">
                                        Choisir un fichier
                                    </button>
                                    <input type="file" id="textProFileInput" accept=".txt,.pdf,.doc,.docx" style="display: none;" onchange="handleTextProFileUpload(event)">
                                    
                                    <button class="textpro-upload-btn" onclick="sendTextToChat()">
                                        Envoyer au chat
                                    </button>
                                </div>
                                
                                <div id="textProFileName" style="margin-top: 12px; font-size: 13px; color: rgba(255, 255, 255, 0.6);"></div>
                            </div>
                            
                            <div class="textpro-grid">
                                <div class="textpro-card">
                                    <h4 class="textpro-card-title">Traduction Professionnelle</h4>
                                    <div class="textpro-card-example">Traduis ce texte en anglais professionnel</div>
                                    <div class="textpro-card-example">Traduis en espagnol en gardant le ton formel</div>
                                </div>
                                
                                <div class="textpro-card">
                                    <h4 class="textpro-card-title">R√©√©criture & Reformulation</h4>
                                    <div class="textpro-card-example">R√©√©cris ce texte de fa√ßon plus formelle</div>
                                    <div class="textpro-card-example">Rends ce message plus convivial</div>
                                </div>
                                
                                <div class="textpro-card">
                                    <h4 class="textpro-card-title">Correction Avanc√©e</h4>
                                    <div class="textpro-card-example">Corrige l'orthographe et la grammaire</div>
                                    <div class="textpro-card-example">Am√©liore le style de ce texte</div>
                                </div>
                                
                                <div class="textpro-card">
                                    <h4 class="textpro-card-title">R√©sum√© Intelligent</h4>
                                    <div class="textpro-card-example">R√©sume ce texte en 3 points cl√©s</div>
                                    <div class="textpro-card-example">Fais un r√©sum√© ex√©cutif de ce rapport</div>
                                </div>
                                
                                <div class="textpro-card">
                                    <h4 class="textpro-card-title">G√©n√©ration de Contenu</h4>
                                    <div class="textpro-card-example">√âcris un email professionnel de demande de cong√©</div>
                                    <div class="textpro-card-example">R√©dige une lettre de motivation</div>
                                </div>
                                
                                <div class="textpro-card">
                                    <h4 class="textpro-card-title">Analyse de Texte</h4>
                                    <div class="textpro-card-example">Analyse le sentiment de ce message</div>
                                    <div class="textpro-card-example">Extrais les mots-cl√©s principaux</div>
                                </div>
                                
                                <div class="textpro-card">
                                    <h4 class="textpro-card-title">Transformation de Format</h4>
                                    <div class="textpro-card-example">Transforme cette liste en paragraphe structur√©</div>
                                    <div class="textpro-card-example">Convertis ces notes en email formel</div>
                                </div>
                                
                                <div class="textpro-card">
                                    <h4 class="textpro-card-title">Enrichissement</h4>
                                    <div class="textpro-card-example">Enrichis ce texte avec du vocabulaire professionnel</div>
                                    <div class="textpro-card-example">Am√©liore cette phrase avec des synonymes</div>
                                </div>
                            </div>
                            
                            <div class="textpro-actions">
                                <button class="textpro-btn" onclick="closeTextPro(); setTimeout(() => document.getElementById('userInput')?.focus(), 300);">
                                    Commencer √† utiliser
                                </button>
                                <button class="textpro-btn textpro-btn-secondary" onclick="closeTextPro()">
                                    Fermer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        function closeTextPro() {
            const overlay = document.getElementById('textProOverlay');
            if (overlay) {
                overlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => overlay.remove(), 300);
            }
        }
        
        function handleTextProFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileNameDiv = document.getElementById('textProFileName');
            fileNameDiv.textContent = `Fichier s√©lectionn√©: ${file.name}`;

            try {
                localStorage.setItem('textPro_lastFileName', String(file.name || ''));
                localStorage.setItem('textPro_lastUpdated', new Date().toISOString());
            } catch (_) {}
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                document.getElementById('textProTextarea').value = content;
            };
            
            // Lire le fichier comme texte
            if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                reader.readAsText(file);
            } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                fileNameDiv.textContent = `Fichier PDF d√©tect√©: ${file.name} - Les fichiers PDF n√©cessitent un traitement sp√©cial. Collez le texte manuellement.`;
            } else {
                fileNameDiv.textContent = `Type de fichier: ${file.name} - Collez le contenu manuellement dans la zone de texte.`;
            }
        }
        
        function sendTextToChat() {
            const textarea = document.getElementById('textProTextarea');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('Veuillez d\'abord coller ou uploader du texte.');
                return;
            }

            // Persister un snapshot minimal pour que /agent tony puisse r√©cup√©rer le contexte
            try {
                localStorage.setItem('textPro_lastText', text);
                localStorage.setItem('textPro_lastUpdated', new Date().toISOString());
                const fileInput = document.getElementById('textProFileInput');
                const fileName = (fileInput && fileInput.files && fileInput.files[0] && fileInput.files[0].name) ? String(fileInput.files[0].name) : '';
                if (fileName) localStorage.setItem('textPro_lastFileName', fileName);
            } catch (_) {}
            
            // Envoyer le texte au chat
            const messageInput = document.getElementById('userInput');
            if (messageInput) {
                messageInput.value = `Voici le texte √† traiter:\n\n${text}\n\nQue souhaitez-vous faire avec ce texte?`;
                
                // Fermer l'overlay
                closeTextPro();
                
                // Focus sur le champ de message
                setTimeout(() => {
                    messageInput.focus();
                    messageInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 400);
            }
        }

        // Excel AI - Variables globales
        let excelCurrentFile = null;
        let excelSheetData = [];
        let excelColumns = [];
        let excelActionHistory = [];
        let excelChatHistory = [];
        let excelAiProcessing = false;
        let excelContextSent = false;  // Flag pour savoir si le contexte Excel a √©t√© envoy√©

        // ‚ö†Ô∏è FONCTIONS EXCEL - DOIVENT √äTRE D√âFINIES AVANT openExcelPro() car appel√©es dans les onclick/onblur
        
        function closeExcelAi() {
            const overlay = document.getElementById('excelAiOverlay');
            if (overlay) {
                overlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => overlay.remove(), 300);
            }
        }
        
        // ========== GESTION RH ==========
        
        // Chargement modulaire du module HR
        let hrModuleLoaded = false;
        
        function loadHRModule() {
            // üéØ Tracking: Utilisateur ouvre HR Management
            AxilumContext.updateActivity('HR Management Hub', 'Agent RH', 'Ouverture du module');
            
            // Si le module est d√©j√† charg√© et les fonctions disponibles
            if (hrModuleLoaded && typeof openHRManagement === 'function') {
                openHRManagement();
                return;
            }
            
            // Charger le wrapper module
            const script = document.createElement('script');
            script.src = '/js/hr-module.js';
            script.onload = function() {
                hrModuleLoaded = true;
                console.log('Module HR wrapper charg√©');
                // Appeler directement openHRManagement qui est d√©j√† dans index.html
                if (typeof openHRManagement === 'function') {
                    openHRManagement();
                } else {
                    console.error('openHRManagement non disponible');
                    alert('Erreur lors de l\'ouverture de la Gestion RH');
                }
            };
            script.onerror = function() {
                console.error('Erreur lors du chargement du module HR');
                // Fallback: essayer d'appeler directement la fonction
                if (typeof openHRManagement === 'function') {
                    openHRManagement();
                } else {
                    alert('Erreur lors du chargement de la Gestion RH. Veuillez r√©essayer.');
                }
            };
            document.head.appendChild(script);
        }
        
        // Helper functions pour lier les donn√©es RH √† l'utilisateur connect√©
        function getHRStorageKey(dataType) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!currentUser || !currentUser.email) {
                return dataType; // Fallback pour les donn√©es non li√©es √† un utilisateur
            }
            return `${dataType}_${currentUser.email}`;
        }
        
        function getHRData(dataType, defaultValue = []) {
            const key = getHRStorageKey(dataType);
            return JSON.parse(localStorage.getItem(key) || JSON.stringify(defaultValue));
        }
        
        function setHRData(dataType, data) {
            const key = getHRStorageKey(dataType);
            localStorage.setItem(key, JSON.stringify(data));

            // Invalidation l√©g√®re du cache UI RH (√©viter re-render complet √† chaque retour)
            try {
                if (!window.__hrUiState) window.__hrUiState = { activeTab: null, activeContentId: null, activeTabId: null, rendered: {}, dirty: {} };

                // Petit cache en m√©moire pour √©viter des relectures localStorage fr√©quentes
                if (dataType === 'companySettings') {
                    window.__hrUiState.companySettings = data;
                }

                const hrTabs = ['dashboard', 'employees', 'leaves', 'payroll', 'reviews', 'turnover', 'recruitment'];
                const markDirty = (tab) => { window.__hrUiState.dirty[tab] = true; };

                if (dataType === 'hrEmployees') {
                    // Les employ√©s alimentent plusieurs onglets (dropdowns, stats)
                    hrTabs.forEach(markDirty);
                } else if (dataType === 'hrLeaves') {
                    markDirty('dashboard');
                    markDirty('leaves');
                } else if (dataType === 'hrPayrolls') {
                    markDirty('dashboard');
                    markDirty('payroll');
                } else if (dataType === 'hrReviews') {
                    markDirty('dashboard');
                    markDirty('reviews');
                } else if (dataType === 'recruitmentJobs' || dataType === 'recruitmentCandidates') {
                    markDirty('dashboard');
                    markDirty('recruitment');
                } else if (dataType === 'companySettings') {
                    // Peut impacter des libell√©s/param√®tres et certaines stats
                    markDirty('dashboard');
                }
            } catch (e) {
                // ignore
            }
        }

        function showHRHelp() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const isEn = (lang === 'en');
            
            const existingHelp = document.getElementById('hr-help-modal');
            if (existingHelp) existingHelp.remove();
            
            const helpModal = document.createElement('div');
            helpModal.id = 'hr-help-modal';
            helpModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                z-index: 10002;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                backdrop-filter: blur(5px);
                animation: fadeIn 0.2s ease-out;
            `;
            
            const title = isEn ? 'Agent RH User Guide' : 'Guide Complet Agent RH';
            const subtitle = isEn ? 'Master Human Resources Management' : 'Ma√Ætriser la Gestion RH';
            const closeText = isEn ? 'Close Guide' : 'Fermer le guide';
            
            const contentFr = `
                <h3>1. Introduction</h3>
                <p><strong>Agent RH</strong> est votre assistant sp√©cialis√© en gestion des ressources humaines, paie et d√©veloppement des talents.</p>
                
                <h3>2. Fonctionnalit√©s Cl√©s</h3>
                <ul>
                    <li><strong>Employ√©s :</strong> Gestion des dossiers du personnel et organigramme.</li>
                    <li><strong>Paie :</strong> Automatisation des fiches de paie et calculs.</li>
                    <li><strong>Cong√©s :</strong> Suivi des demandes et soldes.</li>
                    <li><strong>Recrutement :</strong> Suivi des candidats et entretiens.</li>
                </ul>
                
                <h3>3. Commandes Utiles</h3>
                <ul>
                    <li><code>/employe [nom]</code> : Voir le dossier d'un employ√©.</li>
                    <li><code>/paie [mois]</code> : G√©n√©rer les fiches de paie.</li>
                    <li><code>/conges</code> : Analyser le planning des absences.</li>
                </ul>
                
                <h3>4. Astuces</h3>
                <p>Utilisez l'Agent RH pour r√©diger des offres d'emploi ou pr√©parer des entretiens annuels.</p>
            `;
            
            const contentEn = `
                <h3>1. Introduction</h3>
                <p><strong>Agent RH</strong> is your specialized assistant for HR management, payroll, and talent development.</p>
                
                <h3>2. Key Features</h3>
                <ul>
                    <li><strong>Employees:</strong> Manage staff records and org chart.</li>
                    <li><strong>Payroll:</strong> Automate payslips and calculations.</li>
                    <li><strong>Leaves:</strong> Track requests and balances.</li>
                    <li><strong>Recruitment:</strong> Track candidates and interviews.</li>
                </ul>
                
                <h3>3. Useful Commands</h3>
                <ul>
                    <li><code>/employee [name]</code> : View employee file.</li>
                    <li><code>/payroll [month]</code> : Generate payslips.</li>
                    <li><code>/leaves</code> : Analyze absence schedule.</li>
                </ul>
                
                <h3>4. Tips</h3>
                <p>Use Agent RH to draft job offers or prepare annual reviews.</p>
            `;

            helpModal.innerHTML = `
                <div style="
                    background: #022c22;
                    width: 100%;
                    max-width: 700px;
                    max-height: 85vh;
                    border-radius: 16px;
                    border: 1px solid rgba(16, 185, 129, 0.3);
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                    overflow: hidden;
                ">
                    <div style="
                        padding: 24px;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                        background: rgba(16, 185, 129, 0.1);
                        display: flex;
                        justify-content: space-between;
                        align-items: start;
                    ">
                        <div>
                            <h2 style="margin: 0; font-size: 24px; color: white;">${title}</h2>
                            <p style="margin: 4px 0 0; color: rgba(255, 255, 255, 0.6);">${subtitle}</p>
                        </div>
                        <button onclick="document.getElementById('hr-help-modal').remove()" style="
                            background: none;
                            border: none;
                            color: rgba(255, 255, 255, 0.5);
                            cursor: pointer;
                            padding: 4px;
                        ">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <div style="
                        padding: 32px;
                        overflow-y: auto;
                        color: rgba(255, 255, 255, 0.9);
                        line-height: 1.6;
                        font-family: inherit;
                    ">
                        <style>
                            #hr-help-modal h3 { color: #34d399; margin-top: 24px; margin-bottom: 12px; font-size: 18px; }
                            #hr-help-modal h3:first-child { margin-top: 0; }
                            #hr-help-modal ul { padding-left: 20px; margin-bottom: 16px; }
                            #hr-help-modal li { margin-bottom: 8px; }
                            #hr-help-modal code { background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #6ee7b7; }
                            #hr-help-modal p { margin-bottom: 16px; }
                        </style>
                        ${isEn ? contentEn : contentFr}
                    </div>
                    <div style="
                        padding: 20px 24px;
                        border-top: 1px solid rgba(255, 255, 255, 0.1);
                        background: rgba(0, 0, 0, 0.2);
                        display: flex;
                        justify-content: flex-end;
                    ">
                        <button onclick="document.getElementById('hr-help-modal').remove()" style="
                            padding: 10px 20px;
                            background: linear-gradient(135deg, #10b981, #06b6d4);
                            border: none;
                            border-radius: 8px;
                            color: white;
                            font-weight: 600;
                            cursor: pointer;
                        ">${closeText}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpModal);
            
            // Close on click outside
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    helpModal.remove();
                }
            });
        }
        
        function openHRManagement() {
            // Fermer AI Management s'il est ouvert
            const excelAiOverlay = document.getElementById('excelAiOverlay');
            if (excelAiOverlay) {
                excelAiOverlay.remove();
            }
            
            // Fermer l'overlay RH existant s'il y en a un
            const existingOverlay = document.getElementById('hrManagementOverlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // Cr√©er l'overlay RH
            const overlay = document.createElement('div');
            overlay.id = 'hrManagementOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #0a4d3c, #064e3b, #1e3a8a);
                background-attachment: fixed;
                z-index: 10001;
                animation: fadeIn 0.3s ease;
                overflow: hidden;
            `;
            
            overlay.innerHTML = `
                <style>
                    .hr-container {
                        width: 100%;
                        height: 100%;
                        display: flex;
                        flex-direction: column;
                        color: white;
                        min-height: 0;
                    }
                    
                    .hr-header {
                        background: rgba(0, 0, 0, 0.3);
                        padding: 24px 40px;
                        border-bottom: 1px solid rgba(16, 185, 129, 0.3);
                        backdrop-filter: blur(10px);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    
                    .hr-header-actions {
                        display: flex;
                        gap: 12px;
                    }
                    
                    .hr-title {
                        font-size: 32px;
                        font-weight: 700;
                        background: linear-gradient(135deg, #10b981, #06b6d4, #3b82f6);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                        margin: 0 0 8px;
                        letter-spacing: -0.5px;
                    }
                    
                    .hr-subtitle {
                        font-size: 14px;
                        color: rgba(255, 255, 255, 0.6);
                        margin: 0;
                    }
                    
                    .hr-tabs {
                        display: flex;
                        gap: 8px;
                        padding: 20px 40px;
                        background: rgba(0, 0, 0, 0.2);
                        border-bottom: 1px solid rgba(16, 185, 129, 0.2);
                        overflow-x: auto;
                    }
                    
                    .hr-tab {
                        padding: 12px 24px;
                        background: rgba(16, 185, 129, 0.1);
                        border: 1px solid rgba(16, 185, 129, 0.3);
                        border-radius: 8px;
                        color: rgba(255, 255, 255, 0.7);
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-weight: 600;
                        font-size: 14px;
                        white-space: nowrap;
                    }
                    
                    .hr-tab:hover {
                        background: rgba(16, 185, 129, 0.2);
                        border-color: rgba(16, 185, 129, 0.5);
                        color: white;
                        transform: translateY(-2px);
                    }
                    
                    .hr-tab.active {
                        background: linear-gradient(135deg, #10b981, #06b6d4);
                        border-color: transparent;
                        color: white;
                        box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
                    }
                    
                    .hr-content-area {
                        flex: 1;
                        overflow-y: auto;
                        padding: 40px;
                        min-height: 0;
                        -webkit-overflow-scrolling: touch;
                        overscroll-behavior: contain;
                    }
                    
                    /* Tous les contenus d'onglet HR */
                    .hr-content {
                        flex-grow: 0;
                        flex-shrink: 0;
                    }
                    
                    /* Agent RH: comportement standard (comme RND) */
                    #hrContentAgent {
                        display: none;
                    }
                    
                    .hr-stat-card {
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(16, 185, 129, 0.3);
                        border-radius: 16px;
                        padding: 24px;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .hr-stat-card::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 3px;
                        background: linear-gradient(90deg, #10b981, #06b6d4, #3b82f6);
                    }
                    
                    .hr-stat-card:hover {
                        background: rgba(255, 255, 255, 0.08);
                        border-color: rgba(16, 185, 129, 0.5);
                        transform: translateY(-4px);
                        box-shadow: 0 8px 30px rgba(16, 185, 129, 0.3);
                    }
                    
                    .hr-stat-value {
                        font-size: 40px;
                        font-weight: 700;
                        margin: 0 0 8px;
                        background: linear-gradient(135deg, #10b981, #06b6d4);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                    }
                    
                    .hr-stat-label {
                        font-size: 13px;
                        color: rgba(255, 255, 255, 0.6);
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        font-weight: 600;
                    }
                    
                    .hr-btn {
                        padding: 12px 24px;
                        background: linear-gradient(135deg, #10b981, #06b6d4);
                        border: none;
                        border-radius: 8px;
                        color: white;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-size: 14px;
                    }
                    
                    .hr-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
                    }
                    
                    /* HR buttons: avoid green flash on click */
                    .hr-btn, .hr-tab, .hr-close-btn, #hrManagementOverlay button {
                        -webkit-tap-highlight-color: transparent;
                    }
                    
                    .hr-btn:focus, .hr-tab:focus, .hr-close-btn:focus, #hrManagementOverlay button:focus {
                        outline: none;
                    }
                    
                    .hr-btn:active, .hr-tab:active, .hr-close-btn:active, #hrManagementOverlay button:active {
                        outline: none;
                    }
                    
                    .hr-close-btn {
                        width: 40px;
                        height: 40px;
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }
                    
                    .hr-close-btn:hover {
                        background: rgba(239, 68, 68, 0.2);
                        border-color: rgba(239, 68, 68, 0.5);
                        transform: rotate(90deg);
                    }

                    .hr-help-btn {
                        width: 40px;
                        height: 40px;
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }

                    .hr-help-btn:hover {
                         background: rgba(255, 255, 255, 0.1);
                         border-color: rgba(255, 255, 255, 0.3);
                    }
                    
                    .hr-section {
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(16, 185, 129, 0.2);
                        border-radius: 16px;
                        padding: 24px;
                        margin-bottom: 24px;
                    }
                    
                    .hr-section-title {
                        font-size: 20px;
                        font-weight: 700;
                        color: white;
                        margin: 0 0 20px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }
                    
                    .hr-section-title::before {
                        content: '';
                        width: 4px;
                        height: 24px;
                        background: linear-gradient(180deg, #10b981, #06b6d4);
                        border-radius: 2px;
                    }
                    
                    .hr-item {
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid rgba(16, 185, 129, 0.2);
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 16px;
                        transition: all 0.3s ease;
                    }
                    
                    .hr-item:hover {
                        border-color: rgba(16, 185, 129, 0.5);
                        background: rgba(0, 0, 0, 0.4);
                        transform: translateX(4px);
                    }
                    
                    .hr-badge {
                        display: inline-block;
                        padding: 4px 12px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    
                    .hr-badge-success {
                        background: rgba(16, 185, 129, 0.2);
                        color: #6ee7b7;
                        border: 1px solid rgba(16, 185, 129, 0.3);
                    }
                    
                    .hr-badge-warning {
                        background: rgba(251, 191, 36, 0.2);
                        color: #fcd34d;
                        border: 1px solid rgba(251, 191, 36, 0.3);
                    }
                    
                    .hr-badge-danger {
                        background: rgba(239, 68, 68, 0.2);
                        color: #fca5a5;
                        border: 1px solid rgba(239, 68, 68, 0.3);
                    }
                    
                    .hr-badge-info {
                        background: rgba(59, 130, 246, 0.2);
                        color: #93c5fd;
                        border: 1px solid rgba(59, 130, 246, 0.3);
                    }
                    
                    .hr-empty {
                        text-align: center;
                        padding: 60px 20px;
                        color: rgba(255, 255, 255, 0.5);
                    }
                    
                    .hr-empty-title {
                        font-size: 18px;
                        font-weight: 600;
                        margin: 0 0 8px;
                        color: rgba(255, 255, 255, 0.7);
                    }

                    /* Chat Agent RH (align√© sur Dev/Mark) */
                    .hr-chat-container {
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid rgba(16, 185, 129, 0.3);
                        border-radius: 16px;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                        height: 500px;
                    }

                    .hr-chat-messages {
                        flex: 1;
                        overflow-y: auto;
                        min-height: 0;
                        padding: 20px;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }

                    .hr-chat-messages, .hr-chat-messages * {
                        overflow-wrap: anywhere;
                        word-break: break-word;
                    }

                    .hr-chat-input {
                        display: flex;
                        gap: 10px;
                        padding: 16px;
                        border-top: 1px solid rgba(255, 255, 255, 0.10);
                        background: rgba(0, 0, 0, 0.10);
                    }

                    .hr-input {
                        flex: 1;
                        min-width: 0;
                        padding: 12px 14px;
                        background: rgba(255, 255, 255, 0.06);
                        border: 1px solid rgba(16, 185, 129, 0.3);
                        border-radius: 10px;
                        color: white;
                        font-size: 14px;
                        transition: border-color 0.2s ease, background 0.2s ease;
                    }

                    .hr-input:focus {
                        outline: none;
                        border-color: rgba(16, 185, 129, 0.5);
                        background: rgba(255, 255, 255, 0.1);
                    }

                    /* Recruitment - Cards & Modals (coh√©rence HR) */
                    .hr-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.55);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10003;
                        overflow-y: auto;
                        padding: 20px;
                    }

                    .hr-modal {
                        background: rgba(255, 255, 255, 0.06);
                        border: 1px solid rgba(16, 185, 129, 0.25);
                        border-radius: 20px;
                        padding: 28px;
                        max-width: 860px;
                        width: 100%;
                        max-height: 90vh;
                        overflow-y: auto;
                        backdrop-filter: blur(14px);
                        color: white;
                        position: relative;
                    }

                    .hr-modal-title {
                        margin: 0;
                        font-size: 22px;
                        font-weight: 800;
                        color: white;
                    }

                    .hr-modal-subtitle {
                        margin: 6px 0 0;
                        font-size: 13px;
                        color: rgba(255,255,255,0.7);
                        line-height: 1.5;
                    }

                    .hr-modal-close {
                        position: absolute;
                        top: 16px;
                        right: 16px;
                        width: 40px;
                        height: 40px;
                        background: rgba(255,255,255,0.08);
                        border: 1px solid rgba(255,255,255,0.16);
                        border-radius: 12px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s ease;
                    }

                    .hr-modal-close:hover {
                        background: rgba(239, 68, 68, 0.18);
                        border-color: rgba(239, 68, 68, 0.35);
                    }

                    .hr-form-grid-2 {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 16px;
                    }

                    .hr-input,
                    .hr-select,
                    .hr-textarea {
                        width: 100%;
                        padding: 12px;
                        background: rgba(255,255,255,0.08);
                        border: 1px solid rgba(16, 185, 129, 0.25);
                        border-radius: 12px;
                        font-size: 14px;
                        color: white;
                        outline: none;
                        transition: all 0.2s ease;
                    }

                    .hr-textarea {
                        font-family: inherit;
                        resize: vertical;
                    }

                    .hr-input::placeholder,
                    .hr-textarea::placeholder {
                        color: rgba(255,255,255,0.5);
                    }

                    .hr-input:focus,
                    .hr-select:focus,
                    .hr-textarea:focus {
                        border-color: rgba(16, 185, 129, 0.55);
                        background: rgba(255,255,255,0.10);
                        box-shadow: 0 0 0 3px rgba(16,185,129,0.14);
                    }

                    .hr-btn-secondary {
                        background: rgba(255,255,255,0.10);
                        border: 1px solid rgba(255,255,255,0.18);
                    }

                    .hr-btn-secondary:hover {
                        box-shadow: 0 8px 20px rgba(0,0,0,0.25);
                    }

                    .hr-candidate-card {
                        cursor: pointer;
                        display: grid;
                        gap: 14px;
                    }

                    .hr-candidate-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        gap: 12px;
                    }

                    .hr-candidate-name {
                        margin: 0 0 4px;
                        font-size: 16px;
                        font-weight: 800;
                        color: white;
                    }

                    .hr-candidate-email {
                        margin: 0;
                        font-size: 12px;
                        color: rgba(255,255,255,0.65);
                        word-break: break-word;
                    }

                    .hr-candidate-job {
                        background: rgba(0, 0, 0, 0.28);
                        border: 1px solid rgba(16, 185, 129, 0.18);
                        border-radius: 12px;
                        padding: 12px;
                    }

                    .hr-candidate-job-label {
                        font-size: 11px;
                        color: rgba(255,255,255,0.55);
                        margin-bottom: 6px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        font-weight: 700;
                    }

                    .hr-candidate-job-title {
                        font-size: 13px;
                        font-weight: 700;
                        color: rgba(255,255,255,0.9);
                    }

                    .hr-candidate-metrics {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 10px;
                    }

                    .hr-candidate-metric {
                        background: rgba(255,255,255,0.05);
                        border: 1px solid rgba(16, 185, 129, 0.15);
                        border-radius: 12px;
                        padding: 10px;
                        text-align: center;
                    }

                    .hr-candidate-metric-value {
                        font-size: 16px;
                        font-weight: 800;
                        margin-bottom: 4px;
                    }

                    .hr-candidate-metric-label {
                        font-size: 11px;
                        color: rgba(255,255,255,0.55);
                        font-weight: 700;
                    }

                    @media (max-width: 768px) {
                        .hr-form-grid-2 {
                            grid-template-columns: 1fr;
                        }
                        .hr-candidate-metrics {
                            grid-template-columns: repeat(2, 1fr);
                        }
                    }

                    @media (max-width: 480px) {
                        .hr-modal {
                            padding: 20px;
                            border-radius: 16px;
                        }
                        .hr-candidate-header {
                            flex-direction: column;
                            align-items: stretch;
                        }
                        .hr-candidate-metrics {
                            grid-template-columns: 1fr;
                        }
                    }
                    
                    /* Responsive Design - Mode Bureau Mobile & Tablette */
                    @media (max-width: 1200px) {
                        .hr-content-area {
                            padding: 30px;
                        }
                        .hr-header {
                            padding: 20px 30px;
                        }
                        .hr-tabs {
                            padding: 16px 30px;
                        }
                        .hr-title {
                            font-size: 28px;
                        }
                        .hr-stat-value {
                            font-size: 36px;
                        }
                    }
                    
                    @media (max-width: 768px) {
                        .hr-header {
                            padding: 16px 20px;
                        }
                        .hr-title {
                            font-size: 24px;
                        }
                        .hr-subtitle {
                            font-size: 12px;
                        }
                        .hr-close-btn {
                            width: 36px;
                            height: 36px;
                        }
                        .hr-help-btn {
                            width: 36px;
                            height: 36px;
                        }
                        .hr-tabs {
                            padding: 12px 20px;
                            gap: 6px;
                            overflow-x: auto;
                            -webkit-overflow-scrolling: touch;
                        }
                        .hr-tab {
                            padding: 10px 16px;
                            font-size: 13px;
                            white-space: nowrap;
                            flex-shrink: 0;
                        }
                        .hr-content-area {
                            padding: 20px;
                        }
                        .hr-section {
                            padding: 16px;
                            margin-bottom: 16px;
                        }
                        .hr-section-title {
                            font-size: 18px;
                        }
                        .hr-item {
                            padding: 16px;
                        }
                        .hr-stat-card {
                            padding: 20px;
                        }
                        .hr-stat-value {
                            font-size: 32px;
                        }
                        .hr-stat-label {
                            font-size: 12px;
                        }
                        .hr-btn {
                            padding: 10px 20px;
                            font-size: 13px;
                        }
                    }

                    /* Mobile en mode "site desktop" (largeur grande mais device tactile)
                       -> compacter header/tabs pour √©viter que le chat soit pouss√© vers le bas */
                    @media (hover: none) and (pointer: coarse) {
                        .hr-header {
                            padding: 14px 16px !important;
                        }
                        .hr-title {
                            font-size: 22px !important;
                            margin-bottom: 4px !important;
                        }
                        .hr-subtitle {
                            display: none !important;
                        }
                        .hr-close-btn {
                            width: 36px !important;
                            height: 36px !important;
                        }
                        .hr-help-btn {
                            width: 36px !important;
                            height: 36px !important;
                        }
                        .hr-tabs {
                            padding: 10px 16px !important;
                            gap: 6px !important;
                            overflow-x: auto;
                            -webkit-overflow-scrolling: touch;
                        }
                        .hr-tab {
                            padding: 10px 14px !important;
                            font-size: 13px !important;
                            flex-shrink: 0;
                        }
                        .hr-content-area {
                            padding: 16px !important;
                        }

                        /* Agent RH: zone messages responsive (√©vite hauteur fixe trop grande) */
                        /* Note: Ne pas forcer display: flex ici, sinon √ßa √©crase le display: none */
                        #hrContentAgent[style*="display: block"], #hrContentAgent:not([style*="display: none"]):not([style]) {
                            flex-direction: column;
                            min-height: 0;
                        }
                        #hrContentAgent > div:first-child {
                            margin-bottom: 12px !important;
                        }
                        #hrContentAgent .hr-chat-container {
                            height: 450px;
                        }
                        #hrChatMessages {
                            flex: 1;
                            min-height: 0;
                        }
                    }

                    /* Mobile: Standard layout (behavior patched) */
                    @media (max-width: 768px) {

                        /* Mobile: Agent RH - garder les tabs visibles (comme R&D) */
                        #hrContentAgent .hr-agent-header {
                            flex-shrink: 0;
                        }
                        #hrContentAgent .hr-chat-container {
                            height: 400px;
                            min-height: 300px;
                            display: flex;
                            flex-direction: column;
                        }
                        #hrContentAgent #hrChatMessages {
                            flex: 1;
                            min-height: 0;
                        }
                        #hrContentAgent .hr-chat-input {
                            padding: 14px !important;
                            flex-shrink: 0;
                        }
                    }

                    /* Paysage / faible hauteur: scroll global plus fiable */
                    @media (max-height: 520px) and (orientation: landscape) {
                    }
                    
                    @media (max-width: 480px) {
                        .hr-header {
                            padding: 12px 16px;
                        }
                        .hr-title {
                            font-size: 20px;
                        }
                        .hr-subtitle {
                            display: none;
                        }
                        .hr-close-btn {
                            width: 32px;
                            height: 32px;
                        }
                        .hr-help-btn {
                            width: 32px;
                            height: 32px;
                        }
                        .hr-tabs {
                            padding: 10px 16px;
                            gap: 4px;
                        }
                        .hr-tab {
                            padding: 8px 12px;
                            font-size: 12px;
                        }
                        .hr-content-area {
                            padding: 16px;
                        }
                        .hr-section {
                            padding: 12px;
                            margin-bottom: 12px;
                            border-radius: 12px;
                        }
                        .hr-section-title {
                            font-size: 16px;
                        }
                        .hr-section-title::before {
                            width: 3px;
                            height: 20px;
                        }
                        .hr-item {
                            padding: 12px;
                            margin-bottom: 12px;
                        }
                        .hr-stat-card {
                            padding: 16px;
                        }
                        .hr-stat-value {
                            font-size: 28px;
                        }
                        .hr-stat-label {
                            font-size: 11px;
                        }
                        .hr-btn {
                            padding: 8px 16px;
                            font-size: 12px;
                        }
                        .hr-badge {
                            padding: 3px 8px;
                            font-size: 10px;
                        }
                    }
                    
                    /* Responsive pour le chat Agent RH (align√© sur Agent dev/mark) */
                    @media (max-width: 768px) {
                        #hrContentAgent .hr-chat-container {
                            height: 65vh;
                            min-height: 380px;
                        }
                        #hrContentAgent .hr-chat-messages {
                            padding: 16px !important;
                        }
                        #hrContentAgent .hr-chat-input {
                            padding: 14px !important;
                        }
                    }

                    @media (max-width: 480px) {
                        #hrChatInput {
                            font-size: 13px !important;
                            padding: 10px 12px !important;
                        }
                        #hrContentAgent .hr-chat-input {
                            flex-direction: column !important;
                            align-items: stretch !important;
                            gap: 10px !important;
                        }
                    }
                    
                    /* Responsive pour le panneau Employ√©s */
                    @media (max-width: 1200px) {
                        #hrContentEmployees > div > div {
                            max-width: 100% !important;
                            padding-top: 10px !important;
                        }
                        #hrContentEmployees h2 {
                            font-size: 24px !important;
                        }
                    }
                    
                    @media (max-width: 768px) {
                        #hrContentEmployees > div {
                            padding: 16px !important;
                        }
                        #hrContentEmployees > div > div {
                            padding-top: 0 !important;
                        }
                        #hrContentEmployees h2 {
                            font-size: 22px !important;
                        }
                        #hrContentEmployees p {
                            font-size: 13px !important;
                        }
                        #hrContentEmployees > div > div > div:first-child {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            gap: 16px !important;
                        }
                        #hrContentEmployees > div > div > div:first-child > div:last-child {
                            width: 100% !important;
                            flex-direction: column !important;
                        }
                        #hrContentEmployees > div > div > div:first-child button {
                            width: 100% !important;
                            justify-content: center !important;
                        }
                        #hrContentEmployees > div > div > div:nth-child(2) > div:last-child {
                            grid-template-columns: 1fr !important;
                            gap: 10px !important;
                        }
                        #hrContentEmployees input,
                        #hrContentEmployees select {
                            font-size: 13px !important;
                            padding: 10px 12px !important;
                        }
                        #employeesList {
                            padding: 20px !important;
                        }
                        /* Table des employ√©s responsive */
                        #employeesList table {
                            font-size: 13px !important;
                        }
                        #employeesList table th {
                            font-size: 11px !important;
                            padding: 10px !important;
                        }
                        #employeesList table td {
                            padding: 12px !important;
                        }
                        #employeesList table td > div > div:first-child {
                            width: 36px !important;
                            height: 36px !important;
                            font-size: 14px !important;
                        }
                        #employeesList table button {
                            padding: 5px 10px !important;
                            font-size: 11px !important;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        #hrContentEmployees > div {
                            padding: 12px !important;
                        }
                        #hrContentEmployees h2 {
                            font-size: 18px !important;
                        }
                        #hrContentEmployees h3 {
                            font-size: 14px !important;
                        }
                        #hrContentEmployees p {
                            font-size: 12px !important;
                        }
                        #hrContentEmployees > div > div > div:nth-child(2) {
                            padding: 16px !important;
                        }
                        #hrContentEmployees > div > div > div:nth-child(2) h3 {
                            margin-bottom: 12px !important;
                        }
                        #hrContentEmployees input,
                        #hrContentEmployees select {
                            font-size: 12px !important;
                            padding: 8px 10px !important;
                        }
                        #hrContentEmployees button {
                            padding: 10px 16px !important;
                            font-size: 12px !important;
                        }
                        #employeesList {
                            padding: 16px !important;
                            min-height: 300px !important;
                        }
                        /* Table des employ√©s tr√®s petits √©crans */
                        #employeesList > div {
                            overflow-x: auto !important;
                            -webkit-overflow-scrolling: touch !important;
                        }
                        #employeesList table {
                            font-size: 11px !important;
                            min-width: 600px !important;
                        }
                        #employeesList table th {
                            font-size: 10px !important;
                            padding: 8px 6px !important;
                            white-space: nowrap !important;
                        }
                        #employeesList table td {
                            padding: 10px 6px !important;
                        }
                        #employeesList table td > div {
                            gap: 8px !important;
                        }
                        #employeesList table td > div > div:first-child {
                            width: 32px !important;
                            height: 32px !important;
                            font-size: 12px !important;
                        }
                        #employeesList table td > div > div:last-child {
                            font-size: 12px !important;
                        }
                        #employeesList table td > span {
                            padding: 3px 8px !important;
                            font-size: 10px !important;
                        }
                        #employeesList table button {
                            padding: 4px 8px !important;
                            font-size: 10px !important;
                            margin-right: 2px !important;
                        }
                        /* √âtat vide responsive */
                        #employeesList > div[style*="text-align: center"] h3 {
                            font-size: 16px !important;
                        }
                        #employeesList > div[style*="text-align: center"] p {
                            font-size: 13px !important;
                        }
                        #employeesList > div[style*="text-align: center"] button {
                            padding: 10px 20px !important;
                            font-size: 13px !important;
                        }
                    }
                    
                    /* Responsive pour le panneau Paie */
                    @media (max-width: 1200px) {
                        #hrContentPayroll {
                            padding: 16px !important;
                        }
                        #hrContentPayroll h2 {
                            font-size: 24px !important;
                        }
                    }
                    
                    @media (max-width: 768px) {
                        #hrContentPayroll {
                            padding: 12px !important;
                        }
                        #hrContentPayroll h2 {
                            font-size: 22px !important;
                        }
                        #hrContentPayroll p {
                            font-size: 13px !important;
                        }
                        /* Header avec actions - empiler verticalement */
                        #hrContentPayroll > div:first-child {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            gap: 16px !important;
                        }
                        /* Stats Cards - grille adaptative */
                        #hrContentPayroll > div:nth-child(2) {
                            grid-template-columns: repeat(2, 1fr) !important;
                            gap: 12px !important;
                        }
                        #hrContentPayroll > div:nth-child(2) > div {
                            padding: 16px !important;
                        }
                        #hrContentPayroll input,
                        #hrContentPayroll select,
                        #hrContentPayroll textarea {
                            font-size: 13px !important;
                            padding: 10px 12px !important;
                        }
                        #hrContentPayroll button {
                            font-size: 13px !important;
                            padding: 10px 20px !important;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        #hrContentPayroll {
                            padding: 10px !important;
                        }
                        #hrContentPayroll h2 {
                            font-size: 18px !important;
                        }
                        #hrContentPayroll h3 {
                            font-size: 14px !important;
                        }
                        #hrContentPayroll p {
                            font-size: 12px !important;
                        }
                        /* Stats Cards - 2 colonnes */
                        #hrContentPayroll > div:nth-child(2) {
                            grid-template-columns: 1fr 1fr !important;
                            gap: 10px !important;
                            margin-bottom: 20px !important;
                        }
                        /* Cartes individuelles - padding et layout */
                        #hrContentPayroll > div:nth-child(2) > div {
                            padding: 14px !important;
                            display: flex !important;
                            flex-direction: column !important;
                        }
                        /* Zone ic√¥ne + label */
                        #hrContentPayroll > div:nth-child(2) > div > div:first-child {
                            margin-bottom: 10px !important;
                            gap: 8px !important;
                        }
                        /* Ic√¥ne container */
                        #hrContentPayroll > div:nth-child(2) > div > div:first-child > div:first-child {
                            width: 32px !important;
                            height: 32px !important;
                            min-width: 32px !important;
                            flex-shrink: 0 !important;
                        }
                        /* SVG dans ic√¥ne */
                        #hrContentPayroll > div:nth-child(2) > div > div:first-child > div:first-child svg {
                            width: 16px !important;
                            height: 16px !important;
                        }
                        /* Label texte */
                        #hrContentPayroll > div:nth-child(2) span {
                            font-size: 10px !important;
                            line-height: 1.2 !important;
                        }
                        /* Nombre/valeur */
                        #hrContentPayroll > div:nth-child(2) > div > div:last-child {
                            font-size: 20px !important;
                        }
                        #hrContentPayroll > div:nth-child(2) > div > div:last-child p:first-of-type {
                            font-size: 11px !important;
                        }
                        #hrContentPayroll > div:nth-child(2) > div > div:last-child p:last-of-type {
                            font-size: 22px !important;
                        }
                        #hrContentPayroll input,
                        #hrContentPayroll select,
                        #hrContentPayroll textarea {
                            font-size: 12px !important;
                            padding: 8px 10px !important;
                        }
                        #hrContentPayroll button {
                            padding: 8px 16px !important;
                            font-size: 12px !important;
                        }
                        /* Table des bulletins de paie responsive */
                        #payrollsList {
                            padding: 20px !important;
                        }
                        #payrollsList table {
                            font-size: 13px !important;
                        }
                        #payrollsList table th {
                            font-size: 11px !important;
                            padding: 10px !important;
                        }
                        #payrollsList table td {
                            padding: 12px !important;
                        }
                        #payrollsList table td > div > div:first-child {
                            width: 36px !important;
                            height: 36px !important;
                            font-size: 14px !important;
                        }
                        #payrollsList table td > div > div:last-child > div:first-child {
                            font-size: 13px !important;
                        }
                        #payrollsList table td > div > div:last-child > div:last-child {
                            font-size: 11px !important;
                        }
                        #payrollsList table button {
                            padding: 5px 10px !important;
                            font-size: 11px !important;
                        }
                    }
                    
                    /* Responsive pour le panneau Cong√©s */
                    @media (max-width: 1200px) {
                        #hrContentLeaves {
                            padding: 16px !important;
                        }
                        #hrContentLeaves h2 {
                            font-size: 24px !important;
                        }
                    }
                    
                    @media (max-width: 768px) {
                        #hrContentLeaves {
                            padding: 12px !important;
                        }
                        #hrContentLeaves h2 {
                            font-size: 22px !important;
                        }
                        #hrContentLeaves p {
                            font-size: 13px !important;
                        }
                        /* Header avec actions - empiler verticalement */
                        #hrContentLeaves > div:first-child {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            gap: 16px !important;
                        }
                        #hrContentLeaves > div:first-child > div:last-child {
                            width: 100% !important;
                            flex-wrap: wrap !important;
                        }
                        #hrContentLeaves > div:first-child button {
                            flex: 1 1 auto !important;
                            min-width: 120px !important;
                            justify-content: center !important;
                        }
                        /* Stats Cards - grille adaptative */
                        #hrContentLeaves > div:nth-child(2) {
                            grid-template-columns: repeat(2, 1fr) !important;
                            gap: 12px !important;
                        }
                        #hrContentLeaves > div:nth-child(2) > div {
                            padding: 16px !important;
                        }
                        #hrContentLeaves input,
                        #hrContentLeaves select,
                        #hrContentLeaves textarea {
                            font-size: 13px !important;
                            padding: 10px 12px !important;
                        }
                        #hrContentLeaves button {
                            font-size: 13px !important;
                            padding: 10px 16px !important;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        #hrContentLeaves {
                            padding: 10px !important;
                        }
                        #hrContentLeaves h2 {
                            font-size: 18px !important;
                        }
                        #hrContentLeaves h3 {
                            font-size: 14px !important;
                        }
                        #hrContentLeaves p {
                            font-size: 12px !important;
                        }
                        /* Header - boutons en colonne */
                        #hrContentLeaves > div:first-child > div:last-child {
                            flex-direction: column !important;
                        }
                        #hrContentLeaves > div:first-child button {
                            width: 100% !important;
                            min-width: unset !important;
                        }
                        /* Stats Cards - 2 colonnes */
                        #hrContentLeaves > div:nth-child(2) {
                            grid-template-columns: 1fr 1fr !important;
                            gap: 10px !important;
                            margin-bottom: 20px !important;
                        }
                        /* Cartes individuelles - padding et layout */
                        #hrContentLeaves > div:nth-child(2) > div {
                            padding: 14px !important;
                            display: flex !important;
                            flex-direction: column !important;
                        }
                        /* Zone ic√¥ne + label */
                        #hrContentLeaves > div:nth-child(2) > div > div:first-child {
                            margin-bottom: 10px !important;
                            gap: 8px !important;
                        }
                        /* Ic√¥ne container */
                        #hrContentLeaves > div:nth-child(2) > div > div:first-child > div:first-child {
                            width: 32px !important;
                            height: 32px !important;
                            min-width: 32px !important;
                            flex-shrink: 0 !important;
                        }
                        /* SVG dans ic√¥ne */
                        #hrContentLeaves > div:nth-child(2) > div > div:first-child > div:first-child svg {
                            width: 16px !important;
                            height: 16px !important;
                        }
                        /* Label texte */
                        #hrContentLeaves > div:nth-child(2) span {
                            font-size: 10px !important;
                            line-height: 1.2 !important;
                        }
                        /* Nombre/valeur */
                        #hrContentLeaves > div:nth-child(2) > div > div:last-child {
                            font-size: 20px !important;
                        }
                        #hrContentLeaves input,
                        #hrContentLeaves select,
                        #hrContentLeaves textarea {
                            font-size: 12px !important;
                            padding: 8px 10px !important;
                        }
                        #hrContentLeaves button {
                            padding: 8px 12px !important;
                            font-size: 12px !important;
                        }
                        #hrContentLeaves button svg {
                            width: 16px !important;
                            height: 16px !important;
                        }
                    }
                    
                            font-size: 10px !important;
                            line-height: 1.2 !important;
                        }
                        /* Nombre/valeur */
                        #hrContentLeaves > div:nth-child(2) > div > div:last-child {
                            font-size: 20px !important;
                        }
                        #hrContentLeaves input,
                        #hrContentLeaves select,
                        #hrContentLeaves textarea {
                            font-size: 12px !important;
                            padding: 8px 10px !important;
                        }
                        #hrContentLeaves button {
                            padding: 8px 12px !important;
                            font-size: 12px !important;
                        }
                        #hrContentLeaves button svg {
                            width: 16px !important;
                            height: 16px !important;
                        }
                    }
                    

                    /* Responsive pour le panneau √âvaluations (Reviews) */
                    @media (max-width: 1200px) {
                        #hrContentReviews {
                            padding: 16px !important;
                        }
                        #hrContentReviews h2 {
                            font-size: 24px !important;
                        }
                    }
                    
                    @media (max-width: 768px) {
                        #hrContentReviews {
                            padding: 12px !important;
                        }
                        #hrContentReviews h2 {
                            font-size: 22px !important;
                        }
                        #hrContentReviews p {
                            font-size: 13px !important;
                        }
                        /* Header - empiler verticalement */
                        #hrContentReviews > div:first-child {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            gap: 16px !important;
                        }
                        /* Stats Cards - grille 2 colonnes */
                        #hrContentReviews > div:nth-child(2) {
                            grid-template-columns: repeat(2, 1fr) !important;
                            gap: 12px !important;
                        }
                        #hrContentReviews > div:nth-child(2) > div {
                            padding: 16px !important;
                        }
                        #hrContentReviews input,
                        #hrContentReviews select {
                            font-size: 13px !important;
                            padding: 10px 12px !important;
                        }
                        #hrContentReviews button {
                            font-size: 13px !important;
                            padding: 10px 16px !important;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        #hrContentReviews {
                            padding: 10px !important;
                        }
                        #hrContentReviews h2 {
                            font-size: 18px !important;
                        }
                        #hrContentReviews h3 {
                            font-size: 14px !important;
                        }
                        #hrContentReviews p {
                            font-size: 12px !important;
                        }
                        /* Stats Cards - 2 colonnes sur mobile */
                        #hrContentReviews > div:nth-child(2) {
                            grid-template-columns: 1fr 1fr !important;
                            gap: 10px !important;
                            margin-bottom: 20px !important;
                        }
                        /* Cartes individuelles */
                        #hrContentReviews > div:nth-child(2) > div {
                            padding: 14px !important;
                            display: flex !important;
                            flex-direction: column !important;
                        }
                        /* Zone ic√¥ne + label */
                        #hrContentReviews > div:nth-child(2) > div > div:first-child {
                            margin-bottom: 10px !important;
                            gap: 8px !important;
                        }
                        /* Ic√¥ne SVG container */
                        #hrContentReviews > div:nth-child(2) > div > div:first-child > div:first-child {
                            width: 32px !important;
                            height: 32px !important;
                            min-width: 32px !important;
                            flex-shrink: 0 !important;
                        }
                        /* SVG dans les cartes stats */
                        #hrContentReviews > div:nth-child(2) > div > div:first-child > div:first-child svg {
                            width: 16px !important;
                            height: 16px !important;
                        }
                        /* Label texte */
                        #hrContentReviews > div:nth-child(2) span {
                            font-size: 10px !important;
                            line-height: 1.2 !important;
                        }
                        /* Nombre/valeur */
                        #hrContentReviews > div:nth-child(2) > div > div:last-child {
                            font-size: 20px !important;
                        }
                        #hrContentReviews input,
                        #hrContentReviews select {
                            font-size: 12px !important;
                            padding: 8px 10px !important;
                        }
                        #hrContentReviews button {
                            padding: 8px 12px !important;
                            font-size: 12px !important;
                        }
                        #hrContentReviews button svg {
                            width: 16px !important;
                            height: 16px !important;
                        }
                    }
                    
                    /* Responsive pour le modal Nouvel Employ√© */
                    @media (max-width: 768px) {
                        #addEmployeeModal > div {
                            padding: 24px !important;
                            width: 95% !important;
                            max-height: 85vh !important;
                        }
                        #addEmployeeModal h2 {
                            font-size: 22px !important;
                        }
                        #addEmployeeModal h3 {
                            font-size: 14px !important;
                        }
                        #addEmployeeModal p {
                            font-size: 13px !important;
                        }
                        #addEmployeeModal label {
                            font-size: 12px !important;
                        }
                        #addEmployeeModal > div > div:first-child {
                            margin-bottom: 24px !important;
                            padding-bottom: 16px !important;
                        }
                        #addEmployeeModal > div > div:first-child > button {
                            width: 36px !important;
                            height: 36px !important;
                        }
                        #addEmployeeModal form > div {
                            padding: 20px !important;
                        }
                        #addEmployeeModal form > div > div {
                            grid-template-columns: 1fr !important;
                            gap: 12px !important;
                        }
                        #addEmployeeModal input,
                        #addEmployeeModal select,
                        #addEmployeeModal textarea {
                            font-size: 13px !important;
                            padding: 10px 12px !important;
                        }
                        #addEmployeeModal button[type="submit"],
                        #addEmployeeModal button[type="button"] {
                            font-size: 13px !important;
                            padding: 12px 20px !important;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        #addEmployeeModal > div {
                            padding: 20px !important;
                            width: 96% !important;
                            max-height: 90vh !important;
                            border-radius: 16px !important;
                        }
                        #addEmployeeModal h2 {
                            font-size: 18px !important;
                        }
                        #addEmployeeModal h3 {
                            font-size: 13px !important;
                            margin-bottom: 16px !important;
                        }
                        #addEmployeeModal p {
                            font-size: 12px !important;
                        }
                        #addEmployeeModal label {
                            font-size: 11px !important;
                            margin-bottom: 6px !important;
                        }
                        #addEmployeeModal > div > div:first-child {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            margin-bottom: 20px !important;
                            padding-bottom: 12px !important;
                            gap: 12px !important;
                        }
                        #addEmployeeModal > div > div:first-child > button {
                            width: 32px !important;
                            height: 32px !important;
                            align-self: flex-end !important;
                        }
                        #addEmployeeModal form {
                            gap: 16px !important;
                        }
                        #addEmployeeModal form > div {
                            padding: 16px !important;
                            border-radius: 12px !important;
                        }
                        #addEmployeeModal form > div h3 svg {
                            width: 16px !important;
                            height: 16px !important;
                        }
                        #addEmployeeModal input,
                        #addEmployeeModal select,
                        #addEmployeeModal textarea {
                            font-size: 12px !important;
                            padding: 8px 10px !important;
                        }
                        #addEmployeeModal button[type="submit"],
                        #addEmployeeModal button[type="button"] {
                            font-size: 12px !important;
                            padding: 10px 16px !important;
                        }
                        #addEmployeeModal form > div:last-child {
                            flex-direction: column !important;
                            gap: 10px !important;
                        }
                    }
                    
                    /* Responsive pour le modal Planning des Cong√©s */
                    @media (max-width: 1200px) {
                        #leaveCalendarModal > div {
                            max-width: 100% !important;
                            padding: 24px !important;
                        }
                        #leaveCalendarModal h2 {
                            font-size: 20px !important;
                        }
                    }
                    
                    @media (max-width: 768px) {
                        #leaveCalendarModal {
                            padding: 12px !important;
                        }
                        #leaveCalendarModal > div {
                            padding: 20px !important;
                            max-height: 85vh !important;
                        }
                        #leaveCalendarModal h2 {
                            font-size: 18px !important;
                        }
                        #leaveCalendarModal h3 {
                            font-size: 14px !important;
                        }
                        #leaveCalendarModal p {
                            font-size: 13px !important;
                        }
                        #leaveCalendarModal label {
                            font-size: 12px !important;
                        }
                        #leaveCalendarModal > div > div:first-child {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            gap: 12px !important;
                        }
                        #leaveCalendarModal > div > div:first-child > button {
                            align-self: flex-end !important;
                        }
                        #leaveCalendarModal select {
                            font-size: 13px !important;
                            padding: 10px 12px !important;
                        }
                        #leaveCalendarModal #calendarContainer {
                            padding: 16px !important;
                            min-height: 350px !important;
                            overflow-x: auto !important;
                        }
                        #leaveCalendarModal .calendar-table {
                            font-size: 12px !important;
                        }
                        #leaveCalendarModal .calendar-table th,
                        #leaveCalendarModal .calendar-table td {
                            padding: 6px 4px !important;
                            font-size: 11px !important;
                        }
                        #leaveCalendarModal > div > div:last-child > div {
                            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)) !important;
                            gap: 8px !important;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        #leaveCalendarModal {
                            padding: 8px !important;
                        }
                        #leaveCalendarModal > div {
                            padding: 16px !important;
                            border-radius: 16px !important;
                        }
                        #leaveCalendarModal h2 {
                            font-size: 16px !important;
                        }
                        #leaveCalendarModal h2 svg {
                            width: 20px !important;
                            height: 20px !important;
                        }
                        #leaveCalendarModal h3 {
                            font-size: 13px !important;
                        }
                        #leaveCalendarModal h3 svg {
                            width: 16px !important;
                            height: 16px !important;
                        }
                        #leaveCalendarModal p {
                            font-size: 12px !important;
                        }
                        #leaveCalendarModal label {
                            font-size: 11px !important;
                        }
                        #leaveCalendarModal > div > div:first-child {
                            margin-bottom: 16px !important;
                        }
                        #leaveCalendarModal > div > div:first-child > button {
                            width: 32px !important;
                            height: 32px !important;
                        }
                        #leaveCalendarModal select {
                            font-size: 12px !important;
                            padding: 8px 10px !important;
                        }
                        #leaveCalendarModal #calendarContainer {
                            padding: 12px !important;
                            min-height: 300px !important;
                            border-radius: 12px !important;
                        }
                        #leaveCalendarModal .calendar-table {
                            font-size: 10px !important;
                            min-width: 100% !important;
                        }
                        #leaveCalendarModal .calendar-table th,
                        #leaveCalendarModal .calendar-table td {
                            padding: 4px 2px !important;
                            font-size: 10px !important;
                        }
                        #leaveCalendarModal > div > div:last-child {
                            margin-top: 16px !important;
                            padding-top: 16px !important;
                        }
                        #leaveCalendarModal > div > div:last-child > div {
                            grid-template-columns: 1fr !important;
                            gap: 6px !important;
                        }
                        #leaveCalendarModal > div > div:last-child > div > div {
                            font-size: 11px !important;
                            padding: 8px !important;
                        }
                    }
                    
                    /* Responsive pour le modal Bulletin de Paie (d√©tails) */
                    @media (max-width: 768px) {
                        /* Le modal de d√©tails bulletin n'a pas d'ID, on cible par structure */
                        body > div[style*="z-index: 10004"] > div {
                            padding: 24px !important;
                            max-width: 100% !important;
                        }
                        body > div[style*="z-index: 10004"] h2 {
                            font-size: 22px !important;
                        }
                        body > div[style*="z-index: 10004"] h3 {
                            font-size: 18px !important;
                        }
                        body > div[style*="z-index: 10004"] p {
                            font-size: 14px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(2) {
                            padding: 18px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(2) > div {
                            gap: 12px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(2) > div > div:first-child,
                        body > div[style*="z-index: 10004"] > div > div:nth-child(2) img {
                            width: 56px !important;
                            height: 56px !important;
                            font-size: 22px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) {
                            padding: 18px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) > div {
                            margin-bottom: 12px !important;
                            padding-bottom: 12px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) > div > span:first-child {
                            font-size: 13px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) > div > span:last-child {
                            font-size: 14px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) > div:last-child > span:first-child {
                            font-size: 16px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) > div:last-child > span:last-child {
                            font-size: 20px !important;
                        }
                        body > div[style*="z-index: 10004"] button {
                            padding: 12px !important;
                            font-size: 14px !important;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        body > div[style*="z-index: 10004"] > div {
                            padding: 20px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:first-child {
                            margin-bottom: 20px !important;
                            padding-bottom: 16px !important;
                        }
                        body > div[style*="z-index: 10004"] h2 {
                            font-size: 20px !important;
                        }
                        body > div[style*="z-index: 10004"] h3 {
                            font-size: 16px !important;
                        }
                        body > div[style*="z-index: 10004"] p {
                            font-size: 13px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(2) {
                            padding: 16px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(2) > div {
                            gap: 10px !important;
                            flex-direction: column !important;
                            align-items: flex-start !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(2) > div > div:first-child,
                        body > div[style*="z-index: 10004"] > div > div:nth-child(2) img {
                            width: 48px !important;
                            height: 48px !important;
                            font-size: 18px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) {
                            padding: 16px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) > div {
                            margin-bottom: 10px !important;
                            padding-bottom: 10px !important;
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            gap: 4px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) > div > span:first-child {
                            font-size: 12px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) > div > span:last-child {
                            font-size: 13px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) > div:last-child {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                            gap: 8px !important;
                            padding-top: 12px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) > div:last-child > span:first-child {
                            font-size: 14px !important;
                        }
                        body > div[style*="z-index: 10004"] > div > div:nth-child(3) > div:last-child > span:last-child {
                            font-size: 18px !important;
                        }
                        body > div[style*="z-index: 10004"] button {
                            padding: 12px !important;
                            font-size: 13px !important;
                        }
                    }

                    /* Fix scroll pour Recrutement et Turnover - ajout padding-bottom */
                    #hrContentRecruitment,
                    #hrContentTurnover {
                        padding-bottom: 60px !important;
                        box-sizing: border-box !important;
                    }

                    /* Responsive - Onglet Recrutement (HR)
                       Le bouton de fermeture doit scroller avec le contenu (pas sticky/fixed). */
                    #hrContentRecruitment .hr-recruitment-close-row {
                        display: flex;
                        justify-content: flex-end;
                        margin-bottom: 12px;
                    }

                    #hrContentRecruitment .hr-recruitment-close-row .hr-close-btn {
                        position: relative;
                        top: auto;
                        right: auto;
                        color: white;
                        margin-top: 6px;
                    }
                    @media (max-width: 768px) {
                        #hrContentRecruitment {
                            padding: 12px !important;
                        }
                        #hrContentRecruitment .hr-recruitment-close-row {
                            margin-bottom: 8px;
                        }
                        #hrContentRecruitment .hr-recruitment-close-row .hr-close-btn {
                            margin-top: 8px;
                        }
                        #hrContentRecruitment .hr-recruitment-rgpd {
                            padding: 18px !important;
                        }
                        #hrContentRecruitment .hr-recruitment-rgpd-inner {
                            flex-direction: column !important;
                            align-items: flex-start !important;
                        }
                        #hrContentRecruitment .hr-recruitment-actions {
                            flex-direction: column !important;
                            align-items: stretch !important;
                        }
                        #hrContentRecruitment .hr-recruitment-actions-left,
                        #hrContentRecruitment .hr-recruitment-actions-right {
                            width: 100% !important;
                        }
                        #hrContentRecruitment .hr-recruitment-actions-left {
                            min-width: 0 !important;
                        }
                        #hrContentRecruitment .hr-recruitment-actions-left button,
                        #hrContentRecruitment .hr-recruitment-actions-left select,
                        #hrContentRecruitment .hr-recruitment-actions-right button {
                            width: 100% !important;
                            justify-content: center !important;
                        }
                        #hrContentRecruitment .hr-recruitment-backup {
                            flex-direction: column !important;
                            align-items: stretch !important;
                        }
                        #hrContentRecruitment .hr-recruitment-backup > div:last-child {
                            width: 100% !important;
                            justify-content: stretch !important;
                        }
                        #hrContentRecruitment .hr-recruitment-backup > div:last-child button {
                            width: 100% !important;
                            justify-content: center !important;
                        }
                        #hrContentRecruitment .hr-recruitment-empty-actions {
                            flex-direction: column !important;
                            align-items: stretch !important;
                        }
                        #hrContentRecruitment .hr-recruitment-empty-actions button {
                            width: 100% !important;
                            justify-content: center !important;
                        }
                    }

                    @media (max-width: 480px) {
                        #hrContentRecruitment .hr-recruitment-stats {
                            grid-template-columns: 1fr !important;
                            gap: 12px !important;
                        }
                        #hrContentRecruitment .hr-recruitment-rgpd-badges span {
                            padding: 6px 10px !important;
                            font-size: 10px !important;
                        }
                    }
                </style>
                
                <!-- Interface RH Management -->
                <div class="hr-container">
                    
                    <!-- Header -->
                    <div class="hr-header">
                        <div>
                            <h1 class="hr-title">${t('hr.title')}</h1>
                            <p class="hr-subtitle">${t('hr.subtitle')}</p>
                        </div>
                        <div class="hr-header-actions">
                            <button class="hr-help-btn" onclick="showHRHelp()" title="Guide">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                            </button>
                            <button class="hr-close-btn" onclick="closeHRManagement()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Navigation Tabs -->
                    <div class="hr-tabs">
                        <button onclick="showHRTab('dashboard')" id="hrTabDashboard" class="hr-tab active">
                            ${t('hr.tab.dashboard')}
                        </button>
                        <button onclick="showHRTab('employees')" id="hrTabEmployees" class="hr-tab">
                            ${t('hr.tab.employees')}
                        </button>
                        <button onclick="showHRTab('recruitment')" id="hrTabRecruitment" class="hr-tab">
                            ${t('hr.tab.recruitment')}
                        </button>
                        <button onclick="showHRTab('leaves')" id="hrTabLeaves" class="hr-tab">
                            ${t('hr.tab.leaves')}
                        </button>
                        <button onclick="showHRTab('payroll')" id="hrTabPayroll" class="hr-tab">
                            ${t('hr.tab.payroll')}
                        </button>
                        <button onclick="showHRTab('reviews')" id="hrTabReviews" class="hr-tab">
                            ${t('hr.tab.reviews')}
                        </button>
                        <button onclick="showHRTab('agent')" id="hrTabAgent" class="hr-tab" title="${t('hr.tab.agent')}">
                            ${t('hr.tab.agent')}
                        </button>
<button onclick="openCompanySettings()" id="hrTabCompany" class="hr-tab">
                            ${t('hr.tab.company')}
                        </button>
                    </div>
                    
                    <!-- Content Area -->
                    <div class="hr-content-area">
                        <!-- Dashboard Tab -->
                        <div id="hrContentDashboard" class="hr-content">
                            
                                <!-- Stats Cards -->
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 24px; margin-bottom: 32px;">
                                    <div class="hr-stat-card">
                                        <div class="hr-stat-label">${t('hr.stat.totalEmployees')}</div>
                                        <div id="hrStatTotalEmployees" class="hr-stat-value">0</div>
                                        <div id="hrStatTotalEmployeesLabel" style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 4px;">${t('hr.stat.noEmployee')}</div>
                                    </div>
                                    
                                    <div class="hr-stat-card">
                                        <div class="hr-stat-label">${t('hr.stat.activeLeaves')}</div>
                                        <div class="hr-stat-value">0</div>
                                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 4px;">${t('hr.stat.toProcess')}</div>
                                    </div>
                                    
                                    <div class="hr-stat-card">
                                        <div class="hr-stat-label">${t('hr.stat.absentToday')}</div>
                                        <div class="hr-stat-value">0</div>
                                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 4px;">${t('hr.stat.leavesHint')}</div>
                                    </div>
                                    
                                    <div class="hr-stat-card">
                                        <div class="hr-stat-label">${t('hr.stat.totalSalary')}</div>
                                        <div id="hrStatTotalSalary" class="hr-stat-value">0 DA</div>
                                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 4px;">${t('hr.stat.monthlyGross')}</div>
                                    </div>
                                </div>
                                
                                <!-- Quick Actions -->
                                <div class="hr-section">
                                    <div class="hr-section-title">${t('hr.actions.title')}</div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 220px)); gap: 12px;">
                                        <button onclick="showHRTab('employees'); showAddEmployeeModal();" class="hr-btn">
                                            ${t('hr.actions.newEmployee')}
                                        </button>
                                        
                                        <button onclick="showHRTab('leaves');" class="hr-btn">
                                            ${t('hr.actions.manageLeaves')}
                                        </button>
                                        
                                        <button onclick="showHRTab('payroll');" class="hr-btn">
                                            ${t('hr.actions.generatePayroll')}
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Notifications -->
                                <div class="hr-section">
                                    <div class="hr-section-title">${t('hr.notifications.title')}</div>
                                    <div class="hr-empty">
                                        <p class="hr-empty-title">${t('hr.notifications.empty')}</p>
                                        <p style="margin: 0; font-size: 14px;">${t('hr.notifications.uptodate')}</p>
                                    </div>
                                </div>
                        </div>

                        <!-- Agent RH -->
                        <div id="hrContentAgent" class="hr-content" style="display: none;">
                            <div class="hr-agent-header" style="margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px; margin-bottom: 12px;">
                                    <div class="hr-agent-header-text" style="flex: 1;">
                                        <h2 style="margin: 0 0 8px; font-size: 24px; color: white;">${t('hr.agent.title')}</h2>
                                        <p style="margin: 0 0 12px; color: rgba(255, 255, 255, 0.6); font-size: 14px;">${t('hr.agent.desc')}</p>
                                    </div>
                                    <button onclick="clearHRChatHistory()" title="${t('hr.agent.clearHistory')}" style="padding: 10px 16px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 8px; color: #fca5a5; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                        ${t('hr.agent.clearButton')}
                                    </button>
                                </div>
                            </div>

                            <div id="hrChatContainer" class="hr-chat-container">
                                <div id="hrChatMessages" class="hr-chat-messages"></div>
                                <div class="hr-chat-input">
                                    <input type="text" class="hr-input" id="hrChatInput" placeholder="${t('hr.agent.placeholder')}" onkeypress="if(event.key==='Enter') sendHRChatMessage()">
                                    <button class="hr-btn" onclick="sendHRChatMessage()">${t('hr.agent.send')}</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Employees Tab - Full Screen Modal -->
                        <div id="hrContentEmployees" class="hr-content" style="display: none;">
                                    <!-- Header -->
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px;">
                                        <div>
                                            <h2 style="margin: 0 0 8px; font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #10b981 0%, #06b6d4 50%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${t('hr.employees.title')}</h2>
                                            <p style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.6);">${t('hr.employees.subtitle')}</p>
                                        </div>
                                        <div style="display: flex; gap: 12px;">
                                            <button onclick="showAddEmployeeModal()" class="hr-btn" style="padding: 12px 24px; font-size: 14px;">
                                                + ${t('hr.employees.addBtn')}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Filters -->
                                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 24px; margin-bottom: 24px;">
                                        <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; color: rgba(255, 255, 255, 0.9);">
                                            ${t('hr.filters.title')}
                                        </h3>
                                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 14px;">
                                            <input type="text" id="employeeSearch" placeholder="${t('hr.employees.searchPlaceholder')}" style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; color: white; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'">
                                            <select id="departmentFilter" style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; color: white; cursor: pointer; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'">
                                                <option value="" style="background: #1e3a8a; color: white;">${t('hr.filters.allDepartments')}</option>
                                                <option value="IT" style="background: #1e3a8a; color: white;">IT</option>
                                                <option value="RH" style="background: #1e3a8a; color: white;">RH</option>
                                                <option value="Finance" style="background: #1e3a8a; color: white;">Finance</option>
                                                <option value="Marketing" style="background: #1e3a8a; color: white;">Marketing</option>
                                                <option value="Ventes" style="background: #1e3a8a; color: white;">Ventes</option>
                                                <option value="Operations" style="background: #1e3a8a; color: white;">Op√©rations</option>
                                            </select>
                                            <select id="statusFilter" style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; color: white; cursor: pointer; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'">
                                                <option value="" style="background: #1e3a8a; color: white;">${t('hr.filters.allStatus')}</option>
                                                <option value="active" style="background: #1e3a8a; color: white;">${t('hr.employees.status.active')}</option>
                                                <option value="onLeave" style="background: #1e3a8a; color: white;">${t('hr.employees.status.onLeave')}</option>
                                                <option value="terminated" style="background: #1e3a8a; color: white;">Termin√©</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Employees List Container -->
                                    <div id="employeesList" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 30px; min-height: 400px;">
                                        <!-- Empty State -->
                                        <div style="text-align: center; padding: 60px 20px;">
                                            <div style="width: 80px; height: 80px; background: rgba(16, 185, 129, 0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                            </div>
                                            <h3 style="margin: 0 0 12px; font-size: 20px; font-weight: 600; color: white;">${t('hr.employees.empty.title')}</h3>
                                            <p style="margin: 0 0 24px; font-size: 14px; color: rgba(255,255,255,0.6);">${t('hr.employees.empty.desc')}</p>
                                            <button onclick="showAddEmployeeModal()" class="hr-btn" style="padding: 12px 24px; font-size: 14px;">
                                                ${t('hr.employees.addBtn')}
                                            </button>
                                        </div>
                                    </div>
                        </div>
                        
                        <!-- Leaves Tab -->
                        <div id="hrContentLeaves" class="hr-content" style="display: none;">
                                
                                <!-- Header avec actions -->
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px;">
                                    <div>
                                        <h2 style="margin: 0 0 8px; font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #10b981 0%, #06b6d4 50%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${t('hr.leaves.title')}</h2>
                                        <p style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.6);">${t('hr.leaves.subtitle')}</p>
                                    </div>
                                    <div style="display: flex; gap: 12px;">
                                        <button onclick="showLeaveCalendar()" style="padding: 12px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(16, 185, 129, 0.3)'; this.style.borderColor='#10b981'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='rgba(16, 185, 129, 0.3)'">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                                            ${t('hr.leaves.calendarBtn')}
                                        </button>
                                        <button onclick="showAddLeaveModal()" class="hr-btn" style="padding: 12px 24px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                                            ${t('hr.leaves.newRequestBtn')}
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Stats Cards -->
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 32px;">
                                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 16px; padding: 20px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='#10b981'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(16, 185, 129, 0.4)'; this.style.transform='translateY(0)'">
                                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                            <div style="width: 40px; height: 40px; background: rgba(16,185,129,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(16,185,129,0.3);">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                            </div>
                                            <span style="font-size: 13px; color: rgba(255,255,255,0.7); font-weight: 600;">${t('hr.leaves.stat.approved')}</span>
                                        </div>
                                        <div id="leavesApprovedCount" style="font-size: 28px; font-weight: 700; color: #10b981;">0</div>
                                    </div>
                                    
                                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 16px; padding: 20px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='#f59e0b'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(245, 158, 11, 0.4)'; this.style.transform='translateY(0)'">
                                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                            <div style="width: 40px; height: 40px; background: rgba(245,158,11,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(245,158,11,0.3);">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2h4"/><path d="M12 14v-4"/><path d="M4 13a8 8 0 0 1 7.5-8.37"/><path d="M20 13a8 8 0 1 1-5.5-7.37"/></svg>
                                            </div>
                                            <span style="font-size: 13px; color: rgba(255,255,255,0.7); font-weight: 600;">${t('hr.leaves.stat.pending')}</span>
                                        </div>
                                        <div id="leavesPendingCount" style="font-size: 28px; font-weight: 700; color: #f59e0b;">0</div>
                                    </div>
                                    
                                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 16px; padding: 20px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='#ef4444'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(239, 68, 68, 0.4)'; this.style.transform='translateY(0)'">
                                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                            <div style="width: 40px; height: 40px; background: rgba(239,68,68,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(239,68,68,0.3);">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                                            </div>
                                            <span style="font-size: 13px; color: rgba(255,255,255,0.7); font-weight: 600;">${t('hr.leaves.stat.rejected')}</span>
                                        </div>
                                        <div id="leavesRejectedCount" style="font-size: 28px; font-weight: 700; color: #ef4444;">0</div>
                                    </div>
                                    
                                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(99, 102, 241, 0.4); border-radius: 16px; padding: 20px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='#6366F1'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(99, 102, 241, 0.4)'; this.style.transform='translateY(0)'">
                                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                            <div style="width: 40px; height: 40px; background: rgba(99,102,241,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(99,102,241,0.3);">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366F1" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                            </div>
                                            <span style="font-size: 13px; color: rgba(255,255,255,0.7); font-weight: 600;">${t('hr.leaves.stat.today')}</span>
                                        </div>
                                        <div id="leavesTodayCount" style="font-size: 28px; font-weight: 700; color: #6366F1;">0</div>
                                    </div>
                                </div>
                                
                                <!-- Filtres -->
                                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 24px; margin-bottom: 24px; backdrop-filter: blur(10px);">
                                    <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; color: rgba(255, 255, 255, 0.9);">
                                        ${t('hr.filters.title')}
                                    </h3>
                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 14px;">
                                        <input type="text" id="leaveSearch" placeholder="${t('hr.leaves.searchPlaceholder')}" style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; color: white; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'" oninput="filterLeaves()">
                                        <select id="leaveTypeFilter" style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; color: white; cursor: pointer; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'" onchange="filterLeaves()">
                                            <option value="" style="background: #1e3a8a; color: white;">${t('hr.leaves.filter.allTypes')}</option>
                                            <option value="paid" style="background: #1e3a8a; color: white;">Cong√© pay√©</option>
                                            <option value="sick" style="background: #1e3a8a; color: white;">Maladie</option>
                                            <option value="unpaid" style="background: #1e3a8a; color: white;">Sans solde</option>
                                            <option value="parental" style="background: #1e3a8a; color: white;">Parental</option>
                                            <option value="other" style="background: #1e3a8a; color: white;">Autre</option>
                                        </select>
                                        <select id="leaveStatusFilter" style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; color: white; cursor: pointer; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'" onchange="filterLeaves()">
                                            <option value="" style="background: #1e3a8a; color: white;">${t('hr.filters.allStatus')}</option>
                                            <option value="pending" style="background: #1e3a8a; color: white;">${t('hr.leaves.status.pending')}</option>
                                            <option value="approved" style="background: #1e3a8a; color: white;">${t('hr.leaves.status.approved')}</option>
                                            <option value="rejected" style="background: #1e3a8a; color: white;">${t('hr.leaves.status.rejected')}</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Liste des demandes de cong√©s -->
                                <div id="leavesList" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 30px; min-height: 400px; backdrop-filter: blur(10px);">
                                    <!-- Le contenu sera g√©n√©r√© dynamiquement -->
                                    <div style="text-align: center; padding: 60px 20px;">
                                        <div style="width: 80px; height: 80px; background: rgba(16, 185, 129, 0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; border: 1px solid rgba(16, 185, 129, 0.3);">
                                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                        </div>
                                        <h3 style="margin: 0 0 12px; font-size: 20px; font-weight: 600; color: white;">${t('hr.leaves.empty.title')}</h3>
                                        <p style="margin: 0 0 24px; font-size: 14px; color: rgba(255,255,255,0.6);">${t('hr.leaves.empty.desc')}</p>
                                        <button onclick="showAddLeaveModal()" class="hr-btn" style="padding: 12px 24px; font-size: 14px;">
                                            ${t('hr.leaves.newRequestBtn')}
                                        </button>
                                    </div>
                                </div>
                        </div>
                        
                        <!-- Payroll Tab -->
                        <div id="hrContentPayroll" class="hr-content" style="display: none;">
                                    
                                    <!-- Header -->
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px;">
                                        <div>
                                            <h2 style="margin: 0 0 8px; font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #10b981 0%, #06b6d4 50%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${t('hr.payroll.title')}</h2>
                                            <p style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.6);">${t('hr.payroll.subtitle')}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Payroll Stats -->
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px;">
                                        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 16px; padding: 24px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.transform='translateY(0)'">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                                <div style="width: 40px; height: 40px; background: rgba(16,185,129,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(16,185,129,0.3);">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                                </div>
                                            </div>
                                            <div style="color: white;">
                                                <p style="margin: 0 0 4px; font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.7);">${t('hr.payroll.stat.totalMass')}</p>
                                                <p id="payrollTotalMass" style="margin: 0; font-size: 28px; font-weight: 700; color: #10b981;">0</p>
                                            </div>
                                        </div>
                                        
                                        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 16px; padding: 24px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.transform='translateY(0)'">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                                <div style="width: 40px; height: 40px; background: rgba(59,130,246,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(52,211,153,0.3);">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                                                </div>
                                            </div>
                                            <div style="color: white;">
                                                <p style="margin: 0 0 4px; font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.7);">${t('hr.payroll.stat.monthSlips')}</p>
                                                <p id="payrollCountThisMonth" style="margin: 0; font-size: 28px; font-weight: 700; color: #3b82f6;">0</p>
                                            </div>
                                        </div>
                                        
                                        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 16px; padding: 24px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.transform='translateY(0)'">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                                <div style="width: 40px; height: 40px; background: rgba(245,158,11,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(245,158,11,0.3);">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                                </div>
                                            </div>
                                            <div style="color: white;">
                                                <p style="margin: 0 0 4px; font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.7);">${t('hr.payroll.stat.pending')}</p>
                                                <p id="payrollPendingCount" style="margin: 0; font-size: 28px; font-weight: 700; color: #f59e0b;">0</p>
                                            </div>
                                        </div>
                                        
                                        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 16px; padding: 24px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.transform='translateY(0)'">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                                <div style="width: 40px; height: 40px; background: rgba(139,92,246,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(139,92,246,0.3);">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                                </div>
                                            </div>
                                            <div style="color: white;">
                                                <p style="margin: 0 0 4px; font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.7);">${t('hr.payroll.stat.paidEmployees')}</p>
                                                <p id="payrollEmployeesPaid" style="margin: 0; font-size: 28px; font-weight: 700; color: #8b5cf6;">0</p>
                                            </div>
                                        </div>
                                    </div>
                                
                                    <!-- Filters and Actions -->
                                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 24px; margin-bottom: 24px; backdrop-filter: blur(10px);">
                                        <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; color: rgba(255, 255, 255, 0.9);">
                                            ${t('hr.payroll.filters.title')}
                                        </h3>
                                        <div style="display: flex; justify-content: space-between; align-items: end; flex-wrap: wrap; gap: 16px;">
                                            <div style="display: flex; gap: 12px; flex: 1; min-width: 300px; flex-wrap: wrap;">
                                                <input type="text" id="payrollSearchInput" onkeyup="filterPayrolls()" placeholder="${t('hr.payroll.filters.searchPlaceholder')}" style="flex: 1; min-width: 200px; padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; color: white; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'">
                                                
                                                <select id="payrollMonthFilter" onchange="filterPayrolls()" style="padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; color: white; cursor: pointer; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'">
                                                    <option value="" style="background: #1e3a8a; color: white;">${t('hr.payroll.filter.allMonths')}</option>
                                                    <option value="01" style="background: #1e3a8a; color: white;">${t('common.month.01')}</option>
                                                    <option value="02" style="background: #1e3a8a; color: white;">${t('common.month.02')}</option>
                                                    <option value="03" style="background: #1e3a8a; color: white;">${t('common.month.03')}</option>
                                                    <option value="04" style="background: #1e3a8a; color: white;">${t('common.month.04')}</option>
                                                    <option value="05" style="background: #1e3a8a; color: white;">${t('common.month.05')}</option>
                                                    <option value="06" style="background: #1e3a8a; color: white;">${t('common.month.06')}</option>
                                                    <option value="07" style="background: #1e3a8a; color: white;">${t('common.month.07')}</option>
                                                    <option value="08" style="background: #1e3a8a; color: white;">${t('common.month.08')}</option>
                                                    <option value="09" style="background: #1e3a8a; color: white;">${t('common.month.09')}</option>
                                                    <option value="10" style="background: #1e3a8a; color: white;">${t('common.month.10')}</option>
                                                    <option value="11" style="background: #1e3a8a; color: white;">${t('common.month.11')}</option>
                                                    <option value="12" style="background: #1e3a8a; color: white;">${t('common.month.12')}</option>
                                                </select>
                                                
                                                <select id="payrollStatusFilter" onchange="filterPayrolls()" style="padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; color: white; cursor: pointer; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'">
                                                    <option value="" style="background: #1e3a8a; color: white;">${t('hr.payroll.filters.allStatus')}</option>
                                                    <option value="pending" style="background: #1e3a8a; color: white;">${t('hr.payroll.status.pending')}</option>
                                                    <option value="validated" style="background: #1e3a8a; color: white;">${t('hr.payroll.status.validated')}</option>
                                                    <option value="paid" style="background: #1e3a8a; color: white;">${t('hr.payroll.status.paid')}</option>
                                                </select>
                                            </div>
                                            
                                            <div style="display: flex; gap: 12px;">
                                                <button onclick="generateAllPayrolls()" style="padding: 12px 20px; background: rgba(99, 102, 241, 0.2); border: 1px solid rgba(99, 102, 241, 0.4); border-radius: 12px; color: #6366F1; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; font-size: 14px;" onmouseover="this.style.background='rgba(99, 102, 241, 0.3)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(99, 102, 241, 0.2)'; this.style.transform='translateY(0)'">
                                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                                    ${t('hr.payroll.generateAllBtn')}
                                                </button>
                                                <button onclick="showAddPayrollModal()" class="hr-btn" style="padding: 12px 20px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                                    ${t('hr.payroll.newSlipBtn')}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Payrolls List -->
                                    <div id="payrollsList" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 30px; min-height: 400px; backdrop-filter: blur(10px);">
                                        <!-- Payrolls will be rendered here -->
                                    </div>
                                </div>
                        
                        <!-- Reviews Tab -->
                        <div id="hrContentReviews" class="hr-content" style="display: none;">

                                <!-- Header -->
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px;">
                                    <div>
                                        <h2 style="margin: 0 0 8px; font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #10b981 0%, #06b6d4 50%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${t('hr.reviews.title')}</h2>
                                        <p style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.6);">${t('hr.reviews.subtitle')}</p>
                                    </div>
                                </div>

                            <!-- Stats Cards (coh√©rence RH) -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 32px;">
                                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(99, 102, 241, 0.4); border-radius: 16px; padding: 20px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='#6366F1'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(99, 102, 241, 0.4)'; this.style.transform='translateY(0)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <div style="width: 40px; height: 40px; background: rgba(99,102,241,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(99,102,241,0.3);">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366F1" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                                        </div>
                                        <span style="font-size: 13px; color: rgba(255,255,255,0.7); font-weight: 600;">${t('hr.reviews.stat.total')}</span>
                                    </div>
                                    <div id="totalReviewsCount" style="font-size: 28px; font-weight: 700; color: #6366F1;">0</div>
                                    <p style="margin: 6px 0 0; font-size: 12px; color: rgba(255,255,255,0.6);">${t('hr.reviews.stat.completedLabel')}</p>
                                </div>

                                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 16px; padding: 20px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='#f59e0b'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(245, 158, 11, 0.4)'; this.style.transform='translateY(0)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <div style="width: 40px; height: 40px; background: rgba(245,158,11,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(245,158,11,0.3);">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                        </div>
                                        <span style="font-size: 13px; color: rgba(255,255,255,0.7); font-weight: 600;">${t('hr.reviews.stat.averageScore')}</span>
                                    </div>
                                    <div id="avgReviewScore" style="font-size: 28px; font-weight: 700; color: #f59e0b;">0.0</div>
                                    <p style="margin: 6px 0 0; font-size: 12px; color: rgba(255,255,255,0.6);">${t('hr.reviews.stat.scoreLabel')}</p>
                                </div>

                                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 16px; padding: 20px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='#10b981'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(16, 185, 129, 0.4)'; this.style.transform='translateY(0)'">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <div style="width: 40px; height: 40px; background: rgba(16,185,129,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(16,185,129,0.3);">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                        </div>
                                        <span style="font-size: 13px; color: rgba(255,255,255,0.7); font-weight: 600;">${t('hr.reviews.stat.excellent')}</span>
                                    </div>
                                    <div id="excellentReviewsCount" style="font-size: 28px; font-weight: 700; color: #10b981;">0</div>
                                    <p style="margin: 6px 0 0; font-size: 12px; color: rgba(255,255,255,0.6);">${t('hr.reviews.stat.excellentLabel')}</p>
                                </div>
                            </div>
                            
                            <!-- Actions Bar -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <button onclick="showAddReviewModal()" class="hr-btn" style="display: flex; align-items: center; gap: 8px; padding: 12px 24px; font-size: 14px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                        ${t('hr.reviews.btn.new')}
                                    </button>
                                    
                                    <select id="reviewFilterEmployee" onchange="filterReviews()" style="padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; color: white; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'">
                                        <option value="" style="background: #1e3a8a; color: white;">${t('hr.reviews.filter.allEmployees')}</option>
                                    </select>
                                    
                                    <select id="reviewFilterPeriod" onchange="filterReviews()" style="padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; color: white; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'">
                                        <option value="" style="background: #1e3a8a; color: white;">${t('hr.reviews.filter.allPeriods')}</option>
                                    </select>
                                </div>
                                
                                <input type="text" id="reviewSearchInput" placeholder="${t('hr.reviews.filter.search')}" oninput="filterReviews()" style="padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; font-weight: 600; width: 250px; max-width: 100%; color: white; transition: all 0.3s; outline: none;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'">
                            </div>
                            
                            <!-- Reviews List -->
                            <div id="reviewsListContainer" style="display: grid; gap: 16px;">
                                <!-- Reviews dynamiques -->
                            </div>
                            
                            <!-- Empty State -->
                            <div id="reviewsEmptyState" style="display: none; text-align: center; padding: 60px 20px;">
                                <div style="width: 80px; height: 80px; background: rgba(16, 185, 129, 0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; border: 1px solid rgba(16, 185, 129, 0.3);">
                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                                </div>
                                <h3 style="margin: 0 0 8px; font-size: 18px; font-weight: 600; color: white;">${t('hr.reviews.empty.title')}</h3>
                                <p style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.6);">${t('hr.reviews.empty.desc')}</p>
                            </div>
                        </div>
                        

                        <!-- Turnover Prediction Tab -->
                        <div id="hrContentTurnover" class="hr-content" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; padding: 20px; background: linear-gradient(135deg, #0a4d3c 0%, #064e3b 50%, #1e3a8a 100%); background-attachment: fixed; z-index: 9999;">
                            <!-- RGPD Warning Banner -->
                            <div class="turnover-rgpd-banner" style="background: linear-gradient(135deg, #10b981 0%, #06b6d4 50%, #3b82f6 100%); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white;">
                                <div class="turnover-rgpd-banner-inner" style="display: flex; align-items: start; gap: 16px;">
                                    <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                    </div>
                                    <div style="flex: 1;">
                                        <h3 style="margin: 0 0 8px; font-size: 16px; font-weight: 700;">${t('hr.turnover.rgpd.title')}</h3>
                                        <p style="margin: 0 0 12px; font-size: 13px; line-height: 1.6; opacity: 0.95;">
                                            ${t('hr.turnover.rgpd.desc')}
                                        </p>
                                        <div class="turnover-rgpd-badges" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;">${t('hr.turnover.rgpd.badge.minimized')}</span>
                                            <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;">${t('hr.turnover.rgpd.badge.explainable')}</span>
                                            <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;">${t('hr.turnover.rgpd.badge.noSurveillance')}</span>
                                            <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;">${t('hr.turnover.rgpd.badge.consent')}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Stats Cards -->
                            <div id="turnoverStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 32px;">
                                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 16px; padding: 24px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='#ef4444'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(239, 68, 68, 0.4)'; this.style.transform='translateY(0)'">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                                        <div>
                                            <p style="margin: 0 0 8px; color: rgba(255,255,255,0.7); font-size: 13px; font-weight: 600;">${t('hr.turnover.risk.high')}</p>
                                            <h3 id="highRiskCount" style="margin: 0; font-size: 32px; font-weight: 700; color: #ef4444;">0</h3>
                                        </div>
                                        <div style="width: 48px; height: 48px; background: rgba(239,68,68,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(239,68,68,0.3);">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                        </div>
                                    </div>
                                    <p style="margin: 0; font-size: 12px; color: rgba(255,255,255,0.6);">${t('hr.turnover.risk.highDesc')}</p>
                                </div>
                                
                                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 16px; padding: 24px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='#f59e0b'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(245, 158, 11, 0.4)'; this.style.transform='translateY(0)'">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                                        <div>
                                            <p style="margin: 0 0 8px; color: rgba(255,255,255,0.7); font-size: 13px; font-weight: 600;">${t('hr.turnover.risk.medium')}</p>
                                            <h3 id="mediumRiskCount" style="margin: 0; font-size: 32px; font-weight: 700; color: #f59e0b;">0</h3>
                                        </div>
                                        <div style="width: 48px; height: 48px; background: rgba(245,158,11,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(245,158,11,0.3);">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                                        </div>
                                    </div>
                                    <p style="margin: 0; font-size: 12px; color: rgba(255,255,255,0.6);">${t('hr.turnover.risk.mediumDesc')}</p>
                                </div>
                                
                                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 16px; padding: 24px; backdrop-filter: blur(10px); transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='#10b981'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(16, 185, 129, 0.4)'; this.style.transform='translateY(0)'">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                                        <div>
                                            <p style="margin: 0 0 8px; color: rgba(255,255,255,0.7); font-size: 13px; font-weight: 600;">${t('hr.turnover.risk.low')}</p>
                                            <h3 id="lowRiskCount" style="margin: 0; font-size: 32px; font-weight: 700; color: #10b981;">0</h3>
                                        </div>
                                        <div style="width: 48px; height: 48px; background: rgba(16,185,129,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(16,185,129,0.3);">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                        </div>
                                    </div>
                                    <p style="margin: 0; font-size: 12px; color: rgba(255,255,255,0.6);">${t('hr.turnover.risk.lowDesc')}</p>
                                </div>
                            </div>
                            
                            <!-- Actions Bar -->
                            <div id="turnoverActionsBar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                                <div id="turnoverActionsLeft" style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <button onclick="analyzeTurnoverRisks()" class="hr-btn" style="display: flex; align-items: center; gap: 8px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                        ${t('hr.turnover.btn.analyze')}
                                    </button>
                                    
                                    <select id="turnoverRiskFilter" onchange="filterTurnoverList()" style="padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; color: white; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'">
                                        <option value="">${t('hr.turnover.filter.allLevels')}</option>
                                        <option value="high">${t('hr.turnover.risk.high')}</option>
                                        <option value="medium">${t('hr.turnover.risk.medium')}</option>
                                        <option value="low">${t('hr.turnover.risk.low')}</option>
                                    </select>

                                    <input id="turnoverEmployeeSearch" type="text" placeholder="${t('hr.turnover.searchPlaceholder')}" oninput="filterTurnoverList()" style="min-width: 260px; padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; font-weight: 600; color: white; transition: all 0.3s; outline: none;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'" />
                                </div>
                                
                                <div id="turnoverActionsRight" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <button onclick="showRGPDSettings()" style="padding: 12px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; transition: all 0.3s; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(16, 185, 129, 0.3)'; this.style.borderColor='#10b981'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='rgba(16, 185, 129, 0.3)'">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                        ${t('hr.turnover.btn.rgpdSettings')}
                                    </button>
                                    <button onclick="showHRTab('dashboard'); scheduleHRTabCleanup('turnover'); const area=document.querySelector('#hrManagementOverlay .hr-content-area'); if (area) area.scrollTop = 0;" style="padding: 12px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; transition: all 0.3s; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255,255,255,0.18)'; this.style.borderColor='rgba(255,255,255,0.35)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='rgba(255,255,255,0.2)'">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                        ${t('hr.turnover.btn.close')}
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Turnover Risk List -->
                            <div id="turnoverListContainer" style="display: grid; gap: 16px;">
                                <!-- Risk cards dynamiques -->
                            </div>
                            
                            <!-- Empty State -->
                            <div id="turnoverEmptyState" style="text-align: center; padding: 60px 20px;">
                                <div style="width: 80px; height: 80px; background: rgba(16, 185, 129, 0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; border: 1px solid rgba(16, 185, 129, 0.3);">
                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                </div>
                                <h3 style="margin: 0 0 8px; font-size: 18px; font-weight: 600; color: white;">${t('hr.turnover.empty.title')}</h3>
                                <p style="margin: 0 0 16px; font-size: 14px; color: rgba(255,255,255,0.6);">${t('hr.turnover.empty.desc')}</p>
                                <p style="margin: 0; font-size: 12px; color: rgba(255,255,255,0.6); max-width: 500px; margin: 0 auto; display: inline-flex; align-items: center; gap: 6px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #10b981;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    ${t('hr.turnover.empty.hint')}
                                </p>
                            </div>
                        </div>
                        
                        <!-- Recruitment / CV Screening Tab -->
                        <div id="hrContentRecruitment" class="hr-content" style="display: none;">
                                <!-- RGPD Warning Banner -->
                                <div class="hr-recruitment-rgpd" style="background: linear-gradient(135deg, #10b981 0%, #06b6d4 50%, #3b82f6 100%); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white; border: 1px solid rgba(16, 185, 129, 0.25);">
                                    <div class="hr-recruitment-rgpd-inner" style="display: flex; align-items: start; gap: 16px;">
                                        <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                        </div>
                                        <div style="flex: 1;">
                                            <h3 style="margin: 0 0 8px; font-size: 16px; font-weight: 800;">${t('hr.recruitment.rgpd.title')}</h3>
                                            <p style="margin: 0 0 12px; font-size: 13px; line-height: 1.6; opacity: 0.95;">
                                                ${t('hr.recruitment.rgpd.desc')}
                                            </p>
                                            <div class="hr-recruitment-rgpd-badges" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700;">${t('hr.recruitment.rgpd.badge.minimized')}</span>
                                                <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700;">${t('hr.recruitment.rgpd.badge.explainable')}</span>
                                                <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700;">${t('hr.recruitment.rgpd.badge.human')}</span>
                                                <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700;">${t('hr.recruitment.rgpd.badge.audit')}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stats Cards (coh√©rence HR) -->
                                <div class="hr-recruitment-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px;">
                                    <div class="hr-stat-card">
                                        <div class="hr-stat-label">${t('hr.recruitment.stats.activeJobs')}</div>
                                        <div id="activeJobsCount" class="hr-stat-value">0</div>
                                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.55); margin-top: 4px;">${t('hr.recruitment.stats.activeJobsSub')}</div>
                                    </div>

                                    <div class="hr-stat-card">
                                        <div class="hr-stat-label">${t('hr.recruitment.stats.cvs')}</div>
                                        <div id="totalCVsCount" class="hr-stat-value">0</div>
                                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.55); margin-top: 4px;">${t('hr.recruitment.stats.cvsSub')}</div>
                                    </div>

                                    <div class="hr-stat-card">
                                        <div class="hr-stat-label">${t('hr.recruitment.stats.shortlist')}</div>
                                        <div id="shortlistCount" class="hr-stat-value">0</div>
                                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.55); margin-top: 4px;">${t('hr.recruitment.stats.shortlistSub')}</div>
                                    </div>

                                    <div class="hr-stat-card">
                                        <div class="hr-stat-label">${t('hr.recruitment.stats.avgScore')}</div>
                                        <div id="avgMatchScore" style="font-size: 32px; font-weight: 800; color: #f59e0b;">0</div>
                                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.55); margin-top: 4px;">${t('hr.recruitment.stats.avgScoreSub')}</div>
                                    </div>
                                </div>

                                <!-- Sauvegarde / Restauration -->
                                <div class="hr-section hr-recruitment-backup" style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                                    <div>
                                        <div class="hr-section-title" style="margin-bottom: 4px;">${t('hr.recruitment.backup.title')}</div>
                                        <p style="margin: 0; font-size: 12px; color: rgba(255,255,255,0.65);">${t('hr.recruitment.backup.desc')}</p>
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                        <button onclick="saveRecruitmentData()" class="hr-btn" style="padding: 12px 16px; font-size: 13px; display: inline-flex; align-items: center; gap: 8px;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                            ${t('hr.recruitment.backup.save')}
                                        </button>
                                        <button onclick="restoreRecruitmentData()" class="hr-btn" style="padding: 12px 16px; font-size: 13px; display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2);">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                            ${t('hr.recruitment.backup.restore')}
                                        </button>
                                    </div>
                                </div>

                                <!-- Actions Bar -->
                                <div class="hr-recruitment-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                                    <div class="hr-recruitment-actions-left" style="display: flex; gap: 12px; flex-wrap: wrap; flex: 1; min-width: 280px;">
                                        <button onclick="showAddJobModal()" class="hr-btn" style="padding: 12px 18px; font-size: 14px;">${t('hr.recruitment.actions.newJob')}</button>
                                        <button onclick="showUploadCVModal()" class="hr-btn" style="padding: 12px 18px; font-size: 14px; background: rgba(255,255,255,0.12); border: 1px solid rgba(16, 185, 129, 0.3);">${t('hr.recruitment.actions.uploadCV')}</button>

                                        <select id="jobFilterSelect" onchange="filterCandidatesByJob()" style="padding: 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; color: white; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'; this.style.background='rgba(255,255,255,0.12)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.background='rgba(255,255,255,0.08)'">
                                            <option value="" style="background: #1e3a8a; color: white;">${t('hr.recruitment.filter.allJobs')}</option>
                                        </select>
                                    </div>

                                    <div class="hr-recruitment-actions-right" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                        <button id="recruitmentShortlistFilterBtn" onclick="toggleRecruitmentShortlistOnly()" style="padding: 12px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; color: white; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; transition: all 0.3s; backdrop-filter: blur(10px);" onmouseover="this.style.borderColor='#10b981'" onmouseout="this.style.borderColor='rgba(16, 185, 129, 0.3)'">
                                            ‚≠ê ${t('hr.recruitment.actions.toggleShortlist')}
                                        </button>
                                        <button onclick="showRecruitmentSettings()" style="padding: 12px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; color: white; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; transition: all 0.3s; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(16, 185, 129, 0.3)'; this.style.borderColor='#10b981'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='rgba(16, 185, 129, 0.3)'">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m6-12l-3 3m-6 6l-3 3m12 0l-3-3m-6-6l-3-3"/></svg>
                                            ${t('hr.recruitment.actions.scoringSettings')}
                                        </button>
                                    </div>
                                </div>

                                <!-- Candidates List -->
                                <div id="candidatesListContainer" class="hr-section" style="display: grid; gap: 16px; min-height: 260px;">
                                    <!-- Candidates cards dynamiques -->
                                </div>

                                <!-- Empty State -->
                                <div id="candidatesEmptyState" class="hr-empty" style="display: none; text-align: center; padding: 60px 20px; padding-bottom: calc(80px + env(safe-area-inset-bottom, 24px)); margin-bottom: env(safe-area-inset-bottom, 0px);">
                                    <div style="width: 80px; height: 80px; background: rgba(16,185,129,0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; border: 1px solid rgba(16, 185, 129, 0.3);">
                                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                    </div>
                                    <p class="hr-empty-title">${t('hr.recruitment.empty.title')}</p>
                                    <p style="margin: 0 0 18px; font-size: 14px; color: rgba(255,255,255,0.65);">${t('hr.recruitment.empty.desc')}</p>
                                    <div class="hr-recruitment-empty-actions" style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                                        <button onclick="showAddJobModal()" class="hr-btn" style="padding: 12px 18px; font-size: 14px;">${t('hr.recruitment.empty.createJob')}</button>
                                        <button onclick="showUploadCVModal()" class="hr-btn" style="padding: 12px 18px; font-size: 14px; background: rgba(255,255,255,0.12); border: 1px solid rgba(16, 185, 129, 0.3);">${t('hr.recruitment.empty.uploadCV')}</button>
                                    </div>
                                </div>
                                <!-- Safe Area Spacer for Android Navigation Bar -->
                                <div style="height: calc(40px + env(safe-area-inset-bottom, 24px)); flex-shrink: 0;"></div>
                        </div>
                    </div>
                    
                </div>
            `;
            
            try {
                document.documentElement.classList.add('hr-overlay-open');
                document.body.classList.add('hr-overlay-open');
            } catch (_) {}

            document.body.appendChild(overlay);

            // √âtat initial: dashboard (permet √† showHRTab d'avoir un √©tat propre)
            try { showHRTab('dashboard'); } catch (_) {}
            
            // Initialize HR data (diff√©r√© pour laisser le navigateur peindre l'UI)
            setTimeout(() => {
                try {
                    initializeHRData();
                } catch (e) {
                    console.error('Erreur initializeHRData:', e);
                }
            }, 0);
        }
        
        function closeHRManagement() {
            const overlay = document.getElementById('hrManagementOverlay');
            if (overlay) {
                overlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    try { overlay.remove(); } catch (_) {}
                    try {
                        document.documentElement.classList.remove('hr-overlay-open');
                        document.body.classList.remove('hr-overlay-open');
                    } catch (_) {}
                }, 300);
            } else {
                try {
                    document.documentElement.classList.remove('hr-overlay-open');
                    document.body.classList.remove('hr-overlay-open');
                } catch (_) {}
            }
        }
        
        // ====================================
        // R&D MANAGEMENT SYSTEM
        // ====================================
        
        function showRnDHelp() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const isEn = (lang === 'en');
            
            const existingHelp = document.getElementById('rnd-help-modal');
            if (existingHelp) existingHelp.remove();
            
            const helpModal = document.createElement('div');
            helpModal.id = 'rnd-help-modal';
            helpModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                z-index: 10002;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                backdrop-filter: blur(5px);
                animation: fadeIn 0.2s ease-out;
            `;
            
            const title = isEn ? 'Agent Dev User Guide' : 'Guide Complet Agent Dev';
            const subtitle = isEn ? 'Master the Research & Development Hub' : 'Ma√Ætriser le R&D Hub';
            const closeText = isEn ? 'Close Guide' : 'Fermer le guide';
            
            const contentFr = `
                <h3>1. Introduction</h3>
                <p><strong>Agent Dev</strong> est votre assistant sp√©cialis√© en Recherche & D√©veloppement, Innovation et gestion de projets techniques.</p>
                
                <h3>2. Fonctionnalit√©s Cl√©s</h3>
                <ul>
                    <li><strong>Projets :</strong> Suivi des projets de recherche, budgets et ressources.</li>
                    <li><strong>Jalons :</strong> Gestion des √©tapes cl√©s (Milestones) et KPIs.</li>
                    <li><strong>Documents :</strong> Centralisation de la documentation technique et sp√©cifications.</li>
                    <li><strong>Risques :</strong> Analyse et mitigation des risques projets.</li>
                </ul>
                
                <h3>3. Commandes Utiles</h3>
                <ul>
                    <li><code>/projet [nom]</code> : Cr√©er ou analyser un projet.</li>
                    <li><code>/risque</code> : Identifier les risques potentiels.</li>
                    <li><code>/roadmap</code> : G√©n√©rer une roadmap de d√©veloppement.</li>
                </ul>
                
                <h3>4. Astuces</h3>
                <p>Utilisez l'Agent Dev pour g√©n√©rer des sp√©cifications techniques ou analyser la faisabilit√© de nouvelles id√©es.</p>
            `;
            
            const contentEn = `
                <h3>1. Introduction</h3>
                <p><strong>Agent Dev</strong> is your specialized assistant for Research & Development, Innovation, and technical project management.</p>
                
                <h3>2. Key Features</h3>
                <ul>
                    <li><strong>Projects:</strong> Track research projects, budgets, and resources.</li>
                    <li><strong>Milestones:</strong> Manage key milestones and KPIs.</li>
                    <li><strong>Documents:</strong> Centralize technical documentation and specs.</li>
                    <li><strong>Risks:</strong> Analyze and mitigate project risks.</li>
                </ul>
                
                <h3>3. Useful Commands</h3>
                <ul>
                    <li><code>/project [name]</code> : Create or analyze a project.</li>
                    <li><code>/risk</code> : Identify potential risks.</li>
                    <li><code>/roadmap</code> : Generate a development roadmap.</li>
                </ul>
                
                <h3>4. Tips</h3>
                <p>Use Agent Dev to generate technical specifications or analyze the feasibility of new ideas.</p>
            `;

            helpModal.innerHTML = `
                <div style="
                    background: #1e1b4b;
                    width: 100%;
                    max-width: 700px;
                    max-height: 85vh;
                    border-radius: 16px;
                    border: 1px solid rgba(99, 102, 241, 0.3);
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                    overflow: hidden;
                ">
                    <div style="
                        padding: 24px;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                        background: rgba(99, 102, 241, 0.1);
                        display: flex;
                        justify-content: space-between;
                        align-items: start;
                    ">
                        <div>
                            <h2 style="margin: 0; font-size: 24px; color: white;">${title}</h2>
                            <p style="margin: 4px 0 0; color: rgba(255, 255, 255, 0.6);">${subtitle}</p>
                        </div>
                        <button onclick="document.getElementById('rnd-help-modal').remove()" style="
                            background: none;
                            border: none;
                            color: rgba(255, 255, 255, 0.5);
                            cursor: pointer;
                            padding: 4px;
                        ">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <div style="
                        padding: 32px;
                        overflow-y: auto;
                        color: rgba(255, 255, 255, 0.9);
                        line-height: 1.6;
                        font-family: inherit;
                    ">
                        <style>
                            #rnd-help-modal h3 { color: #818cf8; margin-top: 24px; margin-bottom: 12px; font-size: 18px; }
                            #rnd-help-modal h3:first-child { margin-top: 0; }
                            #rnd-help-modal ul { padding-left: 20px; margin-bottom: 16px; }
                            #rnd-help-modal li { margin-bottom: 8px; }
                            #rnd-help-modal code { background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #a5b4fc; }
                            #rnd-help-modal p { margin-bottom: 16px; }
                        </style>
                        ${isEn ? contentEn : contentFr}
                    </div>
                    <div style="
                        padding: 20px 24px;
                        border-top: 1px solid rgba(255, 255, 255, 0.1);
                        background: rgba(0, 0, 0, 0.2);
                        display: flex;
                        justify-content: flex-end;
                    ">
                        <button onclick="document.getElementById('rnd-help-modal').remove()" style="
                            padding: 10px 20px;
                            background: linear-gradient(135deg, #6366f1, #8b5cf6);
                            border: none;
                            border-radius: 8px;
                            color: white;
                            font-weight: 600;
                            cursor: pointer;
                        ">${closeText}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpModal);
            
            // Close on click outside
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    helpModal.remove();
                }
            });
        }

        // Chargement modulaire du module R&D
        let rndModuleLoaded = false;
        
        function loadRnDModule() {
            // üéØ Tracking: Utilisateur ouvre Research & Development
            AxilumContext.updateActivity('Research & Development Hub', 'Agent dev', 'Ouverture du module');
            
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                errorOpen: lang === 'en' ? 'Error opening AI R&D' : 'Erreur lors de l\'ouverture d\'AI R&D',
                errorLoad: lang === 'en' ? 'Error loading AI R&D. Please try again.' : 'Erreur lors du chargement d\'AI R&D. Veuillez r√©essayer.'
            };

            // Si le module est d√©j√† charg√© et les fonctions disponibles
            if (rndModuleLoaded && typeof openRnD === 'function') {
                openRnD();
                return;
            }
            
            // Charger le wrapper module
            const script = document.createElement('script');
            script.src = '/js/rnd-module.js';
            script.onload = function() {
                rndModuleLoaded = true;
                console.log('Module R&D wrapper charg√©');
                // Appeler directement openRnD qui est d√©j√† dans index.html
                if (typeof openRnD === 'function') {
                    openRnD();
                } else {
                    console.error('openRnD non disponible');
                    alert(t.errorOpen);
                }
            };
            script.onerror = function() {
                console.error('Erreur lors du chargement du module R&D');
                // Fallback: essayer d'appeler directement la fonction
                if (typeof openRnD === 'function') {
                    openRnD();
                } else {
                    alert(t.errorLoad);
                }
            };
            document.head.appendChild(script);
        }
        
        function openRnD() {
            // Fermer AI Management s'il est ouvert
            const excelAiOverlay = document.getElementById('excelAiOverlay');
            if (excelAiOverlay) {
                excelAiOverlay.remove();
            }

            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                title: 'Research & Development Hub',
                subtitle: 'Innovation & Technology Center',
                tabDashboard: 'Dashboard',
                tabProjects: lang === 'en' ? 'R&D Projects' : 'Projets R&D',
                tabMilestones: lang === 'en' ? 'Milestones & KPIs' : 'Jalons & KPIs',
                tabDocs: lang === 'en' ? 'Docs & Risks' : 'Documentation & Risques',
                tabCompany: lang === 'en' ? 'Company' : 'Entreprise',
                tabAgent: 'Agent dev',
                statsProjects: lang === 'en' ? 'Active Projects' : 'Projets Actifs',
                statsMilestones: lang === 'en' ? 'Upcoming Milestones' : 'Jalons √† Venir',
                statsDocs: lang === 'en' ? 'Documents' : 'Documents',
                statsRisks: lang === 'en' ? 'Active Risks' : 'Risques Actifs',
                actionsReady: lang === 'en' ? 'Agent dev actions ready' : 'Actions Agent dev pr√™tes',
                actionsPending: lang === 'en' ? 'action(s) pending. Click to apply.' : 'action(s) en attente. Cliquez pour appliquer au dashboard.',
                applyActions: lang === 'en' ? 'Apply to dashboard' : 'Appliquer au dashboard',
                priorityProjects: lang === 'en' ? 'Priority Projects' : 'Projets Prioritaires',
                titleMilestones: lang === 'en' ? 'Milestones & Performance Indicators' : 'Jalons & Indicateurs de Performance',
                btnAddMilestone: lang === 'en' ? 'Add Milestone' : 'Ajouter Jalon',
                titleDocs: lang === 'en' ? 'Project Documents' : 'Documents Projet',
                btnAddDoc: lang === 'en' ? 'Add Document' : 'Ajouter Document',
                titleRisks: lang === 'en' ? 'Risk Management' : 'Gestion des Risques',
                btnAddRisk: lang === 'en' ? 'Add Risk' : 'Ajouter Risque',
                titleProjects: lang === 'en' ? 'Research Projects' : 'Projets de Recherche',
                btnAddProject: lang === 'en' ? 'Create Project' : 'Cr√©er Projet',
                titleAgent: 'Agent dev',
                agentSub: lang === 'en' ? 'AI Assistant specialized in R&D and multi-domain innovation' : 'Assistant IA sp√©cialis√© en R&D et innovation multi-domaines',
                clearChatTitle: lang === 'en' ? 'Clear chat history' : 'Effacer l\'historique du chat',
                btnClearChat: lang === 'en' ? 'Clear chat' : 'Effacer chat',
                chatPlaceholder: lang === 'en' ? 'Ask a question to Agent dev...' : 'Posez votre question √† Agent dev...',
                sendBtn: lang === 'en' ? 'Send' : 'Envoyer'
            };
            
            // Fermer HR Management s'il est ouvert
            const hrOverlay = document.getElementById('hrManagementOverlay');
            if (hrOverlay) {
                hrOverlay.remove();
            }
            
            // Fermer l'overlay R&D existant s'il y en a un
            const existingOverlay = document.getElementById('rndOverlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // Cr√©er l'overlay R&D
            const overlay = document.createElement('div');
            overlay.id = 'rndOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
                z-index: 10001;
                animation: fadeIn 0.3s ease;
                overflow: hidden;
            `;
            
            overlay.innerHTML = `
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { transform: translateY(-20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.5; }
                    }
                    @keyframes glow {
                        0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
                        50% { box-shadow: 0 0 30px rgba(99, 102, 241, 0.8), 0 0 40px rgba(139, 92, 246, 0.6); }
                    }
                    
                    .rnd-container {
                        width: 100%;
                        height: 100%;
                        display: flex;
                        flex-direction: column;
                        color: white;
                    }
                    
                    .rnd-header {
                        background: rgba(0, 0, 0, 0.3);
                        padding: 24px 40px;
                        border-bottom: 1px solid rgba(99, 102, 241, 0.3);
                        backdrop-filter: blur(10px);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .rnd-header-actions {
                        display: flex;
                        gap: 12px;
                    }
                    
                    .rnd-title {
                        font-size: 32px;
                        font-weight: 700;
                        background: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                        margin: 0 0 8px;
                        letter-spacing: -0.5px;
                    }
                    
                    .rnd-subtitle {
                        font-size: 14px;
                        color: rgba(255, 255, 255, 0.6);
                        margin: 0;
                    }
                    
                    .rnd-tabs {
                        display: flex;
                        gap: 8px;
                        padding: 20px 40px;
                        background: rgba(0, 0, 0, 0.2);
                        border-bottom: 1px solid rgba(99, 102, 241, 0.2);
                    }
                    
                    .rnd-tab {
                        padding: 12px 24px;
                        background: rgba(99, 102, 241, 0.1);
                        border: 1px solid rgba(99, 102, 241, 0.3);
                        border-radius: 8px;
                        color: rgba(255, 255, 255, 0.7);
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-weight: 600;
                        font-size: 14px;
                    }
                    
                    .rnd-tab:hover {
                        background: rgba(99, 102, 241, 0.2);
                        border-color: rgba(99, 102, 241, 0.5);
                        color: white;
                        transform: translateY(-2px);
                    }
                    
                    .rnd-tab.active {
                        background: linear-gradient(135deg, #6366f1, #8b5cf6);
                        border-color: transparent;
                        color: white;
                        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
                    }
                    
                    .rnd-content {
                        flex: 1;
                        overflow-y: auto;
                        padding: 40px;
                    }
                    
                    .rnd-dashboard {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                        gap: 24px;
                        margin-bottom: 40px;
                    }
                    
                    .rnd-stat-card {
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(99, 102, 241, 0.3);
                        border-radius: 16px;
                        padding: 24px;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .rnd-stat-card::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 3px;
                        background: linear-gradient(90deg, #6366f1, #8b5cf6, #ec4899);
                    }
                    
                    .rnd-stat-card:hover {
                        background: rgba(255, 255, 255, 0.08);
                        border-color: rgba(99, 102, 241, 0.5);
                        transform: translateY(-4px);
                        box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
                    }
                    
                    .rnd-stat-value {
                        font-size: 40px;
                        font-weight: 700;
                        margin: 0 0 8px;
                        background: linear-gradient(135deg, #6366f1, #8b5cf6);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                    }
                    
                    .rnd-stat-label {
                        font-size: 13px;
                        color: rgba(255, 255, 255, 0.6);
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        font-weight: 600;
                    }
                    
                    .rnd-section {
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(99, 102, 241, 0.2);
                        border-radius: 16px;
                        padding: 32px;
                        margin-bottom: 24px;
                    }
                    
                    .rnd-section-title {
                        font-size: 20px;
                        font-weight: 700;
                        color: white;
                        margin: 0 0 24px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }
                    
                    .rnd-section-title::before {
                        content: '';
                        width: 4px;
                        height: 24px;
                        background: linear-gradient(180deg, #6366f1, #8b5cf6);
                        border-radius: 2px;
                    }
                    
                    .rnd-item {
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid rgba(99, 102, 241, 0.2);
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 16px;
                        transition: all 0.3s ease;
                    }
                    
                    .rnd-item:hover {
                        border-color: rgba(99, 102, 241, 0.5);
                        background: rgba(0, 0, 0, 0.4);
                        transform: translateX(4px);
                    }
                    
                    .rnd-btn {
                        padding: 12px 24px;
                        background: linear-gradient(135deg, #6366f1, #8b5cf6);
                        border: none;
                        border-radius: 8px;
                        color: white;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-size: 14px;
                    }
                    
                    .rnd-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
                    }
                    


  .rnd-icon-btn {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.75);
      cursor: pointer;
      width: 32px;
      height: 32px;
      padding: 6px;
      border-radius: 8px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
  }

  .rnd-icon-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.95);
  }

  .rnd-icon-btn.delete:hover {
      background: rgba(239, 68, 68, 0.14);
      color: #fca5a5;
  }

  .rnd-icon-btn svg {
      width: 20px;
      height: 20px;
      stroke: currentColor;
  }
                    .rnd-close-btn {
                        width: 40px;
                        height: 40px;
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }
                    
                    .rnd-close-btn:hover {
                        background: rgba(239, 68, 68, 0.2);
                        border-color: rgba(239, 68, 68, 0.5);
                        transform: rotate(90deg);
                    }

                    .rnd-help-btn {
                        width: 40px;
                        height: 40px;
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }
                    
                    .rnd-help-btn:hover {
                         background: rgba(255, 255, 255, 0.1);
                         border-color: rgba(255, 255, 255, 0.3);
                    }
                    
                    .rnd-chat-container {
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid rgba(99, 102, 241, 0.3);
                        border-radius: 16px;
                        height: 500px;
                        display: flex;
                        flex-direction: column;
                    }
                    
                    .rnd-chat-messages {
                        flex: 1;
                        overflow-y: auto;
                        padding: 24px;
                    }

                    .rnd-chat-messages, .rnd-chat-messages * {
                        overflow-wrap: anywhere;
                        word-break: break-word;
                    }
                    
                    .rnd-chat-input {
                        padding: 20px;
                        border-top: 1px solid rgba(99, 102, 241, 0.2);
                        display: flex;
                        gap: 12px;
                    }
                    
                    .rnd-input {
                        flex: 1;
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(99, 102, 241, 0.3);
                        border-radius: 8px;
                        padding: 12px 16px;
                        color: white;
                        font-size: 14px;
                    }
                    
                    .rnd-input:focus {
                        outline: none;
                        border-color: rgba(99, 102, 241, 0.6);
                        background: rgba(255, 255, 255, 0.08);
                    }
                    
                    .rnd-badge {
                        display: inline-block;
                        padding: 4px 8px;
                        border-radius: 8px;
                        font-size: 11px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }

                    /* Badges (phase + domaine) dans la liste Projets: wrap en mobile */
                    .rnd-project-badges {
                        display: flex;
                        flex-wrap: wrap;
                        align-items: center;
                        gap: 8px;
                        margin-top: 6px;
                    }
                    .rnd-project-badges .rnd-badge {
                        max-width: 100%;
                    }
                    /* Domaine peut √™tre long: √©viter qu'il s'√©tire sur mobile */
                    .rnd-project-badges .rnd-badge.rnd-badge-medium {
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                    
                    .rnd-badge-high {
                        background: rgba(239, 68, 68, 0.2);
                        color: #fca5a5;
                        border: 1px solid rgba(239, 68, 68, 0.3);
                    }
                    
                    .rnd-badge-medium {
                        background: rgba(245, 158, 11, 0.2);
                        color: #fcd34d;
                        border: 1px solid rgba(245, 158, 11, 0.3);
                    }
                    
                    .rnd-badge-low {
                        background: rgba(16, 185, 129, 0.2);
                        color: #6ee7b7;
                        border: 1px solid rgba(16, 185, 129, 0.3);
                    }
                    
                    .rnd-empty {
                        text-align: center;
                        padding: 60px 20px;
                        color: rgba(255, 255, 255, 0.5);
                    }
                    
                    .rnd-empty-title {
                        font-size: 18px;
                        font-weight: 600;
                        margin: 0 0 8px;
                        color: rgba(255, 255, 255, 0.7);
                    }
                    
                    /* Responsive Design - Mode Bureau Mobile & Tablette */
                    @media (max-width: 1200px) {
                        .rnd-content {
                            padding: 30px;
                        }
                        .rnd-header {
                            padding: 20px 30px;
                        }
                        .rnd-tabs {
                            padding: 16px 30px;
                        }
                        .rnd-title {
                            font-size: 28px;
                        }
                        .rnd-stat-value {
                            font-size: 36px;
                        }
                        .rnd-dashboard {
                            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                        }
                    }
                    
                    @media (max-width: 768px) {
                        .rnd-header {
                            padding: 16px 20px;
                        }
                        .rnd-title {
                            font-size: 24px;
                            max-width: 100%;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        }
                        .rnd-subtitle {
                            font-size: 12px;
                        }
                        .rnd-close-btn {
                            width: 36px;
                            height: 36px;
                        }
                        .rnd-help-btn {
                            width: 36px;
                            height: 36px;
                        }
                        .rnd-tabs {
                            padding: 12px 20px;
                            gap: 6px;
                            overflow-x: auto;
                            -webkit-overflow-scrolling: touch;
                        }
                        .rnd-tab {
                            padding: 10px 16px;
                            font-size: 13px;
                            white-space: nowrap;
                            flex-shrink: 0;
                        }
                        .rnd-content {
                            padding: 20px;
                        }
                        .rnd-section {
                            padding: 20px;
                            margin-bottom: 16px;
                        }
                        .rnd-section-title {
                            font-size: 18px;
                        }
                        .rnd-item {
                            padding: 16px;
                        }
                        .rnd-stat-card {
                            padding: 20px;
                        }
                        .rnd-stat-value {
                            font-size: 32px;
                        }
                        .rnd-stat-label {
                            font-size: 12px;
                        }
                        .rnd-btn {
                            padding: 10px 20px;
                            font-size: 13px;
                        }
                        .rnd-dashboard {
                            gap: 16px;
                            margin-bottom: 24px;
                        }
                        .rnd-chat-container {
                            height: 60vh;
                            min-height: 420px;
                        }
                        .rnd-chat-messages {
                            padding: 16px;
                        }
                        .rnd-chat-input {
                            padding: 16px;
                            gap: 10px;
                        }
                        
                        /* Agent Dev - Header responsive */
                        #rndAgent > div:first-child > div:first-child {
                            flex-direction: column !important;
                            gap: 16px;
                        }
                        
                        #rndAgent h2 {
                            font-size: 20px !important;
                        }
                        
                        #rndAgent > div:first-child > div:first-child button {
                            width: 100%;
                            justify-content: center;
                        }
                        
                        #rndAgent > div:first-child label {
                            font-size: 12px !important;
                        }
                        
                        /* Modal Informations Projet - Responsive */
                        #projectDetailsModal {
                            padding: 16px !important;
                        }
                        
                        #projectDetailsModal > div {
                            width: 98% !important;
                            max-height: 90vh !important;
                        }
                        
                        #projectDetailsModal h2 {
                            font-size: 22px !important;
                        }
                        
                        #projectDetailsModal > div > div:first-child {
                            padding: 20px 24px !important;
                            flex-direction: column !important;
                            gap: 16px;
                        }
                        
                        #projectDetailsModal > div > div:first-child > div:first-child > div {
                            flex-wrap: wrap;
                        }
                        
                        #projectDetailsModal > div > div:last-child {
                            padding: 24px !important;
                        }
                        
                        /* M√©triques en 2 colonnes sur tablette */
                        #projectDetailsModal > div > div:last-child > div:nth-child(2) {
                            grid-template-columns: repeat(2, 1fr) !important;
                        }
                        
                        /* Description et Probl√®me en colonne */
                        #projectDetailsModal > div > div:last-child > div:nth-child(3) {
                            grid-template-columns: 1fr !important;
                        }
                        
                        /* Cartes de projets - Tablette */
                        .rnd-item {
                            padding: 16px !important;
                        }
                        
                        .rnd-item > div:first-child {
                            flex-direction: column !important;
                            gap: 12px;
                        }
                        
                        .rnd-item > div:first-child > div:first-child {
                            width: 100%;
                        }
                        
                        .rnd-item > div:first-child > div:last-child {
                            text-align: left !important;
                        }
                        
                        .rnd-item h3 {
                            font-size: 16px !important;
                            margin-bottom: 8px !important;
                        }
                        
                        .rnd-item .rnd-badge {
                            font-size: 10px !important;
                            padding: 4px 10px !important;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        .rnd-header {
                            padding: 12px 16px;
                        }
                        .rnd-title {
                            font-size: 20px;
                        }
                        .rnd-subtitle {
                            display: none;
                        }
                        .rnd-close-btn {
                            width: 32px;
                            height: 32px;
                        }
                        .rnd-help-btn {
                            width: 32px;
                            height: 32px;
                        }
                        .rnd-tabs {
                            padding: 10px 16px;
                            gap: 4px;
                        }
                        .rnd-tab {
                            padding: 8px 12px;
                            font-size: 12px;
                        }
                        .rnd-content {
                            padding: 16px;
                        }
                        .rnd-section {
                            padding: 12px;
                            margin-bottom: 12px;
                            border-radius: 12px;
                        }
                        .rnd-section-title {
                            font-size: 16px;
                        }
                        .rnd-section-title::before {
                            width: 3px;
                            height: 20px;
                        }
                        .rnd-item {
                            padding: 12px;
                            margin-bottom: 12px;
                        }
                        .rnd-stat-card {
                            padding: 16px;
                        }
                        .rnd-stat-value {
                            font-size: 28px;
                        }
                        .rnd-stat-label {
                            font-size: 11px;
                        }
                        .rnd-btn {
                            padding: 8px 16px;
                            font-size: 12px;
                        }
                        .rnd-badge {
                            padding: 3px 8px;
                            font-size: 10px;
                        }
                        .rnd-dashboard {
                            grid-template-columns: 1fr;
                            gap: 12px;
                            margin-bottom: 20px;
                        }
                        .rnd-chat-container {
                            height: 65vh;
                            min-height: 360px;
                        }
                        .rnd-chat-messages {
                            padding: 12px;
                        }
                        .rnd-chat-input {
                            padding: 12px;
                            gap: 8px;
                            flex-direction: column;
                        }
                        .rnd-input {
                            padding: 10px 12px;
                            font-size: 13px;
                        }
                        

                        /* Responsive pour le panneau Turnover (Turnovol) */
                        @media (max-width: 1200px) {
                            #turnoverStatsGrid {
                                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)) !important;
                            }
                        }

                        @media (max-width: 768px) {
                            #hrContentTurnover .turnover-rgpd-banner {
                                padding: 16px !important;
                                margin-bottom: 16px !important;
                            }
                            #hrContentTurnover .turnover-rgpd-banner-inner {
                                flex-direction: column !important;
                                align-items: flex-start !important;
                            }
                            #hrContentTurnover .turnover-rgpd-badges {
                                gap: 6px !important;
                            }
                            #turnoverStatsGrid {
                                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
                                gap: 12px !important;
                                margin-bottom: 20px !important;
                            }
                            #turnoverActionsBar {
                                flex-direction: column !important;
                                align-items: stretch !important;
                                gap: 12px !important;
                            }
                            #turnoverActionsLeft,
                            #turnoverActionsRight {
                                width: 100% !important;
                            }
                            #turnoverActionsLeft {
                                flex-direction: column !important;
                            }
                            #turnoverActionsBar button,
                            #turnoverActionsBar select,
                            #turnoverActionsBar input {
                                width: 100% !important;
                                justify-content: center !important;
                            }
                            #turnoverEmployeeSearch {
                                min-width: 0 !important;
                                font-size: 13px !important;
                                padding: 10px 12px !important;
                            }
                            #turnoverRiskFilter {
                                font-size: 13px !important;
                                padding: 10px 12px !important;
                            }
                            #turnoverListContainer {
                                gap: 12px !important;
                            }
                            .turnover-card {
                                padding: 16px !important;
                            }
                            .turnover-card-header {
                                flex-direction: column !important;
                                align-items: stretch !important;
                                gap: 12px !important;
                            }
                            .turnover-card-score {
                                display: flex !important;
                                align-items: center !important;
                                justify-content: space-between !important;
                                gap: 12px !important;
                                text-align: left !important;
                            }
                            .turnover-card-score-value {
                                font-size: 28px !important;
                            }
                            .turnover-modal {
                                padding: 10px !important;
                                align-items: flex-start !important;
                                height: 100dvh !important;
                            }
                            .turnover-modal-content {
                                padding: 18px !important;
                                border-radius: 16px !important;
                                width: 100% !important;
                                max-width: 100% !important;
                                max-height: 96dvh !important;
                                overflow-y: auto !important;
                                -webkit-overflow-scrolling: touch;
                            }
                            .turnover-modal-title {
                                font-size: 20px !important;
                            }
                            .turnover-modal-subtitle {
                                font-size: 12px !important;
                            }
                            .turnover-modal-hero {
                                padding: 16px !important;
                            }
                            .turnover-modal-hero-inner {
                                flex-direction: column !important;
                                align-items: flex-start !important;
                                gap: 12px !important;
                            }
                            .turnover-modal-score {
                                width: 100% !important;
                                display: flex !important;
                                justify-content: space-between !important;
                                align-items: baseline !important;
                                text-align: left !important;
                            }
                            .turnover-modal-score-value {
                                font-size: 36px !important;
                            }
                            .turnover-modal-section {
                                padding: 16px !important;
                            }
                            .turnover-modal-meta {
                                justify-content: flex-start !important;
                            }
                            .turnover-rgpd-modal-content {
                                padding: 20px !important;
                                border-radius: 16px !important;
                                max-height: 92vh !important;
                            }
                            .turnover-rgpd-modal-title {
                                font-size: 20px !important;
                            }
                        }

                        /* Turnovol: chips sur une ligne (√©vite Confiance sur 3 lignes) */
                        .turnover-modal-chip {
                            max-width: 100% !important;
                            min-width: 0 !important;
                            white-space: nowrap !important;
                            overflow: hidden !important;
                            text-overflow: ellipsis !important;
                            overflow-wrap: normal !important;
                            word-break: normal !important;
                        }

                        /* Portrait mobile: √©viter le chevauchement des chips */
                        @media (max-width: 768px) and (orientation: portrait) {
                            .turnover-modal-meta {
                                flex-direction: column !important;
                                align-items: stretch !important;
                                justify-content: flex-start !important;
                                gap: 8px !important;
                            }
                            .turnover-modal-chip {
                                width: 100% !important;
                                text-align: center !important;
                                padding: 8px 12px !important;
                                font-size: 12px !important;
                                white-space: normal !important;
                                overflow: visible !important;
                                text-overflow: ellipsis !important;
                                overflow-wrap: normal !important;
                                word-break: normal !important;
                                line-height: 1.4 !important;
                                text-transform: none !important;
                            }

                            /* Confiance et Fen√™tre: m√™me taille sur petit √©cran */
                            .turnover-modal-chip-confidence, .turnover-modal-chip-window {
                                padding: 8px 12px !important;
                                font-size: 12px !important; min-width: 150px !important; max-width: 200px !important; box-sizing: border-box !important;
                            }
                        }

                        /* Turnovol (Turnover) - Modal plein √©cran */
                        .turnover-modal.turnover-modal-fullscreen {
                            padding: 0 !important;
                            align-items: stretch !important;
                            justify-content: stretch !important;
                            overflow: hidden !important;
                        }
                        .turnover-modal.turnover-modal-fullscreen .turnover-modal-content,
                        .turnover-modal.turnover-modal-fullscreen .turnover-rgpd-modal-content {
                            width: 100vw !important;
                            max-width: 100vw !important;
                            height: 100vh !important;
                            height: 100dvh !important;
                            max-height: 100vh !important;
                            max-height: 100dvh !important;
                            border-radius: 0 !important;
                            overflow-y: auto !important;
                            -webkit-overflow-scrolling: touch;
                        }

                        @media (max-width: 480px) {
                            #turnoverStatsGrid {
                                grid-template-columns: 1fr !important;
                                gap: 10px !important;
                            }
                            #turnoverEmptyState {
                                padding: 36px 14px !important;
                            }
                            .turnover-card {
                                padding: 14px !important;
                            }
                            #turnoverEmployeeSearch {
                                font-size: 12px !important;
                            }
                            .turnover-modal-content {
                                padding: 16px !important;
                                border-radius: 14px !important;
                                max-height: 98dvh !important;
                            }
                            .turnover-modal-title {
                                font-size: 18px !important;
                            }
                            .turnover-modal-score-value {
                                font-size: 32px !important;
                            }
                            .turnover-rgpd-modal-content {
                                padding: 16px !important;
                            }
                        }

                        /* Paysage / faible hauteur: gagner de la place verticale */
                        @media (max-height: 520px) and (orientation: landscape) {
                            #hrContentTurnover .turnover-rgpd-banner {
                                padding: 14px !important;
                                margin-bottom: 14px !important;
                            }
                            #hrContentTurnover .turnover-rgpd-badges {
                                display: none !important;
                            }
                            #turnoverStatsGrid {
                                margin-bottom: 14px !important;
                                gap: 10px !important;
                            }
                            #turnoverActionsBar {
                                margin-bottom: 14px !important;
                                gap: 10px !important;
                            }
                            .turnover-modal {
                                padding: 8px !important;
                                align-items: flex-start !important;
                                height: 100dvh !important;
                            }
                            .turnover-modal-content,
                            .turnover-rgpd-modal-content {
                                max-height: 98dvh !important;
                                padding: 14px !important;
                                border-radius: 14px !important;
                            }
                            .turnover-modal-title {
                                font-size: 18px !important;
                            }
                            .turnover-modal-subtitle {
                                display: none !important;
                            }
                            .turnover-modal-hero {
                                padding: 12px !important;
                                margin-bottom: 16px !important;
                            }
                            .turnover-modal-meta {
                                flex-direction: column !important;
                                align-items: stretch !important;
                                justify-content: flex-start !important;
                                gap: 8px !important;
                            }
                            .turnover-modal-chip {
                                width: 100% !important;
                                text-align: center !important;
                                padding: 8px 12px !important;
                                font-size: 12px !important;
                                white-space: normal !important;
                                overflow: visible !important;
                                text-overflow: ellipsis !important;
                                overflow-wrap: normal !important;
                                word-break: normal !important;
                                line-height: 1.4 !important;
                            }
                            .turnover-modal-section {
                                padding: 14px !important;
                            }
                        }
                        /* Agent Dev - Header responsive mobile */
                        #rndAgent > div:first-child > div:first-child {
                            flex-direction: column !important;
                            gap: 12px;
                        }
                        
                        #rndAgent h2 {
                            font-size: 18px !important;
                        }
                        
                        #rndAgent > div:first-child > div:first-child p {
                            font-size: 12px !important;
                        }
                        
                        #rndAgent > div:first-child > div:first-child button {
                            width: 100%;
                            justify-content: center;
                            padding: 8px 12px !important;
                            font-size: 12px !important;
                        }
                        
                        #rndAgent > div:first-child label {
                            font-size: 11px !important;
                        }
                        
                        .rnd-btn {
                            width: 100%;
                        }
                        
                        /* Modal Informations Projet - Mobile */
                        #projectDetailsModal {
                            padding: 10px !important;
                            align-items: flex-start !important;
                        }
                        
                        #projectDetailsModal > div {
                            width: 100% !important;
                            max-height: 98vh !important;
                            border-radius: 12px !important;
                        }
                        
                        #projectDetailsModal h2 {
                            font-size: 18px !important;
                        }
                        
                        #projectDetailsModal > div > div:first-child {
                            padding: 16px !important;
                            flex-direction: column !important;
                            gap: 12px;
                            border-radius: 12px 12px 0 0 !important;
                        }
                        
                        #projectDetailsModal > div > div:first-child > div:first-child > div {
                            flex-direction: row !important;
                            flex-wrap: wrap;
                            gap: 6px;
                            align-items: flex-start !important;
                        }
                        
                        #projectDetailsModal > div > div:first-child > div:first-child > div > span {
                            font-size: 10px !important;
                            padding: 4px 8px !important;
                            white-space: nowrap;
                        }
                        
                        #projectDetailsModal > div > div:first-child > div:first-child > div > span svg {
                            width: 14px !important;
                            height: 14px !important;
                        }
                        
                        #projectDetailsModal > div > div:first-child button {
                            width: 100%;
                            height: 36px !important;
                            font-size: 24px !important;
                        }
                        
                        #projectDetailsModal > div > div:last-child {
                            padding: 16px !important;
                        }
                        
                        #projectDetailsModal h3 {
                            font-size: 16px !important;
                        }
                        
                        #projectDetailsModal h4 {
                            font-size: 12px !important;
                        }
                        
                        /* Timeline phases en grille 2 colonnes sur mobile */
                        #projectDetailsModal > div > div:last-child > div:first-child > div:nth-child(2) {
                            display: grid !important;
                            grid-template-columns: repeat(2, 1fr) !important;
                            gap: 12px 8px !important;
                            flex-direction: unset !important;
                            margin-bottom: 16px !important;
                        }
                        
                        #projectDetailsModal > div > div:last-child > div:first-child > div:nth-child(2) > div {
                            display: flex !important;
                            flex-direction: column !important;
                            align-items: center !important;
                            gap: 6px !important;
                            text-align: center !important;
                            flex: unset !important;
                        }
                        
                        #projectDetailsModal > div > div:last-child > div:first-child > div:nth-child(2) > div > div:first-child {
                            width: 44px !important;
                            height: 44px !important;
                            margin: 0 !important;
                            flex-shrink: 0;
                        }
                        
                        #projectDetailsModal > div > div:last-child > div:first-child > div:nth-child(2) > div > div:last-child {
                            margin: 0 !important;
                            font-size: 11px !important;
                        }
                        
                        /* Masquer les lignes de connexion sur mobile */
                        #projectDetailsModal > div > div:last-child > div:first-child > div:nth-child(2) > div:nth-child(even) {
                            display: none !important;
                        }
                        
                        /* M√©triques en 1 colonne sur mobile */
                        #projectDetailsModal > div > div:last-child > div:nth-child(2) {
                            grid-template-columns: 1fr !important;
                            gap: 12px !important;
                        }
                        
                        #projectDetailsModal > div > div:last-child > div:nth-child(2) > div {
                            padding: 16px !important;
                        }
                        
                        #projectDetailsModal > div > div:last-child > div:nth-child(2) > div > div:first-child {
                            margin-bottom: 8px !important;
                        }
                        
                        #projectDetailsModal > div > div:last-child > div:nth-child(2) > div > div:nth-child(2) {
                            font-size: 20px !important;
                        }
                        
                        #projectDetailsModal > div > div:last-child > div:nth-child(2) > div > div:nth-child(3) {
                            font-size: 12px !important;
                        }
                        
                        /* Description et Probl√®me en colonne */
                        #projectDetailsModal > div > div:last-child > div:nth-child(3) {
                            grid-template-columns: 1fr !important;
                            gap: 12px !important;
                        }
                        
                        #projectDetailsModal > div > div:last-child > div:nth-child(3) > div {
                            padding: 16px !important;
                        }
                        
                        #projectDetailsModal > div > div:last-child > div:nth-child(3) p {
                            font-size: 13px !important;
                        }
                        
                        /* Public Cible */
                        #projectDetailsModal > div > div:last-child > div:nth-child(4) {
                            padding: 16px !important;
                        }
                        
                        #projectDetailsModal > div > div:last-child > div:nth-child(4) p {
                            font-size: 13px !important;
                        }
                        
                        /* Boutons d'action en colonne */
                        #projectDetailsModal > div > div:last-child > div:last-child {
                            flex-direction: column !important;
                            gap: 8px !important;
                        }
                        
                        #projectDetailsModal > div > div:last-child > div:last-child button {
                            width: 100% !important;
                            justify-content: center;
                            padding: 10px 16px !important;
                            font-size: 13px !important;
                        }
                        
                        /* Cartes de projets - Mobile */
                        .rnd-item {
                            padding: 14px !important;
                            margin-bottom: 12px !important;
                        }
                        
                        .rnd-item > div:first-child {
                            flex-direction: column !important;
                            gap: 10px;
                            margin-bottom: 10px !important;
                        }
                        
                        .rnd-item > div:first-child > div:first-child {
                            width: 100%;
                            display: flex;
                            flex-direction: column;
                            gap: 8px;
                        }
                        
                        .rnd-item > div:first-child > div:first-child h3 {
                            margin-bottom: 0 !important;
                        }
                        
                        /* Container des badges en ligne horizontale */
                        .rnd-item > div:first-child > div:first-child > span {
                            display: inline-block !important;
                        }
                        
                        .rnd-item > div:first-child > div:last-child {
                            text-align: left !important;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            background: rgba(16, 185, 129, 0.1);
                            padding: 8px 12px;
                            border-radius: 8px;
                            border: 1px solid rgba(16, 185, 129, 0.3);
                            flex-shrink: 0;
                        }
                        
                        .rnd-item > div:first-child > div:last-child > div:first-child {
                            font-size: 11px !important;
                            margin: 0 !important;
                        }
                        
                        .rnd-item > div:first-child > div:last-child > div:last-child {
                            font-size: 14px !important;
                        }
                        
                        .rnd-item h3 {
                            font-size: 15px !important;
                            margin-bottom: 8px !important;
                            line-height: 1.3;
                        }
                        
                        .rnd-item .rnd-badge {
                            font-size: 9px !important;
                            padding: 3px 8px !important;
                            letter-spacing: 0.3px;
                        }
                        
                        .rnd-item > div:nth-child(2) {
                            margin-bottom: 8px !important;
                        }
                        
                        .rnd-item > div:nth-child(2) > div:first-child {
                            margin-bottom: 6px !important;
                        }
                        
                        .rnd-item > div:nth-child(2) > div:first-child span {
                            font-size: 11px !important;
                        }
                        
                        .rnd-item > div:nth-child(2) > div:last-child {
                            height: 8px !important;
                            border-radius: 4px !important;
                        }
                        
                        .rnd-item > div:last-child {
                            font-size: 11px !important;
                        }
                    }
                </style>
                
                <div class="rnd-container">
                    <div class="rnd-header">
                        <div>
                            <h1 class="rnd-title">${t.title}</h1>
                            <p class="rnd-subtitle">${t.subtitle}</p>
                        </div>
                        <div class="rnd-header-actions">
                            <button class="rnd-help-btn" onclick="showRnDHelp()" title="Guide">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                            </button>
                            <button class="rnd-close-btn" onclick="closeRnD()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="rnd-tabs">
                        <button class="rnd-tab active" onclick="showRnDTab('dashboard')">${t.tabDashboard}</button>
                        <button class="rnd-tab" onclick="showRnDTab('projets')">${t.tabProjects}</button>
                        <button class="rnd-tab" onclick="showRnDTab('jalons')">${t.tabMilestones}</button>
                        <button class="rnd-tab" onclick="showRnDTab('docs')">${t.tabDocs}</button>
                        <button class="rnd-tab" onclick="openCompanySettings()">${t.tabCompany}</button>
                        <button class="rnd-tab" onclick="showRnDTab('agent')">${t.tabAgent}</button>
                    </div>
                    
                    <div class="rnd-content">
                        <!-- Dashboard -->
                        <div id="rndDashboard" class="rnd-tab-content">
                            <div class="rnd-dashboard">
                                <div class="rnd-stat-card">
                                    <div class="rnd-stat-value" id="rndProjectsCount">0</div>
                                    <div class="rnd-stat-label">${t.statsProjects}</div>
                                </div>
                                <div class="rnd-stat-card">
                                    <div class="rnd-stat-value" id="rndMilestonesCount">0</div>
                                    <div class="rnd-stat-label">${t.statsMilestones}</div>
                                </div>
                                <div class="rnd-stat-card">
                                    <div class="rnd-stat-value" id="rndDocsCount">0</div>
                                    <div class="rnd-stat-label">${t.statsDocs}</div>
                                </div>
                                <div class="rnd-stat-card">
                                    <div class="rnd-stat-value" id="rndRisksCount">0</div>
                                    <div class="rnd-stat-label">${t.statsRisks}</div>
                                </div>
                            </div>

                            <div id="rndActionsPanel" style="display:none; background: rgba(0,0,0,0.22); border: 1px solid rgba(99, 102, 241, 0.25); border-radius: 16px; padding: 16px 18px; margin: 0 0 24px;">
                                <div style="display:flex; align-items:center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                                    <div>
                                        <div style="color: rgba(255,255,255,0.92); font-weight: 700;">${t.actionsReady}</div>
                                        <div style="margin-top: 4px; color: rgba(255,255,255,0.65); font-size: 12px;">
                                            <span id="rndActionsCount">0</span> ${t.actionsPending}
                                        </div>
                                    </div>
                                    <button id="rndApplyActionsBtn" class="rnd-btn" type="button" onclick="applyRnDLatestActionBatch()">${t.applyActions}</button>
                                </div>
                            </div>
                            
                            <div class="rnd-section">
                                <div class="rnd-section-title">${t.priorityProjects}</div>
                                <div id="rndPriorityContainer"></div>
                            </div>
                        </div>
                        
                        <!-- Jalons & KPIs -->
                        <div id="rndJalons" class="rnd-tab-content" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                <h2 style="margin: 0; font-size: 24px; color: white;">${t.titleMilestones}</h2>
                                <button class="rnd-btn" onclick="showAddMilestoneModal()">${t.btnAddMilestone}</button>
                            </div>
                            <div id="rndMilestonesList"></div>
                        </div>
                        
                        <!-- Documentation & Risques -->
                        <div id="rndDocs" class="rnd-tab-content" style="display: none;">
                            <div style="margin-bottom: 32px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                    <h2 style="margin: 0; font-size: 24px; color: white;">${t.titleDocs}</h2>
                                    <button class="rnd-btn" onclick="showAddDocumentModal()">${t.btnAddDoc}</button>
                                </div>
                                <div id="rndDocsList"></div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                    <h2 style="margin: 0; font-size: 24px; color: white;">${t.titleRisks}</h2>
                                    <button class="rnd-btn" onclick="showAddRiskModal()">${t.btnAddRisk}</button>
                                </div>
                                <div id="rndRisksList"></div>
                            </div>
                        </div>
                        
                        <!-- Projets R&D -->
                        <div id="rndProjets" class="rnd-tab-content" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                <h2 style="margin: 0; font-size: 24px; color: white;">${t.titleProjects}</h2>
                                <button class="rnd-btn" onclick="showAddProjectModal()">${t.btnAddProject}</button>
                            </div>
                            <div id="rndProjectsList"></div>
                        </div>
                        
                        <!-- Agent dev -->
                        <div id="rndAgent" class="rnd-tab-content" style="display: none;">
                            <div style="margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div style="flex: 1;">
                                        <h2 style="margin: 0 0 8px; font-size: 24px; color: white;">${t.titleAgent}</h2>
                                        <p style="margin: 0 0 12px; color: rgba(255, 255, 255, 0.6); font-size: 14px;">${t.agentSub}</p>
                                    </div>
                                    <button onclick="clearRnDChatHistory()" title="${t.clearChatTitle}" style="padding: 10px 16px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 8px; color: #fca5a5; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                        ${t.btnClearChat}
                                    </button>
                                </div>
                            </div>
                            
                            <div class="rnd-chat-container">
                                <div class="rnd-chat-messages" id="rndChatMessages"></div>
                                <div class="rnd-chat-input">
                                    <input type="text" class="rnd-input" id="rndChatInput" placeholder="${t.chatPlaceholder}" onkeypress="if(event.key==='Enter') sendRnDMessage()">
                                    <button class="rnd-btn" onclick="sendRnDMessage()">${t.sendBtn}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Initialize R&D data
            initializeRnDData();
            
            // Charger l'historique du chat Agent dev si l'onglet est activ√©
            loadRnDChatHistory();
        }
        
        function closeRnD() {
            const overlay = document.getElementById('rndOverlay');
            if (overlay) {
                overlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => overlay.remove(), 300);
            }
        }
        
        function showRnDTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.rnd-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('.rnd-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const tabMap = {
                'dashboard': 'rndDashboard',
                'projets': 'rndProjets',
                'jalons': 'rndJalons',
                'docs': 'rndDocs',
                'agent': 'rndAgent'
            };
            
            const tabId = tabMap[tabName];
            if (tabId) {
                document.getElementById(tabId).style.display = 'block';
            }
            
            // Set active tab button
            event.target.classList.add('active');
            
            // Render content if needed
            if (tabName === 'jalons') renderMilestonesList();
            if (tabName === 'docs') {
                renderDocsList();
                renderRisksList();
            }
            if (tabName === 'agent') loadRnDChatHistory();
        }
        
        function initializeRnDData() {
            const projects = JSON.parse(localStorage.getItem('rndProjects') || '[]');
            const milestones = JSON.parse(localStorage.getItem('rndMilestones') || '[]');
            const documents = JSON.parse(localStorage.getItem('rndDocuments') || '[]');
            const risks = JSON.parse(localStorage.getItem('rndRisks') || '[]');
            
            // Update stats
            document.getElementById('rndProjectsCount').textContent = projects.filter(p => p.statut === 'actif').length;
            document.getElementById('rndMilestonesCount').textContent = milestones.filter(m => new Date(m.date) >= new Date()).length;
            document.getElementById('rndDocsCount').textContent = documents.length;
            document.getElementById('rndRisksCount').textContent = risks.filter(r => r.statut === 'actif').length;
            
            // Render lists
            renderProjectsList();
            renderDashboardMetrics();
            renderDashboardPriority();
        }
        
        function renderMilestonesList() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                emptyTitle: lang === 'en' ? 'No milestones defined' : 'Aucun jalon d√©fini',
                emptyDesc: lang === 'en' ? 'Add milestones to track your project progress' : "Ajoutez des jalons pour suivre l'avancement de vos projets",
                project: lang === 'en' ? 'Project:' : 'Projet:',
                complete: lang === 'en' ? 'Complete (mark as done)' : 'Effectuer (marquer comme compl√©t√©)',
                delete: lang === 'en' ? 'Delete milestone' : 'Supprimer le jalon',
                statusCompleted: lang === 'en' ? '‚úì Completed' : '‚úì Compl√©t√©',
                statusDelayed: lang === 'en' ? '‚ö† Delayed' : '‚ö† Retard',
                statusUpcoming: lang === 'en' ? '‚è≥ Upcoming' : '‚è≥ √Ä venir',
                kpis: lang === 'en' ? 'Associated KPIs:' : 'KPIs Associ√©s:'
            };

            const milestones = JSON.parse(localStorage.getItem('rndMilestones') || '[]');
            const container = document.getElementById('rndMilestonesList');
            
            if (!container) return;
            
            if (milestones.length === 0) {
                container.innerHTML = `
                    <div class="rnd-empty">
                        <div class="rnd-empty-title">${t.emptyTitle}</div>
                        <p>${t.emptyDesc}</p>
                    </div>
                `;
                return;
            }
            
            // Trier par date
            const sortedMilestones = [...milestones].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            container.innerHTML = sortedMilestones.map(milestone => {
                const isPast = new Date(milestone.date) < new Date();
                const project = JSON.parse(localStorage.getItem('rndProjects') || '[]').find(p => p.id === milestone.projectId);
                
                return `
                <div class="rnd-item" style="opacity: ${milestone.statut === 'compl√©t√©' ? '0.7' : '1'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 4px; font-size: 18px; color: white;">${milestone.titre}</h3>
                            <p style="margin: 0 0 8px; color: rgba(255, 255, 255, 0.7); font-size: 14px;">${milestone.description}</p>
                            ${project ? `<div style="font-size: 12px; color: rgba(99, 102, 241, 0.9);">${t.project} ${project.titre}</div>` : ''}
                        </div>
                        <div style="text-align: right;">

                            <div style="display: flex; gap: 6px; justify-content: flex-end; margin-bottom: 8px;">
                                ${milestone.statut !== 'compl√©t√©' ? `
                                    <button class="rnd-icon-btn" onclick="completeMilestone(${milestone.id})" title="${t.complete}">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M20 6L9 17l-5-5" />
                                        </svg>
                                    </button>
                                ` : ''}
                                <button class="rnd-icon-btn delete" onclick="deleteMilestone(${milestone.id})" title="${t.delete}">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6" />
                                        <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                                        <path d="M10 11v6" />
                                        <path d="M14 11v6" />
                                        <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
                                    </svg>
                                </button>
                            </div>
                            <span class="rnd-badge rnd-badge-${milestone.statut === 'compl√©t√©' ? 'high' : isPast ? 'error' : 'medium'}">
                                ${milestone.statut === 'compl√©t√©' ? t.statusCompleted : isPast ? t.statusDelayed : t.statusUpcoming}
                            </span>
                            <div style="margin-top: 8px; font-size: 14px; color: rgba(255, 255, 255, 0.9); font-weight: 600;">
                                ${new Date(milestone.date).toLocaleDateString(typeof getLocale === 'function' ? getLocale() : 'en-US', { day: 'numeric', month: 'long', year: 'numeric' })}
                            </div>
                        </div>
                    </div>
                    ${milestone.kpis && milestone.kpis.length > 0 ? `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 8px;">${t.kpis}</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${milestone.kpis.map(kpi => `
                                    <div style="background: rgba(99, 102, 241, 0.1); padding: 6px 12px; border-radius: 6px; font-size: 12px;">
                                        <span style="color: rgba(255, 255, 255, 0.7);">${kpi.nom}:</span>
                                        <span style="color: white; font-weight: 600; margin-left: 4px;">${kpi.valeur} ${kpi.unite}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }
        
        function renderDocsList() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                 emptyTitle: lang === 'en' ? 'No documents' : 'Aucun document',
                 emptyDesc: lang === 'en' ? 'Add important documents for your projects' : 'Ajoutez des documents importants pour vos projets',
                 projLabel: lang === 'en' ? 'Project:' : 'Projet:',
                 addedOn: lang === 'en' ? 'Added on' : 'Ajout√© le',
                 viewDoc: lang === 'en' ? 'üîó View document' : 'üîó Voir le document'
            };

            const documents = JSON.parse(localStorage.getItem('rndDocuments') || '[]');
            const container = document.getElementById('rndDocsList');
            
            if (!container) return;
            
            if (documents.length === 0) {
                container.innerHTML = `
                    <div class="rnd-empty">
                        <div class="rnd-empty-title">${t.emptyTitle}</div>
                        <p>${t.emptyDesc}</p>
                    </div>
                `;
                return;
            }
            
            const docIcons = {
                'specs': 'üìã',
                'architecture': 'üèóÔ∏è',
                'rapport': 'üìä',
                'presentation': 'üìΩÔ∏è',
                'contrat': 'üìÑ',
                'autre': 'üìé'
            };
            
            container.innerHTML = documents.map(doc => {
                const project = JSON.parse(localStorage.getItem('rndProjects') || '[]').find(p => p.id === doc.projectId);
                
                return `
                <div class="rnd-item">
                    <div style="display: flex; gap: 16px; align-items: start;">
                        <div style="font-size: 32px;">${docIcons[doc.type] || 'üìé'}</div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div>
                                    <h3 style="margin: 0 0 4px; font-size: 18px; color: white;">${doc.titre}</h3>
                                    ${project ? `<div style="font-size: 12px; color: rgba(99, 102, 241, 0.9);">${t.projLabel} ${project.titre}</div>` : ''}
                                </div>
                                <span class="rnd-badge rnd-badge-low">${doc.type}</span>
                            </div>
                            <p style="margin: 0 0 8px; color: rgba(255, 255, 255, 0.7); font-size: 14px;">${doc.description}</p>
                            <div style="display: flex; gap: 16px; align-items: center; font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                                <span>${t.addedOn} ${new Date(doc.created).toLocaleDateString(getLocale())}</span>
                                ${doc.url ? `<a href="${doc.url}" target="_blank" style="color: rgba(99, 102, 241, 0.9); text-decoration: none;">${t.viewDoc}</a>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function renderRisksList() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                emptyTitle: lang === 'en' ? 'No risks identified' : 'Aucun risque identifi√©',
                emptyDesc: lang === 'en' ? 'Identify and track your project risks' : 'Identifiez et suivez les risques de vos projets',
                mitigation: lang === 'en' ? 'Mitigation Plan:' : 'Plan d\'att√©nuation:',
                projLabel: lang === 'en' ? 'Project:' : 'Projet:',
                resolved: lang === 'en' ? '‚úì Resolved' : '‚úì R√©solu',
                ongoing: lang === 'en' ? 'üîÑ Ongoing' : 'üîÑ En cours',
                active: lang === 'en' ? '‚ö† Active' : '‚ö† Actif',
                impactLabel: lang === 'en' ? 'Impact:' : 'Impact:',
                delete: lang === 'en' ? 'Delete risk' : 'Supprimer le risque'
            };

            const critDisplay = {
                'critique': lang === 'en' ? 'Critical' : 'Critique',
                '√©lev√©e': lang === 'en' ? 'High' : '√âlev√©e',
                'moyenne': lang === 'en' ? 'Medium' : 'Moyenne',
                'faible': lang === 'en' ? 'Low' : 'Faible'
            };

            const risks = JSON.parse(localStorage.getItem('rndRisks') || '[]');
            const container = document.getElementById('rndRisksList');
            
            if (!container) return;
            
            if (risks.length === 0) {
                container.innerHTML = `
                    <div class="rnd-empty">
                        <div class="rnd-empty-title">${t.emptyTitle}</div>
                        <p>${t.emptyDesc}</p>
                    </div>
                `;
                return;
            }
            
            // Trier par criticit√©
            const sortedRisks = [...risks].sort((a, b) => {
                const critOrder = { 'critique': 3, '√©lev√©e': 2, 'moyenne': 1, 'faible': 0 };
                // Keep keys 'critique' etc for data compatibility, assume storage is internal/fixed for now or handle later
                return (critOrder[b.criticite] || 0) - (critOrder[a.criticite] || 0);
            });
            
            container.innerHTML = sortedRisks.map(risk => {
                const project = JSON.parse(localStorage.getItem('rndProjects') || '[]').find(p => p.id === risk.projectId);
                const critColors = {
                    'critique': 'error',
                    '√©lev√©e': 'medium',
                    'moyenne': 'low',
                    'faible': 'low'
                };
                
                return `
                <div class="rnd-item" style="border-left: 4px solid ${risk.criticite === 'critique' ? '#ef4444' : risk.criticite === '√©lev√©e' ? '#f59e0b' : '#10b981'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                                <h3 style="margin: 0; font-size: 18px; color: white;">${risk.titre}</h3>
                                <span class="rnd-badge rnd-badge-${critColors[risk.criticite]}">${critDisplay[risk.criticite] || risk.criticite}</span>
                            </div>
                            ${project ? `<div style="font-size: 12px; color: rgba(99, 102, 241, 0.9); margin-bottom: 8px;">${t.projLabel} ${project.titre}</div>` : ''}
                            <p style="margin: 0 0 8px; color: rgba(255, 255, 255, 0.7); font-size: 14px;">${risk.description}</p>
                            ${risk.mitigation ? `
                                <div style="background: rgba(16, 185, 129, 0.1); padding: 8px 12px; border-radius: 6px; margin-top: 8px;">
                                    <div style="font-size: 12px; color: rgba(16, 185, 129, 0.9); font-weight: 600; margin-bottom: 4px;">${t.mitigation}</div>
                                    <div style="font-size: 13px; color: rgba(255, 255, 255, 0.8);">${risk.mitigation}</div>
                                </div>
                            ` : ''}
                        </div>
                        <div style="text-align: right; min-width: 100px;">

                            <div style="display: flex; justify-content: flex-end; margin-bottom: 8px;">
                                <button class="rnd-icon-btn delete" onclick="deleteRisk(${risk.id})" title="${t.delete}">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6" />
                                        <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                                        <path d="M10 11v6" />
                                        <path d="M14 11v6" />
                                        <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
                                    </svg>
                                </button>
                            </div>
                            <span class="rnd-badge rnd-badge-${risk.statut === 'r√©solu' ? 'high' : risk.statut === 'en-cours' ? 'medium' : 'low'}">
                                ${risk.statut === 'r√©solu' ? t.resolved : risk.statut === 'en-cours' ? t.ongoing : t.active}
                            </span>
                            <div style="margin-top: 8px; font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                                ${t.impactLabel} ${risk.impact}%
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function renderProjectsList() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                emptyTitle: lang === 'en' ? 'No R&D projects' : 'Aucun projet R&D',
                emptyDesc: lang === 'en' ? 'Start your first research project' : 'Lancez votre premier projet de recherche',
                budget: lang === 'en' ? 'Budget' : 'Budget',
                progress: lang === 'en' ? 'Progress' : 'Progression',
                createdOn: lang === 'en' ? 'Created on' : 'Cr√©√© le'
            };
            
            const phasesDisplay = {
                'd√©couverte': lang === 'en' ? 'Discovery' : 'D√©couverte',
                'id√©ation': lang === 'en' ? 'Ideation' : 'Id√©ation',
                'exp√©rimentation': lang === 'en' ? 'Experimentation' : 'Exp√©rimentation',
                'validation': lang === 'en' ? 'Validation' : 'Validation',
                'd√©ploiement': lang === 'en' ? 'Deployment' : 'D√©ploiement',
                'op√©rationnel': lang === 'en' ? 'Operational' : 'Op√©rationnel'
            };

            const domainsDisplay = {
                'technologie': lang === 'en' ? 'Technology' : 'Technologie',
                'sant√©': lang === 'en' ? 'Health' : 'Sant√©',
                '√©ducation': lang === 'en' ? 'Education' : '√âducation',
                'agriculture': lang === 'en' ? 'Agriculture' : 'Agriculture',
                'environnement': lang === 'en' ? 'Environment' : 'Environnement',
                'business': lang === 'en' ? 'Business' : 'Business',
                'arts': lang === 'en' ? 'Arts' : 'Arts',
                'sciences': lang === 'en' ? 'Science' : 'Sciences',
                '√©nergie': lang === 'en' ? 'Energy' : '√ânergie',
                'social': lang === 'en' ? 'Social' : 'Social',
                'autre': lang === 'en' ? 'Other' : 'Autre'
            };

            const projects = JSON.parse(localStorage.getItem('rndProjects') || '[]');
            const container = document.getElementById('rndProjectsList');
            
            if (!container) return; // Sortir si le conteneur n'existe pas
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="rnd-empty">
                        <div class="rnd-empty-title">${t.emptyTitle}</div>
                        <p>${t.emptyDesc}</p>
                    </div>
                `;
                return;
            }
            
            const phaseColors = {
                'd√©couverte': 'low',
                'id√©ation': 'medium',
                'exp√©rimentation': 'medium',
                'validation': 'high',
                'd√©ploiement': 'high'
            };
            
            container.innerHTML = projects.filter(p => p.statut !== 'archiv√©').map(project => `
                <div class="rnd-item" style="cursor: pointer;" onclick="viewProjectDetails(${project.id})">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <h3 style="margin: 0 0 4px; font-size: 18px; color: white;">${project.titre}</h3>
                            <div class="rnd-project-badges">
                                <span class="rnd-badge rnd-badge-${phaseColors[project.phase] || 'low'}">${phasesDisplay[project.phase] || project.phase}</span>
                                <span class="rnd-badge rnd-badge-medium">${domainsDisplay[project.domaine] || project.domaine}</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">${t.budget}</div>
                            <div style="font-size: 16px; color: #6ee7b7; font-weight: 600;">${project.budget.prevu.toLocaleString(getLocale())} ${project.budget.devise}</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 12px; color: rgba(255, 255, 255, 0.7);">${t.progress}</span>
                            <span style="font-size: 12px; color: #6ee7b7; font-weight: 600;">${project.avancement}%</span>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #6366f1, #8b5cf6); height: 100%; width: ${project.avancement}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                        ${t.createdOn} ${new Date(project.created).toLocaleDateString(getLocale(), { day: 'numeric', month: 'long', year: 'numeric' })}
                    </div>
                </div>
            `).join('');
        }
        
        function renderDashboardMetrics() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                empty: lang === 'en' ? 'No active projects to display metrics' : 'Aucun projet actif pour afficher les m√©triques',
                globalView: lang === 'en' ? 'Global View - All Projects' : 'Vue Globale - Tous les Projets',
                phaseDist: lang === 'en' ? 'Phase Distribution' : 'Distribution des Phases',
                avgProgress: lang === 'en' ? 'Average Progress' : 'Progression Moyenne',
                projects: lang === 'en' ? 'projects' : 'projets',
                totalBudget: lang === 'en' ? 'Total Budget' : 'Budget Total',
                upcomingMilestones: lang === 'en' ? 'Upcoming Milestones' : 'Jalons √† Venir',
                activeRisks: lang === 'en' ? 'Active Risks' : 'Risques Actifs'
            };

            const projects = JSON.parse(localStorage.getItem('rndProjects') || '[]');
            const milestones = JSON.parse(localStorage.getItem('rndMilestones') || '[]');
            const risks = JSON.parse(localStorage.getItem('rndRisks') || '[]');
            const container = document.getElementById('rndMetricsContainer');
            
            if (!container) return;
            
            const activeProjects = projects.filter(p => p.statut === 'actif');
            
            if (activeProjects.length === 0) {
                container.innerHTML = `<div class="rnd-empty"><p>${t.empty}</p></div>`;
                return;
            }
            
            // Calculs pour le graphique global
            const phaseDistribution = {
                'd√©couverte': activeProjects.filter(p => p.phase === 'd√©couverte').length,
                'id√©ation': activeProjects.filter(p => p.phase === 'id√©ation').length,
                'exp√©rimentation': activeProjects.filter(p => p.phase === 'exp√©rimentation').length,
                'validation': activeProjects.filter(p => p.phase === 'validation').length,
                'd√©ploiement': activeProjects.filter(p => p.phase === 'd√©ploiement').length
            };
            
            const avgProgress = Math.round(activeProjects.reduce((sum, p) => sum + p.avancement, 0) / activeProjects.length);
            const totalBudget = activeProjects.reduce((sum, p) => sum + (p.budget?.prevu || 0), 0);
            const totalRisks = risks.filter(r => r.statut === 'actif').length;
            
            container.innerHTML = `
                <!-- Graphique Global -->
                <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05)); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 16px; padding: 24px; margin-bottom: 24px;">
                    <h3 style="margin: 0 0 20px; color: white; font-size: 20px; font-weight: 700;">${t.globalView}</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                        
                        <!-- Distribution des Phases -->
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.8); font-size: 13px; font-weight: 600; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;">${t.phaseDist}</div>
                            <svg width="100%" height="200" viewBox="0 0 300 200">
                                <defs>
                                    <linearGradient id="grad1" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                    </linearGradient>
                                    <linearGradient id="grad2" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#6ee7b7;stop-opacity:1" />
                                    </linearGradient>
                                    <linearGradient id="grad3" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#fbbf24;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#f59e0b;stop-opacity:1" />
                                    </linearGradient>
                                    <linearGradient id="grad4" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#ec4899;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#f472b6;stop-opacity:1" />
                                    </linearGradient>
                                    <linearGradient id="grad5" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#a78bfa;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                ${Object.entries(phaseDistribution).map(([phase, count], index) => {
                                    const maxCount = Math.max(...Object.values(phaseDistribution), 1);
                                    const height = (count / maxCount) * 140;
                                    const x = 30 + (index * 50);
                                    const gradId = `grad${index + 1}`;
                                    return `
                                        <g>
                                            <rect x="${x}" y="${160 - height}" width="35" height="${height}" fill="url(#${gradId})" rx="4" opacity="0.9">
                                                <animate attributeName="height" from="0" to="${height}" dur="0.8s" fill="freeze" />
                                                <animate attributeName="y" from="160" to="${160 - height}" dur="0.8s" fill="freeze" />
                                            </rect>
                                            <text x="${x + 17.5}" y="175" fill="rgba(255,255,255,0.7)" font-size="10" text-anchor="middle">${phase.substring(0, 3)}</text>
                                            <text x="${x + 17.5}" y="${150 - height}" fill="white" font-size="14" font-weight="bold" text-anchor="middle">${count}</text>
                                        </g>
                                    `;
                                }).join('')}
                            </svg>
                        </div>
                        
                        <!-- Progression Globale (Jauge circulaire) -->
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.8); font-size: 13px; font-weight: 600; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;">${t.avgProgress}</div>
                            <svg width="100%" height="200" viewBox="0 0 200 200">
                                <defs>
                                    <linearGradient id="circleGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <!-- Cercle de fond -->
                                <circle cx="100" cy="100" r="70" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="15"/>
                                <!-- Cercle de progression -->
                                <circle cx="100" cy="100" r="70" fill="none" stroke="url(#circleGrad)" stroke-width="15" 
                                    stroke-dasharray="${2 * Math.PI * 70}" 
                                    stroke-dashoffset="${2 * Math.PI * 70 * (1 - avgProgress / 100)}"
                                    transform="rotate(-90 100 100)"
                                    stroke-linecap="round">
                                    <animate attributeName="stroke-dashoffset" 
                                        from="${2 * Math.PI * 70}" 
                                        to="${2 * Math.PI * 70 * (1 - avgProgress / 100)}" 
                                        dur="1.5s" 
                                        fill="freeze" />
                                </circle>
                                <!-- Texte central -->
                                <text x="100" y="95" fill="white" font-size="36" font-weight="bold" text-anchor="middle">${avgProgress}%</text>
                                <text x="100" y="115" fill="rgba(255,255,255,0.6)" font-size="12" text-anchor="middle">${activeProjects.length} ${t.projects}</text>
                            </svg>
                        </div>
                        
                        <!-- M√©triques Rapides -->
                        <div style="display: flex; flex-direction: column; gap: 16px; justify-content: center;">
                            <div style="background: rgba(99, 102, 241, 0.1); border-left: 4px solid #6366f1; padding: 16px; border-radius: 8px;">
                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 11px; margin-bottom: 4px;">${t.totalBudget}</div>
                                <div style="color: white; font-size: 24px; font-weight: 700;">${totalBudget.toLocaleString()} DA</div>
                            </div>
                            <div style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981; padding: 16px; border-radius: 8px;">
                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 11px; margin-bottom: 4px;">${t.upcomingMilestones}</div>
                                <div style="color: white; font-size: 24px; font-weight: 700;">${milestones.filter(m => new Date(m.date) >= new Date() && m.statut !== 'compl√©t√©').length}</div>
                            </div>
                            <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; padding: 16px; border-radius: 8px;">
                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 11px; margin-bottom: 4px;">${t.activeRisks}</div>
                                <div style="color: white; font-size: 24px; font-weight: 700;">${totalRisks}</div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            `;
        }
        
        function renderDashboardPriority() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                empty: lang === 'en' ? 'No priority projects' : 'Aucun projet prioritaire'
            };

            const projects = JSON.parse(localStorage.getItem('rndProjects') || '[]');
            const container = document.getElementById('rndPriorityContainer');
            
            if (!container) return;
            
            if (projects.length === 0) {
                container.innerHTML = `<div class="rnd-empty"><p>${t.empty}</p></div>`;
                return;
            }
            
            const activeProjects = projects.filter(p => p.statut === 'actif').slice(0, 3);
            container.innerHTML = activeProjects.map(project => `
                <div style="padding: 12px 0; border-bottom: 1px solid rgba(99, 102, 241, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-weight: 600;">${project.titre}</span>
                        <span class="rnd-badge rnd-badge-medium">${project.phase}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // ========== GESTION DE L'HISTORIQUE DU CHAT AGENT dev ==========
        let rndChatHistory = JSON.parse(localStorage.getItem('rndChatHistory') || '[]');

        // ========== AGENT DEV ‚Üî ACTIONS (apply via dashboard button) ==========
        const rndPendingActionBatches = {};
        let rndLatestActionBatchId = null;

        function rndTryParseJson(text) {
            try {
                return JSON.parse(text);
            } catch (_) {
                return null;
            }
        }

        function rndExtractJsonFromFencedBlocks(text) {
            const blocks = [];
            // Supporte ```json, ```JSON, et m√™me ``` sans tag
            const re = /```(?:\w+)?\s*([\s\S]*?)\s*```/gi;
            let match;
            while ((match = re.exec(String(text || ''))) !== null) {
                blocks.push(match[1]);
            }
            return blocks;
        }

        function rndExtractJsonObjectContainingKey(raw, key = 'axilum_actions') {
            const text = String(raw || '');
            const keyQuoted = `"${key}"`;
            let idx = text.indexOf(keyQuoted);
            if (idx < 0) idx = text.indexOf(key);
            if (idx < 0) return null;

            const start = text.lastIndexOf('{', idx);
            if (start < 0) return null;

            let depth = 0;
            let inString = false;
            let escaped = false;
            for (let i = start; i < text.length; i++) {
                const ch = text[i];
                if (inString) {
                    if (escaped) {
                        escaped = false;
                        continue;
                    }
                    if (ch === '\\') {
                        escaped = true;
                        continue;
                    }
                    if (ch === '"') {
                        inString = false;
                    }
                    continue;
                }

                if (ch === '"') {
                    inString = true;
                    continue;
                }

                if (ch === '{') depth++;
                if (ch === '}') {
                    depth--;
                    if (depth === 0) {
                        return text.slice(start, i + 1);
                    }
                }
            }

            return null;
        }

        function rndExtractActionsFromResponse(responseText) {
            const raw = String(responseText || '');

            // 1) fenced code blocks (tag quelconque)
            // On parse uniquement les blocs qui contiennent axilum_actions.
            const reBlock = /```(?:\w+)?\s*([\s\S]*?)\s*```/gi;
            let match;
            while ((match = reBlock.exec(raw)) !== null) {
                const fullMatch = match[0];
                const block = match[1];
                if (!String(block).includes('axilum_actions')) continue;
                const obj = rndTryParseJson(block);
                if (obj && Array.isArray(obj.axilum_actions)) {
                    const cleaned = raw.replace(fullMatch, '').trim();
                    return { actions: obj.axilum_actions, cleanedText: cleaned };
                }
            }

            // 2) whole response is JSON
            const trimmed = raw.trim();
            if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
                const obj = rndTryParseJson(trimmed);
                if (obj && Array.isArray(obj.axilum_actions)) {
                    return { actions: obj.axilum_actions, cleanedText: '' };
                }
            }

            // 3) JSON imbriqu√© dans du texte (heuristique)
            const embedded = rndExtractJsonObjectContainingKey(raw, 'axilum_actions');
            if (embedded) {
                const obj = rndTryParseJson(embedded);
                if (obj && Array.isArray(obj.axilum_actions)) {
                    const cleaned = raw.replace(embedded, '').trim();
                    return { actions: obj.axilum_actions, cleanedText: cleaned };
                }
            }

            return { actions: null, cleanedText: raw };
        }

        function rndRegisterPendingActions(actions) {
            const id = `rnd_actions_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
            rndPendingActionBatches[id] = {
                actions: Array.isArray(actions) ? actions : [],
                createdAt: Date.now(),
                applied: false,
                discarded: false
            };
            rndLatestActionBatchId = id;
            updateRnDActionsUI();
            return id;
        }

        function updateRnDActionsUI() {
            const panel = document.getElementById('rndActionsPanel');
            const countEl = document.getElementById('rndActionsCount');
            if (!panel || !countEl) return;

            const batch = rndLatestActionBatchId ? rndPendingActionBatches[String(rndLatestActionBatchId)] : null;
            const count = (batch && !batch.applied && !batch.discarded && Array.isArray(batch.actions)) ? batch.actions.length : 0;

            if (count > 0) {
                countEl.textContent = String(count);
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        function applyRnDActionBatch(batchId) {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                confirm: lang === 'en' ? 'Apply {count} action(s) to R&D dashboard?' : 'Appliquer {count} action(s) au dashboard R&D ?',
                appliedTitle: lang === 'en' ? '‚úÖ Actions applied' : '‚úÖ Actions appliqu√©es',
                appliedDetails: lang === 'en' ? 'Applied: {applied} ‚Ä¢ Skipped: {skipped}' : 'Appliqu√©es: {applied} ‚Ä¢ Ignor√©es: {skipped}',
                toast: lang === 'en' ? '‚úÖ Actions applied: {applied} ‚Ä¢ Skipped: {skipped}' : '‚úÖ Actions appliqu√©es: {applied} ‚Ä¢ Ignor√©es: {skipped}'
            };

            const batch = rndPendingActionBatches[String(batchId)];
            if (!batch || batch.applied || batch.discarded) return;
            if (!Array.isArray(batch.actions) || batch.actions.length === 0) return;

            const ok = confirm(t.confirm.replace('{count}', String(batch.actions.length)));
            if (!ok) return;

            const result = rndApplyAgentActions(batch.actions);
            batch.applied = true;
            if (rndLatestActionBatchId === String(batchId)) rndLatestActionBatchId = null;
            updateRnDActionsUI();

            const el = document.getElementById(`rndActionsCard_${batchId}`);
            if (el) {
                el.innerHTML = `
                    <div style="color: rgba(255,255,255,0.92); font-weight: 700;">${t.appliedTitle}</div>
                    <div style="margin-top: 6px; color: rgba(255,255,255,0.65); font-size: 12px;">${t.appliedDetails.replace('{applied}', result.applied).replace('{skipped}', result.skipped)}</div>
                `;
            }

            showToast(t.toast.replace('{applied}', result.applied).replace('{skipped}', result.skipped), 'success');
        }

        function discardRnDActionBatch(batchId) {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                ignoredTitle: lang === 'en' ? '‚è∏Ô∏è Actions ignored' : '‚è∏Ô∏è Actions ignor√©es',
                ignoredDesc: lang === 'en' ? 'No changes were applied.' : 'Aucune modification n‚Äôa √©t√© appliqu√©e.'
            };

            const batch = rndPendingActionBatches[String(batchId)];
            if (!batch || batch.applied || batch.discarded) return;
            batch.discarded = true;
            if (rndLatestActionBatchId === String(batchId)) rndLatestActionBatchId = null;
            updateRnDActionsUI();

            const el = document.getElementById(`rndActionsCard_${batchId}`);
            if (el) {
                el.innerHTML = `
                    <div style="color: rgba(255,255,255,0.85); font-weight: 700;">${t.ignoredTitle}</div>
                    <div style="margin-top: 6px; color: rgba(255,255,255,0.6); font-size: 12px;">${t.ignoredDesc}</div>
                `;
            }
        }

        function rndToInt(value, fallback = 0) {
            const n = Number.parseInt(String(value ?? ''), 10);
            return Number.isFinite(n) ? n : fallback;
        }

        function rndToNumber(value, fallback = 0) {
            const n = Number(value);
            return Number.isFinite(n) ? n : fallback;
        }

        function rndNormalizeString(value, maxLen = 500) {
            return String(value ?? '').trim().slice(0, maxLen);
        }

        function rndApplyAgentActions(actions) {
            if (!Array.isArray(actions) || actions.length === 0) return { applied: 0, skipped: 0 };

            const projects = JSON.parse(localStorage.getItem('rndProjects') || '[]');
            const milestones = JSON.parse(localStorage.getItem('rndMilestones') || '[]');
            const documents = JSON.parse(localStorage.getItem('rndDocuments') || '[]');
            const risks = JSON.parse(localStorage.getItem('rndRisks') || '[]');

            let applied = 0;
            let skipped = 0;

            const upsertById = (arr, item) => {
                const id = item?.id;
                if (id === undefined || id === null) return false;
                const idx = arr.findIndex(x => String(x?.id) === String(id));
                if (idx >= 0) {
                    arr[idx] = { ...arr[idx], ...item, id, updated: new Date().toISOString() };
                } else {
                    arr.unshift({ ...item, id, created: item?.created || new Date().toISOString(), updated: new Date().toISOString() });
                }
                return true;
            };

            for (const action of actions) {
                const type = String(action?.type || action?.action || '').trim();
                const data = action?.data ?? action?.payload ?? action;

                try {
                    if (type === 'upsert_project') {
                        const titre = rndNormalizeString(data?.titre, 180);
                        if (!titre) { skipped++; continue; }

                        const id = (data?.id !== undefined && data?.id !== null) ? rndToInt(data.id, Date.now()) : Date.now();
                        const existing = projects.find(p => String(p?.id) === String(id));

                        // Respecter la limite FREE (3 projets non archiv√©s)
                        const selectedPlan = String(localStorage.getItem('selectedPlan') || 'FREE').toUpperCase();
                        const nonArchivedCount = projects.filter(p => p && p.statut !== 'archiv√©').length;
                        const isNew = !existing;
                        if (selectedPlan === 'FREE' && isNew && nonArchivedCount >= 3) {
                            skipped++;
                            continue;
                        }

                        const currency = rndNormalizeString(data?.budget?.devise || data?.budgetDevise || data?.devise || 'DA', 8) || 'DA';
                        const budgetPrevu = Math.max(0, rndToInt(data?.budget?.prevu ?? data?.budgetPrevu ?? data?.budget ?? 0, 0));
                        const budgetDepense = Math.max(0, rndToInt(data?.budget?.depense ?? data?.budgetDepense ?? existing?.budget?.depense ?? 0, 0));

                        const item = {
                            id,
                            titre,
                            domaine: rndNormalizeString(data?.domaine || existing?.domaine || 'autre', 40),
                            description: rndNormalizeString(data?.description || existing?.description || '', 5000),
                            probleme: rndNormalizeString(data?.probleme || existing?.probleme || '', 2000),
                            budget: {
                                prevu: budgetPrevu,
                                depense: budgetDepense,
                                devise: currency
                            },
                            duree: Math.max(1, rndToInt(data?.duree ?? existing?.duree ?? 12, 12)),
                            equipe: Array.isArray(data?.equipe) ? data.equipe.map(v => rndNormalizeString(v, 80)).filter(Boolean) : (existing?.equipe || []),
                            technologies: Array.isArray(data?.technologies) ? data.technologies.map(v => rndNormalizeString(v, 80)).filter(Boolean) : (existing?.technologies || []),
                            cible: rndNormalizeString(data?.cible || existing?.cible || '', 600),
                            phase: rndNormalizeString(data?.phase || existing?.phase || 'd√©couverte', 24) || 'd√©couverte',
                            avancement: Math.min(100, Math.max(0, rndToInt(data?.avancement ?? existing?.avancement ?? 5, 5))),
                            objectifs: Array.isArray(data?.objectifs) ? data.objectifs : (existing?.objectifs || []),
                            kpis: Array.isArray(data?.kpis) ? data.kpis : (existing?.kpis || []),
                            risques: Array.isArray(data?.risques) ? data.risques : (existing?.risques || []),
                            notes: rndNormalizeString(data?.notes ?? existing?.notes ?? '', 8000),
                            statut: rndNormalizeString(data?.statut || existing?.statut || 'actif', 24) || 'actif',
                            created: existing?.created || new Date().toISOString(),
                            updated: new Date().toISOString()
                        };

                        if (upsertById(projects, item)) applied++; else skipped++;
                        continue;
                    }

                    if (type === 'delete_project') {
                        const id = rndToInt(data?.id, NaN);
                        if (!Number.isFinite(id)) { skipped++; continue; }
                        const before = projects.length;
                        const next = projects.filter(p => String(p?.id) !== String(id));
                        if (next.length !== before) {
                            projects.splice(0, projects.length, ...next);
                            // Nettoyage des items li√©s
                            const mBefore = milestones.length;
                            const dBefore = documents.length;
                            const rBefore = risks.length;
                            const mNext = milestones.filter(m => String(m?.projectId) !== String(id));
                            const dNext = documents.filter(d => String(d?.projectId) !== String(id));
                            const rNext = risks.filter(r => String(r?.projectId) !== String(id));
                            milestones.splice(0, milestones.length, ...mNext);
                            documents.splice(0, documents.length, ...dNext);
                            risks.splice(0, risks.length, ...rNext);
                            applied++;
                        } else {
                            skipped++;
                        }
                        continue;
                    }

                    if (type === 'upsert_milestone') {
                        const titre = rndNormalizeString(data?.titre, 200);
                        const projectId = rndToInt(data?.projectId, NaN);
                        if (!titre || !Number.isFinite(projectId)) { skipped++; continue; }

                        const id = (data?.id !== undefined && data?.id !== null) ? rndToInt(data.id, Date.now()) : Date.now();
                        const existing = milestones.find(m => String(m?.id) === String(id));

                        const item = {
                            id,
                            projectId,
                            titre,
                            description: rndNormalizeString(data?.description || existing?.description || '', 2000),
                            date: rndNormalizeString(data?.date || existing?.date || '', 40),
                            statut: rndNormalizeString(data?.statut || existing?.statut || '√†-venir', 24) || '√†-venir',
                            kpis: Array.isArray(data?.kpis) ? data.kpis : (existing?.kpis || []),
                            created: existing?.created || new Date().toISOString()
                        };

                        if (upsertById(milestones, item)) applied++; else skipped++;
                        continue;
                    }

                    if (type === 'delete_milestone') {
                        const id = rndToInt(data?.id, NaN);
                        if (!Number.isFinite(id)) { skipped++; continue; }
                        const before = milestones.length;
                        const next = milestones.filter(m => String(m?.id) !== String(id));
                        if (next.length !== before) { milestones.splice(0, milestones.length, ...next); applied++; } else skipped++;
                        continue;
                    }

                    if (type === 'upsert_document') {
                        const titre = rndNormalizeString(data?.titre, 200);
                        const projectId = rndToInt(data?.projectId, NaN);
                        if (!titre || !Number.isFinite(projectId)) { skipped++; continue; }

                        const id = (data?.id !== undefined && data?.id !== null) ? rndToInt(data.id, Date.now()) : Date.now();
                        const existing = documents.find(d => String(d?.id) === String(id));

                        const item = {
                            id,
                            projectId,
                            titre,
                            type: rndNormalizeString(data?.type || existing?.type || 'autre', 32) || 'autre',
                            description: rndNormalizeString(data?.description || existing?.description || '', 3000),
                            url: rndNormalizeString(data?.url || existing?.url || '', 2000),
                            created: existing?.created || new Date().toISOString()
                        };

                        if (upsertById(documents, item)) applied++; else skipped++;
                        continue;
                    }

                    if (type === 'delete_document') {
                        const id = rndToInt(data?.id, NaN);
                        if (!Number.isFinite(id)) { skipped++; continue; }
                        const before = documents.length;
                        const next = documents.filter(d => String(d?.id) !== String(id));
                        if (next.length !== before) { documents.splice(0, documents.length, ...next); applied++; } else skipped++;
                        continue;
                    }

                    if (type === 'upsert_risk') {
                        const titre = rndNormalizeString(data?.titre, 200);
                        const projectId = rndToInt(data?.projectId, NaN);
                        if (!titre || !Number.isFinite(projectId)) { skipped++; continue; }

                        const id = (data?.id !== undefined && data?.id !== null) ? rndToInt(data.id, Date.now()) : Date.now();
                        const existing = risks.find(r => String(r?.id) === String(id));

                        const item = {
                            id,
                            projectId,
                            titre,
                            description: rndNormalizeString(data?.description || existing?.description || '', 3000),
                            criticite: rndNormalizeString(data?.criticite || existing?.criticite || 'moyenne', 24) || 'moyenne',
                            impact: Math.min(100, Math.max(0, rndToInt(data?.impact ?? existing?.impact ?? 50, 50))),
                            mitigation: rndNormalizeString(data?.mitigation || existing?.mitigation || '', 3000),
                            statut: rndNormalizeString(data?.statut || existing?.statut || 'actif', 24) || 'actif',
                            created: existing?.created || new Date().toISOString()
                        };

                        if (upsertById(risks, item)) applied++; else skipped++;
                        continue;
                    }

                    if (type === 'delete_risk') {
                        const id = rndToInt(data?.id, NaN);
                        if (!Number.isFinite(id)) { skipped++; continue; }
                        const before = risks.length;
                        const next = risks.filter(r => String(r?.id) !== String(id));
                        if (next.length !== before) { risks.splice(0, risks.length, ...next); applied++; } else skipped++;
                        continue;
                    }

                    skipped++;
                } catch (_) {
                    skipped++;
                }
            }

            localStorage.setItem('rndProjects', JSON.stringify(projects));
            localStorage.setItem('rndMilestones', JSON.stringify(milestones));
            localStorage.setItem('rndDocuments', JSON.stringify(documents));
            localStorage.setItem('rndRisks', JSON.stringify(risks));

            initializeRnDData();
            renderMilestonesList();
            renderDocsList();
            renderRisksList();

            return { applied, skipped };
        }

        function rndValidateActions(actions) {
            if (!Array.isArray(actions) || actions.length === 0) return null;

            const valid = [];
            for (const action of actions) {
                const type = String(action?.type || action?.action || '').trim();
                const data = action?.data ?? action?.payload ?? action;

                if (type === 'upsert_project') {
                    if (String(data?.titre || '').trim()) valid.push(action);
                    continue;
                }
                if (type === 'delete_project') {
                    if (data?.id !== undefined && data?.id !== null && String(data.id).trim() !== '') valid.push(action);
                    continue;
                }

                if (type === 'upsert_milestone') {
                    const hasProject = data?.projectId !== undefined && data?.projectId !== null && String(data.projectId).trim() !== '';
                    const hasTitle = String(data?.titre || '').trim();
                    const hasDate = String(data?.date || '').trim();
                    if (hasProject && hasTitle && hasDate) valid.push(action);
                    continue;
                }
                if (type === 'delete_milestone') {
                    if (data?.id !== undefined && data?.id !== null && String(data.id).trim() !== '') valid.push(action);
                    continue;
                }

                if (type === 'upsert_document') {
                    const hasProject = data?.projectId !== undefined && data?.projectId !== null && String(data.projectId).trim() !== '';
                    const hasTitle = String(data?.titre || '').trim();
                    if (hasProject && hasTitle) valid.push(action);
                    continue;
                }
                if (type === 'delete_document') {
                    if (data?.id !== undefined && data?.id !== null && String(data.id).trim() !== '') valid.push(action);
                    continue;
                }

                if (type === 'upsert_risk') {
                    const hasProject = data?.projectId !== undefined && data?.projectId !== null && String(data.projectId).trim() !== '';
                    const hasTitle = String(data?.titre || '').trim();
                    if (hasProject && hasTitle) valid.push(action);
                    continue;
                }
                if (type === 'delete_risk') {
                    if (data?.id !== undefined && data?.id !== null && String(data.id).trim() !== '') valid.push(action);
                    continue;
                }
            }

            return valid.length > 0 ? valid : null;
        }

        function applyRnDLatestActionBatch() {
            const batchId = rndLatestActionBatchId;
            if (!batchId) return;
            const batch = rndPendingActionBatches[String(batchId)];
            if (!batch || batch.applied || batch.discarded) return;
            if (!Array.isArray(batch.actions) || batch.actions.length === 0) return;

            const ok = confirm(`Appliquer ${batch.actions.length} action(s) au dashboard R&D ?`);
            if (!ok) return;

            const result = rndApplyAgentActions(batch.actions);
            batch.applied = true;
            rndLatestActionBatchId = null;
            updateRnDActionsUI();
            showToast(`‚úÖ Actions appliqu√©es: ${result.applied} ‚Ä¢ Ignor√©es: ${result.skipped}`, 'success');
        }
        
        function loadRnDChatHistory() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const messagesContainer = document.getElementById('rndChatMessages');
            if (!messagesContainer) return;
            
            // Vider le conteneur
            messagesContainer.innerHTML = '';
            
            // Afficher l'historique sauvegard√©
            if (rndChatHistory.length === 0) {
                const welcomeMsg = lang === 'en' 
                    ? 'üëã Hello! I am Agent dev, your AI assistant specialized in R&D and multi-domain innovation.<br><br>I can help you with:<br>‚Ä¢ Research project advice<br>‚Ä¢ Trend and innovation analysis<br>‚Ä¢ Innovation methodologies<br>‚Ä¢ R&D risk management<br>‚Ä¢ Process optimization<br><br>How can I assist you today?' 
                    : 'üëã Bonjour! Je suis Agent dev, votre assistant IA sp√©cialis√© en R&D et innovation multi-domaines.<br><br>Je peux vous aider avec :<br>‚Ä¢ Conseils sur vos projets de recherche<br>‚Ä¢ Analyse de tendances et innovations<br>‚Ä¢ M√©thodologies d\'innovation<br>‚Ä¢ Gestion des risques R&D<br>‚Ä¢ Optimisation de processus<br><br>Comment puis-je vous accompagner aujourd\'hui?';

                // Message de bienvenue si pas d'historique
                messagesContainer.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <div style="display: inline-block; background: rgba(255, 255, 255, 0.1); padding: 12px 16px; border-radius: 12px; max-width: 70%; border: 1px solid rgba(99, 102, 241, 0.3); overflow-wrap: anywhere; word-break: break-word;">
                            <p style="margin: 0; color: white; font-size: 14px; line-height: 1.6;">${welcomeMsg}</p>
                        </div>
                    </div>
                `;
            } else {
                // Afficher chaque message de l'historique
                rndChatHistory.forEach(msg => {
                    if (msg.role === 'user') {
                        messagesContainer.innerHTML += `
                            <div style="margin-bottom: 16px; text-align: right;">
                                <div style="display: inline-block; background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 12px 16px; border-radius: 12px; max-width: 70%; overflow-wrap: anywhere; word-break: break-word;">
                                    <p style="margin: 0; color: white; font-size: 14px;">${msg.content}</p>
                                </div>
                            </div>
                        `;
                    } else if (msg.role === 'assistant') {
                        messagesContainer.innerHTML += `
                            <div style="margin-bottom: 16px;">
                                <div style="display: inline-block; background: rgba(255, 255, 255, 0.1); padding: 12px 16px; border-radius: 12px; max-width: 70%; border: 1px solid rgba(99, 102, 241, 0.3); overflow-wrap: anywhere; word-break: break-word;">
                                    <p style="margin: 0; color: white; font-size: 14px; line-height: 1.6;">${msg.content}</p>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function clearRnDChatHistory() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                confirm: lang === 'en' ? '‚ö†Ô∏è Are you sure you want to clear the entire conversation history with Agent dev?\n\nThis action cannot be undone.' : '‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer tout l\'historique des conversations avec Agent dev?\n\nCette action est irr√©versible.',
                cleared: lang === 'en' ? 'üóëÔ∏è Chat history cleared successfully' : 'üóëÔ∏è Historique du chat effac√© avec succ√®s'
            };

            if (!confirm(t.confirm)) return;
            
            // Effacer l'historique
            rndChatHistory = [];
            localStorage.setItem('rndChatHistory', '[]');
            
            // Recharger l'affichage
            loadRnDChatHistory();
            
            // Notification de succ√®s
            const overlay = document.getElementById('rndOverlay');
            if (overlay) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #10b981, #059669);
                    color: white;
                    padding: 16px 24px;
                    border-radius: 12px;
                    font-size: 14px;
                    font-weight: 600;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                    z-index: 10003;
                    animation: slideIn 0.3s ease;
                `;
                toast.textContent = t.cleared;
                overlay.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }
        
        async function sendRnDMessage() {
            const input = document.getElementById('rndChatInput');
            const message = input.value.trim();
            if (!message) return;

            const messagesContainer = document.getElementById('rndChatMessages');
            
            // Add user message
            messagesContainer.innerHTML += `
                <div style="margin-bottom: 16px; text-align: right;">
                    <div style="display: inline-block; background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 12px 16px; border-radius: 12px; max-width: 70%; overflow-wrap: anywhere; word-break: break-word;">
                        <p style="margin: 0; color: white; font-size: 14px;">${message}</p>
                    </div>
                </div>
            `;
            
            // Sauvegarder le message utilisateur dans l'historique
            rndChatHistory.push({
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('rndChatHistory', JSON.stringify(rndChatHistory));
            
            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Add typing indicator
            const typingIndicator = 'Agent dev analyse...';
            messagesContainer.innerHTML += `
                <div id="rndTyping" style="margin-bottom: 16px;">
                    <div style="display: inline-block; background: rgba(255, 255, 255, 0.1); padding: 12px 16px; border-radius: 12px;">
                        <p style="margin: 0; color: rgba(255, 255, 255, 0.6); font-size: 14px;">${typingIndicator}</p>
                    </div>
                </div>
            `;
            
            try {
                // Aligner le module R&D sur le m√™me endpoint que le chat principal
                const endpoint = AGENT_ENDPOINT_PRO;
                
                // Get R&D context
                const rndData = getRnDDataFromStorage();
                const rndContext = buildAgentDevRnDContext({
                    mode: 'full',
                    projects: rndData.projects,
                    milestones: rndData.milestones,
                    documents: rndData.documents,
                    risks: rndData.risks
                });

                                const rndActionsContract = `

R√àGLE ACTIONS (IMPORTANT):
- Ne parle JAMAIS de "JSON", "bloc", "code" ou "format".
- Si tu n'as PAS encore toutes les infos n√©cessaires (ex: titre + date + projet pour un jalon), pose les questions n√©cessaires d'abord.
- Quand (et seulement quand) tu es pr√™t √† appliquer une modification ET que l'utilisateur a confirm√© / fourni les champs requis, r√©ponds UNIQUEMENT avec un objet JSON strict contenant "axilum_actions". Aucune phrase autour.

Format de r√©ponse (uniquement quand pr√™t √† appliquer):
{
    "axilum_actions": [
        {"type": "upsert_project", "data": {"id?": 0, "titre": "...", "domaine?": "...", "description?": "...", "probleme?": "...", "budgetPrevu?": 0, "budgetDevise?": "DA|EUR|USD|GBP|CAD", "duree?": 12, "equipe?": ["..."], "technologies?": ["..."], "cible?": "...", "phase?": "d√©couverte|id√©ation|exp√©rimentation|validation|d√©ploiement", "avancement?": 0, "statut?": "actif|archiv√©"}},
        {"type": "delete_project", "data": {"id": 0}},
        {"type": "upsert_milestone", "data": {"id?": 0, "projectId": 0, "titre": "...", "description?": "...", "date?": "YYYY-MM-DD", "statut?": "√†-venir|compl√©t√©"}},
        {"type": "delete_milestone", "data": {"id": 0}},
        {"type": "upsert_document", "data": {"id?": 0, "projectId": 0, "titre": "...", "type?": "specs|architecture|rapport|presentation|contrat|autre", "description?": "...", "url?": "..."}},
        {"type": "delete_document", "data": {"id": 0}},
        {"type": "upsert_risk", "data": {"id?": 0, "projectId": 0, "titre": "...", "description?": "...", "criticite?": "faible|moyenne|√©lev√©e|critique", "impact?": 0, "mitigation?": "...", "statut?": "actif|en-cours|r√©solu"}},
        {"type": "delete_risk", "data": {"id": 0}}
    ]
}
N'inclus des actions QUE si l'utilisateur demande explicitement de modifier/ajouter/supprimer des donn√©es.
`;

                // Aligner le context prefix avec le chat principal (knowledge app + contexte enrichi)
                const baseContext = (typeof getApplicationKnowledge === 'function' ? getApplicationKnowledge('agent-dev') : '')
                    + (typeof AxilumContext !== 'undefined' && AxilumContext && typeof AxilumContext.getEnrichedContext === 'function'
                        ? AxilumContext.getEnrichedContext('agent-dev')
                        : '');

                // Contexte entreprise (alignement avec Param√®tres Entreprise)
                const companySettings = (typeof getHRData === 'function' ? getHRData('companySettings', {}) : {}) || {};
                const companyCurrency = companySettings.currency || 'DA';
                const companyContext = companySettings.companyName || companySettings.businessSector || companySettings.currency
                    ? `\n\nINFORMATIONS DE L'ENTREPRISE :\n- Nom: ${companySettings.companyName || 'Non d√©fini'}\n- Domaine d'activit√©: ${companySettings.businessSector || 'Non d√©fini'}\n- Devise: ${companyCurrency}\n`
                    : `\n\nLes informations de l'entreprise n'ont pas encore √©t√© configur√©es.\n`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: withAuthHeaders({ 'Content-Type': 'application/json' }),
                    body: JSON.stringify({
                        message: baseContext + companyContext + '\n\n' + rndContext + rndActionsContract + '\n\nUtilisateur: ' + message,
                        conversationId: 'rnd-agent',
                        chatType: 'agent-dev',
                        history: Array.isArray(rndChatHistory) ? rndChatHistory.slice(-20) : []
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                document.getElementById('rndTyping')?.remove();
                
                // Format response with sources if available
                const rawResponse = String(data.response || '');
                const extracted = rndExtractActionsFromResponse(rawResponse);
                const validActions = rndValidateActions(extracted.actions);

                let responseHtml = '';
                if (Array.isArray(validActions) && validActions.length > 0) {
                    responseHtml = extracted.cleanedText
                        ? extracted.cleanedText
                        : '‚úÖ Proposition d‚Äôactions pr√™te. Allez sur l‚Äôonglet <strong>Dashboard</strong> puis cliquez <strong>Appliquer au dashboard</strong>.';
                } else {
                    responseHtml = extracted.cleanedText || rawResponse || 'Erreur de r√©ponse';
                }
                
                // Add bot response
                messagesContainer.innerHTML += `
                    <div style="margin-bottom: 16px;">
                        <div style="display: inline-block; background: rgba(255, 255, 255, 0.1); padding: 12px 16px; border-radius: 12px; max-width: 70%; border: 1px solid rgba(99, 102, 241, 0.3); overflow-wrap: anywhere; word-break: break-word;">
                            <p style="margin: 0; color: white; font-size: 14px; line-height: 1.6;">${responseHtml}</p>
                        </div>
                    </div>
                `;
                
                // Sauvegarder la r√©ponse de l'assistant dans l'historique
                rndChatHistory.push({
                    role: 'assistant',
                    content: responseHtml,
                    timestamp: new Date().toISOString()
                });

                // Si l'agent propose des actions, les enregistrer (application via bouton du dashboard)
                if (Array.isArray(validActions) && validActions.length > 0) {
                    const batchId = rndRegisterPendingActions(validActions);
                    messagesContainer.innerHTML += `
                        <div style="margin-bottom: 16px;">
                            <div id="rndActionsCard_${batchId}" style="
                                display: inline-block;
                                background: rgba(0, 0, 0, 0.28);
                                padding: 12px 14px;
                                border-radius: 12px;
                                border: 1px solid rgba(99, 102, 241, 0.22);
                                max-width: 70%;
                                text-align: left;
                            ">
                                <div style="color: rgba(255,255,255,0.9); font-weight: 700;">Proposition d'actions</div>
                                <div style="margin-top: 6px; color: rgba(255,255,255,0.65); font-size: 12px;">${validActions.length} action(s) pr√™tes √† appliquer au dashboard R&D.</div>
                                <div style="display:flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                    <button class="rnd-btn" type="button" onclick="applyRnDActionBatch('${batchId}')">Appliquer au dashboard</button>
                                    <button class="rnd-btn" type="button" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18);" onclick="discardRnDActionBatch('${batchId}')">Ignorer</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Limiter l'historique √† 50 messages pour √©viter de surcharger localStorage
                if (rndChatHistory.length > 50) {
                    rndChatHistory = rndChatHistory.slice(-50);
                }
                
                localStorage.setItem('rndChatHistory', JSON.stringify(rndChatHistory));
                
            } catch (error) {
                document.getElementById('rndTyping')?.remove();
                messagesContainer.innerHTML += `
                    <div style="margin-bottom: 16px;">
                        <div style="display: inline-block; background: rgba(239, 68, 68, 0.2); padding: 12px 16px; border-radius: 12px; max-width: 70%; border: 1px solid rgba(239, 68, 68, 0.3);">
                            <p style="margin: 0; color: #fca5a5; font-size: 14px;">Erreur: ${error.message}</p>
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Modal stubs (to be implemented)
        function showAddMilestoneModal() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                noProject: lang === 'en' ? 'Create a project first.' : 'Cr√©ez d\'abord un projet avant d\'ajouter des jalons.',
                title: lang === 'en' ? 'Add Milestone' : 'Ajouter un Jalon',
                project: lang === 'en' ? 'Project *' : 'Projet *',
                select: lang === 'en' ? '-- Select --' : '-- S√©lectionner --',
                milestoneTitle: lang === 'en' ? 'Title *' : 'Titre *',
                desc: lang === 'en' ? 'Description' : 'Description',
                descPlace: lang === 'en' ? 'Milestone description' : 'Description du jalon',
                targetDate: lang === 'en' ? 'Target Date *' : 'Date cible *',
                cancel: lang === 'en' ? 'Cancel' : 'Annuler',
                add: lang === 'en' ? 'Add' : 'Ajouter'
            };

            const projects = JSON.parse(localStorage.getItem('rndProjects') || '[]');
            
            if (projects.length === 0) {
                alert(t.noProject);
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'rndMilestoneModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 10002;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 16px; padding: 32px; width: 90%; max-width: 600px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
                    <h2 style="margin: 0 0 24px; font-size: 24px; color: white;">${t.title}</h2>
                    <form id="milestoneForm" onsubmit="saveMilestone(event)">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.project}</label>
                            <select id="milestoneProject" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px;">
                                <option value="">${t.select}</option>
                                ${projects.map(p => `<option value="${p.id}">${p.titre}</option>`).join('')}
                            </select>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.milestoneTitle}</label>
                            <input type="text" id="milestoneTitle" required placeholder="Ex: MVP Ready" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.desc}</label>
                            <textarea id="milestoneDescription" rows="2" placeholder="${t.descPlace}" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px; resize: vertical;"></textarea>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.targetDate}</label>
                            <input type="date" id="milestoneDate" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px;">
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button type="button" onclick="closeMilestoneModal()" style="padding: 12px 24px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; cursor: pointer;">${t.cancel}</button>
                            <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; border-radius: 8px; color: white; cursor: pointer; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);">${t.add}</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeMilestoneModal() {
            const modal = document.getElementById('rndMilestoneModal');
            if (modal) modal.remove();
        }
        
        function saveMilestone(event) {
            event.preventDefault();
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            
            const milestone = {
                id: Date.now(),
                projectId: parseInt(document.getElementById('milestoneProject').value),
                titre: document.getElementById('milestoneTitle').value.trim(),
                description: document.getElementById('milestoneDescription').value.trim(),
                date: document.getElementById('milestoneDate').value,
                statut: '√†-venir',
                kpis: [],
                created: new Date().toISOString()
            };
            
            const milestones = JSON.parse(localStorage.getItem('rndMilestones') || '[]');
            milestones.push(milestone);
            localStorage.setItem('rndMilestones', JSON.stringify(milestones));
            
            closeMilestoneModal();
            initializeRnDData();
            renderMilestonesList();
            alert(lang === 'en' ? '‚úÖ Milestone added successfully' : '‚úÖ Jalon ajout√© avec succ√®s');
        }
        
        
        function deleteMilestone(id) {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            if (!confirm(lang === 'en' ? 'Delete this milestone?' : 'Supprimer ce jalon ?')) return;
            const milestones = JSON.parse(localStorage.getItem('rndMilestones') || '[]');
            const next = milestones.filter(m => m.id !== id);
            localStorage.setItem('rndMilestones', JSON.stringify(next));
            initializeRnDData();
            renderMilestonesList();
        }

        function completeMilestone(id) {
            const milestones = JSON.parse(localStorage.getItem('rndMilestones') || '[]');
            const index = milestones.findIndex(m => m.id === id);
            if (index === -1) return;
            milestones[index] = { ...milestones[index], statut: 'compl√©t√©' };
            localStorage.setItem('rndMilestones', JSON.stringify(milestones));
            initializeRnDData();
            renderMilestonesList();
        }

function showAddDocumentModal() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                noProject: lang === 'en' ? 'Create a project first before adding documents.' : 'Cr√©ez d\'abord un projet avant d\'ajouter des documents.',
                title: lang === 'en' ? 'Add Document' : 'Ajouter un Document',
                project: lang === 'en' ? 'Project *' : 'Projet *',
                select: lang === 'en' ? '-- Select --' : '-- S√©lectionner --',
                docTitle: lang === 'en' ? 'Title *' : 'Titre *',
                docTitlePlace: lang === 'en' ? 'Ex: Technical Specifications' : 'Ex: Sp√©cifications techniques',
                type: lang === 'en' ? 'Type *' : 'Type *',
                desc: lang === 'en' ? 'Description' : 'Description',
                descPlace: lang === 'en' ? 'Document description' : 'Description du document',
                url: lang === 'en' ? 'URL or link' : 'URL ou lien',
                cancel: lang === 'en' ? 'Cancel' : 'Annuler',
                add: lang === 'en' ? 'Add' : 'Ajouter',
                types: {
                    specs: lang === 'en' ? 'Specifications' : 'Sp√©cifications',
                    architecture: lang === 'en' ? 'Architecture' : 'Architecture',
                    rapport: lang === 'en' ? 'Report' : 'Rapport',
                    presentation: lang === 'en' ? 'Presentation' : 'Pr√©sentation',
                    contrat: lang === 'en' ? 'Contract' : 'Contrat',
                    autre: lang === 'en' ? 'Other' : 'Autre'
                }
            };
            
            const projects = JSON.parse(localStorage.getItem('rndProjects') || '[]');
            
            if (projects.length === 0) {
                alert(t.noProject);
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'rndDocumentModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 10002;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 16px; padding: 32px; width: 90%; max-width: 600px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
                    <h2 style="margin: 0 0 24px; font-size: 24px; color: white;">${t.title}</h2>
                    <form id="documentForm" onsubmit="saveDocument(event)">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.project}</label>
                            <select id="documentProject" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px;">
                                <option value="">${t.select}</option>
                                ${projects.map(p => `<option value="${p.id}">${p.titre}</option>`).join('')}
                            </select>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.docTitle}</label>
                            <input type="text" id="documentTitle" required placeholder="${t.docTitlePlace}" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.type}</label>
                            <select id="documentType" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px;">
                                <option value="specs">${t.types.specs}</option>
                                <option value="architecture">${t.types.architecture}</option>
                                <option value="rapport">${t.types.rapport}</option>
                                <option value="presentation">${t.types.presentation}</option>
                                <option value="contrat">${t.types.contrat}</option>
                                <option value="autre">${t.types.autre}</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.desc}</label>
                            <textarea id="documentDescription" rows="2" placeholder="${t.descPlace}" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px; resize: vertical;"></textarea>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.url}</label>
                            <input type="url" id="documentUrl" placeholder="https://..." style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px;">
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button type="button" onclick="closeDocumentModal()" style="padding: 12px 24px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; cursor: pointer;">${t.cancel}</button>
                            <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; border-radius: 8px; color: white; cursor: pointer; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);">${t.add}</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeDocumentModal() {
            const modal = document.getElementById('rndDocumentModal');
            if (modal) modal.remove();
        }
        
        function saveDocument(event) {
            event.preventDefault();
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            
            const newDoc = {
                id: Date.now(),
                projectId: parseInt(document.getElementById('documentProject').value),
                titre: document.getElementById('documentTitle').value.trim(),
                type: document.getElementById('documentType').value,
                description: document.getElementById('documentDescription').value.trim(),
                url: document.getElementById('documentUrl').value.trim(),
                created: new Date().toISOString()
            };
            
            const documents = JSON.parse(localStorage.getItem('rndDocuments') || '[]');
            documents.push(newDoc);
            localStorage.setItem('rndDocuments', JSON.stringify(documents));
            
            closeDocumentModal();
            initializeRnDData();
            renderDocsList();
            alert(lang === 'en' ? '‚úÖ Document added successfully' : '‚úÖ Document ajout√© avec succ√®s');
        }
        
        function showAddRiskModal() {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            const t = {
                noProject: lang === 'en' ? 'Create a project first before adding risks.' : 'Cr√©ez d\'abord un projet avant d\'ajouter des risques.',
                title: lang === 'en' ? 'Add Risk' : 'Ajouter un Risque',
                project: lang === 'en' ? 'Project *' : 'Projet *',
                select: lang === 'en' ? '-- Select --' : '-- S√©lectionner --',
                riskTitle: lang === 'en' ? 'Title *' : 'Titre *',
                riskTitlePlace: lang === 'en' ? 'Ex: Tech dependency' : 'Ex: D√©pendance technologique',
                desc: lang === 'en' ? 'Description' : 'Description',
                descPlace: lang === 'en' ? 'Risk description' : 'Description du risque',
                criticality: lang === 'en' ? 'Criticality *' : 'Criticit√© *',
                impact: lang === 'en' ? 'Impact (%) *' : 'Impact (%) *',
                mitigation: lang === 'en' ? 'Mitigation Plan' : 'Plan d\'att√©nuation',
                mitigationPlace: lang === 'en' ? 'Actions to reduce risk' : 'Actions pour r√©duire le risque',
                cancel: lang === 'en' ? 'Cancel' : 'Annuler',
                add: lang === 'en' ? 'Add' : 'Ajouter',
                levels: {
                    low: lang === 'en' ? 'Low' : 'Faible',
                    medium: lang === 'en' ? 'Medium' : 'Moyenne',
                    high: lang === 'en' ? 'High' : '√âlev√©e',
                    critical: lang === 'en' ? 'Critical' : 'Critique'
                }
            };
            
            const projects = JSON.parse(localStorage.getItem('rndProjects') || '[]');
            
            if (projects.length === 0) {
                alert(t.noProject);
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'rndRiskModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 10002;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 16px; padding: 32px; width: 90%; max-width: 600px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
                    <h2 style="margin: 0 0 24px; font-size: 24px; color: white;">${t.title}</h2>
                    <form id="riskForm" onsubmit="saveRisk(event)">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.project}</label>
                            <select id="riskProject" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px;">
                                <option value="">${t.select}</option>
                                ${projects.map(p => `<option value="${p.id}">${p.titre}</option>`).join('')}
                            </select>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.riskTitle}</label>
                            <input type="text" id="riskTitle" required placeholder="${t.riskTitlePlace}" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.desc}</label>
                            <textarea id="riskDescription" rows="2" placeholder="${t.descPlace}" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px; resize: vertical;"></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.criticality}</label>
                                <select id="riskCriticality" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px;">
                                    <option value="faible">${t.levels.low}</option>
                                    <option value="moyenne">${t.levels.medium}</option>
                                    <option value="√©lev√©e">${t.levels.high}</option>
                                    <option value="critique">${t.levels.critical}</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.impact}</label>
                                <input type="number" id="riskImpact" required min="0" max="100" value="50" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px;">
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px;">${t.mitigation}</label>
                            <textarea id="riskMitigation" rows="2" placeholder="${t.mitigationPlace}" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; color: white; font-size: 14px; resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button type="button" onclick="closeRiskModal()" style="padding: 12px 24px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; cursor: pointer;">${t.cancel}</button>
                            <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; border-radius: 8px; color: white; cursor: pointer; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);">${t.add}</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeRiskModal() {
            const modal = document.getElementById('rndRiskModal');
            if (modal) modal.remove();
        }
        
        function saveRisk(event) {
            event.preventDefault();
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            
            const risk = {
                id: Date.now(),
                projectId: parseInt(document.getElementById('riskProject').value),
                titre: document.getElementById('riskTitle').value.trim(),
                description: document.getElementById('riskDescription').value.trim(),
                criticite: document.getElementById('riskCriticality').value,
                impact: parseInt(document.getElementById('riskImpact').value),
                mitigation: document.getElementById('riskMitigation').value.trim(),
                statut: 'actif',
                created: new Date().toISOString()
            };
            
            const risks = JSON.parse(localStorage.getItem('rndRisks') || '[]');
            risks.push(risk);
            localStorage.setItem('rndRisks', JSON.stringify(risks));
            
            closeRiskModal();
            initializeRnDData();
            renderRisksList();
            alert(lang === 'en' ? '‚úÖ Risk added successfully' : '‚úÖ Risque ajout√© avec succ√®s');
        }
        
        
        function deleteRisk(id) {
            const lang = (typeof getAppLanguage === 'function' && getAppLanguage() === 'en') ? 'en' : 'fr';
            if (!confirm(lang === 'en' ? 'Delete this risk?' : 'Sup
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Axilum AI - Assistant Intelligent v1.4-DEPLOY-TEST</title>
    <style>
        :root {
            --bg-primary: #FAFBFC;
            --bg-secondary: #F4F6F8;
            --bg-sidebar: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --user-msg: #3B82F6;
            --bot-msg: #FFFFFF;
            --accent: #3B82F6;
            --shadow: rgba(0, 0, 0, 0.08);
            --hi-low: #10B981;
            --hi-med: #F59E0B;
            --hi-high: #EF4444;
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1F2937;
            --bg-sidebar: #0F172A;
            --text-primary: #F9FAFB;
            --text-secondary: #9CA3AF;
            --border-color: #374151;
            --user-msg: #3B82F6;
            --bot-msg: #1F2937;
            --shadow: rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            transition: all 0.3s;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .menu-btn:hover {
            background: var(--bg-secondary);
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .logo .letter {
            display: inline-block;
            transition: opacity 0.3s ease;
        }

        .logo .letter.fade {
            animation: fadeOutIn 2s ease-in-out;
        }

        @keyframes fadeOutIn {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }



        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .icon-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Plan Selector */
        .plan-selector {
            display: flex;
            gap: 6px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 10px;
            margin-right: 10px;
        }

        .plan-badge {
            border: none;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .plan-badge:hover {
            background: var(--bg-primary);
        }

        .plan-badge.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .plan-badge.free.active {
            background: #10B981;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .plan-badge.pro.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: -40%;
            top: 60px;
            bottom: 0;
            width: 40%;
            max-width: 320px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            transition: left 0.3s ease-out;
            z-index: 99;
            box-shadow: 2px 0 20px var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
        }

        .new-chat-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .sessions-toggle-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .sessions-toggle-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .sessions-toggle-btn.active {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--accent);
        }

        .sessions-toggle-btn svg {
            width: 16px;
            height: 16px;
            transition: transform 0.3s ease;
        }

        .sessions-toggle-btn.active svg {
            transform: rotate(180deg);
        }

        .conversations {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease, opacity 0.3s ease, padding 0.3s ease;
        }

        .conversations.visible {
            max-height: 100%;
            opacity: 1;
            padding: 10px;
        }

        .conv-group {
            margin-bottom: 20px;
        }

        .conv-group-title {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            padding: 10px;
            font-weight: 600;
        }

        .conv-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .conv-item:hover {
            background: var(--bg-secondary);
        }

        .conv-item.active {
            background: var(--bg-secondary);
        }

        /* Status Dot pour niveau HI */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            transition: background-color 0.3s ease;
        }

        .status-dot.green {
            background-color: #27ae60;
            box-shadow: 0 0 4px rgba(39, 174, 96, 0.5);
        }

        .status-dot.orange {
            background-color: #f39c12;
            box-shadow: 0 0 4px rgba(243, 156, 18, 0.5);
        }

        .status-dot.red {
            background-color: #e74c3c;
            box-shadow: 0 0 4px rgba(231, 76, 60, 0.5);
        }

        .conv-item-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Main Chat */
        .chat-container {
            margin-top: 60px;
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s;
        }

        .chat-container.sidebar-open {
            margin-left: 40%;
        }

        @media (min-width: 800px) {
            .chat-container.sidebar-open {
                margin-left: 320px;
            }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 40px 20px 200px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        /* Plus d'espace en mode bureau */
        @media (min-width: 800px) {
            .chat-messages {
                padding-bottom: 220px;
            }
        }

        .message-wrapper {
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: none;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .user-avatar {
            background: var(--user-msg);
            color: white;
        }

        .bot-avatar {
            background: var(--bot-msg);
            border: 1px solid var(--border-color);
        }

        .message-sender {
            font-weight: 600;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .message-content {
            padding: 16px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 15px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            position: relative;
        }

        /* Scroll bar styling pour meilleure UX */
        .message-content::-webkit-scrollbar {
            width: 8px;
        }

        .message-content::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 4px;
        }

        .message-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .message-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .message-wrapper.user .message-content {
            background: var(--user-msg);
            color: white;
            margin-left: auto;
            margin-right: 0;
            max-width: 80%;
            border-radius: 18px 18px 4px 18px;
        }

        .message-wrapper.bot .message-content {
            background: var(--bot-msg);
            color: var(--text-primary);
            margin-left: 0;
            margin-right: auto;
            max-width: 80%;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px var(--shadow);
            border-radius: 18px 18px 18px 4px;
        }

        .message-wrapper.error .message-content {
            background: #FFF3F3;
            color: #D32F2F;
            border: 1px solid #FFCDD2;
        }

        /* Metrics */
        .metrics {
            display: none;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-hi {
            background: var(--hi-low);
            color: white;
        }

        .badge-hi.medium {
            background: var(--hi-med);
        }

        .badge-hi.high {
            background: var(--hi-high);
        }

        .badge-rag {
            background: #DBEAFE;
            color: #1E40AF;
        }

        [data-theme="dark"] .badge-rag {
            background: #1E3A8A;
            color: #93C5FD;
        }

        .badge-conf {
            background: #E0E7FF;
            color: #4338CA;
        }

        [data-theme="dark"] .badge-conf {
            background: #312E81;
            color: #A5B4FC;
        }

        /* Input Area */
        .input-container {
            max-width: 800px;
            margin: 0 auto;
            width: 95%;
            flex-shrink: 0;
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            padding: 0;
            transition: all 0.3s ease-out;
        }

        /* RÃ©duction input quand sidebar ouverte - tous appareils */
        .input-container.sidebar-open {
            width: 50%;
            max-width: 400px;
            transform: translateX(-50%) scale(0.85);
            bottom: 16px;
        }

        /* Bureau avec sidebar */
        @media (min-width: 800px) {
            .input-container.sidebar-open {
                width: 60%;
                max-width: 500px;
                transform: translateX(-50%) scale(0.9);
                bottom: 20px;
            }
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-sidebar);
            border-radius: 28px;
            border: 1.5px solid var(--border-color);
            transition: all 0.2s;
            box-shadow: 0 2px 16px var(--shadow);
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
            background: var(--bg-sidebar);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .input-icon-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            width: 32px;
            height: 32px;
            padding: 6px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-icon-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .input-icon-btn svg {
            width: 20px;
            height: 20px;
        }

        #userInput {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 15px;
            color: var(--text-primary);
            resize: none;
            max-height: 150px;
            font-family: inherit;
            min-height: 24px;
            line-height: 1.5;
            padding: 6px 8px;
        }

        #userInput::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
        }

        .send-btn {
            background: transparent;
            color: var(--accent);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            padding: 0;
        }

        .send-btn svg {
            width: 22px;
            height: 22px;
            stroke: var(--accent);
            transition: all 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            background: rgba(59, 130, 246, 0.1);
            transform: scale(1.1);
        }

        .send-btn:hover:not(:disabled) svg {
            stroke: var(--accent);
            transform: translateX(2px);
        }

        .send-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .send-btn:disabled svg {
            stroke: var(--text-secondary);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Badges neutres (sans couleur) */
        .badge.neutral {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            background: transparent;
        }

        /* Listes Fonctions/Outils */
        .feature-list .feature-item { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-radius:8px; background: var(--bg-secondary); color: var(--text-primary); }
        .feature-list .feature-item:hover { background: rgba(59,130,246,0.12); }
        .badge { font-size: 12px; padding:2px 8px; border-radius:999px; background:#10B981; color:white; }
        .badge.pro { background:#F59E0B; }
        .sidebar-section h3 { color: var(--text-primary); }

        /* User Profile Menu */
        .user-menu {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 280px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .user-menu.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .user-menu-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #2563eb);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .user-menu-info {
            flex: 1;
            min-width: 0;
        }

        .user-menu-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-menu-email {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .user-menu-divider {
            height: 1px;
            background: var(--border-color);
        }

        .user-menu-items {
            padding: 8px;
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .user-menu-item:hover {
            background: var(--bg-secondary);
        }

        .user-menu-item svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .user-menu-item-danger {
            color: #ef4444;
        }

        .user-menu-item-danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 14px 20px;
            border-radius: 12px;
            border: 1.5px solid var(--border-color);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            font-size: 14px;
            font-weight: 500;
            max-width: 320px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1.5px solid #3B82F6;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
        }

        .toast.error {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1.5px solid #EF4444;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.2);
        }

        /* File Upload */
        #fileInput {
            display: none;
        }

        /* Protection Alert */
        .protection-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            display: none;
        }

        .protection-alert.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translate(-50%, -60%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        /* ðŸš€ PERFORMANCE : Animation barre de progression */
        @keyframes progressSlide {
            from { width: 0%; opacity: 0.8; }
            to { width: 100%; opacity: 1; }
        }

        @keyframes loadingBar {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .performance-bar {
            animation: progressSlide 0.4s ease-out;
        }

        /* ðŸš€ PERFORMANCE : Styles badges performance */
        .badge-cache {
            animation: pulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }

        .badge-time,
        .badge-tokens {
            font-variant-numeric: tabular-nums;
        }
        
        /* ðŸŽ¨ Metrics icon styling */
        .metrics-icon {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            opacity: 0.7;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .metrics-icon:hover {
            opacity: 1;
            transform: scale(1.1);
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .metrics-icon:active {
            transform: scale(0.95);
        }
        
        /* Desktop: lÃ©gÃ¨rement plus grand et visible */
        @media (min-width: 769px) {
            .metrics-icon {
                width: 34px;
                height: 34px;
                opacity: 0.75;
            }
        }

        .protection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: none;
        }

        .protection-overlay.show {
            display: block;
        }

        .protection-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .protection-icon {
            font-size: 48px;
        }

        .protection-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .protection-description {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .protection-stats {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .protection-stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .protection-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .protection-btn {
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .protection-btn-primary {
            background: #3B82F6;
            color: white;
        }

        .protection-btn-primary:hover {
            background: #2563EB;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .protection-btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1.5px solid var(--border-color);
        }

        .protection-btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .protection-btn-danger {
            background: transparent;
            color: #EF4444;
            border: 1.5px solid #EF4444;
        }

        .protection-btn-danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-icon {
            width: 18px;
            height: 18px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-secondary);
            transition: all 0.2s;
            border: 1.5px solid var(--border-color);
        }

        .info-icon:hover {
            background: #3B82F6;
            color: white;
            border-color: #3B82F6;
            transform: scale(1.1);
        }

        .tooltip {
            position: fixed;
            background: var(--bg-primary);
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            max-width: 280px;
            font-size: 13px;
            line-height: 1.5;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none;
            pointer-events: none;
        }

        .tooltip.show {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                left: -100%;
            }

            .chat-container.sidebar-open {
                margin-left: 0;
            }

            .header-left .logo {
                font-size: 16px;
            }
        }

        /* Modern Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            transition: background 0.2s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Scrollbar pour Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
        }

        [data-theme="dark"] * {
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* About Modal Styles - Modern AI Design */
        .about-section {
            margin-bottom: 25px;
        }

        .about-section h3 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .about-section h3 svg {
            width: 20px;
            height: 20px;
            stroke: var(--accent);
        }

        .about-section p {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .about-intro {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            margin-bottom: 25px;
        }

        .about-intro p {
            margin: 0;
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.6;
        }

        .about-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .feature-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), #2563eb);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--accent);
        }

        .feature-card:hover::before {
            transform: scaleX(1);
        }

        .feature-card h4 {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .feature-card p {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        .dot-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .dot-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-secondary);
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .dot-item:hover {
            transform: translateX(3px);
            border-color: var(--accent);
        }

        .dot-example {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .dot-example.green {
            background: #27ae60;
            box-shadow: 0 0 8px rgba(39, 174, 96, 0.6);
        }

        .dot-example.orange {
            background: #f39c12;
            box-shadow: 0 0 8px rgba(243, 156, 18, 0.6);
        }

        .dot-example.red {
            background: #e74c3c;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.6);
        }

        .dot-item-content {
            flex: 1;
        }

        .dot-item-content strong {
            display: block;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .dot-item-content span {
            display: block;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .company-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1e40af 100%);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-top: 25px;
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }

        .company-info::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .company-info > * {
            position: relative;
            z-index: 1;
        }

        .company-info h4 {
            font-size: 18px;
            margin-bottom: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .company-info p {
            color: rgba(255, 255, 255, 0.95);
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        .company-info a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .company-info a:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .tech-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .tech-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-secondary);
            color: var(--accent);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .tech-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
            border-color: var(--accent);
        }

        /* Sidebar Menu Section */
        .sidebar-menu {
            flex-shrink: 0;
            padding: 15px 10px 20px 10px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-sidebar);
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--text-primary);
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            text-align: left;
        }

        .menu-item:hover {
            background: var(--bg-secondary);
            color: var(--accent);
            transform: translateX(3px);
        }

        .menu-item svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            flex-shrink: 0;
        }

        .menu-item-text {
            flex: 1;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }

        /* Mode Vocal - Voice Chat */
        #logo {
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        #logo:hover {
            color: var(--accent);
            transform: scale(1.05);
        }

        #logo.voice-active {
            color: var(--accent);
            animation: logo-pulse 1.5s ease-in-out infinite;
        }

        @keyframes logo-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .voice-mode-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 180px;
            background: var(--bg-primary);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            z-index: 100;
            border-top: 1px solid var(--border-color);
        }

        .voice-mode-container.active {
            display: flex;
        }

        .voice-orb {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voice-orb::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
            opacity: 0.3;
            animation: pulse-ring 2s ease-out infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.4); opacity: 0; }
        }

        .voice-orb-core {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .voice-orb.listening .voice-orb-core {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            animation: orb-listening 1.5s ease-in-out infinite;
        }

        .voice-orb.thinking .voice-orb-core {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            animation: orb-thinking 1s linear infinite;
        }

        .voice-orb.speaking .voice-orb-core {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            animation: orb-speaking 0.5s ease-in-out infinite;
        }

        @keyframes orb-listening {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes orb-thinking {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes orb-speaking {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(16, 185, 129, 0.5); }
            50% { transform: scale(1.15); box-shadow: 0 0 40px rgba(16, 185, 129, 0.8); }
        }

        .voice-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .voice-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            opacity: 0;
        }

        .voice-orb.listening .voice-particle {
            animation: particle-float 2s ease-in-out infinite;
        }

        @keyframes particle-float {
            0% { transform: translateY(0) scale(0); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateY(-40px) scale(1); opacity: 0; }
        }

        .voice-status-text {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            font-weight: 500;
        }

        .voice-status-text.listening {
            color: #3B82F6;
        }

        .voice-status-text.thinking {
            color: #8B5CF6;
        }

        .voice-status-text.speaking {
            color: #10B981;
        }

        .voice-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 30px;
        }

        .voice-bar {
            width: 3px;
            height: 10px;
            background: var(--accent);
            border-radius: 2px;
            opacity: 0.3;
            transition: all 0.1s ease;
        }

        .voice-orb.listening .voice-bar,
        .voice-orb.speaking .voice-bar {
            animation: voice-bar-pulse 0.5s ease-in-out infinite;
        }

        @keyframes voice-bar-pulse {
            0%, 100% { height: 10px; opacity: 0.3; }
            50% { height: 25px; opacity: 0.8; }
        }

        .voice-bar:nth-child(1) { animation-delay: 0s; }
        .voice-bar:nth-child(2) { animation-delay: 0.1s; }
        .voice-bar:nth-child(3) { animation-delay: 0.2s; }
        .voice-bar:nth-child(4) { animation-delay: 0.3s; }
        .voice-bar:nth-child(5) { animation-delay: 0.4s; }

        .input-container.voice-hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }
    </style>
</head>
<body data-theme="light">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
            <div class="logo" id="logo">Axilum AI</div>
        </div>
        <div class="header-right">
            <!-- Plan Selector -->
            <div class="plan-selector">
                <button class="plan-badge free" id="planBadgeFree" onclick="switchToPlan('free')" title="Plan Gratuit - Phi-3">
                    FREE
                </button>
                <button class="plan-badge pro active" id="planBadgePro" onclick="switchToPlan('pro')" title="Plan Pro - Llama 3.3 70B + Fonctions Azure">
                    PRO
                </button>
            </div>
            
            <button class="icon-btn" onclick="newConversation()" title="Nouvelle conversation">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
            </button>
            <button class="icon-btn" onclick="toggleTheme()" title="Mode sombre" id="themeBtn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                </svg>
            </button>

        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="newConversation()">
                <svg style="width: 16px; height: 16px; margin-right: 8px; display: inline-block; vertical-align: middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Nouvelle Conversation
            </button>
            <button class="sessions-toggle-btn" id="sessionsToggleBtn" onclick="toggleSessions()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Sessions
                <svg style="margin-left: auto;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
        </div>

        <div class="conversations visible" id="conversationsList">
            <!-- Dynamically loaded -->
        </div>
        
        <!-- Menu Section -->
        <div class="sidebar-menu">
            <button class="menu-item" id="accountBtn" onclick="showAccountMenu()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span class="menu-item-text">Mon Compte</span>
            </button>
            <button class="menu-item" onclick="showStats()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <span class="menu-item-text">Statistiques</span>
            </button>
            <button class="menu-item" onclick="showSettings()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="menu-item-text">ParamÃ¨tres</span>
            </button>
            <button class="menu-item" onclick="showAbout()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="menu-item-text">Ã€ propos</span>
            </button>
            <!-- Section My Office (dÃ©pliable) -->
            <button class="menu-item" onclick="toggleFunctionsSection()" title="My Office">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5a2 2 0 104 0 2 2 0 10-4 0zM5 11a2 2 0 102 2h2a2 2 0 102-2v-2a2 2 0 10-2-2H9a2 2 0 10-4 2v2zM13 13a2 2 0 112 2v2a2 2 0 11-2 2h-2a2 2 0 11-2-2v-2a2 2 0 112-2h2z"/>
                </svg>
                <span class="menu-item-text">My Office</span>
                <span class="badge neutral" style="margin-left:8px;">PRO</span>
                <svg id="functionsChevron" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px; height:16px; margin-left:auto; transition:transform 0.3s;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
            <div id="functionsContent" style="display:none; padding-left:20px;">
                <!-- Item indentÃ©: Analyse Vision -->
                <button class="menu-item" id="visionAnalyzeBtn" onclick="showToast('ðŸ”œ Prochainement disponible', '')" style="padding-left:30px;" title="Analyse Vision - Prochainement disponible">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12zm11 3a3 3 0 100-6 3 3 0 000 6z"/>
                    </svg>
                    <span class="menu-item-text">Analyse Vision</span>
                </button>
                <!-- To Do (Calendrier, TÃ¢ches, Planning) -->
                <button class="menu-item" onclick="openOfficePro()" style="padding-left:30px;" title="To Do - Calendrier, TÃ¢ches, Planning">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    <span class="menu-item-text">To Do</span>
                </button>
                <!-- Text (Traitement de texte professionnel) -->
                <button class="menu-item" onclick="openTextPro()" style="padding-left:30px;" title="Text - Traitement de texte professionnel">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="menu-item-text">Text</span>
                </button>
                <!-- Excel (Assistant Excel expert) -->
                <button class="menu-item" onclick="openExcelPro()" style="padding-left:30px;" title="Excel - Assistant Excel expert">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    <span class="menu-item-text">Excel</span>
                </button>
            </div>
            
            <!-- Section Outils (dÃ©pliable) -->
            <button class="menu-item" onclick="toggleToolsSection()" title="Outils">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3a1 1 0 011 1v3l2 2 3-3a1 1 0 011 0l2 2a1 1 0 010 1l-3 3 2 2h3a1 1 0 011 1v2a1 1 0 01-1 1h-3l-4 4a2 2 0 01-2.828 0l-6.586-6.586a2 2 0 010-2.828L9 9V6a3 3 0 013-3z"/>
                </svg>
                <span class="menu-item-text">Outils</span>
                <svg id="toolsChevron" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px; height:16px; margin-left:auto; transition:transform 0.3s;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
            <div id="toolsContent" style="display:none; padding-left:20px;">
            </div>
        </div>
    </div>

    <!-- Main Chat -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will appear here -->
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <button class="input-icon-btn" onclick="attachFile()" title="Joindre un fichier">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                    </svg>
                </button>
                <button class="input-icon-btn" onclick="startVoiceInput()" title="Saisie vocale">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                </button>
                <textarea id="userInput" placeholder="Ã‰crivez votre message..." rows="1"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Voice Mode Container -->
        <div class="voice-mode-container" id="voiceModeContainer">
            <div class="voice-orb" id="voiceOrb" onclick="toggleVoiceMode()">
                <div class="voice-particles" id="voiceParticles"></div>
                <div class="voice-orb-core">
                    <svg width="32" height="32" fill="white" viewBox="0 0 24 24" stroke="white" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" fill="none"/>
                    </svg>
                </div>
            </div>
            <div class="voice-status-text" id="voiceStatusText">Je vous Ã©coute...</div>
            <div class="voice-visualizer">
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
            </div>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div class="modal" id="signupModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title">CrÃ©er un compte</div>
                <button class="close-modal" onclick="closeSignupModal()">Ã—</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form id="signupForm" onsubmit="handleSignup(event)">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Nom complet</label>
                        <input type="text" id="signupName" required 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="John Doe">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Email</label>
                        <input type="email" id="signupEmail" required 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="john@example.com">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Mot de passe</label>
                        <input type="password" id="signupPassword" required minlength="6"
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="Minimum 6 caractÃ¨res">
                    </div>
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Confirmer le mot de passe</label>
                        <input type="password" id="signupPasswordConfirm" required minlength="6"
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="Retapez votre mot de passe">
                    </div>
                    <button type="submit" 
                        style="width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: opacity 0.2s;">
                        CrÃ©er mon compte
                    </button>
                </form>
                <div style="text-align: center; margin-top: 16px; color: var(--text-secondary); font-size: 14px;">
                    DÃ©jÃ  un compte ? <a href="#" onclick="showSignin(); return false;" style="color: var(--accent); text-decoration: none; font-weight: 500;">Se connecter</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign In Modal -->
    <div class="modal" id="signinModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title">Se connecter</div>
                <button class="close-modal" onclick="closeSigninModal()">Ã—</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form id="signinForm" onsubmit="handleSignin(event)">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Email</label>
                        <input type="email" id="signinEmail" required 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="john@example.com">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Mot de passe</label>
                        <input type="password" id="signinPassword" required 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="Votre mot de passe">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                        <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 14px; cursor: pointer;">
                            <input type="checkbox" id="rememberMe" style="cursor: pointer;">
                            Se souvenir de moi
                        </label>
                        <a href="#" onclick="showForgotPasswordModal(); return false;" style="color: var(--accent); text-decoration: none; font-size: 14px;">Mot de passe oubliÃ© ?</a>
                    </div>
                    <button type="submit" 
                        style="width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: opacity 0.2s;">
                        Se connecter
                    </button>
                </form>
                <div style="text-align: center; margin-top: 16px; color: var(--text-secondary); font-size: 14px;">
                    Pas encore de compte ? <a href="#" onclick="showSignup(); return false;" style="color: var(--accent); text-decoration: none; font-weight: 500;">CrÃ©er un compte</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title">RÃ©initialiser le mot de passe</div>
                <button class="close-modal" onclick="closeForgotPasswordModal()">Ã—</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <svg style="width: 48px; height: 48px; margin: 0 auto 12px; display: block; color: var(--accent);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                    <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
                        Entrez votre email et choisissez un nouveau mot de passe
                    </p>
                </div>
                <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Email</label>
                        <input type="email" id="forgotPasswordEmail" required 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="john@example.com">
                    </div>
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Nouveau mot de passe</label>
                        <input type="password" id="forgotPasswordNew" required minlength="6"
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;" 
                            placeholder="Minimum 6 caractÃ¨res">
                        <p style="margin-top: 6px; color: var(--text-secondary); font-size: 12px;">Minimum 6 caractÃ¨res</p>
                    </div>
                    <button type="submit" 
                        style="width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: opacity 0.2s;">
                        Changer le mot de passe
                    </button>
                </form>
                <div style="text-align: center; margin-top: 16px;">
                    <a href="#" onclick="closeForgotPasswordModal(); showSignin(); return false;" style="color: var(--text-secondary); text-decoration: none; font-size: 14px;">â† Retour Ã  la connexion</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Verification Modal -->
    <div class="modal" id="verificationModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title">VÃ©rification Email</div>
                <button class="close-modal" onclick="closeVerificationModal()">Ã—</button>
            </div>
            <div class="modal-body" style="padding: 24px; text-align: center;">
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 2px dashed var(--accent);">
                    <svg style="width: 48px; height: 48px; margin: 0 auto 16px; display: block; color: var(--accent);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    <p style="margin: 0 0 12px 0; color: var(--text-primary); font-weight: 500;">Code de vÃ©rification envoyÃ© Ã  :</p>
                    <p id="verificationEmail" style="margin: 0; color: var(--accent); font-weight: 600; font-size: 15px;"></p>
                    <div style="margin-top: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid var(--accent);">
                        <p style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 13px;">Code de vÃ©rification (simulation) :</p>
                        <p id="displayedCode" style="margin: 0; color: var(--accent); font-weight: 700; font-size: 28px; letter-spacing: 4px; font-family: monospace;"></p>
                        <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 12px; font-style: italic;">En production, ce code sera envoyÃ© par email</p>
                    </div>
                </div>
                <form id="verificationForm" onsubmit="handleVerification(event)">
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 12px; font-weight: 500; color: var(--text-primary);">Entrez le code de vÃ©rification</label>
                        <input type="text" id="verificationCode" required maxlength="6" pattern="[0-9]{6}"
                            style="width: 100%; padding: 16px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 24px; text-align: center; letter-spacing: 8px; font-family: monospace; font-weight: 600;"
                            placeholder="000000"
                            autocomplete="off">
                        <p style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">Code Ã  6 chiffres</p>
                    </div>
                    <button type="submit"
                        style="width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer; transition: opacity 0.2s;">
                        VÃ©rifier et CrÃ©er le Compte
                    </button>
                </form>
                <div style="margin-top: 16px;">
                    <a href="#" onclick="resendVerificationCode(); return false;" style="color: var(--accent); text-decoration: none; font-size: 14px; font-weight: 500;">Renvoyer le code</a>
                    <span style="margin: 0 8px; color: var(--text-secondary);">â€¢</span>
                    <a href="#" onclick="cancelVerification(); return false;" style="color: var(--text-secondary); text-decoration: none; font-size: 14px;">Annuler</a>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Menu -->
    <!-- Hidden file input for profile photo -->
    <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;" onchange="handleProfilePhotoUpload(event)">
    
    <div class="user-menu" id="userMenu">
        <div class="user-menu-header">
            <div class="user-avatar" id="userMenuAvatar" style="cursor: pointer; position: relative; overflow: hidden; border-radius: 50%; background: var(--bg-secondary);" onclick="showProfilePhoto()" title="Cliquez pour changer la photo">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 40px; height: 40px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
            </div>
            <div class="user-menu-info">
                <div class="user-menu-name" id="userMenuName"></div>
                <div class="user-menu-email" id="userMenuEmail"></div>
            </div>
        </div>
        <div class="user-menu-divider"></div>
        <div class="user-menu-items">
            <a href="#" class="user-menu-item" onclick="showProfilePhoto(); return false;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span>Photo de profil</span>
            </a>
            <a href="#" class="user-menu-item" onclick="showResetPassword(); return false;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                </svg>
                <span>Changer le mot de passe</span>
            </a>
            <a href="#" class="user-menu-item user-menu-item-danger" onclick="logout(); return false;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                <span>Se dÃ©connecter</span>
            </a>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Stats Modal -->
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Statistiques</div>
                <button class="close-modal" onclick="closeModal()">Ã—</button>
            </div>
            <div id="statsContent">
                <!-- Dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal" id="aboutModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">Ã€ propos d'Axilum AI</div>
                <button class="close-modal" onclick="closeAboutModal()">Ã—</button>
            </div>
            <div style="padding: 20px;">
                <!-- Introduction -->
                <div class="about-intro">
                    <p>
                        <strong>Axilum AI</strong> est la <strong>premiÃ¨re et seule IA</strong> qui dÃ©tecte et vous protÃ¨ge activement contre les hallucinations. 
                        Notre systÃ¨me brevetÃ© analyse en temps rÃ©el la fiabilitÃ© de chaque rÃ©ponse grÃ¢ce Ã  des mÃ©triques rÃ©volutionnaires.
                    </p>
                </div>

                <!-- MÃ©triques HI/CHR -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        MÃ©triques de FiabilitÃ©
                    </h3>
                    <div class="about-features">
                        <div class="feature-card">
                            <h4>HI - Hallucination Index</h4>
                            <p>Mesure le taux d'incertitude dans la rÃ©ponse. Plus c'est bas, mieux c'est !</p>
                        </div>
                        <div class="feature-card">
                            <h4>CHR - Coherence Rate</h4>
                            <p>Ã‰value la cohÃ©rence et la logique interne de la rÃ©ponse gÃ©nÃ©rÃ©e.</p>
                        </div>
                    </div>
                </div>

                <!-- Dots de statut -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Indicateurs de Session
                    </h3>
                    <p>Chaque session affiche un point colorÃ© animÃ© indiquant sa qualitÃ© en temps rÃ©el :</p>
                    <div class="dot-legend">
                        <div class="dot-item">
                            <span class="dot-example green"></span>
                            <div class="dot-item-content">
                                <strong>Vert - Fiable</strong>
                                <span>HI moyen &lt; 40%</span>
                            </div>
                        </div>
                        <div class="dot-item">
                            <span class="dot-example orange"></span>
                            <div class="dot-item-content">
                                <strong>Orange - Attention</strong>
                                <span>HI moyen 40-59%</span>
                            </div>
                        </div>
                        <div class="dot-item">
                            <span class="dot-example red"></span>
                            <div class="dot-item-content">
                                <strong>Rouge - Risque</strong>
                                <span>HI moyen â‰¥ 60%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Technologies -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                        </svg>
                        Stack Technique
                    </h3>
                    <div class="tech-badges">
                        <span class="tech-badge">Azure OpenAI GPT-4</span>
                        <span class="tech-badge">Azure Functions</span>
                        <span class="tech-badge">Table Storage</span>
                        <span class="tech-badge">RAG System</span>
                        <span class="tech-badge">Google Fact Check</span>
                        <span class="tech-badge">Real-time Analysis</span>
                    </div>
                </div>

                <!-- Fonctions -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        Fonctions
                    </h3>
                    <p style="margin-bottom: 15px;">
                        <strong>Plan Pro :</strong> AccÃ©dez au Chat avancÃ© propulsÃ© par Llama 3.3 70B avec fonctions Azure exclusives. L'Analyse d'image utilise Azure Vision pour extraire du texte, dÃ©tecter des objets et analyser des scÃ¨nes visuelles. La GÃ©nÃ©ration d'images utilise DALL-E 3. Le RÃ©sumÃ© de documents permet de condenser automatiquement vos fichiers PDF et DOCX en points clÃ©s essentiels.
                    </p>
                    <p>
                        <strong>Plan Free :</strong> Profitez du Chat de base avec notre IA conversationnelle pour rÃ©pondre Ã  vos questions quotidiennes. La Lecture PDF/DOCX locale vous permet d'analyser vos documents directement dans votre navigateur sans envoi sur serveur, garantissant confidentialitÃ© et rapiditÃ©.
                    </p>
                </div>

                <!-- Outils -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Outils
                    </h3>
                    <p style="margin-bottom: 15px;">
                        <strong>Plan Pro :</strong> Le Form Recognizer extrait intelligemment les donnÃ©es structurÃ©es de formulaires, factures et documents administratifs. La Recherche avancÃ©e combine Azure Cognitive Search avec notre systÃ¨me RAG pour des rÃ©sultats prÃ©cis et contextualisÃ©s dans vos bases documentaires.
                    </p>
                    <p>
                        <strong>Plan Free :</strong> CrÃ©ez des images uniques avec la GÃ©nÃ©ration d'images via Pollinations AI. La Traduction instantanÃ©e supporte plusieurs langues grÃ¢ce Ã  Azure Translator. La SynthÃ¨se vocale (TTS) convertit du texte en parole naturelle pour une accessibilitÃ© amÃ©liorÃ©e.
                    </p>
                </div>

                <!-- Company Info -->
                <div class="company-info">
                    <h4>
                        <svg style="width: 22px; height: 22px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        DÃ©veloppÃ© par AI Solutions HubÂ®
                    </h4>
                    <p><strong>AI Solutions HubÂ®</strong> - Entreprise innovante spÃ©cialisÃ©e dans le dÃ©veloppement de solutions d'intelligence artificielle de confiance et Ã©thique.</p>
                    <p style="margin-top: 15px;">
                        <svg style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <strong>Support :</strong> <a href="mailto:support@solutionshub.uk">support@solutionshub.uk</a>
                    </p>
                    <p style="margin-top: 10px; font-size: 13px; opacity: 0.9;">
                        Â© 2025 AI Solutions HubÂ®. Tous droits rÃ©servÃ©s.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">ParamÃ¨tres</div>
                <button class="close-modal" onclick="closeSettingsModal()">Ã—</button>
            </div>
            <div style="padding: 20px;">
                <!-- Apparence -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                        </svg>
                        Apparence
                    </h3>
                    <div class="feature-card" style="cursor: pointer;" onclick="toggleTheme()">
                        <h4>
                            <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                            </svg>
                            ThÃ¨me Sombre / Clair
                        </h4>
                        <p>Basculer entre le mode clair et sombre</p>
                    </div>
                </div>

                <!-- DonnÃ©es -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
                        </svg>
                        Gestion des DonnÃ©es
                    </h3>
                    <div class="about-features">
                        <div class="feature-card" style="cursor: pointer;" onclick="exportAllConversations()">
                            <h4>Exporter Tout</h4>
                            <p>TÃ©lÃ©charger toutes vos conversations</p>
                        </div>
                        <div class="feature-card" style="cursor: pointer;" onclick="confirmClearData()">
                            <h4>Effacer DonnÃ©es</h4>
                            <p>Supprimer toutes les conversations</p>
                        </div>
                    </div>
                </div>

                <!-- Version -->
                <div class="about-section">
                    <h3>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Informations
                    </h3>
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color);">
                        <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">
                            <strong>Version :</strong> 1.0.0<br>
                            <strong>DerniÃ¨re mise Ã  jour :</strong> DÃ©cembre 2025<br>
                            <strong>Build :</strong> Production
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay pour panneaux -->
    <div id="panelOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1050;" onclick="closeAllPanels()"></div>

    <!-- Panneau Fonctions (slideout droite) -->
    <div id="functionsPanel" style="position:fixed; top:0; right:-100%; width:90%; max-width:600px; height:100vh; background:var(--bg-primary); z-index:1100; transition:right 0.3s ease; box-shadow:-2px 0 10px rgba(0,0,0,0.2); overflow-y:auto;">
        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:20px; color:var(--text-primary);">Fonctions</h2>
            <button onclick="closeFunctionsPanel()" style="background:none; border:none; font-size:28px; cursor:pointer; color:var(--text-primary);">Ã—</button>
        </div>
        <div id="functionsPanelBody" style="padding:20px;"></div>
    </div>

    <!-- Panneau Outils (slideout droite) -->
    <div id="toolsPanel" style="position:fixed; top:0; right:-100%; width:90%; max-width:600px; height:100vh; background:var(--bg-primary); z-index:1100; transition:right 0.3s ease; box-shadow:-2px 0 10px rgba(0,0,0,0.2); overflow-y:auto;">
        <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:20px; color:var(--text-primary);">Outils</h2>
            <button onclick="closeToolsPanel()" style="background:none; border:none; font-size:28px; cursor:pointer; color:var(--text-primary);">Ã—</button>
        </div>
        <div id="toolsPanelBody" style="padding:20px;"></div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Protection Alert -->
    <div class="protection-overlay" id="protectionOverlay"></div>
    <div class="protection-alert" id="protectionAlert">
        <div class="protection-header">
            <span class="protection-icon" id="protectionIcon"></span>
            <div>
                <h3 class="protection-title" id="protectionTitle"></h3>
            </div>
        </div>
        <p class="protection-description" id="protectionDescription"></p>
        <div class="protection-stats" id="protectionStats"></div>
        <div class="protection-actions" id="protectionActions"></div>
    </div>

    <!-- File Input -->
    <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.webp,image/*" onchange="handleFileUpload(event)">

    <script>
        // Configuration
        const AGENT_ENDPOINT_PRO = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:7071/api/agents/axilum/invoke'
            : '/api/agents/axilum/invoke';
        
        const AGENT_ENDPOINT_FREE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:7071/api/invoke-free'
            : '/api/invoke-free';
        
        // Get current endpoint based on plan
        function getEndpoint() {
            return currentPlan === 'free' ? AGENT_ENDPOINT_FREE : AGENT_ENDPOINT_PRO;
        }

        // State
        let conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
        let currentConversationId = null;
        let messageStats = JSON.parse(localStorage.getItem('messageStats') || '{"hiHistory":[],"chrHistory":[]}');
        let isRecording = false;
        let recognition = null;
        
        // Auth State
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        
        // Email Verification
        let pendingUser = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Log version pour dÃ©bogage dÃ©ploiement
            console.log('ðŸš€ AXILUM AI v1.4-DEPLOY-TEST - ' + new Date().toISOString());
            console.log('ðŸ“¦ Build timestamp: ' + Date.now());
            
            // Animation du logo
            const logoEl = document.getElementById('logo');
            const logoText = 'Axilum AI';
            
            // CrÃ©er les spans pour chaque lettre
            logoEl.innerHTML = '';
            logoText.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.className = 'letter';
                span.textContent = char === ' ' ? '\u00A0' : char;
                span.dataset.index = index;
                logoEl.appendChild(span);
            });
            
            // Animation: disparition/rÃ©apparition aprÃ¨s le "A" toutes les 30 secondes
            function animateLogo() {
                const letters = logoEl.querySelectorAll('.letter');
                letters.forEach((letter, index) => {
                    if (index > 0) { // Tout sauf le premier "A"
                        setTimeout(() => {
                            letter.classList.add('fade');
                            setTimeout(() => letter.classList.remove('fade'), 2000);
                        }, index * 100);
                    }
                });
            }
            
            // Lancer l'animation toutes les 30 secondes
            setInterval(animateLogo, 30000);
            
            loadConversations();
            
            // Si aucune conversation n'existe, en crÃ©er une nouvelle
            if (conversations.length === 0) {
                newConversation();
            } else {
                // Sinon, charger la conversation la plus rÃ©cente
                const userConversations = conversations.filter(conv => {
                    if (!currentUser) return !conv.userId;
                    return conv.userId === currentUser.id;
                });
                
                if (userConversations.length > 0) {
                    // Charger la conversation la plus rÃ©cente
                    const lastConv = userConversations[0];
                    loadConversation(lastConv.id);
                } else {
                    // Si l'utilisateur n'a pas de conversations, en crÃ©er une
                    newConversation();
                }
            }
            
            adjustTextareaHeight();
            
            // Auto-resize textarea
            document.getElementById('userInput').addEventListener('input', adjustTextareaHeight);
            
            // Enter to send (Shift+Enter for new line)
            document.getElementById('userInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Fermer sidebar en cliquant sur la zone de chat
            document.getElementById('chatContainer').addEventListener('click', (e) => {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('open') && !e.target.closest('.sidebar')) {
                    closeSidebar();
                }
            });

            // Fermer sidebar quand on commence Ã  Ã©crire
            document.getElementById('userInput').addEventListener('focus', () => {
                closeSidebar();
            });

            // Fermer le menu utilisateur si on clique ailleurs
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('userMenu');
                const accountBtn = document.getElementById('accountBtn');
                
                if (menu && accountBtn && !menu.contains(e.target) && !accountBtn.contains(e.target)) {
                    menu.classList.remove('show');
                }
            });

            // Initialize speech recognition if available
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'fr-FR';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('userInput').value = transcript;
                    adjustTextareaHeight();
                    showToast('âœ… Transcription terminÃ©e', 'success');
                };
                
                recognition.onerror = (event) => {
                    showToast('âŒ Erreur de reconnaissance vocale', 'error');
                    isRecording = false;
                };
                
                recognition.onend = () => {
                    isRecording = false;
                };
            }

            // Fermer le menu utilisateur si on clique ailleurs
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('userMenu');
                const accountBtn = document.getElementById('accountBtn');
                
                if (menu && accountBtn && !menu.contains(e.target) && !accountBtn.contains(e.target)) {
                    menu.classList.remove('show');
                }
            });
        });

        function adjustTextareaHeight() {
            const textarea = document.getElementById('userInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const chatContainer = document.getElementById('chatContainer');
            const inputContainer = document.querySelector('.input-container');
            sidebar.classList.toggle('open');
            chatContainer.classList.toggle('sidebar-open');
            
            // RÃ©duire input en mobile quand sidebar ouverte
            if (sidebar.classList.contains('open')) {
                inputContainer.classList.add('sidebar-open');
            } else {
                inputContainer.classList.remove('sidebar-open');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const chatContainer = document.getElementById('chatContainer');
            const inputContainer = document.querySelector('.input-container');
            sidebar.classList.remove('open');
            chatContainer.classList.remove('sidebar-open');
            inputContainer.classList.remove('sidebar-open');
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function newConversation() {
            currentConversationId = Date.now().toString();
            const newConv = {
                id: currentConversationId,
                title: 'Nouvelle conversation',
                messages: [],
                timestamp: Date.now(),
                userId: currentUser ? currentUser.id : null // Lier Ã  l'utilisateur connectÃ©
            };
            conversations.unshift(newConv);
            saveConversations();
            loadConversations();
            clearChat();
            // Focus sur l'input pour dÃ©marrer directement
            document.getElementById('userInput').focus();
        }

        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
        }

        // ðŸ†“ðŸ’Ž Plan Management
        let currentPlan = localStorage.getItem('axilum_plan') || 'pro'; // Default to pro

        function switchToPlan(plan) {
            currentPlan = plan;
            localStorage.setItem('axilum_plan', plan);
            
            // Update UI
            const freeBadge = document.getElementById('planBadgeFree');
            const proBadge = document.getElementById('planBadgePro');
            
            if (plan === 'free') {
                freeBadge.classList.add('active');
                proBadge.classList.remove('active');
            } else {
                proBadge.classList.add('active');
                freeBadge.classList.remove('active');
            }
        }

        // Initialize plan on load
        document.addEventListener('DOMContentLoaded', () => {
            switchToPlan(currentPlan);
        });

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            // Fermer la sidebar automatiquement
            closeSidebar();

            // Disable input
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            input.disabled = true;

            // Add user message
            addMessage(message, 'user');
            input.value = '';
            adjustTextareaHeight();

            // Show typing indicator
            showTyping();

            // PrÃ©parer l'historique de conversation
            const conv = conversations.find(c => c.id === currentConversationId);
            const history = [];
            if (conv && conv.messages) {
                conv.messages.forEach(m => {
                    // Ajouter le message utilisateur
                    if (m.user) {
                        history.push({
                            type: 'user',
                            content: m.user
                        });
                    }
                    // Ajouter la rÃ©ponse du bot
                    if (m.bot) {
                        history.push({
                            type: 'bot',
                            content: m.bot,
                            hiScore: m.hiScore || 0,
                            chrScore: m.chrScore || 0
                        });
                    }
                });
            }

            try {
                const requestStart = Date.now();
                const endpoint = getEndpoint();
                console.log(`ðŸŽ¯ Using ${currentPlan.toUpperCase()} endpoint:`, endpoint);
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message,
                        conversationId: currentConversationId,
                        history: history
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}`);
                }

                const data = await response.json();
                const requestTime = Date.now() - requestStart;
                hideTyping();
                
                // ðŸš€ PERFORMANCE : Afficher le temps de rÃ©ponse
                const isCached = response.headers.get('X-Cache') === 'HIT';
                if (isCached) {
                    console.log(`âš¡ RÃ©ponse en cache! Temps: ${requestTime}ms`);
                } else {
                    console.log(`ðŸ“Š Temps de rÃ©ponse: ${requestTime}ms`);
                }
                
                // Ajouter les infos de performance au data
                data.responseTime = requestTime;
                data.cached = isCached;
                
                // ï¿½ VÃ‰RIFIER SI ERREUR DE L'API
                if (data.error) {
                    console.error('âŒ Erreur de l\'API:', data.error);
                    let errorMessage = `âŒ **Erreur**: ${data.error}\n\n`;
                    if (data.hint) errorMessage += `ðŸ’¡ **Solution**: ${data.hint}\n\n`;
                    if (data.details) errorMessage += `ðŸ“‹ **DÃ©tails**: ${data.details}`;
                    addMessage(errorMessage, 'bot', data);
                    return;
                }
                
                // VÃ©rifier que response existe
                if (!data.response) {
                    console.error('âŒ Pas de rÃ©ponse dans data:', data);
                    addMessage('âŒ Erreur: L\'API n\'a pas retournÃ© de rÃ©ponse', 'bot', data);
                    return;
                }
                
                // ï¿½ðŸ›¡ï¸ VÃ©rifier la protection contre hallucinations
                if (data.protection && data.protection.should_intervene) {
                    showProtectionAlert(data.protection);
                }
                
                // ðŸŽ¨ DÃ©tecter demande de gÃ©nÃ©ration d'image
                const imageGenMatch = data.response.match(/Je gÃ©nÃ¨re l'image\s*:\s*(.+?)(?:\n|$)/i);
                if (imageGenMatch) {
                    const imagePrompt = imageGenMatch[1].trim();
                    
                    // Afficher le message de l'IA
                    addMessage(data.response || 'Pas de rÃ©ponse', 'bot', data);
                    
                    // GÃ©nÃ©rer l'image automatiquement
                    try {
                        showToast('ðŸŽ¨ GÃ©nÃ©ration de l\'image en cours...', 'info');
                        const imgResponse = await fetch('/api/generate-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: imagePrompt })
                        });
                        
                        if (imgResponse.ok) {
                            const imgData = await imgResponse.json();
                            imgData.imageGenerated = true;
                            addMessage(`Voici l'image gÃ©nÃ©rÃ©e :`, 'bot', imgData);
                            
                            // Sauvegarder l'image dans la conversation
                            const conv = conversations.find(c => c.id === currentConversationId);
                            if (conv) {
                                conv.messages.push({
                                    user: '',
                                    bot: `Voici l'image gÃ©nÃ©rÃ©e :`,
                                    timestamp: Date.now(),
                                    imageUrl: imgData.imageUrl,
                                    imageGenerated: true,
                                    prompt: imgData.prompt,
                                    hiScore: 0,
                                    chrScore: 0
                                });
                                saveConversations();
                            }
                            
                            showToast('âœ… Image gÃ©nÃ©rÃ©e avec succÃ¨s !', 'success');
                        } else {
                            const errorText = await imgResponse.text();
                            console.error('âŒ Erreur gÃ©nÃ©ration image:', imgResponse.status, errorText);
                            throw new Error(`Erreur ${imgResponse.status}`);
                        }
                    } catch (imgError) {
                        console.error('âŒ Exception gÃ©nÃ©ration image:', imgError);
                        addMessage(`âŒ DÃ©solÃ©, la gÃ©nÃ©ration d'image a Ã©chouÃ©: ${imgError.message}`, 'bot');
                    }
                } else {
                    // Add bot message with metrics
                    addMessage(data.response || 'Pas de rÃ©ponse', 'bot', data);
                }
                
                // Update stats
                updateStats(data);
                
                // Save conversation
                saveMessage(message, data);

            } catch (error) {
                hideTyping();
                addMessage(`Erreur: ${error.message}`, 'error');
                showToast('âŒ Erreur de connexion', 'error');
            } finally {
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        function addMessage(text, type, data = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-wrapper ${type}`;

            // Nettoyer le texte des mÃ©triques pour l'affichage
            let displayText = text;
            if (type === 'bot') {
                // Retirer toutes les variations de mÃ©triques (HI/CHR/pourcentages)
                displayText = text
                    // Retirer "---" et tout ce qui suit (mÃ©triques complÃ¨tes)
                    .replace(/\n*---[\s\S]*/g, '')
                    // Retirer lignes avec emoji + HI/CHR
                    .replace(/\n*ðŸ“Š.*?HI:.*?CHR:.*?\n*/gi, '')
                    // Retirer lignes HI: X% â€¢ CHR: Y%
                    .replace(/\n*HI:\s*[0-9.]+%.*?CHR:\s*[0-9.]+%.*?\n*/gi, '')
                    // Retirer lignes isolÃ©es de pourcentages
                    .replace(/\n*\d+\.\d+%\s*[â€¢Â·]\s*\d+\.\d+%.*?\n*/g, '')
                    // Retirer warnings et sources recommandÃ©es
                    .replace(/\n*âš ï¸\s*Attention\s*:.*?$/gm, '')
                    .replace(/\n*Sources recommandÃ©es\s*:[\s\S]*/gi, '')
                    .trim();
            }

            const now = new Date();
            const time = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            let avatarEmoji = type === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';
            let senderName = type === 'user' ? 'Vous' : 'Axilum AI';
            let avatarClass = type === 'user' ? 'user-avatar' : 'bot-avatar';

            // ðŸŽ¨ VÃ©rifier si c'est une image gÃ©nÃ©rÃ©e
            let contentHTML = displayText;
            if (data && data.imageUrl && data.imageGenerated) {
                contentHTML = `
                    <div style="margin-bottom: 12px;">${displayText}</div>
                    <div style="position: relative; width: 100%; max-width: 512px;">
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(147, 51, 234, 0.05)); border-radius: 12px; padding: 80px; text-align: center; overflow: hidden; position: relative;">
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <div style="width: 60px; height: 60px; border: 4px solid transparent; border-top-color: #3B82F6; border-radius: 50%; animation: spin 0.8s linear infinite; box-shadow: 0 0 30px rgba(59, 130, 246, 0.6), 0 0 60px rgba(59, 130, 246, 0.3);"></div>
                            </div>
                            <style>
                                @keyframes spin {
                                    to { transform: rotate(360deg); }
                                }
                            </style>
                        </div>
                        <img src="${data.imageUrl}" 
                             alt="${data.prompt || 'Image gÃ©nÃ©rÃ©e'}" 
                             style="position: absolute; top: 0; left: 0; width: 100%; height: auto; display: block; cursor: pointer; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.5s ease;"
                             onload="this.style.opacity='1'; this.previousElementSibling.style.display='none';"
                             onerror="this.previousElementSibling.innerHTML='<div style=\\'padding:40px;text-align:center;\\'><div style=\\'font-size:48px;margin-bottom:12px;\\'>âŒ</div><div style=\\'color:var(--text-secondary);\\'>Erreur de chargement</div></div>'"
                             onclick="window.open('${data.imageUrl}', '_blank')"
                             loading="eager">
                    </div>
                `;
            }

            messageWrapper.innerHTML = `
                <div class="message-header">
                    <div class="avatar ${avatarClass}">${avatarEmoji}</div>
                    <span class="message-sender">${senderName}</span>
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-content">${contentHTML}</div>
            `;

            // ðŸŽ¨ Add elegant metrics icon for bot messages
            if (type === 'bot' && data) {
                console.log('ðŸ” Debug - data:', {cached: data.cached, responseTime: data.responseTime, processingTime: data.processingTime, usage: data.usage});
                
                // Collecter toutes les mÃ©triques
                const metrics = {
                    performance: [],
                    quality: []
                };
                
                // MÃ©triques de performance
                if (data.cached === true) {
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>', 
                        label: 'Cache', 
                        value: `${data.responseTime}ms`, 
                        color: '#10B981'
                    });
                } else if (data.responseTime) {
                    const timeInSec = (data.responseTime / 1000).toFixed(2);
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>', 
                        label: 'Temps', 
                        value: `${timeInSec}s`, 
                        color: '#3B82F6'
                    });
                } else if (data.processingTime) {
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>', 
                        label: 'Temps', 
                        value: data.processingTime, 
                        color: '#3B82F6'
                    });
                }
                
                if (data.tokensUsed || (data.usage && data.usage.total_tokens)) {
                    const tokens = data.tokensUsed || data.usage.total_tokens;
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2v20M2 12h20"/></svg>', 
                        label: 'Tokens', 
                        value: tokens, 
                        color: '#8B5CF6'
                    });
                }
                
                // Prompt tokens uniquement
                if (data.promptTokens) {
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>', 
                        label: 'Prompt', 
                        value: data.promptTokens, 
                        color: '#3B82F6'
                    });
                }
                
                // Provider et Model
                if (data.provider) {
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>', 
                        label: 'Provider', 
                        value: data.provider, 
                        color: '#F59E0B'
                    });
                }
                
                if (data.model) {
                    metrics.performance.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m5.196-13.196l-4.242 4.242m-5.908 5.908l-4.242 4.242m18.384-.001l-4.242-4.242m-5.908-5.908l-4.242-4.242"/></svg>', 
                        label: 'ModÃ¨le', 
                        value: data.model, 
                        color: '#8B5CF6'
                    });
                }
                
                // MÃ©triques de qualitÃ©
                
                if (data.response && data.response.includes('HI:')) {
                    const hiMatch = data.response.match(/HI: ([0-9.]+)%/);
                    const chrMatch = data.response.match(/CHR: ([0-9.]+)%/);
                    
                    if (hiMatch) {
                        const hiValue = parseFloat(hiMatch[1]);
                        const color = hiValue < 15 ? '#10B981' : hiValue < 30 ? '#F59E0B' : '#EF4444';
                        metrics.quality.push({
                            icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>', 
                            label: 'HI', 
                            value: `${hiValue}%`, 
                            color: color
                        });
                    }
                    
                    if (chrMatch) {
                        const chrValue = parseFloat(chrMatch[1]);
                        const color = chrValue < 15 ? '#10B981' : chrValue < 30 ? '#F59E0B' : '#EF4444';
                        metrics.quality.push({
                            icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>', 
                            label: 'CHR', 
                            value: `${chrValue}%`, 
                            color: color
                        });
                    }
                }
                
                if (data.rag_verification && data.rag_verification.relevant_facts_count > 0) {
                    metrics.quality.push({
                        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>', 
                        label: 'RAG', 
                        value: `${data.rag_verification.relevant_facts_count} fait${data.rag_verification.relevant_facts_count > 1 ? 's' : ''}`, 
                        color: '#10B981'
                    });
                }
                
                // CrÃ©er l'icÃ´ne Ã©lÃ©gante si des mÃ©triques existent
                if (metrics.performance.length > 0 || metrics.quality.length > 0) {
                    const metricsIcon = document.createElement('div');
                    metricsIcon.className = 'metrics-icon';
                    metricsIcon.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4M12 8h.01"/>
                        </svg>
                    `;
                    
                    metricsIcon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showMetricsModal(metrics);
                    });
                    
                    messageWrapper.style.position = 'relative';
                    messageWrapper.appendChild(metricsIcon);
                }
            }

            // ðŸ”Š Ajouter bouton TTS pour les messages bot
            if (type === 'bot' && displayText && displayText.length > 0) {
                const ttsButton = document.createElement('button');
                ttsButton.className = 'tts-button';
                ttsButton.dataset.speaking = 'false';
                ttsButton.dataset.text = displayText;
                ttsButton.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                    </svg>
                `;
                ttsButton.title = 'Ã‰couter ce message';
                ttsButton.style.cssText = 'position: absolute; bottom: 8px; left: 8px; width: 28px; height: 28px; border-radius: 50%; background: var(--bg-secondary); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; color: var(--text-secondary); opacity: 0.6;';
                
                ttsButton.addEventListener('mouseenter', function() {
                    this.style.opacity = '1';
                    this.style.transform = 'scale(1.1)';
                    this.style.background = 'var(--accent)';
                    this.style.color = 'white';
                });
                
                ttsButton.addEventListener('mouseleave', function() {
                    this.style.opacity = '0.6';
                    this.style.transform = 'scale(1)';
                    this.style.background = 'var(--bg-secondary)';
                    this.style.color = 'var(--text-secondary)';
                });
                
                ttsButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleTTS(this);
                });
                
                messageWrapper.style.position = 'relative';
                messageWrapper.appendChild(ttsButton);
            }

            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ðŸŽ¨ Afficher modal Ã©lÃ©gant avec mÃ©triques
        function showMetricsModal(metrics) {
            // Supprimer modal existant si prÃ©sent
            const existing = document.getElementById('metricsModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'metricsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; animation: fadeIn 0.2s ease;';
            
            let performanceHTML = '';
            if (metrics.performance.length > 0) {
                performanceHTML = '<div style="margin-bottom: 16px;"><h4 style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>Performance</h4>';
                metrics.performance.forEach(m => {
                    performanceHTML += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 6px; transition: all 0.2s;">
                            <span style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary); font-size: 13px;">
                                <span style="color: ${m.color}; display: flex; align-items: center;">${m.icon}</span>
                                ${m.label}
                            </span>
                            <span style="font-weight: 600; color: ${m.color}; font-size: 14px;">${m.value}</span>
                        </div>
                    `;
                });
                performanceHTML += '</div>';
            }
            
            let qualityHTML = '';
            if (metrics.quality.length > 0) {
                qualityHTML = '<div><h4 style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>QualitÃ©</h4>';
                metrics.quality.forEach(m => {
                    qualityHTML += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 6px; transition: all 0.2s;">
                            <span style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary); font-size: 13px;">
                                <span style="color: ${m.color}; display: flex; align-items: center;">${m.icon}</span>
                                ${m.label}
                            </span>
                            <span style="font-weight: 600; color: ${m.color}; font-size: 14px;">${m.value}</span>
                        </div>
                    `;
                });
                qualityHTML += '</div>';
            }
            
            modal.innerHTML = `
                <div style="background: var(--bg-primary); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary); font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18"/>
                                <path d="M18 17V9"/>
                                <path d="M13 17V5"/>
                                <path d="M8 17v-3"/>
                            </svg>
                            MÃ©triques de rÃ©ponse
                        </h3>
                        <button onclick="document.getElementById('metricsModal').remove()" style="background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    ${performanceHTML}
                    ${qualityHTML}
                </div>
            `;
            
            // Fermer au clic sur le fond
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Hover sur bouton fermer
            const closeBtn = modal.querySelector('button');
            closeBtn.addEventListener('mouseenter', function() {
                this.style.background = 'var(--bg-secondary)';
            });
            closeBtn.addEventListener('mouseleave', function() {
                this.style.background = 'none';
            });
            
            document.body.appendChild(modal);
        }

        function showTyping() {
            const chatMessages = document.getElementById('chatMessages');
            const typing = document.createElement('div');
            typing.id = 'typing';
            typing.className = 'message-wrapper bot';
            typing.innerHTML = `
                <div class="message-header">
                    <div class="avatar bot-avatar">ðŸ¤–</div>
                    <span class="message-sender">Axilum AI</span>
                    <span class="message-time" style="color: var(--text-secondary); font-size: 12px;">Analyse en cours...</span>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
                <div style="height: 3px; background: linear-gradient(90deg, #3B82F6 0%, #3B82F6 50%, transparent 50%); background-size: 200% 100%; animation: loadingBar 1.5s linear infinite; border-radius: 2px; margin-top: 8px;"></div>
            `;
            chatMessages.appendChild(typing);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function attachFile() {
            document.getElementById('fileInput').click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileType = file.type;
            const isImage = fileType.startsWith('image/');
            const isText = fileType === 'text/plain';
            const isPDF = fileType === 'application/pdf';
            
            showToast(`ðŸ“Ž Fichier reÃ§u: ${file.name}`, 'info');
            
            try {
                if (isImage) {
                    // Lire l'image en base64
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64 = e.target.result;
                        addMessage(`ðŸ“¸ ${file.name}`, 'user');
                        
                        // Afficher l'image dans le chat
                        const imgData = {
                            imageUrl: base64,
                            imageGenerated: true,
                            prompt: file.name
                        };
                        addMessage('Votre image :', 'bot', imgData);
                        
                        // RÃ©activer l'analyse uniquement pour le plan PRO
                        const currentPlan = localStorage.getItem('selectedPlan') || 'FREE';
                        if (currentPlan === 'PRO') {
                            const analyzeEndpoint = '/api/analyze-image-pro';
                            showToast('ðŸ” Analyse avec Azure Vision (PRO)...', 'info');
                            showTyping();
                            try {
                                const response = await fetch(analyzeEndpoint, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        imageBase64: base64,
                                        question: 'DÃ©cris cette image en dÃ©tail. Que vois-tu ?'
                                    })
                                });
                                const analysisData = await response.json().catch(() => ({ analysis: 'RÃ©ponse non formatÃ©e.' }));
                                hideTyping();
                                if (response.ok) {
                                    const provider = analysisData.provider || 'Azure Computer Vision';
                                    const analysisMessage = `${analysisData.analysis}\n\n_AnalysÃ© par ${provider}_`;
                                    addMessage(analysisMessage, 'bot');
                                    const conv = conversations.find(c => c.id === currentConversationId);
                                    if (conv) {
                                        conv.messages.push({
                                            user: `ðŸ“¸ ${file.name}`,
                                            bot: analysisMessage,
                                            timestamp: Date.now(),
                                            imageUrl: base64,
                                            hiScore: 0,
                                            chrScore: 0
                                        });
                                        saveConversations();
                                    }
                                    showToast('âœ… Image analysÃ©e (PRO
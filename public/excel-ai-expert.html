<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel AI Expert - Axilum AI</title>
    <script>
        (function () {
            // Outil report√©: on garde le code mais on bloque l'acc√®s direct.
            const disabled = true;
            if (!disabled) return;
            try { sessionStorage.setItem('axilum_deferred_tool_blocked', 'excel-ai-expert'); } catch (_) {}
            window.location.replace('/');
        })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --excel-green: #217346;
            --excel-green-dark: #185C37;
            --excel-green-light: #2B8758;
            --excel-green-bg: #F0F8F4;
            --excel-green-border: #D4E8DD;
            --bg-white: #FFFFFF;
            --bg-gray: #F5F5F5;
            --text-dark: #1F1F1F;
            --text-gray: #5F5F5F;
            --border-gray: #D4D4D4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Calibri', 'Arial', sans-serif;
            background: var(--bg-white);
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* Header Excel Style */
        .excel-header {
            background: var(--excel-green);
            color: white;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .excel-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .excel-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
        }

        .excel-title {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.9;
        }

        .header-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .icon-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        /* Auto-save indicator */
        .save-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-indicator.show {
            opacity: 1;
        }

        .save-indicator.saving {
            background: rgba(251, 191, 36, 0.2);
            color: #FCD34D;
        }

        .save-indicator.saved {
            background: rgba(16, 185, 129, 0.2);
            color: #6EE7B7;
        }

        /* Ribbon Menu */
        .ribbon {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-gray);
            padding: 8px 24px;
            display: flex;
            gap: 32px;
        }

        .ribbon-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .ribbon-group-label {
            font-size: 11px;
            color: var(--text-gray);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ribbon-buttons {
            display: flex;
            gap: 4px;
        }

        .ribbon-btn {
            background: var(--bg-white);
            border: 1px solid var(--border-gray);
            color: var(--text-dark);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .ribbon-btn:hover {
            background: var(--excel-green-bg);
            border-color: var(--excel-green);
        }

        .ribbon-btn svg {
            stroke: var(--excel-green);
        }

        /* Main Container */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 0;
            height: calc(100vh - 120px);
        }

        /* Excel Work Area */
        .excel-work-area {
            background: var(--bg-white);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-gray);
        }

        .upload-zone {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .upload-card {
            background: var(--excel-green-bg);
            border: 2px dashed var(--excel-green-border);
            border-radius: 8px;
            padding: 60px 40px;
            text-align: center;
            max-width: 500px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-card:hover {
            background: #E8F5EF;
            border-color: var(--excel-green);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            background: var(--excel-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .upload-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--excel-green);
            margin-bottom: 8px;
        }

        .upload-subtitle {
            font-size: 14px;
            color: var(--text-gray);
            margin-bottom: 20px;
        }

        .upload-btn {
            background: var(--excel-green);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background: var(--excel-green-dark);
        }

        /* Excel Table */
        .excel-table-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            display: none;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .excel-table th {
            background: var(--excel-green);
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border: 1px solid var(--excel-green-dark);
            position: sticky;
            top: 0;
        }

        .excel-table td {
            padding: 8px 10px;
            border: 1px solid var(--border-gray);
            background: white;
        }

        .excel-table td.editable-cell {
            cursor: text;
            transition: background-color 0.2s;
        }

        .excel-table td.editable-cell:hover {
            background: #fffef0;
            outline: 1px solid #1976d2;
        }

        .excel-table td.editable-cell:focus {
            background: #fff8dc;
            outline: 2px solid #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .excel-table tr:hover td {
            background: var(--excel-green-bg);
        }
        
        .excel-table tr:hover td.editable-cell {
            background: #fffef0;
        }

        /* Sidebar Panel */
        .sidebar-panel {
            background: var(--bg-white);
            border-left: 1px solid var(--border-gray);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .panel-header {
            background: var(--excel-green-bg);
            padding: 16px;
            border-bottom: 1px solid var(--excel-green-border);
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--excel-green);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: 100%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: calc(100vh - 400px);
            scroll-behavior: smooth;
        }

        /* Scrollbar personnalis√©e pour le chat */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-gray);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--excel-green);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--excel-green-dark);
        }

        .chat-message {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .chat-message.bot {
            background: var(--excel-green-bg);
            border-left: 3px solid var(--excel-green);
            color: var(--text-dark);
        }

        .chat-message.user {
            background: var(--bg-gray);
            border-left: 3px solid var(--text-gray);
            color: var(--text-dark);
        }

        .chat-input-container {
            padding: 16px;
            border-top: 1px solid var(--border-gray);
            background: var(--bg-white);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--excel-green);
        }

        .send-btn {
            background: var(--excel-green);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: var(--excel-green-dark);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Quick Actions */
        .quick-actions {
            padding: 16px;
            border-bottom: 1px solid var(--border-gray);
            background: var(--bg-white);
        }

        .quick-actions-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-gray);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .quick-action-btn {
            background: var(--bg-white);
            border: 1px solid var(--excel-green-border);
            color: var(--excel-green);
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-action-btn:hover {
            background: var(--excel-green-bg);
            border-color: var(--excel-green);
        }

        .quick-action-btn svg {
            stroke: var(--excel-green);
            flex-shrink: 0;
        }

        /* History Section */
        .history-section {
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid var(--border-gray);
            background: var(--bg-gray);
        }

        .history-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-gray);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .history-item {
            background: white;
            border: 1px solid var(--border-gray);
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 6px;
            color: var(--text-dark);
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            /* Tablette landscape */
            .main-container {
                grid-template-columns: 1fr 320px;
            }

            .ribbon {
                gap: 16px;
                overflow-x: auto;
                padding: 8px 16px;
            }

            .excel-header {
                padding: 12px 16px;
            }
        }

        @media (max-width: 1024px) {
            /* Tablette */
            .main-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            /* Agent Xcel: drawer lat√©ral (au lieu d'√™tre en bas) */
            .sidebar-panel {
                position: fixed;
                top: var(--excel-header-height, 60px);
                right: 0;
                width: 80vw;
                height: calc(100vh - var(--excel-header-height, 60px));
                border-left: 1px solid var(--border-gray);
                border-top: none;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .sidebar-panel.open {
                transform: translateX(0);
            }

            .ai-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50vh;
                max-height: 400px;
                border-right: none;
                border-top: 2px solid var(--excel-green);
                transform: translateY(100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .ai-panel.open {
                transform: translateY(0);
            }

            .excel-work-area {
                height: calc(100vh - 120px);
                border-right: none;
            }

            .ribbon {
                padding: 8px 12px;
                gap: 12px;
            }

            .ribbon-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            /* Mobile */
            .excel-header {
                padding: 10px 12px;
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                height: auto;
            }

            .excel-header-left {
                justify-content: space-between;
                width: 100%;
            }

            .excel-logo {
                font-size: 16px;
            }

            .excel-title {
                font-size: 12px;
            }

            .header-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .icon-btn {
                width: 28px;
                height: 28px;
            }

            .ribbon {
                padding: 6px 8px;
                gap: 8px;
                flex-wrap: wrap;
            }

            .ribbon-group {
                min-width: auto;
            }

            .ribbon-btn {
                padding: 6px 8px;
                font-size: 11px;
            }

            .upload-card {
                padding: 40px 20px;
            }

            .upload-icon {
                width: 48px;
                height: 48px;
            }

            .upload-title {
                font-size: 18px;
            }

            .upload-subtitle {
                font-size: 13px;
            }

            .upload-btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            /* Excel Table Responsive */
            .excel-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .excel-table table {
                min-width: 100%;
                font-size: 12px;
            }

            .excel-table th,
            .excel-table td {
                padding: 6px 8px;
                min-width: 80px;
            }

            /* AI Panel Mobile */
            .ai-panel {
                height: 60vh;
                max-height: none;
            }

            .ai-panel-header {
                padding: 12px;
            }

            .ai-panel-title {
                font-size: 14px;
            }

            .chat-messages {
                padding: 12px;
            }

            .chat-message {
                padding: 10px;
                font-size: 13px;
            }

            .chat-input-container {
                padding: 12px;
            }

            .chat-input {
                font-size: 14px;
                padding: 10px;
            }

            .send-btn {
                padding: 10px 12px;
            }

            .quick-actions-grid {
                grid-template-columns: 1fr;
            }

            .quick-action-btn {
                padding: 12px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            /* Petit mobile */
            .excel-header {
                padding: 8px;
            }

            .excel-logo {
                font-size: 14px;
                gap: 4px;
            }

            .excel-title {
                display: none;
            }

            .header-btn {
                padding: 5px 8px;
                font-size: 11px;
                gap: 4px;
            }

            .header-btn span {
                display: none;
            }

            .icon-btn {
                width: 26px;
                height: 26px;
            }

            .ribbon {
                padding: 4px;
                gap: 4px;
            }

            .ribbon-btn {
                padding: 4px 6px;
                font-size: 10px;
                gap: 4px;
            }

            .ribbon-btn svg {
                width: 14px;
                height: 14px;
            }

            .upload-card {
                padding: 30px 16px;
            }

            .upload-icon {
                width: 40px;
                height: 40px;
            }

            .upload-title {
                font-size: 16px;
            }

            .upload-subtitle {
                font-size: 12px;
            }

            .upload-btn {
                padding: 8px 16px;
                font-size: 13px;
            }

            .excel-table table {
                font-size: 11px;
            }

            .excel-table th,
            .excel-table td {
                padding: 4px 6px;
                min-width: 60px;
            }

            .chat-message {
                padding: 8px;
                font-size: 12px;
            }

            .quick-action-btn {
                padding: 10px;
                font-size: 12px;
            }
        }

        /* Toggle button for mobile AI panel */
        .ai-panel-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--excel-green);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(33, 115, 70, 0.4);
            cursor: pointer;
            z-index: 999;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .ai-panel-toggle:hover {
            background: var(--excel-green-dark);
            transform: scale(1.1);
        }

        @media (max-width: 1024px) {
            .ai-panel-toggle {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="excel-header">
        <div class="excel-header-left">
            <div class="excel-logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <line x1="9" y1="3" x2="9" y2="21"/>
                    <line x1="3" y1="9" x2="21" y2="9"/>
                    <line x1="3" y1="15" x2="21" y2="15"/>
                    <line x1="15" y1="9" x2="15" y2="21"/>
                </svg>
                Excel AI Expert
            </div>
            <span class="excel-title" id="fileName">Nouveau classeur</span>
            <div class="save-indicator" id="saveIndicator">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                <span id="saveIndicatorText">Sauvegard√©</span>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <button class="header-btn" onclick="window.location.href='/'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                </svg>
                Accueil
            </button>
            <button class="header-btn" type="button" onclick="toggleExcelChatSidebar()" title="Ouvrir Agent Xcel">
                Agent Xcel
            </button>
            <button class="icon-btn" onclick="toggleHelp()" title="Aide">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Ribbon Menu -->
    <div class="ribbon">
        <div class="ribbon-group">
            <div class="ribbon-group-label">Fichier</div>
            <div class="ribbon-buttons">
                <button class="ribbon-btn" onclick="document.getElementById('fileInput').click()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Importer
                </button>
                <button class="ribbon-btn" onclick="exportExcel()" id="exportBtn" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Exporter
                </button>
                <button class="ribbon-btn" onclick="clearSession()" title="Nouvelle session (efface toutes les donn√©es)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                    Nouvelle Session
                </button>
            </div>
        </div>

        <div class="ribbon-group">
            <div class="ribbon-group-label">Outils</div>
            <div class="ribbon-buttons">
                <button class="ribbon-btn" onclick="quickAction('analyze')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    Analyser
                </button>
                <button class="ribbon-btn" onclick="quickAction('formulas')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="5" y1="12" x2="19" y2="12"/>
                        <polyline points="12 5 19 12 12 19"/>
                    </svg>
                    Formules
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Excel Work Area -->
        <div class="excel-work-area">
            <!-- Upload Zone -->
            <div class="upload-zone" id="uploadZone">
                <div class="upload-card" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="9" y1="3" x2="9" y2="21"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="3" y1="15" x2="21" y2="15"/>
                            <line x1="15" y1="9" x2="15" y2="21"/>
                        </svg>
                    </div>
                    <div class="upload-title">Importer un fichier Excel</div>
                    <div class="upload-subtitle">Glissez-d√©posez un fichier .xlsx, .xls ou .csv</div>
                    <button class="upload-btn">Parcourir les fichiers</button>
                </div>
            </div>

            <!-- Excel Table -->
            <div class="excel-table-container" id="tableContainer">
                <table class="excel-table" id="excelTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Sidebar Panel -->
        <div class="sidebar-panel">
            <!-- Panel Header -->
            <div class="panel-header">
                <div class="panel-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/>
                        <line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                    Agent Xcel
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-actions-title">Actions Rapides</div>
                <div class="quick-actions-grid">
                    <button class="quick-action-btn" onclick="quickAction('kpi')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="20" x2="12" y2="10"/>
                            <line x1="18" y1="20" x2="18" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="16"/>
                        </svg>
                        G√©n√©rer KPI
                    </button>
                    <button class="quick-action-btn" onclick="quickAction('duplicate')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        D√©tecter Doublons
                    </button>
                    <button class="quick-action-btn" onclick="quickAction('pivot')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="9" y1="21" x2="9" y2="9"/>
                        </svg>
                        Tableau Crois√©
                    </button>
                    <button class="quick-action-btn" onclick="quickAction('chart')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"/>
                            <line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                        </svg>
                        Cr√©er Graphique
                    </button>
                </div>
            </div>

            <!-- AI Chat -->
            <div class="ai-chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message bot">
                        üëã Bonjour ! Je suis Agent Xcel, votre assistant Excel AI. Importez un fichier pour commencer ou posez-moi une question sur Excel.
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Posez votre question ici..."
                            rows="2"
                            onkeypress="handleKeyPress(event)"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- History -->
            <div class="history-section">
                <div class="history-title">Historique</div>
                <div id="historyList">
                    <div class="history-item">Aucune action pour le moment</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none" onchange="handleFileUpload(event)">

    <script>
        let excelData = [];
        let excelColumns = [];
        let currentFileName = '';
        let chatHistory = [];
        let actionHistory = [];

        function updateExcelHeaderHeight() {
            const header = document.querySelector('.excel-header');
            const h = header ? header.offsetHeight : 60;
            document.documentElement.style.setProperty('--excel-header-height', `${h}px`);
        }

        function toggleExcelChatSidebar(forceOpen) {
            const panel = document.querySelector('.sidebar-panel');
            if (!panel) return;

            if (typeof forceOpen === 'boolean') {
                panel.classList.toggle('open', forceOpen);
            } else {
                panel.classList.toggle('open');
            }

            updateExcelHeaderHeight();
        }

        // Initialiser la hauteur du header pour le drawer
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateExcelHeaderHeight);
        } else {
            updateExcelHeaderHeight();
        }
        window.addEventListener('resize', updateExcelHeaderHeight);

        // ==================================================
        // SAUVEGARDE AUTOMATIQUE - AUTO-SAVE FEATURE
        // ==================================================
        
        // R√©cup√©rer l'utilisateur connect√© (compatible avec le syst√®me d'authentification)
        function getCurrentUser() {
            try {
                return JSON.parse(localStorage.getItem('currentUser') || 'null');
            } catch (e) {
                return null;
            }
        }

        // G√©n√©rer une cl√© de sauvegarde unique par utilisateur
        function getSaveKey() {
            const user = getCurrentUser();
            const userId = user?.id || user?.email || 'guest';
            return `excel_ai_session_${userId}`;
        }

        // Afficher l'indicateur de sauvegarde
        function showSaveIndicator(status) {
            const indicator = document.getElementById('saveIndicator');
            const indicatorText = document.getElementById('saveIndicatorText');
            
            if (!indicator || !indicatorText) return;
            
            // R√©initialiser les classes
            indicator.classList.remove('saving', 'saved');
            
            if (status === 'saving') {
                indicator.classList.add('show', 'saving');
                indicatorText.textContent = 'Sauvegarde...';
            } else if (status === 'saved') {
                indicator.classList.add('show', 'saved');
                indicatorText.textContent = 'Sauvegard√©';
                
                // Masquer apr√®s 2 secondes
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        // Sauvegarder la session (donn√©es Excel + historique chat)
        function saveSession() {
            try {
                // Afficher l'indicateur "En cours de sauvegarde..."
                showSaveIndicator('saving');
                
                const sessionData = {
                    excelData: excelData,
                    excelColumns: excelColumns,
                    currentFileName: currentFileName,
                    chatHistory: chatHistory,
                    actionHistory: actionHistory,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };

                localStorage.setItem(getSaveKey(), JSON.stringify(sessionData));
                console.log('‚úÖ Session sauvegard√©e automatiquement');
                
                // Afficher l'indicateur "Sauvegard√©"
                showSaveIndicator('saved');
                
                return true;
            } catch (error) {
                console.error('‚ùå Erreur lors de la sauvegarde:', error);
                return false;
            }
        }

        // Charger la session sauvegard√©e
        function loadSession() {
            try {
                const savedData = localStorage.getItem(getSaveKey());
                if (!savedData) {
                    console.log('‚ÑπÔ∏è Aucune session sauvegard√©e trouv√©e');
                    return false;
                }

                const sessionData = JSON.parse(savedData);
                
                // V√©rifier que les donn√©es sont valides
                if (!sessionData.version || !sessionData.timestamp) {
                    console.log('‚ö†Ô∏è Format de session invalide');
                    return false;
                }

                // Restaurer les donn√©es
                excelData = sessionData.excelData || [];
                excelColumns = sessionData.excelColumns || [];
                currentFileName = sessionData.currentFileName || '';
                chatHistory = sessionData.chatHistory || [];
                actionHistory = sessionData.actionHistory || [];

                // Afficher les donn√©es si elles existent
                if (excelData.length > 0 && excelColumns.length > 0) {
                    document.getElementById('fileName').textContent = currentFileName;
                    displayExcelData();
                    document.getElementById('exportBtn').style.display = 'flex';
                }

                // Restaurer l'historique du chat
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = ''; // Vider le chat
                
                if (chatHistory.length > 0) {
                    chatHistory.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${msg.type}`;
                        messageDiv.innerHTML = msg.message;
                        chatMessages.appendChild(messageDiv);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    // Message de bienvenue par d√©faut
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'chat-message bot';
                    welcomeDiv.textContent = 'üëã Bonjour ! Je suis Agent Xcel, votre assistant Excel AI. Importez un fichier pour commencer ou posez-moi une question sur Excel.';
                    chatMessages.appendChild(welcomeDiv);
                }

                // Restaurer l'historique des actions
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                if (actionHistory.length > 0) {
                    actionHistory.forEach(action => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        historyItem.textContent = action;
                        historyList.appendChild(historyItem);
                    });
                } else {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'history-item';
                    emptyItem.textContent = 'Aucune action pour le moment';
                    historyList.appendChild(emptyItem);
                }

                console.log('‚úÖ Session restaur√©e avec succ√®s');
                
                // Ajouter un message informatif dans le chat
                const restoreMsg = document.createElement('div');
                restoreMsg.className = 'chat-message bot';
                restoreMsg.innerHTML = `üíæ <strong>Session restaur√©e</strong><br>Vos donn√©es et conversations pr√©c√©dentes ont √©t√© r√©cup√©r√©es.`;
                chatMessages.appendChild(restoreMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                return true;
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement de la session:', error);
                return false;
            }
        }

        // Effacer la session (nouvelle session)
        function clearSession() {
            if (confirm('‚ö†Ô∏è Voulez-vous vraiment commencer une nouvelle session ?\n\nCela effacera :\n- Les donn√©es Excel actuelles\n- L\'historique du chat\n- L\'historique des actions\n\nCette action est irr√©versible.')) {
                try {
                    // Supprimer la sauvegarde
                    localStorage.removeItem(getSaveKey());
                    
                    // R√©initialiser toutes les variables
                    excelData = [];
                    excelColumns = [];
                    currentFileName = '';
                    chatHistory = [];
                    actionHistory = [];
                    
                    // R√©initialiser l'interface
                    document.getElementById('fileName').textContent = 'Aucun fichier';
                    document.getElementById('uploadZone').style.display = 'flex';
                    document.getElementById('tableContainer').style.display = 'none';
                    document.getElementById('exportBtn').style.display = 'none';
                    
                    // R√©initialiser le chat
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'chat-message bot';
                    welcomeDiv.textContent = 'üëã Bonjour ! Je suis Agent Xcel, votre assistant Excel AI. Importez un fichier pour commencer ou posez-moi une question sur Excel.';
                    chatMessages.appendChild(welcomeDiv);
                    
                    // R√©initialiser l'historique
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = '';
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'history-item';
                    emptyItem.textContent = 'Aucune action pour le moment';
                    historyList.appendChild(emptyItem);
                    
                    console.log('‚úÖ Session effac√©e avec succ√®s');
                    addChatMessage('‚ú® <strong>Nouvelle session d√©marr√©e</strong><br>Toutes les donn√©es pr√©c√©dentes ont √©t√© effac√©es.', 'bot');
                } catch (error) {
                    console.error('‚ùå Erreur lors de l\'effacement de la session:', error);
                    alert('Erreur lors de l\'effacement de la session: ' + error.message);
                }
            }
        }

        // Sauvegarder automatiquement avant de quitter la page
        window.addEventListener('beforeunload', function(e) {
            // Sauvegarder uniquement s'il y a des donn√©es √† sauvegarder
            if (excelData.length > 0 || chatHistory.length > 0 || actionHistory.length > 0) {
                saveSession();
                // Vos modifications sont enregistr√©es avec succ√®s et vous pouvez quitter
                // Pas de notification - la sauvegarde est automatique
            }
        });

        // Sauvegarde automatique p√©riodique (toutes les 30 secondes)
        setInterval(function() {
            if (excelData.length > 0 || chatHistory.length > 0) {
                saveSession();
            }
        }, 30000); // 30 secondes

        // Charger la session au d√©marrage
        window.addEventListener('DOMContentLoaded', function() {
            loadSession();
        });

        // ==================================================
        // FIN DE LA SAUVEGARDE AUTOMATIQUE
        // ==================================================

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            currentFileName = file.name;
            document.getElementById('fileName').textContent = currentFileName;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                    if (jsonData.length > 0) {
                        // Nettoyer les noms de colonnes (trim espaces et caract√®res invisibles)
                        excelColumns = jsonData[0].map(col => String(col || '').trim());
                        
                        // Nettoyer aussi les donn√©es (trim chaque cellule)
                        excelData = jsonData.slice(1).map(row => 
                            row.map(cell => {
                                if (typeof cell === 'string') {
                                    return cell.trim();
                                }
                                return cell;
                            })
                        );
                        
                        console.log('üìã Colonnes nettoy√©es:', excelColumns);
                        console.log('üìä Aper√ßu donn√©es (premi√®re ligne):', excelData[0]);
                        
                        displayExcelData();
                        addChatMessage('‚úÖ Fichier charg√© avec succ√®s ! ' + excelData.length + ' lignes et ' + excelColumns.length + ' colonnes d√©tect√©es.', 'bot');
                        addHistory('Importation: ' + currentFileName);
                        document.getElementById('exportBtn').style.display = 'flex';
                        
                        // Sauvegarder automatiquement apr√®s l'import
                        saveSession();
                    }
                } catch (error) {
                    addChatMessage('‚ùå Erreur lors du chargement du fichier: ' + error.message, 'bot');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Display Excel data
        function displayExcelData() {
            const uploadZone = document.getElementById('uploadZone');
            const tableContainer = document.getElementById('tableContainer');
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');

            uploadZone.style.display = 'none';
            tableContainer.style.display = 'block';

            // Create header
            let headerHTML = '<tr>';
            excelColumns.forEach(col => {
                headerHTML += `<th>${col}</th>`;
            });
            headerHTML += '</tr>';
            tableHead.innerHTML = headerHTML;

            // S√©parer les lignes normales des lignes de totaux
            const normalRows = [];
            const summaryRows = [];
            
            excelData.forEach(row => {
                const firstCell = String(row[0] || '').toUpperCase().trim();
                // D√©tecter les lignes de totaux/r√©sum√©s
                const summaryKeywords = ['TOTAL', 'MOYENNE', 'SOMME', 'AVERAGE', 'SUM', 'AVG'];
                const isSummaryRow = summaryKeywords.some(keyword => firstCell.includes(keyword));
                
                if (isSummaryRow) {
                    summaryRows.push(row);
                } else {
                    normalRows.push(row);
                }
            });

            // Create rows normales (max 100)
            let bodyHTML = '';
            normalRows.slice(0, 100).forEach((row, rowIndex) => {
                bodyHTML += '<tr>';
                excelColumns.forEach((col, colIndex) => {
                    const cellValue = row[colIndex] || '';
                    bodyHTML += `<td contenteditable="true" data-row="${rowIndex}" data-col="${colIndex}" class="editable-cell">${cellValue}</td>`;
                });
                bodyHTML += '</tr>';
            });
            
            // Ajouter les lignes de totaux √† la fin avec style sp√©cial
            if (summaryRows.length > 0) {
                summaryRows.forEach(row => {
                    bodyHTML += '<tr style="background-color: #e3f2fd; font-weight: bold; border-top: 2px solid #1976d2;">';
                    excelColumns.forEach((col, idx) => {
                        const cellValue = row[idx] || '';
                        // Formater les nombres avec 2 d√©cimales
                        const displayValue = typeof cellValue === 'number' ? cellValue.toFixed(2) : cellValue;
                        bodyHTML += `<td contenteditable="false">${displayValue}</td>`;
                    });
                    bodyHTML += '</tr>';
                });
                console.log(`üìä ${summaryRows.length} ligne(s) de totaux affich√©e(s)`);
            }
            
            tableBody.innerHTML = bodyHTML;
            
            // Ajouter les √©v√©nements pour l'√©dition des cellules
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('blur', function() {
                    const rowIndex = parseInt(this.dataset.row);
                    const colIndex = parseInt(this.dataset.col);
                    const newValue = this.textContent.trim();
                    
                    // Mettre √† jour excelData
                    if (excelData[rowIndex] && excelData[rowIndex][colIndex] !== undefined) {
                        excelData[rowIndex][colIndex] = newValue;
                        console.log(`‚úèÔ∏è Cellule modifi√©e: ligne ${rowIndex}, colonne ${colIndex}, nouvelle valeur: "${newValue}"`);
                        
                        // Sauvegarder automatiquement
                        saveSession();
                    }
                });
                
                // S√©lectionner tout le texte au focus
                cell.addEventListener('focus', function() {
                    const range = document.createRange();
                    range.selectNodeContents(this);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });
            });
        }

        // ==================================================
        // NETTOYAGE DONN√âES - ACTION DIRECTE
        // ==================================================

        // Nettoyer les donn√©es (supprime doublons et cellules vides)
        function cleanData() {
            console.log('üßπ cleanData() appel√©e');
            console.log('üìä excelData avant nettoyage:', excelData.length, 'lignes');
            
            if (excelData.length === 0) {
                addChatMessage('‚ö†Ô∏è Aucune donn√©e √† nettoyer.', 'bot');
                return;
            }

            const initialRowCount = excelData.length;
            let removedDuplicates = 0;
            let removedEmptyRows = 0;

            // 1. Supprimer les lignes compl√®tement vides
            const filteredData = excelData.filter(row => {
                const isEmpty = row.every(cell => cell === '' || cell === null || cell === undefined);
                if (isEmpty) removedEmptyRows++;
                return !isEmpty;
            });
            
            console.log('üìä Apr√®s suppression lignes vides:', filteredData.length, 'lignes');

            // 2. Supprimer les doublons (lignes identiques)
            const uniqueRows = [];
            const seen = new Set();
            
            filteredData.forEach(row => {
                const rowKey = row.join('|||'); // Cr√©er une cl√© unique pour la ligne
                if (!seen.has(rowKey)) {
                    seen.add(rowKey);
                    uniqueRows.push(row);
                } else {
                    removedDuplicates++;
                }
            });
            
            console.log('üìä Apr√®s suppression doublons:', uniqueRows.length, 'lignes');
            
            // Mettre √† jour excelData
            excelData.length = 0; // Vider le tableau
            excelData.push(...uniqueRows); // Ajouter les lignes nettoy√©es
            
            console.log('üìä excelData apr√®s nettoyage:', excelData.length, 'lignes');

            // Mettre √† jour l'affichage du tableau
            displayExcelData();
            
            // Sauvegarder la session avec les donn√©es nettoy√©es
            saveSession();
            
            console.log('‚úÖ Nettoyage termin√© et sauvegard√©');

            // Message de confirmation d√©taill√©
            let message = `‚úÖ **Nettoyage termin√© !**\n\n`;
            message += `üìä **R√©sultats :**\n`;
            message += `- Lignes initiales : **${initialRowCount}**\n`;
            message += `- Lignes vides supprim√©es : **${removedEmptyRows}**\n`;
            message += `- Doublons supprim√©s : **${removedDuplicates}**\n`;
            message += `- Lignes finales : **${excelData.length}**\n\n`;
            message += `üí° **Besoin d'aide ?**\n`;
            message += `Je suis votre Expert Excel AI ! Vous pouvez :\n`;
            message += `- üìù **Me parler dans le chat** pour toute question ou aide\n`;
            message += `- üéØ **Utiliser les actions rapides** ci-dessus pour analyser, cr√©er des formules, KPI, graphiques, etc.\n`;
            message += `- üì• **T√©l√©charger le fichier nettoy√©** avec le bouton Exporter\n\n`;
            message += `Que souhaitez-vous faire maintenant ? üòä`;

            addChatMessage(message, 'bot');
            addHistory(`Nettoyage: ${removedEmptyRows} vides, ${removedDuplicates} doublons supprim√©s`);
        }

        // ==================================================
        // COMMANDES JSON - MODIFICATION EXCEL PAR L'AI
        // ==================================================

        // Parser et ex√©cuter les commandes JSON de l'AI
        function parseAndExecuteJSONCommands(aiResponse) {
            try {
                console.log('üîç Recherche de commandes JSON dans la r√©ponse AI...');
                console.log('R√©ponse compl√®te:', aiResponse);
                
                // Chercher les blocs ```json...```
                const jsonRegex = /```json\s*\n([\s\S]*?)\n```/g;
                let match;
                let commandsExecuted = 0;
                
                while ((match = jsonRegex.exec(aiResponse)) !== null) {
                    try {
                        const jsonText = match[1].trim();
                        console.log('üìã JSON trouv√©:', jsonText);
                        
                        const commands = JSON.parse(jsonText);
                        console.log('‚úÖ JSON pars√©:', commands);
                        
                        // Support tableau ou objet unique
                        const cmdArray = Array.isArray(commands) ? commands : [commands];
                        
                        for (const cmd of cmdArray) {
                            console.log('üîß Ex√©cution commande:', cmd);
                            if (executeJSONCommand(cmd)) {
                                commandsExecuted++;
                            }
                        }
                    } catch (parseError) {
                        console.error('‚ùå Erreur parsing JSON:', parseError);
                        console.error('JSON probl√©matique:', match[1]);
                    }
                }
                
                if (commandsExecuted > 0) {
                    displayExcelData(); // Rafra√Æchir l'affichage
                    saveSession(); // Sauvegarder les modifications
                    addChatMessage(`‚úÖ ${commandsExecuted} modification(s) appliqu√©e(s) avec succ√®s !`, 'bot');
                    addHistory(`Modifications: ${commandsExecuted} action(s) ex√©cut√©e(s)`);
                    return true;
                }
                
                console.log('‚ÑπÔ∏è Aucune commande JSON trouv√©e dans la r√©ponse');
                return false;
            } catch (error) {
                console.error('‚ùå Erreur ex√©cution commandes:', error);
                return false;
            }
        }

        // Router principal pour ex√©cuter une commande
        function executeJSONCommand(cmd) {
            if (!cmd || !cmd.action) {
                console.warn('‚ö†Ô∏è Commande invalide:', cmd);
                return false;
            }
            
            console.log('üîß Ex√©cution commande:', cmd);
            
            switch(cmd.action) {
                case 'addColumn':
                    return executeAddColumn(cmd);
                case 'calculateColumn':
                    return executeCalculateColumn(cmd);
                case 'addRow':
                    return executeAddRow(cmd);
                case 'addSummaryRow':
                    return executeAddSummaryRow(cmd);
                case 'deleteColumn':
                    return executeDeleteColumn(cmd);
                case 'deleteRow':
                    return executeDeleteRow(cmd);
                case 'updateCell':
                    return executeUpdateCell(cmd);
                case 'renameColumn':
                    return executeRenameColumn(cmd);
                case 'sortData':
                    return executeSortData(cmd);
                default:
                    console.warn('‚ö†Ô∏è Action inconnue:', cmd.action);
                    return false;
            }
        }

        // 1. Ajouter une colonne vide
        function executeAddColumn(cmd) {
            const { name, defaultValue = '' } = cmd;
            if (!name) return false;
            
            excelColumns.push(name);
            excelData.forEach(row => {
                row.push(defaultValue);
            });
            
            console.log(`‚úÖ Colonne "${name}" ajout√©e`);
            return true;
        }

        // ==================================================
        // SAFE FORMULA EVALUATOR - No eval, handles accents
        // ==================================================
        
        function safeEvaluate(expression, row, options = {}) {
            const config = {
                aliases: options.aliases || {},
                onMissing: options.onMissing || 'zero',
                trim: options.trim !== false,
                normalizeAccents: options.normalizeAccents !== false,
            };

            try {
                const expr = config.trim ? String(expression || '').trim() : String(expression || '');
                if (!expr) return { ok: false, error: 'Empty expression' };

                const tokens = tokenizeArithmetic(expr);
                if (!tokens.ok) return tokens;

                const idents = tokens.tokens.filter(t => t.type === 'ident').map(t => t.value);

                const banned = new Set([
                    'globalThis','window','self','global','Function','eval','constructor','__proto__',
                    'prototype','Object','Array','Map','Set','WeakMap','WeakSet','Proxy','Reflect',
                    'Intl','JSON','Date','RegExp','Error','Math','document','console','process','require',
                ]);
                for (const name of idents) {
                    if (banned.has(name)) {
                        return { ok: false, error: `Usage of identifier "${name}" is not allowed in formulas.` };
                    }
                }

                const context = Object.create(null);
                const missing = [];

                const rowKeyByNormalized = new Map();
                for (const k of Object.keys(row || {})) {
                    rowKeyByNormalized.set(normalizeKey(k, config.normalizeAccents), k);
                }

                for (const ident of new Set(idents)) {
                    const actualKey = resolveKey(ident, config.aliases, rowKeyByNormalized, config.normalizeAccents);

                    let value;
                    if (actualKey in (row || {})) {
                        value = coerceToNumber(row[actualKey]);
                        
                        // Si coerceToNumber retourne NaN, traiter comme valeur manquante
                        if (isNaN(value)) {
                            if (typeof config.onMissing === 'function') {
                                value = coerceToNumber(config.onMissing(ident));
                            } else if (config.onMissing === 'zero') {
                                value = 0;
                            } else if (config.onMissing === 'null') {
                                value = null;
                            } else if (config.onMissing === 'skip') {
                                return { ok: false, skip: true, error: `Invalid value for "${ident}"` };
                            } else {
                                value = 0; // Par d√©faut, utiliser 0
                            }
                        }
                    } else {
                        if (typeof config.onMissing === 'function') {
                            value = coerceToNumber(config.onMissing(ident));
                        } else if (config.onMissing === 'zero') {
                            value = 0;
                        } else if (config.onMissing === 'null') {
                            value = null;
                        } else if (config.onMissing === 'skip') {
                            return { ok: false, skip: true, error: `Missing "${ident}"` };
                        } else {
                            missing.push(ident);
                            continue;
                        }
                    }

                    if (value !== null && !Number.isFinite(value)) {
                        return { ok: false, error: `Value for "${ident}" is not a finite number.` };
                    }

                    context[ident] = value;
                }

                if (missing.length) {
                    return { ok: false, error: `Missing variables: ${missing.join(', ')}`, missing };
                }

                const paramNames = Object.keys(context);
                const paramValues = paramNames.map(n => context[n]);

                const safeExpr = tokens.tokens.map(t => t.value).join('');
                const fn = new Function(...paramNames, '"use strict"; return (' + safeExpr + ');');
                const result = fn(...paramValues);

                if (typeof result === 'number' && !Number.isFinite(result)) {
                    return { ok: false, error: 'Result is not a finite number.' };
                }

                return { ok: true, value: result };
            } catch (err) {
                return { ok: false, error: String(err && err.message ? err.message : err) };
            }

            function normalizeKey(key, foldAccents = true) {
                let s = String(key);
                if (foldAccents && s.normalize) {
                    s = s.normalize('NFD').replace(/\p{M}+/gu, '');
                }
                return s.toLowerCase().replace(/\s+/g, '');
            }

            function resolveKey(ident, aliases, rowKeyByNorm, foldAccents) {
                if (ident in aliases) return aliases[ident];
                const exact = rowKeyByNorm.get(normalizeKey(ident, foldAccents));
                if (exact) return exact;
                for (const [from, to] of Object.entries(aliases)) {
                    if (normalizeKey(from, foldAccents) === normalizeKey(ident, foldAccents)) {
                        return to;
                    }
                }
                return ident;
            }

            function coerceToNumber(v) {
                if (v === null || v === undefined || v === '') return NaN;
                if (typeof v === 'number') return v;
                if (typeof v === 'boolean') return v ? 1 : 0;

                let s = String(v).trim();
                s = s.replace(/[\u00A0\u202F]/g, ' ').replace(/\s+/g, '');
                const commaDec = /^-?\d{1,3}(\.\d{3})*,\d+$/.test(s) || /,\d+$/.test(s);
                if (commaDec) s = s.replace(/\./g, '').replace(',', '.');

                const num = Number(s);
                return num;
            }

            function tokenizeArithmetic(input) {
                const tokens = [];
                let i = 0;

                const isDigit = (c) => c >= '0' && c <= '9';
                const isWS = (ch) => /\s/.test(ch);

                const identStart = (ch) => {
                    if (ch === '$' || ch === '_') return true;
                    if (/[A-Za-z]/.test(ch)) return true;
                    try { return /\p{L}/u.test(ch); } catch { return false; }
                };
                const identContinue = (ch) => {
                    if (identStart(ch)) return true;
                    if (/[0-9]/.test(ch)) return true;
                    return false;
                };

                while (i < input.length) {
                    const ch = input[i];

                    if (isWS(ch)) { i++; continue; }

                    if (isDigit(ch) || (ch === '.' && isDigit(input[i+1] || ''))) {
                        let start = i;
                        if (ch === '.') i++;
                        while (i < input.length && isDigit(input[i])) i++;
                        if (input[i] === '.') {
                            i++;
                            while (i < input.length && isDigit(input[i])) i++;
                        }
                        tokens.push({ type: 'number', value: input.slice(start, i) });
                        continue;
                    }

                    if (identStart(ch)) {
                        let start = i; i++;
                        while (i < input.length && identContinue(input[i])) i++;
                        const name = input.slice(start, i);
                        tokens.push({ type: 'ident', value: name });
                        continue;
                    }

                    if (ch === '+' || ch === '-' || ch === '/' || ch === '%' || ch === '(' || ch === ')') {
                        tokens.push({ type: 'op', value: ch }); i++; continue;
                    }
                    if (ch === '*') {
                        if (input[i+1] === '*') {
                            tokens.push({ type: 'op', value: '**' }); i += 2; continue;
                        } else {
                            tokens.push({ type: 'op', value: '*' }); i++; continue;
                        }
                    }

                    return { ok: false, error: `Illegal character "${ch}" at position ${i}` };
                }

                return { ok: true, tokens };
            }
        }

        // ==================================================
        // FIN DU SAFE EVALUATOR
        // ==================================================

        // 2. Ajouter une colonne avec calcul (version s√©curis√©e)
        function executeCalculateColumn(cmd) {
            const { name, formula } = cmd;
            if (!name || !formula) return false;
            
            console.log('üîß executeCalculateColumn:', { name, formula });
            console.log('üìã Colonnes disponibles:', excelColumns);
            
            excelColumns.push(name);
            
            // Cr√©er un mapping d'alias pour les accents courants
            const aliases = {
                'quantite': 'quantit√©',
                'quantit√©': 'quantit√©',
                'quantity': 'quantit√©',
                'qty': 'quantit√©'
            };
            
            excelData.forEach((row, idx) => {
                // Ignorer les lignes de totaux (qui commencent par TOTAL, MOYENNE, etc.)
                const firstCell = String(row[0] || '').toUpperCase();
                if (firstCell === 'TOTAL' || firstCell === 'MOYENNE' || firstCell === 'SOMME' || firstCell === 'AVERAGE') {
                    console.log(`‚è≠Ô∏è Ligne ${idx} ignor√©e (ligne de totaux)`);
                    row.push(''); // Ajouter une cellule vide au lieu de calculer
                    return;
                }
                
                // Cr√©er un objet row avec les noms de colonnes comme cl√©s
                const rowObj = {};
                excelColumns.forEach((col, colIdx) => {
                    if (colIdx < row.length) {
                        rowObj[col] = row[colIdx];
                    }
                });
                
                console.log(`üìä Ligne ${idx} - Context:`, rowObj);
                console.log(`üìä Ligne ${idx} - Formule: "${formula}"`);
                
                // √âvaluer avec safeEvaluate
                const result = safeEvaluate(formula, rowObj, {
                    aliases: aliases,
                    onMissing: 'zero', // Utiliser 0 pour les variables manquantes
                    normalizeAccents: true
                });
                
                if (!result.ok) {
                    console.error(`‚ùå Erreur ligne ${idx}:`, result.error);
                    row.push('ERROR');
                } else {
                    console.log(`‚úÖ R√©sultat ligne ${idx}: ${result.value}`);
                    row.push(result.value);
                }
            });
            
            console.log(`‚úÖ Colonne calcul√©e "${name}" ajout√©e`);
            return true;
        }

        // 3. Ajouter une ligne
        function executeAddRow(cmd) {
            const { values } = cmd;
            if (!values || !Array.isArray(values)) return false;
            
            // Compl√©ter avec des valeurs vides si n√©cessaire
            const newRow = [...values];
            while (newRow.length < excelColumns.length) {
                newRow.push('');
            }
            
            excelData.push(newRow);
            console.log(`‚úÖ Ligne ajout√©e`);
            return true;
        }

        // 3b. Ajouter une ligne de totaux/agr√©gation
        function executeAddSummaryRow(cmd) {
            const { label = 'TOTAL', columns } = cmd;
            // columns: { columnName: 'SUM' | 'AVG' | 'COUNT' | 'MIN' | 'MAX' | value }
            
            if (!columns || typeof columns !== 'object') {
                console.warn('‚ö†Ô∏è Param√®tre columns manquant');
                return false;
            }
            
            console.log('üéØ executeAddSummaryRow - Colonnes disponibles:', excelColumns);
            console.log('üéØ executeAddSummaryRow - Op√©rations demand√©es:', columns);
            console.log('üéØ executeAddSummaryRow - Donn√©es existantes:', excelData.length, 'lignes');
            console.log('üîç Structure premi√®re ligne:', excelData[0]);
            console.log('üîç Longueur premi√®re ligne:', excelData[0]?.length, 'vs colonnes:', excelColumns.length);
            
            // Filtrer les donn√©es pour EXCLURE les lignes de totaux existantes
            const dataRows = excelData.filter(row => {
                const firstCell = String(row[0] || '').toUpperCase().trim();
                // D√©tecter les lignes de totaux/r√©sum√©s
                const summaryKeywords = ['TOTAL', 'MOYENNE', 'SOMME', 'AVERAGE', 'SUM', 'AVG'];
                const isSummaryRow = summaryKeywords.some(keyword => firstCell.includes(keyword));
                return !isSummaryRow;
            });
            
            console.log(`üìä Lignes de donn√©es (sans totaux): ${dataRows.length} / ${excelData.length}`);
            console.log('üìã Exemple ligne de donn√©es:', dataRows[0]);
            
            const newRow = [];
            
            excelColumns.forEach((colName, colIdx) => {
                console.log(`\nüîç Traitement colonne "${colName}" (index ${colIdx})`);
                console.log(`  üìç Nombre de colonnes dans les donn√©es: ${dataRows[0]?.length || 0}`);
                
                if (colIdx === 0) {
                    // Premi√®re colonne = label
                    console.log(`  ‚Üí Premi√®re colonne, ajout du label: "${label}"`);
                    newRow.push(label);
                } else if (columns[colName]) {
                    const operation = String(columns[colName]).toUpperCase();
                    console.log(`  ‚Üí Op√©ration demand√©e: "${operation}"`);
                    
                    // Liste des op√©rations d'agr√©gation connues
                    const aggregationOps = ['SUM', 'SOMME', 'AVG', 'AVERAGE', 'MOYENNE', 'COUNT', 'COMPTE', 'MIN', 'MINIMUM', 'MAX', 'MAXIMUM'];
                    
                    if (aggregationOps.includes(operation)) {
                        // Op√©ration d'agr√©gation - calculer SUR LES DONN√âES SEULEMENT (pas les totaux)
                        console.log(`  ‚Üí Extraction valeurs de la colonne ${colIdx}...`);
                        const allValues = dataRows.map(row => row[colIdx]);
                        console.log(`  ‚Üí Valeurs brutes:`, allValues);
                        
                        const values = dataRows
                            .map(row => parseFloat(row[colIdx]))
                            .filter(v => !isNaN(v));
                        
                        console.log(`  ‚Üí Valeurs num√©riques filtr√©es:`, values);
                        console.log(`  ‚Üí Nombre de valeurs: ${values.length}`);
                        
                        let result = 0;
                        switch(operation) {
                            case 'SUM':
                            case 'SOMME':
                                result = values.reduce((a, b) => a + b, 0);
                                console.log(`  üí∞ SUM colonne "${colName}": ${result}`);
                                break;
                            case 'AVG':
                            case 'AVERAGE':
                            case 'MOYENNE':
                                result = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                                console.log(`  üìä AVG colonne "${colName}": ${result}`);
                                break;
                            case 'COUNT':
                            case 'COMPTE':
                                result = values.length;
                                console.log(`  üî¢ COUNT colonne "${colName}": ${result}`);
                                break;
                            case 'MIN':
                            case 'MINIMUM':
                                result = values.length > 0 ? Math.min(...values) : 0;
                                console.log(`  ‚¨áÔ∏è MIN colonne "${colName}": ${result}`);
                                break;
                            case 'MAX':
                            case 'MAXIMUM':
                                result = values.length > 0 ? Math.max(...values) : 0;
                                console.log(`  ‚¨ÜÔ∏è MAX colonne "${colName}": ${result}`);
                                break;
                            default:
                                result = 0;
                        }
                        newRow.push(result);
                    } else {
                        // Valeur fixe (nombre ou texte)
                        console.log(`  ‚Üí Valeur fixe ajout√©e: "${columns[colName]}"`);
                        newRow.push(columns[colName]);
                    }
                } else {
                    // Pas d'op√©ration d√©finie pour cette colonne
                    console.log(`  ‚Üí Pas d'op√©ration pour cette colonne, cellule vide`);
                    newRow.push('');
                }
            });
            
            console.log('\nüìã Ligne de total cr√©√©e:', newRow);
            excelData.push(newRow);
            console.log('‚úÖ Ligne de total ajout√©e au tableau');
            console.log('üìä Nombre total de lignes maintenant:', excelData.length);
            
            return true;
        }

        // 4. Supprimer une colonne
        function executeDeleteColumn(cmd) {
            const { name, index } = cmd;
            
            let colIndex = -1;
            if (typeof index === 'number') {
                colIndex = index;
            } else if (name) {
                colIndex = excelColumns.indexOf(name);
            }
            
            if (colIndex === -1 || colIndex >= excelColumns.length) {
                console.warn('‚ö†Ô∏è Colonne introuvable');
                return false;
            }
            
            excelColumns.splice(colIndex, 1);
            excelData.forEach(row => {
                row.splice(colIndex, 1);
            });
            
            console.log(`‚úÖ Colonne ${colIndex} supprim√©e`);
            return true;
        }

        // 5. Supprimer une ligne
        function executeDeleteRow(cmd) {
            const { index } = cmd;
            if (typeof index !== 'number' || index < 0 || index >= excelData.length) {
                console.warn('‚ö†Ô∏è Index de ligne invalide');
                return false;
            }
            
            excelData.splice(index, 1);
            console.log(`‚úÖ Ligne ${index} supprim√©e`);
            return true;
        }

        // 6. Modifier une cellule
        function executeUpdateCell(cmd) {
            const { row, column, columnName, value } = cmd;
            
            if (typeof row !== 'number' || row < 0 || row >= excelData.length) {
                console.warn('‚ö†Ô∏è Index de ligne invalide');
                return false;
            }
            
            let colIndex = -1;
            if (typeof column === 'number') {
                colIndex = column;
            } else if (columnName) {
                colIndex = excelColumns.indexOf(columnName);
            }
            
            if (colIndex === -1 || colIndex >= excelColumns.length) {
                console.warn('‚ö†Ô∏è Colonne introuvable');
                return false;
            }
            
            excelData[row][colIndex] = value;
            console.log(`‚úÖ Cellule [${row}, ${colIndex}] modifi√©e`);
            return true;
        }

        // 7. Renommer une colonne
        function executeRenameColumn(cmd) {
            const { oldName, newName } = cmd;
            if (!oldName || !newName) return false;
            
            const colIndex = excelColumns.indexOf(oldName);
            if (colIndex === -1) {
                console.warn('‚ö†Ô∏è Colonne introuvable:', oldName);
                return false;
            }
            
            excelColumns[colIndex] = newName;
            console.log(`‚úÖ Colonne "${oldName}" renomm√©e en "${newName}"`);
            return true;
        }

        // 8. Trier les donn√©es
        function executeSortData(cmd) {
            const { columnName, order = 'asc' } = cmd;
            if (!columnName) return false;
            
            const colIndex = excelColumns.indexOf(columnName);
            if (colIndex === -1) {
                console.warn('‚ö†Ô∏è Colonne introuvable:', columnName);
                return false;
            }
            
            excelData.sort((a, b) => {
                let valA = a[colIndex];
                let valB = b[colIndex];
                
                // Essayer de convertir en nombre
                const numA = parseFloat(valA);
                const numB = parseFloat(valB);
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    // Tri num√©rique
                    return order === 'asc' ? numA - numB : numB - numA;
                } else {
                    // Tri alphab√©tique
                    const strA = String(valA).toLowerCase();
                    const strB = String(valB).toLowerCase();
                    if (order === 'asc') {
                        return strA < strB ? -1 : strA > strB ? 1 : 0;
                    } else {
                        return strA > strB ? -1 : strA < strB ? 1 : 0;
                    }
                }
            });
            
            console.log(`‚úÖ Donn√©es tri√©es par "${columnName}" (${order})`);
            return true;
        }

        // Nettoyer la r√©ponse AI (enlever les blocs JSON)
        function cleanAIResponse(aiResponse) {
            return aiResponse.replace(/```json\s*\n[\s\S]*?\n```/g, '').trim();
        }

        // ==================================================
        // FIN DES COMMANDES JSON
        // ==================================================

        // Chat functions
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            // üÜï Utiliser le message d√©taill√© pour l'IA si disponible
            const aiMessage = window.pendingAiMessage || message;
            delete window.pendingAiMessage; // Nettoyer apr√®s utilisation

            // Ajouter un indicateur de chargement
            const loadingMsg = addChatMessage('‚è≥ Traitement en cours...', 'bot');

            // Retry logic avec timeout
            let lastError = null;
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    // Construire le contexte Excel
                    const excelContext = excelData.length > 0 ? `
Contexte Excel actuel :
- Fichier : ${currentFileName}
- Nombre de lignes : ${excelData.length}
- Colonnes : ${excelColumns.join(', ')}
- Aper√ßu des donn√©es : ${JSON.stringify(excelData)}

Tu es Agent Xcel, expert Excel AI. Tu peux modifier directement les fichiers Excel en g√©n√©rant des commandes JSON.

COMMANDES JSON DISPONIBLES :
1. Ajouter colonne : {"action":"addColumn","name":"NomColonne","defaultValue":""}
2. Colonne calcul√©e : {"action":"calculateColumn","name":"Total","formula":"Prix * Quantite"}
3. Ajouter ligne : {"action":"addRow","values":["val1","val2","val3"]}
3b. Ligne de totaux : {"action":"addSummaryRow","label":"TOTAL","columns":{"Total":"SUM","Prix":"AVG"}}
4. Supprimer colonne : {"action":"deleteColumn","name":"NomColonne"}
5. Supprimer ligne : {"action":"deleteRow","index":0}
6. Modifier cellule : {"action":"updateCell","row":0,"columnName":"Prix","value":"150"}
7. Renommer colonne : {"action":"renameColumn","oldName":"Ancien","newName":"Nouveau"}
8. Trier donn√©es : {"action":"sortData","columnName":"Prix","order":"desc"}

OP√âRATIONS DE TOTAUX (addSummaryRow) :
- SUM/SOMME : somme de la colonne
- AVG/MOYENNE : moyenne des valeurs
- COUNT/COMPTE : nombre de valeurs
- MIN/MINIMUM : valeur minimale
- MAX/MAXIMUM : valeur maximale

R√àGLES :
- Utilise les NOMS EXACTS des colonnes (respecte la casse)
- Pour les formules, utilise les noms de colonnes comme variables
- Explique toujours ce que tu vas faire AVANT le JSON
- Mets le JSON dans un bloc \`\`\`json ... \`\`\`
- Tu peux combiner plusieurs commandes dans un tableau : [cmd1, cmd2]

EXEMPLE :
User: "Ajoute une colonne Remise qui calcule 10% du Prix"
Tu r√©ponds:
"Je vais ajouter une colonne Remise calculant 10% du prix.

\`\`\`json
{"action":"calculateColumn","name":"Remise","formula":"Prix * 0.1"}
\`\`\`

La colonne Remise a √©t√© ajout√©e avec succ√®s !"
` : `Tu es Agent Xcel, expert Excel AI. Aide l'utilisateur avec Excel : formules, analyses, Power Query, tableaux crois√©s dynamiques, etc.`;

                    // Convertir l'historique au format backend
                    const historyForBackend = chatHistory.slice(0, -2).map(msg => ({
                        type: msg.type === 'bot' ? 'bot' : 'user',
                        content: msg.message
                    }));

                    // Timeout de 30 secondes
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);

                    const response = await fetch('/api/invoke-v2', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message: excelContext + "\n\nQuestion: " + aiMessage,
                            conversationId: 'excel-ai-expert',
                            chatType: 'excel-expert',
                            history: historyForBackend
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur ${response.status}: ${errorText}`);
                    }

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    let aiResponse = data.response || data.message || 'D√©sol√©, je n\'ai pas pu traiter votre demande.';

                    // Clean metrics
                    aiResponse = aiResponse
                        .replace(/(^|\n)\s*---\s*\n(?=\s*(üìä|üìö|üí°|Sources\s*:))[\s\S]*$/m, '')
                        .replace(/\n*üìä.*?M√©triques.*?\n.*?HI:.*?CHR:.*?\n*/gi, '')
                        .replace(/\n*üìö.*?Sources:.*?\n*/gi, '')
                        .replace(/\n*üí°.*?Plan.*?tokens.*?\n*/gi, '')
                        .trim();

                    // Supprimer le message de chargement
                    loadingMsg.remove();
                    chatHistory.pop(); // Retirer du historique aussi

                    // üÜï Parser et ex√©cuter les commandes JSON SEULEMENT pour actions 'write'
                    // Pour actions 'readonly' (analyze, formulas, kpi, etc.) : pas d'ex√©cution
                    const isReadOnlyAction = window.currentActionType === 'readonly';
                    const commandExecuted = isReadOnlyAction ? false : parseAndExecuteJSONCommands(aiResponse);
                    
                    // üÜï R√©initialiser le flag d'action
                    delete window.currentActionType;
                    
                    // Si demande de modification mais pas de JSON, ajouter un hint
                    if (!commandExecuted && excelData.length > 0 && !isReadOnlyAction) {
                        const modificationKeywords = /ajoute|calcul|supprime|modifi|tri|rename|total|somme|moyenne/i;
                        if (modificationKeywords.test(message)) {
                            console.warn('‚ö†Ô∏è Demande de modification d√©tect√©e mais pas de JSON g√©n√©r√© par l\'AI');
                            addChatMessage('üí° <strong>Note</strong>: Pour que je puisse modifier directement votre fichier, demandez-moi par exemple: "Calcule le total en multipliant prix par quantit√©" ou "Ajoute une colonne Total"', 'bot');
                        }
                    }
                    
                    // Afficher la r√©ponse nettoy√©e (sans les blocs JSON)
                    const cleanResponse = commandExecuted ? cleanAIResponse(aiResponse) : aiResponse;
                    if (cleanResponse) {
                        addChatMessage(cleanResponse, 'bot');
                    }
                    
                    sendBtn.disabled = false;
                    return; // Succ√®s, sortie

                } catch (error) {
                    lastError = error;
                    console.error(`Tentative ${attempt}/3 √©chou√©e:`, error);
                    
                    if (error.name === 'AbortError') {
                        console.log('‚è±Ô∏è Timeout - retry...');
                        loadingMsg.innerHTML = `‚è≥ Timeout... Tentative ${attempt + 1}/3`;
                    } else {
                        loadingMsg.innerHTML = `‚è≥ Retry ${attempt}/3...`;
                    }
                    
                    // Retry avec d√©lai exponentiel
                    if (attempt < 3) {
                        const delay = Math.pow(2, attempt) * 1000; // 2s, 4s
                        console.log(`‚è≥ Nouvelle tentative dans ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                }
            }

            // Toutes les tentatives ont √©chou√©
            console.error('‚ùå √âchec apr√®s 3 tentatives:', lastError);
            const errorMessage = lastError?.message || 'Erreur inconnue';
            
            // Supprimer le message de chargement
            loadingMsg.remove();
            chatHistory.pop();
            
            addChatMessage(
                `‚ö†Ô∏è Impossible de se connecter au serveur.\n\n**Raison:** ${errorMessage}\n\n**Que faire:**\n- V√©rifiez votre connexion internet\n- R√©essayez dans quelques instants\n- Si le probl√®me persiste, contactez le support`,
                'bot'
            );
            sendBtn.disabled = false;
        }

        function addChatMessage(message, type) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            messageDiv.innerHTML = message;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            chatHistory.push({type, message, timestamp: new Date()});
            
            // Sauvegarder automatiquement apr√®s chaque message
            saveSession();
            
            return messageDiv; // Retourner l'√©l√©ment pour pouvoir le modifier
        }

        // Quick actions
        function quickAction(action) {
            // Action 'clean' g√®re sa propre v√©rification de donn√©es
            if (action !== 'clean' && excelData.length === 0) {
                addChatMessage('‚ö†Ô∏è Veuillez d\'abord importer un fichier Excel.', 'bot');
                return;
            }

            // üÜï Classification des actions (readonly = pas de modification du fichier)
            const READONLY_ACTIONS = ['analyze', 'formulas', 'kpi', 'chart', 'duplicate', 'pivot'];
            const isReadOnly = READONLY_ACTIONS.includes(action);
            window.currentActionType = isReadOnly ? 'readonly' : 'write';

            let userMessage = ''; // Message court affich√© √† l'utilisateur
            let aiMessage = ''; // Message d√©taill√© envoy√© √† l'IA
            
            switch(action) {
                case 'clean':
                    // Action directe : nettoyer sans passer par l'agent
                    cleanData();
                    return; // Ne pas continuer vers sendMessage()
                case 'analyze':
                    userMessage = 'Analyse mon fichier Excel';
                    aiMessage = 'Fais une analyse DESCRIPTIVE UNIQUEMENT de mon fichier Excel : nombre de lignes, nombre de colonnes, noms des colonnes, types de donn√©es, aper√ßu des valeurs. NE FAIS AUCUN CALCUL (pas de somme, moyenne, total). D√©cris seulement ce qui existe dans le fichier pour que je comprenne sa structure.';
                    break;
                case 'formulas':
                    userMessage = 'Sugg√®re-moi des formules utiles';
                    aiMessage = 'Sugg√®re-moi des FORMULES EXCEL utiles (format =...) pour mes donn√©es. Explique comment cr√©er des formules dans Excel (comme =A1*B1, =SOMME(A1:A10), =MOYENNE(), etc.). NE calcule RIEN, NE modifie RIEN, sugg√®re SEULEMENT les formules que je peux √©crire manuellement dans Excel. Donne des exemples concrets avec les noms de mes colonnes et explique √† quoi sert chaque formule.';
                    break;
                case 'kpi':
                    userMessage = 'Sugg√®re des KPI pertinents';
                    aiMessage = 'Sugg√®re-moi des KPI (Indicateurs Cl√©s de Performance) pertinents pour mes donn√©es. Explique quels KPI seraient utiles √† suivre et COMMENT les calculer avec des formules Excel. NE calcule RIEN, NE modifie RIEN. Sugg√®re seulement les KPI √† cr√©er et les formules Excel correspondantes. Par exemple : "Chiffre d\'affaires total : =SOMME(Prix*Quantit√©)", "Valeur moyenne : =MOYENNE(Prix)", etc. Sois p√©dagogique et concret.';
                    break;
                case 'duplicate':
                    userMessage = 'D√©tecte les doublons dans mes donn√©es';
                    aiMessage = 'D√©tecte et LISTE les doublons dans mes donn√©es. Identifie quelles lignes sont dupliqu√©es, sur quelles colonnes (si plusieurs produits identiques, prix identiques, etc.). Explique COMMENT trouver et g√©rer les doublons dans Excel (Donn√©es > Supprimer les doublons, ou filtre avanc√©, ou mise en forme conditionnelle). NE supprime RIEN automatiquement, NE modifie RIEN. Donne seulement la liste des doublons trouv√©s et les instructions pour que je les g√®re manuellement.';
                    break;
                case 'pivot':
                    userMessage = 'Sugg√®re un tableau crois√© dynamique';
                    aiMessage = 'Sugg√®re-moi comment cr√©er un TABLEAU CROIS√â DYNAMIQUE adapt√© √† mes donn√©es. Explique quelles colonnes utiliser en lignes, colonnes, valeurs et filtres. Donne des instructions √©tape par √©tape pour cr√©er le tableau dans Excel (Insertion > Tableau crois√© dynamique). Explique pourquoi cette organisation est pertinente et quels insights on peut obtenir. NE cr√©e AUCUN tableau automatiquement, NE modifie RIEN. Sugg√®re seulement comment le cr√©er manuellement dans Excel avec des explications p√©dagogiques.';
                    break;
                case 'chart':
                    userMessage = 'Sugg√®re des graphiques adapt√©s';
                    aiMessage = 'Sugg√®re-moi des GRAPHIQUES adapt√©s √† mes donn√©es. Explique quels types de graphiques seraient pertinents (histogrammes, courbes, camemberts, nuages de points, etc.) et COMMENT les cr√©er dans Excel. Donne des instructions claires : quelles colonnes utiliser pour X et Y, quel type de graphique choisir, pourquoi ce graphique est adapt√©. NE cr√©e AUCUN graphique, NE modifie RIEN. Sugg√®re seulement les graphiques √† cr√©er manuellement dans Excel avec des explications p√©dagogiques.';
                    break;
            }

            // Stocker le message IA pour sendMessage()
            window.pendingAiMessage = aiMessage;
            
            document.getElementById('chatInput').value = userMessage;
            sendMessage();
        }

        // Export Excel
        function exportExcel() {
            if (excelData.length === 0) return;

            const ws = XLSX.utils.aoa_to_sheet([excelColumns, ...excelData]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
            XLSX.writeFile(wb, currentFileName || 'export.xlsx');

            addChatMessage('‚úÖ Fichier export√© avec succ√®s !', 'bot');
            addHistory('Exportation: ' + (currentFileName || 'export.xlsx'));
        }

        // History
        function addHistory(action) {
            actionHistory.unshift(action);
            const historyList = document.getElementById('historyList');
            
            if (actionHistory.length === 1 && historyList.firstChild.textContent === 'Aucune action pour le moment') {
                historyList.innerHTML = '';
            }

            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.textContent = action;
            historyList.insertBefore(historyItem, historyList.firstChild);

            if (actionHistory.length > 10) {
                historyList.removeChild(historyList.lastChild);
                actionHistory.pop();
            }
            
            // Sauvegarder automatiquement apr√®s chaque action
            saveSession();
        }

        // Help modal
        function toggleHelp() {
            addChatMessage('üí° Aide Excel AI Expert:\n\n' +
                '‚Ä¢ Importez vos fichiers Excel/CSV\n' +
                '‚Ä¢ Posez des questions sur vos donn√©es\n' +
                '‚Ä¢ Utilisez les actions rapides\n' +
                '‚Ä¢ G√©n√©rez des formules et analyses\n' +
                '‚Ä¢ Exportez vos r√©sultats', 'bot');
        }

        // Drag and drop
        const uploadZone = document.getElementById('uploadZone');
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.currentTarget.firstElementChild.style.borderColor = 'var(--excel-green)';
            e.currentTarget.firstElementChild.style.background = '#E8F5EF';
        });

        uploadZone.addEventListener('dragleave', (e) => {
            e.currentTarget.firstElementChild.style.borderColor = 'var(--excel-green-border)';
            e.currentTarget.firstElementChild.style.background = 'var(--excel-green-bg)';
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) {
                const fileInput = document.getElementById('fileInput');
                fileInput.files = e.dataTransfer.files;
                handleFileUpload({target: fileInput});
            }
        });
    </script>
</body>
</html>

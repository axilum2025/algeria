<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel AI Expert - Axilum AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --excel-green: #217346;
            --excel-green-dark: #185C37;
            --excel-green-light: #2B8758;
            --excel-green-bg: #F0F8F4;
            --excel-green-border: #D4E8DD;
            --bg-white: #FFFFFF;
            --bg-gray: #F5F5F5;
            --text-dark: #1F1F1F;
            --text-gray: #5F5F5F;
            --border-gray: #D4D4D4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Calibri', 'Arial', sans-serif;
            background: var(--bg-white);
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* Header Excel Style */
        .excel-header {
            background: var(--excel-green);
            color: white;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .excel-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .excel-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
        }

        .excel-title {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.9;
        }

        .header-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .icon-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        /* Ribbon Menu */
        .ribbon {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-gray);
            padding: 8px 24px;
            display: flex;
            gap: 32px;
        }

        .ribbon-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .ribbon-group-label {
            font-size: 11px;
            color: var(--text-gray);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ribbon-buttons {
            display: flex;
            gap: 4px;
        }

        .ribbon-btn {
            background: var(--bg-white);
            border: 1px solid var(--border-gray);
            color: var(--text-dark);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .ribbon-btn:hover {
            background: var(--excel-green-bg);
            border-color: var(--excel-green);
        }

        .ribbon-btn svg {
            stroke: var(--excel-green);
        }

        /* Main Container */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 0;
            height: calc(100vh - 120px);
        }

        /* Excel Work Area */
        .excel-work-area {
            background: var(--bg-white);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-gray);
        }

        .upload-zone {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .upload-card {
            background: var(--excel-green-bg);
            border: 2px dashed var(--excel-green-border);
            border-radius: 8px;
            padding: 60px 40px;
            text-align: center;
            max-width: 500px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-card:hover {
            background: #E8F5EF;
            border-color: var(--excel-green);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            background: var(--excel-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .upload-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--excel-green);
            margin-bottom: 8px;
        }

        .upload-subtitle {
            font-size: 14px;
            color: var(--text-gray);
            margin-bottom: 20px;
        }

        .upload-btn {
            background: var(--excel-green);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background: var(--excel-green-dark);
        }

        /* Excel Table */
        .excel-table-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            display: none;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .excel-table th {
            background: var(--excel-green);
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border: 1px solid var(--excel-green-dark);
            position: sticky;
            top: 0;
        }

        .excel-table td {
            padding: 8px 10px;
            border: 1px solid var(--border-gray);
            background: white;
        }

        .excel-table tr:hover td {
            background: var(--excel-green-bg);
        }

        /* Sidebar Panel */
        .sidebar-panel {
            background: var(--bg-white);
            border-left: 1px solid var(--border-gray);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .panel-header {
            background: var(--excel-green-bg);
            padding: 16px;
            border-bottom: 1px solid var(--excel-green-border);
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--excel-green);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
        }

        .chat-message.bot {
            background: var(--excel-green-bg);
            border-left: 3px solid var(--excel-green);
            color: var(--text-dark);
        }

        .chat-message.user {
            background: var(--bg-gray);
            border-left: 3px solid var(--text-gray);
            color: var(--text-dark);
        }

        .chat-input-container {
            padding: 16px;
            border-top: 1px solid var(--border-gray);
            background: var(--bg-white);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--excel-green);
        }

        .send-btn {
            background: var(--excel-green);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: var(--excel-green-dark);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Quick Actions */
        .quick-actions {
            padding: 16px;
            border-bottom: 1px solid var(--border-gray);
            background: var(--bg-white);
        }

        .quick-actions-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-gray);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .quick-action-btn {
            background: var(--bg-white);
            border: 1px solid var(--excel-green-border);
            color: var(--excel-green);
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-action-btn:hover {
            background: var(--excel-green-bg);
            border-color: var(--excel-green);
        }

        .quick-action-btn svg {
            stroke: var(--excel-green);
            flex-shrink: 0;
        }

        /* History Section */
        .history-section {
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid var(--border-gray);
            background: var(--bg-gray);
        }

        .history-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-gray);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .history-item {
            background: white;
            border: 1px solid var(--border-gray);
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 6px;
            color: var(--text-dark);
        }

        .history-item:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="excel-header">
        <div class="excel-header-left">
            <div class="excel-logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <line x1="9" y1="3" x2="9" y2="21"/>
                    <line x1="3" y1="9" x2="21" y2="9"/>
                    <line x1="3" y1="15" x2="21" y2="15"/>
                    <line x1="15" y1="9" x2="15" y2="21"/>
                </svg>
                Excel AI Expert
            </div>
            <span class="excel-title" id="fileName">Nouveau classeur</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <button class="header-btn" onclick="window.location.href='/'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                </svg>
                Accueil
            </button>
            <button class="icon-btn" onclick="toggleHelp()" title="Aide">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Ribbon Menu -->
    <div class="ribbon">
        <div class="ribbon-group">
            <div class="ribbon-group-label">Fichier</div>
            <div class="ribbon-buttons">
                <button class="ribbon-btn" onclick="document.getElementById('fileInput').click()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Importer
                </button>
                <button class="ribbon-btn" onclick="exportExcel()" id="exportBtn" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Exporter
                </button>
            </div>
        </div>

        <div class="ribbon-group">
            <div class="ribbon-group-label">Outils</div>
            <div class="ribbon-buttons">
                <button class="ribbon-btn" onclick="quickAction('clean')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                        <line x1="9" y1="9" x2="9.01" y2="9"/>
                        <line x1="15" y1="9" x2="15.01" y2="9"/>
                    </svg>
                    Nettoyer
                </button>
                <button class="ribbon-btn" onclick="quickAction('analyze')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    Analyser
                </button>
                <button class="ribbon-btn" onclick="quickAction('formulas')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="5" y1="12" x2="19" y2="12"/>
                        <polyline points="12 5 19 12 12 19"/>
                    </svg>
                    Formules
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Excel Work Area -->
        <div class="excel-work-area">
            <!-- Upload Zone -->
            <div class="upload-zone" id="uploadZone">
                <div class="upload-card" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="9" y1="3" x2="9" y2="21"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="3" y1="15" x2="21" y2="15"/>
                            <line x1="15" y1="9" x2="15" y2="21"/>
                        </svg>
                    </div>
                    <div class="upload-title">Importer un fichier Excel</div>
                    <div class="upload-subtitle">Glissez-d√©posez un fichier .xlsx, .xls ou .csv</div>
                    <button class="upload-btn">Parcourir les fichiers</button>
                </div>
            </div>

            <!-- Excel Table -->
            <div class="excel-table-container" id="tableContainer">
                <table class="excel-table" id="excelTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Sidebar Panel -->
        <div class="sidebar-panel">
            <!-- Panel Header -->
            <div class="panel-header">
                <div class="panel-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/>
                        <line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                    Excel Assistant AI
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-actions-title">Actions Rapides</div>
                <div class="quick-actions-grid">
                    <button class="quick-action-btn" onclick="quickAction('kpi')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="20" x2="12" y2="10"/>
                            <line x1="18" y1="20" x2="18" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="16"/>
                        </svg>
                        G√©n√©rer KPI
                    </button>
                    <button class="quick-action-btn" onclick="quickAction('duplicate')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        D√©tecter Doublons
                    </button>
                    <button class="quick-action-btn" onclick="quickAction('pivot')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="9" y1="21" x2="9" y2="9"/>
                        </svg>
                        Tableau Crois√©
                    </button>
                    <button class="quick-action-btn" onclick="quickAction('chart')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"/>
                            <line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                        </svg>
                        Cr√©er Graphique
                    </button>
                </div>
            </div>

            <!-- AI Chat -->
            <div class="ai-chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message bot">
                        üëã Bonjour ! Je suis votre assistant Excel AI. Importez un fichier pour commencer ou posez-moi une question sur Excel.
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Posez votre question ici..."
                            rows="2"
                            onkeypress="handleKeyPress(event)"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- History -->
            <div class="history-section">
                <div class="history-title">Historique</div>
                <div id="historyList">
                    <div class="history-item">Aucune action pour le moment</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none" onchange="handleFileUpload(event)">

    <script>
        let excelData = [];
        let excelColumns = [];
        let currentFileName = '';
        let chatHistory = [];
        let actionHistory = [];

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            currentFileName = file.name;
            document.getElementById('fileName').textContent = currentFileName;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                    if (jsonData.length > 0) {
                        excelColumns = jsonData[0];
                        excelData = jsonData.slice(1);
                        displayExcelData();
                        addChatMessage('‚úÖ Fichier charg√© avec succ√®s ! ' + excelData.length + ' lignes et ' + excelColumns.length + ' colonnes d√©tect√©es.', 'bot');
                        addHistory('Importation: ' + currentFileName);
                        document.getElementById('exportBtn').style.display = 'flex';
                    }
                } catch (error) {
                    addChatMessage('‚ùå Erreur lors du chargement du fichier: ' + error.message, 'bot');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Display Excel data
        function displayExcelData() {
            const uploadZone = document.getElementById('uploadZone');
            const tableContainer = document.getElementById('tableContainer');
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');

            uploadZone.style.display = 'none';
            tableContainer.style.display = 'block';

            // Create header
            let headerHTML = '<tr>';
            excelColumns.forEach(col => {
                headerHTML += `<th>${col}</th>`;
            });
            headerHTML += '</tr>';
            tableHead.innerHTML = headerHTML;

            // Create rows
            let bodyHTML = '';
            excelData.slice(0, 100).forEach(row => {
                bodyHTML += '<tr>';
                excelColumns.forEach((col, idx) => {
                    bodyHTML += `<td>${row[idx] || ''}</td>`;
                });
                bodyHTML += '</tr>';
            });
            tableBody.innerHTML = bodyHTML;
        }

        // Chat functions
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            // Ajouter un indicateur de chargement
            const loadingMsg = addChatMessage('‚è≥ Traitement en cours...', 'bot');

            // Retry logic avec timeout
            let lastError = null;
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    // Construire le contexte Excel
                    const excelContext = excelData.length > 0 ? `
Contexte Excel actuel :
- Fichier : ${currentFileName}
- Nombre de lignes : ${excelData.length}
- Colonnes : ${excelColumns.join(', ')}
- Aper√ßu des donn√©es : ${JSON.stringify(excelData.slice(0, 3))}

Tu es un expert Excel AI. Aide l'utilisateur avec ses donn√©es Excel, formules, analyses, nettoyage, KPI, etc.
` : `Tu es un expert Excel AI. Aide l'utilisateur avec Excel : formules, analyses, Power Query, tableaux crois√©s dynamiques, etc.`;

                    // Convertir l'historique au format backend
                    const historyForBackend = chatHistory.slice(0, -2).map(msg => ({
                        type: msg.type === 'bot' ? 'bot' : 'user',
                        content: msg.message
                    }));

                    // Timeout de 30 secondes
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);

                    const response = await fetch('/api/invoke-v2', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message: excelContext + "\n\nQuestion: " + message,
                            conversationId: 'excel-ai-expert',
                            chatType: 'excel-expert',
                            history: historyForBackend
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur ${response.status}: ${errorText}`);
                    }

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    let aiResponse = data.response || data.message || 'D√©sol√©, je n\'ai pas pu traiter votre demande.';

                    // Clean metrics
                    aiResponse = aiResponse
                        .replace(/\n*---[\s\S]*$/g, '')
                        .replace(/\n*üìä.*?M√©triques.*?\n.*?HI:.*?CHR:.*?\n*/gi, '')
                        .replace(/\n*üìö.*?Sources:.*?\n*/gi, '')
                        .replace(/\n*üí°.*?Plan.*?tokens.*?\n*/gi, '')
                        .trim();

                    // Supprimer le message de chargement
                    loadingMsg.remove();
                    chatHistory.pop(); // Retirer du historique aussi

                    addChatMessage(aiResponse, 'bot');
                    sendBtn.disabled = false;
                    return; // Succ√®s, sortie

                } catch (error) {
                    lastError = error;
                    console.error(`Tentative ${attempt}/3 √©chou√©e:`, error);
                    
                    if (error.name === 'AbortError') {
                        console.log('‚è±Ô∏è Timeout - retry...');
                        loadingMsg.innerHTML = `‚è≥ Timeout... Tentative ${attempt + 1}/3`;
                    } else {
                        loadingMsg.innerHTML = `‚è≥ Retry ${attempt}/3...`;
                    }
                    
                    // Retry avec d√©lai exponentiel
                    if (attempt < 3) {
                        const delay = Math.pow(2, attempt) * 1000; // 2s, 4s
                        console.log(`‚è≥ Nouvelle tentative dans ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                }
            }

            // Toutes les tentatives ont √©chou√©
            console.error('‚ùå √âchec apr√®s 3 tentatives:', lastError);
            const errorMessage = lastError?.message || 'Erreur inconnue';
            
            // Supprimer le message de chargement
            loadingMsg.remove();
            chatHistory.pop();
            
            addChatMessage(
                `‚ö†Ô∏è Impossible de se connecter au serveur.\n\n**Raison:** ${errorMessage}\n\n**Que faire:**\n- V√©rifiez votre connexion internet\n- R√©essayez dans quelques instants\n- Si le probl√®me persiste, contactez le support`,
                'bot'
            );
            sendBtn.disabled = false;
        }

        function addChatMessage(message, type) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            messageDiv.innerHTML = message;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            chatHistory.push({type, message, timestamp: new Date()});
            return messageDiv; // Retourner l'√©l√©ment pour pouvoir le modifier
        }

        // Quick actions
        function quickAction(action) {
            if (excelData.length === 0) {
                addChatMessage('‚ö†Ô∏è Veuillez d\'abord importer un fichier Excel.', 'bot');
                return;
            }

            let message = '';
            switch(action) {
                case 'clean':
                    message = 'Nettoie mes donn√©es en supprimant les doublons et les cellules vides';
                    break;
                case 'analyze':
                    message = 'Analyse mes donn√©es et donne-moi des statistiques cl√©s';
                    break;
                case 'formulas':
                    message = 'Sugg√®re-moi des formules utiles pour ces donn√©es';
                    break;
                case 'kpi':
                    message = 'G√©n√®re des KPI pertinents pour ces donn√©es';
                    break;
                case 'duplicate':
                    message = 'D√©tecte les doublons dans mes donn√©es';
                    break;
                case 'pivot':
                    message = 'Cr√©e un tableau crois√© dynamique';
                    break;
                case 'chart':
                    message = 'Sugg√®re des graphiques adapt√©s √† mes donn√©es';
                    break;
            }

            document.getElementById('chatInput').value = message;
            sendMessage();
        }

        // Export Excel
        function exportExcel() {
            if (excelData.length === 0) return;

            const ws = XLSX.utils.aoa_to_sheet([excelColumns, ...excelData]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
            XLSX.writeFile(wb, currentFileName || 'export.xlsx');

            addChatMessage('‚úÖ Fichier export√© avec succ√®s !', 'bot');
            addHistory('Exportation: ' + (currentFileName || 'export.xlsx'));
        }

        // History
        function addHistory(action) {
            actionHistory.unshift(action);
            const historyList = document.getElementById('historyList');
            
            if (actionHistory.length === 1 && historyList.firstChild.textContent === 'Aucune action pour le moment') {
                historyList.innerHTML = '';
            }

            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.textContent = action;
            historyList.insertBefore(historyItem, historyList.firstChild);

            if (actionHistory.length > 10) {
                historyList.removeChild(historyList.lastChild);
                actionHistory.pop();
            }
        }

        // Help modal
        function toggleHelp() {
            addChatMessage('üí° Aide Excel AI Expert:\n\n' +
                '‚Ä¢ Importez vos fichiers Excel/CSV\n' +
                '‚Ä¢ Posez des questions sur vos donn√©es\n' +
                '‚Ä¢ Utilisez les actions rapides\n' +
                '‚Ä¢ G√©n√©rez des formules et analyses\n' +
                '‚Ä¢ Exportez vos r√©sultats', 'bot');
        }

        // Drag and drop
        const uploadZone = document.getElementById('uploadZone');
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.currentTarget.firstElementChild.style.borderColor = 'var(--excel-green)';
            e.currentTarget.firstElementChild.style.background = '#E8F5EF';
        });

        uploadZone.addEventListener('dragleave', (e) => {
            e.currentTarget.firstElementChild.style.borderColor = 'var(--excel-green-border)';
            e.currentTarget.firstElementChild.style.background = 'var(--excel-green-bg)';
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) {
                const fileInput = document.getElementById('fileInput');
                fileInput.files = e.dataTransfer.files;
                handleFileUpload({target: fileInput});
            }
        });
    </script>
</body>
</html>
